# file opened: main.asm
   1  0000                  DEFINE TCP_BUF_SIZE 1024
   2  0000              ; Generate version string
   3  0000                  LUA ALLPASS
   4  0000 ~                v = tostring(sj.get_define("V"))
   5  0000 ~                maj = string.sub(v, 1,1)
   6  0000 ~                min = string.sub(v, 2,2)
   7  0000 ~                sj.insert_define("VERSION_STRING", "\"" .. maj .. "." .. min .. "\"")
   8  0000 ~
   9  0000 ~                b = tostring(sj.get_define("BLD"))
  10  0000 ~                sj.insert_define("BUILD_STRING", "\"" .. b .. "\"")
  11  0000                  ENDLUA
  12  0000
  13  0000                  IFDEF MSX
  14  0000 ~                    include "main-msx.asm"
  15  0000                  ELSE
  16  0000                      include "main-all.asm"
# file opened: main-all.asm
   1+ 0000                  device	zxspectrum128
   2+ 0000                  IFDEF NEDOOS
   3+ 0000 ~            	DEFINE CRLF "\r\n"
   4+ 0000 ~                    MODULE nos
   5+ 0000 ~                        include "../_sdk/sysdefs.asm"
   6+ 0000 ~                    ENDMODULE
   7+ 0000 ~                    org nos.PROGSTART
   8+ 0000                      ELSE
   9+ 0000              	DEFINE CRLF "\r"
  10+ 0000                      org 24576
  11+ 6000                  ENDIF
  12+ 6000              asmOrg:
  13+ 6000                  align 256
  14+ 6000 C3 59 A1         jp start
  15+ 6003                  include "vdp/index.asm"
# file opened: vdp/index.asm
   1++6003                  IFDEF TIMEX
   2++6003 ~                include "timex.asm"
   3++6003                  ENDIF
   4++6003
   5++6003                  IFDEF TIMEX80
   6++6003 ~                include "timex80.asm"
   7++6003                  ENDIF
   8++6003
   9++6003                  IFDEF ZXSCR
  10++6003                  include "zx.asm"
# file opened: vdp/zx.asm
   1++6003              COLOR=1
   2++6003              ;; Usual speccy screen driver
   3++6003                  module TextMode
   4++6003              init:
   5++6003 21 D5 61 06      ld hl, font_file, b, Dos.FMODE_READ
   5++6007 01
   6++6008 CD B7 6C         call Dos.fopen
   7++600B F5               push af
   8++600C 01 00 08 21      ld bc, 2048, hl, font64
   8++6010 00 40
   9++6012 CD 0E 6F         call Dos.fread
  10++6015 F1               pop af
  11++6016 CD 02 6E         call Dos.fclose
  12++6019 AF           	xor a
  12++601A D3 FE          out (#fe), a
  13++601C C9           	ret
  14++601D              cls:
  15++601D 11 00 00         ld de, 0
  15++6020 CD 3A 60       call gotoXY
  16++6023 3E 07            ld a, 7
  16++6025 CD 12 93       call Memory.setPage
  17++6028 AF               xor a
  17++6029 D3 FE          out (#fe), a
  18++602B 21 00 C0 11      ld hl, #c000, de, #c001, bc, 6911, (hl), a
  18++602F 01 C0 01 FF
  18++6033 1A 77
  18++6035 ED B0          ldir
  19++6037 C3 12 93         jp Memory.setPage
  20++603A
  21++603A
  22++603A              ; Set console coordinates
  23++603A              ; d = row(0..23), e = column (0..63)
  24++603A              gotoXY:
  25++603A              	;rr e;;;
  26++603A CB 3B        	srl e
  27++603C 3E 00        	ld a, 0
  28++603E 32 62 63     	ld (half_tile_screen), a
  29++6041 ED 53 60 63      ld (col_screen), de
  30++6045 C9               ret
  31++6046
  32++6046              disable:
  33++6046                  ; Nothing to disable
  34++6046 C9               ret
  35++6047
  36++6047              ; H - line
  37++6047              ; A - char
  38++6047              fillLine:
  39++6047 F5               push af
  40++6048 54 1E 00         ld d, h, e, 0
  40++604B CD 3A 60       call gotoXY
  41++604E F1               pop af
  42++604F 21 69 63 11      ld hl, fill_buff, de, fill_buff + 1, bc, 63, (hl), a
  42++6053 6A 63 01 3F
  42++6057 00 77
  42++6059 ED B0          ldir
  43++605B 21 69 63         ld hl, fill_buff
  43++605E C3 BC 60       jp printZ
  44++6061
  45++6061              usualLine:
  46++6061 47               ld b, a
  47++6062 0E 00            ld c, 0
  48++6064 CD 79 61         call bc_to_attr
  49++6067 3E 07            ld a, 7
  49++6069 CD 12 93       call Memory.setPage
  50++606C 36 07            ld (hl), #7
  51++606E 54 5D            ld de, hl
  52++6070 13               inc de
  53++6071 01 1F 00         ld bc, 31
  54++6074 ED B0            ldir
  55++6076 AF               xor a
  55++6077 CD 12 93       call Memory.setPage
  56++607A C9               ret
  57++607B
  58++607B              highlightLine:
  59++607B 47               ld b, a
  60++607C 0E 00            ld c, 0
  61++607E CD 79 61         call bc_to_attr
  62++6081 3E 07            ld a, 7
  62++6083 CD 12 93       call Memory.setPage
  63++6086 36 0C            ld (hl), #C
  64++6088 54 5D            ld de, hl
  65++608A 13               inc de
  66++608B 01 1F 00         ld bc, 31
  67++608E ED B0            ldir
  68++6090 AF               xor a
  68++6091 CD 12 93       call Memory.setPage
  69++6094 C9               ret
  70++6095
  71++6095              mvCR
  72++6095 ED 5B 60 63  	ld de, (col_screen)
  73++6099 14           	inc d
  74++609A 1E 00        	ld e, 0
  75++609C 3E 00        	ld a, 0
  76++609E 32 62 63     	ld (half_tile_screen), a
  77++60A1 C3 3A 60     	jp gotoXY
  78++60A4
  79++60A4              ; Print just one symbol
  80++60A4              ; A - symbol
  81++60A4              putC
  82++60A4 FE 0D            cp 13
  82++60A6 CA 95 60       jp z, mvCR
  83++60A9 21 68 63     	ld hl, single_symbol
  84++60AC 77           	ld (hl), a
  85++60AD 3E 07        	ld a, 7
  85++60AF CD 12 93       call Memory.setPage
  86++60B2 21 67 63         ld hl, single_symbol_print
  87++60B5 CD C7 60         call printL
  88++60B8 AF               xor a
  88++60B9 C3 12 93       jp Memory.setPage
  89++60BC
  90++60BC              ; Put string
  91++60BC              ; hl - string pointer that's begins from symbol count
  92++60BC              printZ
  93++60BC 7E               ld a, (hl)
  93++60BD A7             and a
  93++60BE C8             ret z
  94++60BF E5               push hl
  95++60C0 CD A4 60         call putC
  96++60C3 E1               pop hl
  97++60C4 23               inc hl
  98++60C5 18 F5            jr printZ
  99++60C7
 100++60C7              printL
 101++60C7 7E                   ld	a, (hl)
 102++60C8 A7           		and	a
 103++60C9 C8           		ret	z
 104++60CA
 105++60CA E5           		push	hl
 106++60CB CD 75 61     		call	calc_addr_attr
 107++60CE 3A 63 63     		ld	a,(attr_screen)
 108++60D1 77           		ld	(hl),a
 109++60D2 E1           		pop	hl
 110++60D3
 111++60D3 CD 64 61     		call	calc_addr_scr
 112++60D6
 113++60D6 3A 62 63     		ld	a,(half_tile_screen)
 114++60D9 CB 47        		bit	0,a
 115++60DB 7E           		ld	a,(hl)
 116++60DC C2 10 61     		jp	nz,print64_4
 117++60DF              print64_3
 118++60DF F5                   push    af
 119++60E0 E5           		push	hl
 120++60E1 CD 75 61     		call	calc_addr_attr
 121++60E4 3A 63 63     		ld	a,(attr_screen)
 122++60E7 77           		ld	(hl),a
 123++60E8 E1           		pop	hl
 124++60E9
 125++60E9 23                   inc     hl
 126++60EA E5                   push    hl
 127++60EB
 128++60EB 7E                   ld      a,(hl)
 129++60EC 6F           		ld	l,a
 130++60ED 26 00        		ld	h,0
 131++60EF 29           		add	hl,hl
 132++60F0 29           		add	hl,hl
 133++60F1 29           		add	hl,hl
 134++60F2 01 00 40             ld      bc,font64
 135++60F5 09                   add     hl,bc
 136++60F6
 137++60F6 D5                   push    de
 138++60F7
 139++60F7 06 06                ld      b,6
 140++60F9 AF           		xor	a
 141++60FA 12           		ld	(de),a
 142++60FB              print64_1
 143++60FB 14           	inc     d
 144++60FC 7E           	ld      a,(hl)
 145++60FD E6 F0        	and	#f0
 146++60FF 12           	ld      (de),a
 147++6100 23           	inc     hl
 148++6101 10 F8        	djnz    print64_1
 149++6103
 150++6103 14           	inc	d
 151++6104 AF           	xor	a
 152++6105 12           	ld	(de),a
 153++6106
 154++6106 3E 01        	ld	a,1
 155++6108 32 62 63     	ld	(half_tile_screen),a
 156++610B
 157++610B D1           	pop     de
 158++610C E1           	pop     hl
 159++610D F1           	pop     af
 160++610E
 161++610E 3D           	dec     a
 162++610F C8           	ret     z
 163++6110
 164++6110              print64_4
 165++6110 F5           	push    af
 166++6111
 167++6111 23           	inc     hl
 168++6112 E5           	push    hl
 169++6113
 170++6113 7E           	ld      a,(hl)
 171++6114 6F           	ld	l,a
 172++6115 26 00        	ld	h,0
 173++6117 29           	add	hl,hl
 174++6118 29           	add	hl,hl
 175++6119 29           	add	hl,hl
 176++611A 01 00 40     	ld      bc,font64
 177++611D 09           	add     hl,bc
 178++611E
 179++611E D5           	push    de
 180++611F
 181++611F 06 06        	ld      b,6
 182++6121 AF           	xor	a
 183++6122 12           	ld	(de),a
 184++6123              print64_2
 185++6123 14           	inc     d
 186++6124 7E           	ld      a,(hl)
 187++6125 E6 0F        	and     #0f
 188++6127 4F           	ld      c,a
 189++6128 1A           	ld      a,(de)
 190++6129 B1           	or      c
 191++612A 12           	ld      (de),a
 192++612B 23           	inc     hl
 193++612C 10 F5        	djnz    print64_2
 194++612E
 195++612E 14           	inc	d
 196++612F AF           	xor	a
 197++6130 12           	ld	(de),a
 198++6131
 199++6131 32 62 63     	ld	(half_tile_screen),a
 200++6134
 201++6134 D1           	pop     de
 202++6135
 203++6135 CD 3F 61     	call	move_cr64
 204++6138
 205++6138 E1           	pop     hl
 206++6139 F1           	pop     af
 207++613A 3D           	dec     a
 208++613B
 209++613B C2 DF 60     	jp      nz,print64_3
 210++613E
 211++613E C9           	ret
 212++613F
 213++613F              ; move cursor
 214++613F              move_cr64
 215++613F 13           	inc	de
 216++6140
 217++6140 21 60 63     	ld	hl,col_screen
 218++6143 34           	inc	(hl)
 219++6144 7E           	ld	a,(hl)
 220++6145
 221++6145 FE 20        	cp	32
 222++6147 D8           	ret	c
 223++6148
 224++6148 AF           	xor	a
 225++6149 32 62 63     	ld	(half_tile_screen),a
 226++614C 77           	ld	(hl),a
 227++614D 4F           	ld	c,a
 228++614E
 229++614E 23           	inc	hl
 230++614F 34           	inc	(hl)
 231++6150 7E           	ld	a,(hl)
 232++6151 47           	ld	b,a
 233++6152
 234++6152 FE 18        	cp	24
 235++6154 DA 60 61     	jp	c,move_cr64_01
 236++6157
 237++6157 3E 17        	ld	a,23
 238++6159 77           	ld	(hl),a
 239++615A 47           	ld	b,a
 240++615B
 241++615B C5           	push	bc
 242++615C CD 89 61     	call	scroll_up8
 243++615F C1           	pop	bc
 244++6160
 245++6160              move_cr64_01
 246++6160 CD 64 61     	call	calc_addr_scr
 247++6163 C9           	ret
 248++6164
 249++6164              calc_addr_scr
 250++6164 78           	ld      a,b
 251++6165 57           	ld      d,a
 252++6166 0F           	rrca
 253++6167 0F           	rrca
 254++6168 0F           	rrca
 255++6169 A7 E6 E0     	and     a,224
 256++616C 81           	add     a,c
 257++616D 5F           	ld      e,a
 258++616E 7A           	ld      a,d
 259++616F E6 18        	and     24
 260++6171 F6 C0        	or      #c0
 261++6173 57           	ld      d,a
 262++6174 C9           	ret
 263++6175
 264++6175              calc_addr_attr
 265++6175 ED 4B 60 63  	ld	bc,(col_screen)
 266++6179              bc_to_attr:
 267++6179 78           	ld	a,b
 268++617A 0F           	rrca
 269++617B 0F           	rrca
 270++617C 0F           	rrca
 271++617D 6F           	ld	l,a
 272++617E E6 1F        	and	31
 273++6180 F6 D8        	or	#d8
 274++6182 67           	ld	h,a
 275++6183 7D           	ld	a,l
 276++6184 E6 FC        	and	252
 277++6186 B1           	or	c
 278++6187 6F           	ld	l,a
 279++6188 C9           	ret
 280++6189
 281++6189              scroll_up8
 282++6189 21 E0 61     	ld	hl,table_addr_scr
 283++618C 06 B8        	ld	b,184
 284++618E
 285++618E              scroll_up8_01
 286++618E C5           	push	bc
 287++618F
 288++618F 5E           	ld	e,(hl)
 289++6190 23           	inc	hl
 290++6191 56           	ld	d,(hl)
 291++6192 23           	inc	hl
 292++6193
 293++6193 E5           	push	hl
 294++6194
 295++6194 01 0E 00     	ld	bc,14
 296++6197 09           	add	hl,bc
 297++6198 4E           	ld	c,(hl)
 298++6199 23           	inc	hl
 299++619A 46           	ld	b,(hl)
 300++619B
 301++619B 60           	ld	h,b
 302++619C 69           	ld	l,c
 303++619D
 304++619D 01 20 00     	ld	bc,32
 305++61A0 ED B0        	ldir
 306++61A2
 307++61A2 E1           	pop	hl
 308++61A3 C1           	pop	bc
 309++61A4 10 E8        	djnz	scroll_up8_01
 310++61A6
 311++61A6 06 08        	ld	b,8
 312++61A8
 313++61A8              scroll_up8_02
 314++61A8 C5           	push	bc
 315++61A9
 316++61A9 5E           	ld	e,(hl)
 317++61AA 23           	inc	hl
 318++61AB 56           	ld	d,(hl)
 319++61AC 23           	inc	hl
 320++61AD
 321++61AD E5           	push	hl
 322++61AE
 323++61AE 62           	ld	h,d
 324++61AF 6B           	ld	l,e
 325++61B0 13           	inc	de
 326++61B1 36 00        	ld	(hl),0
 327++61B3 01 1F 00     	ld	bc,31
 328++61B6 ED B0        	ldir
 329++61B8
 330++61B8 E1           	pop	hl
 331++61B9 C1           	pop	bc
 332++61BA 10 EC        	djnz	scroll_up8_02
 333++61BC 11 00 D8 21  	ld	de,#D800, hl,#D820, bc,736
 333++61C0 20 D8 01 E0
 333++61C4 02
 334++61C5 ED B0        	ldir
 335++61C7 1A           	ld	a,(de)
 336++61C8 21 E0 DA 11  	ld	hl,#dae0, de,#dae1, (hl),a, bc,31
 336++61CC E1 DA 77 01
 336++61D0 1F 00
 337++61D2 ED B0        	ldir
 338++61D4
 339++61D4 C9           	ret
 340++61D5
 341++61D5              font64 equ #4000 ; Using ZX-Spectrum screen as font buffer
 342++61D5 66 6F 6E 74  font_file db "font64.bin", 0
 342++61D9 36 34 2E 62
 342++61DD 69 6E 00
 343++61E0
 344++61E0
 345++61E0              table_addr_scr
 346++61E0 00 40 00 41  	defw	#4000,#4100,#4200,#4300,#4400,#4500,#4600,#4700
 346++61E4 00 42 00 43
 346++61E8 00 44 00 45
 346++61EC 00 46 00 47
 347++61F0 20 40 20 41  	defw	#4020,#4120,#4220,#4320,#4420,#4520,#4620,#4720
 347++61F4 20 42 20 43
 347++61F8 20 44 20 45
 347++61FC 20 46 20 47
 348++6200 40 40 40 41  	defw	#4040,#4140,#4240,#4340,#4440,#4540,#4640,#4740
 348++6204 40 42 40 43
 348++6208 40 44 40 45
 348++620C 40 46 40 47
 349++6210 60 40 60 41  	defw	#4060,#4160,#4260,#4360,#4460,#4560,#4660,#4760
 349++6214 60 42 60 43
 349++6218 60 44 60 45
 349++621C 60 46 60 47
 350++6220 80 40 80 41  	defw	#4080,#4180,#4280,#4380,#4480,#4580,#4680,#4780
 350++6224 80 42 80 43
 350++6228 80 44 80 45
 350++622C 80 46 80 47
 351++6230 A0 40 A0 41  	defw	#40a0,#41a0,#42a0,#43a0,#44a0,#45a0,#46a0,#47a0
 351++6234 A0 42 A0 43
 351++6238 A0 44 A0 45
 351++623C A0 46 A0 47
 352++6240 C0 40 C0 41  	defw	#40c0,#41c0,#42c0,#43c0,#44c0,#45c0,#46c0,#47c0
 352++6244 C0 42 C0 43
 352++6248 C0 44 C0 45
 352++624C C0 46 C0 47
 353++6250 E0 40 E0 41  	defw	#40e0,#41e0,#42e0,#43e0,#44e0,#45e0,#46e0,#47e0
 353++6254 E0 42 E0 43
 353++6258 E0 44 E0 45
 353++625C E0 46 E0 47
 354++6260
 355++6260 00 48 00 49  	defw	#4800,#4900,#4a00,#4b00,#4c00,#4d00,#4e00,#4f00
 355++6264 00 4A 00 4B
 355++6268 00 4C 00 4D
 355++626C 00 4E 00 4F
 356++6270 20 48 20 49  	defw	#4820,#4920,#4a20,#4b20,#4c20,#4d20,#4e20,#4f20
 356++6274 20 4A 20 4B
 356++6278 20 4C 20 4D
 356++627C 20 4E 20 4F
 357++6280 40 48 40 49  	defw	#4840,#4940,#4a40,#4b40,#4c40,#4d40,#4e40,#4f40
 357++6284 40 4A 40 4B
 357++6288 40 4C 40 4D
 357++628C 40 4E 40 4F
 358++6290 60 48 60 49  	defw	#4860,#4960,#4a60,#4b60,#4c60,#4d60,#4e60,#4f60
 358++6294 60 4A 60 4B
 358++6298 60 4C 60 4D
 358++629C 60 4E 60 4F
 359++62A0 80 48 80 49  	defw	#4880,#4980,#4a80,#4b80,#4c80,#4d80,#4e80,#4f80
 359++62A4 80 4A 80 4B
 359++62A8 80 4C 80 4D
 359++62AC 80 4E 80 4F
 360++62B0 A0 48 A0 49  	defw	#48a0,#49a0,#4aa0,#4ba0,#4ca0,#4da0,#4ea0,#4fa0
 360++62B4 A0 4A A0 4B
 360++62B8 A0 4C A0 4D
 360++62BC A0 4E A0 4F
 361++62C0 C0 48 C0 49  	defw	#48c0,#49c0,#4ac0,#4bc0,#4cc0,#4dc0,#4ec0,#4fc0
 361++62C4 C0 4A C0 4B
 361++62C8 C0 4C C0 4D
 361++62CC C0 4E C0 4F
 362++62D0 E0 48 E0 49  	defw	#48e0,#49e0,#4ae0,#4be0,#4ce0,#4de0,#4ee0,#4fe0
 362++62D4 E0 4A E0 4B
 362++62D8 E0 4C E0 4D
 362++62DC E0 4E E0 4F
 363++62E0
 364++62E0 00 50 00 51  	defw	#5000,#5100,#5200,#5300,#5400,#5500,#5600,#5700
 364++62E4 00 52 00 53
 364++62E8 00 54 00 55
 364++62EC 00 56 00 57
 365++62F0 20 50 20 51  	defw	#5020,#5120,#5220,#5320,#5420,#5520,#5620,#5720
 365++62F4 20 52 20 53
 365++62F8 20 54 20 55
 365++62FC 20 56 20 57
 366++6300 40 50 40 51  	defw	#5040,#5140,#5240,#5340,#5440,#5540,#5640,#5740
 366++6304 40 52 40 53
 366++6308 40 54 40 55
 366++630C 40 56 40 57
 367++6310 60 50 60 51  	defw	#5060,#5160,#5260,#5360,#5460,#5560,#5660,#5760
 367++6314 60 52 60 53
 367++6318 60 54 60 55
 367++631C 60 56 60 57
 368++6320 80 50 80 51  	defw	#5080,#5180,#5280,#5380,#5480,#5580,#5680,#5780
 368++6324 80 52 80 53
 368++6328 80 54 80 55
 368++632C 80 56 80 57
 369++6330 A0 50 A0 51  	defw	#50a0,#51a0,#52a0,#53a0,#54a0,#55a0,#56a0,#57a0
 369++6334 A0 52 A0 53
 369++6338 A0 54 A0 55
 369++633C A0 56 A0 57
 370++6340 C0 50 C0 51  	defw	#50c0,#51c0,#52c0,#53c0,#54c0,#55c0,#56c0,#57c0
 370++6344 C0 52 C0 53
 370++6348 C0 54 C0 55
 370++634C C0 56 C0 57
 371++6350 E0 50 E0 51  	defw	#50e0,#51e0,#52e0,#53e0,#54e0,#55e0,#56e0,#57e0
 371++6354 E0 52 E0 53
 371++6358 E0 54 E0 55
 371++635C E0 56 E0 57
 372++6360
 373++6360
 374++6360 00           col_screen			db	0
 375++6361 00           row_screen			db	0
 376++6362 00           half_tile_screen	db	0
 377++6363 07           attr_screen			db	07
 378++6364
 379++6364 00 00        col_screen_temp			dw	0
 380++6366 00           half_tile_screen_temp	db	0
 381++6367
 382++6367 01           single_symbol_print db 1
 383++6368 00           single_symbol 		db 0
 384++6369
 385++6369 00 00 00...  fill_buff ds 65
 386++63AA
 387++63AA                  endmodule
# file closed: vdp/zx.asm
  11++63AA                  ENDIF
  12++63AA
  13++63AA              	IFDEF NEDOOS
  14++63AA ~                include "nedotext.asm"
  15++63AA                  ENDIF
# file closed: vdp/index.asm
  16+ 63AA                  include "utils/index.asm"
# file opened: utils/index.asm
   1++63AA                  include "atoi.asm"
# file opened: utils/atoi.asm
   1++63AA              ; DE - buffer
   2++63AA              ; HL - output
   3++63AA              atohl:
   4++63AA 21 00 00         ld hl, 0
   5++63AD              .loop
   6++63AD 1A               ld a, (de)
   7++63AE 13               inc de
   8++63AF                  ; Sepparators
   9++63AF C5 E5            push bc, hl
  10++63B1 01 05 00             ld bc, sepparators_len
  11++63B4 21 CC 63             ld hl, sepparators
  12++63B7 ED B1                cpir
  13++63B9 E1 C1            pop hl, bc
  14++63BB C8               ret z
  15++63BC
  16++63BC D6 30            sub '0'
  17++63BE
  18++63BE C5               push bc
  19++63BF 4D                   ld c, l
  20++63C0 44                   ld b, h
  21++63C1
  22++63C1 29                   add hl, hl
  23++63C2 29                   add hl, hl
  24++63C3 09                   add hl, bc
  25++63C4 29                   add hl, hl
  26++63C5 4F                   ld c, a
  27++63C6 06 00                ld b, 0
  28++63C8 09                   add hl, bc
  29++63C9 C1               pop bc
  30++63CA 18 E1            jr .loop
  31++63CC
# file closed: utils/atoi.asm
   2++63CC                  include "constants.asm"
# file opened: utils/constants.asm
   1++63CC              TAB = 9
   2++63CC              CR = 13
   3++63CC              LF = 10
   4++63CC              NULL = 0
   5++63CC              SPACE = ' '
   6++63CC              ESC = 27
   7++63CC              BACKSPACE = 8
   8++63CC
   9++63CC                  IFDEF TIMEX80
  10++63CC ~            MIME_DOWNLOAD 	= #19
  11++63CC ~            MIME_LINK 		= #1A
  12++63CC ~            MIME_TEXT 		= #10
  13++63CC ~            MIME_IMAGE 		= #01
  14++63CC ~            MIME_MUSIC 		= #0e
  15++63CC ~            MIME_INPUT 		= #b3
  16++63CC ~            MIME_MOD 		= #0d
  17++63CC ~            MIME_SOUND      = 's' ;sound
  18++63CC ~
  19++63CC ~            BORDER_TOP = #b2
  20++63CC ~            BORDER_BOTTOM = #b1
  21++63CC                  ELSE
  22++63CC              	IFDEF MSX
  23++63CC ~            MIME_DOWNLOAD 	= 1
  24++63CC ~            MIME_LINK		= 2
  25++63CC ~            MIME_TEXT 		= 3
  26++63CC ~            MIME_IMAGE 		= 4
  27++63CC ~            MIME_MUSIC 		= 5
  28++63CC ~            MIME_INPUT 		= 6
  29++63CC ~            MIME_MOD      	= 7
  30++63CC ~            MIME_SOUND      = 's' ;sound
  31++63CC ~
  32++63CC ~            BORDER_TOP    = 7
  33++63CC ~            BORDER_BOTTOM = 8
  34++63CC              	ELSE
  35++63CC              MIME_DOWNLOAD = 1
  36++63CC              MIME_LINK     = 2
  37++63CC              MIME_TEXT     = 3
  38++63CC              MIME_IMAGE    = 6
  39++63CC              MIME_MUSIC    = 5
  40++63CC              MIME_INPUT    = 4
  41++63CC              MIME_MOD      = 7
  42++63CC              MIME_SOUND    = 's' ;sound
  43++63CC
  44++63CC              BORDER_TOP    = 9
  45++63CC              BORDER_BOTTOM = 8
  46++63CC              	ENDIF
  47++63CC
  48++63CC
  49++63CC
  50++63CC
  51++63CC              	ENDIF
  52++63CC
  53++63CC 0D 0A 09 00  sepparators db CR, LF, TAB, NULL, SPACE
  53++63D0 20
  54++63D1              sepparators_len = $ - sepparators
# file closed: utils/constants.asm
   3++63D1                  include "strutils.asm"
# file opened: utils/strutils.asm
   1++63D1              ; de - pointer
   2++63D1              ; hl - count
   3++63D1              strlen:
   4++63D1 21 00 00         ld hl, 0
   5++63D4              .loop
   6++63D4 1A               ld a, (de)
   7++63D5 A7               and a
   7++63D6 28 04          jr z, .exit
   8++63D8 23               inc hl
   9++63D9 13               inc de
  10++63DA 18 F8            jr .loop
  11++63DC              .exit
  12++63DC C9               ret
  13++63DD
  14++63DD                  module CompareBuff
  15++63DD
  16++63DD              ; Pushes A to buffer
  17++63DD              push
  18++63DD F5               push af
  19++63DE 06 20            ld b, 32
  19++63E0 21 29 64       ld hl, buffer + 1
  19++63E3 11 28 64       ld de, buffer
  20++63E6              .loop
  21++63E6 7E               ld a, (hl)
  21++63E7 12             ld (de), a
  21++63E8 23             inc hl
  21++63E9 13             inc de
  21++63EA 10 FA          djnz .loop
  22++63EC F1               pop af
  23++63ED 21 47 64         ld hl, buffer + 31
  23++63F0 77             ld (hl), a
  24++63F1 C9               ret
  25++63F2
  26++63F2              ; HL - Compare string(null terminated)
  27++63F2              ; A - 0 NOT Found
  28++63F2              ;     1 Found
  29++63F2              search:
  30++63F2 06 00            ld b, 0
  30++63F4 E5             push hl
  31++63F5              .loop:
  32++63F5 7E               ld a, (hl)
  32++63F6 23             inc hl
  32++63F7 04             inc b
  32++63F8 A7             and a
  32++63F9 C2 F5 63       jp nz, .loop
  33++63FC 05               dec b
  33++63FD E1             pop hl
  33++63FE C5             push bc
  33++63FF E5             push hl
  34++6400 E1               pop hl
  35++6401 11 48 64         ld de, buffer + 32
  36++6404              .sourceLoop
  37++6404 1B               dec de
  37++6405 10 FD          djnz .sourceLoop
  38++6407 C1               pop bc
  39++6408              .compare
  40++6408 C5               push bc
  40++6409 F5             push af
  41++640A 1A               ld a, (de)
  41++640B 47             ld b, a
  42++640C F1               pop af
  42++640D 7E             ld a, (hl)
  42++640E B8             cp b
  42++640F C1             pop bc
  42++6410 3E 00          ld a, 0
  42++6412 C0             ret nz
  43++6413 13               inc de
  43++6414 23             inc hl
  44++6415 10 F1            djnz .compare
  45++6417 3E 01            ld a, 1
  46++6419 C9               ret
  47++641A
  48++641A              clear:
  49++641A AF               xor a
  49++641B 21 28 64       ld hl, buffer
  49++641E 11 29 64       ld de, buffer + 1
  49++6421 01 20 00       ld bc, 32
  49++6424 77             ld (hl), a
  49++6425 ED B0          ldir
  50++6427 C9               ret
  51++6428
  52++6428 00 00 00...  buffer ds 32
  53++6448
  54++6448                  endmodule
# file closed: utils/strutils.asm
   4++6448                  IFDEF MSX
   5++6448 ~            	    include "bios.asm"
   6++6448                  ENDIF
   7++6448                  include "screen.asm"
# file opened: utils/screen.asm
   1++6448              LINE_LIMIT = 63
   2++6448
   3++6448                  IFDEF NEDOOS
   4++6448 ~            LINE_LIMIT = 79
   5++6448                  ENDIF
   6++6448
   7++6448                  IFDEF TIMEX80
   8++6448 ~            LINE_LIMIT = 84
   9++6448                  ENDIF
  10++6448
  11++6448                  IFDEF MSX
  12++6448 ~            LINE_LIMIT = 79
  13++6448                  ENDIF
  14++6448              ; HL - string pointer
  15++6448              print70Text:
  16++6448 06 3F            ld b, LINE_LIMIT
  17++644A              .loop
  18++644A 7E               ld a, (hl)
  19++644B A7               and a
  19++644C C8             ret z
  20++644D FE 0D            cp 13
  20++644F C8             ret z
  21++6450 FE 0A            cp 10
  21++6452 C8             ret z
  22++6453 C5               push bc
  23++6454 E5               push hl
  24++6455 CD A4 60         call TextMode.putC
  25++6458 E1               pop hl
  26++6459 23               inc hl
  27++645A C1               pop bc
  28++645B 05               dec b
  29++645C 78               ld a, b
  29++645D A7             and a
  29++645E C8             ret z
  30++645F C3 4A 64         jp .loop
  31++6462
  32++6462              ; HL - string pointer
  33++6462              print70Goph:
  34++6462 06 3F            ld b, LINE_LIMIT
  35++6464              .loop
  36++6464 7E               ld a, (hl)
  36++6465 FE 09          cp 09
  36++6467 C8             ret z
  37++6468 A7               and a
  37++6469 C8             ret z
  38++646A C5               push bc
  39++646B E5               push hl
  40++646C CD A4 60         call TextMode.putC
  41++646F E1               pop hl
  42++6470 23               inc hl
  43++6471 C1               pop bc
  44++6472 05               dec b
  45++6473 78               ld a, b
  45++6474 A7             and a
  45++6475 C8             ret z
  46++6476 C3 64 64         jp .loop
# file closed: utils/screen.asm
# file closed: utils/index.asm
  17+ 6479                  include "gopher/render/index.asm"
# file opened: gopher/render/index.asm
   1++6479                  MODULE Render
   2++6479              PER_PAGE = 22
   3++6479              CURSOR_OFFSET = 2
   4++6479                  include "row.asm"
# file opened: gopher/render/row.asm
   1++6479              ; A - row number
   2++6479              ; HL - pointer to row
   3++6479              renderRow:
   4++6479 C6 02            add CURSOR_OFFSET
   5++647B 57               ld d,a
   6++647C 1E 00            ld e,0
   7++647E CD 3A 60         call TextMode.gotoXY
   8++6481 7E               ld a,(hl)
   9++6482 E5               push hl
  10++6483 CD 8E 64         call getIcon
  11++6486 CD A4 60         call TextMode.putC
  12++6489 E1               pop hl
  13++648A 23               inc hl
  14++648B C3 62 64         jp print70Goph
  15++648E
  16++648E              ; A - gopher id char
  17++648E              getIcon:
  18++648E FE 69            cp 'i'
  18++6490 CA AF 64       jp z, .info
  19++6493 FE 39            cp '9'
  19++6495 CA B2 64       jp z, .down
  20++6498 FE 31            cp '1'
  20++649A CA 30 65       jp z, .page
  21++649D FE 30            cp '0'
  21++649F CA 33 65       jp z, .text
  22++64A2 FE 37            cp '7'
  22++64A4 CA 36 65       jp z, .input
  23++64A7 FE 73            cp 's'
  23++64A9 CA B2 64       jp z, .down
  24++64AC 3E 20            ld a, ' '
  25++64AE C9               ret
  26++64AF              .info
  27++64AF 3E 20            ld a, SPACE
  27++64B1 C9             ret
  28++64B2              .down
  29++64B2 54 5D            ld de, hl
  30++64B4 01 FF 00 3E      ld bc, #ff, a, TAB
  30++64B8 09
  30++64B9 ED B1          cpir
  31++64BB 78               ld a, b
  31++64BC B1             or c
  31++64BD 28 6E          jr z, .downExit
  32++64BF D5               push de
  33++64C0              .nameLoop
  34++64C0 7E               ld a, (hl)
  34++64C1 A7             and a
  34++64C2 28 10          jr z, .check
  35++64C4 FE 09            cp TAB
  35++64C6 28 0C          jr z, .check
  36++64C8 FE 0D            cp CR
  36++64CA 28 08          jr z, .check
  37++64CC E5               push hl
  38++64CD CD DD 63         call CompareBuff.push
  39++64D0 E1               pop hl
  40++64D1 23               inc hl
  41++64D2 18 EC            jr .nameLoop
  42++64D4              .check
  43++64D4 3A 72 65     	ld a,(saveMode+1);���� ����� �������� ������, ����� �� ������� �� ������ Caps
  44++64D7 B7           	or a
  45++64D8 20 52        	jr nz,.checkExit
  46++64DA 21 45 65     	ld hl, scrExt1
  46++64DD CD F2 63       call CompareBuff.search
  46++64E0 A7             and a
  46++64E1 20 56          jr nz, .image
  47++64E3 21 4A 65         ld hl, scrExt2
  47++64E6 CD F2 63       call CompareBuff.search
  47++64E9 A7             and a
  47++64EA 20 4D          jr nz, .image
  48++64EC 3E 03            ld a, 3
  48++64EE 32 6D 95       ld (VTPL.SETUP), a ; 0 bit - looping, 1 bit - pt2 file
  49++64F1 21 59 65         ld hl, pt2Ext1
  49++64F4 CD F2 63       call CompareBuff.search
  49++64F7 A7             and a
  49++64F8 20 43          jr nz, .music
  50++64FA 21 5E 65         ld hl, pt2Ext2
  50++64FD CD F2 63       call CompareBuff.search
  50++6500 A7             and a
  50++6501 20 3A          jr nz, .music
  51++6503 3E 01            ld a, 1
  51++6505 32 6D 95       ld (VTPL.SETUP), a
  52++6508 21 4F 65         ld hl, pt3Ext1
  52++650B CD F2 63       call CompareBuff.search
  52++650E A7             and a
  52++650F 20 2C          jr nz, .music
  53++6511 21 54 65         ld hl, pt3Ext2
  53++6514 CD F2 63       call CompareBuff.search
  53++6517 A7             and a
  53++6518 20 23          jr nz, .music
  54++651A
  55++651A                  ; General Sound support
  56++651A                  ifdef GS
  57++651A 21 63 65         ld hl, modExt1
  57++651D CD F2 63       call CompareBuff.search
  57++6520 A7             and a
  57++6521 20 1E          jr nz, .mod
  58++6523 21 68 65         ld hl, modExt2
  58++6526 CD F2 63       call CompareBuff.search
  58++6529 A7             and a
  58++652A 20 15          jr nz, .mod
  59++652C                  endif
  60++652C
  61++652C              .checkExit
  62++652C E1               pop hl
  63++652D              .downExit
  64++652D 3E 01            ld a, MIME_DOWNLOAD
  64++652F C9             ret
  65++6530              .page
  66++6530 3E 02            ld a, MIME_LINK
  66++6532 C9             ret
  67++6533              .text
  68++6533 3E 03            ld a, MIME_TEXT
  68++6535 C9             ret
  69++6536              .input
  70++6536 3E 04            ld a, MIME_INPUT
  70++6538 C9             ret
  71++6539              .image
  72++6539 E1               pop hl
  72++653A 3E 06          ld a, MIME_IMAGE
  72++653C C9             ret
  73++653D              .music
  74++653D E1               pop hl
  74++653E 3E 05          ld a, MIME_MUSIC
  74++6540 C9             ret
  75++6541              .mod
  76++6541 E1               pop hl
  76++6542 3E 07          ld a, MIME_MOD
  76++6544 C9             ret
  77++6545
  78++6545 2E 73 63 72  scrExt1 db ".scr", 0
  78++6549 00
  79++654A 2E 53 43 52  scrExt2 db ".SCR", 0
  79++654E 00
  80++654F
  81++654F 2E 70 74 33  pt3Ext1 db ".pt3", 0
  81++6553 00
  82++6554 2E 50 54 33  pt3Ext2 db ".PT3", 0
  82++6558 00
  83++6559 2E 70 74 32  pt2Ext1 db ".pt2", 0
  83++655D 00
  84++655E 2E 50 54 32  pt2Ext2 db ".PT2", 0
  84++6562 00
  85++6563 2E 6D 6F 64  modExt1 db ".mod", 0
  85++6567 00
  86++6568 2E 4D 4F 44  modExt2 db ".MOD", 0
  86++656C 00
  87++656D
  88++656D              toggleSaveMode
  89++656D F5           			push af
  90++656E CD 43 6A     			call Console.waitForKeyUp
  91++6571 3E 00        saveMode	ld a,0 ; ���� Open/Save files
  92++6573 EE 01        			xor 1
  93++6575 32 72 65     			ld (saveMode+1),a
  94++6578 F1           			pop af
  95++6579 C9           			ret
# file closed: gopher/render/row.asm
   5++657A                  include "buffer.asm"
# file opened: gopher/render/buffer.asm
   1++657A              ; BC - line count
   2++657A              findLine
   3++657A 21 59 A1         ld hl, outputBuffer
   4++657D              findLine2
   5++657D 78               ld a,b
   6++657E B1               or c
   7++657F CA AC 65         jp z, .checkEmpty
   8++6582              .loop
   9++6582 7E               ld a, (hl)
  10++6583 A7               and a
  11++6584 CA AF 65         jp z, .nope
  12++6587 23               inc hl
  13++6588 FE 0D            cp 13
  14++658A CA A2 65         jp z, .checkLF  ;13
  15++658D FE 0A            cp 10
  15++658F CA 95 65       jp z, .nextCheck     ;10
  16++6592 C3 82 65         jp .loop
  17++6595              .nextCheck
  18++6595 A7               and a
  19++6596 CA AF 65         jp z, .nope
  20++6599 0B               dec bc
  21++659A 57               ld d,a
  22++659B 78               ld a,b
  23++659C B1               or c
  24++659D 7A               ld a,d
  25++659E C2 82 65         jp nz, .loop
  26++65A1 C9               ret
  27++65A2              .checkLF
  28++65A2 7E               ld a, (hl)
  29++65A3 FE 0A            cp 10
  30++65A5 C2 95 65         jp nz, .nextCheck    ;10
  31++65A8 23               inc hl
  32++65A9 C3 95 65         jp  .nextCheck
  33++65AC              .checkEmpty
  34++65AC 7E               ld a, (hl)
  34++65AD A7             and a
  34++65AE C0             ret nz
  35++65AF              .nope
  36++65AF 21 00 00         ld hl, 0
  36++65B2 C9             ret
  37++65B3
# file closed: gopher/render/buffer.asm
   6++65B3                  include "ui.asm"
# file opened: gopher/render/ui.asm
   1++65B3                  IFDEF ZXSCR
   2++65B3                      DEFINE LEFT_TAB "[D]omain:                                  "
   3++65B3                      DEFINE SCREEN_WIDTH 64
   4++65B3                      DEFINE SCREEN64
   5++65B3                  ENDIF
   6++65B3
   7++65B3                  IFDEF TIMEX     ;UNKNOWM fallback to 64
   8++65B3 ~                    DEFINE LEFT_TAB "[D]omain:                                  "
   9++65B3 ~                    DEFINE SCREEN_WIDTH 64
  10++65B3 ~                    DEFINE SCREEN64
  11++65B3                  ENDIF
  12++65B3
  13++65B3                  IFDEF TIMEX80
  14++65B3 ~                    DEFINE LEFT_TAB "[D]omain:                                                      "
  15++65B3 ~                    DEFINE SCREEN_WIDTH 85
  16++65B3 ~                    DEFINE SCREEN85
  17++65B3                  ENDIF
  18++65B3
  19++65B3                  IFDEF NEDOOS
  20++65B3 ~                    DEFINE LEFT_TAB "[D]omain:                                                  "
  21++65B3 ~                    DEFINE SCREEN_WIDTH 80
  22++65B3 ~                    DEFINE SCREEN80
  23++65B3                  ENDIF
  24++65B3
  25++65B3                  IFDEF MSX
  26++65B3 ~                    DEFINE LEFT_TAB "[D]omain:                                              "
  27++65B3 ~                    DEFINE SCREEN_WIDTH 80
  28++65B3 ~                    DEFINE SCREEN80
  29++65B3                  ENDIF
  30++65B3              prepareScreen:
  31++65B3 CD 1D 60         call TextMode.cls
  32++65B6 21 86 66         ld hl, header
  32++65B9 CD BC 60       call TextMode.printZ
  33++65BC 11 0A 00         ld de, #000A
  33++65BF CD 3A 60       call TextMode.gotoXY
  34++65C2 21 58 89         ld hl, hostName
  34++65C5 CD BC 60       call TextMode.printZ
  35++65C8 AF               xor a
  35++65C9 CD 7B 60       call TextMode.highlightLine
  36++65CC C9               ret
  37++65CD
  38++65CD              inputHost:
  39++65CD CD 43 6A         	call Console.waitForKeyUp
  40++65D0              .loop
  41++65D0 11 0A 00         ld de, #000A
  41++65D3 CD 3A 60       call TextMode.gotoXY
  41++65D6 21 58 89       ld hl, hostName
  41++65D9 CD BC 60       call TextMode.printZ
  42++65DC 3E 04            ld a, MIME_INPUT
  42++65DE CD A4 60       call TextMode.putC
  43++65E1 3E 20            ld a, ' '
  43++65E3 CD A4 60       call TextMode.putC
  44++65E6              .wait
  45++65E6 CD 5C 6A         call Console.getC
  46++65E9 5F               ld e, a
  47++65EA FE 0C            cp Console.BACKSPACE
  47++65EC 28 17          jr z, .removeChar
  48++65EE FE 0D            cp CR
  48++65F0 CA 13 66       jp z, inputNavigate
  49++65F3 FE 20            cp 32
  49++65F5 38 EF          jr c, .wait
  50++65F7              .putC
  51++65F7 AF               xor a
  51++65F8 21 58 89 01    ld hl, hostName, bc, 48
  51++65FC 30 00
  51++65FE ED B1          cpir
  52++6600 77               ld (hl), a
  52++6601 2B             dec hl
  52++6602 73             ld (hl), e
  53++6603 18 CB            jr .loop
  54++6605              .removeChar
  55++6605 AF               xor a
  56++6606 21 58 89 01      ld hl, hostName, bc, 48
  56++660A 30 00
  56++660C ED B1          cpir
  57++660E 2B               dec hl
  57++660F 2B             dec hl
  57++6610 77             ld (hl), a
  58++6611 18 BD            jr .loop
  59++6613
  60++6613              inputNavigate:
  61++6613 21 58 89 11      ld hl, hostName, de, domain
  61++6617 46 66
  62++6619 7E               ld a,(hl)
  63++661A A7               and a
  64++661B CA D1 73         jp z, History.load
  65++661E              .loop
  66++661E 7E               ld a, (hl)
  66++661F A7             and a
  66++6620 28 05          jr z, .complete
  67++6622 12               ld (de), a
  67++6623 23 13          inc hl, de
  68++6625 18 F7            jr .loop
  69++6627              .complete
  70++6627 3E 09            ld a, TAB
  70++6629 12             ld (de), a
  70++662A 13             inc de
  71++662B 3E 37            ld a, '7'
  71++662D 12             ld (de), a
  71++662E 13             inc de
  72++662F 3E 30            ld a, '0'
  72++6631 12             ld (de), a
  72++6632 13             inc de
  73++6633 3E 0D            ld a, CR
  73++6635 12             ld (de), a
  73++6636 13             inc de
  74++6637 3E 0A            ld a, LF
  74++6639 12             ld (de), a
  74++663A 13             inc de
  75++663B 21 41 66         ld hl, navRow
  75++663E C3 2A 74       jp History.navigate
  76++6641
  77++6641 31 20 09 2F  navRow db "1 ", TAB, "/", TAB
  77++6645 09
  78++6646 6E 69 68 69  domain db "nihirash.net"
  78++664A 72 61 73 68
  78++664E 2E 6E 65 74
  79++6652 00 00 00...      ds 64 - ($ - domain)
  80++6686
  81++6686 5B 44 5D 6F  header db "[D]omain:                                  ", "MRF "
  81++668A 6D 61 69 6E
  81++668E 3A 20 20 20
  81++6692 20 20 20 20
  81++6696 20 20 20 20
  81++669A 20 20 20 20
  81++669E 20 20 20 20
  81++66A2 20 20 20 20
  81++66A6 20 20 20 20
  81++66AA 20 20 20 20
  81++66AE 20 20 20 4D
  81++66B2 52 46 20
  82++66B5 31 2E 37            db "1.7"
  83++66B8 2E                  db "."
  84++66B9 32 35               db "25"
  85++66BB              	IFDEF MSX
  86++66BB ~                   db "    [MSX UNAPI]",13, 0
  87++66BB              	ENDIF
  88++66BB
  89++66BB                  IFDEF MB03
  90++66BB ~                   db " [MB03+]",13, 0
  91++66BB                     ENDIF
  92++66BB
  93++66BB                  IFDEF UNO
  94++66BB ~                   db " [UNO UART]",13, 0
  95++66BB                  ENDIF
  96++66BB
  97++66BB                  IFDEF AY
  98++66BB 20 5B 41 59         db " [AYWIFI]",13, 0
  98++66BF 57 49 46 49
  98++66C3 5D 0D 00
  99++66C6              	ENDIF
 100++66C6
 101++66C6                  IFDEF ZW
 102++66C6 ~                   db "  [ZXWiFi]",13, 0
 103++66C6                  ENDIF
 104++66C6
 105++66C6                   IFDEF UARTATM
 106++66C6 ~                   db " [ATM UART]",13, 0
 107++66C6                  ENDIF
 108++66C6
 109++66C6                  IFDEF UARTEVO
 110++66C6 ~                    db " [EVO UART]",13, 0
 111++66C6                  ENDIF
 112++66C6
 113++66C6                  IFDEF UNOUART
 114++66C6 ~                    db " [UNO UART]",13, 0
 115++66C6                  ENDIF
 116++66C6
 117++66C6                  IFDEF NEDONET
 118++66C6 ~            	    db "  [nedoNET]",13, 0
 119++66C6              	ENDIF
 120++66C6
# file closed: gopher/render/ui.asm
   7++66C6                  include "gopher-page.asm"
# file opened: gopher/render/gopher-page.asm
   1++66C6              renderGopherScreen:
   2++66C6 3E FF            ld a, 255
   3++66C8 32 25 94         ld (oldminutes), a
   4++66CB CD B3 65         call Render.prepareScreen
   5++66CE
   6++66CE 2A 45 78         ld hl, (page_offset)        ; HL - offset to 0 Row on screen
   7++66D1 44 4D            ld bc,hl                    ; BC - offset to C Row on screen
   8++66D3 CD 7A 65         call Render.findLine        ;BC - Search this line  HL - Return pointer to page with offset
   9++66D6 7C               ld a, h
  10++66D7 B5               or l
  11++66D8 28 21            jr z, .exit2
  12++66DA 7B               ld a, e
  13++66DB AF               xor a
  14++66DC E5               push hl
  15++66DD CD 79 64         call renderRow
  16++66E0 E1               pop hl
  17++66E1
  18++66E1 06 15            ld b, PER_PAGE-1
  19++66E3
  20++66E3              .loop
  21++66E3 C5               push bc
  22++66E4 3E 16            ld a, PER_PAGE
  23++66E6 90               sub b
  24++66E7 5F               ld e,a
  25++66E8
  26++66E8 01 01 00         ld bc, 1
  27++66EB
  28++66EB CD 7D 65         call Render.findLine2   ;BC - Search this line  HL - Return pointer to page with offset
  29++66EE
  30++66EE 7C               ld a, h
  31++66EF B5               or l
  32++66F0 28 06            jr z, .exit
  33++66F2 7B               ld a, e
  34++66F3 E5               push hl
  35++66F4 CD 79 64         call renderRow
  36++66F7 E1               pop hl
  37++66F8              .exit
  38++66F8 C1               pop bc
  39++66F9 10 E8            djnz .loop
  40++66FB              .exit2
  41++66FB CD 0A 68         call showCursor
  42++66FE C9               ret
  43++66FF
  44++66FF              checkBorder:
  45++66FF 3A 43 78         ld a, (cursor_position)
  45++6702 FE FF          cp #ff
  45++6704 CA 2E 68       jp z, pageUp
  46++6707 3A 43 78         ld a, (cursor_position)
  46++670A FE 16          cp PER_PAGE
  46++670C CA 61 68       jp z, pageDn
  47++670F CD 0A 68         call showCursor
  48++6712 C3 15 67         jp workLoop
  49++6715
  50++6715              workLoop:
  51++6715 3A 54 69         ld a, (play_next)
  51++6718 A7             and a
  51++6719 C2 BA 67       jp nz, navigate
  52++671C
  53++671C                  dup 4
  54++671C 76          >    halt
  54++671D 76          >    halt
  54++671E 76          >    halt
  54++671F 76          >    halt
  55++6720                  edup
  56++6720              .nothing
  57++6720
  58++6720 76               halt
  59++6721 CD 80 93         call printRTC
  60++6724
  61++6724 CD 6D 6A         call Console.peekC
  62++6727 A7               and a
  62++6728 CA 20 67       jp z, .nothing
  63++672B
  64++672B FE 31            cp '1'
  64++672D CA BA 73       jp z, History.back
  65++6730 FE 32            cp '2'
  65++6732 CA BA 67       jp z, navigate
  66++6735 FE 33            cp '3'
  66++6737 CA 1A 68       jp z, cursorDown
  67++673A FE 34            cp '4'
  67++673C CA 24 68       jp z, cursorUp
  68++673F FE 35            cp '5'
  68++6741 CA 2E 68       jp z, pageUp
  69++6744 FE 38            cp '8'
  69++6746 CA 61 68       jp z, pageDn
  70++6749 FE 36            cp '6'
  70++674B CA 1A 68       jp z, cursorDown
  71++674E FE 37            cp '7'
  71++6750 CA 24 68       jp z, cursorUp
  72++6753
  73++6753 FE 0A            cp Console.KEY_DN
  73++6755 CA 1A 68       jp z, cursorDown
  74++6758 FE 61            cp 'a'
  74++675A CA 1A 68       jp z, cursorDown
  75++675D FE 0B            cp Console.KEY_UP
  75++675F CA 24 68       jp z, cursorUp
  76++6762 FE 71            cp 'q'
  76++6764 CA 24 68       jp z, cursorUp
  77++6767 FE 08            cp Console.KEY_LT
  77++6769 CA 2E 68       jp z, pageUp
  78++676C FE 6F            cp 'o'
  78++676E CA 2E 68       jp z, pageUp
  79++6771 FE 09            cp Console.KEY_RT
  79++6773 CA 61 68       jp z, pageDn
  80++6776 FE 70            cp 'p'
  80++6778 CA 61 68       jp z, pageDn
  81++677B
  82++677B FE 68            cp 'h'
  82++677D CA 27 74       jp z, History.home
  83++6780 FE 48            cp 'H'
  83++6782 CA 27 74       jp z, History.home
  84++6785
  85++6785 FE 62            cp 'b'
  85++6787 CA BA 73       jp z, History.back
  86++678A FE 42            cp 'B'
  86++678C CA BA 73       jp z, History.back
  87++678F FE 0C            cp Console.BACKSPACE
  87++6791 CA BA 73       jp z, History.back
  88++6794
  89++6794 FE 64            cp 'd'
  89++6796 CA CD 65       jp z, inputHost
  90++6799 FE 44            cp 'D'
  90++679B CA CD 65       jp z, inputHost
  91++679E
  92++679E FE 0D            cp CR
  92++67A0 CA BA 67       jp z, navigate
  93++67A3
  94++67A3 FE 53            cp 'S'
  94++67A5 CC 6D 65       call z, toggleSaveMode
  95++67A8 FE 73        	cp 's'
  95++67AA CC 6D 65       call z, toggleSaveMode
  96++67AD
  97++67AD
  98++67AD                  IFDEF MSX
  99++67AD ~                	cp ESC
  99++67AD ~              jp z, exit
 100++67AD                  ENDIF
 101++67AD
 102++67AD                  IFDEF GS
 103++67AD FE 4D            cp 'M'
 103++67AF CC 74 93       call z, GeneralSound.toggleModule
 104++67B2 FE 6D            cp 'm'
 104++67B4 CC 74 93       call z, GeneralSound.toggleModule
 105++67B7                  ENDIF
 106++67B7
 107++67B7                  IFDEF TIMEX80
 108++67B7 ~                cp 'T'
 108++67B7 ~              call z, TextMode.toggleColor
 109++67B7 ~                cp 't'
 109++67B7 ~              call z, TextMode.toggleColor
 110++67B7                  ENDIF
 111++67B7
 112++67B7 C3 15 67         jp workLoop
 113++67BA
 114++67BA              navigate:
 115++67BA CD 43 6A         call Console.waitForKeyUp
 116++67BD AF               xor a
 116++67BE 32 54 69       ld (play_next), a
 117++67C1 CD 12 68         call hideCursor
 118++67C4 ED 4B 45 78      ld bc, (page_offset)
 119++67C8 2A 43 78         ld hl, (cursor_position)
 120++67CB 09               add hl,bc
 121++67CC 44               ld b, h ;HHHHH
 122++67CD 4D               ld c, l ;LLLLL
 123++67CE D5               push de
 124++67CF CD 7A 65         call Render.findLine
 125++67D2 D1               pop de
 126++67D3 7E               ld a, (hl)
 127++67D4 FE 31            cp '1'
 127++67D6 CA F3 67       jp z, .load
 128++67D9 FE 30            cp '0'
 128++67DB CA F3 67       jp z, .load
 129++67DE FE 39            cp '9'
 129++67E0 CA F3 67       jp z, .load
 130++67E3 FE 37            cp '7'
 130++67E5 CA FB 67       jp z, .input
 131++67E8 FE 73            cp MIME_SOUND
 131++67EA CA F3 67       jp z, .load
 132++67ED CD 0A 68         call showCursor
 133++67F0 C3 15 67         jp workLoop
 134++67F3              .load
 135++67F3 E5               push hl
 136++67F4 CD 8E 64         call getIcon
 137++67F7 E1               pop hl
 138++67F8 C3 2A 74         jp History.navigate
 139++67FB              .input
 140++67FB E5               push hl
 141++67FC CD 55 69         call DialogBox.inputBox
 142++67FF E1               pop hl
 143++6800 3A BA 69         ld a, (DialogBox.inputBuffer)
 143++6803 A7             and a
 143++6804 CA D1 73       jp z, History.load
 144++6807 C3 F3 67         jp .load
 145++680A
 146++680A              showCursor:
 147++680A 3A 43 78         ld a, (cursor_position)
 147++680D C6 02          add CURSOR_OFFSET
 148++680F C3 7B 60         jp TextMode.highlightLine
 149++6812
 150++6812              hideCursor:
 151++6812 3A 43 78         ld a, (cursor_position)
 151++6815 C6 02          add CURSOR_OFFSET
 152++6817 C3 61 60         jp TextMode.usualLine
 153++681A
 154++681A              cursorDown:
 155++681A CD 12 68         call hideCursor
 156++681D 21 43 78         ld hl, cursor_position
 157++6820 34               inc (hl)
 158++6821 C3 FF 66         jp checkBorder
 159++6824
 160++6824              cursorUp:
 161++6824 CD 12 68         call hideCursor
 162++6827 21 43 78         ld hl, cursor_position
 163++682A 35               dec (hl)
 164++682B C3 FF 66         jp checkBorder
 165++682E
 166++682E              pageUp:
 167++682E 3A 45 78         ld a, (page_offset)
 167++6831 FE 00          cp 0
 167++6833 C2 41 68       jp nz, .pageUp2
 168++6836 3A 46 78         ld a, (page_offset + 1)
 168++6839 FE 00          cp 0
 168++683B C2 41 68       jp nz, .pageUp2
 169++683E C3 57 68         jp .skip
 170++6841              .pageUp2:
 171++6841 3E 15            ld a, PER_PAGE - 1
 171++6843 32 43 78       ld (cursor_position), a
 172++6846 2A 45 78         ld hl, (page_offset)
 173++6849 11 16 00         ld de,PER_PAGE
 174++684C ED 52            sbc hl,de
 175++684E 22 45 78         ld (page_offset), hl
 176++6851              .exit
 177++6851 CD C6 66         call renderGopherScreen
 178++6854 C3 15 67         jp workLoop
 179++6857              .skip
 180++6857 AF               xor a
 180++6858 32 43 78       ld (cursor_position), a
 180++685B CD C6 66       call renderGopherScreen
 180++685E C3 15 67       jp workLoop
 181++6861
 182++6861              pageDn:
 183++6861 AF                xor a
 183++6862 32 43 78       ld (cursor_position), a
 184++6865 2A 45 78         ld hl,(page_offset)
 185++6868 11 16 00         ld de,PER_PAGE
 186++686B 19               add hl,de
 187++686C 22 45 78         ld (page_offset), hl
 188++686F C3 51 68         jp pageUp.exit
 189++6872
# file closed: gopher/render/gopher-page.asm
   8++6872                  include "plaintext.asm"
# file opened: gopher/render/plaintext.asm
   1++6872              renderPlainTextScreen:
   2++6872 3E FF            ld a, 255
   3++6874 32 25 94         ld (oldminutes), a
   4++6877 CD B3 65         call prepareScreen
   5++687A
   6++687A 2A 45 78         ld hl, (page_offset)        ; HL - offset to 0 Row on screen
   7++687D 44 4D            ld bc,hl                    ; BC - offset to C Row on screen
   8++687F CD 7A 65         call Render.findLine        ;BC - Search this line  HL - Return pointer to page with offset
   9++6882 7C               ld a, h
  10++6883 B5               or l
  11++6884 28 30            jr z, .exit2
  12++6886 AF               xor a
  13++6887 C6 02            add CURSOR_OFFSET
  13++6889 57 1E 01       ld d, a, e, 1
  13++688C CD 3A 60       call TextMode.gotoXY
  14++688F CD 48 64         call print70Text
  15++6892 06 15            ld b, PER_PAGE -1
  16++6894              .loop
  17++6894 C5               push bc
  18++6895 3E 16            ld a, PER_PAGE
  19++6897 90               sub b
  20++6898 5F               ld e,a
  21++6899 01 01 00         ld bc, 1
  22++689C CD 7D 65         call Render.findLine2   ;BC - Search this line  HL - Return pointer to page with offset
  23++689F 7C               ld a, h
  24++68A0 B5               or l
  25++68A1 28 10            jr z, .exit
  26++68A3 7B               ld a, e
  27++68A4 C6 02            add CURSOR_OFFSET
  27++68A6 57 1E 01       ld d, a, e, 1
  27++68A9 CD 3A 60       call TextMode.gotoXY
  28++68AC CD 48 64         call print70Text
  29++68AF C1               pop bc
  30++68B0 10 E2            djnz .loop
  31++68B2 C9               ret
  32++68B3              .exit
  33++68B3 C1               pop bc
  34++68B4 10 DE            djnz .loop
  35++68B6              .exit2
  36++68B6 CD 0A 68         call showCursor
  37++68B9 C9               ret
  38++68BA              plainTextLoop:
  39++68BA CD 80 93         call printRTC
  40++68BD CD 5C 6A         call Console.getC
  41++68C0
  42++68C0 FE 31            cp '1'
  42++68C2 CA BA 73       jp z, History.back
  43++68C5 FE 32            cp '2'
  43++68C7 CA BA 67       jp z, navigate
  44++68CA FE 35            cp '5'
  44++68CC CA 32 69       jp z, textUp
  45++68CF FE 38            cp '8'
  45++68D1 CA 22 69       jp z, textDown
  46++68D4 FE 08            cp Console.KEY_LT
  46++68D6 CA 32 69       jp z, textUp
  47++68D9 FE 09            cp Console.KEY_RT
  47++68DB CA 22 69       jp z, textDown
  48++68DE
  49++68DE FE 0A            cp Console.KEY_DN
  49++68E0 CA 22 69       jp z, textDown
  50++68E3 FE 61            cp 'a'
  50++68E5 CA 22 69       jp z, textDown
  51++68E8
  52++68E8 FE 0B            cp Console.KEY_UP
  52++68EA CA 32 69       jp z, textUp
  53++68ED FE 71            cp 'q'
  53++68EF CA 32 69       jp z, textUp
  54++68F2
  55++68F2 FE 68            cp 'h'
  55++68F4 CA 27 74       jp z, History.home
  56++68F7 FE 48            cp 'H'
  56++68F9 CA 27 74       jp z, History.home
  57++68FC
  58++68FC FE 62            cp 'b'
  58++68FE CA BA 73       jp z, History.back
  59++6901 FE 42            cp 'B'
  59++6903 CA BA 73       jp z, History.back
  60++6906
  61++6906 FE 64            cp 'd'
  61++6908 CA CD 65       jp z, inputHost
  62++690B FE 44            cp 'D'
  62++690D CA CD 65       jp z, inputHost
  63++6910
  64++6910 FE 0C            cp Console.BACKSPACE
  64++6912 CA BA 73       jp z, History.back
  65++6915
  66++6915                  IFDEF MSX
  67++6915 ~                	cp ESC
  67++6915 ~              jp z, exit
  68++6915                  ENDIF
  69++6915
  70++6915                  IFDEF GS
  71++6915 FE 4D            cp 'M'
  71++6917 CC 74 93       call z, GeneralSound.toggleModule
  72++691A FE 6D            cp 'm'
  72++691C CC 74 93       call z, GeneralSound.toggleModule
  73++691F                  ENDIF
  74++691F
  75++691F                  IFDEF TIMEX80
  76++691F ~                cp 'T'
  76++691F ~              call z, TextMode.toggleColor
  77++691F ~                cp 't'
  77++691F ~              call z, TextMode.toggleColor
  78++691F                  ENDIF
  79++691F
  80++691F C3 BA 68         jp plainTextLoop
  81++6922
  82++6922
  83++6922              textDown:
  84++6922 2A 45 78         ld hl,(page_offset)
  85++6925 11 16 00         ld de,PER_PAGE
  86++6928 19               add hl,de
  87++6929 22 45 78         ld (page_offset), hl
  88++692C CD 72 68         call renderPlainTextScreen
  89++692F C3 BA 68         jp plainTextLoop
  90++6932
  91++6932              textUp:
  92++6932 3A 45 78         ld a, (page_offset)
  92++6935 FE 00          cp 0
  92++6937 20 0A          jr nz, .textUp2
  93++6939 3A 46 78         ld a, (page_offset + 1)
  93++693C FE 00          cp 0
  93++693E 20 03          jr nz, .textUp2
  94++6940 C3 BA 68         jp plainTextLoop
  95++6943
  96++6943              .textUp2:
  97++6943 2A 45 78         ld hl,(page_offset)
  98++6946 11 16 00         ld de,PER_PAGE
  99++6949 ED 52            sbc hl,de
 100++694B 22 45 78         ld (page_offset), hl
 101++694E CD 72 68         call renderPlainTextScreen
 102++6951 C3 BA 68         jp plainTextLoop
 103++6954
# file closed: gopher/render/plaintext.asm
   9++6954
  10++6954 00           play_next       db  0
  11++6955              position        EQU historyBlock.position
  12++6955              cursor_position EQU position + 2
  13++6955              page_offset     EQU position + 4
  14++6955
  15++6955                  ENDMODULE
  16++6955
  17++6955                  include "dialogbox.asm"
# file opened: gopher/render/dialogbox.asm
   1++6955                  module DialogBox
   2++6955
   3++6955              inputBox:
   4++6955 AF               xor a
   4++6956 32 BA 69       ld (inputBuffer), a
   5++6959              .noclear
   6++6959 CD 1B 6A         call drawBox
   7++695C              .loop
   8++695C 11 05 0B         ld de, #0B05
   8++695F CD 3A 60       call TextMode.gotoXY
   9++6962 21 BA 69         ld hl, inputBuffer
   9++6965 CD BC 60       call TextMode.printZ
  10++6968 3E 04            ld a, MIME_INPUT
  10++696A CD A4 60       call TextMode.putC
  10++696D 3E 20          ld a, ' '
  10++696F CD A4 60       call TextMode.putC
  11++6972              .checkkey
  12++6972 CD 6D 6A         call Console.peekC
  13++6975 FE 00            cp 00
  13++6977 CA 72 69        jp z, .checkkey
  14++697A FE 0D            cp CR
  14++697C C8             ret z
  15++697D
  16++697D                  IFNDEF MSX
  17++697D                  dup 11
  18++697D 76          >    halt
  18++697E 76          >    halt
  18++697F 76          >    halt
  18++6980 76          >    halt
  18++6981 76          >    halt
  18++6982 76          >    halt
  18++6983 76          >    halt
  18++6984 76          >    halt
  18++6985 76          >    halt
  18++6986 76          >    halt
  18++6987 76          >    halt
  19++6988                  edup
  20++6988                  ENDIF
  21++6988
  22++6988 FE 0C            cp Console.BACKSPACE
  22++698A 28 13          jr z, .removeChar
  23++698C FE 20            cp SPACE
  23++698E 38 E2          jr c, .checkkey
  24++6990              .putC
  25++6990 5F               ld e, a
  26++6991 AF               xor a
  26++6992 21 BA 69 01    ld hl, inputBuffer, bc, #ff
  26++6996 FF 00
  26++6998 ED B1          cpir
  27++699A 77               ld (hl), a
  27++699B 2B             dec hl
  27++699C 73             ld (hl), e
  28++699D 18 BD            jr .loop
  29++699F              .removeChar
  30++699F AF               xor a
  31++69A0 21 BA 69 01      ld hl, inputBuffer, bc, #ff
  31++69A4 FF 00
  31++69A6 ED B1          cpir
  32++69A8 E5               push hl
  33++69A9 11 BB 69             ld de, inputBuffer + 1
  34++69AC B7                   or a
  34++69AD ED 52          sbc hl, de
  35++69AF 7C                   ld a, h
  35++69B0 B5             or l
  36++69B1 E1               pop hl
  37++69B2 28 A8            jr z, .loop
  38++69B4 AF               xor a
  39++69B5 2B               dec hl
  39++69B6 2B             dec hl
  39++69B7 77             ld (hl), a
  40++69B8 18 A2            jr .loop
  41++69BA
  42++69BA
  43++69BA              namedownload
  44++69BA                  IFDEF NEDOOS
  45++69BA ~            		db "..",92,"downloads",92
  46++69BA                  ENDIF
  47++69BA
  48++69BA 00 00 00...  inputBuffer ds 80
  49++6A0A
  50++6A0A              msgBox:
  51++6A0A CD 13 6A         call msgNoWait
  52++6A0D 06 96            ld b, 150
  53++6A0F              .loop
  54++6A0F 76               halt
  55++6A10 10 FD            djnz .loop
  56++6A12 C9               ret
  57++6A13
  58++6A13              msgNoWait:
  59++6A13 E5               push hl
  60++6A14 CD 1B 6A         call drawBox
  61++6A17 E1               pop hl
  62++6A18 C3 BC 60         jp TextMode.printZ
  63++6A1B
  64++6A1B              drawBox:
  65++6A1B 26 0A 3E 09      ld h, #0a, a, BORDER_TOP
  66++6A1F CD 47 60         call TextMode.fillLine
  67++6A22 26 0B 3E 20      ld h, #0b, a, ' '
  68++6A26 CD 47 60         call TextMode.fillLine
  69++6A29 26 0C 3E 08      ld h, #0c, a, BORDER_BOTTOM
  70++6A2D CD 47 60         call TextMode.fillLine
  71++6A30 3E 0A            ld a, #0a
  72++6A32 CD 7B 60         call TextMode.highlightLine
  73++6A35 3E 0C            ld a, #0c
  74++6A37 CD 7B 60         call TextMode.highlightLine
  75++6A3A 11 03 0B         ld de,#0B03
  76++6A3D CD 3A 60         call TextMode.gotoXY
  77++6A40 C9               ret
  78++6A41                  endmodule
  79++6A41
# file closed: gopher/render/dialogbox.asm
# file closed: gopher/render/index.asm
  18+ 6A41                  include "dos/index.asm"
# file opened: dos/index.asm
   1++6A41              	IFDEF NEDOOS
   2++6A41 ~            	    include "nedoconsole.asm"
   3++6A41 ~            		include "nedoos.asm"
   4++6A41              	ENDIF
   5++6A41
   6++6A41              	IFDEF TRDOS
   7++6A41                  	include "console.asm"
# file opened: dos/console.asm
   1++6A41                  module Console
   2++6A41              KEY_UP = 11
   3++6A41              KEY_DN = 10
   4++6A41              KEY_LT = 8
   5++6A41              KEY_RT = 9
   6++6A41              BACKSPACE = 12
   7++6A41              BASIC_KEY = #5C08
   8++6A41 00           keyCode db 0
   9++6A42 00           tableShift db 0
  10++6A43
  11++6A43              waitForKeyUp:
  12++6A43 76           	halt
  13++6A44 AF              xor a
  13++6A45 DB FE          in a, (#fe)
  13++6A47 2F             cpl
  13++6A48 E6 1F          and 31
  13++6A4A 20 F7          jr nz, waitForKeyUp
  14++6A4C 32 08 5C        ld (BASIC_KEY), a
  15++6A4F C9              ret
  16++6A50
  17++6A50              keyWait:
  18++6A50                  dup 11
  19++6A50 76          >    halt
  19++6A51 76          >    halt
  19++6A52 76          >    halt
  19++6A53 76          >    halt
  19++6A54 76          >    halt
  19++6A55 76          >    halt
  19++6A56 76          >    halt
  19++6A57 76          >    halt
  19++6A58 76          >    halt
  19++6A59 76          >    halt
  19++6A5A 76          >    halt
  20++6A5B                  edup
  21++6A5B C9              ret
  22++6A5C
  23++6A5C              getC:
  24++6A5C              getCint:       ; for nedoOS
  25++6A5C AF              xor a
  26++6A5D 32 08 5C        ld (BASIC_KEY),a
  27++6A60              getC2:
  28++6A60 3A 08 5C        ld a,(BASIC_KEY)
  29++6A63 A7              and a
  29++6A64 28 FA          jr z, getC2
  30++6A66 47              ld b,a
  31++6A67 AF              xor a
  31++6A68 32 08 5C       ld (BASIC_KEY), a
  32++6A6B 78              ld a, b
  33++6A6C C9              ret
  34++6A6D              ;0xE - to Russian
  35++6A6D              ;0xF - to Englich
  36++6A6D              peekC:
  37++6A6D AF               xor a
  37++6A6E 32 08 5C       ld (BASIC_KEY),a
  38++6A71 CD 91 6A         call inkey
  39++6A74 FE 0E            cp 0xE
  40++6A76 CA 7F 6A         jp z, toRus
  41++6A79 FE 0F            cp 0xF
  42++6A7B CA 89 6A         jp z, toEng
  43++6A7E C9               ret
  44++6A7F              toRus
  45++6A7F 3E A0           ld a, russiantable - englishTable
  46++6A81 32 42 6A        ld (tableShift), a
  47++6A84 AF              xor a
  48++6A85 CD 50 6A        call keyWait
  49++6A88 C9              ret
  50++6A89              toEng
  51++6A89 AF              xor a
  52++6A8A 32 42 6A        ld (tableShift), a
  53++6A8D CD 50 6A        call keyWait
  54++6A90 C9              ret
  55++6A91
  56++6A91              inkey:
  57++6A91 11 00 00        ld de,0
  58++6A94 01 FE FE        ld bc,$fefe
  59++6A97 ED 78           in a,(c)
  60++6A99 F6 E1           or $e1
  61++6A9B FE FF           cp $ff
  62++6A9D 20 57           jr nz, .keyhitA
  63++6A9F
  64++6A9F 1E 05           ld e,5
  65++6AA1 06 FD           ld b,$fd
  66++6AA3 ED 78           in a,(c)
  67++6AA5 F6 E0           or $e0
  68++6AA7 FE FF           cp $ff
  69++6AA9 20 4B           jr nz, .keyhitA
  70++6AAB
  71++6AAB 1E 0A           ld e,10
  72++6AAD 06 FB           ld b,$fb
  73++6AAF ED 78           in a,(c)
  74++6AB1 F6 E0           or $e0
  75++6AB3 FE FF           cp $ff
  76++6AB5 20 3F           jr nz, .keyhitA
  77++6AB7
  78++6AB7 1E 0F           ld e,15
  79++6AB9 06 F7           ld b,$f7
  80++6ABB ED 78           in a,(c)
  81++6ABD F6 E0           or $e0
  82++6ABF FE FF           cp $ff
  83++6AC1 20 33           jr nz, .keyhitA
  84++6AC3
  85++6AC3 1E 14           ld e,20
  86++6AC5 06 EF           ld b,$ef
  87++6AC7 ED 78           in a,(c)
  88++6AC9 F6 E0           or $e0
  89++6ACB FE FF           cp $ff
  90++6ACD 20 27           jr nz, .keyhitA
  91++6ACF
  92++6ACF 1E 19           ld e,25
  93++6AD1 06 DF           ld b,$df
  94++6AD3 ED 78           in a,(c)
  95++6AD5 F6 E0           or $e0
  96++6AD7 FE FF           cp $ff
  97++6AD9 20 1B           jr nz, .keyhitA
  98++6ADB
  99++6ADB 1E 1E           ld e,30
 100++6ADD 06 BF           ld b,$bf
 101++6ADF ED 78           in a,(c)
 102++6AE1 F6 E0           or $e0
 103++6AE3 FE FF           cp $ff
 104++6AE5 20 0F           jr nz, .keyhitA
 105++6AE7
 106++6AE7 1E 23           ld e,35
 107++6AE9 06 7F           ld b,$7f
 108++6AEB ED 78           in a,(c)
 109++6AED F6 E2           or $e2
 110++6AEF FE FF           cp $ff
 111++6AF1 4F              ld c,a
 112++6AF2 20 19           jr nz, .keyhitB
 113++6AF4
 114++6AF4              .nokey
 115++6AF4 AF              xor a
 116++6AF5 C9              ret
 117++6AF6
 118++6AF6              .keyhitA
 119++6AF6
 120++6AF6 4F              ld c,a
 121++6AF7
 122++6AF7 78              ld a,b
 123++6AF8 2F              cpl
 124++6AF9 F6 81           or $81
 125++6AFB DB FE           in a,($fe)
 126++6AFD F6 E0           or $e0
 127++6AFF FE FF           cp $ff
 128++6B01 20 F1           jr nz, .nokey
 129++6B03
 130++6B03 3E 7F           ld a,$7f
 131++6B05 DB FE           in a,($fe)
 132++6B07 F6 E2           or $e2
 133++6B09 FE FF           cp $ff
 134++6B0B 20 E7           jr nz, .nokey
 135++6B0D
 136++6B0D              .keyhitB
 137++6B0D
 138++6B0D 06 00           ld b,0
 139++6B0F 21 5B 6A        ld hl,.rowtbl-$e0
 140++6B12 09              add hl,bc
 141++6B13 7E              ld a,(hl)
 142++6B14 FE 05           cp 5
 143++6B16 30 DC           jr nc, .nokey
 144++6B18 83              add a,e
 145++6B19 5F              ld e,a
 146++6B1A
 147++6B1A 21 5B 6B        ld  hl, englishTable
 148++6B1D 19              add hl, de
 149++6B1E 3A 42 6A        ld  a, (tableShift)
 150++6B21 5F              ld e, a
 151++6B22 19              add hl, de
 152++6B23 3E FE           ld a,$fe
 153++6B25 DB FE           in a,($fe)
 154++6B27 E6 01           and $01
 155++6B29 20 03           jr nz, .nocaps
 156++6B2B 1E 28           ld e,40
 157++6B2D 19              add hl,de
 158++6B2E
 159++6B2E              .nocaps
 160++6B2E
 161++6B2E 3E 7F           ld a,$7f
 162++6B30 DB FE           in a,($fe)
 163++6B32 E6 02           and $02
 164++6B34 20 03           jr nz, .nosym
 165++6B36 1E 50           ld e,80
 166++6B38 19              add hl,de
 167++6B39
 168++6B39              .nosym
 169++6B39
 170++6B39 7E              ld a,(hl)
 171++6B3A C9              ret
 172++6B3B
 173++6B3B              .rowtbl
 174++6B3B FF FF FF FF     defb 255,255,255,255,255,255,255
 174++6B3F FF FF FF
 175++6B42 FF FF FF FF     defb 255,255,255,255,255,255,255,255
 175++6B46 FF FF FF FF
 176++6B4A 04 FF FF FF     defb 4,255,255,255,255,255,255
 176++6B4E FF FF FF
 177++6B51 FF 03 FF FF     defb 255,3,255,255,255,2,255,1
 177++6B55 FF 02 FF 01
 178++6B59 00 FF           defb 0,255
 179++6B5B
 180++6B5B              englishTable
 181++6B5B 00 7A 78 63     db 0,'z','x','c','v'      ; CAPS SHIFT, Z, X, C, V
 181++6B5F 76
 182++6B60 61 73 64 66     db 'a','s','d','f','g'      ; A, S, D, F, G
 182++6B64 67
 183++6B65 71 77 65 72     db 'q','w','e','r','t'      ; Q, W, E, R, T
 183++6B69 74
 184++6B6A 31 32 33 34     db '1','2','3','4','5'      ; 1, 2, 3, 4, 5
 184++6B6E 35
 185++6B6F 30 39 38 37     db '0','9','8','7','6'      ; 0, 9, 8, 7, 6
 185++6B73 36
 186++6B74 70 6F 69 75     db 'p','o','i','u','y'      ; P, O, I, U, Y
 186++6B78 79
 187++6B79 0D 6C 6B 6A     db 13,'l','k','j','h'       ; ENTER, L, K, J, H
 187++6B7D 68
 188++6B7E 20 00 6D 6E     db ' ',0,'m','n','b'      ; SPACE, SYM SHIFT, M, N, B
 188++6B82 62
 189++6B83
 190++6B83                 ; the following are CAPS SHIFTed
 191++6B83
 192++6B83 00 5A 58 43     db 0,'Z','X','C','V'      ; CAPS SHIFT, Z, X, C, V
 192++6B87 56
 193++6B88 41 53 44 46     db 'A','S','D','F','G'      ; A, S, D, F, G
 193++6B8C 47
 194++6B8D 51 57 45 52     db 'Q','W','E','R','T'      ; Q, W, E, R, T
 194++6B91 54
 195++6B92 0E 06 80 81     db 14,6,128,129,8           ; 1, 2, 3, 4, 5
 195++6B96 08
 196++6B97 0C 00 09 0B     db 12,0,9,11,10             ; 0, 9, 8, 7, 6
 196++6B9B 0A
 197++6B9C 50 4F 49 55     db 'P','O','I','U','Y'      ; P, O, I, U, Y
 197++6BA0 59
 198++6BA1 0D 4C 4B 4A     db 13,'L','K','J','H'       ; ENTER, L, K, J, H
 198++6BA5 48
 199++6BA6 20 00 4D 4E     db ' ',0,'M','N','B'      ; SPACE, SYM SHIFT, M, N, B
 199++6BAA 42
 200++6BAB
 201++6BAB                 ; the following are SYM SHIFTed
 202++6BAB
 203++6BAB 00 3A 60 3F     db 0,':',96,'?','/'       ; CAPS SHIFT, Z, X, C, V
 203++6BAF 2F
 204++6BB0 7E 7C 5C 7B     db '~','|',92,'{','}'       ; A, S, D, F, G
 204++6BB4 7D
 205++6BB5 83 84 85 3C     db 131,132,133,'<','>'      ; Q, W, E, R, T
 205++6BB9 3E
 206++6BBA 21 40 23 24     db '!','@','#','$','%'      ; 1, 2, 3, 4, 5
 206++6BBE 25
 207++6BBF 5F 29 28 27     db '_',')','(',39,'&'       ; 0, 9, 8, 7, 6
 207++6BC3 26
 208++6BC4 22 3B 82 5D     db 34,';',130,']','['       ; P, O, I, U, Y
 208++6BC8 5B
 209++6BC9 0D 3D 2B 2D     db 13,'=','+','-','^'       ; ENTER, L, K, J, H
 209++6BCD 5E
 210++6BCE 20 00 2E 2C     db ' ',0,'.',',','*'      ; SPACE, SYM SHIFT, M, N, B
 210++6BD2 2A
 211++6BD3
 212++6BD3                 ; the following are CAPS SHIFTed and SYM SHIFTed ("CTRL" key)
 213++6BD3
 214++6BD3 00 1A 18 03     db 0,26,24,3,22           ; CAPS SHIFT, Z, X, C, V
 214++6BD7 16
 215++6BD8 01 13 04 06     db 1,19,4,6,7               ; A, S, D, F, G
 215++6BDC 07
 216++6BDD 11 17 05 12     db 17,23,5,18,20            ; Q, W, E, R, T
 216++6BE1 14
 217++6BE2 1B 1C 1D 1E     db 27,28,29,30,31           ; 1, 2, 3, 4, 5
 217++6BE6 1F
 218++6BE7 7F 00 86 60     db 127,0,134,'`',135      ; 0, 9, 8, 7, 6
 218++6BEB 87
 219++6BEC 10 0F 09 15     db 16,15,9,21,25            ; P, O, I, U, Y
 219++6BF0 19
 220++6BF1 0D 0C 0B 0A     db 13,12,11,10,8            ; ENTER, L, K, J, H
 220++6BF5 08
 221++6BF6 20 00 0D 0E     db ' ',0,13,14,2          ; SPACE, SYM SHIFT, M, N, B
 221++6BFA 02
 222++6BFB
 223++6BFB              russiantable
 224++6BFB 00 EF E7 E1     db 0,'','','',''      ; CAPS SHIFT, Z, X, C, V
 224++6BFF AC
 225++6C00 E4 EB A2 A0     db '','','','',''      ; A, S, D, F, G
 225++6C04 AF
 226++6C05 A9 E6 E3 AA     db '','','','',''      ; Q, W, E, R, T
 226++6C09 A5
 227++6C0A 31 32 33 34     db '1','2','3','4','5'      ; 1, 2, 3, 4, 5
 227++6C0E 35
 228++6C0F 30 39 38 37     db '0','9','8','7','6'      ; 0, 9, 8, 7, 6
 228++6C13 36
 229++6C14 A7 E9 E8 A3     db '','','','',''      ; P, O, I, U, Y
 229++6C18 AD
 230++6C19 0D A4 AB AE     db 13,'','','',''       ; ENTER, L, K, J, H
 230++6C1D E0
 231++6C1E 20 00 EC E2     db ' ',0,'','',''      ; SPACE, SYM SHIFT, M, N, B
 231++6C22 A8
 232++6C23
 233++6C23                 ; the following are CAPS SHIFTed
 234++6C23
 235++6C23 00 9F 97 91     db 0,'','','',''      ; CAPS SHIFT, Z, X, C, V
 235++6C27 8C
 236++6C28 94 9B 82 80     db '','','','',''      ; A, S, D, F, G
 236++6C2C 8F
 237++6C2D 89 96 93 8A     db '','','','',''      ; Q, W, E, R, T
 237++6C31 85
 238++6C32 0F 06 80 81     db 15,6,128,129,8            ; 1, 2, 3, 4, 5
 238++6C36 08
 239++6C37 0C 00 09 0B     db 12,0,9,11,10             ; 0, 9, 8, 7, 6
 239++6C3B 0A
 240++6C3C 87 99 98 83     db '','','','',''      ; P, O, I, U, Y
 240++6C40 8D
 241++6C41 0D 84 8B 8E     db 13,'','','',''       ; ENTER, L, K, J, H
 241++6C45 90
 242++6C46 20 00 9C 92     db ' ',0,'','',''      ; SPACE, SYM SHIFT, M, N, B
 242++6C4A 88
 243++6C4B
 244++6C4B                 ; the following are SYM SHIFTed
 245++6C4B
 246++6C4B 00 3A EE 3F     db 0,':','','?','/'       ; CAPS SHIFT, Z, X, C, V
 246++6C4F 2F
 247++6C50 A1 ED 5C E5     db '','',92,'',''       ; A, S, D, F, G
 247++6C54 A6
 248++6C55 83 84 85 3C     db 131,132,133,'<','>'      ; Q, W, E, R, T
 248++6C59 3E
 249++6C5A 21 40 23 24     db '!','@','#','$','%'      ; 1, 2, 3, 4, 5
 249++6C5E 25
 250++6C5F 5F 29 28 27     db '_',')','(',39,'&'       ; 0, 9, 8, 7, 6
 250++6C63 26
 251++6C64 22 3B 82 5D     db 34,';',130,']','['       ; P, O, I, U, Y
 251++6C68 5B
 252++6C69 0D 3D 2B 2D     db 13,'=','+','-','^'       ; ENTER, L, K, J, H
 252++6C6D 5E
 253++6C6E 20 00 2E 2C     db ' ',0,'.',',','*'      ; SPACE, SYM SHIFT, M, N, B
 253++6C72 2A
 254++6C73
 255++6C73                 ; the following are CAPS SHIFTed and SYM SHIFTed ("CTRL" key)
 256++6C73
 257++6C73 00 1A 9E 03     db 0,26,'',3,22           ; CAPS SHIFT, Z, X, C, V
 257++6C77 16
 258++6C78 81 9D 04 95     db '','',4,'',''               ; A, S, D, F, G
 258++6C7C 86
 259++6C7D 11 17 05 12     db 17,23,5,18,20            ; Q, W, E, R, T
 259++6C81 14
 260++6C82 1B 1C 1D 1E     db 27,28,29,30,31           ; 1, 2, 3, 4, 5
 260++6C86 1F
 261++6C87 7F 00 86 60     db 127,0,134,'`',135      ; 0, 9, 8, 7, 6
 261++6C8B 87
 262++6C8C 10 0F 09 15     db 16,15,9,21,25            ; P, O, I, U, Y
 262++6C90 19
 263++6C91 0D 0C 0B 0A     db 13,12,11,10,8            ; ENTER, L, K, J, H
 263++6C95 08
 264++6C96 20 00 0D 0E     db ' ',0,13,14,2          ; SPACE, SYM SHIFT, M, N, B
 264++6C9A 02
 265++6C9B
 266++6C9B                  endmodule
# file closed: dos/console.asm
   8++6C9B              		include "trdos.asm"
# file opened: dos/trdos.asm
   1++6C9B              ;trdos driver (izzx)
   2++6C9B                  MODULE Dos
   3++6C9B              ; API methods
   4++6C9B              ESX_GETSETDRV = #89
   5++6C9B              ESX_FOPEN = #9A
   6++6C9B              ESX_FCLOSE = #9B
   7++6C9B              ESX_FSYNC = #9C
   8++6C9B              ESX_FREAD = #9D
   9++6C9B              ESX_FWRITE = #9E
  10++6C9B
  11++6C9B              ; File modes
  12++6C9B              FMODE_READ = #01
  13++6C9B              FMODE_WRITE = #06
  14++6C9B              FMODE_CREATE = #0E
  15++6C9B
  16++6C9B                  ; MACRO esxCall func
  17++6C9B                  ; rst #8 : db func
  18++6C9B                  ; ENDM
  19++6C9B
  20++6C9B              ;id = 0 䠩  
  21++6C9B              ;id = 1 䠩  ⥭
  22++6C9B              ;id = 2 䠩  
  23++6C9B              ;id = 3 䠩   ⨯ TRD
  24++6C9B              ;id = 4 䠩   ⨯ SCL
  25++6C9B
  26++6C9B              ; HL - filename in ASCIIZ
  27++6C9B              loadBuffer:
  28++6C9B 06 01            ld b, Dos.FMODE_READ
  28++6C9D CD B7 6C       call Dos.fopen
  29++6CA0 F5               push af
  30++6CA1 21 59 A1 01          ld hl, outputBuffer, bc, #ffff - outputBuffer
  30++6CA5 A6 5E
  30++6CA7 CD 0E 6F       call Dos.fread
  31++6CAA 21 59 A1             ld hl, outputBuffer
  31++6CAD 09             add hl, bc
  31++6CAE AF             xor a
  31++6CAF 77             ld (hl), a
  31++6CB0 23             inc hl
  31++6CB1 77             ld (hl), a
  32++6CB2 F1               pop af
  33++6CB3 CD 02 6E         call Dos.fclose
  34++6CB6 C9               ret
  35++6CB7
  36++6CB7
  37++6CB7              ; Returns:
  38++6CB7              ;  A - current drive
  39++6CB7              ; getDefaultDrive: ;  ᯮ
  40++6CB7                  ; ld a, 0 : esxCall ESX_GETSETDRV
  41++6CB7                  ; ret
  42++6CB7
  43++6CB7
  44++6CB7
  45++6CB7              ; Opens file on default drive
  46++6CB7              ; B - File mode
  47++6CB7              ; HL - File name
  48++6CB7              ; Returns:
  49++6CB7              ;  A - file stream id
  50++6CB7              fopen:
  51++6CB7                  ; push bc : push hl
  52++6CB7                  ; call getDefaultDrive
  53++6CB7                  ; pop ix : pop bc
  54++6CB7                  ; esxCall ESX_FOPEN
  55++6CB7                  ; ret
  56++6CB7 78           	ld a,b
  57++6CB8 FE 01        	cp FMODE_READ ;᫨ ० ⨥ 䠩
  58++6CBA 28 06        	jr z,fopen_r
  59++6CBC FE 0E        	cp FMODE_CREATE
  60++6CBE 28 39        	jr z,fopen_c ;᫨ ० ᮧ 䠩
  61++6CC0 18 34        	jr fopen_err ; 室
  62++6CC2
  63++6CC2              fopen_r	;⨥ 饣 䠩  ⥭ (id=1)
  64++6CC2              	; ld a,(#5D19) ; ᪮  㬮砭
  65++6CC2              	; ld 	(prev_drive),a ;
  66++6CC2 CD 98 72     			call format_name ;
  67++6CC5 0E 13        			ld      c,#13 ;move file info to syst var
  68++6CC7 CD FE 6D                 call    call3d13
  69++6CCA 0E 0A                    ld      c,#0a ;find file
  70++6CCC CD FE 6D                 call    call3d13
  71++6CCF 79                       ld      a,c
  72++6CD0 FE FF        			cp 		#ff
  73++6CD2 28 22        			jr 		z,fopen_err ;᫨  諨 䠩
  74++6CD4 0E 08                    ld      c,#08 ;read file title
  75++6CD6 CD FE 6D                 call    call3d13
  76++6CD9                          ;ld      hl,loadadr ;㤠
  77++6CD9 ED 5B EB 5C              ld      de,(#5ceb) ;砫 䠩 ᥪ ஦
  78++6CDD ED 53 65 73              ld      (f_r_cur_trk),de
  79++6CE1
  80++6CE1 3A EA 5C                 ld      a,(#5cea)
  81++6CE4 32 67 73                 ld      (f_r_len_sec),a ;  ᥪ
  82++6CE7                          ;or      a
  83++6CE7                          ;ret     z    ;室 ᫨ ⮩
  84++6CE7
  85++6CE7 ED 5B E8 5C  			ld de,(#5CE8) ;  䠩  ணࠬ   BASIC
  86++6CEB ED 53 68 73  			ld      (f_r_len),de
  87++6CEF
  88++6CEF                          ; ld      de,(fcurtrk) ;⥪騥 ᥪ ஦
  89++6CEF                          ; ld      (#5cf4),de ;⠭
  90++6CEF AF           			xor a
  91++6CF0 3E 01        			ld 		a,1
  92++6CF2 32 6A 73     			ld (f_r_flag),a ;䫠  䠩  ⥭ 
  93++6CF5              			;id  㤥 1
  94++6CF5 C9           	ret
  95++6CF6
  96++6CF6              fopen_err
  97++6CF6 AF           	xor a ;᫨  䠩  뫨,  id = 0
  98++6CF7 37           	scf ;䫠 訡
  99++6CF8 C9           	ret
 100++6CF9
 101++6CF9
 102++6CF9              fopen_c	;ᮧ  䠩 (id=2-4)
 103++6CF9              	; ld a,(#5D19) ; ᪮  㬮砭
 104++6CF9              	; ld 	(prev_drive),a ;
 105++6CF9 CD 98 72     	call format_name ;
 106++6CFC              	;᭨,  ࠧ    ࠧ稢
 107++6CFC 21 41 73         ld hl, trdExt1
 107++6CFF CD F2 63       call CompareBuff.search
 107++6D02 A7             and a
 107++6D03 20 7B          jr nz, fopen_c_trd
 108++6D05 21 46 73         ld hl, trdExt2
 108++6D08 CD F2 63       call CompareBuff.search
 108++6D0B A7             and a
 108++6D0C 20 72          jr nz, fopen_c_trd
 109++6D0E 21 4B 73     	ld hl, sclExt1
 109++6D11 CD F2 63       call CompareBuff.search
 109++6D14 A7             and a
 109++6D15 C2 A2 6D       jp nz, fopen_c_scl
 110++6D18 21 50 73         ld hl, sclExt2
 110++6D1B CD F2 63       call CompareBuff.search
 110++6D1E A7             and a
 110++6D1F C2 A2 6D       jp nz, fopen_c_scl
 111++6D22
 112++6D22
 113++6D22              	;ᮧ ந쭮 䠩 (id=2)
 114++6D22 CD CA 6D     	call select_drive
 115++6D25 FE 79        	cp "y"
 116++6D27 20 CD        	jr nz,fopen_err
 117++6D29
 118++6D29 CD 72 6D     	call cat_buf_cls
 119++6D2C
 120++6D2C 21 00 48     	ld hl,cat_buf ;⠥ ⠫ ᪠
 121++6D2F 11 00 00     	ld de,0
 122++6D32 01 05 09         ld      bc,#0905 ;
 123++6D35 CD FE 6D         call    call3d13
 124++6D38
 125++6D38 3A E4 50     	ld a,(cat_buf+8*256+#e4) ; 饥 ⢮ 䠩
 126++6D3B FE 80        	cp 128
 127++6D3D DA 48 6D     	jp c,fopen_c2 ;᫨ 㦥 ᨬ
 128++6D40 21 A6 73         ld hl, file_err
 129++6D43 CD 0A 6A         call DialogBox.msgBox ;।०
 130++6D46 18 AE        	jr fopen_err
 131++6D48
 132++6D48              fopen_c2
 133++6D48 2A E5 50     	ld hl,(cat_buf+8*256+#e5) ; ⢮ ᢮ ᥪ஢  ᪥
 134++6D4B 7C           	ld a,h
 135++6D4C B5           	or l
 136++6D4D 20 08        	jr nz,fopen_c3 ;᫨   
 137++6D4F 21 A6 73         ld hl, file_err
 138++6D52 CD 0A 6A         call DialogBox.msgBox ;।०
 139++6D55 18 9F        	jr fopen_err
 140++6D57
 141++6D57              fopen_c3
 142++6D57 ED 5B E1 50  	ld de,(cat_buf+8*256+#e1) ; ᢮ ᥪ-஦
 143++6D5B ED 53 F4 5C      ld   (#5cf4),de ; 㤥  䠩
 144++6D5F
 145++6D5F AF           	xor a
 146++6D60 32 7A 73     	ld (sec_shift),a ;६
 147++6D63 21 00 00     	ld hl,0
 148++6D66 22 6F 73     	ld (f_w_len+0),hl
 149++6D69 22 71 73     	ld (f_w_len+2),hl
 150++6D6C 3E 02        	ld a,2 ;id 
 151++6D6E 32 6E 73     	ld (f_w_flag),a ;䫠  䠩   
 152++6D71 C9           	ret
 153++6D72
 154++6D72
 155++6D72              cat_buf_cls ;⪠  ⠫
 156++6D72 21 00 48     	ld hl,cat_buf ;   ⠫ ᪥
 157++6D75 11 01 48     	ld de,cat_buf+1
 158++6D78 36 00        	ld (hl),0
 159++6D7A 01 FF 08     	ld bc,9*256-1
 160++6D7D ED B0        	ldir
 161++6D7F C9           	ret
 162++6D80
 163++6D80
 164++6D80
 165++6D80              fopen_c_trd	;⨥ 䠩  ࠧ稢 ࠧ trd (id=3)
 166++6D80 CD CA 6D     	call select_drive
 167++6D83 FE 79        	cp "y"
 168++6D85 C2 F6 6C     	jp nz,fopen_err
 169++6D88
 170++6D88 11 00 00     	ld      de,0 ;砫 ᥪ ஦
 171++6D8B ED 53 F4 5C      ld      (#5cf4),de
 172++6D8F
 173++6D8F AF           	xor a
 174++6D90 32 7A 73     	ld (sec_shift),a ;६
 175++6D93 21 00 00     	ld hl,0
 176++6D96 22 6F 73     	ld (f_w_len+0),hl
 177++6D99 22 71 73     	ld (f_w_len+2),hl
 178++6D9C 3E 03        	ld a,3 ;id 
 179++6D9E 32 6E 73     	ld (f_w_flag),a ;䫠  trd   
 180++6DA1 C9           	ret
 181++6DA2
 182++6DA2
 183++6DA2
 184++6DA2              fopen_c_scl	;⨥ 䠩  ࠧ稢 ࠧ scl (id=4)
 185++6DA2 CD CA 6D     	call select_drive
 186++6DA5 FE 79        	cp "y"
 187++6DA7 C2 F6 6C     	jp nz,fopen_err
 188++6DAA
 189++6DAA 11 00 00     	ld      de,0 ;砫 ᥪ ஦
 190++6DAD ED 53 F4 5C      ld      (#5cf4),de
 191++6DB1
 192++6DB1 CD 72 6D     	call cat_buf_cls ; 
 193++6DB4
 194++6DB4 CD 0D 71     	call scl_parse ; 横 ᡮન ࠧ
 195++6DB7
 196++6DB7 AF           	xor a
 197++6DB8 32 7A 73     	ld (sec_shift),a ;६
 198++6DBB              	;ld (scl_que),a
 199++6DBB 21 00 00     	ld hl,0
 200++6DBE 22 6F 73     	ld (f_w_len+0),hl
 201++6DC1 22 71 73     	ld (f_w_len+2),hl
 202++6DC4 3E 04        	ld a,4 ;id 
 203++6DC6 32 6E 73     	ld (f_w_flag),a ;䫠  scl   
 204++6DC9 C9           	ret
 205++6DCA
 206++6DCA
 207++6DCA
 208++6DCA
 209++6DCA
 210++6DCA              select_drive	;  ᪮
 211++6DCA 3A 19 5D     	ld a,(#5D19) ; ᪮  㬮砭
 212++6DCD C6 41        	add a,"A"
 213++6DCF 32 13 73     	ld (write_ima_d),a ;⠢ 㪢  
 214++6DD2 21 07 73         ld hl, write_ima
 215++6DD5 CD 13 6A         call DialogBox.msgNoWait ;।०
 216++6DD8              WAITKEY_trd
 217++6DD8              	;halt
 218++6DD8 CD 5C 6A     	call Console.getC
 219++6DDB FE FF        	cp 255
 220++6DDD 28 F9        	JR Z,WAITKEY_trd	;  
 221++6DDF FE 79        	cp "y"
 222++6DE1 C8           	ret z
 223++6DE2 FE 6E        	cp "n"
 224++6DE4 C8           	ret z
 225++6DE5 FE 61        	cp "a"
 226++6DE7 38 EF        	jr c,WAITKEY_trd
 227++6DE9 FE 65        	cp "e"
 228++6DEB 30 EB        	jr nc,WAITKEY_trd
 229++6DED D6 61        	sub "a"
 230++6DEF 32 19 5D         ld      (#5d19) ,a
 231++6DF2 0E 01            ld      c,1
 232++6DF4 CD FE 6D         call    call3d13
 233++6DF7 0E 18            ld      c,#18
 234++6DF9 CD FE 6D         call    call3d13
 235++6DFC 18 CC        	jr select_drive
 236++6DFE
 237++6DFE
 238++6DFE              ; restore_drive ;⠭ ᪮  㬮砭
 239++6DFE              	; ld 	a,(prev_drive)
 240++6DFE                  ; ld      (#5d19) ,a
 241++6DFE                  ; ld      c,1
 242++6DFE                  ; call    call3d13
 243++6DFE                  ; ld      c,#18
 244++6DFE                  ; call    call3d13
 245++6DFE              	; ret
 246++6DFE
 247++6DFE
 248++6DFE              call3d13 ;䨪  GMX
 249++6DFE              	ifndef ZSGMX
 250++6DFE C3 13 3D         jp    #3d13
 251++6E01              	endif
 252++6E01
 253++6E01              	ifdef ZSGMX
 254++6E01 ~                call    #3d13
 255++6E01 ~            	exx
 256++6E01 ~            	call TextMode.gmxscron
 257++6E01 ~            	exx
 258++6E01              	endif
 259++6E01 C9           	ret
 260++6E02
 261++6E02
 262++6E02
 263++6E02              ; A - file stream id
 264++6E02              fclose:
 265++6E02                  ;esxCall ESX_FCLOSE
 266++6E02              	; push af
 267++6E02              ; WAITKEY2	XOR A:IN A,(#FE):CPL:AND #1F:JR Z,WAITKEY2
 268++6E02              	; pop af
 269++6E02 FE 02        	cp 2 ;᫨  䠩
 270++6E04 C2 FA 6E     	jp nz,fclose_scl
 271++6E07
 272++6E07              	; ⮪ 䠩
 273++6E07 3A 73 73     	ld a,(write_end_flag) ;㦭 뢠 ⮪?
 274++6E0A B7           	or a
 275++6E0B 20 12        	jr nz,fclose_f ; 㦭
 276++6E0D
 277++6E0D 21 00 51     	ld hl,sec_buf
 278++6E10 01 06 01     	ld bc,#0106
 279++6E13 ED 5B F4 5C  	ld de,(#5cf4)
 280++6E17 CD FE 6D     	call call3d13
 281++6E1A
 282++6E1A 3E 30        	ld a,"0" ;  䠩
 283++6E1C 32 B9 73     	ld (file_num),a
 284++6E1F
 285++6E1F              fclose_f ;ࠢ ⠫
 286++6E1F 3A 71 73     	ld a,(f_w_len+2) ;ᠬ 訩   䠩
 287++6E22 2A 6F 73     	ld hl,(f_w_len+0)
 288++6E25 B4           	or h
 289++6E26 B5           	or l
 290++6E27 CA 06 6F     	jp z,fclose_ex ;室 ᫨  0
 291++6E2A
 292++6E2A              	;஢ન  
 293++6E2A 3A E4 50     	ld a,(cat_buf+8*256+#e4) ; 饥 ⢮ 䠩
 294++6E2D FE 80        	cp 128
 295++6E2F D2 06 6F     	jp nc,fclose_ex ;᫨ 㦥 ᨬ
 296++6E32 2A E5 50     	ld hl,(cat_buf+8*256+#e5) ; ⢮ ᢮ ᥪ஢  ᪥
 297++6E35 7C           	ld a,h
 298++6E36 B5           	or l
 299++6E37 CA 06 6F     	jp z,fclose_ex ;᫨  
 300++6E3A
 301++6E3A 3A 71 73     	ld a,(f_w_len+2) ;ᠬ 訩   䠩
 302++6E3D B7           	or a
 303++6E3E 20 28        	jr nz,fclose_f_multi ;᫨ 䠩  255 ᥪ஢ (65280)
 304++6E40 3A 70 73     	ld a,(f_w_len+1)
 305++6E43 FE FF        	cp 255
 306++6E45 20 05        	jr nz,fclose_f1
 307++6E47 3A 6F 73     	ld a,(f_w_len+0)
 308++6E4A 20 1C        	jr nz,fclose_f_multi ;᫨ 䠩  255 ᥪ஢ (65280)
 309++6E4C              fclose_f1
 310++6E4C              	;䠩  ॢ蠥 ᨬ ࠧ  trdos
 311++6E4C ED 5B 6F 73  	ld de,(f_w_len+0)
 312++6E50 21 60 73     	ld hl,f_name+11 ; 䠩
 313++6E53 73           	ld (hl),e
 314++6E54 23           	inc hl
 315++6E55 72           	ld (hl),d
 316++6E56 23           	inc hl
 317++6E57 3A 70 73     	ld a,(f_w_len+1) ; ᥪ஢
 318++6E5A 77           	ld (hl),a
 319++6E5B 3A 6F 73     	ld a,(f_w_len+0) ; 訩
 320++6E5E B7           	or a
 321++6E5F 28 01        	jr z,fclose_f2
 322++6E61 34           	inc (hl) ;४ ᥪ஢
 323++6E62              fclose_f2
 324++6E62 CD 94 6E     	call fclose_f_one ; ଠ
 325++6E65 C3 06 6F     	jp fclose_ex ;⮢
 326++6E68
 327++6E68              fclose_f_multi ;䠩 让, 㤥 ᪮쪮 ᥩ  ⠫
 328++6E68 3A B9 73     	ld a,(file_num)
 329++6E6B 32 5C 73     	ld (f_name+7),a ;   
 330++6E6E
 331++6E6E 21 60 73     	ld hl,f_name+11 ; 䠩
 332++6E71 36 00        	ld (hl),0
 333++6E73 23           	inc hl
 334++6E74 36 FF        	ld (hl),#ff ;65280
 335++6E76 23           	inc hl
 336++6E77              	; ᥪ஢
 337++6E77 36 FF        	ld (hl),#ff
 338++6E79 CD 94 6E     	call fclose_f_one ; ଠ
 339++6E7C
 340++6E7C              	;  ᠭ
 341++6E7C 2A 70 73     	ld hl,(f_w_len+1) ;訩  । 
 342++6E7F 01 FF 00     	ld bc,255
 343++6E82 A7           	and a
 344++6E83 ED 42        	sbc hl,bc ; 255 ᥪ஢
 345++6E85 22 70 73     	ld (f_w_len+1),hl
 346++6E88
 347++6E88 3A B9 73     	ld a,(file_num)
 348++6E8B 3C           	inc a
 349++6E8C 32 B9 73     	ld (file_num),a
 350++6E8F 32 5C 73     	ld (f_name+7),a ;   
 351++6E92
 352++6E92 18 8B        	jr fclose_f ;᭠砫
 353++6E94
 354++6E94
 355++6E94              fclose_f_one ;   䠩
 356++6E94 3A E4 50     			ld a,(cat_buf+8*256+#e4) ; 饥 ⢮ 䠩
 357++6E97 6F           			ld l,a ;㧭   ᥪ 㤥   䠩
 358++6E98 26 00        			ld h,0
 359++6E9A 29           			add hl,hl ;*2
 360++6E9B 29           			add hl,hl ;*4
 361++6E9C 29           			add hl,hl ;*8
 362++6E9D 29           			add hl,hl ;*16
 363++6E9E 7C           			ld a,h ;    ⠫
 364++6E9F 32 B8 73     			ld (sec_cat),a
 365++6EA2 01 00 48     			ld bc,cat_buf
 366++6EA5 09           			add hl,bc ; 㤥    䠩
 367++6EA6 EB           			ex de,hl
 368++6EA7
 369++6EA7 21 55 73     			ld hl,f_name ;  䠩
 370++6EAA 01 10 00     			ld bc,16
 371++6EAD ED B0        			ldir ;᪮஢
 372++6EAF EB           			ex de,hl
 373++6EB0 2B           			dec hl
 374++6EB1 ED 5B E1 50  			ld de,(cat_buf+8*256+#e1) ; ᢮ ᥪ-஦ 祭
 375++6EB5 72           			ld (hl),d ;஦
 376++6EB6 2B           			dec hl
 377++6EB7 73           			ld (hl),e ;ᥪ
 378++6EB8
 379++6EB8 2E 00        			ld l,0 ; ᥪ 楫  ஢ 
 380++6EBA 16 00        			ld d,0
 381++6EBC 3A B8 73     			ld a,(sec_cat)
 382++6EBF 5F           			ld e,a ; ᥪ
 383++6EC0 01 06 01     			ld bc,#0106 ;1 ᥪ 
 384++6EC3 CD FE 6D     			call call3d13
 385++6EC6
 386++6EC6              			;㦥 ᥪ
 387++6EC6 ED 5B E1 50  			ld de,(cat_buf+8*256+#e1) ; ᢮ ᥪ-஦
 388++6ECA 3A 62 73     			ld a,(f_name+13) ;ࠧ 䠩  ᥪ
 389++6ECD 47           			ld b,a
 390++6ECE CD FB 72     			call calc_next_pos2
 391++6ED1 ED 53 E1 50  			ld (cat_buf+8*256+#e1),de
 392++6ED5
 393++6ED5 2A E5 50     			ld hl,(cat_buf+8*256+#e5) ; ⢮ ᢮ ᥪ஢  ᪥
 394++6ED8 3A 62 73     			ld a,(f_name+13) ;ࠧ 䠩  ᥪ
 395++6EDB 4F           			ld c,a
 396++6EDC 06 00        			ld b,0
 397++6EDE A7           			and a
 398++6EDF ED 42        			sbc hl,bc
 399++6EE1 30 03        			jr nc,fclose_f_one2
 400++6EE3 21 00 00     			ld hl,0 ;᫨ 뫮 ⥫쭮
 401++6EE6              fclose_f_one2
 402++6EE6 22 E5 50     			ld (cat_buf+8*256+#e5),hl
 403++6EE9
 404++6EE9 21 E4 50     			ld hl,cat_buf+8*256+#e4 ; 饥 ⢮ 䠩
 405++6EEC 34           			inc (hl)
 406++6EED
 407++6EED 21 00 50     			ld hl,cat_buf+8*256
 408++6EF0 11 08 00     			ld de,#0008
 409++6EF3 01 06 01     			ld bc,#0106 ;1 ᥪ 
 410++6EF6 CD FE 6D     			call call3d13
 411++6EF9 C9           			ret
 412++6EFA
 413++6EFA
 414++6EFA              fclose_scl
 415++6EFA FE 04        	cp 4 ;᫨ scl
 416++6EFC 20 08        	jr nz,fclose_ex
 417++6EFE 21 00 51     	ld hl,sec_buf ;
 418++6F01 06 01        	ld b,1
 419++6F03 CD EC 70     	call scl_write_buf ;襬 ⮪ scl, ᫨ 
 420++6F06
 421++6F06              fclose_ex
 422++6F06 AF           	xor a ;  뢠  䠩
 423++6F07 32 6A 73     	ld (f_r_flag),a
 424++6F0A 32 6E 73     	ld (f_w_flag),a
 425++6F0D              	;call restore_drive ; ,  
 426++6F0D C9               ret
 427++6F0E
 428++6F0E
 429++6F0E
 430++6F0E
 431++6F0E              ; A - file stream id
 432++6F0E              ; BC - length
 433++6F0E              ; HL - buffer
 434++6F0E              ; Returns
 435++6F0E              ;  BC - length(how much was actually read)
 436++6F0E              fread: ;(id=1)
 437++6F0E                  ; push hl : pop ix
 438++6F0E                  ; esxCall ESX_FREAD
 439++6F0E              	; push af
 440++6F0E              	; ld a,4
 441++6F0E              	; out (254),a
 442++6F0E              ; WAITKEY	XOR A:IN A,(#FE):CPL:AND #1F:JR Z,WAITKEY
 443++6F0E              	; xor a
 444++6F0E              	; out (254),a
 445++6F0E              	; pop af
 446++6F0E
 447++6F0E FE 01        	cp 1 ;id = 1?
 448++6F10 20 06        	jr nz,fread_no_chek ;室 ᫨  ⮪  = 1
 449++6F12 3A 6A 73     	ld a,(f_r_flag)
 450++6F15 B7           	or a
 451++6F16 20 06        	jr nz,fread_chek ;䠩 㦥 ?
 452++6F18              fread_no_chek ;室  訡
 453++6F18 AF           	xor a
 454++6F19 37           	scf ;䫠 訡
 455++6F1A 01 00 00     	ld bc,0 ;祣   ⠫
 456++6F1D C9           	ret
 457++6F1E
 458++6F1E              fread_chek
 459++6F1E ED 4B 66 73  	ld bc,(f_r_len_sec-1) ;㦠 䠩 楫,  ᬮ  , ᪮쪮  뫮 襭
 460++6F22 0E 05            ld      c,5 ;read ⠥ 楫묨 ᥪࠬ
 461++6F24 ED 5B 65 73  	ld de,(f_r_cur_trk)
 462++6F28 CD FE 6D         call    call3d13
 463++6F2B ED 4B 68 73  	ld bc,(f_r_len) ;⨬ ᪮쪮 ⠫  ( 䠩)
 464++6F2F AF           	xor a ;䫠 ᨬ
 465++6F30 C9               ret
 466++6F31
 467++6F31              ; A - file stream id
 468++6F31              ; BC - length
 469++6F31              ; HL - buffer
 470++6F31              ; Returns:
 471++6F31              ;   BC - actually written bytes
 472++6F31              fwrite: ;
 473++6F31                  ; push hl : pop ix
 474++6F31                  ; esxCall ESX_FWRITE
 475++6F31
 476++6F31              	; push af
 477++6F31              	; ld a,2
 478++6F31              	; out (254),a
 479++6F31              ; WAITKEY1	XOR A:IN A,(#FE):CPL:AND #1F:JR Z,WAITKEY1
 480++6F31              	; xor a
 481++6F31              	; out (254),a
 482++6F31              	; pop af
 483++6F31
 484++6F31 FE 02        	cp 2 ;id = 2?
 485++6F33 28 0F        	jr z,fwrite_chek ;஢ઠ id ⮪
 486++6F35 FE 03        	cp 3 ;id = 3?
 487++6F37 28 0B        	jr z,fwrite_chek_trd ;஢ઠ id ⮪
 488++6F39 FE 04        	cp 4 ;id = 4?
 489++6F3B CA 27 70     	jp z,fwrite_chek_scl ;஢ઠ id ⮪
 490++6F3E
 491++6F3E
 492++6F3E              fwrite_no_chek ;室  訡
 493++6F3E AF           	xor a
 494++6F3F 37           	scf ;䫠 訡
 495++6F40 01 00 00     	ld bc,0 ;祣   ᠫ
 496++6F43 C9           	ret
 497++6F44
 498++6F44              fwrite_chek ; ந쭮 ⨯ 䠩 (id=2)
 499++6F44
 500++6F44              	; ⫨砥   trd,  室騩 ⮪  , ⫨  ⨨  ⨨ 䠩
 501++6F44
 502++6F44
 503++6F44
 504++6F44
 505++6F44
 506++6F44              fwrite_chek_trd ; trd 䠩 (ࠧ稢 ࠧ, id=3)
 507++6F44              	; ld a,2
 508++6F44              	; out (254),a
 509++6F44              ; WAITKEY_t	XOR A:IN A,(#FE):CPL:AND #1F:JR Z,WAITKEY_t
 510++6F44              	; xor a
 511++6F44              	; out (254),a
 512++6F44 3A 6E 73     	ld a,(f_w_flag)
 513++6F47 B7           	or a
 514++6F48 28 F4        	jr z,fwrite_no_chek ;䠩 㦥 ?
 515++6F4A ED 43 74 73  	ld (temp_bc),bc ;
 516++6F4E 22 76 73     	ld (temp_hl),hl ; 
 517++6F51 78           	ld a,b
 518++6F52 B1           	or c
 519++6F53 28 E9        	jr z,fwrite_no_chek ; ᫨  0,  室
 520++6F55
 521++6F55              	;  ९ ᪠
 522++6F55 ED 5B F4 5C  	ld de,(#5cf4)
 523++6F59 7A           	ld a,d
 524++6F5A FE A0        	cp #a0 ;᫥ ஦ 160
 525++6F5C 30 E0        	jr nc,fwrite_no_chek
 526++6F5E
 527++6F5E AF           	xor a
 528++6F5F 32 7C 73     	ld (sec_part),a ;㫨 ६
 529++6F62 32 7B 73     	ld (sec_shift2),a
 530++6F65 32 7C 73     	ld (sec_shift2+1),a
 531++6F68 32 7D 73     	ld (sec_shift_flag),a
 532++6F6B 32 73 73     	ld (write_end_flag),a ;
 533++6F6E
 534++6F6E
 535++6F6E 3A 7A 73     	ld a,(sec_shift)
 536++6F71 B7           	or a
 537++6F72 28 43        	jr z,fwrite_trd3 ;᫨ ᬥ饭 ,    ய⨬
 538++6F74
 539++6F74
 540++6F74 4F           	ld c,a
 541++6F75 06 00        	ld b,0
 542++6F77 2A 74 73     	ld hl,(temp_bc) ;஢ઠ   楫 ᥪ
 543++6F7A 09           	add hl,bc
 544++6F7B
 545++6F7B 3E 01        	ld a,1
 546++6F7D 32 73 73     	ld (write_end_flag),a ;䫠   㦭 뢠 ⮪
 547++6F80
 548++6F80 7C           	ld a,h
 549++6F81 B7           	or a
 550++6F82 20 05        	jr nz,fwrite_trd4
 551++6F84 3E 01        	ld a,1
 552++6F86 32 7D 73     	ld (sec_shift_flag),a ;䫠    ᥪ
 553++6F89
 554++6F89              fwrite_trd4
 555++6F89 21 00 51     	ld hl,sec_buf ; ᫥ ᥪ
 556++6F8C 09           	add hl,bc ; ⮩ 窥 ⠭
 557++6F8D EB           	ex de,hl
 558++6F8E 2A 76 73     	ld hl,(temp_hl) ;ᮥ 砫    ।
 559++6F91              	; ld a,c
 560++6F91              	; or a
 561++6F91              	; jr nz,fwrite_trd2
 562++6F91              	; inc b ;४
 563++6F91              ; fwrite_trd2
 564++6F91              	; ld c,a
 565++6F91 AF           	xor a
 566++6F92 91           	sub c
 567++6F93 4F           	ld c,a ;᪮쪮 ⠫ ७   ᥪ
 568++6F94 ED 43 7B 73  	ld (sec_shift2),bc ;࠭ ᪮쪮  
 569++6F98 ED B0        	ldir
 570++6F9A
 571++6F9A 3A 7D 73     	ld a,(sec_shift_flag)
 572++6F9D B7           	or a
 573++6F9E 20 17        	jr nz,fwrite_trd3 ;᫨ ᥪ      㤥
 574++6FA0
 575++6FA0 21 00 51     	ld hl,sec_buf
 576++6FA3 ED 5B F4 5C  	ld de,(#5cf4)
 577++6FA7              	;ld (f_w_cur_trk),de	; 
 578++6FA7 01 06 01         ld      bc,#0106 ;襬 1 ᥪ  
 579++6FAA CD FE 6D         call    call3d13
 580++6FAD 79           	ld a,c
 581++6FAE FE FF        	cp 255
 582++6FB0 CA 3E 6F     	jp z,fwrite_no_chek ;室 ᫨ 訡
 583++6FB3
 584++6FB3 AF           	xor a
 585++6FB4 32 73 73     	ld (write_end_flag),a ;䫠  㦭 뢠 ⮪
 586++6FB7              	; ld de,(f_w_cur_trk) ;᫨ ᥪ   , ⠭  ன 樨
 587++6FB7              	; ld (#5cf4),de
 588++6FB7              	; ld b,1 ; ᥪ 
 589++6FB7              	; ld de,(f_w_cur_trk)
 590++6FB7              	; call calc_next_pos
 591++6FB7              	; ld (f_w_cur_trk),de
 592++6FB7
 593++6FB7              fwrite_trd3
 594++6FB7 2A 76 73     	ld hl,(temp_hl) ;襬 ⮪ 
 595++6FBA              	;ld a,(sec_shift)
 596++6FBA              	;ld c,a
 597++6FBA              	;ld b,0
 598++6FBA ED 4B 7B 73  	ld bc,(sec_shift2)
 599++6FBE 09           	add hl,bc ; ⮩ 窨 襬
 600++6FBF 22 78 73     	ld (temp_hl2),hl ;࠭ 砫  ண ᥪ
 601++6FC2
 602++6FC2 2A 74 73     	ld hl,(temp_bc) ;᫥   ⠭   ࠧ
 603++6FC5 A7           	and a
 604++6FC6 ED 42        	sbc hl,bc ;⥬ ,    ࢮ ᥪ
 605++6FC8 4D           	ld c,l
 606++6FC9 44           	ld b,h
 607++6FCA 30 02        	jr nc,fwrite_trd5
 608++6FCC 06 00        	ld b,0 ;४ ᫨ 襫 
 609++6FCE              fwrite_trd5
 610++6FCE 2A 76 73     	ld hl,(temp_hl)
 611++6FD1 09           	add hl,bc
 612++6FD2
 613++6FD2 11 59 A1     	ld de,outputBuffer
 614++6FD5 A7           	and a
 615++6FD6 ED 52        	sbc hl,de
 616++6FD8
 617++6FD8 7D           	ld a,l
 618++6FD9 32 7A 73     	ld (sec_shift),a ;ᬥ饭  ᫥騩 ࠧ
 619++6FDC              	;ld hl,(temp_hl)
 620++6FDC
 621++6FDC
 622++6FDC              	; or a
 623++6FDC              	; jr z,fwrite_trd1
 624++6FDC              	; inc b  ;४ ⢠ ᥪ஢
 625++6FDC
 626++6FDC 78           	ld a,b ;㦭 ஢ઠ  ⢮ ᥪ஢!!!
 627++6FDD 32 7C 73     	ld (sec_part),a ; ᪮쪮 ᥪ஢  ன 
 628++6FE0
 629++6FE0              	;ld a,b
 630++6FE0 B7           	or a
 631++6FE1 28 16        	jr z,fwrite_trd1 ;᫨ ࠧ   ᥪ,  ய⨬ 
 632++6FE3
 633++6FE3 2A 78 73     	ld hl,(temp_hl2)
 634++6FE6              	;push bc
 635++6FE6 ED 5B F4 5C  	ld de,(#5cf4)
 636++6FEA 0E 06            ld      c,6 ;襬 楫묨 ᥪࠬ
 637++6FEC CD FE 6D         call    call3d13
 638++6FEF 79           	ld a,c
 639++6FF0              	;pop bc
 640++6FF0 FE FF        	cp 255
 641++6FF2 CA 3E 6F     	jp z,fwrite_no_chek ;室 ᫨ 訡
 642++6FF5              	; ld de,(f_w_cur_trk)
 643++6FF5              	; call calc_next_pos
 644++6FF5              	; ld (f_w_cur_trk),de
 645++6FF5
 646++6FF5 AF           	xor a
 647++6FF6 32 73 73     	ld (write_end_flag),a ;䫠  㦭 뢠 ⮪
 648++6FF9
 649++6FF9              fwrite_trd1
 650++6FF9 3A 73 73     	ld a,(write_end_flag) ;㦭 뢠 ⮪?
 651++6FFC B7           	or a
 652++6FFD 20 12        	jr nz,fwrite_trd_ex ; 㦭
 653++6FFF
 654++6FFF 2A 78 73     	ld hl,(temp_hl2) ;࠭ ᠭ ⮪
 655++7002 3A 7C 73     	ld a,(sec_part)
 656++7005 47           	ld b,a
 657++7006 0E 00        	ld c,0
 658++7008 09           	add hl,bc
 659++7009 11 00 51     	ld de,sec_buf
 660++700C 01 00 01     	ld bc,256
 661++700F ED B0        	ldir
 662++7011              ;fwrite_trd2
 663++7011
 664++7011
 665++7011              fwrite_trd_ex
 666++7011 ED 4B 74 73  	ld bc,(temp_bc) ;⨬,  ᪮쪮 訢, ⮫쪮  ᠫ 
 667++7015              	;⠥   ᠭ
 668++7015 2A 6F 73     	ld hl,(f_w_len)
 669++7018 09           	add hl,bc
 670++7019 22 6F 73     	ld (f_w_len),hl
 671++701C 30 07        	jr nc,fwrite_trd_ex1
 672++701E 2A 71 73     	ld hl,(f_w_len+2)
 673++7021 23           	inc hl
 674++7022 22 71 73     	ld (f_w_len+2),hl
 675++7025
 676++7025              fwrite_trd_ex1
 677++7025 AF           	xor a ;䫠 ᨬ
 678++7026 C9               ret
 679++7027
 680++7027
 681++7027
 682++7027
 683++7027
 684++7027              ;------------------scl----------------------
 685++7027              fwrite_chek_scl ; scl 䠩 (ࠧ稢 ࠧ, id=4)
 686++7027              	; ld a,2
 687++7027              	; out (254),a
 688++7027              ; WAITKEY_t	XOR A:IN A,(#FE):CPL:AND #1F:JR Z,WAITKEY_t
 689++7027              	; xor a
 690++7027              	; out (254),a
 691++7027 3A 6E 73     	ld a,(f_w_flag)
 692++702A B7           	or a
 693++702B CA 3E 6F     	jp z,fwrite_no_chek ;䠩 㦥 ?
 694++702E ED 43 74 73  	ld (temp_bc),bc ;
 695++7032 22 76 73     	ld (temp_hl),hl ; 
 696++7035 78           	ld a,b
 697++7036 B1           	or c
 698++7037 CA 3E 6F     	jp z,fwrite_no_chek ; ᫨  0,  室
 699++703A
 700++703A              	; ld a,b
 701++703A              	; or a
 702++703A              	; jr nz,testt1
 703++703A              	; nop
 704++703A
 705++703A              ; testt1
 706++703A
 707++703A AF           	xor a
 708++703B 32 7C 73     	ld (sec_part),a ;㫨 ६
 709++703E 32 7B 73     	ld (sec_shift2),a
 710++7041 32 7C 73     	ld (sec_shift2+1),a
 711++7044 32 7D 73     	ld (sec_shift_flag),a
 712++7047 32 73 73     	ld (write_end_flag),a ;
 713++704A
 714++704A
 715++704A 3A 7A 73     	ld a,(sec_shift)
 716++704D B7           	or a
 717++704E 28 38        	jr z,fwrite_scl3 ;᫨ ᬥ饭 ,    ய⨬
 718++7050
 719++7050
 720++7050 4F           	ld c,a
 721++7051 06 00        	ld b,0
 722++7053 2A 74 73     	ld hl,(temp_bc) ;஢ઠ   楫 ᥪ
 723++7056 09           	add hl,bc
 724++7057
 725++7057 3E 01        	ld a,1
 726++7059 32 73 73     	ld (write_end_flag),a ;䫠   㦭 뢠 ⮪
 727++705C
 728++705C 7C           	ld a,h
 729++705D B7           	or a
 730++705E 20 05        	jr nz,fwrite_scl4
 731++7060 3E 01        	ld a,1
 732++7062 32 7D 73     	ld (sec_shift_flag),a ;䫠    ᥪ
 733++7065
 734++7065              fwrite_scl4
 735++7065 21 00 51     	ld hl,sec_buf ; ᫥ ᥪ
 736++7068 09           	add hl,bc ; ⮩ 窥 ⠭
 737++7069 EB           	ex de,hl
 738++706A 2A 76 73     	ld hl,(temp_hl) ;ᮥ 砫    ।
 739++706D              	; ld a,c
 740++706D              	; or a
 741++706D              	; jr nz,fwrite_scl2
 742++706D              	; inc b ;४
 743++706D              ; fwrite_scl2
 744++706D              	; ld c,a
 745++706D AF           	xor a
 746++706E 91           	sub c
 747++706F 4F           	ld c,a ;᪮쪮 ⠫ ७   ᥪ
 748++7070 ED 43 7B 73  	ld (sec_shift2),bc ;࠭ ᪮쪮  
 749++7074 ED B0        	ldir
 750++7076
 751++7076 3A 7D 73     	ld a,(sec_shift_flag)
 752++7079 B7           	or a
 753++707A 20 0C        	jr nz,fwrite_scl3 ;᫨ ᥪ      㤥
 754++707C
 755++707C 21 00 51     	ld hl,sec_buf
 756++707F              	;ld de,(#5cf4)
 757++707F              	;ld (f_w_cur_trk),de	; 
 758++707F 06 01            ld      b,#01 ;襬 1 ᥪ  
 759++7081 CD EC 70         call    scl_write_buf
 760++7084              	; ld a,c
 761++7084              	; cp 255
 762++7084              	; jp z,fwrite_no_chek ;室 ᫨ 訡
 763++7084
 764++7084 AF           	xor a
 765++7085 32 73 73     	ld (write_end_flag),a ;䫠  㦭 뢠 ⮪
 766++7088              	; ld de,(f_w_cur_trk) ;᫨ ᥪ   , ⠭  ன 樨
 767++7088              	; ld (#5cf4),de
 768++7088              	; ld b,1 ; ᥪ 
 769++7088              	; ld de,(f_w_cur_trk)
 770++7088              	; call calc_next_pos
 771++7088              	; ld (f_w_cur_trk),de
 772++7088
 773++7088              fwrite_scl3
 774++7088 2A 76 73     	ld hl,(temp_hl) ;襬 ⮪ 
 775++708B              	;ld a,(sec_shift)
 776++708B              	;ld c,a
 777++708B              	;ld b,0
 778++708B ED 4B 7B 73  	ld bc,(sec_shift2)
 779++708F 09           	add hl,bc ; ⮩ 窨 襬
 780++7090 22 78 73     	ld (temp_hl2),hl ;࠭ 砫  ண ᥪ
 781++7093
 782++7093 2A 74 73     	ld hl,(temp_bc) ;᫥   ⠭   ࠧ
 783++7096 A7           	and a
 784++7097 ED 42        	sbc hl,bc ;⥬ ,    ࢮ ᥪ
 785++7099 4D           	ld c,l
 786++709A 44           	ld b,h
 787++709B 30 02        	jr nc,fwrite_scl5
 788++709D 06 00        	ld b,0 ;४ ᫨ 襫 
 789++709F              fwrite_scl5
 790++709F 2A 76 73     	ld hl,(temp_hl)
 791++70A2 09           	add hl,bc
 792++70A3
 793++70A3 11 59 A1     	ld de,outputBuffer
 794++70A6 A7           	and a
 795++70A7 ED 52        	sbc hl,de
 796++70A9
 797++70A9 7D           	ld a,l
 798++70AA 32 7A 73     	ld (sec_shift),a ;ᬥ饭  ᫥騩 ࠧ
 799++70AD              	;ld hl,(temp_hl)
 800++70AD
 801++70AD
 802++70AD              	; or a
 803++70AD              	; jr z,fwrite_scl1
 804++70AD              	; inc b  ;४ ⢠ ᥪ஢
 805++70AD
 806++70AD 78           	ld a,b ;㦭 ஢ઠ  ⢮ ᥪ஢!!!
 807++70AE 32 7C 73     	ld (sec_part),a ; ᪮쪮 ᥪ஢  ன 
 808++70B1
 809++70B1              	;ld a,b
 810++70B1 B7           	or a
 811++70B2 28 0A        	jr z,fwrite_scl1 ;᫨ ࠧ   ᥪ,  ய⨬ 
 812++70B4
 813++70B4 2A 78 73     	ld hl,(temp_hl2)
 814++70B7              	;push bc
 815++70B7              	;ld de,(#5cf4)
 816++70B7                  ;ld      c,6 ;襬 楫묨 ᥪࠬ
 817++70B7 CD EC 70         call    scl_write_buf
 818++70BA              	;ld a,c
 819++70BA              	;pop bc
 820++70BA              	; cp 255
 821++70BA              	; jp z,fwrite_no_chek ;室 ᫨ 訡
 822++70BA              	; ld de,(f_w_cur_trk)
 823++70BA              	; call calc_next_pos
 824++70BA              	; ld (f_w_cur_trk),de
 825++70BA
 826++70BA AF           	xor a
 827++70BB 32 73 73     	ld (write_end_flag),a ;䫠  㦭 뢠 ⮪
 828++70BE
 829++70BE              fwrite_scl1
 830++70BE 3A 73 73     	ld a,(write_end_flag) ;㦭 뢠 ⮪?
 831++70C1 B7           	or a
 832++70C2 20 12        	jr nz,fwrite_scl_ex ; 㦭
 833++70C4
 834++70C4 2A 78 73     	ld hl,(temp_hl2) ;࠭ ᠭ ⮪
 835++70C7 3A 7C 73     	ld a,(sec_part)
 836++70CA 47           	ld b,a
 837++70CB 0E 00        	ld c,0
 838++70CD 09           	add hl,bc
 839++70CE 11 00 51     	ld de,sec_buf
 840++70D1 01 00 01     	ld bc,256
 841++70D4 ED B0        	ldir
 842++70D6              ;fwrite_scl2
 843++70D6
 844++70D6
 845++70D6              fwrite_scl_ex
 846++70D6 ED 4B 74 73  	ld bc,(temp_bc) ;⨬,  ᪮쪮 訢, ⮫쪮  ᠫ 
 847++70DA              	;⠥   ᠭ
 848++70DA 2A 6F 73     	ld hl,(f_w_len)
 849++70DD 09           	add hl,bc
 850++70DE 22 6F 73     	ld (f_w_len),hl
 851++70E1 30 07        	jr nc,fwrite_scl_ex1
 852++70E3 2A 71 73     	ld hl,(f_w_len+2)
 853++70E6 23           	inc hl
 854++70E7 22 71 73     	ld (f_w_len+2),hl
 855++70EA
 856++70EA              fwrite_scl_ex1
 857++70EA AF           	xor a ;䫠 ᨬ
 858++70EB C9               ret
 859++70EC
 860++70EC
 861++70EC
 862++70EC
 863++70EC
 864++70EC
 865++70EC              scl_write_buf ; ஬筮 
 866++70EC C5           	push bc ;᪮쪮 ⮢ 㪠  b
 867++70ED 11 00 53     	ld de,scl_buf ;७ ᥪ  ६ 
 868++70F0 01 00 01     	ld bc,256
 869++70F3 ED B0        	ldir
 870++70F5 22 9E 73     	ld (scl_temp_hl2),hl ;࠭  
 871++70F8 3A 86 73     	ld a,(scl_que) ;஢ਬ 䫠  㦭 
 872++70FB B7           	or a
 873++70FC 28 08        	jr z,scl_write_buf_ret ; 㤥 뢠  ᫨  㦭
 874++70FE 21 06 71     	ld hl,scl_write_buf_ret ; 
 875++7101 E5           	push hl
 876++7102 2A 98 73     	ld hl,(scl_parse_ret_adr) ;  த ᭮ 横 ᡮન
 877++7105 E9           	jp (hl) ;⤠  256  
 878++7106              scl_write_buf_ret
 879++7106 2A 9E 73     	ld hl,(scl_temp_hl2)
 880++7109 C1           	pop bc
 881++710A 10 E0        	djnz scl_write_buf
 882++710C
 883++710C C9           	ret
 884++710D
 885++710D
 886++710D
 887++710D              scl_parse ;ࠧ ࠧ scl  trd, ᭮ 横
 888++710D              	;  ᥪ
 889++710D              ; 樨   256 
 890++710D 22 9C 73     	ld (scl_temp_hl),hl
 891++7110 ED 53 A0 73  	ld (scl_temp_de),de
 892++7114 ED 43 A2 73  	ld (scl_temp_bc),bc
 893++7118 3E 01        	ld a,1
 894++711A 32 86 73     	ld (scl_que),a ;稬 䫠  㦭 
 895++711D 21 24 71     	ld hl,scl_parse_ret ;࠭  
 896++7120 22 98 73     	ld (scl_parse_ret_adr),hl
 897++7123 C9           	ret ;   
 898++7124              scl_parse_ret
 899++7124 AF           	xor a
 900++7125 32 86 73     	ld (scl_que),a
 901++7128 2A 9C 73     	ld hl,(scl_temp_hl)
 902++712B ED 5B A0 73  	ld de,(scl_temp_de)
 903++712F ED 4B A2 73  	ld bc,(scl_temp_bc)
 904++7133
 905++7133 11 00 53     	ld de,scl_buf ;஢ઠ ⪨ ࠧ
 906++7136 21 7E 73     	ld hl,scl_sign
 907++7139 06 08        	ld b,8
 908++713B              scl_parse_chk
 909++713B 1A           	ld a,(de)
 910++713C BE           	cp (hl)
 911++713D 20 06        	jr nz,scl_parse_chk_no
 912++713F 23           	inc hl
 913++7140 13           	inc de
 914++7141 10 F8        	djnz scl_parse_chk
 915++7143 18 10        	jr scl_parse_chk_ok
 916++7145              scl_parse_chk_no ;᫨  ᮢ,  宩 ࠧ
 917++7145 21 87 73         ld hl, scl_err
 918++7148 CD 0A 6A         call DialogBox.msgBox ;।०
 919++714B AF           	xor a
 920++714C 32 86 73     	ld (scl_que),a ;몫稬 䫠  㦭 
 921++714F 3E 04        	ld a,4 ;஥ 䠩
 922++7151 CD 02 6E     	call fclose
 923++7154 C9           	ret
 924++7155              scl_parse_chk_ok ;ᨣ ࠢ쭠
 925++7155
 926++7155              ;ନ஢ ⠫
 927++7155 3A 08 53     	ld a,(scl_buf+8)
 928++7158 32 9B 73     	ld (scl_files),a ;ᥣ 䠩
 929++715B 32 9A 73     	ld (scl_cat_cycl),a ;横
 930++715E 21 09 53     	ld hl,scl_buf+9 ; ࢮ 
 931++7161 11 00 48     	ld de,cat_buf ; ନ㥬 ⠫ trd
 932++7164              scl_parse_cat2
 933++7164 06 0E        	ld b,14 ;14   
 934++7166              scl_parse_cat
 935++7166 7E           	ld a,(hl)
 936++7167 12           	ld (de),a
 937++7168 13           	inc de
 938++7169 2C           	inc l ; 㢥稢 ⮫쪮  । 襣 ॣ
 939++716A 20 26        	jr nz,scl_parse_cat1
 940++716C              	;   ᫥騩 ᥪ
 941++716C              ; 樨   256 
 942++716C 22 9C 73     	ld (scl_temp_hl),hl
 943++716F ED 53 A0 73  	ld (scl_temp_de),de
 944++7173 ED 43 A2 73  	ld (scl_temp_bc),bc
 945++7177 3E 01        	ld a,1
 946++7179 32 86 73     	ld (scl_que),a ;稬 䫠  㦭 
 947++717C 21 83 71     	ld hl,scl_parse_ret1 ;࠭  
 948++717F 22 98 73     	ld (scl_parse_ret_adr),hl
 949++7182 C9           	ret ;   
 950++7183              scl_parse_ret1
 951++7183 AF           	xor a
 952++7184 32 86 73     	ld (scl_que),a
 953++7187 2A 9C 73     	ld hl,(scl_temp_hl)
 954++718A ED 5B A0 73  	ld de,(scl_temp_de)
 955++718E ED 4B A2 73  	ld bc,(scl_temp_bc)
 956++7192
 957++7192              scl_parse_cat1
 958++7192 10 D2        	djnz scl_parse_cat
 959++7194 13           	inc de
 960++7195 13           	inc de
 961++7196 3A 9A 73     	ld a,(scl_cat_cycl)
 962++7199 3D           	dec a
 963++719A 32 9A 73     	ld (scl_cat_cycl),a
 964++719D 20 C5        	jr nz,scl_parse_cat2
 965++719F
 966++719F 22 9C 73     	ld (scl_temp_hl),hl ;  ⠭
 967++71A2
 968++71A2              ; ᥪ஢  ஦
 969++71A2 DD E5        	push ix
 970++71A4 3A 9B 73     	ld a,(scl_files)
 971++71A7 11 00 01     	ld de,#0100 ;  ࢮ ஦
 972++71AA DD 21 00 48  	ld ix,cat_buf
 973++71AE DD 73 0E     	ld (ix+14),e
 974++71B1 DD 72 0F     	ld (ix+15),d
 975++71B4 21 00 00     	ld hl,0 ;饥 ⢮ ᥪ஢
 976++71B7              scl_cacl
 977++71B7 32 9A 73     	ld (scl_cat_cycl),a ;横
 978++71BA DD 7E 0D     	ld a,(ix+13) ; 䠩  ᥪ
 979++71BD 4F           	ld c,a
 980++71BE 06 00        	ld b,0
 981++71C0 09           	add hl,bc ;ᥪ஢
 982++71C1
 983++71C1 01 10 00     	ld bc,16
 984++71C4 DD 09        	add ix,bc
 985++71C6 47           	ld b,a
 986++71C7 CD FB 72     	call calc_next_pos
 987++71CA 3A 9A 73     	ld a,(scl_cat_cycl)
 988++71CD FE 01        	cp 1
 989++71CF 28 06        	jr z,scl_cacl2 ; ᫥ ࠧ யᨬ
 990++71D1 DD 73 0E     	ld (ix+14),e
 991++71D4 DD 72 0F     	ld (ix+15),d
 992++71D7              scl_cacl2
 993++71D7 3D           	dec a
 994++71D8 20 DD        	jr nz,scl_cacl
 995++71DA              	;⥯ 㧭  ᢮ ᥪ
 996++71DA DD 7E 0D     	ld a,(ix+13) ; 䠩  ᥪ
 997++71DD 4F           	ld c,a
 998++71DE 06 00        	ld b,0
 999++71E0 09           	add hl,bc
1000++71E1              	; ld b,a
1001++71E1              	; call calc_next_pos
1002++71E1 ED 53 E1 50  	ld (cat_buf+8*256+#e1),de ; ᢮ ᥪ  ஦  ᪥
1003++71E5 11 F0 09     	ld de,16*159
1004++71E8 EB           	ex de,hl
1005++71E9 A7           	and a
1006++71EA ED 52        	sbc hl,de
1007++71EC 22 E5 50     	ld (cat_buf+8*256+#e5),hl ;᫮ ᢮ ᥪ஢  ᪥
1008++71EF DD E1        	pop ix
1009++71F1
1010++71F1
1011++71F1
1012++71F1              ; ᮤন 䠩
1013++71F1 3A 9B 73     	ld a,(scl_files) ;ᥣ 䠩
1014++71F4 32 9A 73     	ld (scl_cat_cycl),a ;横
1015++71F7 21 0D 48     	ld hl,cat_buf+13 ; ࠧ ᥪ஢ 䠩
1016++71FA 22 A4 73     	ld (cat_cur_adr),hl
1017++71FD
1018++71FD 21 00 01     	ld hl,#0100 ;稭  ࢮ ஦
1019++7200 22 F4 5C     	ld (#5cf4),hl
1020++7203              scl_parse_file2
1021++7203 2A 9C 73     	ld hl,(scl_temp_hl) ; 
1022++7206 ED 5B A4 73  	ld de,(cat_cur_adr) ; ᥪ ஦ 䠩
1023++720A              	;dec de
1024++720A 1A           	ld a,(de) ;⢮ ᥪ஢, 横
1025++720B 4F           	ld c,a
1026++720C              scl_parse_file3
1027++720C 11 00 55     	ld de,scl_buf2 ;   
1028++720F 06 00        	ld b,0 ;256   ᥪ, 横
1029++7211              scl_parse_file
1030++7211 7E           	ld a,(hl)
1031++7212 12           	ld (de),a
1032++7213 13           	inc de
1033++7214 2C           	inc l ; 㢥稢 ⮫쪮  । 襣 ॣ
1034++7215 20 26        	jr nz,scl_parse_file1
1035++7217              	;   ᫥騩 ᥪ
1036++7217              ; 樨   256 
1037++7217 22 9C 73     	ld (scl_temp_hl),hl
1038++721A ED 53 A0 73  	ld (scl_temp_de),de
1039++721E ED 43 A2 73  	ld (scl_temp_bc),bc
1040++7222 3E 01        	ld a,1
1041++7224 32 86 73     	ld (scl_que),a ;稬 䫠  㦭 
1042++7227 21 2E 72     	ld hl,scl_parse_ret2 ;࠭  
1043++722A 22 98 73     	ld (scl_parse_ret_adr),hl
1044++722D C9           	ret ;   
1045++722E              scl_parse_ret2
1046++722E AF           	xor a
1047++722F 32 86 73     	ld (scl_que),a
1048++7232 2A 9C 73     	ld hl,(scl_temp_hl)
1049++7235 ED 5B A0 73  	ld de,(scl_temp_de)
1050++7239 ED 4B A2 73  	ld bc,(scl_temp_bc)
1051++723D
1052++723D              scl_parse_file1
1053++723D 10 D2        	djnz scl_parse_file
1054++723F 22 9C 73     	ld (scl_temp_hl),hl
1055++7242 ED 43 A2 73  	ld (scl_temp_bc),bc
1056++7246
1057++7246 21 00 55     	ld hl,scl_buf2 ;;襬  ᥪ
1058++7249 ED 5B F4 5C  	ld  de,(#5cf4)
1059++724D 01 06 01         ld      bc,#0106 ;
1060++7250 CD FE 6D         call    call3d13
1061++7253              	; ld a,c
1062++7253              	; cp 255
1063++7253              	; jp z,fwrite_no_chek ;室 ᫨ 訡
1064++7253 2A 9C 73     	ld hl,(scl_temp_hl)
1065++7256 ED 4B A2 73  	ld bc,(scl_temp_bc)
1066++725A
1067++725A 0D           	dec c
1068++725B 20 AF        	jr nz,scl_parse_file3
1069++725D
1070++725D 2A A4 73     	ld hl,(cat_cur_adr) ; ᥪ ஦ 䠩
1071++7260              	; ld e,(hl)
1072++7260              	; inc hl
1073++7260              	; ld d,(hl)
1074++7260 01 10 00     	ld bc,16
1075++7263 09           	add hl,bc ; ᫥騩 䠩
1076++7264 22 A4 73     	ld (cat_cur_adr),hl
1077++7267
1078++7267
1079++7267 3A 9A 73     	ld a,(scl_cat_cycl)
1080++726A 3D           	dec a
1081++726B 32 9A 73     	ld (scl_cat_cycl),a
1082++726E 20 93        	jr nz,scl_parse_file2	; ᫥騩 䠩
1083++7270
1084++7270
1085++7270
1086++7270              ;ନ஢ ⥬ ᥪ 9 (8)
1087++7270              	;
1088++7270              	;ld (cat_buf+8*256+#e1),a ;// #E1  ᢮ ᥪ  ᪥
1089++7270              	;
1090++7270              	;ld (cat_buf+8*256+#e2),a ;// #E2  ᢮ ४
1091++7270 3E 16        	ld a,#16
1092++7272 32 E3 50     	ld (cat_buf+8*256+#e3),a ;// #E3 16 80 ஦, 2 ஭
1093++7275 3A 9B 73     	ld a,(scl_files)
1094++7278 32 E4 50     	ld (cat_buf+8*256+#e4),a ;// #E4 饥 ⢮ 䠩 ᠭ  
1095++727B              	;
1096++727B              	;ld (cat_buf+8*256+#e5),a ;// #5,6 ᫮ ᢮ ᥪ஢  ᪥
1097++727B              	;ld (cat_buf+8*256+#e6),a
1098++727B 3E 10        	ld a,#10
1099++727D 32 E7 50     	ld (cat_buf+8*256+#e7),a ;// #E7   #10,।騩 ਭ  TR-DOS
1100++7280
1101++7280 21 55 73     	ld hl,f_name ;襬  ᪠,   ⮣  䠩
1102++7283 11 F5 50     	ld de,cat_buf+8*256+#f5 ;// #F5-#FC  ᪠  ASCII ଠ
1103++7286 01 08 00     	ld bc,8
1104++7289 ED B0        	ldir
1105++728B
1106++728B 21 00 48     	ld hl,cat_buf ;襬 ⠫  
1107++728E 11 00 00     	ld de,0
1108++7291 01 06 09         ld      bc,#0906 ;
1109++7294 CD FE 6D         call    call3d13
1110++7297              	; ld a,c
1111++7297              	; cp 255
1112++7297              	; jp z,fwrite_no_chek ;室 ᫨ 訡
1113++7297 C9           	ret
1114++7298
1115++7298
1116++7298              ;-----------scl end --------------------
1117++7298
1118++7298
1119++7298
1120++7298
1121++7298
1122++7298
1123++7298
1124++7298
1125++7298
1126++7298
1127++7298              ; A - file stream id
1128++7298              ; fsync:
1129++7298              ;     esxCall ESX_FSYNC
1130++7298                  ; ret
1131++7298
1132++7298
1133++7298              ; HL - name (name.ext)
1134++7298              ; Returns:
1135++7298              ; HL - name (name    e)
1136++7298              format_name ;  䠩  ⠭ trdos (8+1)
1137++7298
1138++7298              	;᭠砫 ஡㥬    , ᫨  
1139++7298 22 76 73     	ld (temp_hl),hl ;࠭  室 
1140++729B 06 00        	ld b,#00 ;  255 ᨬ
1141++729D              format_name5
1142++729D 7E           	ld a,(hl)
1143++729E FE 2F        	cp "/" ;᫨  
1144++72A0 28 0D        	jr z,format_name_path_yep
1145++72A2 7E           	ld a,(hl)
1146++72A3 FE 2E        	cp "." ;᫨   諨  ७
1147++72A5 20 05        	jr nz,format_name6
1148++72A7 2A 76 73     	ld hl,(temp_hl) ;᫨ 諨  ७,  ⥩ ,   砫 
1149++72AA 18 04        	jr format_name_7 ; 室
1150++72AC              format_name6
1151++72AC 23           	inc hl
1152++72AD 10 EE        	djnz format_name5
1153++72AF
1154++72AF              format_name_path_yep ;諨
1155++72AF 23           	inc hl ;ய⨬  "/"
1156++72B0
1157++72B0              format_name_7
1158++72B0
1159++72B0 E5           	push hl ;⨬    
1160++72B1 21 55 73     	ld hl,f_name
1161++72B4 11 56 73     	ld de,f_name+1
1162++72B7 36 20        	ld (hl)," "
1163++72B9 01 09 00     	ld bc,8+1
1164++72BC ED B0        	ldir
1165++72BE 36 00        	ld (hl),0
1166++72C0 01 06 00     	ld bc,16-8-1-1
1167++72C3 ED B0        	ldir
1168++72C5 E1           	pop hl
1169++72C6
1170++72C6 01 FF 09     	ld bc,#09ff ;  9 ᨬ
1171++72C9 11 55 73     	ld de,f_name ;㤠
1172++72CC              format_name2
1173++72CC 7E           	ld a,(hl)
1174++72CD FE 2E        	cp "."
1175++72CF 20 0C        	jr nz,format_name1
1176++72D1 11 5D 73     	ld de,f_name+8
1177++72D4 23           	inc hl
1178++72D5 ED A0        	ldi ;    ७ 3 㪢
1179++72D7 ED A0        	ldi
1180++72D9 ED A0        	ldi
1181++72DB              	;ex de,hl ;࠭  室 ७
1182++72DB 18 1A        	jr format_name_e
1183++72DD              format_name1
1184++72DD ED A0        	ldi
1185++72DF 10 EB        	djnz format_name2
1186++72E1
1187++72E1              	;᫨  , ய⨬ 譥  ७
1188++72E1 06 00        	ld b,#00 ;  255 ᨬ
1189++72E3              format_name3
1190++72E3 7E           	ld a,(hl)
1191++72E4 FE 2E        	cp "."
1192++72E6 20 0C        	jr nz,format_name4
1193++72E8 11 5D 73     	ld de,f_name+8
1194++72EB 23           	inc hl
1195++72EC ED A0        	ldi ;    ७ 3 㪢
1196++72EE ED A0        	ldi
1197++72F0 ED A0        	ldi
1198++72F2              	;ex de,hl ;࠭  室 ७
1199++72F2 18 03        	jr format_name_e
1200++72F4              format_name4
1201++72F4 23           	inc hl
1202++72F5 10 EC        	djnz format_name3
1203++72F7
1204++72F7              format_name_e ;室
1205++72F7 21 55 73     	ld hl,f_name ; १
1206++72FA C9           	ret
1207++72FB
1208++72FB              ; DE - trk/sec
1209++72FB              ; B - sectors step
1210++72FB              ; Returns:
1211++72FB              ; DE - trk/sec
1212++72FB              calc_next_pos		;  N ᥪ஢
1213++72FB              			;ld b,4
1214++72FB              			;ld  de,(#5ceb)
1215++72FB              calc_next_pos2
1216++72FB 1C           			inc e
1217++72FC 7B           			ld a,e
1218++72FD FE 10        			cp 16
1219++72FF 38 03        			jr c,calc_next_pos1
1220++7301 14           			inc d
1221++7302 1E 00        			ld e,0
1222++7304              calc_next_pos1
1223++7304              			;ld (#5ceb),de
1224++7304 10 F5        			djnz calc_next_pos2
1225++7306 C9           			ret
1226++7307
1227++7307
1228++7307              ;testt db "123.trd"
1229++7307 53 65 6C 65  write_ima db "Select disk "
1229++730B 63 74 20 64
1229++730F 69 73 6B 20
1230++7313 41 3A 20 28  write_ima_d db "A: (A-D). "
1230++7317 41 2D 44 29
1230++731B 2E 20
1231++731D 41 6C 6C 20  		db "All data may be lost! Press Y or N.",0
1231++7321 64 61 74 61
1231++7325 20 6D 61 79
1231++7329 20 62 65 20
1231++732D 6C 6F 73 74
1231++7331 21 20 50 72
1231++7335 65 73 73 20
1231++7339 59 20 6F 72
1231++733D 20 4E 2E 00
1232++7341              ;prev_drive db 0 ;।騩  ᪮
1233++7341
1234++7341 2E 74 72 64  trdExt1 db ".trd", 0
1234++7345 00
1235++7346 2E 54 52 44  trdExt2 db ".TRD", 0
1235++734A 00
1236++734B
1237++734B 2E 73 63 6C  sclExt1 db ".scl", 0
1237++734F 00
1238++7350 2E 53 43 4C  sclExt2 db ".SCL", 0
1238++7354 00
1239++7355
1240++7355 00 00 00...  f_name ds 16 ; 䠩
1241++7365 00 00        f_r_cur_trk dw 	 0 ;⥪騥 ᥪ-஦ 䠩  ⥭
1242++7367 00           f_r_len_sec db 0 ; 䠩  ⥭  ᥪ
1243++7368 00 00        f_r_len dw 0; 䠩  
1244++736A 00           f_r_flag db 0 ;䫠   䠩  ⥭
1245++736B
1246++736B 00 00        f_w_cur_trk dw 	 0 ;⥪騥 ᥪ-஦ 䠩  
1247++736D 00           f_w_len_sec db 0 ; 䠩    ᥪ
1248++736E 00           f_w_flag db 0 ;䫠   䠩  
1249++736F 00 00 00 00  f_w_len ds 4 ; ᠭ 
1250++7373 00           write_end_flag db 0 ;䫠  㦭  ⮪
1251++7374
1252++7374 00 00        temp_bc dw 0 ;࠭ ॣ
1253++7376 00 00        temp_hl dw 0 ;࠭ ॣ
1254++7378 00 00        temp_hl2 dw 0 ;࠭ ॣ
1255++737A
1256++737A 00           sec_shift db 0 ;㪠⥫    ⠭ 
1257++737B 00           sec_shift2 db 0 ;㪠⥫    ⠭  (⮪)
1258++737C 00           sec_part db 0 ;᪮쪮 ᥪ஢  ன 樨  
1259++737D 00           sec_shift_flag db 0 ;䫠   ᥪ  
1260++737E
1261++737E              ;ᥪ scl
1262++737E 53 49 4E 43  scl_sign db "SINCLAIR" ;⪠
1262++7382 4C 41 49 52
1263++7386 00           scl_que db 0 ;䫠  樨 
1264++7387 53 43 4C 20  scl_err db "SCL image error!",0
1264++738B 69 6D 61 67
1264++738F 65 20 65 72
1264++7393 72 6F 72 21
1264++7397 00
1265++7398 00 00        scl_parse_ret_adr dw 0;    横
1266++739A 00           scl_cat_cycl db 0 ;६ 横
1267++739B 00           scl_files db 0 ;ᥣ 䠩
1268++739C 00 00        scl_temp_hl dw 0;;࠭ ॣ
1269++739E 00 00        scl_temp_hl2 dw 0;
1270++73A0 00 00        scl_temp_de dw 0;
1271++73A2 00 00        scl_temp_bc dw 0;
1272++73A4 00 00        cat_cur_adr dw 0;
1273++73A6              ;scl end
1274++73A6
1275++73A6              ;ᥪ ࠭  䠩
1276++73A6 4E 6F 74 20  file_err db "Not enough space!",0
1276++73AA 65 6E 6F 75
1276++73AE 67 68 20 73
1276++73B2 70 61 63 65
1276++73B6 21 00
1277++73B8 00           sec_cat db 0 ;ᥪ ⠫
1278++73B9 30           file_num db "0" ;    䠩
1279++73BA
1280++73BA              	;  #4000 
1281++73BA              cat_buf equ #4800 ;  ⮣ ᪠ 9*256
1282++73BA              sec_buf equ cat_buf + 9*256 ; ᥪ   256
1283++73BA              scl_buf equ sec_buf + 512 ;஬  256
1284++73BA              scl_buf2 equ scl_buf + 512 ;஬  256
1285++73BA
1286++73BA                  ENDMODULE
# file closed: dos/trdos.asm
   9++73BA              	ENDIF
  10++73BA
  11++73BA              	IFDEF ESXDOS
  12++73BA ~               		include "console.asm"
  13++73BA ~               		include "esxdos.asm"
  14++73BA              	ENDIF
  15++73BA
  16++73BA              	IFDEF P3DOS
  17++73BA ~               		include "console.asm"
  18++73BA ~               		include "p3dos.asm"
  19++73BA              	ENDIF
  20++73BA
# file closed: dos/index.asm
  19+ 73BA                  include "gopher/engine/history/index.asm"
# file opened: gopher/engine/history/index.asm
   1++73BA                  include "controler.asm"
# file opened: gopher/engine/history/controler.asm
   1++73BA                  module History
   2++73BA              back:
   3++73BA 3A FA 74         ld a, (depth)
   3++73BD FE 01          cp 1
   3++73BF CA D1 73       jp z, load
   4++73C2 21 49 78 11      ld hl, historyBlock + HistoryRecord, de, historyBlock, bc, (total - 1) * HistoryRecord
   4++73C6 FB 74 01 38
   4++73CA 0D
   4++73CB ED B0          ldir ; Move history up
   5++73CD 21 FA 74         ld hl, depth
   5++73D0 35             dec (hl)
   6++73D1              ; Loads current resource
   7++73D1              load:
   8++73D1 21 EE 73         ld hl, .msg
   8++73D4 CD 13 6A       call DialogBox.msgNoWait
   9++73D7 AF               xor a
   9++73D8 21 59 A1 11    ld hl, outputBuffer, de, outputBuffer + 1
   9++73DC 5A A1
  10++73DE              	IFDEF MSX
  11++73DE ~                	ld bc, (ramtop)
  12++73DE ~                	dec bc
  13++73DE              	ELSE
  14++73DE 01 A5 5E         	ld bc, #ffff - outputBuffer - 1
  15++73E1              	ENDIF
  16++73E1
  17++73E1 77               ld (hl), a
  18++73E2 ED B0            ldir
  19++73E4
  20++73E4 3A FB 74         ld a, (historyBlock.isFile)
  20++73E7 A7             and a
  20++73E8 C2 E5 89       jp nz, Fetcher.fetchFromFS
  21++73EB C3 98 89         jp Fetcher.fetchFromNet
  22++73EE
  23++73EE 20 20 20 20  .msg db "    Loading resource! Please wait! It will be here soon!", 0
  23++73F2 4C 6F 61 64
  23++73F6 69 6E 67 20
  23++73FA 72 65 73 6F
  23++73FE 75 72 63 65
  23++7402 21 20 50 6C
  23++7406 65 61 73 65
  23++740A 20 77 61 69
  23++740E 74 21 20 49
  23++7412 74 20 77 69
  23++7416 6C 6C 20 62
  23++741A 65 20 68 65
  23++741E 72 65 20 73
  23++7422 6F 6F 6E 21
  23++7426 00
  24++7427
  25++7427              home:
  26++7427 21 D8 74         ld hl, homePage
  27++742A              ; HL - gopher row
  28++742A              navigate:
  29++742A 54 5D            ld de, hl
  30++742C CD 10 89         call UrlEncoder.isValidGopherRow
  31++742F 30 A0            jr nc, load ; Not valid - reload last
  32++7431 62 6B            ld hl, de
  33++7433 E5               push hl
  34++7434
  35++7434 E5               push hl
  36++7435 21 80 85 11      ld hl, HistoryEnd - HistoryRecord, de, HistoryEnd, bc,  HistoryRecord * total
  36++7439 CE 88 01 86
  36++743D 10
  36++743E ED B8          lddr
  37++7440
  38++7440 ED 5B 41 78      ld de, (Render.position), (historyBlock.position + HistoryRecord), de
  38++7444 ED 53 8F 7B
  39++7448                  ; Clean up struct
  40++7448 AF               xor a
  40++7449 21 FB 74 11    ld hl, historyBlock, de, historyBlock + 1, bc, historyBlockSize - 1, (hl), a
  40++744D FC 74 01 4D
  40++7451 03 77
  40++7453 ED B0          ldir
  41++7455 E1               pop hl
  42++7456
  43++7456                  ; Fill record
  44++7456 54 5D            ld de, hl
  45++7458 CD CF 88         call UrlEncoder.isFile
  46++745B EB               ex hl, de
  47++745C 11 FB 74         ld de, historyBlock
  48++745F 12               ld (de), a
  48++7460 13             inc de
  49++7461 7E               ld a, (hl)
  49++7462 E5 D5          push hl, de
  49++7464 CD 8E 64       call Render.getIcon
  49++7467 D1 E1          pop de, hl
  50++7469 12               ld (de), a
  50++746A 13             inc de
  51++746B 3E 09            ld a, 9
  52++746D
  53++746D 01 FF 01         ld bc, #1ff
  54++7470
  55++7470 ED B1            cpir
  56++7472              .locatorCopy
  57++7472 7E               ld a, (hl)
  57++7473 FE 09          cp 9
  57++7475 28 05          jr z, 1f
  58++7477 12               ld (de), a
  58++7478 23 13          inc hl, de
  59++747A 18 F6            jr .locatorCopy
  60++747C              1
  61++747C 23               inc hl
  61++747D AF             xor a
  61++747E 12             ld (de), a
  62++747F 11 FC 76         ld de, historyBlock.host
  63++7482              .hostCopy
  64++7482 7E               ld a, (hl)
  64++7483 FE 09          cp 9
  64++7485 28 05          jr z, 1f
  65++7487 12               ld (de), a
  65++7488 23 13          inc hl, de
  66++748A 18 F6            jr .hostCopy
  67++748C              1
  68++748C 23               inc hl
  68++748D AF             xor a
  68++748E 12             ld (de), a
  69++748F 11 3C 77         ld de, historyBlock.port
  70++7492              .portCopy
  71++7492 7E               ld a, (hl)
  72++7493 FE 09            cp 9
  72++7495 28 11          jr z, 1f
  73++7497 FE 0D            cp 13
  73++7499 28 0D          jr z, 1f
  74++749B FE 0A            cp 10
  74++749D 28 09          jr z, 1f
  75++749F FE 00            cp 0
  75++74A1 28 05          jr z, 1f
  76++74A3 12               ld (de), a
  76++74A4 23 13          inc hl, de
  77++74A6 18 EA            jr .portCopy
  78++74A8 AF           1   xor a
  78++74A9 12             ld (de), a
  79++74AA 21 BA 69 11      ld hl, DialogBox.inputBuffer, de, historyBlock.search, bc, #ff
  79++74AE 42 77 01 FF
  79++74B2 00
  79++74B3 ED B0          ldir
  80++74B5 11 00 00 ED      ld de, 0, (historyBlock.position), de
  80++74B9 53 41 78
  81++74BC E1               pop hl
  82++74BD 3A FA 74         ld a, (depth)
  82++74C0 FE 05          cp total
  82++74C2 30 04          jr nc, 1f
  83++74C4 3C               inc a
  83++74C5 32 FA 74       ld (depth), a
  84++74C8              1
  85++74C8 3A FC 74         ld a,(historyBlock.mediaType)
  85++74CB FE 01          cp MIME_DOWNLOAD
  85++74CD CA EB 8A       jp z, Gopher.download
  86++74D0
  87++74D0                  ifdef GS
  88++74D0 FE 07            cp MIME_MOD
  88++74D2 CA 8A 8A       jp z, Gopher.loadMod
  89++74D5                  endif
  90++74D5
  91++74D5 C3 D1 73         jp load
  92++74D8
  93++74D8              homePage:
  94++74D8              	IFDEF MSX
  95++74D8 ~                	db "1Home", TAB, "index.gph"
  96++74D8 ~                	db TAB, "file", TAB, "70", CR, LF, 0
  97++74D8                  ELSE
  98++74D8 31 48 6F 6D      	db "1Home", TAB, "browser/index.gph"
  98++74DC 65 09 62 72
  98++74E0 6F 77 73 65
  98++74E4 72 2F 69 6E
  98++74E8 64 65 78 2E
  98++74EC 67 70 68
  99++74EF 09 66 69 6C      	db TAB, "file", TAB, "70", CR, LF, 0
  99++74F3 65 09 37 30
  99++74F7 0D 0A 00
 100++74FA                  ENDIF
 101++74FA                  endmodule
# file closed: gopher/engine/history/controler.asm
   2++74FA                  include "model.asm"
# file opened: gopher/engine/history/model.asm
   1++74FA              total   equ 5
   2++74FA 00           depth   db 0
   3++74FB
   4++74FB              historyBlock:
   5++74FB 00           .isFile    db  0
   6++74FC 00           .mediaType db  0
   7++74FD 00 00 00...  .locator   ds  #1ff
   8++76FC 00 00 00...  .host      ds  64
   9++773C 00 00 00...  .port      ds  6
  10++7742 00 00 00...  .search    ds  #ff
  11++7841 00 00        .position  dw  #0000    ;position
  12++7843
  13++7843 00 00 00 00      db 0,0,0,0,0,0  ;cursor_position page_offset
  13++7847 00 00
  14++7849
  15++7849              historyBlockSize = $ - historyBlock
  16++7849
  17++7849              HistoryRecord EQU $ - historyBlock
  18++7849                  dup total
  19++7849 00 00 00... >    ds HistoryRecord
  19++7B97 00 00 00... >    ds HistoryRecord
  19++7EE5 00 00 00... >    ds HistoryRecord
  19++8233 00 00 00... >    ds HistoryRecord
  19++8581 00 00 00... >    ds HistoryRecord
  20++88CF                  edup
  21++88CF              HistoryEnd equ $ - 1
  22++88CF
# file closed: gopher/engine/history/model.asm
# file closed: gopher/engine/history/index.asm
  20+ 88CF                  include "gopher/engine/urlencoder.asm"
# file opened: gopher/engine/urlencoder.asm
   1++88CF                  MODULE UrlEncoder
   2++88CF              ; HL - pointer to line in gopher page
   3++88CF              ; C - flag set when it's file
   4++88CF              isFile:
   5++88CF              .findServerLoop
   6++88CF 7E               ld a, (hl)
   6++88D0 A7             and a
   6++88D1 28 3B          jr z, .notFile
   6++88D3 23             inc hl
   7++88D4 FE 0D            cp 13
   7++88D6 28 36          jr z, .notFile
   8++88D8 FE 09            cp 9
   8++88DA 28 02          jr z, .skipPath
   9++88DC 18 F1            jr .findServerLoop
  10++88DE              .skipPath
  11++88DE 7E               ld a, (hl)
  11++88DF A7             and a
  11++88E0 28 2C          jr z, .notFile
  11++88E2 23             inc hl
  12++88E3 FE 0D            cp 13
  12++88E5 28 27          jr z, .notFile
  13++88E7 FE 09            cp 9
  13++88E9 28 02          jr z, .compareServer
  14++88EB 18 F1            jr .skipPath
  15++88ED              .compareServer
  16++88ED 7E               ld a, (hl)
  16++88EE FE 66          cp "f"
  16++88F0 20 1C          jr nz, .notFile
  16++88F2 23             inc hl
  17++88F3 7E               ld a, (hl)
  17++88F4 FE 69          cp "i"
  17++88F6 20 16          jr nz, .notFile
  17++88F8 23             inc hl
  18++88F9 7E               ld a, (hl)
  18++88FA FE 6C          cp "l"
  18++88FC 20 10          jr nz, .notFile
  18++88FE 23             inc hl
  19++88FF 7E               ld a, (hl)
  19++8900 FE 65          cp "e"
  19++8902 20 0A          jr nz, .notFile
  19++8904 23             inc hl
  20++8905 7E               ld a, (hl)
  20++8906 FE 09          cp 9
  20++8908 20 04          jr nz, .notFile
  20++890A 23             inc hl
  21++890B 3E 01            ld a, 1
  22++890D C9               ret
  23++890E              .notFile
  24++890E AF               xor a
  25++890F C9               ret
  26++8910
  27++8910              ; Is enough fields to encode
  28++8910              ; HL - pointer to line in gopher page
  29++8910              ; C - flag set when there is enough fields
  30++8910              isValidGopherRow:
  31++8910 7E               ld a, (hl)
  31++8911 A7             and a
  31++8912 28 FA          jr z, isFile.notFile
  31++8914 23             inc hl
  32++8915 FE 0D            cp 13
  32++8917 28 F5          jr z, isFile.notFile
  33++8919 FE 09            cp 9
  33++891B 28 02          jr z, .skipPath
  34++891D 18 F1            jr isValidGopherRow
  35++891F              .skipPath
  36++891F 7E               ld a, (hl)
  36++8920 A7             and a
  36++8921 28 EB          jr z, isFile.notFile
  36++8923 23             inc hl
  37++8924 FE 0D            cp 13
  37++8926 28 E6          jr z, isFile.notFile
  38++8928 FE 09            cp 9
  38++892A 28 02          jr z, .skipHost
  39++892C 18 F1            jr .skipPath
  40++892E              .skipHost
  41++892E 7E               ld a, (hl)
  41++892F A7             and a
  41++8930 28 DC          jr z, isFile.notFile
  41++8932 23             inc hl
  42++8933 FE 0D            cp 13
  42++8935 28 D7          jr z, isFile.notFile
  43++8937 FE 09            cp 9
  43++8939 28 02           jr z, .isValid
  44++893B 18 F1            jr .skipHost
  45++893D              .isValid:
  46++893D 37               scf
  47++893E C9               ret
  48++893F
  49++893F              extractPath:
  50++893F 21 FD 74 11      ld hl, historyBlock.locator, de, Gopher.requestbuffer, bc, #ff
  50++8943 E1 8B 01 FF
  50++8947 00
  50++8948 ED B0          ldir
  51++894A C9               ret
  52++894B
  53++894B              extractHostName:
  54++894B 21 FC 76 11      ld hl, historyBlock.host, de, hostName, bc, 64
  54++894F 58 89 01 40
  54++8953 00
  54++8954 ED B0          ldir
  55++8956 C9               ret
  56++8957
  57++8957                  ENDMODULE
  58++8957
  59++8957              ;nameBuffer ds #ff, 0
  60++8957
  61++8957 00                    db 0
  62++8958 00 00 00...  hostName ds 64
# file closed: gopher/engine/urlencoder.asm
  21+ 8998                  include "gopher/engine/fetcher.asm"
# file opened: gopher/engine/fetcher.asm
   1++8998                  MODULE Fetcher
   2++8998
   3++8998              fetchFromNet:
   4++8998
   5++8998              	IFDEF MSX
   6++8998 ~                	call Gopher.makeRequest
   6++8998 ~              jr nz, .error
   7++8998                  ELSE
   8++8998 CD 5F 8A         	call Gopher.makeRequest
   8++899B 38 06          jr c, .error
   9++899D                  ENDIF
  10++899D
  11++899D CD 77 8A         call Gopher.loadBuffer
  12++89A0 C3 F1 89         jp MediaProcessor.processResource
  13++89A3              .error
  14++89A3 21 AC 89         ld hl, .err
  14++89A6 CD 0A 6A       call DialogBox.msgBox
  15++89A9 C3 BA 73         jp History.back
  16++89AC
  17++89AC 44 6F 63 75  .err db "Document fetch error! Check your connection or hostname!", 0
  17++89B0 6D 65 6E 74
  17++89B4 20 66 65 74
  17++89B8 63 68 20 65
  17++89BC 72 72 6F 72
  17++89C0 21 20 43 68
  17++89C4 65 63 6B 20
  17++89C8 79 6F 75 72
  17++89CC 20 63 6F 6E
  17++89D0 6E 65 63 74
  17++89D4 69 6F 6E 20
  17++89D8 6F 72 20 68
  17++89DC 6F 73 74 6E
  17++89E0 61 6D 65 21
  17++89E4 00
  18++89E5
  19++89E5
  20++89E5              fetchFromFS:
  21++89E5 CD 3F 89         call UrlEncoder.extractPath
  22++89E8              loadFile
  23++89E8              	IFDEF MSX
  24++89E8 ~                ld de, Gopher.requestbuffer, a, FMODE_NO_WRITE
  25++89E8 ~                call Dos.fopen
  26++89E8 ~                ld a, b, (.fp), a
  27++89E8 ~                ld de, outputBuffer, hl, (ramtop)
  28++89E8 ~                call Dos.fread
  29++89E8 ~                ld a, (.fp), b, a
  30++89E8 ~                call Dos.fclose
  31++89E8 ~                jp MediaProcessor.processResource
  32++89E8 ~            .fp db 0
  33++89E8              	ELSE
  34++89E8 21 E1 8B         ld hl, Gopher.requestbuffer
  35++89EB CD 9B 6C         call Dos.loadBuffer
  36++89EE C3 F1 89         jp MediaProcessor.processResource
  37++89F1              	ENDIF
  38++89F1                  ENDMODULE
# file closed: gopher/engine/fetcher.asm
  22+ 89F1                  include "gopher/engine/media-processor.asm"
# file opened: gopher/engine/media-processor.asm
   1++89F1                  MODULE MediaProcessor
   2++89F1              processResource:
   3++89F1 CD 4B 89         call UrlEncoder.extractHostName
   4++89F4 3A FC 74         ld a, (historyBlock.mediaType)
   5++89F7 FE 05            cp MIME_MUSIC
   5++89F9 28 17          jr z, processPT
   6++89FB FE 02            cp MIME_LINK
   6++89FD 28 1F          jr z, processPage
   7++89FF FE 04            cp MIME_INPUT
   7++8A01 28 1B          jr z, processPage
   8++8A03 FE 06            cp MIME_IMAGE
   8++8A05 CA CB 94       jp z, ScreenViewer.display
   9++8A08              	ifdef GS
  10++8A08 FE 07            cp MIME_MOD
  10++8A0A 28 0C          jr z, processMOD
  11++8A0C              	endif
  12++8A0C              ; Fallback to plain text
  13++8A0C              processText:
  14++8A0C CD 72 68         call Render.renderPlainTextScreen
  15++8A0F C3 BA 68         jp   Render.plainTextLoop
  16++8A12
  17++8A12              processPT:
  18++8A12 CD F0 94         call VortexProcessor.play
  19++8A15 C3 BA 73         jp History.back
  20++8A18
  21++8A18                  ifdef GS
  22++8A18              processMOD:
  23++8A18 CD 26 94         call ModProcessor.play
  24++8A1B C3 BA 73         jp History.back
  25++8A1E              	endif
  26++8A1E
  27++8A1E              processPage:
  28++8A1E 3A 54 69         ld a, (Render.play_next)
  28++8A21 A7             and a
  28++8A22 20 06          jr nz, .playNext
  29++8A24 CD C6 66         call Render.renderGopherScreen
  30++8A27 C3 15 67         jp   Render.workLoop
  31++8A2A              .playNext
  32++8A2A 21 43 78         ld hl, Render.cursor_position
  33++8A2D 34               inc (hl)
  34++8A2E CD C6 66         call Render.renderGopherScreen
  35++8A31 C3 FF 66         jp Render.checkBorder
  36++8A34                  ENDMODULE
# file closed: gopher/engine/media-processor.asm
  23+ 8A34                  include "gopher/gopher.asm"
# file opened: gopher/gopher.asm
   1++8A34                  module Gopher
   2++8A34              ; HL - gopher row
   3++8A34              extractRequest:
   4++8A34 21 FD 74         ld hl, historyBlock.locator
   5++8A37 11 E1 8B         ld de, requestbuffer
   6++8A3A              .loop
   7++8A3A 7E               ld a, (hl)
   8++8A3B 12               ld (de), a
   9++8A3C 23               inc hl
  10++8A3D 13               inc de
  11++8A3E FE 00            cp 0
  12++8A40 28 02            jr z, .search
  13++8A42 18 F6            jr .loop
  14++8A44              .search
  15++8A44 1B               dec de
  16++8A45 3A FC 74         ld a, (historyBlock.mediaType)
  17++8A48 FE 04            cp MIME_INPUT
  18++8A4A 20 10            jr nz, .exit
  19++8A4C 21 42 77         ld hl, historyBlock.search
  20++8A4F 3E 09            ld a, TAB
  21++8A51 12               ld (de), a
  22++8A52 13               inc de
  23++8A53              .searchCopy
  24++8A53 7E               ld a, (hl)
  25++8A54 A7               and a
  25++8A55 28 05          jr z, .exit
  26++8A57 12               ld (de), a
  27++8A58 23               inc hl
  27++8A59 13             inc de
  28++8A5A 18 F7            jr .searchCopy
  29++8A5C              .exit
  30++8A5C AF               xor a
  31++8A5D 12               ld (de), a
  32++8A5E C9               ret
  33++8A5F
  34++8A5F
  35++8A5F              makeRequest:
  36++8A5F CD 34 8A         call extractRequest
  37++8A62
  38++8A62 21 FC 76         ld hl, historyBlock.host
  39++8A65 11 3C 77         ld de, historyBlock.port
  40++8A68 CD 8D 90         call Wifi.openTCP
  41++8A6B D8               ret c
  42++8A6C
  43++8A6C 21 E1 8B         ld hl, requestbuffer
  44++8A6F CD 7E 91         call Wifi.tcpSendZ
  45++8A72 AF               xor a
  45++8A73 32 58 8F       ld (Wifi.closed), a
  46++8A76 C9               ret
  47++8A77
  48++8A77
  49++8A77              loadBuffer:
  50++8A77 21 59 A1         ld hl, outputBuffer
  51++8A7A 22 56 8F         ld (Wifi.buffer_pointer), hl
  52++8A7D              .loop
  53++8A7D CD CE 91         call Wifi.getPacket
  54++8A80 3A 58 8F         ld a, (Wifi.closed)
  54++8A83 A7             and a
  54++8A84 C0             ret nz
  55++8A85 CD EB 90         call Wifi.continue
  56++8A88 18 F3            jr .loop
  57++8A8A
  58++8A8A                  ifdef GS
  59++8A8A              loadMod:
  60++8A8A AF               xor a
  60++8A8B CD 1D 93       call GeneralSound.init
  61++8A8E 21 CB 8A         ld hl, .progress
  61++8A91 CD 13 6A       call DialogBox.msgNoWait
  62++8A94 CD 5F 8A         call makeRequest
  62++8A97 DA A3 89       jp c, Fetcher.fetchFromNet.error
  63++8A9A CD 2A 93         call GeneralSound.loadModule
  64++8A9D              .loop
  65++8A9D 21 59 A1 22      ld hl, outputBuffer, (Wifi.buffer_pointer), hl
  65++8AA1 56 8F
  66++8AA3 CD CE 91         call Wifi.getPacket
  67++8AA6 3A 58 8F         ld a, (Wifi.closed)
  67++8AA9 A7             and a
  67++8AAA 20 19          jr nz, .exit
  68++8AAC 21 59 A1 ED      ld hl, outputBuffer, bc, (Wifi.bytes_avail)
  68++8AB0 4B 54 8F
  69++8AB3              .loadLoop
  70++8AB3 78               ld a, b
  70++8AB4 B1             or c
  70++8AB5 A7             and a
  70++8AB6 28 08          jr z, .nextFrame
  71++8AB8 7E               ld a, (hl)
  71++8AB9 CD 3D 93       call GeneralSound.sendByte
  72++8ABC 0B               dec bc
  73++8ABD 23               inc hl
  74++8ABE 18 F3            jr .loadLoop
  75++8AC0              .nextFrame
  76++8AC0 CD C1 8B         call pulsing
  77++8AC3                  ;call Wifi.continue
  78++8AC3 18 D8            jr .loop
  79++8AC5              .exit
  80++8AC5 CD 45 93         call GeneralSound.finishLoadingModule
  81++8AC8                  ;jp History.back
  82++8AC8 C3 F1 89     	jp MediaProcessor.processResource
  83++8ACB 4D 4F 44 20  .progress db "MOD downloading directly to GS!", 0
  83++8ACF 64 6F 77 6E
  83++8AD3 6C 6F 61 64
  83++8AD7 69 6E 67 20
  83++8ADB 64 69 72 65
  83++8ADF 63 74 6C 79
  83++8AE3 20 74 6F 20
  83++8AE7 47 53 21 00
  84++8AEB                  endif
  85++8AEB
  86++8AEB              download:
  87++8AEB 11 FD 74         ld de, historyBlock.locator
  88++8AEE 62 6B            ld hl, de
  89++8AF0              .findFileName
  90++8AF0 1A               ld a, (de)
  90++8AF1 13             inc de
  91++8AF2 FE 2F            cp '/'
  91++8AF4 20 02          jr nz, .skip
  92++8AF6 62 6B            ld hl, de
  93++8AF8              .skip
  94++8AF8 A7               and a
  94++8AF9 20 F5          jr nz, .findFileName
  95++8AFB              .copy
  96++8AFB                  ;; HL - filename pointer
  97++8AFB 11 BA 69         ld de, DialogBox.inputBuffer
  98++8AFE              .copyFileName
  99++8AFE 7E               ld a, (hl)
  99++8AFF A7             and a
  99++8B00 28 05          jr z, .finishCopy
 100++8B02
 101++8B02 12               ld (de), a
 101++8B03 23 13          inc hl, de
 102++8B05 18 F7            jr .copyFileName
 103++8B07              .finishCopy
 104++8B07 12               ld (de), a
 105++8B08 CD 59 69         call DialogBox.inputBox.noclear
 106++8B0B 3A BA 69         ld a, (DialogBox.namedownload)
 106++8B0E A7             and a
 106++8B0F CA BA 73       jp z, History.back
 107++8B12
 108++8B12 CD 5F 8A         call makeRequest
 108++8B15 DA A3 89       jp c, Fetcher.fetchFromNet.error
 109++8B18
 110++8B18 06 0E 21 BA      ld b, Dos.FMODE_CREATE, hl, DialogBox.namedownload
 110++8B1C 69
 111++8B1D CD B7 6C         call Dos.fopen
 112++8B20 32 BE 8B         ld (.fp), a
 113++8B23
 114++8B23 21 99 8B         ld hl, .progress
 114++8B26 CD 13 6A       call DialogBox.msgNoWait
 115++8B29              .loop
 116++8B29 21 59 A1 22      ld hl, outputBuffer, (Wifi.buffer_pointer), hl
 116++8B2D 56 8F
 117++8B2F CD CE 91         call Wifi.getPacket
 118++8B32 3A 58 8F         ld a, (Wifi.closed)
 118++8B35 A7             and a
 118++8B36 20 12          jr nz, .exit
 119++8B38
 120++8B38 3A BE 8B 21      ld a, (.fp), hl, outputBuffer, bc, (Wifi.bytes_avail)
 120++8B3C 59 A1 ED 4B
 120++8B40 54 8F
 121++8B42 CD 31 6F         call Dos.fwrite
 122++8B45 CD C1 8B         call pulsing
 123++8B48 18 DF            jr .loop
 124++8B4A              .exit
 125++8B4A 3A BE 8B         ld a, (.fp)
 126++8B4D CD 02 6E         call Dos.fclose
 127++8B50 C3 BA 73         jp History.back
 128++8B53              .error
 129++8B53 3A BE 8B         ld a, (.fp)
 130++8B56 CD 02 6E         call Dos.fclose
 131++8B59 21 62 8B         ld hl, .err
 132++8B5C CD 0A 6A         call DialogBox.msgBox
 133++8B5F C3 BA 73         jp History.back
 134++8B62
 135++8B62 4F 70 65 72  .err db "Operation failed! Sorry! Check filename or disk space!",0
 135++8B66 61 74 69 6F
 135++8B6A 6E 20 66 61
 135++8B6E 69 6C 65 64
 135++8B72 21 20 53 6F
 135++8B76 72 72 79 21
 135++8B7A 20 43 68 65
 135++8B7E 63 6B 20 66
 135++8B82 69 6C 65 6E
 135++8B86 61 6D 65 20
 135++8B8A 6F 72 20 64
 135++8B8E 69 73 6B 20
 135++8B92 73 70 61 63
 135++8B96 65 21 00
 136++8B99 44 6F 77 6E  .progress db "Downloading in progress! Wait a bit!", 0
 136++8B9D 6C 6F 61 64
 136++8BA1 69 6E 67 20
 136++8BA5 69 6E 20 70
 136++8BA9 72 6F 67 72
 136++8BAD 65 73 73 21
 136++8BB1 20 57 61 69
 136++8BB5 74 20 61 20
 136++8BB9 62 69 74 21
 136++8BBD 00
 137++8BBE 00           .fp db 0
 138++8BBF 00           socket db 0
 139++8BC0 20           pulsator db " "
 140++8BC1              pulsing
 141++8BC1 11 01 0B         ld de, #0B01
 141++8BC4 CD 3A 60       call TextMode.gotoXY
 142++8BC7 3A C0 8B         ld a, (pulsator)
 143++8BCA FE 2A            cp '*'
 144++8BCC CA D8 8B         jp z, printasterix
 145++8BCF CD A4 60         call TextMode.putC
 146++8BD2 3E 2A            ld a, '*'
 147++8BD4 32 C0 8B         ld (pulsator),a
 148++8BD7 C9               ret
 149++8BD8              printasterix
 150++8BD8 CD A4 60         call TextMode.putC
 151++8BDB 3E 20            ld a, ' '
 152++8BDD 32 C0 8B         ld (pulsator),a
 153++8BE0 C9               ret
 154++8BE1
 155++8BE1 00 00 00...  requestbuffer ds #1ff
 156++8DE0                  endmodule
 157++8DE0
# file closed: gopher/gopher.asm
  24+ 8DE0                  include "drivers/index.asm"
# file opened: drivers/index.asm
   1++8DE0                  IFDEF UNO
   2++8DE0 ~                	include "uart-uno.asm"
   3++8DE0                  ENDIF
   4++8DE0
   5++8DE0                  IFDEF UNOUART
   6++8DE0 ~                	include "uart-uno.asm"
   7++8DE0                  ENDIF
   8++8DE0
   9++8DE0                  IFDEF MB03
  10++8DE0 ~                	include "uart-mb03.asm"
  11++8DE0                  ENDIF
  12++8DE0
  13++8DE0                  IFDEF AY
  14++8DE0                  	include "uart-ay.asm"
# file opened: drivers/uart-ay.asm
   1++8DE0                  module Uart
   2++8DE0                  assert $ > #8000 ;; Important keep it in FAST memory
   3++8DE0              init:
   4++8DE0 F3               di
   5++8DE1 3E 07            ld a, #07
   6++8DE3 01 FD FF         ld bc, #fffd
   7++8DE6 ED 79            out (c), a
   8++8DE8 3E FC            ld a, #fc
   9++8DEA 06 BF            ld b, #bf
  10++8DEC ED 79            out (c), a ; Enable read mode
  11++8DEE
  12++8DEE 3E 0E            ld a, #0e
  13++8DF0 01 FD FF         ld bc, #fffd
  14++8DF3 ED 79            out (c), a
  15++8DF5
  16++8DF5 06 BF            ld b, #bf
  17++8DF7 ED 78            in a, (c)
  18++8DF9 E6 FB            and #fb
  19++8DFB ED 79            out (c), a ; Make CTS low
  20++8DFD
  21++8DFD FB               ei
  22++8DFE 06 FF            ld b, #ff
  23++8E00              .flush
  24++8E00 76               halt
  25++8E01 10 FD            djnz .flush
  26++8E03 C9               ret
  27++8E04
  28++8E04
  29++8E04              write:
  30++8E04 E5 D5 C5         push hl, de, bc
  31++8E07 F5               push af
  32++8E08 0E FD            ld c, #fd ; prepare port addresses
  33++8E0A 16 FF            ld d, #ff
  34++8E0C 1E BF            ld e, #bf
  35++8E0E 42               ld b, d
  36++8E0F
  37++8E0F 3E 0E            ld a, #0e
  38++8E11 ED 79            out (c), a ; Select AY's PORT A
  39++8E13
  40++8E13 2A 44 8F         ld hl, (_baud)
  41++8E16 11 02 00         ld de, #0002
  42++8E19 B7               or a
  43++8E1A ED 52            sbc hl, de
  44++8E1C EB               ex hl, de
  45++8E1D
  46++8E1D F1               pop af
  47++8E1E 2F               cpl
  48++8E1F 37               scf
  49++8E20 06 0B            ld b, #0b ; Numbers of bits - 1 start, 8 data, 2 stop
  50++8E22
  51++8E22 F3               di ; Hard timing starts
  52++8E23              transmitBit:
  53++8E23 C5               push bc
  54++8E24 F5               push af
  55++8E25
  56++8E25 3E FE            ld a, #fe
  57++8E27 62               ld h, d
  58++8E28 6B               ld l, e
  59++8E29 01 FD BF         ld bc, #bffd
  60++8E2C D2 35 8E         jp nc, transmitOne
  61++8E2F              ; Transmit Zero:
  62++8E2F E6 F7            and #f7
  63++8E31 ED 79            out (c), a
  64++8E33 18 06            jr transmitNext
  65++8E35              transmitOne:
  66++8E35 F6 08            or 8
  67++8E37 ED 79            out (c), a
  68++8E39 18 00            jr transmitNext
  69++8E3B
  70++8E3B              transmitNext:
  71++8E3B 2B               dec hl
  72++8E3C 7C               ld a, h
  73++8E3D B5               or l
  74++8E3E 20 FB            jr nz, transmitNext
  75++8E40
  76++8E40 00               nop
  77++8E41 00               nop
  78++8E42 00               nop
  79++8E43
  80++8E43 F1               pop af
  81++8E44 C1               pop bc
  82++8E45 B7               or a
  83++8E46 1F               rra
  84++8E47 10 DA            djnz transmitBit
  85++8E49 D9               exx
  86++8E4A FB               ei
  87++8E4B C1 D1 E1         pop bc, de, hl
  88++8E4E C9               ret
  89++8E4F
  90++8E4F              read:
  91++8E4F C5 D5 E5         push bc, de, hl
  92++8E52 CD 5B 8E         call uartRead
  93++8E55 E1 D1 C1         pop hl, de, bc
  94++8E58 D8               ret c
  95++8E59 18 F4            jr read
  96++8E5B
  97++8E5B              uartRead:
  98++8E5B 21 46 8F         ld hl, _isSecondByteAvail
  99++8E5E 7E               ld a, (hl)
 100++8E5F A7               and a
 101++8E60 28 06            jr z, startReadByte
 102++8E62 36 00            ld (hl), 0
 103++8E64 23               inc hl
 104++8E65 7E               ld a, (hl)
 105++8E66 37               scf
 106++8E67 C9               ret
 107++8E68              startReadByte:
 108++8E68 F3               di
 109++8E69 AF               xor a
 110++8E6A D9               exx
 111++8E6B ED 5B 44 8F      ld de, (_baud)
 112++8E6F 2A 44 8F         ld hl, (_baud)
 113++8E72 CB 3C            srl h
 114++8E74 CB 1D            rr l  ; HL=_baud/2
 115++8E76 B7               or a
 116++8E77 06 FA            ld b, #FA ; Wait look length
 117++8E79 D9               exx
 118++8E7A 0E FD            ld c, #fd
 119++8E7C 16 FF            ld d, #ff
 120++8E7E 1E BF            ld e, #bf
 121++8E80 42               ld b, d
 122++8E81 3E 0E            ld a, #0e
 123++8E83 ED 79            out (c), a
 124++8E85 ED 78            in a, (c)
 125++8E87 F6 F0            or #f0      ; Input lines is 1
 126++8E89 E6 FB            and #fb     ; CTS force to 0
 127++8E8B 43               ld b, e     ; B = #BF
 128++8E8C ED 79            out (c), a  ; Make CTS high
 129++8E8E 67               ld h, a
 130++8E8F
 131++8E8F              waitStartBit:
 132++8E8F 42               ld b, d
 133++8E90 ED 78            in a, (c)
 134++8E92 E6 80            and #80
 135++8E94 28 09            jr z, startBitFound
 136++8E96              readTimeOut:
 137++8E96 D9               exx
 138++8E97 05               dec b
 139++8E98 D9               exx
 140++8E99 20 F4            jr nz, waitStartBit
 141++8E9B AF               xor a
 142++8E9C F5               push af
 143++8E9D 18 39            jr readFinish
 144++8E9F              startBitFound:
 145++8E9F ED 78            in a, (c)
 146++8EA1 E6 80            and #80
 147++8EA3 20 F1            jr nz, readTimeOut
 148++8EA5
 149++8EA5 ED 78            in a, (c)
 150++8EA7 E6 80            and #80
 151++8EA9 20 EB            jr nz, readTimeOut
 152++8EAB                  ;; Start bit found!
 153++8EAB
 154++8EAB D9               exx
 155++8EAC 01 FD FF         ld bc, #fffd
 156++8EAF 3E 80            ld a, #80
 157++8EB1 08               ex af, af
 158++8EB2              readTune:
 159++8EB2 19               add hl, de ; HL = 1.5 * _baud
 160++8EB3 00               nop
 161++8EB4 00               nop
 162++8EB5 00               nop
 163++8EB6 00               nop ; Fine tuning delay
 164++8EB7
 165++8EB7              bdDelay:
 166++8EB7 2B               dec hl
 167++8EB8 7C               ld a, h
 168++8EB9 B5               or l
 169++8EBA 20 FB            jr nz, bdDelay
 170++8EBC
 171++8EBC ED 78            in a, (c)
 172++8EBE E6 80            and #80
 173++8EC0 CA CC 8E         jp z, zeroReceived
 174++8EC3              ; One received:
 175++8EC3 08               ex af, af
 176++8EC4 37               scf
 177++8EC5 1F               rra
 178++8EC6 38 0D            jr c, receivedByte
 179++8EC8 08               ex af, af
 180++8EC9 C3 B2 8E         jp readTune
 181++8ECC              zeroReceived:
 182++8ECC 08               ex af, af
 183++8ECD B7               or a
 184++8ECE 1F               RRA
 185++8ECF 38 04            jr c, receivedByte
 186++8ED1 08               ex af, af
 187++8ED2 C3 B2 8E         jp readTune
 188++8ED5              receivedByte:
 189++8ED5 37               scf
 190++8ED6 F5               push af
 191++8ED7 D9               exx
 192++8ED8              readFinish:
 193++8ED8 7C               ld a, h
 194++8ED9 F6 04            or #04
 195++8EDB 43               ld b, e
 196++8EDC ED 79            out (c), a
 197++8EDE
 198++8EDE D9               exx
 199++8EDF 62               ld h, d
 200++8EE0 6B               ld l, e
 201++8EE1
 202++8EE1 01 07 00         ld bc, #0007
 203++8EE4 B7               or a
 204++8EE5 ED 42            sbc hl, bc
 205++8EE7
 206++8EE7              delayForStopBit:
 207++8EE7 2B               dec hl
 208++8EE8 7C               ld a, h
 209++8EE9 B5               or l
 210++8EEA 20 FB            jr nz, delayForStopBit
 211++8EEC
 212++8EEC 01 FD FF         ld bc, #fffd
 213++8EEF 19               add hl, de
 214++8EF0 19               add hl, de
 215++8EF1 19               add hl, de
 216++8EF2
 217++8EF2              waitStartBitSecondByte:
 218++8EF2 ED 78            in a, (c)
 219++8EF4 E6 80            and #80
 220++8EF6 28 08            jr z, secondStartBitFound
 221++8EF8 2B               dec hl
 222++8EF9 7C               ld a, h
 223++8EFA B5               or l
 224++8EFB 20 F5            jr nz, waitStartBitSecondByte
 225++8EFD                  ; No second byte
 226++8EFD F1               pop af
 227++8EFE FB               ei
 228++8EFF C9               ret
 229++8F00
 230++8F00              secondStartBitFound:
 231++8F00 ED 78            in a, (c)
 232++8F02 E6 80            and #80
 233++8F04 20 EC            jr nz, waitStartBitSecondByte
 234++8F06 62               ld h, d
 235++8F07 6B               ld l, e
 236++8F08 01 02 00         ld bc, #0002
 237++8F0B CB 3C            srl h
 238++8F0D CB 1D            rr l
 239++8F0F B7               or a
 240++8F10 ED 42            sbc hl, bc
 241++8F12 01 FD FF         ld bc, #fffd
 242++8F15 3E 80            ld a, #80
 243++8F17 08               ex af, af
 244++8F18              secondByteTune:
 245++8F18 00               nop
 246++8F19 00               nop
 247++8F1A 00               nop
 248++8F1B 00               nop
 249++8F1C 19               add hl, de
 250++8F1D
 251++8F1D              secondDelay:
 252++8F1D 2B               dec hl
 253++8F1E 7C               ld a, h
 254++8F1F B5               or l
 255++8F20 20 FB            jr nz, secondDelay
 256++8F22
 257++8F22 ED 78            in a, (c)
 258++8F24 E6 80            and #80
 259++8F26 28 09            jr z, secondZeroReceived
 260++8F28              ; Second 1 received
 261++8F28 08               ex af, af
 262++8F29 37               scf
 263++8F2A 1F               rra
 264++8F2B 38 0D            jr c, secondByteFinished
 265++8F2D 08               ex af, af
 266++8F2E C3 18 8F         jp secondByteTune
 267++8F31
 268++8F31              secondZeroReceived:
 269++8F31 08               ex af, af
 270++8F32 B7               or a
 271++8F33 1F               rra
 272++8F34 38 04            jr c, secondByteFinished
 273++8F36 08               ex af, af
 274++8F37 C3 18 8F         jp secondByteTune
 275++8F3A              secondByteFinished:
 276++8F3A 21 46 8F         ld hl, _isSecondByteAvail
 277++8F3D 36 01            ld (hl), 1
 278++8F3F 23               inc hl
 279++8F40 77               ld (hl), a
 280++8F41 F1               pop af
 281++8F42 FB               ei
 282++8F43 C9               ret
 283++8F44
 284++8F44
 285++8F44 0B 00        _baud dw 11 ; 54 - 2400 --- 25 - 4800 --- 11 - 9600
 286++8F46 00 00        _isSecondByteAvail dw #0
 287++8F48 00 00        _testByte dw #0
 288++8F4A
 289++8F4A                  endmodule
# file closed: drivers/uart-ay.asm
  15++8F4A                  ENDIF
  16++8F4A
  17++8F4A                  IFDEF ZW
  18++8F4A ~                	include "uart-zxwifi.asm"
  19++8F4A                  ENDIF
  20++8F4A
  21++8F4A              	include "utils.asm"
# file opened: drivers/utils.asm
   1++8F4A              ;;; Macroses!!!!
   2++8F4A                  MACRO EspSend Text
   3++8F4A ~                ld hl, .txtB
   4++8F4A ~                ld e, (.txtE - .txtB)
   5++8F4A ~                call espSend
   6++8F4A ~                jr .txtE
   7++8F4A ~            .txtB
   8++8F4A ~                db Text
   9++8F4A ~            .txtE
  10++8F4A                  ENDM
  11++8F4A
  12++8F4A                  MACRO EspCmd Text
  13++8F4A ~                ld hl, .txtB
  14++8F4A ~                ld e, (.txtE - .txtB)
  15++8F4A ~                call espSend
  16++8F4A ~                jr .txtE
  17++8F4A ~            .txtB
  18++8F4A ~                db Text
  19++8F4A ~                db 13, 10
  20++8F4A ~            .txtE
  21++8F4A                  ENDM
  22++8F4A
  23++8F4A                  MACRO EspCmdOkErr text
  24++8F4A ~                EspCmd text
  25++8F4A ~                call checkOkErr
  26++8F4A                  ENDM
  27++8F4A
  28++8F4A              ; IN DE - string pointer
  29++8F4A              ; OUT HL - string len
  30++8F4A              strLen:
  31++8F4A 21 00 00         ld hl, 0
  32++8F4D              .loop
  33++8F4D 1A               ld a, (de)
  33++8F4E A7             and a
  33++8F4F C8             ret z
  34++8F50 13 23            inc de, hl
  35++8F52 18 F9            jr .loop
# file closed: drivers/utils.asm
  22++8F54
  23++8F54              	IFDEF UARTATM
  24++8F54 ~            		include "uart-atm.asm"
  25++8F54              	ENDIF
  26++8F54
  27++8F54              	IFDEF UARTEVO
  28++8F54 ~            		include "uart-evo.asm"
  29++8F54                  ENDIF
  30++8F54
  31++8F54              	IFDEF NEDONET
  32++8F54 ~            		include "nedowifi.asm"
  33++8F54              	ELSE
  34++8F54              	IFNDEF MSX
  35++8F54              		include "wifi.asm"
# file opened: drivers/wifi.asm
   1++8F54                  MODULE Wifi
   2++8F54 00 00        bytes_avail dw 0
   3++8F56 00 00        buffer_pointer dw 0
   4++8F58 01           closed db 1
   5++8F59              ; Initialize Wifi chip to work
   6++8F59              init:
   7++8F59
   8++8F59 21 4B 90         ld hl, .uartIniting
   8++8F5C CD BC 60       call TextMode.printZ
   9++8F5F CD E0 8D         call Uart.init
  10++8F62 21 5C 90         ld hl, .chipIniting
  10++8F65 CD BC 60       call TextMode.printZ
  11++8F68
  12++8F68                  EspCmdOkErr "ATE0"
  12++8F68             >    EspCmd "ATE0"
  12++8F68 21 72 8F    >    ld hl, .txtB
  12++8F6B 1E 06       >    ld e, (.txtE - .txtB)
  12++8F6D CD 61 91    >    call espSend
  12++8F70 18 06       >    jr .txtE
  12++8F72             >.txtB
  12++8F72 41 54 45 30 >    db "ATE0"
  12++8F76 0D 0A       >    db 13, 10
  12++8F78             >.txtE
  12++8F78 CD EC 90    >    call checkOkErr
  13++8F7B DA 2B 90         jp c, .initError
  14++8F7E
  15++8F7E              ; Reading auth.pwd and send it to ESP
  16++8F7E 21 BC A1 06      ld hl, creds, b, Dos.FMODE_READ
  16++8F82 01
  16++8F83 CD B7 6C       call Dos.fopen
  17++8F86 F5               push af
  18++8F87 21 CD A1 01      ld hl,outputBuffer2, bc, 255
  18++8F8B FF 00
  18++8F8D CD 0E 6F       call Dos.fread
  19++8F90 F1               pop af
  20++8F91 CD 02 6E         call Dos.fclose
  21++8F94
  22++8F94 21 74 90         ld hl, .doneInit1
  22++8F97 CD BC 60       call TextMode.printZ
  23++8F9A
  24++8F9A 21 CD A1         ld hl,outputBuffer2
  25++8F9D CD 6B 91         call espSendT
  26++8FA0 3E 0D            ld a, 13
  26++8FA2 CD 04 8E       call Uart.write
  27++8FA5 3E 0A            ld a, 10
  27++8FA7 CD 04 8E       call Uart.write
  28++8FAA CD EC 90         call checkOkErr
  29++8FAD DA 2B 90         jp c, .initError
  30++8FB0              ;
  31++8FB0                 	EspCmdOkErr "AT+CIPSERVER=0"
  31++8FB0             >    EspCmd "AT+CIPSERVER=0"
  31++8FB0 21 BA 8F    >    ld hl, .txtB
  31++8FB3 1E 10       >    ld e, (.txtE - .txtB)
  31++8FB5 CD 61 91    >    call espSend
  31++8FB8 18 10       >    jr .txtE
  31++8FBA             >.txtB
  31++8FBA 41 54 2B 43 >    db "AT+CIPSERVER=0"
  31++8FBE 49 50 53 45 >
  31++8FC2 52 56 45 52 >
  31++8FC6 3D 30       >
  31++8FC8 0D 0A       >    db 13, 10
  31++8FCA             >.txtE
  31++8FCA CD EC 90    >    call checkOkErr
  32++8FCD                  EspCmdOkErr "AT+CIPCLOSE" ; Close if there some connection was. Don't care about result
  32++8FCD             >    EspCmd "AT+CIPCLOSE"
  32++8FCD 21 D7 8F    >    ld hl, .txtB
  32++8FD0 1E 0D       >    ld e, (.txtE - .txtB)
  32++8FD2 CD 61 91    >    call espSend
  32++8FD5 18 0D       >    jr .txtE
  32++8FD7             >.txtB
  32++8FD7 41 54 2B 43 >    db "AT+CIPCLOSE"
  32++8FDB 49 50 43 4C >
  32++8FDF 4F 53 45    >
  32++8FE2 0D 0A       >    db 13, 10
  32++8FE4             >.txtE
  32++8FE4 CD EC 90    >    call checkOkErr
  33++8FE7                  EspCmdOkErr "AT+CIPMUX=0" ; Single connection mode
  33++8FE7             >    EspCmd "AT+CIPMUX=0"
  33++8FE7 21 F1 8F    >    ld hl, .txtB
  33++8FEA 1E 0D       >    ld e, (.txtE - .txtB)
  33++8FEC CD 61 91    >    call espSend
  33++8FEF 18 0D       >    jr .txtE
  33++8FF1             >.txtB
  33++8FF1 41 54 2B 43 >    db "AT+CIPMUX=0"
  33++8FF5 49 50 4D 55 >
  33++8FF9 58 3D 30    >
  33++8FFC 0D 0A       >    db 13, 10
  33++8FFE             >.txtE
  33++8FFE CD EC 90    >    call checkOkErr
  34++9001 DA 2B 90         jp c, .initError
  35++9004
  36++9004                  EspCmdOkErr "AT+CIPDINFO=0" ; Disable additional info
  36++9004             >    EspCmd "AT+CIPDINFO=0"
  36++9004 21 0E 90    >    ld hl, .txtB
  36++9007 1E 0F       >    ld e, (.txtE - .txtB)
  36++9009 CD 61 91    >    call espSend
  36++900C 18 0F       >    jr .txtE
  36++900E             >.txtB
  36++900E 41 54 2B 43 >    db "AT+CIPDINFO=0"
  36++9012 49 50 44 49 >
  36++9016 4E 46 4F 3D >
  36++901A 30          >
  36++901B 0D 0A       >    db 13, 10
  36++901D             >.txtE
  36++901D CD EC 90    >    call checkOkErr
  37++9020 DA 2B 90         jp c, .initError
  38++9023
  39++9023 21 6D 90         ld hl, .doneInit
  39++9026 CD BC 60       call TextMode.printZ
  40++9029
  41++9029 B7               or a
  42++902A C9               ret
  43++902B              .initError
  44++902B 21 33 90         ld hl, .errMsg
  44++902E CD 0A 6A       call DialogBox.msgBox
  45++9031 37               scf
  46++9032 C9               ret
  47++9033 57 69 46 69  .errMsg      db "WiFi chip init failed!", "\r", 0
  47++9037 20 63 68 69
  47++903B 70 20 69 6E
  47++903F 69 74 20 66
  47++9043 61 69 6C 65
  47++9047 64 21 0D 00
  48++904B 55 61 72 74  .uartIniting db "Uart initing...", "\r", 0
  48++904F 20 69 6E 69
  48++9053 74 69 6E 67
  48++9057 2E 2E 2E 0D
  48++905B 00
  49++905C 43 68 69 70  .chipIniting db "Chip initing...", "\r", 0
  49++9060 20 69 6E 69
  49++9064 74 69 6E 67
  49++9068 2E 2E 2E 0D
  49++906C 00
  50++906D 44 6F 6E 65  .doneInit    db "Done!","\r", 0
  50++9071 21 0D 00
  51++9074 53 65 6E 64  .doneInit1   db "Sending auth.pwd to ESP","\r", 0
  51++9078 69 6E 67 20
  51++907C 61 75 74 68
  51++9080 2E 70 77 64
  51++9084 20 74 6F 20
  51++9088 45 53 50 0D
  51++908C 00
  52++908D                  IFNDEF PROXY
  53++908D              ; HL - host pointer in gopher row
  54++908D              ; DE - port pointer in gopher row
  55++908D              openTCP:
  56++908D D5               push de
  57++908E E5               push hl
  58++908F                  EspCmdOkErr "AT+CIPCLOSE" ; Don't care about result. Just close if it didn't happens before
  58++908F             >    EspCmd "AT+CIPCLOSE"
  58++908F 21 99 90    >    ld hl, .txtB
  58++9092 1E 0D       >    ld e, (.txtE - .txtB)
  58++9094 CD 61 91    >    call espSend
  58++9097 18 0D       >    jr .txtE
  58++9099             >.txtB
  58++9099 41 54 2B 43 >    db "AT+CIPCLOSE"
  58++909D 49 50 43 4C >
  58++90A1 4F 53 45    >
  58++90A4 0D 0A       >    db 13, 10
  58++90A6             >.txtE
  58++90A6 CD EC 90    >    call checkOkErr
  59++90A9                  EspSend 'AT+CIPSTART="TCP","'
  59++90A9 21 B3 90    >    ld hl, .txtB
  59++90AC 1E 13       >    ld e, (.txtE - .txtB)
  59++90AE CD 61 91    >    call espSend
  59++90B1 18 13       >    jr .txtE
  59++90B3             >.txtB
  59++90B3 41 54 2B 43 >    db 'AT+CIPSTART="TCP","'
  59++90B7 49 50 53 54 >
  59++90BB 41 52 54 3D >
  59++90BF 22 54 43 50 >
  59++90C3 22 2C 22    >
  59++90C6             >.txtE
  60++90C6 E1               pop hl
  61++90C7 CD 6B 91         call espSendT
  62++90CA                  EspSend '",'
  62++90CA 21 D4 90    >    ld hl, .txtB
  62++90CD 1E 02       >    ld e, (.txtE - .txtB)
  62++90CF CD 61 91    >    call espSend
  62++90D2 18 02       >    jr .txtE
  62++90D4             >.txtB
  62++90D4 22 2C       >    db '",'
  62++90D6             >.txtE
  63++90D6 E1               pop hl
  64++90D7 CD 6B 91         call espSendT
  65++90DA 3E 0D            ld a, 13
  65++90DC CD 04 8E       call Uart.write
  66++90DF 3E 0A            ld a, 10
  66++90E1 CD 04 8E       call Uart.write
  67++90E4 AF               xor a
  67++90E5 32 58 8F       ld (closed), a
  68++90E8 C3 EC 90         jp checkOkErr
  69++90EB
  70++90EB              continue:
  71++90EB C9               ret
  72++90EC                  ENDIF
  73++90EC
  74++90EC
  75++90EC
  76++90EC              checkOkErr:
  77++90EC CD 4F 8E         call Uart.read
  78++90EF FE 4F            cp 'O'
  78++90F1 CA 01 91       jp z, .okStart ; OK
  79++90F4 FE 45            cp 'E'
  79++90F6 CA 16 91       jp z, .errStart ; ERROR
  80++90F9 FE 46            cp 'F'
  80++90FB CA 3B 91       jp z, .failStart ; FAIL
  81++90FE C3 EC 90         jp checkOkErr
  82++9101              .okStart
  83++9101 CD 4F 8E         call Uart.read
  83++9104 FE 4B          cp 'K'
  83++9106 C2 EC 90       jp nz, checkOkErr
  84++9109 CD 4F 8E         call Uart.read
  84++910C FE 0D          cp 13
  84++910E C2 EC 90       jp nz, checkOkErr
  85++9111 CD 58 91         call .flushToLF
  86++9114 B7               or a
  87++9115 C9               ret
  88++9116              .errStart
  89++9116 CD 4F 8E         call Uart.read
  89++9119 FE 52          cp 'R'
  89++911B C2 EC 90       jp nz, checkOkErr
  90++911E CD 4F 8E         call Uart.read
  90++9121 FE 52          cp 'R'
  90++9123 C2 EC 90       jp nz, checkOkErr
  91++9126 CD 4F 8E         call Uart.read
  91++9129 FE 4F          cp 'O'
  91++912B C2 EC 90       jp nz, checkOkErr
  92++912E CD 4F 8E         call Uart.read
  92++9131 FE 52          cp 'R'
  92++9133 C2 EC 90       jp nz, checkOkErr
  93++9136 CD 58 91         call .flushToLF
  94++9139 37               scf
  95++913A C9               ret
  96++913B              .failStart
  97++913B CD 4F 8E         call Uart.read
  97++913E FE 41          cp 'A'
  97++9140 C2 EC 90       jp nz, checkOkErr
  98++9143 CD 4F 8E         call Uart.read
  98++9146 FE 49          cp 'I'
  98++9148 C2 EC 90       jp nz, checkOkErr
  99++914B CD 4F 8E         call Uart.read
  99++914E FE 4C          cp 'L'
  99++9150 C2 EC 90       jp nz, checkOkErr
 100++9153 CD 58 91         call .flushToLF
 101++9156 37               scf
 102++9157 C9               ret
 103++9158              .flushToLF
 104++9158 CD 4F 8E         call Uart.read
 105++915B FE 0A            cp 10
 105++915D C2 58 91       jp nz, .flushToLF
 106++9160 C9               ret
 107++9161
 108++9161              ; Send buffer to UART
 109++9161              ; HL - buff
 110++9161              ; E - count
 111++9161              espSend:
 112++9161 7E               ld a, (hl)
 112++9162 CD 04 8E       call Uart.write
 113++9165 23               inc hl
 114++9166 1D               dec e
 115++9167 C2 61 91         jp nz, espSend
 116++916A C9               ret
 117++916B
 118++916B              ; HL - string that ends with one of the terminator(CR/LF/TAB/NULL)
 119++916B              espSendT:
 120++916B 7E               ld a, (hl)
 121++916C
 122++916C A7               and a
 122++916D C8             ret z
 123++916E FE 09            cp 9
 123++9170 C8             ret z
 124++9171 FE 0D            cp 13
 124++9173 C8             ret z
 125++9174 FE 0A            cp 10
 125++9176 C8             ret z
 126++9177
 127++9177 CD 04 8E         call Uart.write
 128++917A 23               inc hl
 129++917B C3 6B 91         jp espSendT
 130++917E
 131++917E              ; HL - stringZ to send
 132++917E              ; Adds CR LF
 133++917E              tcpSendZ:
 134++917E E5               push hl
 135++917F                  EspSend "AT+CIPSEND="
 135++917F 21 89 91    >    ld hl, .txtB
 135++9182 1E 0B       >    ld e, (.txtE - .txtB)
 135++9184 CD 61 91    >    call espSend
 135++9187 18 0B       >    jr .txtE
 135++9189             >.txtB
 135++9189 41 54 2B 43 >    db "AT+CIPSEND="
 135++918D 49 50 53 45 >
 135++9191 4E 44 3D    >
 135++9194             >.txtE
 136++9194 D1               pop de
 136++9195 D5             push de
 137++9196 CD 4A 8F         call strLen
 138++9199 23               inc hl
 138++919A 23             inc hl ; +CRLF
 139++919B CD 95 92         call hlToNumEsp
 140++919E 3E 0D            ld a, 13
 140++91A0 CD 04 8E       call Uart.write
 141++91A3 3E 0A            ld a, 10
 141++91A5 CD 04 8E       call Uart.write
 142++91A8 CD EC 90         call checkOkErr
 142++91AB D8             ret c
 143++91AC              .wait
 144++91AC CD 4F 8E         call Uart.read
 144++91AF FE 3E          cp '>'
 144++91B1 C2 AC 91       jp nz, .wait
 145++91B4 E1               pop hl
 146++91B5              .loop
 147++91B5 7E               ld a, (hl)
 147++91B6 A7             and a
 147++91B7 CA C1 91       jp z, .exit
 148++91BA CD 04 8E         call Uart.write
 149++91BD 23               inc hl
 150++91BE C3 B5 91         jp .loop
 151++91C1              .exit
 152++91C1 3E 0D            ld a, 13
 152++91C3 CD 04 8E       call Uart.write
 153++91C6 3E 0A            ld a, 10
 153++91C8 CD 04 8E       call Uart.write
 154++91CB C3 EC 90         jp checkOkErr
 155++91CE
 156++91CE              getPacket:
 157++91CE CD 4F 8E         call Uart.read
 158++91D1 FE 2B            cp '+'
 158++91D3 CA 04 92       jp z, .ipdBegun    ; "+IPD," packet
 159++91D6 FE 4F            cp 'O'
 159++91D8 CA DE 91       jp z, .closedBegun ; It enough to check "OSED\n" :-)
 160++91DB C3 CE 91         jp getPacket
 161++91DE              .closedBegun
 162++91DE CD 4F 8E         call Uart.read
 162++91E1 FE 53          cp 'S'
 162++91E3 C2 DE 91       jp nz, .closedBegun
 163++91E6 CD 4F 8E         call Uart.read
 163++91E9 FE 45          cp 'E'
 163++91EB C2 DE 91       jp nz, .closedBegun
 164++91EE CD 4F 8E         call Uart.read
 164++91F1 FE 44          cp 'D'
 164++91F3 C2 DE 91       jp nz, .closedBegun
 165++91F6 CD 4F 8E         call Uart.read
 165++91F9 FE 0D          cp 13
 165++91FB C2 DE 91       jp nz, .closedBegun
 166++91FE 3E 01 32 58      ld a, 1, (closed), a
 166++9202 8F
 167++9203 C9               ret
 168++9204              .ipdBegun
 169++9204 CD 4F 8E         call Uart.read
 169++9207 FE 49          cp 'I'
 169++9209 C2 04 92       jp nz, .ipdBegun
 170++920C CD 4F 8E         call Uart.read
 170++920F FE 50          cp 'P'
 170++9211 C2 04 92       jp nz, .ipdBegun
 171++9214 CD 4F 8E         call Uart.read
 171++9217 FE 44          cp 'D'
 171++9219 C2 04 92       jp nz, .ipdBegun
 172++921C CD 4F 8E         call Uart.read  ;Comma
 173++921F CD 7B 92         call .count_ipd_lenght
 173++9222 22 54 8F       ld (bytes_avail), hl
 174++9225 54 5D            ld de, hl
 175++9227 2A 56 8F         ld hl, (buffer_pointer)
 176++922A              .readp
 177++922A 7C               ld a, h
 177++922B FE FF          cp #ff
 177++922D D2 3F 92       jp nc, .skipbuff
 178++9230 CD 4F 8E         call Uart.read
 179++9233 77               ld (hl), a
 180++9234 1B               dec de
 181++9235 23               inc hl
 182++9236 7A               ld a, d
 182++9237 B3             or e
 182++9238 C2 2A 92       jp nz, .readp
 183++923B 22 56 8F         ld (buffer_pointer), hl
 184++923E C9               ret
 185++923F              .skipbuff
 186++923F CD 4F 8E         call Uart.read
 187++9242 1B               dec de
 187++9243 7A             ld a, d
 187++9244 B3             or e
 187++9245 C2 3F 92       jp nz, .skipbuff
 188++9248 3E 01            ld a,1
 189++924A 32 58 8F     	ld (closed),a
 190++924D AF           	xor a
 191++924E 32 54 8F     	ld (bytes_avail),a
 192++9251 21 58 92         ld hl, .errMem
 192++9254 CD 0A 6A       call DialogBox.msgBox
 193++9257 C9               ret
 194++9258              .errMem:
 195++9258 4F 75 74 20  	db "Out of memory. Page loading error.",0
 195++925C 6F 66 20 6D
 195++9260 65 6D 6F 72
 195++9264 79 2E 20 50
 195++9268 61 67 65 20
 195++926C 6C 6F 61 64
 195++9270 69 6E 67 20
 195++9274 65 72 72 6F
 195++9278 72 2E 00
 196++927B              .count_ipd_lenght
 197++927B 21 00 00     		ld hl,0			; count lenght
 198++927E E5           .cil1	push  hl
 199++927F CD 4F 8E             call Uart.read
 200++9282 E1                   pop hl
 201++9283 FE 3A        		cp ':'
 202++9285 C8                   ret z
 203++9286 D6 30        		sub 0x30
 204++9288 4D                   ld c,l
 205++9289 44                   ld b,h
 206++928A 29                   add hl,hl
 207++928B 29                   add hl,hl
 208++928C 09                   add hl,bc
 209++928D 29                   add hl,hl
 210++928E 4F                   ld c,a
 211++928F 06 00                ld b,0
 212++9291 09                   add hl,bc
 213++9292 C3 7E 92     		jp .cil1
 214++9295
 215++9295              ; Based on: https://wikiti.brandonw.net/index.php?title=Z80_Routines:Other:DispHL
 216++9295              ; HL - number
 217++9295              ; It will be written to UART
 218++9295              hlToNumEsp:
 219++9295 01 F0 D8     	ld	bc,-10000
 220++9298 CD AE 92     	call	.n1
 221++929B 01 18 FC     	ld	bc,-1000
 222++929E CD AE 92     	call	.n1
 223++92A1 01 9C FF     	ld	bc,-100
 224++92A4 CD AE 92     	call	.n1
 225++92A7 0E F6        	ld	c,-10
 226++92A9 CD AE 92     	call	.n1
 227++92AC 0E FF        	ld	c,-1
 228++92AE 3E 2F        .n1	ld	a,'0'-1
 229++92B0 3C           .n2	inc	a
 230++92B1 09           	add	hl,bc
 231++92B2 DA B0 92     	jp	c, .n2
 232++92B5 ED 42        	sbc	hl,bc
 233++92B7 C5               push bc
 234++92B8 CD 04 8E     	call Uart.write
 235++92BB C1               pop bc
 236++92BC C9               ret
 237++92BD              flushToLF1
 238++92BD CD 4F 8E         call Uart.read
 239++92C0 FE 0A            cp 10
 239++92C2 C2 BD 92       jp nz, flushToLF1
 240++92C5 C9               ret
 241++92C6                  ENDMODULE
# file closed: drivers/wifi.asm
  36++92C6              	ENDIF
  37++92C6              	ENDIF
  38++92C6
  39++92C6                  IFDEF NEDOOS
  40++92C6 ~                	include "rtc-nos.asm"
  41++92C6                  ENDIF
  42++92C6
  43++92C6
  44++92C6                  IFDEF SMUCRTC
  45++92C6                  	include "rtc-smuc.asm"
# file opened: drivers/rtc-smuc.asm
   1++92C6              ;clock driver SMUC
   2++92C6              	module Clock
   3++92C6              ; вых.:	CY=1, если микросхемы CMOS нет
   4++92C6              	; C — секунды/число;
   5++92C6              	; B - минуты/месяц;
   6++92C6              	; E - часы/год;
   7++92C6
   8++92C6              readTime
   9++92C6 01 BA DF     	ld bc,#DFBA
  10++92C9 3E 04        	ld a,4 ;часы
  11++92CB CD 01 93     	call out3d2f
  12++92CE 3E 0A        	ld a,10 ;пауза
  13++92D0              readTimeCL
  14++92D0 3D           	dec a
  15++92D1 20 FD        	jr nz,readTimeCL
  16++92D3 CD FA 92     	call in3d2f
  17++92D6 FE FF        	cp 255 ;проверка наличия микросхемы
  18++92D8 37           	scf
  19++92D9 C8           	ret z
  20++92DA 5F           	ld e,a
  21++92DB 3E 02        	ld a,2 ;минуты
  22++92DD CD 01 93     	call out3d2f
  23++92E0 3E 0A        	ld a,10 ;пауза
  24++92E2              readTimeCL2
  25++92E2 3D           	dec a
  26++92E3 20 FD        	jr nz,readTimeCL2
  27++92E5 CD FA 92     	call in3d2f
  28++92E8 47           	ld b,a
  29++92E9 B7           	or a
  30++92EA              ;сохранение текущего времени
  31++92EA 30 01        	jr nc,read_time_ok
  32++92EC              	; ld hl,mes_no_RTC
  33++92EC              	; call print_mes
  34++92EC              	; scf
  35++92EC C9           	ret ;выход
  36++92ED              read_time_ok
  37++92ED 7B           	ld a,e ;часы
  38++92EE 32 1A 94     	ld (hours),a
  39++92F1 78           	ld a,b ;минуты
  40++92F2 32 1B 94     	ld (minutes),a
  41++92F5 79           	ld a,c ;секунды
  42++92F6 32 1C 94     	ld (seconds),a
  43++92F9 C9           	ret
  44++92FA
  45++92FA              in3d2f
  46++92FA 21 F3 3F     	ld hl,#3ff3
  47++92FD E5           	push hl
  48++92FE C3 2F 3D     	jp #3d2f
  49++9301
  50++9301              out3d2f
  51++9301 21 53 2A     	ld hl,#2A53
  52++9304 E5           	push hl
  53++9305 C3 2F 3D     	jp #3d2f
  54++9308                  endmodule
  55++9308
# file closed: drivers/rtc-smuc.asm
  46++9308                  ENDIF
  47++9308
  48++9308              	IFDEF MSX
  49++9308 ~                    include "drivers/unapi/unapi.asm"
  50++9308 ~                	include "drivers/unapi/tcp.asm"
  51++9308 ~            		include "rtc-msx.asm"
  52++9308                  ELSE
  53++9308              		include "proxy.asm"
# file opened: drivers/proxy.asm
   1++9308                  IFDEF PROXY
   2++9308 ~                MODULE Wifi
   3++9308 ~            ; Same singature as wifi.openTCP
   4++9308 ~            ; HL - host pointer in gopher row
   5++9308 ~            ; DE - port pointer in gopher row
   6++9308 ~            openTCP:
   7++9308 ~                push de
   8++9308 ~                push hl
   9++9308 ~
  10++9308 ~                xor a
  10++9308 ~              ld hl, hostBuff, de, hostBuff + 1, bc, 102, (hl), a
  10++9308 ~              ldir
  11++9308 ~
  12++9308 ~                EspCmdOkErr "AT+CIPCLOSE"
  13++9308 ~                EspCmdOkErr 'AT+CIPSTART="TCP","138.68.76.243",6912' // Replace here for yourown proxy. If you wish
  14++9308 ~                jr c, .error
  15++9308 ~                pop hl
  15++9308 ~              ld de, hostBuff
  16++9308 ~            .copyHost
  17++9308 ~                ld a, (hl)
  17++9308 ~              and a
  17++9308 ~              jr z, 1F
  17++9308 ~              and a
  17++9308 ~              jr z, 1F
  18++9308 ~                ld (de), a
  18++9308 ~              inc hl, de
  19++9308 ~                jr .copyHost
  20++9308 ~            1   xor a
  20++9308 ~              ld (de), a
  21++9308 ~                pop hl
  21++9308 ~              ld de, portBuff
  22++9308 ~            .copyPort
  23++9308 ~                ld a, (hl)
  23++9308 ~              and a
  23++9308 ~              jr z, 1F
  23++9308 ~              and a
  23++9308 ~              jr z, 1F
  24++9308 ~                ld (de), a
  24++9308 ~              inc hl, de
  25++9308 ~                jr .copyPort
  26++9308 ~            1   ld hl, hostBuff
  26++9308 ~              call tcpSendZ
  27++9308 ~                ld hl, portBuff
  27++9308 ~              call tcpSendZ
  28++9308 ~                xor a
  28++9308 ~              ld (closed), a
  29++9308 ~                ret
  30++9308 ~            .error
  31++9308 ~                pop hl
  31++9308 ~              pop de
  32++9308 ~                ret
  33++9308 ~
  34++9308 ~            continue:
  35++9308 ~                EspCmdOkErr "AT+CIPSEND=1"
  36++9308 ~                ret c
  37++9308 ~            .wait
  38++9308 ~                call Uart.read
  38++9308 ~              cp '>'
  38++9308 ~              jr nz, .wait
  39++9308 ~                ld a, 'c'
  39++9308 ~              call Uart.write
  40++9308 ~                jp checkOkErr
  41++9308 ~
  42++9308 ~            hostBuff ds 96
  43++9308 ~            portBuff ds 7
  44++9308 ~                ENDMODULE
  45++9308                  ENDIF
# file closed: drivers/proxy.asm
  54++9308              		include "memory.asm"
# file opened: drivers/memory.asm
   1++9308                  module Memory
   2++9308              BANKM = #5b5c
   3++9308              MEM_PORT = #7ffd
   4++9308
   5++9308              init:
   6++9308 F3               di
   7++9309 FD CB 01 A6      res 4, (iy + 1)
   8++930D
   9++930D AF               xor a
   9++930E CD 12 93       call setPage
  10++9311 C9               ret
  11++9312
  12++9312              ; a - page
  13++9312              setPage:
  14++9312 F6 18            or #18
  14++9314 32 5C 5B       ld (BANKM), a
  15++9317 01 FD 7F         ld bc, MEM_PORT
  15++931A ED 79          out (c), a
  16++931C C9               ret
  17++931D
  18++931D                  endmodule
# file closed: drivers/memory.asm
  55++931D              	ENDIF
  56++931D
  57++931D              	IFDEF GS
  58++931D              		include "general-sound.asm"
# file opened: drivers/general-sound.asm
   1++931D                  macro _WaitCommand
   2++931D ~            .wait
   3++931D ~                in a, (GeneralSound.CMD)
   4++931D ~                rrca
   5++931D ~                jr c, .wait
   6++931D                  endm
   7++931D
   8++931D                  macro _WaitData
   9++931D ~            .wait
  10++931D ~                in a, (GeneralSound.CMD)
  11++931D ~                rlca
  12++931D ~                jr c, .wait
  13++931D                  endm
  14++931D
  15++931D                  macro _SendCommand nn
  16++931D ~                ld a, nn
  16++931D ~              out (GeneralSound.CMD), a
  17++931D                  endm
  18++931D
  19++931D                  module GeneralSound
  20++931D              ;; Control ports
  21++931D              CMD  = 187
  22++931D              DATA = 179
  23++931D
  24++931D              ;; Commands
  25++931D              CMD_WARM_RESET      = #F3
  26++931D              CMD_COLD_RESET      = #F4
  27++931D              CMD_LOAD_MODULE     = #30
  28++931D              CMD_PLAY_MODULE     = #31
  29++931D              CMD_STOP_MODULE     = #32
  30++931D              CMD_CONTINUE_MODULE = #33
  31++931D              CMD_OPEN_STREAM     = #D1
  32++931D              CMD_CLOSE_STREAM    = #D2
  33++931D
  34++931D              ; A - 0 warm reset, other - cold
  35++931D              init:
  36++931D A7               and a
  36++931E 20 05          jr nz, .cold
  37++9320                  _SendCommand CMD_WARM_RESET
  37++9320 3E F3       >    ld a, CMD_WARM_RESET
  37++9322 D3 BB       >  out (GeneralSound.CMD), a
  38++9324 C9               ret
  39++9325              .cold
  40++9325                  _SendCommand CMD_COLD_RESET
  40++9325 3E F4       >    ld a, CMD_COLD_RESET
  40++9327 D3 BB       >  out (GeneralSound.CMD), a
  41++9329 C9               ret
  42++932A
  43++932A              ;; Initializes loading module
  44++932A              loadModule:
  45++932A                  _SendCommand CMD_LOAD_MODULE
  45++932A 3E 30       >    ld a, CMD_LOAD_MODULE
  45++932C D3 BB       >  out (GeneralSound.CMD), a
  46++932E                  _WaitCommand
  46++932E             >.wait
  46++932E DB BB       >    in a, (GeneralSound.CMD)
  46++9330 0F          >    rrca
  46++9331 38 FB       >    jr c, .wait
  47++9333                  _SendCommand CMD_OPEN_STREAM
  47++9333 3E D1       >    ld a, CMD_OPEN_STREAM
  47++9335 D3 BB       >  out (GeneralSound.CMD), a
  48++9337                  _WaitCommand
  48++9337             >.wait
  48++9337 DB BB       >    in a, (GeneralSound.CMD)
  48++9339 0F          >    rrca
  48++933A 38 FB       >    jr c, .wait
  49++933C C9               ret
  50++933D
  51++933D              ;; Use it for streaming mod file
  52++933D              sendByte:
  53++933D D3 B3            out (DATA), a
  54++933F                  _WaitData
  54++933F             >.wait
  54++933F DB BB       >    in a, (GeneralSound.CMD)
  54++9341 07          >    rlca
  54++9342 38 FB       >    jr c, .wait
  55++9344 C9               ret
  56++9345
  57++9345              ;; Call it when module was loaded
  58++9345              finishLoadingModule:
  59++9345                  _SendCommand CMD_CLOSE_STREAM
  59++9345 3E D2       >    ld a, CMD_CLOSE_STREAM
  59++9347 D3 BB       >  out (GeneralSound.CMD), a
  60++9349                  _WaitCommand
  60++9349             >.wait
  60++9349 DB BB       >    in a, (GeneralSound.CMD)
  60++934B 0F          >    rrca
  60++934C 38 FB       >    jr c, .wait
  61++934E              rewind:
  62++934E 3E 01            ld a, 1
  62++9350 D3 B3          out (DATA), a
  63++9352                  _SendCommand CMD_PLAY_MODULE
  63++9352 3E 31       >    ld a, CMD_PLAY_MODULE
  63++9354 D3 BB       >  out (GeneralSound.CMD), a
  64++9356                  _WaitCommand
  64++9356             >.wait
  64++9356 DB BB       >    in a, (GeneralSound.CMD)
  64++9358 0F          >    rrca
  64++9359 38 FB       >    jr c, .wait
  65++935B 3E 01 32 7F      ld a, 1, (state),a
  65++935F 93
  66++9360 C9               ret
  67++9361
  68++9361              ;; Works like pause too
  69++9361              stopModule:
  70++9361 AF               xor a
  70++9362 32 7F 93       ld (state), a
  71++9365                  _SendCommand CMD_STOP_MODULE
  71++9365 3E 32       >    ld a, CMD_STOP_MODULE
  71++9367 D3 BB       >  out (GeneralSound.CMD), a
  72++9369 C9               ret
  73++936A
  74++936A              continueModule:
  75++936A 3E 01            ld a, 1
  75++936C 32 7F 93       ld (state), a
  76++936F                  _SendCommand CMD_CONTINUE_MODULE
  76++936F 3E 33       >    ld a, CMD_CONTINUE_MODULE
  76++9371 D3 BB       >  out (GeneralSound.CMD), a
  77++9373 C9               ret
  78++9374
  79++9374              ; Pauses resumes
  80++9374              toggleModule:
  81++9374 CD 43 6A         call Console.waitForKeyUp
  82++9377 3A 7F 93         ld a, (state)
  82++937A A7             and a
  83++937B 28 ED            jr z, continueModule
  84++937D 18 E2            jr stopModule
  85++937F
  86++937F 00           state db 0
  87++9380                  endmodule
# file closed: drivers/general-sound.asm
  59++9380              	ENDIF
# file closed: drivers/index.asm
  25+ 9380                  include "screen/rtc.asm"
# file opened: screen/rtc.asm
   1++9380              printRTC
   2++9380              	IFDEF RTC
   3++9380 CD C6 92     	call Clock.readTime
   4++9383
   5++9383 3A 25 94     	ld a, (oldminutes)
   6++9386 57           	ld d,a
   7++9387 3A 1B 94     	ld a, (minutes)
   8++938A BA           	cp d					; Update only if minutes changed
   9++938B C8           	ret z
  10++938C 32 25 94     	ld (oldminutes), a
  11++938F
  12++938F 16 01        	ld d,1 ;??? Y,X
  13++9391 1E 39        	ld e,64 - 7
  14++9393 CD 3A 60     	call TextMode.gotoXY
  15++9396 3E 5B        	ld a,'['
  16++9398 CD A4 60     	call TextMode.putC
  17++939B 26 00        	ld h,0
  18++939D 3A 1A 94     	ld a,(hours) ;
  19++93A0 6F           	ld l,a
  20++93A1 CD C4 93     	call toDecimal
  21++93A4 21 20 94     	ld hl,decimalS+3
  22++93A7 CD BC 60     	call TextMode.printZ
  23++93AA 3E 3A        	ld a,':'
  24++93AC CD A4 60     	call TextMode.putC
  25++93AF 26 00        	ld h,0
  26++93B1 3A 1B 94     	ld a,(minutes) ;
  27++93B4 6F           	ld l,a
  28++93B5 CD C4 93     	call toDecimal
  29++93B8 21 20 94     	ld hl,decimalS+3
  30++93BB CD BC 60     	call TextMode.printZ
  31++93BE              	;ld a,':'
  32++93BE              	;call TextMode.putC
  33++93BE              	;ld h,0
  34++93BE              	;ld a,(seconds) ;ᥪ㭤
  35++93BE              	;ld l,a
  36++93BE              	;call toDecimal
  37++93BE              	;ld hl,decimalS+3
  38++93BE              	;call TextMode.printZ
  39++93BE 3E 5D        	ld a,']'
  40++93C0 CD A4 60     	call TextMode.putC
  41++93C3 C9           	ret
  42++93C4
  43++93C4              toDecimal		; 2   5  
  44++93C4              				; 室  HL ᫮
  45++93C4 11 10 27     	ld de,10000 ;⪨ 
  46++93C7 3E FF        	ld a,255
  47++93C9              toDecimal10k
  48++93C9 A7           	and a
  49++93CA ED 52        	sbc hl,de
  50++93CC 3C           	inc a
  51++93CD 30 FA        	jr nc,toDecimal10k
  52++93CF 19           	add hl,de
  53++93D0 C6 30        	add a,48
  54++93D2 32 1D 94     	ld (decimalS),a
  55++93D5 11 E8 03     	ld de,1000 ;
  56++93D8 3E FF        	ld a,255
  57++93DA              toDecimal1k
  58++93DA A7           	and a
  59++93DB ED 52        	sbc hl,de
  60++93DD 3C           	inc a
  61++93DE 30 FA        	jr nc,toDecimal1k
  62++93E0 19           	add hl,de
  63++93E1 C6 30        	add a,48
  64++93E3 32 1E 94     	ld (decimalS+1),a
  65++93E6 11 64 00     	ld de,100 ;⭨
  66++93E9 3E FF        	ld a,255
  67++93EB              toDecimal01k
  68++93EB A7           	and a
  69++93EC ED 52        	sbc hl,de
  70++93EE 3C           	inc a
  71++93EF 30 FA        	jr nc,toDecimal01k
  72++93F1 19           	add hl,de
  73++93F2 C6 30        	add a,48
  74++93F4 32 1F 94     	ld (decimalS+2),a
  75++93F7 11 0A 00     	ld de,10 ;⪨
  76++93FA 3E FF        	ld a,255
  77++93FC              toDecimal001k
  78++93FC A7           	and a
  79++93FD ED 52        	sbc hl,de
  80++93FF 3C           	inc a
  81++9400 30 FA        	jr nc,toDecimal001k
  82++9402 19           	add hl,de
  83++9403 C6 30        	add a,48
  84++9405 32 20 94     	ld (decimalS+3),a
  85++9408 11 01 00     	ld de,1 ;
  86++940B 3E FF        	ld a,255
  87++940D              toDecimal0001k
  88++940D A7           	and a
  89++940E ED 52        	sbc hl,de
  90++9410 3C           	inc a
  91++9411 30 FA        	jr nc,toDecimal0001k
  92++9413 19           	add hl,de
  93++9414 C6 30        	add a,48
  94++9416 32 21 94     	ld (decimalS+4),a
  95++9419 C9           	ret
  96++941A              hours
  97++941A 00           	db 0
  98++941B              minutes
  99++941B 00           	db 0
 100++941C              seconds
 101++941C 00           	db 0
 102++941D 00 00 00...  decimalS	ds 7 ; 
 103++9424              	ENDIF
 104++9424 C9           	ret
 105++9425              oldminutes		;  㡨  ᫮
 106++9425 FF           	db 255
 107++9426
 108++9426
 109++9426
 110++9426
# file closed: screen/rtc.asm
  26+ 9426
  27+ 9426                  IFDEF NEDOOS
  28+ 9426 ~                ;Gap about 8kb, CMD_SETMUSIC 0x4000 mandatory
  29+ 9426 ~                ;Stack down from 0x4000
  30+ 9426 ~                    include "screen/nedoscreen.asm"
  31+ 9426 ~                    include "player/mod-processor.asm"
  32+ 9426 ~                    include "player/vortexnedoos.asm"
  33+ 9426 ~
  34+ 9426 ~            start:
  35+ 9426 ~            outputBuffer:
  36+ 9426 ~                    ld sp, 0x4000
  37+ 9426 ~                    ld c,nos.CMD_SETSYSDRV
  38+ 9426 ~                 	ex af,af'
  39+ 9426 ~            	    call nos.BDOS
  40+ 9426              	ELSE
  41+ 9426                      include "player/mod-processor.asm"
# file opened: player/mod-processor.asm
   1++9426                  MODULE ModProcessor
   2++9426                  ifdef GS
   3++9426
   4++9426                  macro _WaitCommand2
   5++9426 ~            .wait
   6++9426 ~                in a, (CMD)
   7++9426 ~                rrca
   8++9426 ~                jr c, .wait
   9++9426                  endm
  10++9426
  11++9426                  macro _SendCommand2 nn
  12++9426 ~                ld a, nn
  12++9426 ~              out (CMD), a
  13++9426                  endm
  14++9426
  15++9426              play:
  16++9426 3E FF            ld a, 255
  17++9428 32 25 94         ld (oldminutes), a
  18++942B
  19++942B CD 43 6A         call Console.waitForKeyUp
  20++942E
  21++942E 21 E1 8B         ld hl, Gopher.requestbuffer
  21++9431 CD 13 6A       call DialogBox.msgNoWait
  22++9434
  23++9434                  ;ld a, 1, (Render.play_next), a
  24++9434 AF           	xor a
  25++9435 32 CA 94     	ld (last_song_position),a
  26++9438
  27++9438 26 00 3E 20      ld h, #00, a, 32
  28++943C CD 47 60         call TextMode.fillLine
  29++943F 11 01 00         ld de, #0001
  29++9442 CD 3A 60       call TextMode.gotoXY
  30++9445 21 89 94         ld hl, message
  30++9448 CD BC 60       call TextMode.printZ
  31++944B 3E 00            ld a, #00
  32++944D CD 7B 60         call TextMode.highlightLine
  33++9450
  34++9450              .loop
  35++9450 76               halt
  36++9451 AF               xor a
  37++9452 CD 6D 6A         call Console.peekC
  38++9455 FE 0C            cp Console.BACKSPACE
  39++9457 CA 83 94         jp z, .stopKey
  40++945A FE 20        	cp SPACE
  41++945C CA 77 94         jp z, .playNext
  42++945F
  43++945F CD 80 93         call printRTC
  44++9462
  45++9462                 ;проверка что MOD начал играть сначала
  46++9462                  _SendCommand2 CMD_GET_SONG_POSITION
  46++9462 3E 60       >    ld a, CMD_GET_SONG_POSITION
  46++9464 D3 BB       >  out (CMD), a
  47++9466                  _WaitCommand2
  47++9466             >.wait
  47++9466 DB BB       >    in a, (CMD)
  47++9468 0F          >    rrca
  47++9469 38 FB       >    jr c, .wait
  48++946B 3A CA 94     	ld a,(last_song_position) ;предыдущая позиция
  49++946E 4F           	ld c,a
  50++946F DB B3        	in a,(DATA) ;текущая позиция
  51++9471 32 CA 94     	ld (last_song_position),a
  52++9474 B9           	cp c
  53++9475 30 D9        	jr nc, .loop ;если не меньше, продолжаем играть
  54++9477              .playNext
  55++9477 3E 01 32 54      ld a, 1, (Render.play_next), a ;флаг что надо будет играть следующий файл
  55++947B 69
  56++947C              .stop
  57++947C CD 61 93         call GeneralSound.stopModule
  58++947F
  59++947F CD 43 6A         call Console.waitForKeyUp
  60++9482 C9               ret
  61++9483              .stopKey
  62++9483 AF               xor a
  62++9484 32 54 69       ld (Render.play_next), a ;флаг что не надо играть следующий файл
  63++9487 18 F3            jr .stop
  64++9489
  65++9489              message
  66++9489                  IFDEF SCREEN64
  67++9489                  ENDIF
  68++9489                  IFDEF SCREEN80
  69++9489 ~                db "       "
  70++9489                  ENDIF
  71++9489                  IFDEF SCREEN85
  72++9489 ~                db "         "
  73++9489                  ENDIF
  74++9489
  75++9489 50 6C 61 79      db "Playing MODs [SPACE] for next song [BACKSPACE] for stop playing.", 0
  75++948D 69 6E 67 20
  75++9491 4D 4F 44 73
  75++9495 20 5B 53 50
  75++9499 41 43 45 5D
  75++949D 20 66 6F 72
  75++94A1 20 6E 65 78
  75++94A5 74 20 73 6F
  75++94A9 6E 67 20 5B
  75++94AD 42 41 43 4B
  75++94B1 53 50 41 43
  75++94B5 45 5D 20 66
  75++94B9 6F 72 20 73
  75++94BD 74 6F 70 20
  75++94C1 70 6C 61 79
  75++94C5 69 6E 67 2E
  75++94C9 00
  76++94CA
  77++94CA              CMD_GET_SONG_POSITION     = #60
  78++94CA 00           last_song_position db 0
  79++94CB
  80++94CB              ;; Control ports
  81++94CB              CMD  = 187
  82++94CB              DATA = 179
  83++94CB                  endif
  84++94CB                  ENDMODULE
  85++94CB
# file closed: player/mod-processor.asm
  42+ 94CB                      include "screen/screen.asm"
# file opened: screen/screen.asm
   1++94CB                  module ScreenViewer
   2++94CB              display:
   3++94CB CD 43 6A         call Console.waitForKeyUp
   4++94CE 3E 07            ld a, 7
   4++94D0 CD 12 93       call Memory.setPage
   5++94D3 21 59 A1 11      ld hl, outputBuffer, de, #c000, bc, 6912
   5++94D7 00 C0 01 00
   5++94DB 1B
   5++94DC ED B0          ldir
   6++94DE CD 46 60         call TextMode.disable
   7++94E1              .wait
   8++94E1 76           	halt
   9++94E2 AF               xor a
   9++94E3 DB FE          in a, (#fe)
   9++94E5 2F             cpl
   9++94E6 E6 1F          and 31
   9++94E8 28 F7          jr z, .wait
  10++94EA CD 1D 60         call TextMode.cls
  11++94ED C3 BA 73         jp History.back
  12++94F0
  13++94F0                  endmodule
# file closed: screen/screen.asm
  43+ 94F0                      include "player/vortex-processor.asm"
# file opened: player/vortex-processor.asm
   1++94F0                  MODULE VortexProcessor
   2++94F0              	IFDEF MSX
   3++94F0 ~            play:
   4++94F0 ~                call Console.peekC
   4++94F0 ~              and a
   5++94F0 ~                jr nz, play
   6++94F0 ~
   7++94F0 ~                ld hl, message
   7++94F0 ~              call DialogBox.msgNoWait
   8++94F0 ~
   9++94F0 ~                ld hl, outputBuffer
   9++94F0 ~              call VTPL.INIT
  10++94F0 ~            .loop
  11++94F0 ~                halt
  11++94F0 ~              di
  11++94F0 ~              call VTPL.PLAY
  11++94F0 ~              ei
  12++94F0 ~                call Console.peekC
  12++94F0 ~              and a
  12++94F0 ~              jp nz, .stop
  13++94F0 ~                jr nc, .loop
  14++94F0 ~            .stop
  15++94F0 ~                call VTPL.MUTE
  16++94F0 ~            .wlp
  17++94F0 ~                call Console.peekC
  17++94F0 ~              and a
  18++94F0 ~                jr nz, .wlp
  19++94F0 ~                ret
  20++94F0 ~
  21++94F0 ~            message db "Press key to stop...", 0
  22++94F0 ~                ENDMODULE
  23++94F0 ~                include "msxplayer.asm"
  24++94F0              	ELSE
  25++94F0              play:
  26++94F0 3E FF            ld a, 255
  27++94F2 32 25 94         ld (oldminutes), a
  28++94F5
  29++94F5 CD 43 6A         call Console.waitForKeyUp
  30++94F8
  31++94F8 21 4E 95         ld hl, message
  31++94FB CD 13 6A       call DialogBox.msgNoWait
  32++94FE
  33++94FE 21 59 A1         ld hl, outputBuffer
  33++9501 CD A4 95       call VTPL.INIT
  34++9504
  35++9504
  36++9504 3E 01 32 54      ld a, 1, (Render.play_next), a
  36++9508 69
  37++9509
  38++9509                  IFDEF GS
  39++9509 CD 61 93         call GeneralSound.stopModule
  40++950C                  ENDIF
  41++950C              .loop
  42++950C 76               halt
  42++950D F3             di
  42++950E CD C7 9D       call VTPL.PLAY
  42++9511 FB             ei
  43++9512 AF               xor a
  43++9513 DB FE          in a, (#fe)
  43++9515 2F             cpl
  43++9516 E6 1F          and 31
  43++9518 C2 33 95       jp nz, .stopKey
  44++951B CD 80 93         call printRTC
  45++951E 3A 6D 95         ld a, (VTPL.SETUP)
  45++9521 17             rla
  45++9522 30 E8          jr nc, .loop
  46++9524 3E 01 32 54      ld a, 1, (Render.play_next), a
  46++9528 69
  47++9529              .stop
  48++9529 CD 92 95         call VTPL.MUTE
  49++952C
  50++952C                  IFDEF AY
  51++952C CD 39 95         call restoreAyState
  52++952F                  ENDIF
  53++952F
  54++952F CD 43 6A         call Console.waitForKeyUp
  55++9532 C9               ret
  56++9533              .stopKey
  57++9533 AF               xor a
  57++9534 32 54 69       ld (Render.play_next), a
  58++9537 18 F0            jr .stop
  59++9539
  60++9539                  IFDEF AY
  61++9539              restoreAyState:
  62++9539 3E 07            ld a, #07
  63++953B 01 FD FF         ld bc, #fffd
  64++953E ED 79            out (c), a
  65++9540 3E FC            ld a, #fc
  66++9542 06 BF            ld b, #bf
  67++9544 ED 79            out (c), a ; Enable read mode
  68++9546
  69++9546 3E 0E            ld a, #0e
  70++9548 01 FD FF         ld bc, #fffd
  71++954B ED 79            out (c), a
  72++954D C9               ret
  73++954E              	ENDIF
  74++954E 50 72 65 73  message db "Press key to stop...", 0
  74++9552 73 20 6B 65
  74++9556 79 20 74 6F
  74++955A 20 73 74 6F
  74++955E 70 2E 2E 2E
  74++9562 00
  75++9563                  ENDMODULE
  76++9563                  include "player.asm"
# file opened: player/player.asm
   1++9563              ;Universal PT2'n'PT3 Turbo Sound player for ZX Spectrum
   2++9563              ;(c)2004-2007 S.V.Bulba <vorobey@mail.khstu.ru>
   3++9563              ;Specially for AlCo
   4++9563              ;http://bulba.untergrund.net/ (http://bulba.at.kz/)
   5++9563              	MODULE VTPL
   6++9563              ;Release number
   7++9563              Release EQU "0"
   8++9563              ;Conditional assembly
   9++9563              ;1) Current position counters at (Vars1+0) and (Vars2+0)
  10++9563              CurPosCounter=0
  11++9563              ;2) Allow channels allocation bits at (START+10)
  12++9563              ACBBAC=0
  13++9563              ;3) Allow loop checking and disabling
  14++9563              LoopChecker=1
  15++9563              ;4) Insert official identificator
  16++9563              Id=0
  17++9563              ;5) Set IY for correct return to ZX Basic
  18++9563              Basic=1
  19++9563
  20++9563              ;Features
  21++9563              ;--------
  22++9563              ;-Can be compiled at any address (i.e. no need rounding ORG
  23++9563              ; address).
  24++9563              ;-Variables (VARS) can be located at any address (not only after
  25++9563              ; code block).
  26++9563              ;-INIT subprogram checks PT3-module version and rightly
  27++9563              ; generates both note and volume tables outside of code block
  28++9563              ; (in VARS).
  29++9563              ;-Two portamento (spc. command 3xxx) algorithms (depending of
  30++9563              ; PT3 module version).
  31++9563              ;-New 1.XX and 2.XX special command behaviour (only for PT v3.7
  32++9563              ; and higher).
  33++9563              ;-Any Tempo value are accepted (including Tempo=1 and Tempo=2).
  34++9563              ;-TS modes: 2xPT3, 2xPT2 and PT v3.7 TS standard.
  35++9563              ;-Fully compatible with Ay_Emul PT3 and PT2 players codes.
  36++9563              ;-See also notes at the end of this source code.
  37++9563
  38++9563              ;Limitations
  39++9563              ;-----------
  40++9563              ;-Can run in RAM only (self-modified code is used).
  41++9563              ;-PT2 position list must be end by #FF marker only.
  42++9563
  43++9563              ;Warning!!! PLAY subprogram can crash if no module are loaded
  44++9563              ;into RAM or INIT subprogram was not called before.
  45++9563
  46++9563              ;Call MUTE or INIT one more time to mute sound after stopping
  47++9563              ;playing
  48++9563
  49++9563              ;Test codes (commented)
  50++9563              ;	LD A,32 ;SinglePT3(TS if TSPT3.7),ABC,Looped
  51++9563              ;	LD (START+10),A
  52++9563              ;	LD HL,#8000 ;Mod1
  53++9563              ;	LD DE,#A000 ;Mod2 (optional)
  54++9563              ;	CALL START+3
  55++9563              ;	EI
  56++9563              ;_LP	HALT
  57++9563              ;	CALL START+5
  58++9563              ;	XOR A
  59++9563              ;	IN A,(#FE)
  60++9563              ;	CPL
  61++9563              ;	AND 15
  62++9563              ;	JR Z,_LP
  63++9563              ;	JR START+8
  64++9563
  65++9563              TonA	EQU 0
  66++9563              TonB	EQU 2
  67++9563              TonC	EQU 4
  68++9563              Noise	EQU 6
  69++9563              Mixer	EQU 7
  70++9563              AmplA	EQU 8
  71++9563              AmplB	EQU 9
  72++9563              AmplC	EQU 10
  73++9563              Env	EQU 11
  74++9563              EnvTp	EQU 13
  75++9563
  76++9563              ;Entry and other points
  77++9563              ;START initialize playing of modules at MDLADDR (single module)
  78++9563              ;START+3 initialization with module address in HL and DE (TS)
  79++9563              ;START+5 play one quark
  80++9563              ;START+8 mute
  81++9563              ;START+10 setup and status flags
  82++9563
  83++9563              START:
  84++9563 21 59 A1     	LD HL,outputBuffer ;DE - address of 2nd module for TS
  85++9566 18 3C        	JR INIT
  86++9568 C3 C7 9D     	JP PLAY
  87++956B 18 25        	JR MUTE
  88++956D 00           SETUP	DB 0 ;set bit0, if you want to play without looping
  89++956E              	     ;(optional);
  90++956E              	     ;set bit1 for PT2 and reset for PT3 before
  91++956E              	     ;calling INIT;
  92++956E              	     ;bits2-3: %00-ABC, %01-ACB, %10-BAC (optional);
  93++956E              	     ;bits4-5: %00-no TS, %01-2 modules TS, %10-
  94++956E              	     ;autodetect PT3 TS-format by AlCo (PT 3.7+);
  95++956E              	     ;Remark: old PT3 TS-format by AlCo (PT 3.6) is not
  96++956E              	     ;documented and must be converted to new standard.
  97++956E              	     ;bit6 is set each time, when loop point of 2nd TS
  98++956E              	     ;module is passed (optional).
  99++956E              	     ;bit7 is set each time, when loop point of 1st TS
 100++956E              	     ;or of single module is passed (optional).
 101++956E
 102++956E              ;Identifier
 103++956E              	IF Id
 104++956E ~            	DB "=UniPT2/PT3/TS-Player r.",Release,"="
 105++956E              	ENDIF
 106++956E
 107++956E              	IF LoopChecker
 108++956E 21 6D 95     CHECKLP	LD HL,SETUP
 109++9571 FD CB 9E 46  	BIT 0,(IY-100+VRS.ModNum)
 110++9575 28 04        	JR Z,CHL1
 111++9577 CB F6        	SET 6,(HL)
 112++9579 18 02        	JR CHL2
 113++957B CB FE        CHL1	SET 7,(HL)
 114++957D CB 46        CHL2	BIT 0,(HL)
 115++957F C8           	RET Z
 116++9580 E1           	POP HL
 117++9581 FD 34 09     	INC (IY-100+VRS.DelyCnt)
 118++9584 FD 34 BA     	INC (IY-100+VRS.ChanA+CHP.NtSkCn)
 119++9587 AF           	XOR A
 120++9588 FD 77 1D     	LD (IY-100+VRS.AYREGS+AmplA),A
 121++958B FD 77 1E     	LD (IY-100+VRS.AYREGS+AmplB),A
 122++958E FD 77 1F     	LD (IY-100+VRS.AYREGS+AmplC),A
 123++9591 C9           	RET
 124++9592              	ENDIF
 125++9592
 126++9592 AF           MUTE: XOR A
 127++9593 67           	LD H,A
 128++9594 6F           	LD L,A
 129++9595 32 1C 9F     	LD (VARS1+VRS.AYREGS+AmplA),A
 130++9598 22 1D 9F     	LD (VARS1+VRS.AYREGS+AmplB),HL
 131++959B 32 A3 9F     	LD (VARS2+VRS.AYREGS+AmplA),A
 132++959E 22 A4 9F     	LD (VARS2+VRS.AYREGS+AmplB),HL
 133++95A1 C3 DF 9D     	JP ROUT
 134++95A4
 135++95A4              INIT:
 136++95A4              ;HL - AddressOfModule
 137++95A4              ;DE - AddresOf2ndModule
 138++95A4 D5           	PUSH DE
 139++95A5 E5           	PUSH HL
 140++95A6 21 9A 9E     	LD HL,VARS
 141++95A9 36 00        	LD (HL),0
 142++95AB 11 9B 9E     	LD DE,VARS+1
 143++95AE 01 0E 01     	LD BC,VAR0END-VARS-1
 144++95B1 ED B0        	LDIR
 145++95B3 23           	INC HL
 146++95B4 22 FD 9E     	LD (VARS1+VRS.AdInPtA),HL ;ptr to zero
 147++95B7 22 84 9F     	LD (VARS2+VRS.AdInPtA),HL
 148++95BA
 149++95BA E1           	POP HL
 150++95BB FD 21 FF 9E  	LD IY,VARS1+100
 151++95BF 3A 6D 95     	LD A,(START+10)
 152++95C2 E6 02        	AND 2
 153++95C4 C2 4D 96     	JP NZ,I_PT2
 154++95C7
 155++95C7 CD 9A 97     	CALL INITPT3
 156++95CA 21 18 1F     	LD HL,(e_-SamCnv-2)*256+#18
 157++95CD 22 6D 9B     	LD (SamCnv),HL
 158++95D0 3E BA        	LD A,#BA
 159++95D2 32 38 9B     	LD (OrnCP),A
 160++95D5 32 64 9B     	LD (SamCP),A
 161++95D8 3E 7B        	LD A,#7B
 162++95DA 32 3B 9B     	LD (OrnLD),A
 163++95DD 32 67 9B     	LD (SamLD),A
 164++95E0 3E 87        	LD A,#87
 165++95E2 32 5E 9B     	LD (SamClc2),A
 166++95E5 E1           	POP HL
 167++95E6              	;Use version and ton table of 1st module
 168++95E6 DD 7E A9     	LD A,(IX+13-100) ;EXTRACT VERSION NUMBER
 169++95E9 D6 30        	SUB #30
 170++95EB 38 04        	JR C,L20
 171++95ED FE 0A        	CP 10
 172++95EF 38 02        	JR C,L21
 173++95F1 3E 06        L20	LD A,6
 174++95F3 32 0B 9A     L21	LD (Version),A
 175++95F6 F5           	PUSH AF ;VolTable version
 176++95F7 FE 04        	CP 4
 177++95F9 DD 7E FF     	LD A,(IX+99-100) ;TONE TABLE NUMBER
 178++95FC 17           	RLA
 179++95FD E6 07        	AND 7
 180++95FF F5           	PUSH AF ;NoteTable number
 181++9600
 182++9600 FD 21 86 9F  	LD IY,VARS2+100
 183++9604 3A 6D 95     	LD A,(START+10)
 184++9607 E6 30        	AND 48
 185++9609 28 37        	JR Z,NOTS
 186++960B FE 10        	CP 16
 187++960D 28 27        	JR Z,TwoPT3s
 188++960F 3A 0B 9A     	LD A,(Version)
 189++9612 FE 07        	CP 7
 190++9614 38 2C        	JR C,NOTS
 191++9616 DD 7E FE     	LD A,(IX+98-100) ;ALCO TS MARKER
 192++9619 FE 20        	CP #20
 193++961B 28 25        	JR Z,NOTS
 194++961D 21 9B 9E     	LD HL,VARS1
 195++9620 11 22 9F     	LD DE,VARS2
 196++9623 01 87 00     	LD BC,VRS
 197++9626 ED B0        	LDIR
 198++9628 FD CB 9E CE  	SET 1,(IY-100+VRS.ModNum)
 199++962C 4F           	LD C,A
 200++962D 87           	ADD A,A
 201++962E 81           	ADD A,C
 202++962F D6 02        	SUB 2
 203++9631 32 D2 9C     	LD (TSSub),A
 204++9634 18 03        	JR AlCoTS_
 205++9636 CD 9A 97     TwoPT3s	CALL INITPT3
 206++9639 3E 01        AlCoTS_	LD A,1
 207++963B 32 9A 9E     	LD (is_ts),A
 208++963E FD CB 9E C6  	SET 0,(IY-100+VRS.ModNum)
 209++9642
 210++9642 01 57 99     NOTS	LD BC,PT3PD
 211++9645 21 00 00     	LD HL,0
 212++9648 11 62 9E     	LD DE,PT3EMPTYORN
 213++964B 18 48        	JR INITCOMMON
 214++964D
 215++964D CD D2 97     I_PT2	CALL INITPT2
 216++9650 21 CB 51     	LD HL,#51CB
 217++9653 22 6D 9B     	LD (SamCnv),HL
 218++9656 3E BB        	LD A,#BB
 219++9658 32 38 9B     	LD (OrnCP),A
 220++965B 32 64 9B     	LD (SamCP),A
 221++965E 3E 7A        	LD A,#7A
 222++9660 32 3B 9B     	LD (OrnLD),A
 223++9663 32 67 9B     	LD (SamLD),A
 224++9666 3E 80        	LD A,#80
 225++9668 32 5E 9B     	LD (SamClc2),A
 226++966B E1           	POP HL
 227++966C 3E 05        	LD A,5
 228++966E 32 0B 9A     	LD (Version),A
 229++9671 F5           	PUSH AF
 230++9672 3E 02        	LD A,2
 231++9674 F5           	PUSH AF
 232++9675
 233++9675 3A 6D 95     	LD A,(START+10)
 234++9678 E6 30        	AND 48
 235++967A 28 10        	JR Z,NOTS2
 236++967C
 237++967C FD 21 86 9F  	LD IY,VARS2+100
 238++9680 3E 01        	LD A,1
 239++9682 32 9A 9E     	LD (is_ts),A
 240++9685 FD CB 9E C6  	SET 0,(IY-100+VRS.ModNum)
 241++9689 CD D2 97     	CALL INITPT2
 242++968C
 243++968C 01 91 98     NOTS2	LD BC,PT2PD
 244++968F 21 87 86     	LD HL,#8687
 245++9692 11 B8 9F     	LD DE,PT2EMPTYORN
 246++9695
 247++9695              INITCOMMON
 248++9695
 249++9695              	IF Basic
 250++9695 FD 21 3A 5C  	LD IY,#5C3A
 251++9699              	ENDIF
 252++9699
 253++9699 ED 43 42 98  	LD (PTDEC),BC
 254++969D 22 D4 9C     	LD (PsCalc),HL
 255++96A0 D5           	PUSH DE
 256++96A1
 257++96A1              ;note table data depacker
 258++96A1              ;(c) Ivan Roshin
 259++96A1 11 65 9E     	LD DE,T_PACK
 260++96A4 01 0A A0     	LD BC,T1_+(2*49)-1
 261++96A7 1A           TP_0	LD A,(DE)
 262++96A8 13           	INC DE
 263++96A9 FE 1E        	CP 15*2
 264++96AB 30 06        	JR NC,TP_1
 265++96AD 67           	LD H,A
 266++96AE 1A           	LD A,(DE)
 267++96AF 6F           	LD L,A
 268++96B0 13           	INC DE
 269++96B1 18 07        	JR TP_2
 270++96B3 D5           TP_1	PUSH DE
 271++96B4 16 00        	LD D,0
 272++96B6 5F           	LD E,A
 273++96B7 19           	ADD HL,DE
 274++96B8 19           	ADD HL,DE
 275++96B9 D1           	POP DE
 276++96BA 7C           TP_2	LD A,H
 277++96BB 02           	LD (BC),A
 278++96BC 0B           	DEC BC
 279++96BD 7D           	LD A,L
 280++96BE 02           	LD (BC),A
 281++96BF 0B           	DEC BC
player.asm(282): warning: value 0x1F0 is truncated to 8bit value: 0xF0
 282++96C0 D6 F0        	SUB #F8*2
 283++96C2 20 E3        	JR NZ,TP_0
 284++96C4
 285++96C4 3C           	INC A
 286++96C5 32 08 9F     	LD (VARS1+VRS.DelyCnt),A
 287++96C8 32 8F 9F     	LD (VARS2+VRS.DelyCnt),A
 288++96CB 21 01 F0     	LD HL,#F001 ;H - CHP.Volume, L - CHP.NtSkCn
 289++96CE 22 B9 9E     	LD (VARS1+VRS.ChanA+CHP.NtSkCn),HL
 290++96D1 22 D6 9E     	LD (VARS1+VRS.ChanB+CHP.NtSkCn),HL
 291++96D4 22 F3 9E     	LD (VARS1+VRS.ChanC+CHP.NtSkCn),HL
 292++96D7 22 40 9F     	LD (VARS2+VRS.ChanA+CHP.NtSkCn),HL
 293++96DA 22 5D 9F     	LD (VARS2+VRS.ChanB+CHP.NtSkCn),HL
 294++96DD 22 7A 9F     	LD (VARS2+VRS.ChanC+CHP.NtSkCn),HL
 295++96E0 E1           	POP HL
 296++96E1 22 AB 9E     	LD (VARS1+VRS.ChanA+CHP.OrnPtr),HL
 297++96E4 22 C8 9E     	LD (VARS1+VRS.ChanB+CHP.OrnPtr),HL
 298++96E7 22 E5 9E     	LD (VARS1+VRS.ChanC+CHP.OrnPtr),HL
 299++96EA 22 32 9F     	LD (VARS2+VRS.ChanA+CHP.OrnPtr),HL
 300++96ED 22 4F 9F     	LD (VARS2+VRS.ChanB+CHP.OrnPtr),HL
 301++96F0 22 6C 9F     	LD (VARS2+VRS.ChanC+CHP.OrnPtr),HL
 302++96F3
 303++96F3 F1           	POP AF
 304++96F4
 305++96F4              ;NoteTableCreator (c) Ivan Roshin
 306++96F4              ;A - NoteTableNumber*2+VersionForNoteTable
 307++96F4              ;(xx1b - 3.xx..3.4r, xx0b - 3.4x..3.6x..VTII1.0)
 308++96F4
 309++96F4 21 12 9E     	LD HL,NT_DATA
 310++96F7 16 00        	LD D,0
 311++96F9 87           	ADD A,A
 312++96FA 5F           	LD E,A
 313++96FB 19           	ADD HL,DE
 314++96FC 5E           	LD E,(HL)
 315++96FD 23           	INC HL
 316++96FE CB 3B        	SRL E
 317++9700 9F           	SBC A,A
 318++9701 E6 A7        	AND #A7 ;#00 (NOP) or #A7 (AND A)
 319++9703 32 2B 97     	LD (L3),A
 320++9706 EB           	EX DE,HL
 321++9707 01 A9 9F     	LD BC,T1_
 322++970A 09           	ADD HL,BC
 323++970B
 324++970B 1A           	LD A,(DE)
player.asm(325): warning: value 0x9E22 is truncated to 8bit value: 0x22
 325++970C C6 22        	ADD A,T_
 326++970E 4F           	LD C,A
 327++970F CE 9E        	ADC A,T_/256
 328++9711 91           	SUB C
 329++9712 47           	LD B,A
 330++9713 C5           	PUSH BC
 331++9714 11 99 A0     	LD DE,NT_
 332++9717 D5           	PUSH DE
 333++9718
 334++9718 06 0C        	LD B,12
 335++971A C5           L1	PUSH BC
 336++971B 4E           	LD C,(HL)
 337++971C 23           	INC HL
 338++971D E5           	PUSH HL
 339++971E 46           	LD B,(HL)
 340++971F
 341++971F D5           	PUSH DE
 342++9720 EB           	EX DE,HL
 343++9721 11 17 00     	LD DE,23
 344++9724 DD 26 08     	LD IXH,8
 345++9727
 346++9727 CB 38        L2	SRL B
 347++9729 CB 19        	RR C
 348++972B 19           L3	DB #19	;AND A or NOP
 349++972C 79           	LD A,C
 350++972D 8A           	ADC A,D	;=ADC 0
 351++972E 77           	LD (HL),A
 352++972F 23           	INC HL
 353++9730 78           	LD A,B
 354++9731 8A           	ADC A,D
 355++9732 77           	LD (HL),A
 356++9733 19           	ADD HL,DE
 357++9734 DD 25        	DEC IXH
 358++9736 20 EF        	JR NZ,L2
 359++9738
 360++9738 D1           	POP DE
 361++9739 13           	INC DE
 362++973A 13           	INC DE
 363++973B E1           	POP HL
 364++973C 23           	INC HL
 365++973D C1           	POP BC
 366++973E 10 DA        	DJNZ L1
 367++9740
 368++9740 E1           	POP HL
 369++9741 D1           	POP DE
 370++9742
 371++9742 7B           	LD A,E
player.asm(372): warning: value 0x9E2E is truncated to 8bit value: 0x2E
 372++9743 FE 2E        	CP TCOLD_1
 373++9745 20 05        	JR NZ,CORR_1
 374++9747 3E FD        	LD A,#FD
 375++9749 32 C7 A0     	LD (NT_+#2E),A
 376++974C
 377++974C 1A           CORR_1	LD A,(DE)
 378++974D A7           	AND A
 379++974E 28 11        	JR Z,TC_EXIT
 380++9750 1F           	RRA
 381++9751 F5           	PUSH AF
 382++9752 87           	ADD A,A
 383++9753 4F           	LD C,A
 384++9754 09           	ADD HL,BC
 385++9755 F1           	POP AF
 386++9756 30 02        	JR NC,CORR_2
 387++9758 35           	DEC (HL)
 388++9759 35           	DEC (HL)
 389++975A 34           CORR_2	INC (HL)
 390++975B A7           	AND A
 391++975C ED 42        	SBC HL,BC
 392++975E 13           	INC DE
 393++975F 18 EB        	JR CORR_1
 394++9761
 395++9761              TC_EXIT
 396++9761
 397++9761 F1           	POP AF
 398++9762
 399++9762              ;VolTableCreator (c) Ivan Roshin
 400++9762              ;A - VersionForVolumeTable (0..4 - 3.xx..3.4x;
 401++9762              			   ;5.. - 2.x,3.5x..3.6x..VTII1.0)
 402++9762
 403++9762 FE 05        	CP 5
 404++9764 21 11 00     	LD HL,#11
 405++9767 54           	LD D,H
 406++9768 5C           	LD E,H
 407++9769 3E 17        	LD A,#17
 408++976B 30 03        	JR NC,M1
 409++976D 2D           	DEC L
 410++976E 5D           	LD E,L
 411++976F AF           	XOR A
 412++9770 32 81 97     M1      LD (M2),A
 413++9773
 414++9773 DD 21 A9 9F  	LD IX,VT_+16
 415++9777
 416++9777 0E 0F        	LD C,#F
 417++9779 E5           INITV2  PUSH HL
 418++977A
 419++977A 19           	ADD HL,DE
 420++977B EB           	EX DE,HL
 421++977C ED 62        	SBC HL,HL
 422++977E
 423++977E 06 10        	LD B,#10
 424++9780 7D           INITV1  LD A,L
 425++9781 7D           M2      DB #7D
 426++9782 7C           	LD A,H
 427++9783 CE 00        	ADC A,0
 428++9785 DD 77 00     	LD (IX),A
 429++9788 DD 23        	INC IX
 430++978A 19           	ADD HL,DE
 431++978B 10 F3        	DJNZ INITV1
 432++978D
 433++978D E1           	POP HL
 434++978E 7B           	LD A,E
 435++978F FE 77        	CP #77
 436++9791 20 01        	JR NZ,M3
 437++9793 1C           	INC E
 438++9794 0D           M3      DEC C
 439++9795 20 E2        	JR NZ,INITV2
 440++9797
 441++9797 C3 DF 9D     	JP ROUT
 442++979A
 443++979A CD 0D 98     INITPT3	CALL SETMDAD
 444++979D E5           	PUSH HL
 445++979E 11 64 00     	LD DE,100
 446++97A1 19           	ADD HL,DE
 447++97A2 7E           	LD A,(HL)
 448++97A3 FD 77 08     	LD (IY-100+VRS.Delay),A
 449++97A6 E5           	PUSH HL
 450++97A7 DD E1        	POP IX
 451++97A9 19           	ADD HL,DE
 452++97AA CD 1B 98     	CALL SETCPPT
 453++97AD DD 5E 02     	LD E,(IX+102-100)
 454++97B0 23           	INC HL
 455++97B1
 456++97B1              	IF CurPosCounter
 457++97B1 ~            	LD (IY-100+VRS.PosSub),L
 458++97B1              	ENDIF
 459++97B1
 460++97B1 19           	ADD HL,DE
 461++97B2 CD 22 98     	CALL SETLPPT
 462++97B5 D1           	POP DE
 463++97B6 DD 6E 03     	LD L,(IX+103-100)
 464++97B9 DD 66 04     	LD H,(IX+104-100)
 465++97BC 19           	ADD HL,DE
 466++97BD CD 06 98     	CALL SETPTPT
 467++97C0 21 A9 00     	LD HL,169
 468++97C3 19           	ADD HL,DE
 469++97C4 CD 14 98     	CALL SETORPT
 470++97C7 21 69 00     	LD HL,105
 471++97CA 19           	ADD HL,DE
 472++97CB
 473++97CB FD 75 FA     SETSMPT LD (IY-100+VRS.SamPtrs),L
 474++97CE FD 74 FB     	LD (IY-100+VRS.SamPtrs+1),H
 475++97D1 C9           	RET
 476++97D2
 477++97D2 7E           INITPT2	LD A,(HL)
 478++97D3 FD 77 08     	LD (IY-100+VRS.Delay),A
 479++97D6 E5           	PUSH HL
 480++97D7 E5           	PUSH HL
 481++97D8 E5           	PUSH HL
 482++97D9 23           	INC HL
 483++97DA 23           	INC HL
 484++97DB 7E           	LD A,(HL)
 485++97DC 23           	INC HL
 486++97DD CD CB 97     	CALL SETSMPT
 487++97E0 5E           	LD E,(HL)
 488++97E1 23           	INC HL
 489++97E2 56           	LD D,(HL)
 490++97E3 E1           	POP HL
 491++97E4 A7           	AND A
 492++97E5 ED 52        	SBC HL,DE
 493++97E7 CD 0D 98     	CALL SETMDAD
 494++97EA E1           	POP HL
 495++97EB 11 43 00     	LD DE,67
 496++97EE 19           	ADD HL,DE
 497++97EF CD 14 98     	CALL SETORPT
 498++97F2 1E 20        	LD E,32
 499++97F4 19           	ADD HL,DE
 500++97F5 4E           	LD C,(HL)
 501++97F6 23           	INC HL
 502++97F7 46           	LD B,(HL)
 503++97F8 1E 1E        	LD E,30
 504++97FA 19           	ADD HL,DE
 505++97FB CD 1B 98     	CALL SETCPPT
 506++97FE 5F           	LD E,A
 507++97FF 23           	INC HL
 508++9800
 509++9800              	IF CurPosCounter
 510++9800 ~            	LD (IY-100+VRS.PosSub),L
 511++9800              	ENDIF
 512++9800
 513++9800 19           	ADD HL,DE
 514++9801 CD 22 98     	CALL SETLPPT
 515++9804 E1           	POP HL
 516++9805 09           	ADD HL,BC
 517++9806
 518++9806 FD 75 FC     SETPTPT	LD (IY-100+VRS.PatsPtr),L
 519++9809 FD 74 FD     	LD (IY-100+VRS.PatsPtr+1),H
 520++980C C9           	RET
 521++980D
 522++980D FD 75 F6     SETMDAD	LD (IY-100+VRS.MODADDR),L
 523++9810 FD 74 F7     	LD (IY-100+VRS.MODADDR+1),H
 524++9813 C9           	RET
 525++9814
 526++9814 FD 75 F8     SETORPT	LD (IY-100+VRS.OrnPtrs),L
 527++9817 FD 74 F9     	LD (IY-100+VRS.OrnPtrs+1),H
 528++981A C9           	RET
 529++981B
 530++981B FD 75 04     SETCPPT	LD (IY-100+VRS.CrPsPtr),L
 531++981E FD 74 05     	LD (IY-100+VRS.CrPsPtr+1),H
 532++9821 C9           	RET
 533++9822
 534++9822 FD 75 06     SETLPPT	LD (IY-100+VRS.LPosPtr),L
 535++9825 FD 74 07     	LD (IY-100+VRS.LPosPtr+1),H
 536++9828 C9           	RET
 537++9829
 538++9829 FD 75 13     SETENBS	LD (IY-100+VRS.EnvBase),L
 539++982C FD 74 14     	LD (IY-100+VRS.EnvBase+1),H
 540++982F C9           	RET
 541++9830
 542++9830 FD 75 0C     SETESLD	LD (IY-100+VRS.CurESld),L
 543++9833 FD 74 0D     	LD (IY-100+VRS.CurESld+1),H
 544++9836 C9           	RET
 545++9837
 546++9837 FD E5        GETIX	PUSH IY
 547++9839 DD E1        	POP IX
 548++983B DD 19        	ADD IX,DE
 549++983D C9           	RET
 550++983E
 551++983E CD 37 98     PTDECOD CALL GETIX
 552++9841              PTDEC	EQU $+1
 553++9841 C3 C3 C3     	JP #C3C3
 554++9844
 555++9844              ;PT2 pattern decoder
 556++9844 CD DA 9A     PD2_SAM	CALL SETSAM
 557++9847 18 4A        	JR PD2_LOOP
 558++9849
 559++9849 DD 77 08     PD2_EOff LD (IX-12+CHP.Env_En),A
 560++984C 18 45        	JR PD2_LOOP
 561++984E
 562++984E DD 36 08 10  PD2_ENV	LD (IX-12+CHP.Env_En),16
 563++9852 FD 77 22     	LD (IY-100+VRS.AYREGS+EnvTp),A
 564++9855 0A           	LD A,(BC)
 565++9856 03           	INC BC
 566++9857 6F           	LD L,A
 567++9858 0A           	LD A,(BC)
 568++9859 03           	INC BC
 569++985A 67           	LD H,A
 570++985B CD 29 98     	CALL SETENBS
 571++985E 18 33        	JR PD2_LOOP
 572++9860
 573++9860 CD BB 9A     PD2_ORN	CALL SETORN
 574++9863 18 2E        	JR PD2_LOOP
 575++9865
 576++9865 3C           PD2_SKIP INC A
 577++9866 DD 77 05     	LD (IX-12+CHP.NNtSkp),A
 578++9869 18 28        	JR PD2_LOOP
 579++986B
 580++986B 0F           PD2_VOL	RRCA
 581++986C 0F           	RRCA
 582++986D 0F           	RRCA
 583++986E 0F           	RRCA
 584++986F DD 77 10     	LD (IX-12+CHP.Volume),A
 585++9872 18 1F        	JR PD2_LOOP
 586++9874
 587++9874 CD 8B 9A     PD2_DEL	CALL C_DELAY
 588++9877 18 1A        	JR PD2_LOOP
 589++9879
 590++9879 DD CB 09 D6  PD2_GLIS SET 2,(IX-12+CHP.Flags)
 591++987D 3C           	INC A
 592++987E DD 77 0A     	LD (IX-12+CHP.TnSlDl),A
 593++9881 DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 594++9884 0A           	LD A,(BC)
 595++9885 03           	INC BC
 596++9886 DD 77 0B             LD (IX-12+CHP.TSlStp),A
 597++9889 87           	ADD A,A
 598++988A 9F           	SBC A,A
 599++988B DD 77 0C             LD (IX-12+CHP.TSlStp+1),A
 600++988E 37           	SCF
 601++988F 18 01        	JR PD2_LP2
 602++9891
 603++9891 A7           PT2PD	AND A
 604++9892
 605++9892 08           PD2_LP2	EX AF,AF'
 606++9893
 607++9893 0A           PD2_LOOP LD A,(BC)
 608++9894 03           	INC BC
 609++9895 C6 20        	ADD A,#20
 610++9897 28 3F        	JR Z,PD2_REL
 611++9899 38 A9        	JR C,PD2_SAM
 612++989B C6 60        	ADD A,96
 613++989D 38 3E        	JR C,PD2_NOTE
 614++989F 3C           	INC A
 615++98A0 28 A7        	JR Z,PD2_EOff
 616++98A2 C6 0F        	ADD A,15
 617++98A4 CA BA 99     	JP Z,PD_FIN
 618++98A7 38 A5        	JR C,PD2_ENV
 619++98A9 C6 10        	ADD A,#10
 620++98AB 38 B3        	JR C,PD2_ORN
 621++98AD C6 40        	ADD A,#40
 622++98AF 38 B4        	JR C,PD2_SKIP
 623++98B1 C6 10        	ADD A,#10
 624++98B3 38 B6        	JR C,PD2_VOL
 625++98B5 3C           	INC A
 626++98B6 28 BC        	JR Z,PD2_DEL
 627++98B8 3C           	INC A
 628++98B9 28 BE        	JR Z,PD2_GLIS
 629++98BB 3C           	INC A
 630++98BC 28 0A        	JR Z,PD2_PORT
 631++98BE 3C           	INC A
 632++98BF 28 12        	JR Z,PD2_STOP
 633++98C1 0A           	LD A,(BC)
 634++98C2 03           	INC BC
 635++98C3 DD 77 F7     	LD (IX-12+CHP.CrNsSl),A
 636++98C6 18 CB        	JR PD2_LOOP
 637++98C8
 638++98C8 DD CB 09 96  PD2_PORT RES 2,(IX-12+CHP.Flags)
 639++98CC 0A           	LD A,(BC)
 640++98CD 03           	INC BC
 641++98CE 03           	INC BC ;ignoring precalc delta to right sound
 642++98CF 03           	INC BC
 643++98D0 37           	SCF
 644++98D1 18 BF        	JR PD2_LP2
 645++98D3
 646++98D3 DD 77 F9     PD2_STOP LD (IX-12+CHP.TSlCnt),A
 647++98D6 18 BB        	JR PD2_LOOP
 648++98D8
 649++98D8 DD 77 09     PD2_REL	LD (IX-12+CHP.Flags),A
 650++98DB 18 2C        	JR PD2_EXIT
 651++98DD
 652++98DD 6F           PD2_NOTE LD L,A
 653++98DE DD 7E 06     	LD A,(IX-12+CHP.Note)
 654++98E1 32 F4 99     	LD (PrNote+1),A
 655++98E4 DD 75 06     	LD (IX-12+CHP.Note),L
 656++98E7 AF           	XOR A
 657++98E8 DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 658++98EB DD CB 09 C6  	SET 0,(IX-12+CHP.Flags)
 659++98EF 08           	EX AF,AF'
 660++98F0 30 16        	JR NC,NOGLIS2
 661++98F2 DD CB 09 56  	BIT 2,(IX-12+CHP.Flags)
 662++98F6 20 0C        	JR NZ,NOPORT2
 663++98F8 32 1A 9A     	LD (LoStep),A
 664++98FB 87           	ADD A,A
 665++98FC 9F           	SBC A,A
 666++98FD 08           	EX AF,AF'
 667++98FE 67           	LD H,A
 668++98FF 6F           	LD L,A
 669++9900 3C           	INC A
 670++9901 CD D5 99     	CALL SETPORT
 671++9904 DD 36 F9 01  NOPORT2	LD (IX-12+CHP.TSlCnt),1
 672++9908 AF           NOGLIS2	XOR A
 673++9909
 674++9909
 675++9909 DD 77 F5     PD2_EXIT LD (IX-12+CHP.PsInSm),A
 676++990C DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 677++990F DD 77 FA     	LD (IX-12+CHP.CrTnSl),A
 678++9912 DD 77 FB     	LD (IX-12+CHP.CrTnSl+1),A
 679++9915 C3 BA 99     	JP PD_FIN
 680++9918
 681++9918              ;PT3 pattern decoder
 682++9918 DD 36 08 00  PD_OrSm	LD (IX-12+CHP.Env_En),0
 683++991C CD BB 9A     	CALL SETORN
 684++991F 0A           PD_SAM_	LD A,(BC)
 685++9920 03           	INC BC
 686++9921 0F           	RRCA
 687++9922
 688++9922 CD DA 9A     PD_SAM	CALL SETSAM
 689++9925 18 3F        	JR PD_LOOP
 690++9927
 691++9927 0F           PD_VOL	RRCA
 692++9928 0F           	RRCA
 693++9929 0F           	RRCA
 694++992A 0F           	RRCA
 695++992B DD 77 10     	LD (IX-12+CHP.Volume),A
 696++992E 18 39        	JR PD_LP2
 697++9930
 698++9930 DD 77 08     PD_EOff	LD (IX-12+CHP.Env_En),A
 699++9933 DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 700++9936 18 31        	JR PD_LP2
 701++9938
 702++9938 3D           PD_SorE	DEC A
 703++9939 20 07        	JR NZ,PD_ENV
 704++993B 0A           	LD A,(BC)
 705++993C 03           	INC BC
 706++993D DD 77 05     	LD (IX-12+CHP.NNtSkp),A
 707++9940 18 27        	JR PD_LP2
 708++9942
 709++9942 CD A0 9A     PD_ENV	CALL SETENV
 710++9945 18 22        	JR PD_LP2
 711++9947
 712++9947 CD BB 9A     PD_ORN	CALL SETORN
 713++994A 18 1A        	JR PD_LOOP
 714++994C
 715++994C DD 77 08     PD_ESAM	LD (IX-12+CHP.Env_En),A
 716++994F DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 717++9952 C4 A0 9A     	CALL NZ,SETENV
 718++9955 18 C8        	JR PD_SAM_
 719++9957
 720++9957 DD 7E 06     PT3PD	LD A,(IX-12+CHP.Note)
 721++995A 32 F4 99     	LD (PrNote+1),A
 722++995D DD 6E FA     	LD L,(IX-12+CHP.CrTnSl)
 723++9960 DD 66 FB     	LD H,(IX-12+CHP.CrTnSl+1)
 724++9963 22 11 9A     	LD (PrSlide+1),HL
 725++9966
 726++9966 11 10 20     PD_LOOP	LD DE,#2010
 727++9969 0A           PD_LP2	LD A,(BC)
 728++996A 03           	INC BC
 729++996B 83           	ADD A,E
 730++996C 38 AA        	JR C,PD_OrSm
 731++996E 82           	ADD A,D
 732++996F 28 49        	JR Z,PD_FIN
 733++9971 38 AF        	JR C,PD_SAM
 734++9973 83           	ADD A,E
 735++9974 28 25        	JR Z,PD_REL
 736++9976 38 AF        	JR C,PD_VOL
 737++9978 83           	ADD A,E
 738++9979 28 B5        	JR Z,PD_EOff
 739++997B 38 BB        	JR C,PD_SorE
 740++997D C6 60        	ADD A,96
 741++997F 38 20        	JR C,PD_NOTE
 742++9981 83           	ADD A,E
 743++9982 38 C3        	JR C,PD_ORN
 744++9984 82           	ADD A,D
 745++9985 38 0F        	JR C,PD_NOIS
 746++9987 83           	ADD A,E
 747++9988 38 C2        	JR C,PD_ESAM
 748++998A 87           	ADD A,A
 749++998B 5F           	LD E,A
player.asm(750): warning: value 0x17A16 is truncated to 16bit value: 0x7A16
 750++998C 21 16 7A     	LD HL,SPCCOMS+#FF20-#2000
 751++998F 19           	ADD HL,DE
 752++9990 5E           	LD E,(HL)
 753++9991 23           	INC HL
 754++9992 56           	LD D,(HL)
 755++9993 D5           	PUSH DE
 756++9994 18 D0        	JR PD_LOOP
 757++9996
 758++9996 FD 77 10     PD_NOIS	LD (IY-100+VRS.Ns_Base),A
 759++9999 18 CE        	JR PD_LP2
 760++999B
 761++999B DD CB 09 86  PD_REL	RES 0,(IX-12+CHP.Flags)
 762++999F 18 08        	JR PD_RES
 763++99A1
 764++99A1 DD 77 06     PD_NOTE	LD (IX-12+CHP.Note),A
 765++99A4 DD CB 09 C6  	SET 0,(IX-12+CHP.Flags)
 766++99A8 AF           	XOR A
 767++99A9
 768++99A9 ED 73 B8 99  PD_RES	LD (PDSP_+1),SP
 769++99AD DD F9        	LD SP,IX
 770++99AF 67           	LD H,A
 771++99B0 6F           	LD L,A
 772++99B1 E5           	PUSH HL
 773++99B2 E5           	PUSH HL
 774++99B3 E5           	PUSH HL
 775++99B4 E5           	PUSH HL
 776++99B5 E5           	PUSH HL
 777++99B6 E5           	PUSH HL
 778++99B7 31 31 31     PDSP_	LD SP,#3131
 779++99BA
 780++99BA DD 7E 05     PD_FIN	LD A,(IX-12+CHP.NNtSkp)
 781++99BD DD 77 0F     	LD (IX-12+CHP.NtSkCn),A
 782++99C0 C9           	RET
 783++99C1
 784++99C1 0A           C_PORTM LD A,(BC)
 785++99C2 03           	INC BC
 786++99C3              ;SKIP PRECALCULATED TONE DELTA (BECAUSE
 787++99C3              ;CANNOT BE RIGHT AFTER PT3 COMPILATION)
 788++99C3 03           	INC BC
 789++99C4 03           	INC BC
 790++99C5 08           	EX AF,AF'
 791++99C6 0A           	LD A,(BC) ;SIGNED TONE STEP
 792++99C7 03           	INC BC
 793++99C8 32 1A 9A     	LD (LoStep),A
 794++99CB 0A           	LD A,(BC)
 795++99CC 03           	INC BC
 796++99CD A7           	AND A
 797++99CE 08           	EX AF,AF'
 798++99CF DD 6E FA     	LD L,(IX-12+CHP.CrTnSl)
 799++99D2 DD 66 FB     	LD H,(IX-12+CHP.CrTnSl+1)
 800++99D5
 801++99D5              ;Set portamento variables
 802++99D5              ;A - Delay; A' - Hi(Step); ZF' - (A'=0); HL - CrTnSl
 803++99D5
 804++99D5 DD CB 09 96  SETPORT	RES 2,(IX-12+CHP.Flags)
 805++99D9 DD 77 0A     	LD (IX-12+CHP.TnSlDl),A
 806++99DC DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 807++99DF E5           	PUSH HL
 808++99E0 11 99 A0     	LD DE,NT_
 809++99E3 DD 7E 06     	LD A,(IX-12+CHP.Note)
 810++99E6 DD 77 07     	LD (IX-12+CHP.SlToNt),A
 811++99E9 87           	ADD A,A
 812++99EA 6F           	LD L,A
 813++99EB 26 00        	LD H,0
 814++99ED 19           	ADD HL,DE
 815++99EE 7E           	LD A,(HL)
 816++99EF 23           	INC HL
 817++99F0 66           	LD H,(HL)
 818++99F1 6F           	LD L,A
 819++99F2 E5           	PUSH HL
 820++99F3 3E 3E        PrNote	LD A,#3E
 821++99F5 DD 77 06     	LD (IX-12+CHP.Note),A
 822++99F8 87           	ADD A,A
 823++99F9 6F           	LD L,A
 824++99FA 26 00        	LD H,0
 825++99FC 19           	ADD HL,DE
 826++99FD 5E           	LD E,(HL)
 827++99FE 23           	INC HL
 828++99FF 56           	LD D,(HL)
 829++9A00 E1           	POP HL
 830++9A01 ED 52        	SBC HL,DE
 831++9A03 DD 75 0D     	LD (IX-12+CHP.TnDelt),L
 832++9A06 DD 74 0E     	LD (IX-12+CHP.TnDelt+1),H
 833++9A09 D1           	POP DE
 834++9A0A              Version EQU $+1
 835++9A0A 3E 3E        	LD A,#3E
 836++9A0C FE 06        	CP 6
 837++9A0E 38 09        	JR C,OLDPRTM ;Old 3xxx for PT v3.5-
 838++9A10 11 11 11     PrSlide	LD DE,#1111
 839++9A13 DD 73 FA     	LD (IX-12+CHP.CrTnSl),E
 840++9A16 DD 72 FB     	LD (IX-12+CHP.CrTnSl+1),D
 841++9A19              LoStep	EQU $+1
 842++9A19 3E 3E        OLDPRTM	LD A,#3E
 843++9A1B 08           	EX AF,AF'
 844++9A1C 28 01        	JR Z,NOSIG
 845++9A1E EB           	EX DE,HL
 846++9A1F ED 52        NOSIG	SBC HL,DE
 847++9A21 F2 29 9A     	JP P,SET_STP
 848++9A24 2F           	CPL
 849++9A25 08           	EX AF,AF'
 850++9A26 ED 44        	NEG
 851++9A28 08           	EX AF,AF'
 852++9A29 DD 77 0C     SET_STP	LD (IX-12+CHP.TSlStp+1),A
 853++9A2C 08           	EX AF,AF'
 854++9A2D DD 77 0B     	LD (IX-12+CHP.TSlStp),A
 855++9A30 DD 36 FE 00  	LD (IX-12+CHP.COnOff),0
 856++9A34 C9           	RET
 857++9A35
 858++9A35 DD CB 09 D6  C_GLISS	SET 2,(IX-12+CHP.Flags)
 859++9A39 0A           	LD A,(BC)
 860++9A3A 03           	INC BC
 861++9A3B DD 77 0A     	LD (IX-12+CHP.TnSlDl),A
 862++9A3E A7           	AND A
 863++9A3F 20 07        	JR NZ,GL36
 864++9A41 3A 0B 9A     	LD A,(Version) ;AlCo PT3.7+
 865++9A44 FE 07        	CP 7
 866++9A46 9F           	SBC A,A
 867++9A47 3C           	INC A
 868++9A48 DD 77 F9     GL36	LD (IX-12+CHP.TSlCnt),A
 869++9A4B 0A           	LD A,(BC)
 870++9A4C 03           	INC BC
 871++9A4D 08           	EX AF,AF'
 872++9A4E 0A           	LD A,(BC)
 873++9A4F 03           	INC BC
 874++9A50 18 D7        	JR SET_STP
 875++9A52
 876++9A52 0A           C_SMPOS	LD A,(BC)
 877++9A53 03           	INC BC
 878++9A54 DD 77 F5     	LD (IX-12+CHP.PsInSm),A
 879++9A57 C9           	RET
 880++9A58
 881++9A58 0A           C_ORPOS	LD A,(BC)
 882++9A59 03           	INC BC
 883++9A5A DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 884++9A5D C9           	RET
 885++9A5E
 886++9A5E 0A           C_VIBRT	LD A,(BC)
 887++9A5F 03           	INC BC
 888++9A60 DD 77 FF     	LD (IX-12+CHP.OnOffD),A
 889++9A63 DD 77 FE     	LD (IX-12+CHP.COnOff),A
 890++9A66 0A           	LD A,(BC)
 891++9A67 03           	INC BC
 892++9A68 DD 77 00     	LD (IX-12+CHP.OffOnD),A
 893++9A6B AF           	XOR A
 894++9A6C DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 895++9A6F DD 77 FA     	LD (IX-12+CHP.CrTnSl),A
 896++9A72 DD 77 FB     	LD (IX-12+CHP.CrTnSl+1),A
 897++9A75 C9           	RET
 898++9A76
 899++9A76 0A           C_ENGLS	LD A,(BC)
 900++9A77 03           	INC BC
 901++9A78 FD 77 0E     	LD (IY-100+VRS.Env_Del),A
 902++9A7B FD 77 0F     	LD (IY-100+VRS.CurEDel),A
 903++9A7E 0A           	LD A,(BC)
 904++9A7F 03           	INC BC
 905++9A80 6F           	LD L,A
 906++9A81 0A           	LD A,(BC)
 907++9A82 03           	INC BC
 908++9A83 67           	LD H,A
 909++9A84 FD 75 0A     	LD (IY-100+VRS.ESldAdd),L
 910++9A87 FD 74 0B     	LD (IY-100+VRS.ESldAdd+1),H
 911++9A8A C9           	RET
 912++9A8B
 913++9A8B 0A           C_DELAY	LD A,(BC)
 914++9A8C 03           	INC BC
 915++9A8D FD 77 08     	LD (IY-100+VRS.Delay),A
 916++9A90 21 24 9F     	LD HL,VARS2+VRS.ModNum ;if AlCo_TS
 917++9A93 CB 4E        	BIT 1,(HL)
 918++9A95 C8           	RET Z
 919++9A96 32 07 9F     	LD (VARS1+VRS.Delay),A
 920++9A99 32 08 9F     	LD (VARS1+VRS.DelyCnt),A
 921++9A9C 32 8E 9F     	LD (VARS2+VRS.Delay),A
 922++9A9F C9           	RET
 923++9AA0
 924++9AA0 DD 73 08     SETENV	LD (IX-12+CHP.Env_En),E
 925++9AA3 FD 77 22     	LD (IY-100+VRS.AYREGS+EnvTp),A
 926++9AA6 0A           	LD A,(BC)
 927++9AA7 03           	INC BC
 928++9AA8 67           	LD H,A
 929++9AA9 0A           	LD A,(BC)
 930++9AAA 03           	INC BC
 931++9AAB 6F           	LD L,A
 932++9AAC CD 29 98     	CALL SETENBS
 933++9AAF AF           	XOR A
 934++9AB0 DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 935++9AB3 FD 77 0F     	LD (IY-100+VRS.CurEDel),A
 936++9AB6 67           	LD H,A
 937++9AB7 6F           	LD L,A
 938++9AB8 C3 30 98     	JP SETESLD
 939++9ABB
 940++9ABB 87           SETORN	ADD A,A
 941++9ABC 5F           	LD E,A
 942++9ABD 16 00        	LD D,0
 943++9ABF DD 72 F4     	LD (IX-12+CHP.PsInOr),D
 944++9AC2 FD 6E F8     	LD L,(IY-100+VRS.OrnPtrs)
 945++9AC5 FD 66 F9     	LD H,(IY-100+VRS.OrnPtrs+1)
 946++9AC8 19           	ADD HL,DE
 947++9AC9 5E           	LD E,(HL)
 948++9ACA 23           	INC HL
 949++9ACB 56           	LD D,(HL)
 950++9ACC FD 6E F6     	LD L,(IY-100+VRS.MODADDR)
 951++9ACF FD 66 F7     	LD H,(IY-100+VRS.MODADDR+1)
 952++9AD2 19           	ADD HL,DE
 953++9AD3 DD 75 01     	LD (IX-12+CHP.OrnPtr),L
 954++9AD6 DD 74 02     	LD (IX-12+CHP.OrnPtr+1),H
 955++9AD9 C9           C_NOP	RET
 956++9ADA
 957++9ADA 87           SETSAM	ADD A,A
 958++9ADB 5F           	LD E,A
 959++9ADC 16 00        	LD D,0
 960++9ADE FD 6E FA     	LD L,(IY-100+VRS.SamPtrs);
 961++9AE1 FD 66 FB     	LD H,(IY-100+VRS.SamPtrs+1);
 962++9AE4 19           	ADD HL,DE
 963++9AE5 5E           	LD E,(HL)
 964++9AE6 23           	INC HL
 965++9AE7 56           	LD D,(HL)
 966++9AE8 FD 6E F6     	LD L,(IY-100+VRS.MODADDR)
 967++9AEB FD 66 F7     	LD H,(IY-100+VRS.MODADDR+1)
 968++9AEE 19           	ADD HL,DE
 969++9AEF DD 75 03     	LD (IX-12+CHP.SamPtr),L
 970++9AF2 DD 74 04     	LD (IX-12+CHP.SamPtr+1),H
 971++9AF5 C9           	RET
 972++9AF6
 973++9AF6              ;ALL 16 ADDRESSES TO PROTECT FROM BROKEN PT3 MODULES
 974++9AF6 D9 9A        SPCCOMS DW C_NOP
 975++9AF8 35 9A        	DW C_GLISS
 976++9AFA C1 99        	DW C_PORTM
 977++9AFC 52 9A        	DW C_SMPOS
 978++9AFE 58 9A        	DW C_ORPOS
 979++9B00 5E 9A        	DW C_VIBRT
 980++9B02 D9 9A        	DW C_NOP
 981++9B04 D9 9A        	DW C_NOP
 982++9B06 76 9A        	DW C_ENGLS
 983++9B08 8B 9A        	DW C_DELAY
 984++9B0A D9 9A        	DW C_NOP
 985++9B0C D9 9A        	DW C_NOP
 986++9B0E D9 9A        	DW C_NOP
 987++9B10 D9 9A        	DW C_NOP
 988++9B12 D9 9A        	DW C_NOP
 989++9B14 D9 9A        	DW C_NOP
 990++9B16
 991++9B16 CD 37 98     CHREGS	CALL GETIX
 992++9B19 AF           	XOR A
 993++9B1A 32 56 9D     	LD (Ampl),A
 994++9B1D DD CB 15 46  	BIT 0,(IX+CHP.Flags)
 995++9B21 E5           	PUSH HL
 996++9B22 CA 69 9C     	JP Z,CH_EXIT
 997++9B25 ED 73 B3 9B  	LD (CSP_+1),SP
 998++9B29 DD 6E 0D     	LD L,(IX+CHP.OrnPtr)
 999++9B2C DD 66 0E     	LD H,(IX+CHP.OrnPtr+1)
1000++9B2F F9           	LD SP,HL
1001++9B30 D1           	POP DE
1002++9B31 67           	LD H,A
1003++9B32 DD 7E 00     	LD A,(IX+CHP.PsInOr)
1004++9B35 6F           	LD L,A
1005++9B36 39           	ADD HL,SP
1006++9B37 3C           	INC A
1007++9B38              		;PT2	PT3
1008++9B38 3C           OrnCP	INC A	;CP E	CP D
1009++9B39 38 01        	JR C,CH_ORPS
1010++9B3B 01           OrnLD	DB 1	;LD A,D	LD A,E
1011++9B3C DD 77 00     CH_ORPS	LD (IX+CHP.PsInOr),A
1012++9B3F DD 7E 12     	LD A,(IX+CHP.Note)
1013++9B42 86           	ADD A,(HL)
1014++9B43 F2 47 9B     	JP P,CH_NTP
1015++9B46 AF           	XOR A
1016++9B47 FE 60        CH_NTP	CP 96
1017++9B49 38 02        	JR C,CH_NOK
1018++9B4B 3E 5F        	LD A,95
1019++9B4D 87           CH_NOK	ADD A,A
1020++9B4E 08           	EX AF,AF'
1021++9B4F DD 6E 0F     	LD L,(IX+CHP.SamPtr)
1022++9B52 DD 66 10     	LD H,(IX+CHP.SamPtr+1)
1023++9B55 F9           	LD SP,HL
1024++9B56 D1           	POP DE
1025++9B57 26 00        	LD H,0
1026++9B59 DD 7E 01     	LD A,(IX+CHP.PsInSm)
1027++9B5C 47           	LD B,A
1028++9B5D 87           	ADD A,A
1029++9B5E 87           SamClc2	ADD A,A ;or ADD A,B for PT2
1030++9B5F 6F           	LD L,A
1031++9B60 39           	ADD HL,SP
1032++9B61 F9           	LD SP,HL
1033++9B62 78           	LD A,B
1034++9B63 3C           	INC A
1035++9B64              		;PT2	PT3
1036++9B64 3C           SamCP	INC A	;CP E	CP D
1037++9B65 38 01        	JR C,CH_SMPS
1038++9B67 01           SamLD	DB 1	;LD A,D	LD A,E
1039++9B68 DD 77 01     CH_SMPS	LD (IX+CHP.PsInSm),A
1040++9B6B C1           	POP BC
1041++9B6C E1           	POP HL
1042++9B6D
1043++9B6D              ;Convert PT2 sample to PT3
1044++9B6D              		;PT2		PT3
1045++9B6D E1           SamCnv	POP HL  ;BIT 2,C	JR e_
1046++9B6E E1           	POP HL
1047++9B6F 60           	LD H,B
1048++9B70 20 06        	JR NZ,$+8
1049++9B72 EB           	EX DE,HL
1050++9B73 A7           	AND A
1051++9B74 ED 62        	SBC HL,HL
1052++9B76 ED 52        	SBC HL,DE
1053++9B78 51           	LD D,C
1054++9B79 CB 19        	RR C
1055++9B7B 9F           	SBC A,A
1056++9B7C 2F           	CPL
1057++9B7D E6 3E        	AND #3E
1058++9B7F CB 19        	RR C
1059++9B81 CB 18        	RR B
1060++9B83 A1           	AND C
1061++9B84 4F           	LD C,A
1062++9B85 78           	LD A,B
1063++9B86 1F           	RRA
1064++9B87 1F           	RRA
1065++9B88 CB 1A        	RR D
1066++9B8A 1F           	RRA
1067++9B8B E6 9F        	AND #9F
1068++9B8D 47           	LD B,A
1069++9B8E
1070++9B8E DD 5E 08     e_	LD E,(IX+CHP.TnAcc)
1071++9B91 DD 56 09     	LD D,(IX+CHP.TnAcc+1)
1072++9B94 19           	ADD HL,DE
1073++9B95 CB 70        	BIT 6,B
1074++9B97 28 06        	JR Z,CH_NOAC
1075++9B99 DD 75 08     	LD (IX+CHP.TnAcc),L
1076++9B9C DD 74 09     	LD (IX+CHP.TnAcc+1),H
1077++9B9F EB           CH_NOAC EX DE,HL
1078++9BA0 08           	EX AF,AF'
player.asm(1079): warning: value 0xA099 is truncated to 8bit value: 0x99
1079++9BA1 C6 99        	ADD A,NT_
1080++9BA3 6F           	LD L,A
1081++9BA4 CE A0        	ADC A,NT_/256
1082++9BA6 95           	SUB L
1083++9BA7 67           	LD H,A
1084++9BA8 F9           	LD SP,HL
1085++9BA9 E1           	POP HL
1086++9BAA 19           	ADD HL,DE
1087++9BAB DD 5E 06     	LD E,(IX+CHP.CrTnSl)
1088++9BAE DD 56 07     	LD D,(IX+CHP.CrTnSl+1)
1089++9BB1 19           	ADD HL,DE
1090++9BB2 31 31 31     CSP_	LD SP,#3131
1091++9BB5 E3           	EX (SP),HL
1092++9BB6 AF           	XOR A
1093++9BB7 DD B6 05     	OR (IX+CHP.TSlCnt)
1094++9BBA 28 3E        	JR Z,CH_AMP
1095++9BBC DD 35 05     	DEC (IX+CHP.TSlCnt)
1096++9BBF 20 39        	JR NZ,CH_AMP
1097++9BC1 DD 7E 16     	LD A,(IX+CHP.TnSlDl)
1098++9BC4 DD 77 05     	LD (IX+CHP.TSlCnt),A
1099++9BC7 DD 6E 17     	LD L,(IX+CHP.TSlStp)
1100++9BCA DD 66 18     	LD H,(IX+CHP.TSlStp+1)
1101++9BCD 7C           	LD A,H
1102++9BCE 19           	ADD HL,DE
1103++9BCF DD 75 06     	LD (IX+CHP.CrTnSl),L
1104++9BD2 DD 74 07     	LD (IX+CHP.CrTnSl+1),H
1105++9BD5 DD CB 15 56  	BIT 2,(IX+CHP.Flags)
1106++9BD9 20 1F        	JR NZ,CH_AMP
1107++9BDB DD 5E 19     	LD E,(IX+CHP.TnDelt)
1108++9BDE DD 56 1A     	LD D,(IX+CHP.TnDelt+1)
1109++9BE1 A7           	AND A
1110++9BE2 28 01        	JR Z,CH_STPP
1111++9BE4 EB           	EX DE,HL
1112++9BE5 ED 52        CH_STPP SBC HL,DE
1113++9BE7 FA FA 9B     	JP M,CH_AMP
1114++9BEA DD 7E 13     	LD A,(IX+CHP.SlToNt)
1115++9BED DD 77 12     	LD (IX+CHP.Note),A
1116++9BF0 AF           	XOR A
1117++9BF1 DD 77 05     	LD (IX+CHP.TSlCnt),A
1118++9BF4 DD 77 06     	LD (IX+CHP.CrTnSl),A
1119++9BF7 DD 77 07     	LD (IX+CHP.CrTnSl+1),A
1120++9BFA DD 7E 02     CH_AMP	LD A,(IX+CHP.CrAmSl)
1121++9BFD CB 79        	BIT 7,C
1122++9BFF 28 13        	JR Z,CH_NOAM
1123++9C01 CB 71        	BIT 6,C
1124++9C03 28 07        	JR Z,CH_AMIN
1125++9C05 FE 0F        	CP 15
1126++9C07 28 0B        	JR Z,CH_NOAM
1127++9C09 3C           	INC A
1128++9C0A 18 05        	JR CH_SVAM
1129++9C0C FE F1        CH_AMIN	CP -15
1130++9C0E 28 04        	JR Z,CH_NOAM
1131++9C10 3D           	DEC A
1132++9C11 DD 77 02     CH_SVAM	LD (IX+CHP.CrAmSl),A
1133++9C14 6F           CH_NOAM	LD L,A
1134++9C15 78           	LD A,B
1135++9C16 E6 0F        	AND 15
1136++9C18 85           	ADD A,L
1137++9C19 F2 1D 9C     	JP P,CH_APOS
1138++9C1C AF           	XOR A
1139++9C1D FE 10        CH_APOS	CP 16
1140++9C1F 38 02        	JR C,CH_VOL
1141++9C21 3E 0F        	LD A,15
1142++9C23 DD B6 1C     CH_VOL	OR (IX+CHP.Volume)
player.asm(1143): warning: value 0x9F99 is truncated to 8bit value: 0x99
1143++9C26 C6 99        	ADD A,VT_
1144++9C28 6F           	LD L,A
1145++9C29 CE 9F        	ADC A,VT_/256
1146++9C2B 95           	SUB L
1147++9C2C 67           	LD H,A
1148++9C2D 7E           	LD A,(HL)
1149++9C2E CB 41        CH_ENV	BIT 0,C
1150++9C30 20 03        	JR NZ,CH_NOEN
1151++9C32 DD B6 14     	OR (IX+CHP.Env_En)
1152++9C35 32 56 9D     CH_NOEN	LD (Ampl),A
1153++9C38 CB 78        	BIT 7,B
1154++9C3A 79           	LD A,C
1155++9C3B 28 1A        	JR Z,NO_ENSL
1156++9C3D 17           	RLA
1157++9C3E 17           	RLA
1158++9C3F CB 2F        	SRA A
1159++9C41 CB 2F        	SRA A
1160++9C43 CB 2F        	SRA A
1161++9C45 DD 86 04     	ADD A,(IX+CHP.CrEnSl) ;SEE COMMENT BELOW
1162++9C48 CB 68        	BIT 5,B
1163++9C4A 28 03        	JR Z,NO_ENAC
1164++9C4C DD 77 04     	LD (IX+CHP.CrEnSl),A
1165++9C4F FD 86 12     NO_ENAC	ADD A,(IY-100+VRS.AddToEn) ;BUG IN PT3 - NEED WORD HERE
1166++9C52 FD 77 12     	LD (IY-100+VRS.AddToEn),A
1167++9C55 18 0E        	JR CH_MIX
1168++9C57 1F           NO_ENSL RRA
1169++9C58 DD 86 03     	ADD A,(IX+CHP.CrNsSl)
1170++9C5B FD 77 11     	LD (IY-100+VRS.AddToNs),A
1171++9C5E CB 68        	BIT 5,B
1172++9C60 28 03        	JR Z,CH_MIX
1173++9C62 DD 77 03     	LD (IX+CHP.CrNsSl),A
1174++9C65 78           CH_MIX	LD A,B
1175++9C66 1F           	RRA
1176++9C67 E6 48        	AND #48
1177++9C69 FD B6 1C     CH_EXIT	OR (IY-100+VRS.AYREGS+Mixer)
1178++9C6C 0F           	RRCA
1179++9C6D FD 77 1C     	LD (IY-100+VRS.AYREGS+Mixer),A
1180++9C70 E1           	POP HL
1181++9C71 AF           	XOR A
1182++9C72 DD B6 0A     	OR (IX+CHP.COnOff)
1183++9C75 C8           	RET Z
1184++9C76 DD 35 0A     	DEC (IX+CHP.COnOff)
1185++9C79 C0           	RET NZ
1186++9C7A DD AE 15     	XOR (IX+CHP.Flags)
1187++9C7D DD 77 15     	LD (IX+CHP.Flags),A
1188++9C80 1F           	RRA
1189++9C81 DD 7E 0B     	LD A,(IX+CHP.OnOffD)
1190++9C84 38 03        	JR C,CH_ONDL
1191++9C86 DD 7E 0C     	LD A,(IX+CHP.OffOnD)
1192++9C89 DD 77 0A     CH_ONDL	LD (IX+CHP.COnOff),A
1193++9C8C C9           	RET
1194++9C8D
1195++9C8D AF           PLAY_	XOR A
1196++9C8E FD 77 12     	LD (IY-100+VRS.AddToEn),A
1197++9C91 FD 77 1C     	LD (IY-100+VRS.AYREGS+Mixer),A
1198++9C94 3D           	DEC A
1199++9C95 FD 77 22     	LD (IY-100+VRS.AYREGS+EnvTp),A
1200++9C98 FD 35 09     	DEC (IY-100+VRS.DelyCnt)
1201++9C9B C2 43 9D     	JP NZ,PL2
1202++9C9E FD 35 BA     	DEC (IY-100+VRS.ChanA+CHP.NtSkCn)
1203++9CA1 20 6C        	JR NZ,PL1B
1204++9CA3 FD 4E FE     	LD C,(IY-100+VRS.AdInPtA)
1205++9CA6 FD 46 FF     	LD B,(IY-100+VRS.AdInPtA+1)
1206++9CA9 0A           	LD A,(BC)
1207++9CAA A7           	AND A
1208++9CAB 20 56        	JR NZ,PL1A
1209++9CAD 57           	LD D,A
1210++9CAE FD 77 10     	LD (IY-100+VRS.Ns_Base),A
1211++9CB1 FD 6E 04     	LD L,(IY-100+VRS.CrPsPtr)
1212++9CB4 FD 66 05     	LD H,(IY-100+VRS.CrPsPtr+1)
1213++9CB7 23           	INC HL
1214++9CB8 7E           	LD A,(HL)
1215++9CB9 3C           	INC A
1216++9CBA 20 0B        	JR NZ,PLNLP
1217++9CBC
1218++9CBC              	IF LoopChecker
1219++9CBC CD 6E 95     	CALL CHECKLP
1220++9CBF              	ENDIF
1221++9CBF
1222++9CBF FD 6E 06     	LD L,(IY-100+VRS.LPosPtr)
1223++9CC2 FD 66 07     	LD H,(IY-100+VRS.LPosPtr+1)
1224++9CC5 7E           	LD A,(HL)
1225++9CC6 3C           	INC A
1226++9CC7 CD 1B 98     PLNLP	CALL SETCPPT
1227++9CCA 3D           	DEC A
1228++9CCB FD CB 9E 4E  	BIT 1,(IY-100+VRS.ModNum)
1229++9CCF 28 03        	JR Z,NoAlCo
1230++9CD1              TSSub	EQU $+1
1231++9CD1 D6 D6        	SUB #D6
1232++9CD3 2F           	CPL
1233++9CD4              NoAlCo
1234++9CD4              		;PT2		PT3
1235++9CD4 3D           PsCalc	DEC A	;ADD A,A	NOP
1236++9CD5 3D           	DEC A	;ADD A,(HL)	NOP
1237++9CD6 87           	ADD A,A
1238++9CD7 5F           	LD E,A
1239++9CD8 CB 12        	RL D
1240++9CDA
1241++9CDA              	IF CurPosCounter
1242++9CDA ~            	LD A,L
1243++9CDA ~            	SUB (IY-100+VRS.PosSub)
1244++9CDA ~            	LD (IY-100+VRS.CurPos),A
1245++9CDA              	ENDIF
1246++9CDA
1247++9CDA FD 6E FC     	LD L,(IY-100+VRS.PatsPtr)
1248++9CDD FD 66 FD     	LD H,(IY-100+VRS.PatsPtr+1)
1249++9CE0 19           	ADD HL,DE
1250++9CE1 FD 5E F6     	LD E,(IY-100+VRS.MODADDR)
1251++9CE4 FD 56 F7     	LD D,(IY-100+VRS.MODADDR+1)
1252++9CE7 ED 73 01 9D  	LD (PSP_+1),SP
1253++9CEB F9           	LD SP,HL
1254++9CEC E1           	POP HL
1255++9CED 19           	ADD HL,DE
1256++9CEE 44           	LD B,H
1257++9CEF 4D           	LD C,L
1258++9CF0 E1           	POP HL
1259++9CF1 19           	ADD HL,DE
1260++9CF2 FD 75 00     	LD (IY-100+VRS.AdInPtB),L
1261++9CF5 FD 74 01     	LD (IY-100+VRS.AdInPtB+1),H
1262++9CF8 E1           	POP HL
1263++9CF9 19           	ADD HL,DE
1264++9CFA FD 75 02     	LD (IY-100+VRS.AdInPtC),L
1265++9CFD FD 74 03     	LD (IY-100+VRS.AdInPtC+1),H
1266++9D00 31 31 31     PSP_	LD SP,#3131
1267++9D03 11 AB FF     PL1A	LD DE,VRS.ChanA+12-100
1268++9D06 CD 3E 98     	CALL PTDECOD
1269++9D09 FD 71 FE     	LD (IY-100+VRS.AdInPtA),C
1270++9D0C FD 70 FF     	LD (IY-100+VRS.AdInPtA+1),B
1271++9D0F
1272++9D0F FD 35 D7     PL1B	DEC (IY-100+VRS.ChanB+CHP.NtSkCn)
1273++9D12 20 12        	JR NZ,PL1C
1274++9D14 11 C8 FF     	LD DE,VRS.ChanB+12-100
1275++9D17 FD 4E 00     	LD C,(IY-100+VRS.AdInPtB)
1276++9D1A FD 46 01     	LD B,(IY-100+VRS.AdInPtB+1)
1277++9D1D CD 3E 98     	CALL PTDECOD
1278++9D20 FD 71 00     	LD (IY-100+VRS.AdInPtB),C
1279++9D23 FD 70 01     	LD (IY-100+VRS.AdInPtB+1),B
1280++9D26
1281++9D26 FD 35 F4     PL1C	DEC (IY-100+VRS.ChanC+CHP.NtSkCn)
1282++9D29 20 12        	JR NZ,PL1D
1283++9D2B 11 E5 FF     	LD DE,VRS.ChanC+12-100
1284++9D2E FD 4E 02     	LD C,(IY-100+VRS.AdInPtC)
1285++9D31 FD 46 03     	LD B,(IY-100+VRS.AdInPtC+1)
1286++9D34 CD 3E 98     	CALL PTDECOD
1287++9D37 FD 71 02     	LD (IY-100+VRS.AdInPtC),C
1288++9D3A FD 70 03     	LD (IY-100+VRS.AdInPtC+1),B
1289++9D3D
1290++9D3D FD 7E 08     PL1D	LD A,(IY-100+VRS.Delay)
1291++9D40 FD 77 09     	LD (IY-100+VRS.DelyCnt),A
1292++9D43
1293++9D43 11 9F FF     PL2	LD DE,VRS.ChanA-100
1294++9D46 FD 6E 15     	LD L,(IY-100+VRS.AYREGS+TonA)
1295++9D49 FD 66 16     	LD H,(IY-100+VRS.AYREGS+TonA+1)
1296++9D4C CD 16 9B     	CALL CHREGS
1297++9D4F FD 75 15     	LD (IY-100+VRS.AYREGS+TonA),L
1298++9D52 FD 74 16     	LD (IY-100+VRS.AYREGS+TonA+1),H
1299++9D55              Ampl	EQU $+1
1300++9D55 3E 3E        	LD A,#3E
1301++9D57 FD 77 1D     	LD (IY-100+VRS.AYREGS+AmplA),A
1302++9D5A 11 BC FF     	LD DE,VRS.ChanB-100
1303++9D5D FD 6E 17     	LD L,(IY-100+VRS.AYREGS+TonB)
1304++9D60 FD 66 18     	LD H,(IY-100+VRS.AYREGS+TonB+1)
1305++9D63 CD 16 9B     	CALL CHREGS
1306++9D66 FD 75 17     	LD (IY-100+VRS.AYREGS+TonB),L
1307++9D69 FD 74 18     	LD (IY-100+VRS.AYREGS+TonB+1),H
1308++9D6C 3A 56 9D     	LD A,(Ampl)
1309++9D6F FD 77 1E     	LD (IY-100+VRS.AYREGS+AmplB),A
1310++9D72 11 D9 FF     	LD DE,VRS.ChanC-100
1311++9D75 FD 6E 19     	LD L,(IY-100+VRS.AYREGS+TonC)
1312++9D78 FD 66 1A     	LD H,(IY-100+VRS.AYREGS+TonC+1)
1313++9D7B CD 16 9B     	CALL CHREGS
1314++9D7E FD 75 19     	LD (IY-100+VRS.AYREGS+TonC),L
1315++9D81 FD 74 1A     	LD (IY-100+VRS.AYREGS+TonC+1),H
1316++9D84 3A 56 9D     	LD A,(Ampl)
1317++9D87 FD 77 1F     	LD (IY-100+VRS.AYREGS+AmplC),A
1318++9D8A
1319++9D8A FD 7E 10     	LD A,(IY-100+VRS.Ns_Base)
1320++9D8D FD 86 11     	ADD (IY-100+VRS.AddToNs)
1321++9D90 FD 77 1B     	LD (IY-100+VRS.AYREGS+Noise),A
1322++9D93
1323++9D93 FD 7E 12     	LD A,(IY-100+VRS.AddToEn)
1324++9D96 5F           	LD E,A
1325++9D97 87           	ADD A,A
1326++9D98 9F           	SBC A,A
1327++9D99 57           	LD D,A
1328++9D9A FD 6E 13     	LD L,(IY-100+VRS.EnvBase)
1329++9D9D FD 66 14     	LD H,(IY-100+VRS.EnvBase+1)
1330++9DA0 19           	ADD HL,DE
1331++9DA1 FD 5E 0C     	LD E,(IY-100+VRS.CurESld)
1332++9DA4 FD 56 0D     	LD D,(IY-100+VRS.CurESld+1)
1333++9DA7 19           	ADD HL,DE
1334++9DA8 FD 75 20     	LD (IY-100+VRS.AYREGS+Env),L
1335++9DAB FD 74 21     	LD (IY-100+VRS.AYREGS+Env+1),H
1336++9DAE
1337++9DAE AF           	XOR A
1338++9DAF FD B6 0F     	OR (IY-100+VRS.CurEDel)
1339++9DB2 C8           	RET Z
1340++9DB3 FD 35 0F     	DEC (IY-100+VRS.CurEDel)
1341++9DB6 C0           	RET NZ
1342++9DB7 FD 7E 0E     	LD A,(IY-100+VRS.Env_Del)
1343++9DBA FD 77 0F     	LD (IY-100+VRS.CurEDel),A
1344++9DBD FD 6E 0A     	LD L,(IY-100+VRS.ESldAdd)
1345++9DC0 FD 66 0B     	LD H,(IY-100+VRS.ESldAdd+1)
1346++9DC3 19           	ADD HL,DE
1347++9DC4 C3 30 98     	JP SETESLD
1348++9DC7
1349++9DC7 FD 21 FF 9E  PLAY    LD IY,VARS1+100
1350++9DCB CD 8D 9C     	CALL PLAY_
1351++9DCE 3A 9A 9E     	LD A,(is_ts)
1352++9DD1 A7           	AND A
1353++9DD2 28 07        	JR Z,PL_nts
1354++9DD4 FD 21 86 9F  	LD IY,VARS2+100
1355++9DD8 CD 8D 9C     	CALL PLAY_
1356++9DDB              PL_nts
1357++9DDB              	IF Basic
1358++9DDB FD 21 3A 5C  	LD IY,#5C3A
1359++9DDF              	ENDIF
1360++9DDF
1361++9DDF 01 FD FF     ROUT	LD BC,#FFFD
1362++9DE2 3A 9A 9E     	LD A,(is_ts)
1363++9DE5 A7           	AND A
1364++9DE6 28 02        	JR Z,r_nts ;keep old standard
1365++9DE8 ED 41        	OUT (C),B
1366++9DEA 08           r_nts	EX AF,AF'
1367++9DEB
1368++9DEB              	IF ACBBAC
1369++9DEB ~            	LD IX,VARS1+VRS.AYREGS
1370++9DEB              	ELSE
1371++9DEB 21 14 9F     	LD HL,VARS1+VRS.AYREGS
1372++9DEE              	ENDIF
1373++9DEE
1374++9DEE CD FA 9D     	CALL ROUT_
1375++9DF1 08           	EX AF,AF'
1376++9DF2 C8           	RET Z
1377++9DF3 42           	LD B,D
1378++9DF4 2F           	CPL
1379++9DF5 ED 79        	OUT (C),A
1380++9DF7
1381++9DF7              	IF ACBBAC
1382++9DF7 ~            	LD IX,VARS2+VRS.AYREGS
1383++9DF7              	ELSE
1384++9DF7 21 9B 9F     	LD HL,VARS2+VRS.AYREGS
1385++9DFA              	ENDIF
1386++9DFA
1387++9DFA              ROUT_
1388++9DFA              	IF ACBBAC
1389++9DFA ~            	LD A,(SETUP)
1390++9DFA ~            	AND 12
1391++9DFA ~            	JR Z,ABC
1392++9DFA ~            	ADD A,CHTABLE
1393++9DFA ~            	LD E,A
1394++9DFA ~            	ADC A,CHTABLE/256
1395++9DFA ~            	SUB E
1396++9DFA ~            	LD D,A
1397++9DFA ~            	LD B,0
1398++9DFA ~            	PUSH IX
1399++9DFA ~            	POP HL
1400++9DFA ~            	LD A,(DE)
1401++9DFA ~            	INC DE
1402++9DFA ~            	LD C,A
1403++9DFA ~            	ADD HL,BC
1404++9DFA ~            	LD A,(IX+TonB)
1405++9DFA ~            	LD C,(HL)
1406++9DFA ~            	LD (IX+TonB),C
1407++9DFA ~            	LD (HL),A
1408++9DFA ~            	INC HL
1409++9DFA ~            	LD A,(IX+TonB+1)
1410++9DFA ~            	LD C,(HL)
1411++9DFA ~            	LD (IX+TonB+1),C
1412++9DFA ~            	LD (HL),A
1413++9DFA ~            	LD A,(DE)
1414++9DFA ~            	INC DE
1415++9DFA ~            	LD C,A
1416++9DFA ~            	ADD HL,BC
1417++9DFA ~            	LD A,(IX+AmplB)
1418++9DFA ~            	LD C,(HL)
1419++9DFA ~            	LD (IX+AmplB),C
1420++9DFA ~            	LD (HL),A
1421++9DFA ~            	LD A,(DE)
1422++9DFA ~            	INC DE
1423++9DFA ~            	LD (RxCA1),A
1424++9DFA ~            	XOR 8
1425++9DFA ~            	LD (RxCA2),A
1426++9DFA ~            	LD A,(DE)
1427++9DFA ~            	AND (IX+Mixer)
1428++9DFA ~            	LD E,A
1429++9DFA ~            	LD A,(IX+Mixer)
1430++9DFA ~            RxCA1	DB #E6
1431++9DFA ~            	AND %010010
1432++9DFA ~            	OR E
1433++9DFA ~            	LD E,A
1434++9DFA ~            	LD A,(IX+Mixer)
1435++9DFA ~            	AND %010010
1436++9DFA ~            RxCA2	OR E
1437++9DFA ~            	OR E
1438++9DFA ~            	LD (IX+Mixer),A
1439++9DFA ~            ABC
1440++9DFA              	ENDIF
1441++9DFA
1442++9DFA AF           	XOR A
1443++9DFB 11 BF FF     	LD DE,#FFBF
1444++9DFE
1445++9DFE              	IF ACBBAC
1446++9DFE ~            	LD BC,#FFFD
1447++9DFE ~            	PUSH IX
1448++9DFE ~            	POP HL
1449++9DFE              	ENDIF
1450++9DFE
1451++9DFE ED 79        LOUT	OUT (C),A
1452++9E00 43           	LD B,E
1453++9E01 ED A3        	OUTI
1454++9E03 42           	LD B,D
1455++9E04 3C           	INC A
1456++9E05 FE 0D        	CP 13
1457++9E07 20 F5        	JR NZ,LOUT
1458++9E09 ED 79        	OUT (C),A
1459++9E0B 7E           	LD A,(HL)
1460++9E0C A7           	AND A
1461++9E0D F8           	RET M
1462++9E0E 43           	LD B,E
1463++9E0F ED 79        	OUT (C),A
1464++9E11 C9           	RET
1465++9E12
1466++9E12              	IF ACBBAC
1467++9E12 ~            CHTABLE	EQU $-4
1468++9E12 ~            	DB 4,5,15,%001001,0,7,7,%100100
1469++9E12              	ENDIF
1470++9E12
1471++9E12 64           NT_DATA	DB (T_NEW_0-T1_)*2
1472++9E13 2A           	DB TCNEW_0-T_
1473++9E14 65           	DB (T_OLD_0-T1_)*2+1
1474++9E15 00           	DB TCOLD_0-T_
1475++9E16 01           	DB (T_NEW_1-T1_)*2+1
1476++9E17 0C           	DB TCNEW_1-T_
1477++9E18 01           	DB (T_OLD_1-T1_)*2+1
1478++9E19 0C           	DB TCOLD_1-T_
1479++9E1A 94           	DB (T_NEW_2-T1_)*2
1480++9E1B 35           	DB TCNEW_2-T_
1481++9E1C 30           	DB (T_OLD_2-T1_)*2
1482++9E1D 0E           	DB TCOLD_2-T_
1483++9E1E 60           	DB (T_NEW_3-T1_)*2
1484++9E1F 20           	DB TCNEW_3-T_
1485++9E20 60           	DB (T_OLD_3-T1_)*2
1486++9E21 21           	DB TCOLD_3-T_
1487++9E22
1488++9E22              T_
1489++9E22
1490++9E22 01 05 09 0B  TCOLD_0	DB #00+1,#04+1,#08+1,#0A+1,#0C+1,#0E+1,#12+1,#14+1
1490++9E26 0D 0F 13 15
1491++9E2A 19 25 3D 00  	DB #18+1,#24+1,#3C+1,0
1492++9E2E 5D 00        TCOLD_1	DB #5C+1,0
1493++9E30 31 37 4D 53  TCOLD_2	DB #30+1,#36+1,#4C+1,#52+1,#5E+1,#70+1,#82,#8C,#9C
1493++9E34 5F 71 82 8C
1493++9E38 9C
1494++9E39 9E A0 A6 A8  	DB #9E,#A0,#A6,#A8,#AA,#AC,#AE,#AE,0
1494++9E3D AA AC AE AE
1494++9E41 00
1495++9E42 57           TCNEW_3	DB #56+1
1496++9E43 1F 23 25 29  TCOLD_3	DB #1E+1,#22+1,#24+1,#28+1,#2C+1,#2E+1,#32+1,#BE+1,0
1496++9E47 2D 2F 33 BF
1496++9E4B 00
1497++9E4C 1D 21 23 27  TCNEW_0	DB #1C+1,#20+1,#22+1,#26+1,#2A+1,#2C+1,#30+1,#54+1
1497++9E50 2B 2D 31 55
1498++9E54 BD BF 00     	DB #BC+1,#BE+1,0
1499++9E57              TCNEW_1 EQU TCOLD_1
1500++9E57 1B 21 25 29  TCNEW_2	DB #1A+1,#20+1,#24+1,#28+1,#2A+1,#3A+1,#4C+1,#5E+1
1500++9E5B 2B 3B 4D 5F
1501++9E5F BB BD BF 00  	DB #BA+1,#BC+1,#BE+1,0
1502++9E63
1503++9E63              PT3EMPTYORN EQU $-1
1504++9E63 01 00        	DB 1,0
1505++9E65
1506++9E65              ;first 12 values of tone tables (packed)
1507++9E65
player.asm(1508): warning: value 0xDD8 is truncated to 8bit value: 0xD8
1508++9E65 0D D8        T_PACK	DB #06EC*2/256,#06EC*2
1509++9E67 69           	DB #0755-#06EC
1510++9E68 70           	DB #07C5-#0755
1511++9E69 76           	DB #083B-#07C5
1512++9E6A 7D           	DB #08B8-#083B
1513++9E6B 85           	DB #093D-#08B8
1514++9E6C 8D           	DB #09CA-#093D
1515++9E6D 95           	DB #0A5F-#09CA
1516++9E6E 9D           	DB #0AFC-#0A5F
1517++9E6F A8           	DB #0BA4-#0AFC
1518++9E70 B1           	DB #0C55-#0BA4
1519++9E71 BB           	DB #0D10-#0C55
player.asm(1520): warning: value 0xCDA is truncated to 8bit value: 0xDA
1520++9E72 0C DA        	DB #066D*2/256,#066D*2
1521++9E74 62           	DB #06CF-#066D
1522++9E75 68           	DB #0737-#06CF
1523++9E76 6D           	DB #07A4-#0737
1524++9E77 75           	DB #0819-#07A4
1525++9E78 7B           	DB #0894-#0819
1526++9E79 83           	DB #0917-#0894
1527++9E7A 8A           	DB #09A1-#0917
1528++9E7B 92           	DB #0A33-#09A1
1529++9E7C 9C           	DB #0ACF-#0A33
1530++9E7D A4           	DB #0B73-#0ACF
1531++9E7E AF           	DB #0C22-#0B73
1532++9E7F B8           	DB #0CDA-#0C22
player.asm(1533): warning: value 0xE08 is truncated to 8bit value: 0x08
1533++9E80 0E 08        	DB #0704*2/256,#0704*2
1534++9E82 6A           	DB #076E-#0704
1535++9E83 72           	DB #07E0-#076E
1536++9E84 78           	DB #0858-#07E0
1537++9E85 7E           	DB #08D6-#0858
1538++9E86 86           	DB #095C-#08D6
1539++9E87 90           	DB #09EC-#095C
1540++9E88 96           	DB #0A82-#09EC
1541++9E89 A0           	DB #0B22-#0A82
1542++9E8A AA           	DB #0BCC-#0B22
1543++9E8B B4           	DB #0C80-#0BCC
1544++9E8C BE           	DB #0D3E-#0C80
player.asm(1545): warning: value 0xFC0 is truncated to 8bit value: 0xC0
1545++9E8D 0F C0        	DB #07E0*2/256,#07E0*2
1546++9E8F 78           	DB #0858-#07E0
1547++9E90 88           	DB #08E0-#0858
1548++9E91 80           	DB #0960-#08E0
1549++9E92 90           	DB #09F0-#0960
1550++9E93 98           	DB #0A88-#09F0
1551++9E94 A0           	DB #0B28-#0A88
1552++9E95 B0           	DB #0BD8-#0B28
1553++9E96 A8           	DB #0C80-#0BD8
1554++9E97 E0           	DB #0D60-#0C80
1555++9E98 B0           	DB #0E10-#0D60
1556++9E99 E8           	DB #0EF8-#0E10
1557++9E9A
1558++9E9A              ;vars from here can be stripped
1559++9E9A              ;you can move VARS to any other address
1560++9E9A
1561++9E9A              VARS
1562++9E9A
1563++9E9A 00           is_ts	DB 0
1564++9E9B
1565++9E9B              ;ChannelsVars
1566++9E9B              	STRUCT	CHP
1567++9E9B ~            ;reset group
1568++9E9B ~            PsInOr	DB 0
1569++9E9B ~            PsInSm	DB 0
1570++9E9B ~            CrAmSl	DB 0
1571++9E9B ~            CrNsSl	DB 0
1572++9E9B ~            CrEnSl	DB 0
1573++9E9B ~            TSlCnt	DB 0
1574++9E9B ~            CrTnSl	DW 0
1575++9E9B ~            TnAcc	DW 0
1576++9E9B ~            COnOff	DB 0
1577++9E9B ~            ;reset group
1578++9E9B ~
1579++9E9B ~            OnOffD	DB 0
1580++9E9B ~
1581++9E9B ~            ;IX for PTDECOD here (+12)
1582++9E9B ~            OffOnD	DB 0
1583++9E9B ~            OrnPtr	DW 0
1584++9E9B ~            SamPtr	DW 0
1585++9E9B ~            NNtSkp	DB 0
1586++9E9B ~            Note	DB 0
1587++9E9B ~            SlToNt	DB 0
1588++9E9B ~            Env_En	DB 0
1589++9E9B ~            Flags	DB 0
1590++9E9B ~             ;Enabled - 0, SimpleGliss - 2
1591++9E9B ~            TnSlDl	DB 0
1592++9E9B ~            TSlStp	DW 0
1593++9E9B ~            TnDelt	DW 0
1594++9E9B ~            NtSkCn	DB 0
1595++9E9B ~            Volume	DB 0
1596++9E9B              	ENDS
1597++9E9B
1598++9E9B              	STRUCT	VRS
1599++9E9B ~
1600++9E9B ~            ;IF not works in STRUCT in SjASM :(
1601++9E9B ~            ;	IF CurPosCounter
1602++9E9B ~            CurPos	DB 0
1603++9E9B ~            PosSub	DB 0
1604++9E9B ~            ;	ENDIF
1605++9E9B ~
1606++9E9B ~            ModNum	DB 0 ;bit0: ChipNum
1607++9E9B ~            	     ;bit1: 1-reversed patterns order (AlCo TS)
1608++9E9B ~
1609++9E9B ~            ChanA	DS CHP
1610++9E9B ~            ChanB	DS CHP
1611++9E9B ~            ChanC	DS CHP
1612++9E9B ~
1613++9E9B ~            ;GlobalVars
1614++9E9B ~            MODADDR	DW 0
1615++9E9B ~            OrnPtrs	DW 0
1616++9E9B ~            SamPtrs	DW 0
1617++9E9B ~            PatsPtr	DW 0
1618++9E9B ~            AdInPtA	DW 0
1619++9E9B ~            AdInPtB	DW 0
1620++9E9B ~            AdInPtC	DW 0
1621++9E9B ~            CrPsPtr	DW 0
1622++9E9B ~            LPosPtr	DW 0
1623++9E9B ~            Delay	DB 0
1624++9E9B ~            DelyCnt	DB 0
1625++9E9B ~            ESldAdd	DW 0
1626++9E9B ~            CurESld	DW 0
1627++9E9B ~            Env_Del	DB 0
1628++9E9B ~            CurEDel	DB 0
1629++9E9B ~            Ns_Base	DB 0
1630++9E9B ~            AddToNs	DB 0
1631++9E9B ~            AddToEn	DB 0
1632++9E9B ~            EnvBase	DW 0
1633++9E9B ~            AYREGS	DS 14
1634++9E9B              	ENDS
1635++9E9B
1636++9E9B 00 00 00...  VARS1	DS VRS
1637++9F22 00 00 00...  VARS2	DS VRS
1638++9FA9
1639++9FA9              VT_	EQU $-16
1640++9FA9 00 00 00...  	DS 256-16 ;CreatedVolumeTableAddress
1641++A099
1642++A099              T1_	EQU VT_+16 ;Tone tables data depacked here
1643++A099
1644++A099              T_OLD_1	EQU T1_
1645++A099              T_OLD_2	EQU T_OLD_1+24
1646++A099              T_OLD_3	EQU T_OLD_2+24
1647++A099              T_OLD_0	EQU T_OLD_3+2
1648++A099              T_NEW_0	EQU T_OLD_0
1649++A099              T_NEW_1	EQU T_OLD_1
1650++A099              T_NEW_2	EQU T_NEW_0+24
1651++A099              T_NEW_3	EQU T_OLD_3
1652++A099
1653++A099              PT2EMPTYORN EQU VT_+31 ;1,0,0 sequence
1654++A099
1655++A099 00 00 00...  NT_	DS 192 ;CreatedNoteTableAddress
1656++A159
1657++A159              VAR0END	EQU VT_+16 ;INIT zeroes from VARS to VAR0END-1
1658++A159
1659++A159              VARSEND EQU $
1660++A159
1661++A159              MDLADDR EQU outputBuffer
1662++A159
1663++A159              ;Release 0 steps:
1664++A159              ;04/21/2007
1665++A159              ;Works start (PTxPlay adaptation); first beta.
1666++A159              ;04/22/2007
1667++A159              ;Job finished; beta-testing.
1668++A159              ;04/23/2007
1669++A159              ;PT v3.7 TS mode corrected (after AlCo remarks).
1670++A159              ;04/29/2007
1671++A159              ;Added 1.XX and 2.XX special commands interpretation for PT3
1672++A159              ;modules of v3.7+.
1673++A159
1674++A159              ;Size (minimal build for ZX Spectrum):
1675++A159              ;Code block #908 bytes
1676++A159              ;Variables #2BF bytes (can be stripped)
1677++A159              ;Total size #908+#2BF=#BC7 (3015) bytes
1678++A159              	ENDMODULE
# file closed: player/player.asm
  77++A159                  ENDIF
# file closed: player/vortex-processor.asm
  44+ A159
  45+ A159              start:
  46+ A159              outputBuffer:
  47+ A159 F3                   di
  48+ A15A AF                   xor a
  48+ A15B 32 6A 5C       ld (#5c6a), a  ; Thank you, Mario Prato, for feedback
  49+ A15E 32 00 5C             ld (#5c00),a
  50+ A161 31 00 60             ld sp, asmOrg
  51+ A164 CD 08 93             call Memory.init
  52+ A167 AF                   xor a
  52+ A168 D3 FE          out (#fe),a
  53+ A16A FB                   ei
  54+ A16B
  55+ A16B 3E 07                ld a, 7
  55+ A16D CD 12 93       call Memory.setPage
  56+ A170                      ;; Logo
  57+ A170 21 AB A1 06          ld hl, logo, b, Dos.FMODE_READ
  57+ A174 01
  57+ A175 CD B7 6C       call Dos.fopen
  58+ A178 F5                   push af
  59+ A179 21 00 C0 01          ld hl, #c000, bc, 6912
  59+ A17D 00 1B
  59+ A17F CD 0E 6F       call Dos.fread
  60+ A182 F1                   pop af
  61+ A183 CD 02 6E             call Dos.fclose
  62+ A186
  63+ A186 06 32                ld b, 50
  64+ A188 76           1       halt
  65+ A189 10 FD                djnz 1b
  66+ A18B                  ENDIF
  67+ A18B
  68+ A18B CD 03 60         call TextMode.init
  69+ A18E 21 9A A1     	ld hl, initing
  69+ A191 CD BC 60       call TextMode.printZ
  70+ A194
  71+ A194                  IFNDEF NOINIT
  72+ A194 CD 59 8F       	    call Wifi.init
  73+ A197                  ENDIF
  74+ A197
  75+ A197 C3 27 74         jp History.home
  76+ A19A
  77+ A19A 49 6E 69 74  initing db "Initing Wifi...", "\r", 0
  77+ A19E 69 6E 67 20
  77+ A1A2 57 69 66 69
  77+ A1A6 2E 2E 2E 0D
  77+ A1AA 00
  78+ A1AB 62 72 6F 77  logo    db "browser/logo.scr", 0
  78+ A1AF 73 65 72 2F
  78+ A1B3 6C 6F 67 6F
  78+ A1B7 2E 73 63 72
  78+ A1BB 00
  79+ A1BC 62 72 6F 77  creds   db "browser/auth.pwd", 0
  79+ A1C0 73 65 72 2F
  79+ A1C4 61 75 74 68
  79+ A1C8 2E 70 77 64
  79+ A1CC 00
  80+ A1CD              outputBuffer2:
  81+ A1CD 41 54 45 30      db  "ATE0", 0
  81+ A1D1 00
  82+ A1D2                  display "ENDS: ", $
  83+ A1D2                  display "Buff size", #ffff - $
  84+ A1D2
  85+ A1D2              	IFDEF TRDOS
  86+ A1D2              		SAVETRD "TRD/MRF.TRD",|"AY-64-SC.C",asmOrg, $ - asmOrg
  87+ A1D2              	        ELSE
  88+ A1D2 ~            			    savebin BINNAME, asmOrg, $ - asmOrg
  89+ A1D2                 	ENDIF
  90+ A1D2
# file closed: main-all.asm
  17  A1D2                  ENDIF
# file closed: main.asm
