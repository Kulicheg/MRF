# file opened: main.asm
   1  0000                  DEFINE TCP_BUF_SIZE 1024
   2  0000              ; Generate version string
   3  0000                  LUA ALLPASS
   4  0000 ~                v = tostring(sj.get_define("V"))
   5  0000 ~                maj = string.sub(v, 1,1)
   6  0000 ~                min = string.sub(v, 2,2)
   7  0000 ~                sj.insert_define("VERSION_STRING", "\"" .. maj .. "." .. min .. "\"")
   8  0000 ~
   9  0000 ~                b = tostring(sj.get_define("BLD"))
  10  0000 ~                sj.insert_define("BUILD_STRING", "\"" .. b .. "\"")
  11  0000                  ENDLUA
  12  0000
  13  0000                  IFDEF MSX
  14  0000                      include "main-msx.asm"
# file opened: main-msx.asm
   1+ 0000              ;******************************* MSX **********************************************
   2+ 0000                  output "mrfmsx.com"
   3+ 0000                  org 100h
   4+ 0100              asmOrg:
   5+ 0100 C3 AB 2E         jp start
   6+ 0103                  include "vdp/vdpdriver.asm"
# file opened: vdp/vdpdriver.asm
   1++0103              ; Colourful pseudo-text code
   2++0103              VDP_DATA_PORT    = #98
   3++0103              VDP_COMMAND_PORT = #99
   4++0103                  module TextMode
   5++0103
   6++0103                  macro vdp_reg reg, value
   7++0103 ~                di
   8++0103 ~                ld a, value
   9++0103 ~                out (VDP_COMMAND_PORT), a
  10++0103 ~                nop
  11++0103 ~                ld a, #80 or reg
  12++0103 ~                ei
  13++0103 ~                out (VDP_COMMAND_PORT), a
  14++0103                  endm
  15++0103
  16++0103              init:
  17++0103 CD 3C 02         call vdpWait
  18++0106                  vdp_reg 1, 48 ; Shutdown screen
  18++0106 F3          >    di
  18++0107 3E 30       >    ld a, 48
  18++0109 D3 99       >    out (VDP_COMMAND_PORT), a
  18++010B 00          >    nop
  18++010C 3E 81       >    ld a, #80 or 1
  18++010E FB          >    ei
  18++010F D3 99       >    out (VDP_COMMAND_PORT), a
  19++0111 AF               xor a
  20++0112 32 DC F3 32      ld (#f3dc), a, (#f3dd), a
  20++0116 DD F3
  21++0118                  vdp_reg 0, 4
  21++0118 F3          >    di
  21++0119 3E 04       >    ld a, 4
  21++011B D3 99       >    out (VDP_COMMAND_PORT), a
  21++011D 00          >    nop
  21++011E 3E 80       >    ld a, #80 or 0
  21++0120 FB          >    ei
  21++0121 D3 99       >    out (VDP_COMMAND_PORT), a
  22++0123
  23++0123 21 00 10         ld hl, #1000
  23++0126 CD 5A 02       call vdpSetWrite
  24++0129 01 00 08         ld bc, 2048
  24++012C 21 FA 2E       ld hl, font
  25++012F              .fontLoop
  26++012F 7E               ld a, (hl)
  27++0130 D3 98            out (VDP_DATA_PORT), a
  28++0132 00               nop
  29++0133 23               inc hl
  29++0134 0B             dec bc
  30++0135 78               ld a, b
  30++0136 B1             or c
  30++0137 20 F6          jr nz, .fontLoop
  31++0139              cls:
  32++0139                  vdp_reg 1, 48 ; Shutdown screen
  32++0139 F3          >    di
  32++013A 3E 30       >    ld a, 48
  32++013C D3 99       >    out (VDP_COMMAND_PORT), a
  32++013E 00          >    nop
  32++013F 3E 81       >    ld a, #80 or 1
  32++0141 FB          >    ei
  32++0142 D3 99       >    out (VDP_COMMAND_PORT), a
  33++0144 21 00 00         ld hl, #0000
  33++0147 CD 5A 02       call vdpSetWrite
  34++014A 01 0D 09         ld bc, #90D ; To the end attrs
  35++014D              .loop
  36++014D AF               xor a
  37++014E D3 98            out (VDP_DATA_PORT), a
  38++0150 00               nop
  39++0151 0B               dec bc
  40++0152 78               ld a, b
  40++0153 B1             or c
  40++0154 20 F7          jr nz, .loop
  41++0156 21 00 00 22      ld hl, 0, (coords), hl
  41++015A 75 02
  42++015C                  vdp_reg 2, 3
  42++015C F3          >    di
  42++015D 3E 03       >    ld a, 3
  42++015F D3 99       >    out (VDP_COMMAND_PORT), a
  42++0161 00          >    nop
  42++0162 3E 82       >    ld a, #80 or 2
  42++0164 FB          >    ei
  42++0165 D3 99       >    out (VDP_COMMAND_PORT), a
  43++0167                  vdp_reg 4, 2
  43++0167 F3          >    di
  43++0168 3E 02       >    ld a, 2
  43++016A D3 99       >    out (VDP_COMMAND_PORT), a
  43++016C 00          >    nop
  43++016D 3E 84       >    ld a, #80 or 4
  43++016F FB          >    ei
  43++0170 D3 99       >    out (VDP_COMMAND_PORT), a
  44++0172                  vdp_reg 7, #F1    ; Color 1
  44++0172 F3          >    di
  44++0173 3E F1       >    ld a, #F1
  44++0175 D3 99       >    out (VDP_COMMAND_PORT), a
  44++0177 00          >    nop
  44++0178 3E 87       >    ld a, #80 or 7
  44++017A FB          >    ei
  44++017B D3 99       >    out (VDP_COMMAND_PORT), a
  45++017D                  vdp_reg 12, #F4   ; Color 2
  45++017D F3          >    di
  45++017E 3E F4       >    ld a, #F4
  45++0180 D3 99       >    out (VDP_COMMAND_PORT), a
  45++0182 00          >    nop
  45++0183 3E 8C       >    ld a, #80 or 12
  45++0185 FB          >    ei
  45++0186 D3 99       >    out (VDP_COMMAND_PORT), a
  46++0188                  vdp_reg 13, #f0   ; Flashing using as second color
  46++0188 F3          >    di
  46++0189 3E F0       >    ld a, #f0
  46++018B D3 99       >    out (VDP_COMMAND_PORT), a
  46++018D 00          >    nop
  46++018E 3E 8D       >    ld a, #80 or 13
  46++0190 FB          >    ei
  46++0191 D3 99       >    out (VDP_COMMAND_PORT), a
  47++0193                  ; Set attrs begin to #800
  48++0193                  vdp_reg 3,  #20 or #7  ; A13-A9 bits and 111 for attributes address bus
  48++0193 F3          >    di
  48++0194 3E 27       >    ld a, #20 or #7
  48++0196 D3 99       >    out (VDP_COMMAND_PORT), a
  48++0198 00          >    nop
  48++0199 3E 83       >    ld a, #80 or 3
  48++019B FB          >    ei
  48++019C D3 99       >    out (VDP_COMMAND_PORT), a
  49++019E                  vdp_reg 10, #00        ; 00000 and A16-A14 for attributes address bus
  49++019E F3          >    di
  49++019F 3E 00       >    ld a, #00
  49++01A1 D3 99       >    out (VDP_COMMAND_PORT), a
  49++01A3 00          >    nop
  49++01A4 3E 8A       >    ld a, #80 or 10
  49++01A6 FB          >    ei
  49++01A7 D3 99       >    out (VDP_COMMAND_PORT), a
  50++01A9                  vdp_reg 1, 112 ; Screen 0/Text 2
  50++01A9 F3          >    di
  50++01AA 3E 70       >    ld a, 112
  50++01AC D3 99       >    out (VDP_COMMAND_PORT), a
  50++01AE 00          >    nop
  50++01AF 3E 81       >    ld a, #80 or 1
  50++01B1 FB          >    ei
  50++01B2 D3 99       >    out (VDP_COMMAND_PORT), a
  51++01B4 C9               ret
  52++01B5
  53++01B5              ; A - line
  54++01B5              usualLine:
  55++01B5 F5               push af
  56++01B6 AF               xor a
  57++01B7 32 DA 01         ld (fillLineColor.loop + 1), a
  58++01BA F1               pop af
  59++01BB 18 07            jr fillLineColor
  60++01BD              ; A - line
  61++01BD              highlightLine:
  62++01BD F5               push af
  63++01BE 3E FF            ld a, #ff
  64++01C0 32 DA 01         ld (fillLineColor.loop + 1), a
  65++01C3 F1               pop af
  66++01C4              fillLineColor:
  67++01C4 26 00 6F         ld h, 0, l, a
  68++01C7 A7               and a
  68++01C8 28 06          jr z, .skip
  69++01CA 29               add hl, hl
  70++01CB 44 4D            ld bc, hl
  71++01CD 29               add hl, hl
  72++01CE 29               add hl, hl
  73++01CF 09               add hl, bc ; x10
  74++01D0              .skip
  75++01D0 7C               ld a, h
  75++01D1 C6 08          add #8
  75++01D3 67             ld h, a
  76++01D4 CD 5A 02         call vdpSetWrite
  77++01D7
  78++01D7 06 0A            ld b, 10
  79++01D9              .loop
  80++01D9 3E FF            ld a, #ff
  81++01DB D3 98            out (VDP_DATA_PORT), a
  82++01DD 00               nop
  83++01DE 10 F9            djnz .loop
  84++01E0 C9               ret
  85++01E1
  86++01E1              printZ:
  87++01E1 7E               ld a, (hl)
  87++01E2 A7             and a
  87++01E3 C8             ret z
  88++01E4 E5               push hl
  89++01E5 CD EC 01         call putC
  90++01E8 E1               pop hl
  91++01E9 23               inc hl
  92++01EA 18 F5            jr printZ
  93++01EC
  94++01EC
  95++01EC              ; A - char
  96++01EC              putC:
  97++01EC FE 0D            cp 13
  97++01EE 28 16          jr z, .nl
  98++01F0 F5               push af
  99++01F1 ED 5B 75 02      ld de, (coords)
 100++01F5 CD 2A 02         call xyToAddr
 101++01F8 CD 5A 02         call vdpSetWrite
 102++01FB F1               pop af
 103++01FC D3 98            out (VDP_DATA_PORT), a
 104++01FE 3A 75 02         ld a, (coords)
 105++0201 3C               inc a
 106++0202 FE 50            cp 80
 106++0204 20 05          jr nz, .write
 107++0206              .nl
 108++0206 21 76 02         ld hl, coords + 1
 109++0209 34               inc (hl)
 110++020A AF               xor a
 111++020B              .write
 112++020B 32 75 02         ld (coords), a
 113++020E C9               ret
 114++020F
 115++020F              fillLine:
 116++020F 6C 26 00         ld l, h, h, 0
 117++0212                  dup 4
 118++0212 29          >    add hl, hl
 118++0213 29          >    add hl, hl
 118++0214 29          >    add hl, hl
 118++0215 29          >    add hl, hl
 119++0216                  edup
 120++0216 C5               push bc
 121++0217 44 4D            ld bc, hl
 122++0219 29               add hl,hl
 123++021A 29               add hl,hl
 124++021B 09               add hl, bc
 125++021C 08               ex af, af'
 126++021D CD 5A 02         call vdpSetWrite
 127++0220 08               ex af, af'
 128++0221 06 50            ld b, 80
 129++0223              .loop
 130++0223 D3 98            out (VDP_DATA_PORT), a
 131++0225 00               nop
 132++0226 10 FB            djnz .loop
 133++0228 C1               pop bc
 134++0229 C9               ret
 135++022A
 136++022A              ; DE - coord(E - X, D - Y)
 137++022A              xyToAddr:
 138++022A 26 00 6A         ld h, 0, l, d
 139++022D                  dup 4
 140++022D 29          >    add hl, hl
 140++022E 29          >    add hl, hl
 140++022F 29          >    add hl, hl
 140++0230 29          >    add hl, hl
 141++0231                  edup
 142++0231 C5               push bc
 143++0232 44 4D            ld bc, hl
 144++0234 29               add hl,hl
 145++0235 29               add hl,hl
 146++0236 09               add hl, bc
 147++0237 16 00            ld d, 0
 148++0239 19               add hl, de
 149++023A C1               pop bc
 150++023B C9               ret
 151++023C
 152++023C              vdpWait:
 153++023C                  vdp_reg 15, 2
 153++023C F3          >    di
 153++023D 3E 02       >    ld a, 2
 153++023F D3 99       >    out (VDP_COMMAND_PORT), a
 153++0241 00          >    nop
 153++0242 3E 8F       >    ld a, #80 or 15
 153++0244 FB          >    ei
 153++0245 D3 99       >    out (VDP_COMMAND_PORT), a
 154++0247 F3               di
 155++0248 DB 99            in a, (VDP_COMMAND_PORT)
 156++024A 0F               rrca
 157++024B                  vdp_reg 15, 0
 157++024B F3          >    di
 157++024C 3E 00       >    ld a, 0
 157++024E D3 99       >    out (VDP_COMMAND_PORT), a
 157++0250 00          >    nop
 157++0251 3E 8F       >    ld a, #80 or 15
 157++0253 FB          >    ei
 157++0254 D3 99       >    out (VDP_COMMAND_PORT), a
 158++0256 FB               ei
 159++0257 38 E3            jr c, vdpWait
 160++0259
 161++0259 C9               ret
 162++025A
 163++025A              ;
 164++025A              ; Set VDP address counter to write from address AHL (17-bit)
 165++025A              ; Enables the interrupts
 166++025A              ;
 167++025A              vdpSetWrite:
 168++025A F3               di
 169++025B 7D               ld a, l
 169++025C D3 99          out (VDP_COMMAND_PORT), a
 170++025E 00               nop
 170++025F 00             nop
 171++0260 7C               ld a, h
 171++0261 F6 40          or #40
 171++0263 D3 99          out (VDP_COMMAND_PORT), a
 172++0265 00               nop
 173++0266 FB               ei
 174++0267 C9               ret
 175++0268
 176++0268              vdpSetRead:
 177++0268 7D               ld a, l
 177++0269 D3 99          out (VDP_COMMAND_PORT), a
 178++026B 00               nop
 179++026C 7C               ld a, h
 179++026D D3 99          out (VDP_COMMAND_PORT), a
 180++026F C9               ret
 181++0270
 182++0270              gotoXY:
 183++0270 ED 53 75 02      ld (coords), de
 184++0274 C9               ret
 185++0275
 186++0275 00 00        coords dw 0
 187++0277
 188++0277              loadFont:
 189++0277              ; Loading font
 190++0277 11 A2 2E 3E      ld de, fontName, a, FMODE_NO_WRITE
 190++027B 01
 190++027C CD 64 09       call Dos.fopen
 191++027F C5               push bc
 192++0280 11 FA 2E 21      ld de, font, hl, 2048
 192++0284 00 08
 192++0286 CD 78 09      call Dos.fread
 193++0289 C1               pop bc
 194++028A CD 6E 09         call Dos.fclose
 195++028D C9               ret
 196++028E                  endmodule
 197++028E
 198++028E              exit:
 199++028E                  vdp_reg 1, 48 ; Shutdown screen
 199++028E F3          >    di
 199++028F 3E 30       >    ld a, 48
 199++0291 D3 99       >    out (VDP_COMMAND_PORT), a
 199++0293 00          >    nop
 199++0294 3E 81       >    ld a, #80 or 1
 199++0296 FB          >    ei
 199++0297 D3 99       >    out (VDP_COMMAND_PORT), a
 200++0299 0E 00            ld c, 0
 201++029B B7               or a
 201++029C DD 21 85 01    ld ix, #0185
 202++02A0 CD 49 03     	call callSub
 203++02A3 C7               rst 0
# file closed: vdp/vdpdriver.asm
   7+ 02A4                  include "utils/index.asm"
# file opened: utils/index.asm
   1++02A4                  include "atoi.asm"
# file opened: utils/atoi.asm
   1++02A4              ; DE - buffer
   2++02A4              ; HL - output
   3++02A4              atohl:
   4++02A4 21 00 00         ld hl, 0
   5++02A7              .loop
   6++02A7 1A               ld a, (de)
   7++02A8 13               inc de
   8++02A9                  ; Sepparators
   9++02A9 C5 E5            push bc, hl
  10++02AB 01 05 00             ld bc, sepparators_len
  11++02AE 21 C6 02             ld hl, sepparators
  12++02B1 ED B1                cpir
  13++02B3 E1 C1            pop hl, bc
  14++02B5 C8               ret z
  15++02B6
  16++02B6 D6 30            sub '0'
  17++02B8
  18++02B8 C5               push bc
  19++02B9 4D                   ld c, l
  20++02BA 44                   ld b, h
  21++02BB
  22++02BB 29                   add hl, hl
  23++02BC 29                   add hl, hl
  24++02BD 09                   add hl, bc
  25++02BE 29                   add hl, hl
  26++02BF 4F                   ld c, a
  27++02C0 06 00                ld b, 0
  28++02C2 09                   add hl, bc
  29++02C3 C1               pop bc
  30++02C4 18 E1            jr .loop
  31++02C6
# file closed: utils/atoi.asm
   2++02C6                  include "constants.asm"
# file opened: utils/constants.asm
   1++02C6              TAB = 9
   2++02C6              CR = 13
   3++02C6              LF = 10
   4++02C6              NULL = 0
   5++02C6              SPACE = ' '
   6++02C6              ESC = 27
   7++02C6              BACKSPACE = 8
   8++02C6
   9++02C6                  IFDEF TIMEX80
  10++02C6 ~            MIME_DOWNLOAD 	= #19
  11++02C6 ~            MIME_LINK 		= #1A
  12++02C6 ~            MIME_TEXT 		= #10
  13++02C6 ~            MIME_IMAGE 		= #01
  14++02C6 ~            MIME_MUSIC 		= #0e
  15++02C6 ~            MIME_INPUT 		= #b3
  16++02C6 ~            MIME_MOD 		= #0d
  17++02C6 ~            MIME_SOUND      = 's' ;sound
  18++02C6 ~
  19++02C6 ~            BORDER_TOP = #b2
  20++02C6 ~            BORDER_BOTTOM = #b1
  21++02C6                  ELSE
  22++02C6              	IFDEF MSX
  23++02C6              MIME_DOWNLOAD 	= 1
  24++02C6              MIME_LINK		= 2
  25++02C6              MIME_TEXT 		= 3
  26++02C6              MIME_IMAGE 		= 4
  27++02C6              MIME_MUSIC 		= 5
  28++02C6              MIME_INPUT 		= 6
  29++02C6              MIME_MOD      	= 7
  30++02C6              MIME_SOUND      = 's' ;sound
  31++02C6
  32++02C6              BORDER_TOP    = 7
  33++02C6              BORDER_BOTTOM = 8
  34++02C6              	ELSE
  35++02C6 ~            MIME_DOWNLOAD = 1
  36++02C6 ~            MIME_LINK     = 2
  37++02C6 ~            MIME_TEXT     = 3
  38++02C6 ~            MIME_IMAGE    = 6
  39++02C6 ~            MIME_MUSIC    = 5
  40++02C6 ~            MIME_INPUT    = 4
  41++02C6 ~            MIME_MOD      = 7
  42++02C6 ~            MIME_SOUND    = 's' ;sound
  43++02C6 ~
  44++02C6 ~            BORDER_TOP    = 9
  45++02C6 ~            BORDER_BOTTOM = 8
  46++02C6              	ENDIF
  47++02C6
  48++02C6
  49++02C6
  50++02C6
  51++02C6              	ENDIF
  52++02C6
  53++02C6 0D 0A 09 00  sepparators db CR, LF, TAB, NULL, SPACE
  53++02CA 20
  54++02CB              sepparators_len = $ - sepparators
# file closed: utils/constants.asm
   3++02CB                  include "strutils.asm"
# file opened: utils/strutils.asm
   1++02CB              ; de - pointer
   2++02CB              ; hl - count
   3++02CB              strlen:
   4++02CB 21 00 00         ld hl, 0
   5++02CE              .loop
   6++02CE 1A               ld a, (de)
   7++02CF A7               and a
   7++02D0 28 04          jr z, .exit
   8++02D2 23               inc hl
   9++02D3 13               inc de
  10++02D4 18 F8            jr .loop
  11++02D6              .exit
  12++02D6 C9               ret
  13++02D7
  14++02D7                  module CompareBuff
  15++02D7
  16++02D7              ; Pushes A to buffer
  17++02D7              push
  18++02D7 F5               push af
  19++02D8 06 20            ld b, 32
  19++02DA 21 23 03       ld hl, buffer + 1
  19++02DD 11 22 03       ld de, buffer
  20++02E0              .loop
  21++02E0 7E               ld a, (hl)
  21++02E1 12             ld (de), a
  21++02E2 23             inc hl
  21++02E3 13             inc de
  21++02E4 10 FA          djnz .loop
  22++02E6 F1               pop af
  23++02E7 21 41 03         ld hl, buffer + 31
  23++02EA 77             ld (hl), a
  24++02EB C9               ret
  25++02EC
  26++02EC              ; HL - Compare string(null terminated)
  27++02EC              ; A - 0 NOT Found
  28++02EC              ;     1 Found
  29++02EC              search:
  30++02EC 06 00            ld b, 0
  30++02EE E5             push hl
  31++02EF              .loop:
  32++02EF 7E               ld a, (hl)
  32++02F0 23             inc hl
  32++02F1 04             inc b
  32++02F2 A7             and a
  32++02F3 C2 EF 02       jp nz, .loop
  33++02F6 05               dec b
  33++02F7 E1             pop hl
  33++02F8 C5             push bc
  33++02F9 E5             push hl
  34++02FA E1               pop hl
  35++02FB 11 42 03         ld de, buffer + 32
  36++02FE              .sourceLoop
  37++02FE 1B               dec de
  37++02FF 10 FD          djnz .sourceLoop
  38++0301 C1               pop bc
  39++0302              .compare
  40++0302 C5               push bc
  40++0303 F5             push af
  41++0304 1A               ld a, (de)
  41++0305 47             ld b, a
  42++0306 F1               pop af
  42++0307 7E             ld a, (hl)
  42++0308 B8             cp b
  42++0309 C1             pop bc
  42++030A 3E 00          ld a, 0
  42++030C C0             ret nz
  43++030D 13               inc de
  43++030E 23             inc hl
  44++030F 10 F1            djnz .compare
  45++0311 3E 01            ld a, 1
  46++0313 C9               ret
  47++0314
  48++0314              clear:
  49++0314 AF               xor a
  49++0315 21 22 03       ld hl, buffer
  49++0318 11 23 03       ld de, buffer + 1
  49++031B 01 20 00       ld bc, 32
  49++031E 77             ld (hl), a
  49++031F ED B0          ldir
  50++0321 C9               ret
  51++0322
  52++0322 00 00 00...  buffer ds 32
  53++0342
  54++0342                  endmodule
# file closed: utils/strutils.asm
   4++0342                  IFDEF MSX
   5++0342              	    include "bios.asm"
# file opened: utils/bios.asm
   1++0342              CALSLT  EQU    0x001C
   2++0342              NMI     EQU    0x0066
   3++0342              EXTROM  EQU    0x015f
   4++0342              EXPTBL  EQU    0xfcc1
   5++0342              H_NMI   EQU    0xfdd6
   6++0342
   7++0342              biosC:
   8++0342 FD 2A C0 FC  	LD	IY,($FCC0)
   9++0346 C3 1C 00     	JP	$001C
  10++0349
  11++0349              callSub:
  12++0349 D9           		 exx
  13++034A 08                    ex     af,af'       ; store all registers
  14++034B 21 5F 01              ld     hl,EXTROM
  15++034E E5                    push   hl
  16++034F 21 00 C3              ld     hl,0xC300
  17++0352 E5                    push   hl           ; push NOP ; JP EXTROM
  18++0353 DD E5                 push   ix
  19++0355 21 DD 21              ld     hl,0x21DD
  20++0358 E5                    push   hl           ; push LD IX,<entry>
  21++0359 21 33 33              ld     hl,0x3333
  22++035C E5                    push   hl           ; push INC SP; INC SP
  23++035D 21 00 00              ld     hl,0
  24++0360 39                    add    hl,sp        ; HL = offset of routine
  25++0361 3E C3                 ld     a,0xC3
  26++0363 32 D6 FD              ld     (H_NMI),a
  27++0366 22 D7 FD              ld     (H_NMI+1),hl ; JP <routine> in NMI hook
  28++0369 08                    ex     af,af'
  29++036A D9                    exx                 ; restore all registers
  30++036B DD 21 66 00           ld     ix,NMI
  31++036F FD 2A C0 FC           ld     iy,(EXPTBL-1)
  32++0373 CD 1C 00              call   CALSLT       ; call NMI-hook via NMI entry in ROMBIOS
  33++0376                                           ; NMI-hook will call SUBROM
  34++0376 D9                    exx
  35++0377 08                    ex     af,af'       ; store all returned registers
  36++0378 21 0A 00              ld     hl,10
  37++037B 39                    add    hl,sp
  38++037C F9                    ld     sp,hl        ; remove routine from stack
  39++037D 08                    ex     af,af'
  40++037E D9                    exx                 ; restore all returned registers
  41++037F C9                    ret
# file closed: utils/bios.asm
   6++0380                  ENDIF
   7++0380                  include "screen.asm"
# file opened: utils/screen.asm
   1++0380              LINE_LIMIT = 63
   2++0380
   3++0380                  IFDEF NEDOOS
   4++0380 ~            LINE_LIMIT = 79
   5++0380                  ENDIF
   6++0380
   7++0380                  IFDEF TIMEX80
   8++0380 ~            LINE_LIMIT = 84
   9++0380                  ENDIF
  10++0380
  11++0380                  IFDEF MSX
  12++0380              LINE_LIMIT = 79
  13++0380                  ENDIF
  14++0380              ; HL - string pointer
  15++0380              print70Text:
  16++0380 06 4F            ld b, LINE_LIMIT
  17++0382              .loop
  18++0382 7E               ld a, (hl)
  19++0383 A7               and a
  19++0384 C8             ret z
  20++0385 FE 0D            cp 13
  20++0387 C8             ret z
  21++0388 FE 0A            cp 10
  21++038A C8             ret z
  22++038B C5               push bc
  23++038C E5               push hl
  24++038D CD EC 01         call TextMode.putC
  25++0390 E1               pop hl
  26++0391 23               inc hl
  27++0392 C1               pop bc
  28++0393 05               dec b
  29++0394 78               ld a, b
  29++0395 A7             and a
  29++0396 C8             ret z
  30++0397 C3 82 03         jp .loop
  31++039A
  32++039A              ; HL - string pointer
  33++039A              print70Goph:
  34++039A 06 4F            ld b, LINE_LIMIT
  35++039C              .loop
  36++039C 7E               ld a, (hl)
  36++039D FE 09          cp 09
  36++039F C8             ret z
  37++03A0 A7               and a
  37++03A1 C8             ret z
  38++03A2 C5               push bc
  39++03A3 E5               push hl
  40++03A4 CD EC 01         call TextMode.putC
  41++03A7 E1               pop hl
  42++03A8 23               inc hl
  43++03A9 C1               pop bc
  44++03AA 05               dec b
  45++03AB 78               ld a, b
  45++03AC A7             and a
  45++03AD C8             ret z
  46++03AE C3 9C 03         jp .loop
# file closed: utils/screen.asm
# file closed: utils/index.asm
   8+ 03B1                  include "gopher/render/index.asm"
# file opened: gopher/render/index.asm
   1++03B1                  MODULE Render
   2++03B1              PER_PAGE = 22
   3++03B1              CURSOR_OFFSET = 2
   4++03B1                  include "row.asm"
# file opened: gopher/render/row.asm
   1++03B1              ; A - row number
   2++03B1              ; HL - pointer to row
   3++03B1              renderRow:
   4++03B1 C6 02            add CURSOR_OFFSET
   5++03B3 57               ld d,a
   6++03B4 1E 00            ld e,0
   7++03B6 CD 70 02         call TextMode.gotoXY
   8++03B9 7E               ld a,(hl)
   9++03BA E5               push hl
  10++03BB CD C6 03         call getIcon
  11++03BE CD EC 01         call TextMode.putC
  12++03C1 E1               pop hl
  13++03C2 23               inc hl
  14++03C3 C3 9A 03         jp print70Goph
  15++03C6
  16++03C6              ; A - gopher id char
  17++03C6              getIcon:
  18++03C6 FE 69            cp 'i'
  18++03C8 CA E7 03       jp z, .info
  19++03CB FE 39            cp '9'
  19++03CD CA EA 03       jp z, .down
  20++03D0 FE 31            cp '1'
  20++03D2 CA 56 04       jp z, .page
  21++03D5 FE 30            cp '0'
  21++03D7 CA 59 04       jp z, .text
  22++03DA FE 37            cp '7'
  22++03DC CA 5C 04       jp z, .input
  23++03DF FE 73            cp 's'
  23++03E1 CA EA 03       jp z, .down
  24++03E4 3E 20            ld a, ' '
  25++03E6 C9               ret
  26++03E7              .info
  27++03E7 3E 20            ld a, SPACE
  27++03E9 C9             ret
  28++03EA              .down
  29++03EA 54 5D            ld de, hl
  30++03EC 01 FF 00 3E      ld bc, #ff, a, TAB
  30++03F0 09
  30++03F1 ED B1          cpir
  31++03F3 78               ld a, b
  31++03F4 B1             or c
  31++03F5 28 5C          jr z, .downExit
  32++03F7 D5               push de
  33++03F8              .nameLoop
  34++03F8 7E               ld a, (hl)
  34++03F9 A7             and a
  34++03FA 28 10          jr z, .check
  35++03FC FE 09            cp TAB
  35++03FE 28 0C          jr z, .check
  36++0400 FE 0D            cp CR
  36++0402 28 08          jr z, .check
  37++0404 E5               push hl
  38++0405 CD D7 02         call CompareBuff.push
  39++0408 E1               pop hl
  40++0409 23               inc hl
  41++040A 18 EC            jr .nameLoop
  42++040C              .check
  43++040C 3A 98 04     	ld a,(saveMode+1);���� ����� �������� ������, ����� �� ������� �� ������ Caps
  44++040F B7           	or a
  45++0410 20 40        	jr nz,.checkExit
  46++0412 21 6B 04     	ld hl, scrExt1
  46++0415 CD EC 02       call CompareBuff.search
  46++0418 A7             and a
  46++0419 20 44          jr nz, .image
  47++041B 21 70 04         ld hl, scrExt2
  47++041E CD EC 02       call CompareBuff.search
  47++0421 A7             and a
  47++0422 20 3B          jr nz, .image
  48++0424 3E 03            ld a, 3
  48++0426 32 B0 25       ld (VTPL.SETUP), a ; 0 bit - looping, 1 bit - pt2 file
  49++0429 21 7F 04         ld hl, pt2Ext1
  49++042C CD EC 02       call CompareBuff.search
  49++042F A7             and a
  49++0430 20 31          jr nz, .music
  50++0432 21 84 04         ld hl, pt2Ext2
  50++0435 CD EC 02       call CompareBuff.search
  50++0438 A7             and a
  50++0439 20 28          jr nz, .music
  51++043B 3E 01            ld a, 1
  51++043D 32 B0 25       ld (VTPL.SETUP), a
  52++0440 21 75 04         ld hl, pt3Ext1
  52++0443 CD EC 02       call CompareBuff.search
  52++0446 A7             and a
  52++0447 20 1A          jr nz, .music
  53++0449 21 7A 04         ld hl, pt3Ext2
  53++044C CD EC 02       call CompareBuff.search
  53++044F A7             and a
  53++0450 20 11          jr nz, .music
  54++0452
  55++0452                  ; General Sound support
  56++0452                  ifdef GS
  57++0452 ~                ld hl, modExt1
  57++0452 ~              call CompareBuff.search
  57++0452 ~              and a
  57++0452 ~              jr nz, .mod
  58++0452 ~                ld hl, modExt2
  58++0452 ~              call CompareBuff.search
  58++0452 ~              and a
  58++0452 ~              jr nz, .mod
  59++0452                  endif
  60++0452
  61++0452              .checkExit
  62++0452 E1               pop hl
  63++0453              .downExit
  64++0453 3E 01            ld a, MIME_DOWNLOAD
  64++0455 C9             ret
  65++0456              .page
  66++0456 3E 02            ld a, MIME_LINK
  66++0458 C9             ret
  67++0459              .text
  68++0459 3E 03            ld a, MIME_TEXT
  68++045B C9             ret
  69++045C              .input
  70++045C 3E 06            ld a, MIME_INPUT
  70++045E C9             ret
  71++045F              .image
  72++045F E1               pop hl
  72++0460 3E 04          ld a, MIME_IMAGE
  72++0462 C9             ret
  73++0463              .music
  74++0463 E1               pop hl
  74++0464 3E 05          ld a, MIME_MUSIC
  74++0466 C9             ret
  75++0467              .mod
  76++0467 E1               pop hl
  76++0468 3E 07          ld a, MIME_MOD
  76++046A C9             ret
  77++046B
  78++046B 2E 73 63 72  scrExt1 db ".scr", 0
  78++046F 00
  79++0470 2E 53 43 52  scrExt2 db ".SCR", 0
  79++0474 00
  80++0475
  81++0475 2E 70 74 33  pt3Ext1 db ".pt3", 0
  81++0479 00
  82++047A 2E 50 54 33  pt3Ext2 db ".PT3", 0
  82++047E 00
  83++047F 2E 70 74 32  pt2Ext1 db ".pt2", 0
  83++0483 00
  84++0484 2E 50 54 32  pt2Ext2 db ".PT2", 0
  84++0488 00
  85++0489 2E 6D 6F 64  modExt1 db ".mod", 0
  85++048D 00
  86++048E 2E 4D 4F 44  modExt2 db ".MOD", 0
  86++0492 00
  87++0493
  88++0493              toggleSaveMode
  89++0493 F5           			push af
  90++0494 CD A8 09     			call Console.waitForKeyUp
  91++0497 3E 00        saveMode	ld a,0 ; ���� Open/Save files
  92++0499 EE 01        			xor 1
  93++049B 32 98 04     			ld (saveMode+1),a
  94++049E F1           			pop af
  95++049F C9           			ret
# file closed: gopher/render/row.asm
   5++04A0                  include "buffer.asm"
# file opened: gopher/render/buffer.asm
   1++04A0              ; BC - line count
   2++04A0              findLine
   3++04A0 21 FA 2E         ld hl, outputBuffer
   4++04A3              findLine2
   5++04A3 78               ld a,b
   6++04A4 B1               or c
   7++04A5 CA D2 04         jp z, .checkEmpty
   8++04A8              .loop
   9++04A8 7E               ld a, (hl)
  10++04A9 A7               and a
  11++04AA CA D5 04         jp z, .nope
  12++04AD 23               inc hl
  13++04AE FE 0D            cp 13
  14++04B0 CA C8 04         jp z, .checkLF  ;13
  15++04B3 FE 0A            cp 10
  15++04B5 CA BB 04       jp z, .nextCheck     ;10
  16++04B8 C3 A8 04         jp .loop
  17++04BB              .nextCheck
  18++04BB A7               and a
  19++04BC CA D5 04         jp z, .nope
  20++04BF 0B               dec bc
  21++04C0 57               ld d,a
  22++04C1 78               ld a,b
  23++04C2 B1               or c
  24++04C3 7A               ld a,d
  25++04C4 C2 A8 04         jp nz, .loop
  26++04C7 C9               ret
  27++04C8              .checkLF
  28++04C8 7E               ld a, (hl)
  29++04C9 FE 0A            cp 10
  30++04CB C2 BB 04         jp nz, .nextCheck    ;10
  31++04CE 23               inc hl
  32++04CF C3 BB 04         jp  .nextCheck
  33++04D2              .checkEmpty
  34++04D2 7E               ld a, (hl)
  34++04D3 A7             and a
  34++04D4 C0             ret nz
  35++04D5              .nope
  36++04D5 21 00 00         ld hl, 0
  36++04D8 C9             ret
  37++04D9
# file closed: gopher/render/buffer.asm
   6++04D9                  include "ui.asm"
# file opened: gopher/render/ui.asm
   1++04D9                  IFDEF ZXSCR
   2++04D9 ~                    DEFINE LEFT_TAB "[D]omain:                                  "
   3++04D9 ~                    DEFINE SCREEN_WIDTH 64
   4++04D9 ~                    DEFINE SCREEN64
   5++04D9                  ENDIF
   6++04D9
   7++04D9                  IFDEF TIMEX     ;UNKNOWM fallback to 64
   8++04D9 ~                    DEFINE LEFT_TAB "[D]omain:                                  "
   9++04D9 ~                    DEFINE SCREEN_WIDTH 64
  10++04D9 ~                    DEFINE SCREEN64
  11++04D9                  ENDIF
  12++04D9
  13++04D9                  IFDEF TIMEX80
  14++04D9 ~                    DEFINE LEFT_TAB "[D]omain:                                                      "
  15++04D9 ~                    DEFINE SCREEN_WIDTH 85
  16++04D9 ~                    DEFINE SCREEN85
  17++04D9                  ENDIF
  18++04D9
  19++04D9                  IFDEF NEDOOS
  20++04D9 ~                    DEFINE LEFT_TAB "[D]omain:                                                  "
  21++04D9 ~                    DEFINE SCREEN_WIDTH 80
  22++04D9 ~                    DEFINE SCREEN80
  23++04D9                  ENDIF
  24++04D9
  25++04D9                  IFDEF MSX
  26++04D9                      DEFINE LEFT_TAB "[D]omain:                                              "
  27++04D9                      DEFINE SCREEN_WIDTH 80
  28++04D9                      DEFINE SCREEN80
  29++04D9                  ENDIF
  30++04D9              prepareScreen:
  31++04D9 CD 39 01         call TextMode.cls
  32++04DC 21 AC 05         ld hl, header
  32++04DF CD E1 01       call TextMode.printZ
  33++04E2 11 0A 00         ld de, #000A
  33++04E5 CD 70 02       call TextMode.gotoXY
  34++04E8 21 3C 19         ld hl, hostName
  34++04EB CD E1 01       call TextMode.printZ
  35++04EE AF               xor a
  35++04EF CD BD 01       call TextMode.highlightLine
  36++04F2 C9               ret
  37++04F3
  38++04F3              inputHost:
  39++04F3 CD A8 09         	call Console.waitForKeyUp
  40++04F6              .loop
  41++04F6 11 0A 00         ld de, #000A
  41++04F9 CD 70 02       call TextMode.gotoXY
  41++04FC 21 3C 19       ld hl, hostName
  41++04FF CD E1 01       call TextMode.printZ
  42++0502 3E 06            ld a, MIME_INPUT
  42++0504 CD EC 01       call TextMode.putC
  43++0507 3E 20            ld a, ' '
  43++0509 CD EC 01       call TextMode.putC
  44++050C              .wait
  45++050C CD 8F 09         call Console.getC
  46++050F 5F               ld e, a
  47++0510 FE 08            cp Console.BACKSPACE
  47++0512 28 17          jr z, .removeChar
  48++0514 FE 0D            cp CR
  48++0516 CA 39 05       jp z, inputNavigate
  49++0519 FE 20            cp 32
  49++051B 38 EF          jr c, .wait
  50++051D              .putC
  51++051D AF               xor a
  51++051E 21 3C 19 01    ld hl, hostName, bc, 48
  51++0522 30 00
  51++0524 ED B1          cpir
  52++0526 77               ld (hl), a
  52++0527 2B             dec hl
  52++0528 73             ld (hl), e
  53++0529 18 CB            jr .loop
  54++052B              .removeChar
  55++052B AF               xor a
  56++052C 21 3C 19 01      ld hl, hostName, bc, 48
  56++0530 30 00
  56++0532 ED B1          cpir
  57++0534 2B               dec hl
  57++0535 2B             dec hl
  57++0536 77             ld (hl), a
  58++0537 18 BD            jr .loop
  59++0539
  60++0539              inputNavigate:
  61++0539 21 3C 19 11      ld hl, hostName, de, domain
  61++053D 6C 05
  62++053F 7E               ld a,(hl)
  63++0540 A7               and a
  64++0541 CA C0 09         jp z, History.load
  65++0544              .loop
  66++0544 7E               ld a, (hl)
  66++0545 A7             and a
  66++0546 28 05          jr z, .complete
  67++0548 12               ld (de), a
  67++0549 23 13          inc hl, de
  68++054B 18 F7            jr .loop
  69++054D              .complete
  70++054D 3E 09            ld a, TAB
  70++054F 12             ld (de), a
  70++0550 13             inc de
  71++0551 3E 37            ld a, '7'
  71++0553 12             ld (de), a
  71++0554 13             inc de
  72++0555 3E 30            ld a, '0'
  72++0557 12             ld (de), a
  72++0558 13             inc de
  73++0559 3E 0D            ld a, CR
  73++055B 12             ld (de), a
  73++055C 13             inc de
  74++055D 3E 0A            ld a, LF
  74++055F 12             ld (de), a
  74++0560 13             inc de
  75++0561 21 67 05         ld hl, navRow
  75++0564 C3 1B 0A       jp History.navigate
  76++0567
  77++0567 31 20 09 2F  navRow db "1 ", TAB, "/", TAB
  77++056B 09
  78++056C 6E 69 68 69  domain db "nihirash.net"
  78++0570 72 61 73 68
  78++0574 2E 6E 65 74
  79++0578 00 00 00...      ds 64 - ($ - domain)
  80++05AC
  81++05AC 5B 44 5D 6F  header db "[D]omain:                                              ", "MRF "
  81++05B0 6D 61 69 6E
  81++05B4 3A 20 20 20
  81++05B8 20 20 20 20
  81++05BC 20 20 20 20
  81++05C0 20 20 20 20
  81++05C4 20 20 20 20
  81++05C8 20 20 20 20
  81++05CC 20 20 20 20
  81++05D0 20 20 20 20
  81++05D4 20 20 20 20
  81++05D8 20 20 20 20
  81++05DC 20 20 20 20
  81++05E0 20 20 20 4D
  81++05E4 52 46 20
  82++05E7 31 2E 37            db "1.7"
  83++05EA 2E                  db "."
  84++05EB 32 32               db "22"
  85++05ED              	IFDEF MSX
  86++05ED 20 20 20 20         db "    [MSX UNAPI]",13, 0
  86++05F1 5B 4D 53 58
  86++05F5 20 55 4E 41
  86++05F9 50 49 5D 0D
  86++05FD 00
  87++05FE              	ENDIF
  88++05FE
  89++05FE                  IFDEF MB03
  90++05FE ~                   db " [MB03+]",13, 0
  91++05FE                     ENDIF
  92++05FE
  93++05FE                  IFDEF UNO
  94++05FE ~                   db " [UNO UART]",13, 0
  95++05FE                  ENDIF
  96++05FE
  97++05FE                  IFDEF AY
  98++05FE ~                   db " [AYWIFI]",13, 0
  99++05FE              	ENDIF
 100++05FE
 101++05FE                  IFDEF ZW
 102++05FE ~                   db "  [ZXWiFi]",13, 0
 103++05FE                  ENDIF
 104++05FE
 105++05FE                   IFDEF UARTATM
 106++05FE ~                   db " [ATM UART]",13, 0
 107++05FE                  ENDIF
 108++05FE
 109++05FE                  IFDEF UARTEVO
 110++05FE ~                    db " [EVO UART]",13, 0
 111++05FE                  ENDIF
 112++05FE
 113++05FE                  IFDEF UNOUART
 114++05FE ~                    db " [UNO UART]",13, 0
 115++05FE                  ENDIF
 116++05FE
 117++05FE                  IFDEF NEDONET
 118++05FE ~            	    db "  [nedoNET]",13, 0
 119++05FE              	ENDIF
 120++05FE
# file closed: gopher/render/ui.asm
   7++05FE                  include "gopher-page.asm"
# file opened: gopher/render/gopher-page.asm
   1++05FE              renderGopherScreen:
   2++05FE 3E FF            ld a, 255
   3++0600 32 A1 2E         ld (oldminutes), a
   4++0603 CD D9 04         call Render.prepareScreen
   5++0606
   6++0606 2A 29 0D         ld hl, (page_offset)        ; HL - offset to 0 Row on screen
   7++0609 44 4D            ld bc,hl                    ; BC - offset to C Row on screen
   8++060B CD A0 04         call Render.findLine        ;BC - Search this line  HL - Return pointer to page with offset
   9++060E 7C               ld a, h
  10++060F B5               or l
  11++0610 28 21            jr z, .exit2
  12++0612 7B               ld a, e
  13++0613 AF               xor a
  14++0614 E5               push hl
  15++0615 CD B1 03         call renderRow
  16++0618 E1               pop hl
  17++0619
  18++0619 06 15            ld b, PER_PAGE-1
  19++061B
  20++061B              .loop
  21++061B C5               push bc
  22++061C 3E 16            ld a, PER_PAGE
  23++061E 90               sub b
  24++061F 5F               ld e,a
  25++0620
  26++0620 01 01 00         ld bc, 1
  27++0623
  28++0623 CD A3 04         call Render.findLine2   ;BC - Search this line  HL - Return pointer to page with offset
  29++0626
  30++0626 7C               ld a, h
  31++0627 B5               or l
  32++0628 28 06            jr z, .exit
  33++062A 7B               ld a, e
  34++062B E5               push hl
  35++062C CD B1 03         call renderRow
  36++062F E1               pop hl
  37++0630              .exit
  38++0630 C1               pop bc
  39++0631 10 E8            djnz .loop
  40++0633              .exit2
  41++0633 CD 3D 07         call showCursor
  42++0636 C9               ret
  43++0637
  44++0637              checkBorder:
  45++0637 3A 27 0D         ld a, (cursor_position)
  45++063A FE FF          cp #ff
  45++063C CA 61 07       jp z, pageUp
  46++063F 3A 27 0D         ld a, (cursor_position)
  46++0642 FE 16          cp PER_PAGE
  46++0644 CA 94 07       jp z, pageDn
  47++0647 CD 3D 07         call showCursor
  48++064A C3 4D 06         jp workLoop
  49++064D
  50++064D              workLoop:
  51++064D 3A 82 08         ld a, (play_next)
  51++0650 A7             and a
  51++0651 C2 ED 06       jp nz, navigate
  52++0654
  53++0654                  dup 4
  54++0654 76          >    halt
  54++0655 76          >    halt
  54++0656 76          >    halt
  54++0657 76          >    halt
  55++0658                  edup
  56++0658              .nothing
  57++0658
  58++0658 76               halt
  59++0659 CD FC 2D         call printRTC
  60++065C
  61++065C CD 96 09         call Console.peekC
  62++065F A7               and a
  62++0660 CA 58 06       jp z, .nothing
  63++0663
  64++0663 FE 31            cp '1'
  64++0665 CA A9 09       jp z, History.back
  65++0668 FE 32            cp '2'
  65++066A CA ED 06       jp z, navigate
  66++066D FE 33            cp '3'
  66++066F CA 4D 07       jp z, cursorDown
  67++0672 FE 34            cp '4'
  67++0674 CA 57 07       jp z, cursorUp
  68++0677 FE 35            cp '5'
  68++0679 CA 61 07       jp z, pageUp
  69++067C FE 38            cp '8'
  69++067E CA 94 07       jp z, pageDn
  70++0681 FE 36            cp '6'
  70++0683 CA 4D 07       jp z, cursorDown
  71++0686 FE 37            cp '7'
  71++0688 CA 57 07       jp z, cursorUp
  72++068B
  73++068B FE 1F            cp Console.KEY_DN
  73++068D CA 4D 07       jp z, cursorDown
  74++0690 FE 61            cp 'a'
  74++0692 CA 4D 07       jp z, cursorDown
  75++0695 FE 1E            cp Console.KEY_UP
  75++0697 CA 57 07       jp z, cursorUp
  76++069A FE 71            cp 'q'
  76++069C CA 57 07       jp z, cursorUp
  77++069F FE 1D            cp Console.KEY_LT
  77++06A1 CA 61 07       jp z, pageUp
  78++06A4 FE 6F            cp 'o'
  78++06A6 CA 61 07       jp z, pageUp
  79++06A9 FE 1C            cp Console.KEY_RT
  79++06AB CA 94 07       jp z, pageDn
  80++06AE FE 70            cp 'p'
  80++06B0 CA 94 07       jp z, pageDn
  81++06B3
  82++06B3 FE 68            cp 'h'
  82++06B5 CA 18 0A       jp z, History.home
  83++06B8 FE 48            cp 'H'
  83++06BA CA 18 0A       jp z, History.home
  84++06BD
  85++06BD FE 62            cp 'b'
  85++06BF CA A9 09       jp z, History.back
  86++06C2 FE 42            cp 'B'
  86++06C4 CA A9 09       jp z, History.back
  87++06C7 FE 08            cp Console.BACKSPACE
  87++06C9 CA A9 09       jp z, History.back
  88++06CC
  89++06CC FE 64            cp 'd'
  89++06CE CA F3 04       jp z, inputHost
  90++06D1 FE 44            cp 'D'
  90++06D3 CA F3 04       jp z, inputHost
  91++06D6
  92++06D6 FE 0D            cp CR
  92++06D8 CA ED 06       jp z, navigate
  93++06DB
  94++06DB FE 53            cp 'S'
  94++06DD CC 93 04       call z, toggleSaveMode
  95++06E0 FE 73        	cp 's'
  95++06E2 CC 93 04       call z, toggleSaveMode
  96++06E5
  97++06E5
  98++06E5                  IFDEF MSX
  99++06E5 FE 1B            	cp ESC
  99++06E7 CA 8E 02       jp z, exit
 100++06EA                  ENDIF
 101++06EA
 102++06EA                  IFDEF GS
 103++06EA ~                cp 'M'
 103++06EA ~              call z, GeneralSound.toggleModule
 104++06EA ~                cp 'm'
 104++06EA ~              call z, GeneralSound.toggleModule
 105++06EA                  ENDIF
 106++06EA
 107++06EA                  IFDEF TIMEX80
 108++06EA ~                cp 'T'
 108++06EA ~              call z, TextMode.toggleColor
 109++06EA ~                cp 't'
 109++06EA ~              call z, TextMode.toggleColor
 110++06EA                  ENDIF
 111++06EA
 112++06EA C3 4D 06         jp workLoop
 113++06ED
 114++06ED              navigate:
 115++06ED CD A8 09         call Console.waitForKeyUp
 116++06F0 AF               xor a
 116++06F1 32 82 08       ld (play_next), a
 117++06F4 CD 45 07         call hideCursor
 118++06F7 ED 4B 29 0D      ld bc, (page_offset)
 119++06FB 2A 27 0D         ld hl, (cursor_position)
 120++06FE 09               add hl,bc
 121++06FF 44               ld b, h ;HHHHH
 122++0700 4D               ld c, l ;LLLLL
 123++0701 D5               push de
 124++0702 CD A0 04         call Render.findLine
 125++0705 D1               pop de
 126++0706 7E               ld a, (hl)
 127++0707 FE 31            cp '1'
 127++0709 CA 26 07       jp z, .load
 128++070C FE 30            cp '0'
 128++070E CA 26 07       jp z, .load
 129++0711 FE 39            cp '9'
 129++0713 CA 26 07       jp z, .load
 130++0716 FE 37            cp '7'
 130++0718 CA 2E 07       jp z, .input
 131++071B FE 73            cp MIME_SOUND
 131++071D CA 26 07       jp z, .load
 132++0720 CD 3D 07         call showCursor
 133++0723 C3 4D 06         jp workLoop
 134++0726              .load
 135++0726 E5               push hl
 136++0727 CD C6 03         call getIcon
 137++072A E1               pop hl
 138++072B C3 1B 0A         jp History.navigate
 139++072E              .input
 140++072E E5               push hl
 141++072F CD 83 08         call DialogBox.inputBox
 142++0732 E1               pop hl
 143++0733 3A DD 08         ld a, (DialogBox.inputBuffer)
 143++0736 A7             and a
 143++0737 CA C0 09       jp z, History.load
 144++073A C3 26 07         jp .load
 145++073D
 146++073D              showCursor:
 147++073D 3A 27 0D         ld a, (cursor_position)
 147++0740 C6 02          add CURSOR_OFFSET
 148++0742 C3 BD 01         jp TextMode.highlightLine
 149++0745
 150++0745              hideCursor:
 151++0745 3A 27 0D         ld a, (cursor_position)
 151++0748 C6 02          add CURSOR_OFFSET
 152++074A C3 B5 01         jp TextMode.usualLine
 153++074D
 154++074D              cursorDown:
 155++074D CD 45 07         call hideCursor
 156++0750 21 27 0D         ld hl, cursor_position
 157++0753 34               inc (hl)
 158++0754 C3 37 06         jp checkBorder
 159++0757
 160++0757              cursorUp:
 161++0757 CD 45 07         call hideCursor
 162++075A 21 27 0D         ld hl, cursor_position
 163++075D 35               dec (hl)
 164++075E C3 37 06         jp checkBorder
 165++0761
 166++0761              pageUp:
 167++0761 3A 29 0D         ld a, (page_offset)
 167++0764 FE 00          cp 0
 167++0766 C2 74 07       jp nz, .pageUp2
 168++0769 3A 2A 0D         ld a, (page_offset + 1)
 168++076C FE 00          cp 0
 168++076E C2 74 07       jp nz, .pageUp2
 169++0771 C3 8A 07         jp .skip
 170++0774              .pageUp2:
 171++0774 3E 15            ld a, PER_PAGE - 1
 171++0776 32 27 0D       ld (cursor_position), a
 172++0779 2A 29 0D         ld hl, (page_offset)
 173++077C 11 16 00         ld de,PER_PAGE
 174++077F ED 52            sbc hl,de
 175++0781 22 29 0D         ld (page_offset), hl
 176++0784              .exit
 177++0784 CD FE 05         call renderGopherScreen
 178++0787 C3 4D 06         jp workLoop
 179++078A              .skip
 180++078A AF               xor a
 180++078B 32 27 0D       ld (cursor_position), a
 180++078E CD FE 05       call renderGopherScreen
 180++0791 C3 4D 06       jp workLoop
 181++0794
 182++0794              pageDn:
 183++0794 AF                xor a
 183++0795 32 27 0D       ld (cursor_position), a
 184++0798 2A 29 0D         ld hl,(page_offset)
 185++079B 11 16 00         ld de,PER_PAGE
 186++079E 19               add hl,de
 187++079F 22 29 0D         ld (page_offset), hl
 188++07A2 C3 84 07         jp pageUp.exit
 189++07A5
# file closed: gopher/render/gopher-page.asm
   8++07A5                  include "plaintext.asm"
# file opened: gopher/render/plaintext.asm
   1++07A5              renderPlainTextScreen:
   2++07A5 3E FF            ld a, 255
   3++07A7 32 A1 2E         ld (oldminutes), a
   4++07AA CD D9 04         call prepareScreen
   5++07AD
   6++07AD 2A 29 0D         ld hl, (page_offset)        ; HL - offset to 0 Row on screen
   7++07B0 44 4D            ld bc,hl                    ; BC - offset to C Row on screen
   8++07B2 CD A0 04         call Render.findLine        ;BC - Search this line  HL - Return pointer to page with offset
   9++07B5 7C               ld a, h
  10++07B6 B5               or l
  11++07B7 28 30            jr z, .exit2
  12++07B9 AF               xor a
  13++07BA C6 02            add CURSOR_OFFSET
  13++07BC 57 1E 01       ld d, a, e, 1
  13++07BF CD 70 02       call TextMode.gotoXY
  14++07C2 CD 80 03         call print70Text
  15++07C5 06 15            ld b, PER_PAGE -1
  16++07C7              .loop
  17++07C7 C5               push bc
  18++07C8 3E 16            ld a, PER_PAGE
  19++07CA 90               sub b
  20++07CB 5F               ld e,a
  21++07CC 01 01 00         ld bc, 1
  22++07CF CD A3 04         call Render.findLine2   ;BC - Search this line  HL - Return pointer to page with offset
  23++07D2 7C               ld a, h
  24++07D3 B5               or l
  25++07D4 28 10            jr z, .exit
  26++07D6 7B               ld a, e
  27++07D7 C6 02            add CURSOR_OFFSET
  27++07D9 57 1E 01       ld d, a, e, 1
  27++07DC CD 70 02       call TextMode.gotoXY
  28++07DF CD 80 03         call print70Text
  29++07E2 C1               pop bc
  30++07E3 10 E2            djnz .loop
  31++07E5 C9               ret
  32++07E6              .exit
  33++07E6 C1               pop bc
  34++07E7 10 DE            djnz .loop
  35++07E9              .exit2
  36++07E9 CD 3D 07         call showCursor
  37++07EC C9               ret
  38++07ED              plainTextLoop:
  39++07ED CD FC 2D         call printRTC
  40++07F0 CD 8F 09         call Console.getC
  41++07F3
  42++07F3 FE 31            cp '1'
  42++07F5 CA A9 09       jp z, History.back
  43++07F8 FE 32            cp '2'
  43++07FA CA ED 06       jp z, navigate
  44++07FD FE 35            cp '5'
  44++07FF CA 60 08       jp z, textUp
  45++0802 FE 38            cp '8'
  45++0804 CA 50 08       jp z, textDown
  46++0807 FE 1D            cp Console.KEY_LT
  46++0809 CA 60 08       jp z, textUp
  47++080C FE 1C            cp Console.KEY_RT
  47++080E CA 50 08       jp z, textDown
  48++0811
  49++0811 FE 1F            cp Console.KEY_DN
  49++0813 CA 50 08       jp z, textDown
  50++0816 FE 61            cp 'a'
  50++0818 CA 50 08       jp z, textDown
  51++081B
  52++081B FE 1E            cp Console.KEY_UP
  52++081D CA 60 08       jp z, textUp
  53++0820 FE 71            cp 'q'
  53++0822 CA 60 08       jp z, textUp
  54++0825
  55++0825 FE 68            cp 'h'
  55++0827 CA 18 0A       jp z, History.home
  56++082A FE 48            cp 'H'
  56++082C CA 18 0A       jp z, History.home
  57++082F
  58++082F FE 62            cp 'b'
  58++0831 CA A9 09       jp z, History.back
  59++0834 FE 42            cp 'B'
  59++0836 CA A9 09       jp z, History.back
  60++0839
  61++0839 FE 64            cp 'd'
  61++083B CA F3 04       jp z, inputHost
  62++083E FE 44            cp 'D'
  62++0840 CA F3 04       jp z, inputHost
  63++0843
  64++0843 FE 08            cp Console.BACKSPACE
  64++0845 CA A9 09       jp z, History.back
  65++0848
  66++0848                  IFDEF MSX
  67++0848 FE 1B            	cp ESC
  67++084A CA 8E 02       jp z, exit
  68++084D                  ENDIF
  69++084D
  70++084D                  IFDEF GS
  71++084D ~                cp 'M'
  71++084D ~              call z, GeneralSound.toggleModule
  72++084D ~                cp 'm'
  72++084D ~              call z, GeneralSound.toggleModule
  73++084D                  ENDIF
  74++084D
  75++084D                  IFDEF TIMEX80
  76++084D ~                cp 'T'
  76++084D ~              call z, TextMode.toggleColor
  77++084D ~                cp 't'
  77++084D ~              call z, TextMode.toggleColor
  78++084D                  ENDIF
  79++084D
  80++084D C3 ED 07         jp plainTextLoop
  81++0850
  82++0850
  83++0850              textDown:
  84++0850 2A 29 0D         ld hl,(page_offset)
  85++0853 11 16 00         ld de,PER_PAGE
  86++0856 19               add hl,de
  87++0857 22 29 0D         ld (page_offset), hl
  88++085A CD A5 07         call renderPlainTextScreen
  89++085D C3 ED 07         jp plainTextLoop
  90++0860
  91++0860              textUp:
  92++0860 3A 29 0D         ld a, (page_offset)
  92++0863 FE 00          cp 0
  92++0865 20 0A          jr nz, .textUp2
  93++0867 3A 2A 0D         ld a, (page_offset + 1)
  93++086A FE 00          cp 0
  93++086C 20 03          jr nz, .textUp2
  94++086E C3 ED 07         jp plainTextLoop
  95++0871
  96++0871              .textUp2:
  97++0871 2A 29 0D         ld hl,(page_offset)
  98++0874 11 16 00         ld de,PER_PAGE
  99++0877 ED 52            sbc hl,de
 100++0879 22 29 0D         ld (page_offset), hl
 101++087C CD A5 07         call renderPlainTextScreen
 102++087F C3 ED 07         jp plainTextLoop
 103++0882
# file closed: gopher/render/plaintext.asm
   9++0882
  10++0882 00           play_next       db  0
  11++0883              position        EQU historyBlock.position
  12++0883              cursor_position EQU position + 2
  13++0883              page_offset     EQU position + 4
  14++0883
  15++0883                  ENDMODULE
  16++0883
  17++0883                  include "dialogbox.asm"
# file opened: gopher/render/dialogbox.asm
   1++0883                  module DialogBox
   2++0883
   3++0883              inputBox:
   4++0883 AF               xor a
   4++0884 32 DD 08       ld (inputBuffer), a
   5++0887              .noclear
   6++0887 CD 3E 09         call drawBox
   7++088A              .loop
   8++088A 11 05 0B         ld de, #0B05
   8++088D CD 70 02       call TextMode.gotoXY
   9++0890 21 DD 08         ld hl, inputBuffer
   9++0893 CD E1 01       call TextMode.printZ
  10++0896 3E 06            ld a, MIME_INPUT
  10++0898 CD EC 01       call TextMode.putC
  10++089B 3E 20          ld a, ' '
  10++089D CD EC 01       call TextMode.putC
  11++08A0              .checkkey
  12++08A0 CD 96 09         call Console.peekC
  13++08A3 FE 00            cp 00
  13++08A5 CA A0 08        jp z, .checkkey
  14++08A8 FE 0D            cp CR
  14++08AA C8             ret z
  15++08AB
  16++08AB                  IFNDEF MSX
  17++08AB ~                dup 11
  18++08AB ~                halt
  19++08AB ~                edup
  20++08AB                  ENDIF
  21++08AB
  22++08AB FE 08            cp Console.BACKSPACE
  22++08AD 28 13          jr z, .removeChar
  23++08AF FE 20            cp SPACE
  23++08B1 38 ED          jr c, .checkkey
  24++08B3              .putC
  25++08B3 5F               ld e, a
  26++08B4 AF               xor a
  26++08B5 21 DD 08 01    ld hl, inputBuffer, bc, #ff
  26++08B9 FF 00
  26++08BB ED B1          cpir
  27++08BD 77               ld (hl), a
  27++08BE 2B             dec hl
  27++08BF 73             ld (hl), e
  28++08C0 18 C8            jr .loop
  29++08C2              .removeChar
  30++08C2 AF               xor a
  31++08C3 21 DD 08 01      ld hl, inputBuffer, bc, #ff
  31++08C7 FF 00
  31++08C9 ED B1          cpir
  32++08CB E5               push hl
  33++08CC 11 DE 08             ld de, inputBuffer + 1
  34++08CF B7                   or a
  34++08D0 ED 52          sbc hl, de
  35++08D2 7C                   ld a, h
  35++08D3 B5             or l
  36++08D4 E1               pop hl
  37++08D5 28 B3            jr z, .loop
  38++08D7 AF               xor a
  39++08D8 2B               dec hl
  39++08D9 2B             dec hl
  39++08DA 77             ld (hl), a
  40++08DB 18 AD            jr .loop
  41++08DD
  42++08DD
  43++08DD              namedownload
  44++08DD                  IFDEF NEDOOS
  45++08DD ~            		db "..",92,"downloads",92
  46++08DD                  ENDIF
  47++08DD
  48++08DD 00 00 00...  inputBuffer ds 80
  49++092D
  50++092D              msgBox:
  51++092D CD 36 09         call msgNoWait
  52++0930 06 96            ld b, 150
  53++0932              .loop
  54++0932 76               halt
  55++0933 10 FD            djnz .loop
  56++0935 C9               ret
  57++0936
  58++0936              msgNoWait:
  59++0936 E5               push hl
  60++0937 CD 3E 09         call drawBox
  61++093A E1               pop hl
  62++093B C3 E1 01         jp TextMode.printZ
  63++093E
  64++093E              drawBox:
  65++093E 26 0A 3E 07      ld h, #0a, a, BORDER_TOP
  66++0942 CD 0F 02         call TextMode.fillLine
  67++0945 26 0B 3E 20      ld h, #0b, a, ' '
  68++0949 CD 0F 02         call TextMode.fillLine
  69++094C 26 0C 3E 08      ld h, #0c, a, BORDER_BOTTOM
  70++0950 CD 0F 02         call TextMode.fillLine
  71++0953 3E 0A            ld a, #0a
  72++0955 CD BD 01         call TextMode.highlightLine
  73++0958 3E 0C            ld a, #0c
  74++095A CD BD 01         call TextMode.highlightLine
  75++095D 11 03 0B         ld de,#0B03
  76++0960 CD 70 02         call TextMode.gotoXY
  77++0963 C9               ret
  78++0964                  endmodule
  79++0964
# file closed: gopher/render/dialogbox.asm
# file closed: gopher/render/index.asm
   9+ 0964                  include "dos/msxdos.asm"
# file opened: dos/msxdos.asm
   1++0964              BDOS = 5
   2++0964                  include "msxfiles.asm"
# file opened: dos/msxfiles.asm
   1++0964              FMODE_RW       = %000
   2++0964              FMODE_NO_WRITE = %001
   3++0964              FMODE_NO_READ  = %010
   4++0964              FMODE_INHERIT  = %100
   5++0964
   6++0964              ATTR_NOTHING   = #00
   7++0964              ATTR_RDONLY    = #01
   8++0964              ATTR_HIDDEN    = #02
   9++0964              ATTR_SYSTEM    = #04
  10++0964              ATTR_VOLUME    = #08
  11++0964              ATTR_DIRECTORY = #10
  12++0964              ATTR_ARCHIVE   = #20
  13++0964              ATTR_DEVICE    = #80
  14++0964
  15++0964                  module Dos
  16++0964              ; DE -> filename
  17++0964              ; A -> mode
  18++0964              ;
  19++0964              ; A <- Error
  20++0964              ; B <- Handle
  21++0964              fopen:
  22++0964 0E 43            ld c, #43
  23++0966 C3 05 00         jp BDOS
  24++0969
  25++0969              ; DE -> filename
  26++0969              ; A  -> mode
  27++0969              ; B  -> attribute
  28++0969              ;
  29++0969              ; A <- error
  30++0969              ; B <- handle
  31++0969              fcreate:
  32++0969 0E 44            ld c, #44
  33++096B C3 05 00         jp BDOS
  34++096E
  35++096E              ; B <- Handle
  36++096E              ;
  37++096E              ; A <- Error
  38++096E              fclose:
  39++096E 0E 45            ld c, #45
  40++0970 C3 05 00         jp BDOS
  41++0973
  42++0973              ; B <- Handle
  43++0973              fsync:
  44++0973 0E 46            ld c, #46
  45++0975 C3 05 00         jp BDOS
  46++0978
  47++0978              ; B <- Handle
  48++0978              ; DE <- buffer
  49++0978              ; HL <- Count
  50++0978              ;
  51++0978              ; A <- error
  52++0978              ; HL <- actually read
  53++0978              fread:
  54++0978 0E 48            ld c, #48
  55++097A C3 05 00         jp BDOS
  56++097D              ; B <- Handle
  57++097D              ; DE <- Buffer
  58++097D              ; HL <- Count
  59++097D              ;
  60++097D              ; HL <- actully written
  61++097D              ; A <- Error
  62++097D              fwrite:
  63++097D 0E 49            ld c, #49
  64++097F C3 05 00         jp BDOS
  65++0982                  endmodule
  66++0982
# file closed: dos/msxfiles.asm
   3++0982                  include "msxconsole.asm"
# file opened: dos/msxconsole.asm
   1++0982                  module Console
   2++0982              KEY_UP = 30
   3++0982              KEY_DN = 31
   4++0982              KEY_LT = 29
   5++0982              KEY_RT = 28
   6++0982              BACKSPACE = 8
   7++0982              newLine:
   8++0982 3E 0D            ld a, CR
   9++0984 CD 89 09         call putC
  10++0987 3E 0A            ld a, LF
  11++0989              putC:
  12++0989 5F               ld e, a
  13++098A 0E 02            ld c, 2
  14++098C C3 05 00         jp BDOS
  15++098F
  16++098F              getC:
  17++098F DD 21 9F 00      ld ix, #9f
  18++0993 C3 42 03         jp biosC
  19++0996
  20++0996              peekC:
  21++0996 0E 06 1E FF      ld c, 6, e, #ff
  22++099A C3 05 00         jp BDOS
  23++099D
  24++099D              putStringZ:
  25++099D 7E               ld a, (hl)
  26++099E A7               and a
  27++099F C8               ret z
  28++09A0 E5               push hl
  29++09A1 CD 89 09         call putC
  30++09A4 E1               pop hl
  31++09A5 23               inc hl
  32++09A6 18 F5            jr putStringZ
  33++09A8
  34++09A8              waitForKeyUp:
  35++09A8 C9               ret
  36++09A9
  37++09A9                  endmodule
# file closed: dos/msxconsole.asm
   4++09A9
   5++09A9
# file closed: dos/msxdos.asm
  10+ 09A9                  include "gopher/engine/history/index.asm"
# file opened: gopher/engine/history/index.asm
   1++09A9                  include "controler.asm"
# file opened: gopher/engine/history/controler.asm
   1++09A9                  module History
   2++09A9              back:
   3++09A9 3A DE 0A         ld a, (depth)
   3++09AC FE 01          cp 1
   3++09AE CA C0 09       jp z, load
   4++09B1 21 2D 0D 11      ld hl, historyBlock + HistoryRecord, de, historyBlock, bc, (total - 1) * HistoryRecord
   4++09B5 DF 0A 01 38
   4++09B9 09
   4++09BA ED B0          ldir ; Move history up
   5++09BC 21 DE 0A         ld hl, depth
   5++09BF 35             dec (hl)
   6++09C0              ; Loads current resource
   7++09C0              load:
   8++09C0 21 DF 09         ld hl, .msg
   8++09C3 CD 36 09       call DialogBox.msgNoWait
   9++09C6 AF               xor a
   9++09C7 21 FA 2E 11    ld hl, outputBuffer, de, outputBuffer + 1
   9++09CB FB 2E
  10++09CD              	IFDEF MSX
  11++09CD ED 4B F8 2E      	ld bc, (ramtop)
  12++09D1 0B               	dec bc
  13++09D2              	ELSE
  14++09D2 ~                	ld bc, #ffff - outputBuffer - 1
  15++09D2              	ENDIF
  16++09D2
  17++09D2 77               ld (hl), a
  18++09D3 ED B0            ldir
  19++09D5
  20++09D5 3A DF 0A         ld a, (historyBlock.isFile)
  20++09D8 A7             and a
  20++09D9 C2 C9 19       jp nz, Fetcher.fetchFromFS
  21++09DC C3 7C 19         jp Fetcher.fetchFromNet
  22++09DF
  23++09DF 20 20 20 20  .msg db "    Loading resource! Please wait! It will be here soon!", 0
  23++09E3 4C 6F 61 64
  23++09E7 69 6E 67 20
  23++09EB 72 65 73 6F
  23++09EF 75 72 63 65
  23++09F3 21 20 50 6C
  23++09F7 65 61 73 65
  23++09FB 20 77 61 69
  23++09FF 74 21 20 49
  23++0A03 74 20 77 69
  23++0A07 6C 6C 20 62
  23++0A0B 65 20 68 65
  23++0A0F 72 65 20 73
  23++0A13 6F 6F 6E 21
  23++0A17 00
  24++0A18
  25++0A18              home:
  26++0A18 21 C4 0A         ld hl, homePage
  27++0A1B              ; HL - gopher row
  28++0A1B              navigate:
  29++0A1B 54 5D            ld de, hl
  30++0A1D CD F4 18         call UrlEncoder.isValidGopherRow
  31++0A20 30 9E            jr nc, load ; Not valid - reload last
  32++0A22 62 6B            ld hl, de
  33++0A24 E5               push hl
  34++0A25
  35++0A25 E5               push hl
  36++0A26 21 64 16 11      ld hl, HistoryEnd - HistoryRecord, de, HistoryEnd, bc,  HistoryRecord * total
  36++0A2A B2 18 01 86
  36++0A2E 0B
  36++0A2F ED B8          lddr
  37++0A31
  38++0A31 ED 5B 25 0D      ld de, (Render.position), (historyBlock.position + HistoryRecord), de
  38++0A35 ED 53 73 0F
  39++0A39                  ; Clean up struct
  40++0A39 AF               xor a
  40++0A3A 21 DF 0A 11    ld hl, historyBlock, de, historyBlock + 1, bc, historyBlockSize - 1, (hl), a
  40++0A3E E0 0A 01 4D
  40++0A42 02 77
  40++0A44 ED B0          ldir
  41++0A46 E1               pop hl
  42++0A47
  43++0A47                  ; Fill record
  44++0A47 54 5D            ld de, hl
  45++0A49 CD B3 18         call UrlEncoder.isFile
  46++0A4C EB               ex hl, de
  47++0A4D 11 DF 0A         ld de, historyBlock
  48++0A50 12               ld (de), a
  48++0A51 13             inc de
  49++0A52 7E               ld a, (hl)
  49++0A53 E5 D5          push hl, de
  49++0A55 CD C6 03       call Render.getIcon
  49++0A58 D1 E1          pop de, hl
  50++0A5A 12               ld (de), a
  50++0A5B 13             inc de
  51++0A5C 3E 09            ld a, 9
  52++0A5E
  53++0A5E                  IFDEF MSX
  54++0A5E 01 FF 00         	ld bc, #ff
  55++0A61                  ELSE
  56++0A61 ~                	ld bc, #ff
  57++0A61                  ENDIF
  58++0A61
  59++0A61 ED B1            cpir
  60++0A63              .locatorCopy
  61++0A63 7E               ld a, (hl)
  61++0A64 FE 09          cp 9
  61++0A66 28 05          jr z, 1f
  62++0A68 12               ld (de), a
  62++0A69 23 13          inc hl, de
  63++0A6B 18 F6            jr .locatorCopy
  64++0A6D              1
  65++0A6D 23               inc hl
  65++0A6E AF             xor a
  65++0A6F 12             ld (de), a
  66++0A70 11 E0 0B         ld de, historyBlock.host
  67++0A73              .hostCopy
  68++0A73 7E               ld a, (hl)
  68++0A74 FE 09          cp 9
  68++0A76 28 05          jr z, 1f
  69++0A78 12               ld (de), a
  69++0A79 23 13          inc hl, de
  70++0A7B 18 F6            jr .hostCopy
  71++0A7D              1
  72++0A7D 23               inc hl
  72++0A7E AF             xor a
  72++0A7F 12             ld (de), a
  73++0A80 11 20 0C         ld de, historyBlock.port
  74++0A83              .portCopy
  75++0A83 7E               ld a, (hl)
  76++0A84 FE 09            cp 9
  76++0A86 28 11          jr z, 1f
  77++0A88 FE 0D            cp 13
  77++0A8A 28 0D          jr z, 1f
  78++0A8C FE 0A            cp 10
  78++0A8E 28 09          jr z, 1f
  79++0A90 FE 00            cp 0
  79++0A92 28 05          jr z, 1f
  80++0A94 12               ld (de), a
  80++0A95 23 13          inc hl, de
  81++0A97 18 EA            jr .portCopy
  82++0A99 AF           1   xor a
  82++0A9A 12             ld (de), a
  83++0A9B 21 DD 08 11      ld hl, DialogBox.inputBuffer, de, historyBlock.search, bc, #ff
  83++0A9F 26 0C 01 FF
  83++0AA3 00
  83++0AA4 ED B0          ldir
  84++0AA6 11 00 00 ED      ld de, 0, (historyBlock.position), de
  84++0AAA 53 25 0D
  85++0AAD E1               pop hl
  86++0AAE 3A DE 0A         ld a, (depth)
  86++0AB1 FE 05          cp total
  86++0AB3 30 04          jr nc, 1f
  87++0AB5 3C               inc a
  87++0AB6 32 DE 0A       ld (depth), a
  88++0AB9              1
  89++0AB9 3A E0 0A         ld a,(historyBlock.mediaType)
  89++0ABC FE 01          cp MIME_DOWNLOAD
  89++0ABE CA 28 21       jp z, Gopher.download
  90++0AC1
  91++0AC1                  ifdef GS
  92++0AC1 ~                cp MIME_MOD
  92++0AC1 ~              jp z, Gopher.loadMod
  93++0AC1                  endif
  94++0AC1
  95++0AC1 C3 C0 09         jp load
  96++0AC4
  97++0AC4              homePage:
  98++0AC4              	IFDEF MSX
  99++0AC4 31 48 6F 6D      	db "1Home", TAB, "index.gph"
  99++0AC8 65 09 69 6E
  99++0ACC 64 65 78 2E
  99++0AD0 67 70 68
 100++0AD3 09 66 69 6C      	db TAB, "file", TAB, "70", CR, LF, 0
 100++0AD7 65 09 37 30
 100++0ADB 0D 0A 00
 101++0ADE                  ELSE
 102++0ADE ~                	db "1Home", TAB, "browser/index.gph"
 103++0ADE ~                	db TAB, "file", TAB, "70", CR, LF, 0
 104++0ADE                  ENDIF
 105++0ADE                  endmodule
# file closed: gopher/engine/history/controler.asm
   2++0ADE                  include "model.asm"
# file opened: gopher/engine/history/model.asm
   1++0ADE              total   equ 5
   2++0ADE 00           depth   db 0
   3++0ADF
   4++0ADF              historyBlock:
   5++0ADF 00           .isFile    db  0
   6++0AE0 00           .mediaType db  0
   7++0AE1 00 00 00...  .locator   ds  #ff
   8++0BE0 00 00 00...  .host      ds  64
   9++0C20 00 00 00...  .port      ds  6
  10++0C26 00 00 00...  .search    ds  #ff
  11++0D25 00 00        .position  dw  #0000    ;position
  12++0D27
  13++0D27 00 00 00 00      db 0,0,0,0,0,0  ;cursor_position page_offset
  13++0D2B 00 00
  14++0D2D
  15++0D2D              historyBlockSize = $ - historyBlock
  16++0D2D
  17++0D2D              HistoryRecord EQU $ - historyBlock
  18++0D2D                  dup total
  19++0D2D 00 00 00... >    ds HistoryRecord
  19++0F7B 00 00 00... >    ds HistoryRecord
  19++11C9 00 00 00... >    ds HistoryRecord
  19++1417 00 00 00... >    ds HistoryRecord
  19++1665 00 00 00... >    ds HistoryRecord
  20++18B3                  edup
  21++18B3              HistoryEnd equ $ - 1
  22++18B3
# file closed: gopher/engine/history/model.asm
# file closed: gopher/engine/history/index.asm
  11+ 18B3                  include "gopher/engine/urlencoder.asm"
# file opened: gopher/engine/urlencoder.asm
   1++18B3                  MODULE UrlEncoder
   2++18B3              ; HL - pointer to line in gopher page
   3++18B3              ; C - flag set when it's file
   4++18B3              isFile:
   5++18B3              .findServerLoop
   6++18B3 7E               ld a, (hl)
   6++18B4 A7             and a
   6++18B5 28 3B          jr z, .notFile
   6++18B7 23             inc hl
   7++18B8 FE 0D            cp 13
   7++18BA 28 36          jr z, .notFile
   8++18BC FE 09            cp 9
   8++18BE 28 02          jr z, .skipPath
   9++18C0 18 F1            jr .findServerLoop
  10++18C2              .skipPath
  11++18C2 7E               ld a, (hl)
  11++18C3 A7             and a
  11++18C4 28 2C          jr z, .notFile
  11++18C6 23             inc hl
  12++18C7 FE 0D            cp 13
  12++18C9 28 27          jr z, .notFile
  13++18CB FE 09            cp 9
  13++18CD 28 02          jr z, .compareServer
  14++18CF 18 F1            jr .skipPath
  15++18D1              .compareServer
  16++18D1 7E               ld a, (hl)
  16++18D2 FE 66          cp "f"
  16++18D4 20 1C          jr nz, .notFile
  16++18D6 23             inc hl
  17++18D7 7E               ld a, (hl)
  17++18D8 FE 69          cp "i"
  17++18DA 20 16          jr nz, .notFile
  17++18DC 23             inc hl
  18++18DD 7E               ld a, (hl)
  18++18DE FE 6C          cp "l"
  18++18E0 20 10          jr nz, .notFile
  18++18E2 23             inc hl
  19++18E3 7E               ld a, (hl)
  19++18E4 FE 65          cp "e"
  19++18E6 20 0A          jr nz, .notFile
  19++18E8 23             inc hl
  20++18E9 7E               ld a, (hl)
  20++18EA FE 09          cp 9
  20++18EC 20 04          jr nz, .notFile
  20++18EE 23             inc hl
  21++18EF 3E 01            ld a, 1
  22++18F1 C9               ret
  23++18F2              .notFile
  24++18F2 AF               xor a
  25++18F3 C9               ret
  26++18F4
  27++18F4              ; Is enough fields to encode
  28++18F4              ; HL - pointer to line in gopher page
  29++18F4              ; C - flag set when there is enough fields
  30++18F4              isValidGopherRow:
  31++18F4 7E               ld a, (hl)
  31++18F5 A7             and a
  31++18F6 28 FA          jr z, isFile.notFile
  31++18F8 23             inc hl
  32++18F9 FE 0D            cp 13
  32++18FB 28 F5          jr z, isFile.notFile
  33++18FD FE 09            cp 9
  33++18FF 28 02          jr z, .skipPath
  34++1901 18 F1            jr isValidGopherRow
  35++1903              .skipPath
  36++1903 7E               ld a, (hl)
  36++1904 A7             and a
  36++1905 28 EB          jr z, isFile.notFile
  36++1907 23             inc hl
  37++1908 FE 0D            cp 13
  37++190A 28 E6          jr z, isFile.notFile
  38++190C FE 09            cp 9
  38++190E 28 02          jr z, .skipHost
  39++1910 18 F1            jr .skipPath
  40++1912              .skipHost
  41++1912 7E               ld a, (hl)
  41++1913 A7             and a
  41++1914 28 DC          jr z, isFile.notFile
  41++1916 23             inc hl
  42++1917 FE 0D            cp 13
  42++1919 28 D7          jr z, isFile.notFile
  43++191B FE 09            cp 9
  43++191D 28 02           jr z, .isValid
  44++191F 18 F1            jr .skipHost
  45++1921              .isValid:
  46++1921 37               scf
  47++1922 C9               ret
  48++1923
  49++1923              extractPath:
  50++1923 21 E1 0A 11      ld hl, historyBlock.locator, de, Gopher.requestbuffer, bc, #ff
  50++1927 43 22 01 FF
  50++192B 00
  50++192C ED B0          ldir
  51++192E C9               ret
  52++192F
  53++192F              extractHostName:
  54++192F 21 E0 0B 11      ld hl, historyBlock.host, de, hostName, bc, 64
  54++1933 3C 19 01 40
  54++1937 00
  54++1938 ED B0          ldir
  55++193A C9               ret
  56++193B
  57++193B                  ENDMODULE
  58++193B
  59++193B              ;nameBuffer ds #ff, 0
  60++193B
  61++193B 00                    db 0
  62++193C 00 00 00...  hostName ds 64
# file closed: gopher/engine/urlencoder.asm
  12+ 197C                  include "gopher/engine/fetcher.asm"
# file opened: gopher/engine/fetcher.asm
   1++197C                  MODULE Fetcher
   2++197C
   3++197C              fetchFromNet:
   4++197C
   5++197C              	IFDEF MSX
   6++197C CD A8 20         	call Gopher.makeRequest
   6++197F 20 06          jr nz, .error
   7++1981                  ELSE
   8++1981 ~                	call Gopher.makeRequest
   8++1981 ~              jr c, .error
   9++1981                  ENDIF
  10++1981
  11++1981 CD DF 20         call Gopher.loadBuffer
  12++1984 C3 EC 19         jp MediaProcessor.processResource
  13++1987              .error
  14++1987 21 90 19         ld hl, .err
  14++198A CD 2D 09       call DialogBox.msgBox
  15++198D C3 A9 09         jp History.back
  16++1990
  17++1990 44 6F 63 75  .err db "Document fetch error! Check your connection or hostname!", 0
  17++1994 6D 65 6E 74
  17++1998 20 66 65 74
  17++199C 63 68 20 65
  17++19A0 72 72 6F 72
  17++19A4 21 20 43 68
  17++19A8 65 63 6B 20
  17++19AC 79 6F 75 72
  17++19B0 20 63 6F 6E
  17++19B4 6E 65 63 74
  17++19B8 69 6F 6E 20
  17++19BC 6F 72 20 68
  17++19C0 6F 73 74 6E
  17++19C4 61 6D 65 21
  17++19C8 00
  18++19C9
  19++19C9
  20++19C9              fetchFromFS:
  21++19C9 CD 23 19         call UrlEncoder.extractPath
  22++19CC              loadFile
  23++19CC              	IFDEF MSX
  24++19CC 11 43 22 3E      ld de, Gopher.requestbuffer, a, FMODE_NO_WRITE
  24++19D0 01
  25++19D1 CD 64 09         call Dos.fopen
  26++19D4 78 32 EB 19      ld a, b, (.fp), a
  27++19D8 11 FA 2E 2A      ld de, outputBuffer, hl, (ramtop)
  27++19DC F8 2E
  28++19DE CD 78 09         call Dos.fread
  29++19E1 3A EB 19 47      ld a, (.fp), b, a
  30++19E5 CD 6E 09         call Dos.fclose
  31++19E8 C3 EC 19         jp MediaProcessor.processResource
  32++19EB 00           .fp db 0
  33++19EC              	ELSE
  34++19EC ~                ld hl, Gopher.requestbuffer
  35++19EC ~                call Dos.loadBuffer
  36++19EC ~                jp MediaProcessor.processResource
  37++19EC              	ENDIF
  38++19EC                  ENDMODULE
# file closed: gopher/engine/fetcher.asm
  13+ 19EC                  include "gopher/engine/media-processor.asm"
# file opened: gopher/engine/media-processor.asm
   1++19EC                  MODULE MediaProcessor
   2++19EC              processResource:
   3++19EC CD 2F 19         call UrlEncoder.extractHostName
   4++19EF 3A E0 0A         ld a, (historyBlock.mediaType)
   5++19F2 FE 05            cp MIME_MUSIC
   5++19F4 28 13          jr z, processPT
   6++19F6 FE 02            cp MIME_LINK
   6++19F8 28 15          jr z, processPage
   7++19FA FE 06            cp MIME_INPUT
   7++19FC 28 11          jr z, processPage
   8++19FE FE 04            cp MIME_IMAGE
   8++1A00 CA 42 24       jp z, ScreenViewer.display
   9++1A03              	ifdef GS
  10++1A03 ~                cp MIME_MOD
  10++1A03 ~              jr z, processMOD
  11++1A03              	endif
  12++1A03              ; Fallback to plain text
  13++1A03              processText:
  14++1A03 CD A5 07         call Render.renderPlainTextScreen
  15++1A06 C3 ED 07         jp   Render.plainTextLoop
  16++1A09
  17++1A09              processPT:
  18++1A09 CD 66 25         call VortexProcessor.play
  19++1A0C C3 A9 09         jp History.back
  20++1A0F
  21++1A0F                  ifdef GS
  22++1A0F ~            processMOD:
  23++1A0F ~                call ModProcessor.play
  24++1A0F ~                jp History.back
  25++1A0F              	endif
  26++1A0F
  27++1A0F              processPage:
  28++1A0F 3A 82 08         ld a, (Render.play_next)
  28++1A12 A7             and a
  28++1A13 20 06          jr nz, .playNext
  29++1A15 CD FE 05         call Render.renderGopherScreen
  30++1A18 C3 4D 06         jp   Render.workLoop
  31++1A1B              .playNext
  32++1A1B 21 27 0D         ld hl, Render.cursor_position
  33++1A1E 34               inc (hl)
  34++1A1F CD FE 05         call Render.renderGopherScreen
  35++1A22 C3 37 06         jp Render.checkBorder
  36++1A25                  ENDMODULE
# file closed: gopher/engine/media-processor.asm
  14+ 1A25                  include "drivers/index.asm"
# file opened: drivers/index.asm
   1++1A25                  IFDEF UNO
   2++1A25 ~                	include "uart-uno.asm"
   3++1A25                  ENDIF
   4++1A25
   5++1A25                  IFDEF UNOUART
   6++1A25 ~                	include "uart-uno.asm"
   7++1A25                  ENDIF
   8++1A25
   9++1A25                  IFDEF MB03
  10++1A25 ~                	include "uart-mb03.asm"
  11++1A25                  ENDIF
  12++1A25
  13++1A25                  IFDEF AY
  14++1A25 ~                	include "uart-ay.asm"
  15++1A25                  ENDIF
  16++1A25
  17++1A25                  IFDEF ZW
  18++1A25 ~                	include "uart-zxwifi.asm"
  19++1A25                  ENDIF
  20++1A25
  21++1A25              	include "utils.asm"
# file opened: drivers/utils.asm
   1++1A25              ;;; Macroses!!!!
   2++1A25                  MACRO EspSend Text
   3++1A25 ~                ld hl, .txtB
   4++1A25 ~                ld e, (.txtE - .txtB)
   5++1A25 ~                call espSend
   6++1A25 ~                jr .txtE
   7++1A25 ~            .txtB
   8++1A25 ~                db Text
   9++1A25 ~            .txtE
  10++1A25                  ENDM
  11++1A25
  12++1A25                  MACRO EspCmd Text
  13++1A25 ~                ld hl, .txtB
  14++1A25 ~                ld e, (.txtE - .txtB)
  15++1A25 ~                call espSend
  16++1A25 ~                jr .txtE
  17++1A25 ~            .txtB
  18++1A25 ~                db Text
  19++1A25 ~                db 13, 10
  20++1A25 ~            .txtE
  21++1A25                  ENDM
  22++1A25
  23++1A25                  MACRO EspCmdOkErr text
  24++1A25 ~                EspCmd text
  25++1A25 ~                call checkOkErr
  26++1A25                  ENDM
  27++1A25
  28++1A25              ; IN DE - string pointer
  29++1A25              ; OUT HL - string len
  30++1A25              strLen:
  31++1A25 21 00 00         ld hl, 0
  32++1A28              .loop
  33++1A28 1A               ld a, (de)
  33++1A29 A7             and a
  33++1A2A C8             ret z
  34++1A2B 13 23            inc de, hl
  35++1A2D 18 F9            jr .loop
# file closed: drivers/utils.asm
  22++1A2F
  23++1A2F              	IFDEF UARTATM
  24++1A2F ~            		include "uart-atm.asm"
  25++1A2F              	ENDIF
  26++1A2F
  27++1A2F              	IFDEF UARTEVO
  28++1A2F ~            		include "uart-evo.asm"
  29++1A2F                  ENDIF
  30++1A2F
  31++1A2F              	IFDEF NEDONET
  32++1A2F ~            		include "nedowifi.asm"
  33++1A2F              	ELSE
  34++1A2F              	IFNDEF MSX
  35++1A2F ~            		include "wifi.asm"
  36++1A2F              	ENDIF
  37++1A2F              	ENDIF
  38++1A2F
  39++1A2F                  IFDEF NEDOOS
  40++1A2F ~                	include "rtc-nos.asm"
  41++1A2F                  ENDIF
  42++1A2F
  43++1A2F
  44++1A2F                  IFDEF SMUCRTC
  45++1A2F ~                	include "rtc-smuc.asm"
  46++1A2F                  ENDIF
  47++1A2F
  48++1A2F              	IFDEF MSX
  49++1A2F                      include "drivers/unapi/unapi.asm"
# file opened: ./drivers/unapi/unapi.asm
   1++1A2F                  module UnApi
   2++1A2F              EXTBIOS = #FFCA
   3++1A2F              TPASLOT1 = #F342
   4++1A2F              MAPPER = #0402
   5++1A2F              ARG = #F847
   6++1A2F              DISCOVER = #2222
   7++1A2F              ENABLE_SLOT = #0024
   8++1A2F              TPA_SLOT_1 = #F342
   9++1A2F
  10++1A2F              preinit:
  11++1A2F 11 02 04         ld de, MAPPER
  12++1A32 AF               xor a
  13++1A33 CD CA FF         call EXTBIOS
  14++1A36 B7               or a
  15++1A37 28 13            jr z, .noMapper
  16++1A39
  17++1A39 01 1E 00         ld bc, 30 ; skip all_segs mapper
  18++1A3C 09               add hl, bc
  19++1A3D 11 D2 1A         ld de, put_p1 ; replace direct routines
  20++1A40 0E 06            ld c, 6
  21++1A42 ED B0            ldir
  22++1A44
  23++1A44 CD D5 1A         call get_p1
  24++1A47 32 D8 1A         ld (tpa_seg_1), a
  25++1A4A B7               or a
  26++1A4B C9               ret
  27++1A4C              .noMapper
  28++1A4C 37               scf
  29++1A4D C9               ret
  30++1A4E
  31++1A4E              ; HL - string to implementation
  32++1A4E              initApi:
  33++1A4E 11 47 F8         ld de, ARG
  34++1A51 01 0F 00         ld bc, 15
  35++1A54 ED B0            ldir
  36++1A56              .copied
  37++1A56 AF               xor a
  38++1A57 12               ld (de), a
  39++1A58 47               ld b, a
  40++1A59 11 22 22         ld de, DISCOVER
  41++1A5C CD CA FF         call EXTBIOS
  42++1A5F 78               ld a, b
  43++1A60 B7               or a
  44++1A61 32 92 1A         ld (.num + 1), a
  45++1A64 C8               ret z
  46++1A65
  47++1A65 3E 01            ld a, 1 ; First implementation
  48++1A67 11 22 22         ld de, DISCOVER
  49++1A6A CD CA FF         call EXTBIOS
  50++1A6D
  51++1A6D 22 B2 1A         ld (unapiCall + 1), hl ; Store address
  52++1A70 4F               ld c, a
  53++1A71 7C               ld a, h
  54++1A72 FE C0            cp #c0
  55++1A74 79               ld a, c
  56++1A75 38 07            jr c, .noP3
  57++1A77
  58++1A77 3E C9            ld a, #c9
  59++1A79 32 94 1A         ld (setUnApi), a
  60++1A7C 18 12            jr .okSet
  61++1A7E              .noP3
  62++1A7E 32 9E 1A         ld (unApiSlot + 1), a
  63++1A81 78               ld a, b
  64++1A82 FE FF            cp #ff
  65++1A84 20 07            jr nz, .noRom
  66++1A86
  67++1A86 3E C9            ld a, #c9
  68++1A88 32 A4 1A         ld (unApiSeg), a
  69++1A8B 18 03            jr .okSet
  70++1A8D              .noRom
  71++1A8D 32 A5 1A         ld (unApiSeg + 1), a
  72++1A90              .okSet
  73++1A90 37               scf
  74++1A91              .num
  75++1A91 3E 00            ld a, 0
  76++1A93 C9               ret
  77++1A94
  78++1A94              setUnApi:
  79++1A94 3A D9 1A         ld a, (unapi_is_set)
  80++1A97 B7               or a
  81++1A98 C0               ret nz
  82++1A99 3D               dec a
  83++1A9A 32 D9 1A         ld (unapi_is_set), a
  84++1A9D              unApiSlot:
  85++1A9D 3E 00            ld a, 0
  86++1A9F 26 40            ld h, #40
  87++1AA1 CD 24 00         call ENABLE_SLOT
  88++1AA4              unApiSeg
  89++1AA4 3E 00            ld a, 0
  90++1AA6 C3 D2 1A         jp put_p1
  91++1AA9
  92++1AA9              callUnApi:
  93++1AA9 08               ex af, af'
  94++1AAA D9               exx
  95++1AAB CD 94 1A         call setUnApi
  96++1AAE FB               ei
  97++1AAF 08               ex af, af'
  98++1AB0 D9               exx
  99++1AB1              unapiCall:
 100++1AB1 C3 00 00         jp 0
 101++1AB4
 102++1AB4              tpaUnApiCall:
 103++1AB4 CD A9 1A         call callUnApi
 104++1AB7              exit:
 105++1AB7 F5 C5 D5 E5      push af, bc, de, hl
 106++1ABB AF               xor a
 107++1ABC 32 D9 1A         ld (unapi_is_set), a
 108++1ABF 3A 42 F3         ld a, (TPA_SLOT_1)
 109++1AC2 26 40            ld h, #40
 110++1AC4 CD 24 00         call ENABLE_SLOT
 111++1AC7 3A D8 1A         ld a, (tpa_seg_1)
 112++1ACA CD D2 1A         call put_p1
 113++1ACD E1 D1 C1 F1      pop hl, de, bc, af
 114++1AD1 C9               ret
 115++1AD2
 116++1AD2              put_p1:
 117++1AD2 D3 FE            out (#fe), a
 118++1AD4 C9               ret
 119++1AD5              get_p1:
 120++1AD5 DB FE            in a, (#fe)
 121++1AD7 C9               ret
 122++1AD8
 123++1AD8 00           tpa_seg_1 db 0
 124++1AD9 00           unapi_is_set db 0
 125++1ADA                  endmodule
# file closed: ./drivers/unapi/unapi.asm
  50++1ADA                  	include "drivers/unapi/tcp.asm"
# file opened: ./drivers/unapi/tcp.asm
   1++1ADA              ;;; TPA SAFE TcpIP operations
   2++1ADA                  module TcpIP
   3++1ADA              START_RESOLVE = 6
   4++1ADA              GET_DNS_RESULT = 7
   5++1ADA              TCP_WAIT = 29
   6++1ADA
   7++1ADA              OPEN_TCP = 13
   8++1ADA              CLOSE_TCP = 14
   9++1ADA              ABORT_TCP = 15
  10++1ADA              STATE_TCP = 16
  11++1ADA              SEND_TCP = 17
  12++1ADA              RECV_TCP = 18
  13++1ADA
  14++1ADA              ; C - init successful
  15++1ADA              ; Closes all connections
  16++1ADA              init:
  17++1ADA CD 2F 1A         call UnApi.preinit
  18++1ADD 21 D3 1F         ld hl, api
  19++1AE0 CD 4E 1A         call UnApi.initApi
  20++1AE3 D0               ret nc ; If error
  21++1AE4 CD 87 1B         call closeAll
  22++1AE7 37               scf
  23++1AE8 C9               ret
  24++1AE9
  25++1AE9
  26++1AE9              ; HL - domain string
  27++1AE9              ; C - success flag
  28++1AE9              ; L.H.E.D. - IP addr(if no error)
  29++1AE9              resolveIp:
  30++1AE9 11 93 1B         ld de, dnsbuff
  31++1AEC              .loop
  32++1AEC 7E               ld a, (hl)
  33++1AED 12               ld (de), a
  34++1AEE 23               inc hl
  35++1AEF 13               inc de
  36++1AF0 A7               and a
  37++1AF1 20 F9            jr nz, .loop
  38++1AF3 12               ld (de), a
  39++1AF4
  40++1AF4 21 93 1B         ld hl, dnsbuff
  41++1AF7 3E 06            ld a, START_RESOLVE
  42++1AF9 06 00            ld b, 0
  43++1AFB CD B4 1A         call UnApi.tpaUnApiCall
  44++1AFE
  45++1AFE 3E 1D            ld a, TCP_WAIT
  46++1B00 CD B4 1A         call UnApi.tpaUnApiCall
  47++1B03              .resolveLoop
  48++1B03 3E 07            ld a, GET_DNS_RESULT
  49++1B05 06 01            ld b, 1
  50++1B07 CD B4 1A         call UnApi.tpaUnApiCall
  51++1B0A A7               and a
  51++1B0B C2 15 1B       jp nz, .err
  52++1B0E 78               ld a, b
  53++1B0F FE 02            cp 2
  53++1B11 20 F0          jr nz, .resolveLoop
  54++1B13              .fin
  55++1B13 37               scf
  56++1B14 C9               ret
  57++1B15              .err
  58++1B15 B7               or a
  59++1B16 C9               ret
  60++1B17
  61++1B17              ; L.H.E.D - IP addr
  62++1B17              ; BC - port
  63++1B17              ; Output:
  64++1B17              ; NZ - error flag
  65++1B17              ; A - error code
  66++1B17              ; B - socket id
  67++1B17              openTcp:
  68++1B17 22 47 1B         ld (.ip), hl
  69++1B1A ED 53 49 1B      ld (.ip + 2), de
  70++1B1E ED 43 4B 1B      ld (.port), bc
  71++1B22 21 47 1B         ld hl, .buff
  72++1B25 3E 0D            ld a, OPEN_TCP
  73++1B27 CD B4 1A         call UnApi.tpaUnApiCall
  74++1B2A A7               and a
  74++1B2B C0             ret nz
  75++1B2C
  76++1B2C 78               ld a, b
  77++1B2D 32 52 1B         ld (.socket), a
  78++1B30              .establishWait
  79++1B30 CD 8E 1B         call TcpIP.wait
  80++1B33
  81++1B33 3A 52 1B         ld a, (.socket)
  82++1B36 47               ld b, a
  83++1B37 CD 53 1B         call TcpIP.stateTcp
  84++1B3A
  85++1B3A A7               and a
  86++1B3B C0               ret nz
  87++1B3C
  88++1B3C 78               ld a, b
  89++1B3D FE 04            cp 4
  90++1B3F 20 EF            jr nz, .establishWait
  91++1B41
  92++1B41 3A 52 1B         ld a, (.socket)
  93++1B44 47               ld b, a
  94++1B45 AF               xor a
  95++1B46 C9               ret
  96++1B47              .buff
  97++1B47 00 00 00 00  .ip        ds 4
  98++1B4B 00 00        .port      dw 0
  99++1B4D FF FF        .localPort dw #ffff
 100++1B4F 00 00        .timeout   dw 0
 101++1B51 00           .flags     db 0
 102++1B52 00           .socket    db 0
 103++1B53
 104++1B53              ; A - socket
 105++1B53              ; Output:
 106++1B53              ; B - connection state
 107++1B53              ; HL - bytes avail
 108++1B53              ; IX - free bytes in output buffer
 109++1B53              stateTcp:
 110++1B53 47               ld b, a
 111++1B54 21 00 00         ld hl, 0
 112++1B57 3E 10            ld a, STATE_TCP
 113++1B59 C3 B4 1A         jp UnApi.tpaUnApiCall
 114++1B5C
 115++1B5C
 116++1B5C              ; A - socket
 117++1B5C              ; DE - buffer
 118++1B5C              ; HL - data len
 119++1B5C              sendTCP:
 120++1B5C E5               push hl
 121++1B5D 44 4D            ld bc, hl
 122++1B5F EB               ex hl, de
 123++1B60 11 D3 1B         ld de, tcpBuff
 124++1B63 ED B0            ldir
 125++1B65 E1               pop hl
 126++1B66 47               ld b, a
 127++1B67 11 D3 1B         ld de, tcpBuff
 128++1B6A 0E 00            ld c, 0
 129++1B6C 3E 11            ld a, TcpIP.SEND_TCP
 130++1B6E C3 B4 1A         jp UnApi.tpaUnApiCall
 131++1B71
 132++1B71              ; A - socket
 133++1B71              ; HL - data len
 134++1B71              ; BC - actually received
 135++1B71              recvTCP:
 136++1B71 47               ld b, a
 137++1B72
 138++1B72              ; 512 Bytes buffer limit
 139++1B72 7C               ld a, h
 140++1B73 A7               and a
 141++1B74 28 02            jr z, .skip
 142++1B76 3E 01            ld a, 1
 143++1B78              .skip
 144++1B78 67               ld h, a
 145++1B79
 146++1B79 3E 12            ld a, RECV_TCP
 147++1B7B 11 D3 1B         ld de, tcpBuff
 148++1B7E C3 B4 1A         jp UnApi.tpaUnApiCall
 149++1B81
 150++1B81
 151++1B81              ; A - socket id
 152++1B81              closeTcp:
 153++1B81 47               ld b, a
 154++1B82 3E 0E            ld a, CLOSE_TCP
 155++1B84 C3 B4 1A         jp UnApi.tpaUnApiCall
 156++1B87
 157++1B87
 158++1B87              closeAll:
 159++1B87 3E 0E            ld a, CLOSE_TCP
 160++1B89 06 00            ld b, 0
 161++1B8B CD B4 1A         call UnApi.tpaUnApiCall
 162++1B8E              wait:
 163++1B8E 3E 1D            ld a, TCP_WAIT
 164++1B90 C3 B4 1A         jp UnApi.tpaUnApiCall
 165++1B93
 166++1B93 00 00 00...  dnsbuff ds 64
 167++1BD3 00 00 00...  tcpBuff ds 1024
 168++1FD3
 169++1FD3 54 43 50 2F  api  db "TCP/IP", 0
 169++1FD7 49 50 00
 170++1FDA                  endmodule
# file closed: ./drivers/unapi/tcp.asm
  51++1FDA              		include "rtc-msx.asm"
# file opened: drivers/rtc-msx.asm
   1++1FDA              ;clock driver MSX2
   2++1FDA              	module Clock
   3++1FDA                  define RTCreg 0xb4
   4++1FDA                  define RTCdat 0xb5
   5++1FDA                  define MODEreg 0x0d
   6++1FDA
   7++1FDA              readTime:
   8++1FDA              ;I/O Ports
   9++1FDA              ;Port 00B4h allows you to specify the RTC register (0-15) to access, and
  10++1FDA              ;port 00B5h allows you to read or write data in the specified register. Bits 4 to 7 of these ports are not used.
  11++1FDA              ;
  12++1FDA              ;Block 0
  13++1FDA              ;Register	Bit 3	Bit 2	Bit 1	Bit 0
  14++1FDA              ;0	        Units counter for seconds
  15++1FDA              ;1	        0	    Tens counter for seconds
  16++1FDA              ;2	        Units counter for minutes
  17++1FDA              ;3	        0	    Tens counter for minutes
  18++1FDA              ;4	        Units counter for hours
  19++1FDA              ;5	        0	    0	    Tens counter for hours
  20++1FDA              ;
  21++1FDA
  22++1FDA 01 B4 00     	ld bc, 0xb4
  23++1FDD 3E 0D        	ld a,0x0d
  24++1FDF ED 79            out (c),a           ; Selecting MODE register
  25++1FE1
  26++1FE1 01 B5 00     	ld bc, 0xb5
  27++1FE4 ED 78            in a, (c)           ; Reading MODE register
  28++1FE6 E6 0C            and 12
  29++1FE8 ED 79            out (c),a           ;Selecting BLOCK0
  30++1FEA
  31++1FEA              ; Seconds-----------------------------------------------------------------
  32++1FEA 01 B4 00     	ld bc, 0xb4
  33++1FED 3E 00            ld a,0
  34++1FEF ED 79            out (c),a           ;Selecting 0 register (Units counter for seconds)
  35++1FF1
  36++1FF1 01 B5 00         ld bc, 0xb5
  37++1FF4 ED 78            in  a, (c)          ; Reading 0 register
  38++1FF6 E6 0F            and 15
  39++1FF8 5F               ld e,a
  40++1FF9
  41++1FF9 01 B4 00     	ld bc, 0xb4
  42++1FFC 3E 01            ld a, 1
  43++1FFE ED 79            out (c),a           ;Selecting 1 register (Tens counter for seconds)
  44++2000
  45++2000 01 B5 00         ld bc, 0xb5
  46++2003 ED 78            in  a, (c)          ; Reading 1 register
  47++2005 E6 07            and 7
  48++2007 FE 00            cp 0
  49++2009 CA 14 20         jp z,zerosecs
  50++200C 57               ld d,a
  51++200D AF               xor a
  52++200E              secCounter:
  53++200E C6 0A            add 10
  54++2010 15               dec d
  55++2011 C2 0E 20         jp nz,secCounter
  56++2014              zerosecs:
  57++2014 83               add e
  58++2015 32 98 2E     	ld (seconds),a
  59++2018              ; Minites-----------------------------------------------------------------
  60++2018 01 B4 00     	ld bc, 0xb4
  61++201B 3E 02            ld a,2
  62++201D ED 79            out (c),a           ;Selecting 2 register
  63++201F
  64++201F 01 B5 00         ld bc, 0xb5
  65++2022 ED 78            in  a, (c)          ; Reading 2 register
  66++2024 E6 0F            and 15
  67++2026 5F               ld e,a
  68++2027
  69++2027 01 B4 00     	ld bc, 0xb4
  70++202A 3E 03            ld a, 3
  71++202C ED 79            out (c),a           ;Selecting 3 register
  72++202E
  73++202E 01 B5 00         ld bc, 0xb5
  74++2031 ED 78            in  a, (c)          ; Reading 3 register
  75++2033 E6 07            and 7
  76++2035 FE 00            cp 0
  77++2037 CA 42 20         jp z,zerominutes
  78++203A 57               ld d,a
  79++203B AF               xor a
  80++203C              minCounter:
  81++203C C6 0A            add 10
  82++203E 15               dec d
  83++203F C2 3C 20         jp nz,minCounter
  84++2042              zerominutes:
  85++2042 83               add e
  86++2043 32 97 2E         ld (minutes),a
  87++2046              ; Hours-----------------------------------------------------------------
  88++2046
  89++2046 01 B4 00     	ld bc, 0xb4
  90++2049 3E 04            ld a,4
  91++204B ED 79            out (c),a          ;Selecting 4 register
  92++204D
  93++204D 01 B5 00         ld bc, 0xb5
  94++2050 ED 78            in  a, (c)         ; Reading 4 register
  95++2052 E6 07            and 7
  96++2054 5F               ld e,a
  97++2055
  98++2055 01 B4 00     	ld bc, 0xb4
  99++2058 3E 05            ld a, 5
 100++205A ED 79            out (c),a          ;Selecting 5 register
 101++205C
 102++205C 01 B5 00         ld bc, 0xb5
 103++205F ED 78            in  a, (c)         ; Reading 5 register
 104++2061 E6 03            and 3
 105++2063 FE 00            cp 0
 106++2065 CA 70 20         jp z,zerohour
 107++2068 57               ld d,a
 108++2069 AF               xor a
 109++206A              hourCounter:
 110++206A C6 0A            add 10
 111++206C 15               dec d
 112++206D C2 6A 20         jp nz,hourCounter
 113++2070              zerohour:
 114++2070 83               add e
 115++2071 32 96 2E         ld (hours),a
 116++2074 C9             	ret
 117++2075                  endmodule
 118++2075
# file closed: drivers/rtc-msx.asm
  52++2075                  ELSE
  53++2075 ~            		include "proxy.asm"
  54++2075 ~            		include "memory.asm"
  55++2075              	ENDIF
  56++2075
  57++2075              	IFDEF GS
  58++2075 ~            		include "general-sound.asm"
  59++2075              	ENDIF
# file closed: drivers/index.asm
  15+ 2075                  include "gopher/msxgopher.asm"
# file opened: gopher/msxgopher.asm
   1++2075                  module Gopher
   2++2075              ; HL - gopher row
   3++2075              extractRequest:
   4++2075 21 E1 0A         ld hl, historyBlock.locator
   5++2078 11 43 22         ld de, requestbuffer
   6++207B              .loop
   7++207B 7E               ld a, (hl)
   8++207C 12               ld (de), a
   9++207D 23               inc hl
  10++207E 13               inc de
  11++207F FE 00            cp 0
  12++2081 28 02            jr z, .search
  13++2083 18 F6            jr .loop
  14++2085              .search
  15++2085 1B               dec de
  16++2086 3A E0 0A         ld a, (historyBlock.mediaType)
  17++2089 FE 06            cp MIME_INPUT
  18++208B 20 10            jr nz, .exit
  19++208D 21 26 0C         ld hl, historyBlock.search
  20++2090 3E 09            ld a, TAB
  21++2092 12               ld (de), a
  22++2093 13               inc de
  23++2094              .searchCopy
  24++2094 7E               ld a, (hl)
  25++2095 A7               and a
  25++2096 28 05          jr z, .exit
  26++2098 12               ld (de), a
  27++2099 23               inc hl
  27++209A 13             inc de
  28++209B 18 F7            jr .searchCopy
  29++209D              .exit
  30++209D 3E 0D            ld a, CR
  30++209F 12             ld (de), a
  30++20A0 13             inc de
  31++20A1 3E 0A            ld a, LF
  31++20A3 12             ld (de), a
  31++20A4 13             inc de
  32++20A5 AF               xor a
  33++20A6 12               ld (de), a
  34++20A7 C9               ret
  35++20A8
  36++20A8
  37++20A8              makeRequest:
  38++20A8 CD 87 1B         call TcpIP.closeAll
  39++20AB CD 75 20         call extractRequest
  40++20AE 11 20 0C         ld de, historyBlock.port
  41++20B1 CD A4 02         call atohl
  42++20B4 22 C1 20         ld (.port + 1), hl
  43++20B7
  44++20B7 21 E0 0B         ld hl, historyBlock.host
  45++20BA CD E9 1A         call TcpIP.resolveIp
  46++20BD D2 DD 20         jp nc, .error
  47++20C0              .port
  48++20C0 01 AF BE         ld bc, #beaf
  49++20C3 CD 17 1B         call TcpIP.openTcp
  50++20C6 C2 DD 20         jp nz, .error
  51++20C9
  52++20C9 78               ld a, b
  53++20CA 32 1A 22         ld (socket), a
  54++20CD
  55++20CD 11 43 22         ld de, requestbuffer
  56++20D0 D5               push de
  57++20D1 CD CB 02         call strlen
  58++20D4 D1               pop de
  59++20D5 3A 1A 22         ld a, (socket)
  60++20D8 CD 5C 1B         call TcpIP.sendTCP
  61++20DB B7               or a
  62++20DC C9               ret
  63++20DD              .error
  64++20DD 37               scf
  65++20DE C9               ret
  66++20DF
  67++20DF              loadBuffer:
  68++20DF 21 FA 2E         ld hl, outputBuffer
  69++20E2 22 26 21         ld (.pointer), hl
  70++20E5              .loop
  71++20E5 3A 1A 22         ld a, (socket)
  72++20E8 CD 53 1B         call TcpIP.stateTcp
  73++20EB A7               and a
  73++20EC C0             ret nz ; If there some error
  74++20ED 7C               ld a, h
  74++20EE B5             or l
  74++20EF 20 06          jr nz, .getPacket ; if there some data
  75++20F1 78               ld a, b
  75++20F2 FE 04          cp 4
  75++20F4 C0             ret nz ; If there no established status
  76++20F5 18 EE            jr .loop
  77++20F7              .getPacket
  78++20F7 21 00 04         ld hl, 1024
  79++20FA 3A 1A 22         ld a, (socket)
  80++20FD CD 71 1B         call TcpIP.recvTCP
  81++2100 C5               push bc
  82++2101 2A 26 21             ld hl, (.pointer)
  83++2104 09                   add hl, bc
  83++2105 7C             ld a, h
  83++2106 FE C0          cp #c0
  83++2108 D2 1F 21       jp nc, .skiploop
  84++210B ED 5B 26 21          ld de, (.pointer), hl, TcpIP.tcpBuff
  84++210F 21 D3 1B
  85++2112 ED B0                ldir
  86++2114 C1               pop bc
  87++2115 2A 26 21         ld hl, (.pointer)
  88++2118 09               add hl, bc
  89++2119 22 26 21         ld (.pointer), hl
  90++211C C3 E5 20         jp .loop
  91++211F              .skiploop
  92++211F C1               pop bc
  93++2120 CD 87 1B         call TcpIP.closeAll
  94++2123 C3 E5 20         jp .loop
  95++2126 FA 2E        .pointer dw outputBuffer
  96++2128
  97++2128              download:
  98++2128 11 E1 0A         ld de, historyBlock.locator
  99++212B 62 6B            ld hl, de
 100++212D              .findFileName
 101++212D 1A               ld a, (de)
 101++212E 13             inc de
 102++212F FE 2F            cp '/'
 102++2131 20 02          jr nz, .skip
 103++2133 62 6B            ld hl, de
 104++2135              .skip
 105++2135 A7               and a
 105++2136 20 F5          jr nz, .findFileName
 106++2138              .copy
 107++2138                  ;; HL - filename pointer
 108++2138 11 DD 08         ld de, DialogBox.inputBuffer
 109++213B              .copyFileName
 110++213B 7E               ld a, (hl)
 110++213C A7             and a
 110++213D 28 05          jr z, .finishCopy
 111++213F
 112++213F 12               ld (de), a
 112++2140 23 13          inc hl, de
 113++2142 18 F7            jr .copyFileName
 114++2144              .finishCopy
 115++2144 12               ld (de), a
 116++2145 CD 87 08         call DialogBox.inputBox.noclear
 117++2148 3A DD 08         ld a, (DialogBox.inputBuffer)
 117++214B A7             and a
 117++214C CA A9 09       jp z, History.back
 118++214F
 119++214F CD A8 20         call makeRequest
 119++2152 DA 87 19       jp c, Fetcher.fetchFromNet.error
 120++2155
 121++2155 3E 02 06 00      ld a, FMODE_NO_READ, b, ATTR_NOTHING, de, DialogBox.inputBuffer
 121++2159 11 DD 08
 122++215C CD 69 09         call Dos.fcreate
 123++215F A7               and a
 123++2160 20 48          jr nz, .error
 124++2162 78               ld a, b
 124++2163 32 19 22       ld (.fp), a
 125++2166 21 F4 21         ld hl, .progress
 125++2169 CD 36 09       call DialogBox.msgNoWait
 126++216C              .loop
 127++216C 3A 1A 22         ld a, (socket)
 128++216F CD 53 1B         call TcpIP.stateTcp
 129++2172 A7               and a
 129++2173 C2 9D 21       jp nz, .exit ; If there some error
 130++2176 7C               ld a, h
 130++2177 B5             or l
 130++2178 20 08          jr nz, .getPacket ; if there some data
 131++217A 78               ld a, b
 131++217B FE 04          cp 4
 131++217D C2 9D 21       jp nz, .exit ; If there no established status
 132++2180 18 EA            jr .loop
 133++2182              .getPacket
 134++2182 CD 1C 22         call pulsing
 135++2185 21 00 02         ld hl, 512
 136++2188 3A 1A 22         ld a, (socket)
 137++218B CD 71 1B         call TcpIP.recvTCP
 138++218E 60 69 3A 19      ld hl, bc, a, (.fp), b, a, de, TcpIP.tcpBuff
 138++2192 22 47 11 D3
 138++2196 1B
 139++2197 CD 7D 09         call Dos.fwrite
 140++219A C3 6C 21         jp .loop
 141++219D              .exit
 142++219D 3A 19 22 47      ld a, (.fp), b, a
 143++21A1 CD 6E 09         call Dos.fclose
 144++21A4 CD 87 1B         call TcpIP.closeAll
 145++21A7 C3 A9 09         jp History.back
 146++21AA              .error
 147++21AA 3A 19 22 47      ld a, (.fp), b, a
 148++21AE CD 6E 09         call Dos.fclose
 149++21B1 CD 87 1B         call TcpIP.closeAll
 150++21B4 21 BD 21         ld hl, .err
 151++21B7 CD 2D 09         call DialogBox.msgBox
 152++21BA C3 A9 09         jp History.back
 153++21BD 4F 70 65 72  .err db "Operation failed! Sorry! Check filename or disk space!",0
 153++21C1 61 74 69 6F
 153++21C5 6E 20 66 61
 153++21C9 69 6C 65 64
 153++21CD 21 20 53 6F
 153++21D1 72 72 79 21
 153++21D5 20 43 68 65
 153++21D9 63 6B 20 66
 153++21DD 69 6C 65 6E
 153++21E1 61 6D 65 20
 153++21E5 6F 72 20 64
 153++21E9 69 73 6B 20
 153++21ED 73 70 61 63
 153++21F1 65 21 00
 154++21F4 44 6F 77 6E  .progress db "Downloading in progress! Wait a bit!", 0
 154++21F8 6C 6F 61 64
 154++21FC 69 6E 67 20
 154++2200 69 6E 20 70
 154++2204 72 6F 67 72
 154++2208 65 73 73 21
 154++220C 20 57 61 69
 154++2210 74 20 61 20
 154++2214 62 69 74 21
 154++2218 00
 155++2219 00           .fp db 0
 156++221A
 157++221A 00           socket db 0
 158++221B 20           pulsator db " "
 159++221C              pulsing
 160++221C D5               push de
 161++221D 11 01 0B         ld de, #0B01
 161++2220 CD 70 02       call TextMode.gotoXY
 162++2223 3A 1B 22         ld a, (pulsator)
 163++2226 FE 2A            cp '*'
 164++2228 CA 37 22         jp z, printasterix
 165++222B 3E 2A            ld a, '*'
 166++222D 32 1B 22         ld (pulsator),a
 167++2230 3E 20            ld a,' '
 168++2232 CD EC 01         call TextMode.putC
 169++2235 D1               pop de
 170++2236 C9               ret
 171++2237              printasterix
 172++2237 3E 20            ld a, ' '
 173++2239 32 1B 22         ld (pulsator),a
 174++223C 3E 2A            ld a,'*'
 175++223E CD EC 01         call TextMode.putC
 176++2241 D1               pop de
 177++2242 C9               ret
 178++2243
 179++2243 00 00 00...  requestbuffer ds #1ff
 180++2442                  endmodule
 181++2442
# file closed: gopher/msxgopher.asm
  16+ 2442                  include "screen/msxscreen.asm"
# file opened: screen/msxscreen.asm
   1++2442                  module ScreenViewer
   2++2442              PGT EQU 0		; начало таблицы шаблонов screen2
   3++2442              CT EQU #2000
   4++2442              display:
   5++2442
   6++2442 3E 02        	ld a,2			; screen2
   7++2444 CD 51 25     	call CHGMOD
   8++2447                  ;ld hl,MSX1paletteData
   9++2447              	;call set_palette_registre
  10++2447
  11++2447 21 FA 2E     	ld hl,outputBuffer
  12++244A DD 21 FA 4E  	ld ix,outputBuffer + 0x2000
  13++244E
  14++244E 3E 03        	ld a,3			; 3 сегмента экрана
  15++2450              loop3:
  16++2450 08           	ex af,af'
  17++2451 E5           	push hl
  18++2452 0E 00        	ld c,0
  19++2454              loop256:
  20++2454 06 08        	ld b,8
  21++2456 E5           	push hl
  22++2457              loop8:
  23++2457 7E           	ld a,(hl)
  24++2458 DD 77 00     	ld (ix+0),a
  25++245B 11 00 01     	ld de,#0100
  26++245E 19           	add hl,de
  27++245F DD 23        	inc ix
  28++2461 10 F4        	djnz loop8
  29++2463 E1           	pop hl
  30++2464 23           	inc hl
  31++2465 0D           	dec c
  32++2466 20 EC        	jr nz,loop256
  33++2468 E1           	pop hl
  34++2469 11 00 08     	ld de,2048
  35++246C 19           	add hl,de
  36++246D 08           	ex af,af'
  37++246E 3D           	dec a
  38++246F 20 DF        	jr nz,loop3
  39++2471
  40++2471 21 FA 4E     	ld hl,outputBuffer + 0x2000
  41++2474 11 00 00     	ld de,PGT
  42++2477 01 00 18     	ld bc,6144
  43++247A CD 4C 25     	call LDIRVM
  44++247D
  45++247D              	;jr keywait
  46++247D
  47++247D 01 00 03     	ld bc,768
  48++2480 21 FA 46     	ld hl,outputBuffer+6144
  49++2483 11 FA 4E     	ld de,outputBuffer + 0x2000
  50++2486              colorloop2:
  51++2486 C5           	push bc
  52++2487 06 08        	ld b,8
  53++2489 7E           	ld a,(hl)
  54++248A CD B6 24     	call convertpalete
  55++248D              colorloop1:
  56++248D 12           	ld (de),a
  57++248E 13           	inc de
  58++248F 10 FC        	djnz colorloop1
  59++2491 23           	inc hl
  60++2492 C1           	pop bc
  61++2493 0B           	dec bc
  62++2494 78           	ld a,b
  63++2495 B1           	or c
  64++2496 20 EE        	jr nz,colorloop2
  65++2498
  66++2498 21 FA 4E     	ld hl,outputBuffer + 0x2000
  67++249B 11 00 20     	ld de,CT
  68++249E 01 00 18     	ld bc,6144
  69++24A1 CD 4C 25     	call LDIRVM
  70++24A4
  71++24A4              keywait:
  72++24A4 F7           	RST #30			; Читает один символ из буфера клавиатуры. Если буфер пуст,
  73++24A5 00           	db 0			; выводит курсор и ждет нажатия клавиши.
  74++24A6 9F 00         	dw #009F 		; CHGET A = код символа
  75++24A8
  76++24A8 AF           	xor a			; screen0
  77++24A9 CD 51 25     	call CHGMOD
  78++24AC CD 77 02         call TextMode.loadFont
  79++24AF CD 03 01         call TextMode.init
  80++24B2 C3 A9 09         jp History.back
  81++24B5 C9           	ret
  82++24B6              convertpalete:
  83++24B6 E5           	push hl
  84++24B7 D5           	push de
  85++24B8 C5           	push bc
  86++24B9 47           	ld b,a
  87++24BA E6 07        	and #07
  88++24BC 21 56 25     	ld hl,colors0
  89++24BF CB 70        	bit 6,b
  90++24C1 28 03        	jr z,col0
  91++24C3 21 5E 25     	ld hl,colors1
  92++24C6              col0:
  93++24C6 16 00        	ld d,0
  94++24C8 5F           	ld e,a
  95++24C9 19           	add hl,de
  96++24CA 7E           	ld a,(hl)
  97++24CB A7           	and a
  98++24CC 07           	rlca
  99++24CD 07           	rlca
 100++24CE 07           	rlca
 101++24CF 07           	rlca
 102++24D0 4F           	ld c,a
 103++24D1 78           	ld a,b
 104++24D2 0F           	rrca
 105++24D3 0F           	rrca
 106++24D4 0F           	rrca
 107++24D5 E6 07        	and #07
 108++24D7 21 56 25     	ld hl,colors0
 109++24DA CB 70        	bit 6,b
 110++24DC 28 03        	jr z,col00
 111++24DE 21 5E 25     	ld hl,colors1
 112++24E1              col00:
 113++24E1 16 00        	ld d,0
 114++24E3 5F           	ld e,a
 115++24E4 19           	add hl,de
 116++24E5 7E           	ld a,(hl)
 117++24E6 B1           	or c
 118++24E7 C1           	pop bc
 119++24E8 D1           	pop de
 120++24E9 E1           	pop hl
 121++24EA C9           	ret
 122++24EB
 123++24EB              calcxy:
 124++24EB 7B           	ld a,e
 125++24EC E6 18        	and #18
 126++24EE F6 40        	or #40
 127++24F0 67           	ld h,a
 128++24F1 7B           	ld a,e
 129++24F2 E6 07        	and #07
 130++24F4 0F           	rrca
 131++24F5 0F           	rrca
 132++24F6 0F           	rrca
 133++24F7 82           	add a,d
 134++24F8 6F           	ld l,a
 135++24F9 C9           	ret
 136++24FA              ;-----------------------------------------------------------------------------------
 137++24FA              ; Routine to set colors palette MSX1 like
 138++24FA
 139++24FA              VDP_DW	equ	#00007
 140++24FA              RG16SAV	equ	#FFEF
 141++24FA
 142++24FA              MSX1palette:
 143++24FA 3A 07 00     	ld	a,(VDP_DW)
 144++24FD 4F           	ld	c,a		; C= CPU port connected to the VDP writing port #1
 145++24FE
 146++24FE AF           	xor	a		; Set color 0 ...
 147++24FF F3           	di
 148++2500 ED 79        	out	(c),a
 149++2502 32 EF FF     	ld	(RG16SAV),a
 150++2505 3E 90        	ld	a,#80+16	; ...into register 16 (+80h)
 151++2507 ED 79        	out	(c),a
 152++2509 FB           	ei
 153++250A
 154++250A 0C           	inc	c		; C= CPU port connected to the VDP writing port #2
 155++250B 06 1F        	ld	b,31
 156++250D 21 27 25     	ld	hl,MSX1paletteData
 157++2510 ED B3        	otir
 158++2512 C9           	ret
 159++2513
 160++2513              set_palette_registre:
 161++2513 AF           	xor a
 162++2514 D3 99        	out (#99),a		; номер регистра цвета
 163++2516 3E 90        	ld a,#90		; reg 16(#10) +7бит=1(запись)
 164++2518 00           	nop
 165++2519 D3 99        	out (#99),a
 166++251B 3E 10        	ld a,16			; сколько регистров
 167++251D 0E 9A        	ld c,#9A		; Color Palette Register
 168++251F              set_palette_loop:
 169++251F ED A3        	outi			; SET RED BLUE
 170++2521 ED A3        	outi			; SET GREEN
 171++2523 3D           	dec a
 172++2524 20 F9        	jr nz, set_palette_loop
 173++2526 C9           	ret
 174++2527
 175++2527              MSX1paletteData:
 176++2527 00 00        	db	00h,0	; Color 0
 177++2529 00 00        	db	00h,0	; Color 1
 178++252B 11 05        	db	11h,5	; Color 2
 179++252D 33 06        	db	33h,6	; Color 3
 180++252F 26 02        	db	26h,2	; Color 4
 181++2531 37 03        	db	37h,3	; Color 5
 182++2533 52 02        	db	52h,2	; Color 6
 183++2535 27 06        	db	27h,6	; Color 7
 184++2537 62 02        	db	62h,2	; Color 8
 185++2539 63 03        	db	63h,3	; Color 9
 186++253B 52 05        	db	52h,5	; Color A
 187++253D 63 06        	db	63h,6	; Color B
 188++253F 11 04        	db	11h,4	; Color C
 189++2541 55 02        	db	55h,2	; Color D
 190++2543 55 05        	db	55h,5	; Color E
 191++2545 77 07        	db	77h,7	; Color F
 192++2547              ;----------------------------------------------------------------------------------
 193++2547
 194++2547              WRTVRM:
 195++2547 F7           	rst #30
 196++2548 00           	db 0
 197++2549 4D 00        	dw #004D
 198++254B C9           	ret
 199++254C              LDIRVM:				; копирует блок данных из RAM в VRAM
 200++254C F7           	RST #30
 201++254D 00           	db 0
 202++254E 5C 00        	dw #005C
 203++2550 C9           	ret
 204++2551              CHGMOD:
 205++2551 F7           	rst #30
 206++2552 00           	db 0
 207++2553 5F 00        	dw #005F
 208++2555 C9           	ret
 209++2556
 210++2556              colors0:
 211++2556 01 04 08 0D  	db #01,#04,#08,13,#02,7,10,14
 211++255A 02 07 0A 0E
 212++255E              colors1:
 213++255E 01 05 09 0D  	db #01,#05,#09,13,#03,7,11,15
 213++2562 03 07 0B 0F
 214++2566                  endmodule
# file closed: screen/msxscreen.asm
  17+ 2566                  include "player/vortex-processor.asm"
# file opened: player/vortex-processor.asm
   1++2566                  MODULE VortexProcessor
   2++2566              	IFDEF MSX
   3++2566              play:
   4++2566 CD 96 09         call Console.peekC
   4++2569 A7             and a
   5++256A 20 FA            jr nz, play
   6++256C
   7++256C 21 91 25         ld hl, message
   7++256F CD 36 09       call DialogBox.msgNoWait
   8++2572
   9++2572 21 FA 2E         ld hl, outputBuffer
   9++2575 CD D0 25       call VTPL.INIT
  10++2578              .loop
  11++2578 76               halt
  11++2579 F3             di
  11++257A CD 4B 2A       call VTPL.PLAY
  11++257D FB             ei
  12++257E CD 96 09         call Console.peekC
  12++2581 A7             and a
  12++2582 C2 87 25       jp nz, .stop
  13++2585 30 F1            jr nc, .loop
  14++2587              .stop
  15++2587 CD C4 25         call VTPL.MUTE
  16++258A              .wlp
  17++258A CD 96 09         call Console.peekC
  17++258D A7             and a
  18++258E 20 FA            jr nz, .wlp
  19++2590 C9               ret
  20++2591
  21++2591 50 72 65 73  message db "Press key to stop...", 0
  21++2595 73 20 6B 65
  21++2599 79 20 74 6F
  21++259D 20 73 74 6F
  21++25A1 70 2E 2E 2E
  21++25A5 00
  22++25A6                  ENDMODULE
  23++25A6                  include "msxplayer.asm"
# file opened: player/msxplayer.asm
   1++25A6              ;Vortex Tracker II v1.0 PT3 player for MSX
   2++25A6              ;Adapted by Alfonso D. C. aka Dioniso <dioniso072@yahoo.es>
   3++25A6              ;09-Jan-05
   4++25A6              ;From:
   5++25A6              ;Vortex Tracker II v1.0 PT3 player for ZX Spectrum
   6++25A6              ;(c)2004 S.V.Bulba <vorobey@mail.khstu.ru> http://bulba.at.kz
   7++25A6
   8++25A6              ;Release number
   9++25A6              Release: .equ '6'
  10++25A6
  11++25A6              ;Features
  12++25A6              ;--------
  13++25A6              ;-Can be compiled at any address (i.e. no need rounding .org
  14++25A6              ; address).
  15++25A6              ;-Variables (VARS) can be located at any address (not only after
  16++25A6              ;code block).
  17++25A6              ;-INIT subroutine detects module version and rightly generates
  18++25A6              ; both note and volume tables outside of code block (in VARS).
  19++25A6              ;-Two portamento (spc. command 3xxx) algorithms (depending of
  20++25A6              ; module version).
  21++25A6              ;-Any Tempo value are accepted (including Tempo=1 and Tempo=2).
  22++25A6              ;-Fully compatible with Ay_Emul PT3 player codes.
  23++25A6              ;-See also notes at the end of this source code.
  24++25A6
  25++25A6              ;Limitations
  26++25A6              ;-----------
  27++25A6              ;-Can run in RAM only (self-modified code is used).
  28++25A6
  29++25A6              ;Warning!!! PLAY subroutine can crash if no module are loaded
  30++25A6              ;into RAM or INIT subroutine was not called before.
  31++25A6
  32++25A6              ;Call MUTE or INIT one more time to mute sound after stopping
  33++25A6              ;playing
  34++25A6
  35++25A6              ;Entry and other points
  36++25A6              ;START initialization
  37++25A6              ;START+3 initialization with module address in HL
  38++25A6              ;START+5 play one quark
  39++25A6              ;START+8 mute
  40++25A6              ;START+10 setup and status flags
  41++25A6              ;START+11 pointer to current position value in PT3 module;
  42++25A6              ;After INIT (START+11) points to Postion0-1 (optimization)
  43++25A6              	module VTPL
  44++25A6              START:
  45++25A6 21 FA 2E     	LD HL,outputBuffer	;Address of PT3 module
  46++25A9 18 25        	JR INIT		;START+3
  47++25AB C3 4B 2A     	JP PLAY		;START+5
  48++25AE 18 14        	JR MUTE		;START+8
  49++25B0 00           SETUP:	.db 0 ;set bit0 to 1, if you want to play without looping
  50++25B1              	     ;bit7 is set each time, when loop point is passed
  51++25B1 00 00        CrPsPtr:	.dw 0
  52++25B3
  53++25B3 21 B0 25     CHECKLP:	LD HL,SETUP
  54++25B6 CB FE        	SET 7,(HL)
  55++25B8 CB 46        	BIT 0,(HL)
  56++25BA C8           	RET Z
  57++25BB E1           	POP HL
  58++25BC 21 36 2C     	LD HL,DelyCnt
  59++25BF 34           	INC (HL)
  60++25C0 21 FA 2B     	LD HL,ChanA+CHNPRM_NtSkCn
  61++25C3 34           	INC (HL)
  62++25C4 AF           MUTE:	XOR A
  63++25C5 67           	LD H,A
  64++25C6 6F           	LD L,A
  65++25C7 32 44 2C     	LD (AYREGS+AR_AmplA),A
  66++25CA 22 45 2C     	LD (AYREGS+AR_AmplB),HL
  67++25CD C3 3D 2B     	JP ROUT_A0
  68++25D0
  69++25D0              INIT:
  70++25D0              ;HL - AddressOfModule
  71++25D0
  72++25D0 22 3E 27     	LD (MODADDR),HL
  73++25D3 22 D0 28     	LD (MDADDR2),HL
  74++25D6 E5           	PUSH HL
  75++25D7 11 64 00     	LD DE,100
  76++25DA 19           	ADD HL,DE
  77++25DB 7E           	LD A,(HL)
  78++25DC 32 D7 2A     	LD (Delay),A
  79++25DF E5           	PUSH HL
  80++25E0 DD E1        	POP IX
  81++25E2 19           	ADD HL,DE
  82++25E3 22 B1 25     	LD (CrPsPtr),HL
  83++25E6 DD 5E 02     	LD E,(IX+102-100)
  84++25E9 19           	ADD HL,DE
  85++25EA 23           	INC HL
  86++25EB 22 79 2A     	LD (LPosPtr),HL
  87++25EE D1           	POP DE
  88++25EF DD 6E 03     	LD L,(IX+103-100)
  89++25F2 DD 66 04     	LD H,(IX+104-100)
  90++25F5 19           	ADD HL,DE
  91++25F6 22 86 2A     	LD (PatsPtr),HL
  92++25F9 21 A9 00     	LD HL,169
  93++25FC 19           	ADD HL,DE
  94++25FD 22 C9 28     	LD (OrnPtrs),HL
  95++2600 21 69 00     	LD HL,105
  96++2603 19           	ADD HL,DE
  97++2604 22 37 27     	LD (SamPtrs),HL
  98++2607 21 B0 25     	LD HL,SETUP
  99++260A CB BE        	RES 7,(HL)
 100++260C
 101++260C              ;note table data depacker
 102++260C 11 AA 2B     	LD DE,T_PACK
 103++260F 01 AD 2C     	LD BC,T1_+(2*49)-1
 104++2612 1A           TP_0:	LD A,(DE)
 105++2613 13           	INC DE
 106++2614 FE 1E        	CP 15*2
 107++2616 30 06        	JR NC,TP_1
 108++2618 67           	LD H,A
 109++2619 1A           	LD A,(DE)
 110++261A 6F           	LD L,A
 111++261B 13           	INC DE
 112++261C 18 07        	JR TP_2
 113++261E D5           TP_1:	PUSH DE
 114++261F 16 00        	LD D,0
 115++2621 5F           	LD E,A
 116++2622 19           	ADD HL,DE
 117++2623 19           	ADD HL,DE
 118++2624 D1           	POP DE
 119++2625 7C           TP_2:	LD A,H
 120++2626 02           	LD (BC),A
 121++2627 0B           	DEC BC
 122++2628 7D           	LD A,L
 123++2629 02           	LD (BC),A
 124++262A 0B           	DEC BC
 125++262B D6 F0        	SUB $F0
 126++262D 20 E3        	JR NZ,TP_0
 127++262F
 128++262F 21 DF 2B     	LD HL,VARS
 129++2632 77           	LD (HL),A
 130++2633 11 E0 2B     	LD DE,VARS+1
 131++2636 01 6C 00     	LD BC,VAR0END-VARS-1
 132++2639 ED B0        	LDIR
 133++263B 3C           	INC A
 134++263C 32 36 2C     	LD (DelyCnt),A
 135++263F 21 01 F0     	LD HL,$F001 ;H - CHNPRM_Volume, L - CHNPRM_NtSkCn
 136++2642 22 FA 2B     	LD (ChanA+CHNPRM_NtSkCn),HL
 137++2645 22 17 2C     	LD (ChanB+CHNPRM_NtSkCn),HL
 138++2648 22 34 2C     	LD (ChanC+CHNPRM_NtSkCn),HL
 139++264B
 140++264B 21 A6 2B     	LD HL,EMPTYSAMORN
 141++264E 22 63 2A     	LD (AdInPtA),HL ;ptr to zero
 142++2651 22 EC 2B     	LD (ChanA+CHNPRM_OrnPtr),HL ;ornament 0 is "0,1,0"
 143++2654 22 09 2C     	LD (ChanB+CHNPRM_OrnPtr),HL ;in all versions from
 144++2657 22 26 2C     	LD (ChanC+CHNPRM_OrnPtr),HL ;3.xx to 3.6x and VTII
 145++265A
 146++265A 22 EE 2B     	LD (ChanA+CHNPRM_SamPtr),HL ;S1 There is no default
 147++265D 22 0B 2C     	LD (ChanB+CHNPRM_SamPtr),HL ;S2 sample in PT3, so, you
 148++2660 22 28 2C     	LD (ChanC+CHNPRM_SamPtr),HL ;S3 can comment S1,2,3; see
 149++2663              				    ;also EMPTYSAMORN comment
 150++2663
 151++2663 DD 7E A9     	LD A,(IX+13-100) ;EXTRACT VERSION NUMBER
 152++2666 D6 30        	SUB $30
 153++2668 38 04        	JR C,L20
 154++266A FE 0A        	CP 10
 155++266C 38 02        	JR C,L21
 156++266E 3E 06        L20:	LD A,6
 157++2670 32 29 28     L21:	LD (Version),A
 158++2673 F5           	PUSH AF
 159++2674 FE 04        	CP 4
 160++2676 DD 7E FF     	LD A,(IX+99-100) ;TONE TABLE NUMBER
 161++2679 17           	RLA
 162++267A E6 07        	AND 7
 163++267C
 164++267C              ;NoteTableCreator (c) Ivan Roshin
 165++267C              ;A - NoteTableNumber*2+VersionForNoteTable
 166++267C              ;(xx1b - 3.xx..3.4r, xx0b - 3.4x..3.6x..VTII1.0)
 167++267C
 168++267C 21 56 2B     	LD HL,NT_DATA
 169++267F D5           	PUSH DE
 170++2680 50           	LD D,B
 171++2681 87           	ADD A,A
 172++2682 5F           	LD E,A
 173++2683 19           	ADD HL,DE
 174++2684 5E           	LD E,(HL)
 175++2685 23           	INC HL
 176++2686 CB 3B        	SRL E
 177++2688 9F           	SBC A,A
 178++2689 E6 A7        	AND $A7 ;$00 (NOP) or $A7 (AND A)
 179++268B 32 B2 26     	LD (L3),A
 180++268E EB           	EX DE,HL
 181++268F C1           	POP BC ;BC=T1_
 182++2690 09           	ADD HL,BC
 183++2691
 184++2691 1A           	LD A,(DE)
 185++2692
 186++2692 01 66 2B     	LD BC,T_
 187++2695 81           	ADD A,C
 188++2696 4F           	LD C,A
 189++2697 88           	ADC A,B
 190++2698
 191++2698 91           	SUB C
 192++2699 47           	LD B,A
 193++269A C5           	PUSH BC
 194++269B 11 3C 2D     	LD DE,NT_
 195++269E D5           	PUSH DE
 196++269F
 197++269F 06 0C        	LD B,12
 198++26A1 C5           L1:	PUSH BC
 199++26A2 4E           	LD C,(HL)
 200++26A3 23           	INC HL
 201++26A4 E5           	PUSH HL
 202++26A5 46           	LD B,(HL)
 203++26A6
 204++26A6 D5           	PUSH DE
 205++26A7 EB           	EX DE,HL
 206++26A8 11 17 00     	LD DE,23
 207++26AB DD 26 08     	.db $DD,$26,$08	;LD XH,8
 208++26AE
 209++26AE CB 38        L2:	SRL B
 210++26B0 CB 19        	RR C
 211++26B2 19           L3:	.db $19	;AND A or NOP
 212++26B3 79           	LD A,C
 213++26B4 8A           	ADC A,D	;=ADC 0
 214++26B5 77           	LD (HL),A
 215++26B6 23           	INC HL
 216++26B7 78           	LD A,B
 217++26B8 8A           	ADC A,D
 218++26B9 77           	LD (HL),A
 219++26BA 19           	ADD HL,DE
 220++26BB DD 25        	.db $DD,$25	;DEC XH
 221++26BD 20 EF        	JR NZ,L2
 222++26BF
 223++26BF D1           	POP DE
 224++26C0 13           	INC DE
 225++26C1 13           	INC DE
 226++26C2 E1           	POP HL
 227++26C3 23           	INC HL
 228++26C4 C1           	POP BC
 229++26C5 10 DA        	DJNZ L1
 230++26C7
 231++26C7 E1           	POP HL
 232++26C8 D1           	POP DE
 233++26C9
 234++26C9 7B           	LD A,E
 235++26CA D5           	PUSH DE
 236++26CB 11 72 2B     	LD DE,TCOLD_1
 237++26CE BB           	CP E
 238++26CF D1           	POP DE
 239++26D0 20 05        	JR NZ,CORR_1
 240++26D2 3E FD        	LD A,$FD
 241++26D4 32 6A 2D     	LD (NT_+$2E),A
 242++26D7
 243++26D7              CORR_1:
 244++26D7 1A           	LD A,(DE)
 245++26D8 A7           	AND A
 246++26D9 28 11        	JR Z,TC_EXIT
 247++26DB 1F           	RRA
 248++26DC F5           	PUSH AF
 249++26DD 87           	ADD A,A
 250++26DE 4F           	LD C,A
 251++26DF 09           	ADD HL,BC
 252++26E0 F1           	POP AF
 253++26E1 30 02        	JR NC,CORR_2
 254++26E3 35           	DEC (HL)
 255++26E4 35           	DEC (HL)
 256++26E5 34           CORR_2:	INC (HL)
 257++26E6 A7           	AND A
 258++26E7 ED 42        	SBC HL,BC
 259++26E9 13           	INC DE
 260++26EA 18 EB        	JR CORR_1
 261++26EC
 262++26EC              TC_EXIT:
 263++26EC
 264++26EC F1           	POP AF
 265++26ED
 266++26ED              ;VolTableCreator (c) Ivan Roshin
 267++26ED              ;A - VersionForVolumeTable (0..4 - 3.xx..3.4x;
 268++26ED              			   ;5.. - 3.5x..3.6x..VTII1.0)
 269++26ED
 270++26ED FE 05        	CP 5
 271++26EF 21 11 00     	LD HL,$11
 272++26F2 54           	LD D,H
 273++26F3 5C           	LD E,H
 274++26F4 3E 17        	LD A,$17
 275++26F6 30 03        	JR NC,M1
 276++26F8 2D           	DEC L
 277++26F9 5D           	LD E,L
 278++26FA AF           	XOR A
 279++26FB 32 0A 27     M1:      LD (M2),A
 280++26FE
 281++26FE DD 21 4C 2C  	LD IX,VT_+16
 282++2702 0E 10        	LD C,$10
 283++2704
 284++2704 E5           INITV2:  PUSH HL
 285++2705
 286++2705 19           	ADD HL,DE
 287++2706 EB           	EX DE,HL
 288++2707 ED 62        	SBC HL,HL
 289++2709
 290++2709 7D           INITV1:  LD A,L
 291++270A 7D           M2:      .db $7D
 292++270B 7C           	LD A,H
 293++270C CE 00        	ADC A,0
 294++270E DD 77 00     	LD (IX),A
 295++2711 DD 23        	INC IX
 296++2713 19           	ADD HL,DE
 297++2714 0C           	INC C
 298++2715 79           	LD A,C
 299++2716 E6 0F        	AND 15
 300++2718 20 EF        	JR NZ,INITV1
 301++271A
 302++271A E1           	POP HL
 303++271B 7B           	LD A,E
 304++271C FE 77        	CP $77
 305++271E 20 01        	JR NZ,M3
 306++2720 1C           	INC E
 307++2721 79           M3:      LD A,C
 308++2722 A7           	AND A
 309++2723 20 DF        	JR NZ,INITV2
 310++2725
 311++2725 C3 3D 2B     	JP ROUT_A0
 312++2728
 313++2728              ;pattern decoder
 314++2728 DD 36 08 00  PD_OrSm:	LD (IX-12+CHNPRM_Env_En),0
 315++272C CD C1 28     	CALL SETORN
 316++272F 0A           	LD A,(BC)
 317++2730 03           	INC BC
 318++2731 0F           	RRCA
 319++2732
 320++2732 87           PD_SAM:	ADD A,A
 321++2733 5F           PD_SAM_:	LD E,A
 322++2734 16 00        	LD D,0
 323++2736              SamPtrs: .equ $+1
 324++2736 21 21 21     	LD HL,$2121
 325++2739 19           	ADD HL,DE
 326++273A 5E           	LD E,(HL)
 327++273B 23           	INC HL
 328++273C 56           	LD D,(HL)
 329++273D              MODADDR: .equ $+1
 330++273D 21 21 21     	LD HL,$2121
 331++2740 19           	ADD HL,DE
 332++2741 DD 75 03     	LD (IX-12+CHNPRM_SamPtr),L
 333++2744 DD 74 04     	LD (IX-12+CHNPRM_SamPtr+1),H
 334++2747 18 41        	JR PD_LOOP
 335++2749
 336++2749 07           PD_VOL:	RLCA
 337++274A 07           	RLCA
 338++274B 07           	RLCA
 339++274C 07           	RLCA
 340++274D DD 77 10     	LD (IX-12+CHNPRM_Volume),A
 341++2750 18 3B        	JR PD_LP2
 342++2752
 343++2752 DD 77 08     PD_EOff:	LD (IX-12+CHNPRM_Env_En),A
 344++2755 DD 77 F4     	LD (IX-12+CHNPRM_PsInOr),A
 345++2758 18 33        	JR PD_LP2
 346++275A
 347++275A 3D           PD_SorE:	DEC A
 348++275B 20 07        	JR NZ,PD_ENV
 349++275D 0A           	LD A,(BC)
 350++275E 03           	INC BC
 351++275F DD 77 05     	LD (IX-12+CHNPRM_NNtSkp),A
 352++2762 18 29        	JR PD_LP2
 353++2764
 354++2764 CD A5 28     PD_ENV:	CALL SETENV
 355++2767 18 24        	JR PD_LP2
 356++2769
 357++2769 CD C1 28     PD_ORN:	CALL SETORN
 358++276C 18 1C        	JR PD_LOOP
 359++276E
 360++276E DD 77 08     PD_ESAM:	LD (IX-12+CHNPRM_Env_En),A
 361++2771 DD 77 F4     	LD (IX-12+CHNPRM_PsInOr),A
 362++2774 C4 A5 28     	CALL NZ,SETENV
 363++2777 0A           	LD A,(BC)
 364++2778 03           	INC BC
 365++2779 18 B8        	JR PD_SAM_
 366++277B
 367++277B DD 7E 06     PTDECOD: LD A,(IX-12+CHNPRM_Note)
 368++277E 32 0D 28     	LD (PrNote+1),A
 369++2781 DD 6E FA     	LD L,(IX-12+CHNPRM_CrTnSl)
 370++2784 DD 66 FB     	LD H,(IX-12+CHNPRM_CrTnSl+1)
 371++2787 22 2F 28     	LD (PrSlide+1),HL
 372++278A
 373++278A 11 10 20     PD_LOOP:	LD DE,$2010
 374++278D 0A           PD_LP2:	LD A,(BC)
 375++278E 03           	INC BC
 376++278F 83           	ADD A,E
 377++2790 38 96        	JR C,PD_OrSm
 378++2792 82           	ADD A,D
 379++2793 28 4F        	JR Z,PD_FIN
 380++2795 38 9B        	JR C,PD_SAM
 381++2797 83           	ADD A,E
 382++2798 28 2B        	JR Z,PD_REL
 383++279A 38 AD        	JR C,PD_VOL
 384++279C 83           	ADD A,E
 385++279D 28 B3        	JR Z,PD_EOff
 386++279F 38 B9        	JR C,PD_SorE
 387++27A1 C6 60        	ADD A,96
 388++27A3 38 26        	JR C,PD_NOTE
 389++27A5 83           	ADD A,E
 390++27A6 38 C1        	JR C,PD_ORN
 391++27A8 82           	ADD A,D
 392++27A9 38 15        	JR C,PD_NOIS
 393++27AB 83           	ADD A,E
 394++27AC 38 C0        	JR C,PD_ESAM
 395++27AE 87           	ADD A,A
 396++27AF 5F           	LD E,A
 397++27B0
 398++27B0 D5           	PUSH DE
 399++27B1 11 20 DF     	LD DE,$DF20
 400++27B4 21 DA 28     	LD HL,SPCCOMS
 401++27B7 19           	ADD HL,DE
 402++27B8 D1           	POP DE
 403++27B9
 404++27B9 19           	ADD HL,DE
 405++27BA 5E           	LD E,(HL)
 406++27BB 23           	INC HL
 407++27BC 56           	LD D,(HL)
 408++27BD D5           	PUSH DE
 409++27BE 18 CA        	JR PD_LOOP
 410++27C0
 411++27C0 32 3A 2C     PD_NOIS:	LD (Ns_Base),A
 412++27C3 18 C8        	JR PD_LP2
 413++27C5
 414++27C5 DD CB 09 86  PD_REL:	RES 0,(IX-12+CHNPRM_Flags)
 415++27C9 18 08        	JR PD_RES
 416++27CB
 417++27CB DD 77 06     PD_NOTE:	LD (IX-12+CHNPRM_Note),A
 418++27CE DD CB 09 C6  	SET 0,(IX-12+CHNPRM_Flags)
 419++27D2 AF           	XOR A
 420++27D3
 421++27D3 ED 73 E2 27  PD_RES:	LD (PDSP_+1),SP
 422++27D7 DD F9        	LD SP,IX
 423++27D9 67           	LD H,A
 424++27DA 6F           	LD L,A
 425++27DB E5           	PUSH HL
 426++27DC E5           	PUSH HL
 427++27DD E5           	PUSH HL
 428++27DE E5           	PUSH HL
 429++27DF E5           	PUSH HL
 430++27E0 E5           	PUSH HL
 431++27E1 31 31 31     PDSP_:	LD SP,$3131
 432++27E4
 433++27E4 DD 7E 05     PD_FIN:	LD A,(IX-12+CHNPRM_NNtSkp)
 434++27E7 DD 77 0F     	LD (IX-12+CHNPRM_NtSkCn),A
 435++27EA C9           	RET
 436++27EB
 437++27EB DD CB 09 96  C_PORTM: RES 2,(IX-12+CHNPRM_Flags)
 438++27EF 0A           	LD A,(BC)
 439++27F0 03           	INC BC
 440++27F1              ;SKIP PRECALCULATED TONE DELTA (BECAUSE
 441++27F1              ;CANNOT BE RIGHT AFTER PT3 COMPILATION)
 442++27F1 03           	INC BC
 443++27F2 03           	INC BC
 444++27F3 DD 77 0A     	LD (IX-12+CHNPRM_TnSlDl),A
 445++27F6 DD 77 F9     	LD (IX-12+CHNPRM_TSlCnt),A
 446++27F9 11 3C 2D     	LD DE,NT_
 447++27FC DD 7E 06     	LD A,(IX-12+CHNPRM_Note)
 448++27FF DD 77 07     	LD (IX-12+CHNPRM_SlToNt),A
 449++2802 87           	ADD A,A
 450++2803 6F           	LD L,A
 451++2804 26 00        	LD H,0
 452++2806 19           	ADD HL,DE
 453++2807 7E           	LD A,(HL)
 454++2808 23           	INC HL
 455++2809 66           	LD H,(HL)
 456++280A 6F           	LD L,A
 457++280B E5           	PUSH HL
 458++280C 3E 3E        PrNote:	LD A,$3E
 459++280E DD 77 06     	LD (IX-12+CHNPRM_Note),A
 460++2811 87           	ADD A,A
 461++2812 6F           	LD L,A
 462++2813 26 00        	LD H,0
 463++2815 19           	ADD HL,DE
 464++2816 5E           	LD E,(HL)
 465++2817 23           	INC HL
 466++2818 56           	LD D,(HL)
 467++2819 E1           	POP HL
 468++281A ED 52        	SBC HL,DE
 469++281C DD 75 0D     	LD (IX-12+CHNPRM_TnDelt),L
 470++281F DD 74 0E     	LD (IX-12+CHNPRM_TnDelt+1),H
 471++2822 DD 5E FA     	LD E,(IX-12+CHNPRM_CrTnSl)
 472++2825 DD 56 FB     	LD D,(IX-12+CHNPRM_CrTnSl+1)
 473++2828              Version: .equ $+1
 474++2828 3E 3E        	LD A,$3E
 475++282A FE 06        	CP 6
 476++282C 38 09        	JR C,OLDPRTM ;Old 3xxx for PT v3.5-
 477++282E 11 11 11     PrSlide:	LD DE,$1111
 478++2831 DD 73 FA     	LD (IX-12+CHNPRM_CrTnSl),E
 479++2834 DD 72 FB     	LD (IX-12+CHNPRM_CrTnSl+1),D
 480++2837 0A           OLDPRTM:	LD A,(BC) ;SIGNED TONE STEP
 481++2838 03           	INC BC
 482++2839 08           	EX AF,AF'
 483++283A 0A           	LD A,(BC)
 484++283B 03           	INC BC
 485++283C A7           	AND A
 486++283D 28 01        	JR Z,NOSIG
 487++283F EB           	EX DE,HL
 488++2840 ED 52        NOSIG:	SBC HL,DE
 489++2842 F2 4A 28     	JP P,SET_STP
 490++2845 2F           	CPL
 491++2846 08           	EX AF,AF'
 492++2847 ED 44        	NEG
 493++2849 08           	EX AF,AF'
 494++284A DD 77 0C     SET_STP:	LD (IX-12+CHNPRM_TSlStp+1),A
 495++284D 08           	EX AF,AF'
 496++284E DD 77 0B     	LD (IX-12+CHNPRM_TSlStp),A
 497++2851 DD 36 FE 00  	LD (IX-12+CHNPRM_COnOff),0
 498++2855 C9           	RET
 499++2856
 500++2856 DD CB 09 D6  C_GLISS:	SET 2,(IX-12+CHNPRM_Flags)
 501++285A 0A           	LD A,(BC)
 502++285B 03           	INC BC
 503++285C DD 77 0A     	LD (IX-12+CHNPRM_TnSlDl),A
 504++285F DD 77 F9     	LD (IX-12+CHNPRM_TSlCnt),A
 505++2862 0A           	LD A,(BC)
 506++2863 03           	INC BC
 507++2864 08           	EX AF,AF'
 508++2865 0A           	LD A,(BC)
 509++2866 03           	INC BC
 510++2867 18 E1        	JR SET_STP
 511++2869
 512++2869 0A           C_SMPOS:	LD A,(BC)
 513++286A 03           	INC BC
 514++286B DD 77 F5     	LD (IX-12+CHNPRM_PsInSm),A
 515++286E C9           	RET
 516++286F
 517++286F 0A           C_ORPOS:	LD A,(BC)
 518++2870 03           	INC BC
 519++2871 DD 77 F4     	LD (IX-12+CHNPRM_PsInOr),A
 520++2874 C9           	RET
 521++2875
 522++2875 0A           C_VIBRT:	LD A,(BC)
 523++2876 03           	INC BC
 524++2877 DD 77 FF     	LD (IX-12+CHNPRM_OnOffD),A
 525++287A DD 77 FE     	LD (IX-12+CHNPRM_COnOff),A
 526++287D 0A           	LD A,(BC)
 527++287E 03           	INC BC
 528++287F DD 77 00     	LD (IX-12+CHNPRM_OffOnD),A
 529++2882 AF           	XOR A
 530++2883 DD 77 F9     	LD (IX-12+CHNPRM_TSlCnt),A
 531++2886 DD 77 FA     	LD (IX-12+CHNPRM_CrTnSl),A
 532++2889 DD 77 FB     	LD (IX-12+CHNPRM_CrTnSl+1),A
 533++288C C9           	RET
 534++288D
 535++288D 0A           C_ENGLS:	LD A,(BC)
 536++288E 03           	INC BC
 537++288F 32 33 2B     	LD (Env_Del),A
 538++2892 32 39 2C     	LD (CurEDel),A
 539++2895 0A           	LD A,(BC)
 540++2896 03           	INC BC
 541++2897 6F           	LD L,A
 542++2898 0A           	LD A,(BC)
 543++2899 03           	INC BC
 544++289A 67           	LD H,A
 545++289B 22 36 2B     	LD (ESldAdd),HL
 546++289E C9           	RET
 547++289F
 548++289F 0A           C_DELAY:	LD A,(BC)
 549++28A0 03           	INC BC
 550++28A1 32 D7 2A     	LD (Delay),A
 551++28A4 C9           	RET
 552++28A5
 553++28A5 DD 73 08     SETENV:	LD (IX-12+CHNPRM_Env_En),E
 554++28A8 32 49 2C     	LD (AYREGS+AR_EnvTp),A
 555++28AB 0A           	LD A,(BC)
 556++28AC 03           	INC BC
 557++28AD 67           	LD H,A
 558++28AE 0A           	LD A,(BC)
 559++28AF 03           	INC BC
 560++28B0 6F           	LD L,A
 561++28B1 22 4A 2C     	LD (EnvBase),HL
 562++28B4 AF           	XOR A
 563++28B5 DD 77 F4     	LD (IX-12+CHNPRM_PsInOr),A
 564++28B8 32 39 2C     	LD (CurEDel),A
 565++28BB 67           	LD H,A
 566++28BC 6F           	LD L,A
 567++28BD 22 37 2C     	LD (CurESld),HL
 568++28C0 C9           C_NOP:	RET
 569++28C1
 570++28C1 87           SETORN:	ADD A,A
 571++28C2 5F           	LD E,A
 572++28C3 16 00        	LD D,0
 573++28C5 DD 72 F4     	LD (IX-12+CHNPRM_PsInOr),D
 574++28C8              OrnPtrs:	.equ $+1
 575++28C8 21 21 21     	LD HL,$2121
 576++28CB 19           	ADD HL,DE
 577++28CC 5E           	LD E,(HL)
 578++28CD 23           	INC HL
 579++28CE 56           	LD D,(HL)
 580++28CF              MDADDR2:	.equ $+1
 581++28CF 21 21 21     	LD HL,$2121
 582++28D2 19           	ADD HL,DE
 583++28D3 DD 75 01     	LD (IX-12+CHNPRM_OrnPtr),L
 584++28D6 DD 74 02     	LD (IX-12+CHNPRM_OrnPtr+1),H
 585++28D9 C9           	RET
 586++28DA
 587++28DA              ;ALL 16 ADDRESSES TO PROTECT FROM BROKEN PT3 MODULES
 588++28DA C0 28        SPCCOMS: .dw C_NOP
 589++28DC 56 28        	.dw C_GLISS
 590++28DE EB 27        	.dw C_PORTM
 591++28E0 69 28        	.dw C_SMPOS
 592++28E2 6F 28        	.dw C_ORPOS
 593++28E4 75 28        	.dw C_VIBRT
 594++28E6 C0 28        	.dw C_NOP
 595++28E8 C0 28        	.dw C_NOP
 596++28EA 8D 28        	.dw C_ENGLS
 597++28EC 9F 28        	.dw C_DELAY
 598++28EE C0 28        	.dw C_NOP
 599++28F0 C0 28        	.dw C_NOP
 600++28F2 C0 28        	.dw C_NOP
 601++28F4 C0 28        	.dw C_NOP
 602++28F6 C0 28        	.dw C_NOP
 603++28F8 C0 28        	.dw C_NOP
 604++28FA
 605++28FA AF           CHREGS:	XOR A
 606++28FB 32 46 2C     	LD (Ampl),A
 607++28FE DD CB 15 46  	BIT 0,(IX+CHNPRM_Flags)
 608++2902 E5           	PUSH HL
 609++2903 CA 28 2A     	JP Z,CH_EXIT
 610++2906 ED 73 73 29  	LD (CSP_+1),SP
 611++290A DD 6E 0D     	LD L,(IX+CHNPRM_OrnPtr)
 612++290D DD 66 0E     	LD H,(IX+CHNPRM_OrnPtr+1)
 613++2910 F9           	LD SP,HL
 614++2911 D1           	POP DE
 615++2912 67           	LD H,A
 616++2913 DD 7E 00     	LD A,(IX+CHNPRM_PsInOr)
 617++2916 6F           	LD L,A
 618++2917 39           	ADD HL,SP
 619++2918 3C           	INC A
 620++2919 BA           	CP D
 621++291A 38 01        	JR C,CH_ORPS
 622++291C 7B           	LD A,E
 623++291D DD 77 00     CH_ORPS:	LD (IX+CHNPRM_PsInOr),A
 624++2920 DD 7E 12     	LD A,(IX+CHNPRM_Note)
 625++2923 86           	ADD A,(HL)
 626++2924 F2 28 29     	JP P,CH_NTP
 627++2927 AF           	XOR A
 628++2928 FE 60        CH_NTP:	CP 96
 629++292A 38 02        	JR C,CH_NOK
 630++292C 3E 5F        	LD A,95
 631++292E 87           CH_NOK:	ADD A,A
 632++292F 08           	EX AF,AF'
 633++2930 DD 6E 0F     	LD L,(IX+CHNPRM_SamPtr)
 634++2933 DD 66 10     	LD H,(IX+CHNPRM_SamPtr+1)
 635++2936 F9           	LD SP,HL
 636++2937 D1           	POP DE
 637++2938 26 00        	LD H,0
 638++293A DD 7E 01     	LD A,(IX+CHNPRM_PsInSm)
 639++293D 47           	LD B,A
 640++293E 87           	ADD A,A
 641++293F 87           	ADD A,A
 642++2940 6F           	LD L,A
 643++2941 39           	ADD HL,SP
 644++2942 F9           	LD SP,HL
 645++2943 78           	LD A,B
 646++2944 3C           	INC A
 647++2945 BA           	CP D
 648++2946 38 01        	JR C,CH_SMPS
 649++2948 7B           	LD A,E
 650++2949 DD 77 01     CH_SMPS:	LD (IX+CHNPRM_PsInSm),A
 651++294C C1           	POP BC
 652++294D E1           	POP HL
 653++294E DD 5E 08     	LD E,(IX+CHNPRM_TnAcc)
 654++2951 DD 56 09     	LD D,(IX+CHNPRM_TnAcc+1)
 655++2954 19           	ADD HL,DE
 656++2955 CB 70        	BIT 6,B
 657++2957 28 06        	JR Z,CH_NOAC
 658++2959 DD 75 08     	LD (IX+CHNPRM_TnAcc),L
 659++295C DD 74 09     	LD (IX+CHNPRM_TnAcc+1),H
 660++295F EB           CH_NOAC: EX DE,HL
 661++2960 08           	EX AF,AF'
 662++2961 6F           	LD L,A
 663++2962 26 00        	LD H,0
 664++2964 31 3C 2D     	LD SP,NT_
 665++2967 39           	ADD HL,SP
 666++2968 F9           	LD SP,HL
 667++2969 E1           	POP HL
 668++296A 19           	ADD HL,DE
 669++296B DD 5E 06     	LD E,(IX+CHNPRM_CrTnSl)
 670++296E DD 56 07     	LD D,(IX+CHNPRM_CrTnSl+1)
 671++2971 19           	ADD HL,DE
 672++2972 31 31 31     CSP_:	LD SP,$3131
 673++2975 E3           	EX (SP),HL
 674++2976 AF           	XOR A
 675++2977 DD B6 05     	OR (IX+CHNPRM_TSlCnt)
 676++297A 28 3E        	JR Z,CH_AMP
 677++297C DD 35 05     	DEC (IX+CHNPRM_TSlCnt)
 678++297F 20 39        	JR NZ,CH_AMP
 679++2981 DD 7E 16     	LD A,(IX+CHNPRM_TnSlDl)
 680++2984 DD 77 05     	LD (IX+CHNPRM_TSlCnt),A
 681++2987 DD 6E 17     	LD L,(IX+CHNPRM_TSlStp)
 682++298A DD 66 18     	LD H,(IX+CHNPRM_TSlStp+1)
 683++298D 7C           	LD A,H
 684++298E 19           	ADD HL,DE
 685++298F DD 75 06     	LD (IX+CHNPRM_CrTnSl),L
 686++2992 DD 74 07     	LD (IX+CHNPRM_CrTnSl+1),H
 687++2995 DD CB 15 56  	BIT 2,(IX+CHNPRM_Flags)
 688++2999 20 1F        	JR NZ,CH_AMP
 689++299B DD 5E 19     	LD E,(IX+CHNPRM_TnDelt)
 690++299E DD 56 1A     	LD D,(IX+CHNPRM_TnDelt+1)
 691++29A1 A7           	AND A
 692++29A2 28 01        	JR Z,CH_STPP
 693++29A4 EB           	EX DE,HL
 694++29A5 ED 52        CH_STPP: SBC HL,DE
 695++29A7 FA BA 29     	JP M,CH_AMP
 696++29AA DD 7E 13     	LD A,(IX+CHNPRM_SlToNt)
 697++29AD DD 77 12     	LD (IX+CHNPRM_Note),A
 698++29B0 AF           	XOR A
 699++29B1 DD 77 05     	LD (IX+CHNPRM_TSlCnt),A
 700++29B4 DD 77 06     	LD (IX+CHNPRM_CrTnSl),A
 701++29B7 DD 77 07     	LD (IX+CHNPRM_CrTnSl+1),A
 702++29BA DD 7E 02     CH_AMP:	LD A,(IX+CHNPRM_CrAmSl)
 703++29BD CB 79        	BIT 7,C
 704++29BF 28 13        	JR Z,CH_NOAM
 705++29C1 CB 71        	BIT 6,C
 706++29C3 28 07        	JR Z,CH_AMIN
 707++29C5 FE 0F        	CP 15
 708++29C7 28 0B        	JR Z,CH_NOAM
 709++29C9 3C           	INC A
 710++29CA 18 05        	JR CH_SVAM
 711++29CC FE F1        CH_AMIN:	CP -15
 712++29CE 28 04        	JR Z,CH_NOAM
 713++29D0 3D           	DEC A
 714++29D1 DD 77 02     CH_SVAM:	LD (IX+CHNPRM_CrAmSl),A
 715++29D4 6F           CH_NOAM:	LD L,A
 716++29D5 78           	LD A,B
 717++29D6 E6 0F        	AND 15
 718++29D8 85           	ADD A,L
 719++29D9 F2 DD 29     	JP P,CH_APOS
 720++29DC AF           	XOR A
 721++29DD FE 10        CH_APOS:	CP 16
 722++29DF 38 02        	JR C,CH_VOL
 723++29E1 3E 0F        	LD A,15
 724++29E3 DD B6 1C     CH_VOL:	OR (IX+CHNPRM_Volume)
 725++29E6 6F           	LD L,A
 726++29E7 26 00        	LD H,0
 727++29E9 11 3C 2C     	LD DE,VT_
 728++29EC 19           	ADD HL,DE
 729++29ED 7E           	LD A,(HL)
 730++29EE CB 41        CH_ENV:	BIT 0,C
 731++29F0 20 03        	JR NZ,CH_NOEN
 732++29F2 DD B6 14     	OR (IX+CHNPRM_Env_En)
 733++29F5 32 46 2C     CH_NOEN:	LD (Ampl),A
 734++29F8 CB 78        	BIT 7,B
 735++29FA 79           	LD A,C
 736++29FB 28 19        	JR Z,NO_ENSL
 737++29FD 17           	RLA
 738++29FE 17           	RLA
 739++29FF CB 2F        	SRA A
 740++2A01 CB 2F        	SRA A
 741++2A03 CB 2F        	SRA A
 742++2A05 DD 86 04     	ADD A,(IX+CHNPRM_CrEnSl) ;SEE COMMENT BELOW
 743++2A08 CB 68        	BIT 5,B
 744++2A0A 28 03        	JR Z,NO_ENAC
 745++2A0C DD 77 04     	LD (IX+CHNPRM_CrEnSl),A
 746++2A0F 21 17 2B     NO_ENAC:	LD HL,AddToEn
 747++2A12 86           	ADD A,(HL) ;BUG IN PT3 - NEED WORD HERE.
 748++2A13              		   ;FIX IT IN NEXT VERSION?
 749++2A13 77           	LD (HL),A
 750++2A14 18 0E        	JR CH_MIX
 751++2A16 1F           NO_ENSL: RRA
 752++2A17 DD 86 03     	ADD A,(IX+CHNPRM_CrNsSl)
 753++2A1A 32 3B 2C     	LD (AddToNs),A
 754++2A1D CB 68        	BIT 5,B
 755++2A1F 28 03        	JR Z,CH_MIX
 756++2A21 DD 77 03     	LD (IX+CHNPRM_CrNsSl),A
 757++2A24 78           CH_MIX:	LD A,B
 758++2A25 1F           	RRA
 759++2A26 E6 48        	AND $48
 760++2A28 21 43 2C     CH_EXIT:	LD HL,AYREGS+AR_Mixer
 761++2A2B B6           	OR (HL)
 762++2A2C 0F           	RRCA
 763++2A2D 77           	LD (HL),A
 764++2A2E E1           	POP HL
 765++2A2F AF           	XOR A
 766++2A30 DD B6 0A     	OR (IX+CHNPRM_COnOff)
 767++2A33 C8           	RET Z
 768++2A34 DD 35 0A     	DEC (IX+CHNPRM_COnOff)
 769++2A37 C0           	RET NZ
 770++2A38 DD AE 15     	XOR (IX+CHNPRM_Flags)
 771++2A3B DD 77 15     	LD (IX+CHNPRM_Flags),A
 772++2A3E 1F           	RRA
 773++2A3F DD 7E 0B     	LD A,(IX+CHNPRM_OnOffD)
 774++2A42 38 03        	JR C,CH_ONDL
 775++2A44 DD 7E 0C     	LD A,(IX+CHNPRM_OffOnD)
 776++2A47 DD 77 0A     CH_ONDL:	LD (IX+CHNPRM_COnOff),A
 777++2A4A C9           	RET
 778++2A4B
 779++2A4B AF           PLAY:    XOR A
 780++2A4C 32 17 2B     	LD (AddToEn),A
 781++2A4F 32 43 2C     	LD (AYREGS+AR_Mixer),A
 782++2A52 3D           	DEC A
 783++2A53 32 49 2C     	LD (AYREGS+AR_EnvTp),A
 784++2A56 21 36 2C     	LD HL,DelyCnt
 785++2A59 35           	DEC (HL)
 786++2A5A 20 7F        	JR NZ,PL2
 787++2A5C 21 FA 2B     	LD HL,ChanA+CHNPRM_NtSkCn
 788++2A5F 35           	DEC (HL)
 789++2A60 20 4C        	JR NZ,PL1B
 790++2A62              AdInPtA:	.equ $+1
 791++2A62 01 01 01     	LD BC,$0101
 792++2A65 0A           	LD A,(BC)
 793++2A66 A7           	AND A
 794++2A67 20 3A        	JR NZ,PL1A
 795++2A69 57           	LD D,A
 796++2A6A 32 3A 2C     	LD (Ns_Base),A
 797++2A6D 2A B1 25     	LD HL,(CrPsPtr)
 798++2A70 23           	INC HL
 799++2A71 7E           	LD A,(HL)
 800++2A72 3C           	INC A
 801++2A73 20 08        	JR NZ,PLNLP
 802++2A75 CD B3 25     	CALL CHECKLP
 803++2A78              LPosPtr:	.equ $+1
 804++2A78 21 21 21     	LD HL,$2121
 805++2A7B 7E           	LD A,(HL)
 806++2A7C 3C           	INC A
 807++2A7D 22 B1 25     PLNLP:	LD (CrPsPtr),HL
 808++2A80 3D           	DEC A
 809++2A81 87           	ADD A,A
 810++2A82 5F           	LD E,A
 811++2A83 CB 12        	RL D
 812++2A85              PatsPtr:	.equ $+1
 813++2A85 21 21 21     	LD HL,$2121
 814++2A88 19           	ADD HL,DE
 815++2A89 ED 5B 3E 27  	LD DE,(MODADDR)
 816++2A8D ED 73 A1 2A  	LD (PSP_+1),SP
 817++2A91 F9           	LD SP,HL
 818++2A92 E1           	POP HL
 819++2A93 19           	ADD HL,DE
 820++2A94 44           	LD B,H
 821++2A95 4D           	LD C,L
 822++2A96 E1           	POP HL
 823++2A97 19           	ADD HL,DE
 824++2A98 22 B9 2A     	LD (AdInPtB),HL
 825++2A9B E1           	POP HL
 826++2A9C 19           	ADD HL,DE
 827++2A9D 22 CD 2A     	LD (AdInPtC),HL
 828++2AA0 31 31 31     PSP_:	LD SP,$3131
 829++2AA3 DD 21 EB 2B  PL1A:	LD IX,ChanA+12
 830++2AA7 CD 7B 27     	CALL PTDECOD
 831++2AAA ED 43 63 2A  	LD (AdInPtA),BC
 832++2AAE
 833++2AAE 21 17 2C     PL1B:	LD HL,ChanB+CHNPRM_NtSkCn
 834++2AB1 35           	DEC (HL)
 835++2AB2 20 0E        	JR NZ,PL1C
 836++2AB4 DD 21 08 2C  	LD IX,ChanB+12
 837++2AB8              AdInPtB:	.equ $+1
 838++2AB8 01 01 01     	LD BC,$0101
 839++2ABB CD 7B 27     	CALL PTDECOD
 840++2ABE ED 43 B9 2A  	LD (AdInPtB),BC
 841++2AC2
 842++2AC2 21 34 2C     PL1C:	LD HL,ChanC+CHNPRM_NtSkCn
 843++2AC5 35           	DEC (HL)
 844++2AC6 20 0E        	JR NZ,PL1D
 845++2AC8 DD 21 25 2C  	LD IX,ChanC+12
 846++2ACC              AdInPtC:	.equ $+1
 847++2ACC 01 01 01     	LD BC,$0101
 848++2ACF CD 7B 27     	CALL PTDECOD
 849++2AD2 ED 43 CD 2A  	LD (AdInPtC),BC
 850++2AD6
 851++2AD6              Delay:	.equ $+1
 852++2AD6 3E 3E        PL1D:	LD A,$3E
 853++2AD8 32 36 2C     	LD (DelyCnt),A
 854++2ADB
 855++2ADB DD 21 DF 2B  PL2:	LD IX,ChanA
 856++2ADF 2A 3C 2C     	LD HL,(AYREGS+AR_TonA)
 857++2AE2 CD FA 28     	CALL CHREGS
 858++2AE5 22 3C 2C     	LD (AYREGS+AR_TonA),HL
 859++2AE8 3A 46 2C     	LD A,(Ampl)
 860++2AEB 32 44 2C     	LD (AYREGS+AR_AmplA),A
 861++2AEE DD 21 FC 2B  	LD IX,ChanB
 862++2AF2 2A 3E 2C     	LD HL,(AYREGS+AR_TonB)
 863++2AF5 CD FA 28     	CALL CHREGS
 864++2AF8 22 3E 2C     	LD (AYREGS+AR_TonB),HL
 865++2AFB 3A 46 2C     	LD A,(Ampl)
 866++2AFE 32 45 2C     	LD (AYREGS+AR_AmplB),A
 867++2B01 DD 21 19 2C  	LD IX,ChanC
 868++2B05 2A 40 2C     	LD HL,(AYREGS+AR_TonC)
 869++2B08 CD FA 28     	CALL CHREGS
 870++2B0B              ;	LD A,(Ampl) ;Ampl = AYREGS+AR_AmplC
 871++2B0B              ;	LD (AYREGS+AR_AmplC),A
 872++2B0B 22 40 2C     	LD (AYREGS+AR_TonC),HL
 873++2B0E
 874++2B0E 2A 3A 2C     	LD HL,(Ns_Base_AddToNs)
 875++2B11 7C           	LD A,H
 876++2B12 85           	ADD A,L
 877++2B13 32 42 2C     	LD (AYREGS+AR_Noise),A
 878++2B16
 879++2B16              AddToEn: .equ $+1
 880++2B16 3E 3E        	LD A,$3E
 881++2B18 5F           	LD E,A
 882++2B19 87           	ADD A,A
 883++2B1A 9F           	SBC A,A
 884++2B1B 57           	LD D,A
 885++2B1C 2A 4A 2C     	LD HL,(EnvBase)
 886++2B1F 19           	ADD HL,DE
 887++2B20 ED 5B 37 2C  	LD DE,(CurESld)
 888++2B24 19           	ADD HL,DE
 889++2B25 22 47 2C     	LD (AYREGS+AR_Env),HL
 890++2B28
 891++2B28 AF           	XOR A
 892++2B29 21 39 2C     	LD HL,CurEDel
 893++2B2C B6           	OR (HL)
 894++2B2D 28 0E        	JR Z,ROUT_A0
 895++2B2F 35           	DEC (HL)
 896++2B30 20 0A        	JR NZ,ROUT
 897++2B32              Env_Del:	.equ $+1
 898++2B32 3E 3E        	LD A,$3E
 899++2B34 77           	LD (HL),A
 900++2B35              ESldAdd:	.equ $+1
 901++2B35 21 21 21     	LD HL,$2121
 902++2B38 19           	ADD HL,DE
 903++2B39 22 37 2C     	LD (CurESld),HL
 904++2B3C
 905++2B3C AF           ROUT:	XOR A
 906++2B3D              ROUT_A0:
 907++2B3D 0E A0        	LD C,$A0
 908++2B3F 21 3C 2C     	LD HL,AYREGS
 909++2B42 ED 79        LOUT:	OUT (C),A
 910++2B44 0C           	INC C
 911++2B45 ED A3        	OUTI
 912++2B47 0D           	DEC C
 913++2B48 3C           	INC A
 914++2B49 FE 0D        	CP 13
 915++2B4B 20 F5        	JR NZ,LOUT
 916++2B4D ED 79        	OUT (C),A
 917++2B4F 7E           	LD A,(HL)
 918++2B50 A7           	AND A
 919++2B51 F8           	RET M
 920++2B52 0C           	INC C
 921++2B53 ED 79        	OUT (C),A
 922++2B55 C9           	RET
 923++2B56
 924++2B56 64           NT_DATA:	.db (T_NEW_0-T1_)*2
 925++2B57 2A           	.db TCNEW_0-T_
 926++2B58 65           	.db (T_OLD_0-T1_)*2+1
 927++2B59 00           	.db TCOLD_0-T_
 928++2B5A 01           	.db (T_NEW_1-T1_)*2+1
 929++2B5B 0C           	.db TCNEW_1-T_
 930++2B5C 01           	.db (T_OLD_1-T1_)*2+1
 931++2B5D 0C           	.db TCOLD_1-T_
 932++2B5E 94           	.db (T_NEW_2-T1_)*2
 933++2B5F 35           	.db TCNEW_2-T_
 934++2B60 30           	.db (T_OLD_2-T1_)*2
 935++2B61 0E           	.db TCOLD_2-T_
 936++2B62 60           	.db (T_NEW_3-T1_)*2
 937++2B63 20           	.db TCNEW_3-T_
 938++2B64 60           	.db (T_OLD_3-T1_)*2
 939++2B65 21           	.db TCOLD_3-T_
 940++2B66
 941++2B66              T_:
 942++2B66
 943++2B66 01 05 09 0B  TCOLD_0:	.db $00+1,$04+1,$08+1,$0A+1,$0C+1,$0E+1,$12+1,$14+1
 943++2B6A 0D 0F 13 15
 944++2B6E 19 25 3D 00  	.db $18+1,$24+1,$3C+1,0
 945++2B72 5D 00        TCOLD_1:	.db $5C+1,0
 946++2B74 31 37 4D 53  TCOLD_2:	.db $30+1,$36+1,$4C+1,$52+1,$5E+1,$70+1,$82,$8C,$9C
 946++2B78 5F 71 82 8C
 946++2B7C 9C
 947++2B7D 9E A0 A6 A8  	.db $9E,$A0,$A6,$A8,$AA,$AC,$AE,$AE,0
 947++2B81 AA AC AE AE
 947++2B85 00
 948++2B86 57           TCNEW_3:	.db $56+1
 949++2B87 1F 23 25 29  TCOLD_3:	.db $1E+1,$22+1,$24+1,$28+1,$2C+1,$2E+1,$32+1,$BE+1,0
 949++2B8B 2D 2F 33 BF
 949++2B8F 00
 950++2B90 1D 21 23 27  TCNEW_0:	.db $1C+1,$20+1,$22+1,$26+1,$2A+1,$2C+1,$30+1,$54+1
 950++2B94 2B 2D 31 55
 951++2B98 BD BF 00     	.db $BC+1,$BE+1,0
 952++2B9B              TCNEW_1: .equ TCOLD_1
 953++2B9B 1B 21 25 29  TCNEW_2:	.db $1A+1,$20+1,$24+1,$28+1,$2A+1,$3A+1,$4C+1,$5E+1
 953++2B9F 2B 3B 4D 5F
 954++2BA3 BB BD BF 00  	.db $BA+1,$BC+1,$BE+1,0
 955++2BA7
 956++2BA7              EMPTYSAMORN: .equ $-1
 957++2BA7 01 00 90     	.db 1,0,$90 ;delete $90 if you don't need default sample
 958++2BAA
 959++2BAA              ;first 12 values of tone tables (packed)
 960++2BAA
msxplayer.asm(961): warning: value 0xDD8 is truncated to 8bit value: 0xD8
 961++2BAA 0D D8        T_PACK:	.db $06EC*2/256,$06EC*2
 962++2BAC 69           	.db $0755-$06EC
 963++2BAD 70           	.db $07C5-$0755
 964++2BAE 76           	.db $083B-$07C5
 965++2BAF 7D           	.db $08B8-$083B
 966++2BB0 85           	.db $093D-$08B8
 967++2BB1 8D           	.db $09CA-$093D
 968++2BB2 95           	.db $0A5F-$09CA
 969++2BB3 9D           	.db $0AFC-$0A5F
 970++2BB4 A8           	.db $0BA4-$0AFC
 971++2BB5 B1           	.db $0C55-$0BA4
 972++2BB6 BB           	.db $0D10-$0C55
msxplayer.asm(973): warning: value 0xCDA is truncated to 8bit value: 0xDA
 973++2BB7 0C DA        	.db $066D*2/256,$066D*2
 974++2BB9 62           	.db $06CF-$066D
 975++2BBA 68           	.db $0737-$06CF
 976++2BBB 6D           	.db $07A4-$0737
 977++2BBC 75           	.db $0819-$07A4
 978++2BBD 7B           	.db $0894-$0819
 979++2BBE 83           	.db $0917-$0894
 980++2BBF 8A           	.db $09A1-$0917
 981++2BC0 92           	.db $0A33-$09A1
 982++2BC1 9C           	.db $0ACF-$0A33
 983++2BC2 A4           	.db $0B73-$0ACF
 984++2BC3 AF           	.db $0C22-$0B73
 985++2BC4 B8           	.db $0CDA-$0C22
msxplayer.asm(986): warning: value 0xE08 is truncated to 8bit value: 0x08
 986++2BC5 0E 08        	.db $0704*2/256,$0704*2
 987++2BC7 6A           	.db $076E-$0704
 988++2BC8 72           	.db $07E0-$076E
 989++2BC9 78           	.db $0858-$07E0
 990++2BCA 7E           	.db $08D6-$0858
 991++2BCB 86           	.db $095C-$08D6
 992++2BCC 90           	.db $09EC-$095C
 993++2BCD 96           	.db $0A82-$09EC
 994++2BCE A0           	.db $0B22-$0A82
 995++2BCF AA           	.db $0BCC-$0B22
 996++2BD0 B4           	.db $0C80-$0BCC
 997++2BD1 BE           	.db $0D3E-$0C80
msxplayer.asm(998): warning: value 0xFC0 is truncated to 8bit value: 0xC0
 998++2BD2 0F C0        	.db $07E0*2/256,$07E0*2
 999++2BD4 78           	.db $0858-$07E0
1000++2BD5 88           	.db $08E0-$0858
1001++2BD6 80           	.db $0960-$08E0
1002++2BD7 90           	.db $09F0-$0960
1003++2BD8 98           	.db $0A88-$09F0
1004++2BD9 A0           	.db $0B28-$0A88
1005++2BDA B0           	.db $0BD8-$0B28
1006++2BDB A8           	.db $0C80-$0BD8
1007++2BDC E0           	.db $0D60-$0C80
1008++2BDD B0           	.db $0E10-$0D60
1009++2BDE E8           	.db $0EF8-$0E10
1010++2BDF
1011++2BDF              ;vars from here can be stripped
1012++2BDF              ;you can move VARS to any other address
1013++2BDF
1014++2BDF              VARS:
1015++2BDF
1016++2BDF              ;ChannelsVars
1017++2BDF              ;struc	CHNPRM
1018++2BDF              ;reset group
1019++2BDF              CHNPRM_PsInOr:	.equ 0	;RESB 1
1020++2BDF              CHNPRM_PsInSm:	.equ 1	;RESB 1
1021++2BDF              CHNPRM_CrAmSl:	.equ 2	;RESB 1
1022++2BDF              CHNPRM_CrNsSl:	.equ 3	;RESB 1
1023++2BDF              CHNPRM_CrEnSl:	.equ 4	;RESB 1
1024++2BDF              CHNPRM_TSlCnt:	.equ 5	;RESB 1
1025++2BDF              CHNPRM_CrTnSl:	.equ 6	;RESW 1
1026++2BDF              CHNPRM_TnAcc:	.equ 8	;RESW 1
1027++2BDF              CHNPRM_COnOff:	.equ 10	;RESB 1
1028++2BDF              ;reset group
1029++2BDF
1030++2BDF              CHNPRM_OnOffD:	.equ 11	;RESB 1
1031++2BDF
1032++2BDF              ;IX for PTDECOD here (+12)
1033++2BDF              CHNPRM_OffOnD:	.equ 12	;RESB 1
1034++2BDF              CHNPRM_OrnPtr:	.equ 13	;RESW 1
1035++2BDF              CHNPRM_SamPtr:	.equ 15	;RESW 1
1036++2BDF              CHNPRM_NNtSkp:	.equ 17	;RESB 1
1037++2BDF              CHNPRM_Note:	.equ 18	;RESB 1
1038++2BDF              CHNPRM_SlToNt:	.equ 19	;RESB 1
1039++2BDF              CHNPRM_Env_En:	.equ 20	;RESB 1
1040++2BDF              CHNPRM_Flags:	.equ 21	;RESB 1
1041++2BDF               ;Enabled - 0,SimpleGliss - 2
1042++2BDF              CHNPRM_TnSlDl:	.equ 22	;RESB 1
1043++2BDF              CHNPRM_TSlStp:	.equ 23	;RESW 1
1044++2BDF              CHNPRM_TnDelt:	.equ 25	;RESW 1
1045++2BDF              CHNPRM_NtSkCn:	.equ 27	;RESB 1
1046++2BDF              CHNPRM_Volume:	.equ 28	;RESB 1
1047++2BDF              CHNPRM_Size	.equ 29	;RESB 1
1048++2BDF              ;endstruc
1049++2BDF
1050++2BDF 00 00 00...  ChanA:	.ds CHNPRM_Size
1051++2BFC 00 00 00...  ChanB:	.ds CHNPRM_Size
1052++2C19 00 00 00...  ChanC:	.ds CHNPRM_Size
1053++2C36
1054++2C36              ;struc	AR
1055++2C36              AR_TonA:	.equ 0	;RESW 1
1056++2C36              AR_TonB:	.equ 2	;RESW 1
1057++2C36              AR_TonC:	.equ 4	;RESW 1
1058++2C36              AR_Noise:	.equ 6	;RESB 1
1059++2C36              AR_Mixer:	.equ 7	;RESB 1
1060++2C36              AR_AmplA:	.equ 8	;RESB 1
1061++2C36              AR_AmplB:	.equ 9	;RESB 1
1062++2C36              AR_AmplC:	.equ 10	;RESB 1
1063++2C36              AR_Env:	.equ 11	;RESW 1
1064++2C36              AR_EnvTp:	.equ 13	;RESB 1
1065++2C36              ;endstruc
1066++2C36
1067++2C36              ;GlobalVars
1068++2C36 00           DelyCnt:	.db 0
1069++2C37 00 00        CurESld:	.dw 0
1070++2C39 00           CurEDel:	.db 0
1071++2C3A              Ns_Base_AddToNs:
1072++2C3A 00           Ns_Base:	.db 0
1073++2C3B 00           AddToNs:	.db 0
1074++2C3C
1075++2C3C              AYREGS:
1076++2C3C
1077++2C3C 00 00 00...  VT_:	.ds 256 ;CreatedVolumeTableAddress
1078++2D3C
1079++2D3C              EnvBase:	.equ VT_+14
1080++2D3C
1081++2D3C              T1_:	.equ VT_+16 ;Tone tables data depacked here
1082++2D3C
1083++2D3C              T_OLD_1:	.equ T1_
1084++2D3C              T_OLD_2:	.equ T_OLD_1+24
1085++2D3C              T_OLD_3:	.equ T_OLD_2+24
1086++2D3C              T_OLD_0:	.equ T_OLD_3+2
1087++2D3C              T_NEW_0:	.equ T_OLD_0
1088++2D3C              T_NEW_1:	.equ T_OLD_1
1089++2D3C              T_NEW_2:	.equ T_NEW_0+24
1090++2D3C              T_NEW_3:	.equ T_OLD_3
1091++2D3C
1092++2D3C 00 00 00...  NT_:	.ds 192 ;CreatedNoteTableAddress
1093++2DFC
1094++2DFC              ;local var
1095++2DFC              Ampl:	.equ AYREGS+AR_AmplC
1096++2DFC
1097++2DFC              VAR0END:	.equ VT_+16 ;INIT zeroes from VARS to VAR0END-1
1098++2DFC
1099++2DFC              VARSEND: .equ $
1100++2DFC              	endmodule
1101++2DFC              ;Release 0 steps:
1102++2DFC              ;11.Sep.2004 - Note tables creator
1103++2DFC              ;12.Sep.2004 - Volume tables creator; INIT subroutine
1104++2DFC              ;13.Sep.2004 - Play counters, position counters
1105++2DFC              ;14.Sep.2004 - Patterns decoder subroutine
1106++2DFC              ;15.Sep.2004 - Resting (no code)
1107++2DFC              ;16.Sep.2004 - CHREGS subroutine; global debugging; 1st stable
1108++2DFC              ;version was born
1109++2DFC              ;17.Sep.2004 - Debugging and optimization. First release!
1110++2DFC              ;Release 1 steps:
1111++2DFC              ;20.Sep.2004 - local vars moved to code (selfmodified code
1112++2DFC              ;smaller and faster)
1113++2DFC              ;22.Sep.2004 - added mute sound entry at START+8; position
1114++2DFC              ;pointer moved to START+11; added setup and status byte at
1115++2DFC              ;START+10 noloop mode and loop passed flags added
1116++2DFC              ;Release 2 steps:
1117++2DFC              ;28.Sep.2004 - Optimization: code around CHREGS's volume and
1118++2DFC              ;vibrato faster now; zeroing PD_RES through stack; Ton and Ampl
1119++2DFC              ;moved from channel vars to global ones; first position selector
1120++2DFC              ;removed from INIT; optimization for packers(Ivan Roshin method)
1121++2DFC              ;Release 3 steps:
1122++2DFC              ;2.Oct.2004 - optimization in INIT and PD_LOOP (thanks to Ivan
1123++2DFC              ;Roshin)
1124++2DFC              ;4.Oct.2004 - load delay from (hl) in INIT (2 bytes shorter)
1125++2DFC              ;5.Oct.2004 - optimization in PD_LOOP (->PD_LP2)
1126++2DFC              ;7.Oct.2004 - swaping some commands for better packing
1127++2DFC              ;Release 4 steps:
1128++2DFC              ;9.Oct.2004 - optimization around LD HL,SPCCOMS (thanks to Ivan
1129++2DFC              ;Roshin); in PTDECOD swapped BC and DE to optimize C_PORTM;
1130++2DFC              ;removed sam and orn len and loop channel vars; CHREGS totally
1131++2DFC              ;optimized
1132++2DFC              ;Release 5 steps:
1133++2DFC              ;11.Oct.2004 - PD_OrSm and C_PORTM optimized; Ivan Roshin's
1134++2DFC              ;volume tables creator algorithm (51 bytes shorter than mine)
1135++2DFC              ;12.Oct.2004 - Ivan Roshin's note tables creator algorithm (74
1136++2DFC              ;bytes shorter than mine)
1137++2DFC              ;Release 6 steps:
1138++2DFC              ;14.Oct.2004 - loop and next position calculations moved to INIT
1139++2DFC              ;15.Oct.2004 - AdInPt moved to code
1140++2DFC              ;19.Oct.2004 - Env_Del moved to code
1141++2DFC              ;20.Oct.2004 - Version PUSH and POP (1 byte shorter, thanks to
1142++2DFC              ;Ivan Roshin)
1143++2DFC              ;22.Oct.2004 - Env_En moved from Flags' bit to byte (shorter and
1144++2DFC              ;faster code)
1145++2DFC              ;25.Oct.2004 - SETENV optimized
1146++2DFC              ;29.Oct.2004 - Optimized around AddToEn (SBC A,A, thanks to Ivan
1147++2DFC              ;Roshin)
1148++2DFC              ;3.Nov.2004 - Note tables data was compressed; with depacker it
1149++2DFC              ;is 9 bytes shorter than uncompressed (thanks to Ivan Roshin)
1150++2DFC              ;4.Nov.2004 - default sample and ornament both are fixed now
1151++2DFC              ;and placed into code block (6 bytes shorter)
1152++2DFC              ;7.Nov.2004 - LD A,(Ns_Base):LD L,A changed to LD HL,(Ns_Base)
1153++2DFC              ;(thanks to Dima Bystrov)
1154++2DFC              ;9.Nov.2004 - Ns_Base and AddToNs are merged to Ns_Base_AddToNs;
1155++2DFC              ;LD A,255 changed to DEC A (at start of PLAY); added ROUT_A0
1156++2DFC              ;12.Nov.2004 - NtSkCn&Volume are merged (8 bytes smaller init);
1157++2DFC              ;LD BC,T1_ changed to PUSH DE...POP BC in note table creator
1158++2DFC              ;19.Dec.2004 - NT_DATA reorganized (6 bytes shorter, thanks to
1159++2DFC              ;Ivan Roshin); C_PORTM and C_GLISS are merged via SET_STP (48
1160++2DFC              ;tacts slower, but 8 bytes smaller, thanks to Ivan Roshin)
1161++2DFC              ;09.Jan.2005 - Adapted to MSX by Alfonso D.C. a.k.a. Dioniso
1162++2DFC
1163++2DFC              ;Notes:
1164++2DFC              ;Pro Tracker 3.4r can not be detected by header, so PT3.4r tone
1165++2DFC              ;tables realy used only for modules of 3.3 and older versions.
# file closed: player/msxplayer.asm
  24++2DFC              	ELSE
  25++2DFC ~            play:
  26++2DFC ~                ld a, 255
  27++2DFC ~                ld (oldminutes), a
  28++2DFC ~
  29++2DFC ~                call Console.waitForKeyUp
  30++2DFC ~
  31++2DFC ~                ld hl, message
  31++2DFC ~              call DialogBox.msgNoWait
  32++2DFC ~
  33++2DFC ~                ld hl, outputBuffer
  33++2DFC ~              call VTPL.INIT
  34++2DFC ~
  35++2DFC ~
  36++2DFC ~                ld a, 1, (Render.play_next), a
  37++2DFC ~
  38++2DFC ~                IFDEF GS
  39++2DFC ~                call GeneralSound.stopModule
  40++2DFC ~                ENDIF
  41++2DFC ~            .loop
  42++2DFC ~                halt
  42++2DFC ~              di
  42++2DFC ~              call VTPL.PLAY
  42++2DFC ~              ei
  43++2DFC ~                xor a
  43++2DFC ~              in a, (#fe)
  43++2DFC ~              cpl
  43++2DFC ~              and 31
  43++2DFC ~              jp nz, .stopKey
  44++2DFC ~                call printRTC
  45++2DFC ~                ld a, (VTPL.SETUP)
  45++2DFC ~              rla
  45++2DFC ~              jr nc, .loop
  46++2DFC ~                ld a, 1, (Render.play_next), a
  47++2DFC ~            .stop
  48++2DFC ~                call VTPL.MUTE
  49++2DFC ~
  50++2DFC ~                IFDEF AY
  51++2DFC ~                call restoreAyState
  52++2DFC ~                ENDIF
  53++2DFC ~
  54++2DFC ~                call Console.waitForKeyUp
  55++2DFC ~                ret
  56++2DFC ~            .stopKey
  57++2DFC ~                xor a
  57++2DFC ~              ld (Render.play_next), a
  58++2DFC ~                jr .stop
  59++2DFC ~
  60++2DFC ~                IFDEF AY
  61++2DFC ~            restoreAyState:
  62++2DFC ~                ld a, #07
  63++2DFC ~                ld bc, #fffd
  64++2DFC ~                out (c), a
  65++2DFC ~                ld a, #fc
  66++2DFC ~                ld b, #bf
  67++2DFC ~                out (c), a ; Enable read mode
  68++2DFC ~
  69++2DFC ~                ld a, #0e
  70++2DFC ~                ld bc, #fffd
  71++2DFC ~                out (c), a
  72++2DFC ~                ret
  73++2DFC ~            	ENDIF
  74++2DFC ~            message db "Press key to stop...", 0
  75++2DFC ~                ENDMODULE
  76++2DFC ~                include "player.asm"
  77++2DFC                  ENDIF
# file closed: player/vortex-processor.asm
  18+ 2DFC                  include "player/mod-processor.asm"
# file opened: player/mod-processor.asm
   1++2DFC                  MODULE ModProcessor
   2++2DFC                  ifdef GS
   3++2DFC ~
   4++2DFC ~                macro GS_WaitCommand2
   5++2DFC ~            .wait
   6++2DFC ~                in a, (CMD)
   7++2DFC ~                rrca
   8++2DFC ~                jr c, .wait
   9++2DFC ~                endm
  10++2DFC ~
  11++2DFC ~                macro GS_SendCommand2 nn
  12++2DFC ~                ld a, nn
  12++2DFC ~              out (CMD), a
  13++2DFC ~                endm
  14++2DFC ~
  15++2DFC ~            play:
  16++2DFC ~                ld a, 255
  17++2DFC ~                ld (oldminutes), a
  18++2DFC ~
  19++2DFC ~                call Console.waitForKeyUp
  20++2DFC ~
  21++2DFC ~                ld hl, Gopher.requestbuffer
  21++2DFC ~              call DialogBox.msgNoWait
  22++2DFC ~
  23++2DFC ~                ;ld a, 1, (Render.play_next), a
  24++2DFC ~            	xor a
  25++2DFC ~            	ld (last_song_position),a
  26++2DFC ~
  27++2DFC ~                ld h, #00, a, 32
  28++2DFC ~                call TextMode.fillLine
  29++2DFC ~                ld de, #0001
  29++2DFC ~              call TextMode.gotoXY
  30++2DFC ~                ld hl, message
  30++2DFC ~              call TextMode.printZ
  31++2DFC ~                ld a, #00
  32++2DFC ~                call TextMode.highlightLine
  33++2DFC ~
  34++2DFC ~            .loop
  35++2DFC ~                halt
  36++2DFC ~                xor a
  37++2DFC ~                call Console.peekC
  38++2DFC ~                cp Console.BACKSPACE
  39++2DFC ~                jp z, .stopKey
  40++2DFC ~            	cp SPACE
  41++2DFC ~                jp z, .playNext
  42++2DFC ~
  43++2DFC ~                call printRTC
  44++2DFC ~
  45++2DFC ~               ;проверка что MOD начал играть сначала
  46++2DFC ~                GS_SendCommand2 CMD_GET_SONG_POSITION
  47++2DFC ~                GS_WaitCommand2
  48++2DFC ~            	ld a,(last_song_position) ;предыдущая позиция
  49++2DFC ~            	ld c,a
  50++2DFC ~            	in a,(DATA) ;текущая позиция
  51++2DFC ~            	ld (last_song_position),a
  52++2DFC ~            	cp c
  53++2DFC ~            	jr nc, .loop ;если не меньше, продолжаем играть
  54++2DFC ~            .playNext
  55++2DFC ~                ld a, 1, (Render.play_next), a ;флаг что надо будет играть следующий файл
  56++2DFC ~            .stop
  57++2DFC ~                call GeneralSound.stopModule
  58++2DFC ~
  59++2DFC ~                call Console.waitForKeyUp
  60++2DFC ~                ret
  61++2DFC ~            .stopKey
  62++2DFC ~                xor a
  62++2DFC ~              ld (Render.play_next), a ;флаг что не надо играть следующий файл
  63++2DFC ~                jr .stop
  64++2DFC ~
  65++2DFC ~            message
  66++2DFC ~                IFDEF SCREEN64
  67++2DFC ~                ENDIF
  68++2DFC ~                IFDEF SCREEN80
  69++2DFC ~                db "       "
  70++2DFC ~                ENDIF
  71++2DFC ~                IFDEF SCREEN85
  72++2DFC ~                db "         "
  73++2DFC ~                ENDIF
  74++2DFC ~
  75++2DFC ~                db "Playing MODs [SPACE] for next song [BACKSPACE] for stop playing.", 0
  76++2DFC ~
  77++2DFC ~            CMD_GET_SONG_POSITION     = #60
  78++2DFC ~            last_song_position db 0
  79++2DFC ~
  80++2DFC ~            ;; Control ports
  81++2DFC ~            CMD  = 187
  82++2DFC ~            DATA = 179
  83++2DFC                  endif
  84++2DFC                  ENDMODULE
  85++2DFC
# file closed: player/mod-processor.asm
  19+ 2DFC                  include "screen/rtc.asm"
# file opened: screen/rtc.asm
   1++2DFC              printRTC
   2++2DFC              	IFDEF RTC
   3++2DFC CD DA 1F     	call Clock.readTime
   4++2DFF
   5++2DFF 3A A1 2E     	ld a, (oldminutes)
   6++2E02 57           	ld d,a
   7++2E03 3A 97 2E     	ld a, (minutes)
   8++2E06 BA           	cp d					; Update only if minutes changed
   9++2E07 C8           	ret z
  10++2E08 32 A1 2E     	ld (oldminutes), a
  11++2E0B
  12++2E0B 16 01        	ld d,1 ;??? Y,X
  13++2E0D 1E 49        	ld e,80 - 7
  14++2E0F CD 70 02     	call TextMode.gotoXY
  15++2E12 3E 5B        	ld a,'['
  16++2E14 CD EC 01     	call TextMode.putC
  17++2E17 26 00        	ld h,0
  18++2E19 3A 96 2E     	ld a,(hours) ;
  19++2E1C 6F           	ld l,a
  20++2E1D CD 40 2E     	call toDecimal
  21++2E20 21 9C 2E     	ld hl,decimalS+3
  22++2E23 CD E1 01     	call TextMode.printZ
  23++2E26 3E 3A        	ld a,':'
  24++2E28 CD EC 01     	call TextMode.putC
  25++2E2B 26 00        	ld h,0
  26++2E2D 3A 97 2E     	ld a,(minutes) ;
  27++2E30 6F           	ld l,a
  28++2E31 CD 40 2E     	call toDecimal
  29++2E34 21 9C 2E     	ld hl,decimalS+3
  30++2E37 CD E1 01     	call TextMode.printZ
  31++2E3A              	;ld a,':'
  32++2E3A              	;call TextMode.putC
  33++2E3A              	;ld h,0
  34++2E3A              	;ld a,(seconds) ;ᥪ㭤
  35++2E3A              	;ld l,a
  36++2E3A              	;call toDecimal
  37++2E3A              	;ld hl,decimalS+3
  38++2E3A              	;call TextMode.printZ
  39++2E3A 3E 5D        	ld a,']'
  40++2E3C CD EC 01     	call TextMode.putC
  41++2E3F C9           	ret
  42++2E40
  43++2E40              toDecimal		; 2   5  
  44++2E40              				; 室  HL ᫮
  45++2E40 11 10 27     	ld de,10000 ;⪨ 
  46++2E43 3E FF        	ld a,255
  47++2E45              toDecimal10k
  48++2E45 A7           	and a
  49++2E46 ED 52        	sbc hl,de
  50++2E48 3C           	inc a
  51++2E49 30 FA        	jr nc,toDecimal10k
  52++2E4B 19           	add hl,de
  53++2E4C C6 30        	add a,48
  54++2E4E 32 99 2E     	ld (decimalS),a
  55++2E51 11 E8 03     	ld de,1000 ;
  56++2E54 3E FF        	ld a,255
  57++2E56              toDecimal1k
  58++2E56 A7           	and a
  59++2E57 ED 52        	sbc hl,de
  60++2E59 3C           	inc a
  61++2E5A 30 FA        	jr nc,toDecimal1k
  62++2E5C 19           	add hl,de
  63++2E5D C6 30        	add a,48
  64++2E5F 32 9A 2E     	ld (decimalS+1),a
  65++2E62 11 64 00     	ld de,100 ;⭨
  66++2E65 3E FF        	ld a,255
  67++2E67              toDecimal01k
  68++2E67 A7           	and a
  69++2E68 ED 52        	sbc hl,de
  70++2E6A 3C           	inc a
  71++2E6B 30 FA        	jr nc,toDecimal01k
  72++2E6D 19           	add hl,de
  73++2E6E C6 30        	add a,48
  74++2E70 32 9B 2E     	ld (decimalS+2),a
  75++2E73 11 0A 00     	ld de,10 ;⪨
  76++2E76 3E FF        	ld a,255
  77++2E78              toDecimal001k
  78++2E78 A7           	and a
  79++2E79 ED 52        	sbc hl,de
  80++2E7B 3C           	inc a
  81++2E7C 30 FA        	jr nc,toDecimal001k
  82++2E7E 19           	add hl,de
  83++2E7F C6 30        	add a,48
  84++2E81 32 9C 2E     	ld (decimalS+3),a
  85++2E84 11 01 00     	ld de,1 ;
  86++2E87 3E FF        	ld a,255
  87++2E89              toDecimal0001k
  88++2E89 A7           	and a
  89++2E8A ED 52        	sbc hl,de
  90++2E8C 3C           	inc a
  91++2E8D 30 FA        	jr nc,toDecimal0001k
  92++2E8F 19           	add hl,de
  93++2E90 C6 30        	add a,48
  94++2E92 32 9D 2E     	ld (decimalS+4),a
  95++2E95 C9           	ret
  96++2E96              hours
  97++2E96 00           	db 0
  98++2E97              minutes
  99++2E97 00           	db 0
 100++2E98              seconds
 101++2E98 00           	db 0
 102++2E99 00 00 00...  decimalS	ds 7 ; 
 103++2EA0              	ENDIF
 104++2EA0 C9           	ret
 105++2EA1              oldminutes		;  㡨  ᫮
 106++2EA1 FF           	db 255
 107++2EA2
 108++2EA2
 109++2EA2
 110++2EA2
# file closed: screen/rtc.asm
  20+ 2EA2 66 6F 6E 74  fontName db "font.bin",0
  20+ 2EA6 2E 62 69 6E
  20+ 2EAA 00
  21+ 2EAB              start:
  22+ 2EAB 2A 06 00         ld hl,(0x0006)
  23+ 2EAE 01 FA 2E         ld bc,outputBuffer
  24+ 2EB1 ED 42            sbc hl,bc
  25+ 2EB3 01 00 01         ld bc, 0x100
  26+ 2EB6 ED 42            sbc hl,bc
  27+ 2EB8 22 F8 2E         ld (ramtop),hl
  28+ 2EBB
  29+ 2EBB CD DA 1A         call TcpIP.init
  29+ 2EBE D2 CD 2E       jp nc, noTcpIP ; No TCP/IP - no browser! Anyway you can use "useless tcp/ip driver"
  30+ 2EC1 CD 77 02         call TextMode.loadFont
  31+ 2EC4 CD 03 01         call TextMode.init
  32+ 2EC7 CD 18 0A         call History.home
  33+ 2ECA C3 8E 02         jp exit
  34+ 2ECD              noTcpIP:
  35+ 2ECD 21 D4 2E         ld hl, .err
  36+ 2ED0 CD 9D 09         call Console.putStringZ
  37+ 2ED3 C7               rst 0
  38+ 2ED4 0D 0A 4E 6F  .err db 13,10,"No TCP/IP implementation found!",13,10,0
  38+ 2ED8 20 54 43 50
  38+ 2EDC 2F 49 50 20
  38+ 2EE0 69 6D 70 6C
  38+ 2EE4 65 6D 65 6E
  38+ 2EE8 74 61 74 69
  38+ 2EEC 6F 6E 20 66
  38+ 2EF0 6F 75 6E 64
  38+ 2EF4 21 0D 0A 00
  39+ 2EF8              ramtop:
  40+ 2EF8 00 D0            db 0x00, 0xD0
  41+ 2EFA              outputBuffer:
  42+ 2EFA              font:
  43+ 2EFA                  display "ENDS: ", $
  44+ 2EFA                  display "Buff size: ", #D000 - $  ;ramtop
# file closed: main-msx.asm
  15  2EFA                  ELSE
  16  2EFA ~                    include "main-all.asm"
  17  2EFA                  ENDIF
# file closed: main.asm
