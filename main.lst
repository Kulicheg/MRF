# file opened: main.asm
   1  0000                  DEFINE TCP_BUFFER_SIZE 2048
   2  0000              ; Generate version string
   3  0000                  LUA ALLPASS
   4  0000 ~                v = tostring(sj.get_define("V"))
   5  0000 ~                maj = string.sub(v, 1,1)
   6  0000 ~                min = string.sub(v, 2,2)
   7  0000 ~                sj.insert_define("VERSION_STRING", "\"" .. maj .. "." .. min .. "\"")
   8  0000 ~
   9  0000 ~                b = tostring(sj.get_define("BLD"))
  10  0000 ~                sj.insert_define("BUILD_STRING", "\"" .. b .. "\"")
  11  0000                  ENDLUA
  12  0000
  13  0000                  IFDEF MSX
  14  0000 ~                    include "main-msx.asm"
  15  0000                  ELSE
  16  0000                      include "main-all.asm"
# file opened: main-all.asm
   1+ 0000                  device	zxspectrum128
   2+ 0000                  IFDEF NEDOOS
   3+ 0000 ~            	DEFINE CRLF "\r\n"
   4+ 0000 ~                    MODULE nos
   5+ 0000 ~                        include "../_sdk/sysdefs.asm"
   6+ 0000 ~                    ENDMODULE
   7+ 0000 ~                    org nos.PROGSTART
   8+ 0000                      ELSE
   9+ 0000              	DEFINE CRLF "\r"
  10+ 0000                      org 24576
  11+ 6000                  ENDIF
  12+ 6000              asmOrg:
  13+ 6000                  align 256
  14+ 6000 C3 D0 9F         jp start
  15+ 6003                  include "vdp/index.asm"
# file opened: vdp/index.asm
   1++6003                  IFDEF TIMEX
   2++6003 ~                include "timex.asm"
   3++6003                  ENDIF
   4++6003
   5++6003                  IFDEF TIMEX80
   6++6003 ~                include "timex80.asm"
   7++6003                  ENDIF
   8++6003
   9++6003                  IFDEF ZXSCR
  10++6003                  include "zx.asm"
# file opened: vdp/zx.asm
   1++6003              COLOR=1
   2++6003              ;; Usual speccy screen driver
   3++6003                  module TextMode
   4++6003              init:
   5++6003 21 D5 61 06      ld hl, font_file, b, Dos.FMODE_READ
   5++6007 01
   6++6008 CD EB 6C         call Dos.fopen
   7++600B F5               push af
   8++600C 01 00 08 21      ld bc, 2048, hl, font64
   8++6010 00 40
   9++6012 CD 42 6F         call Dos.fread
  10++6015 F1               pop af
  11++6016 CD 36 6E         call Dos.fclose
  12++6019 AF           	xor a
  12++601A D3 FE          out (#fe), a
  13++601C C9           	ret
  14++601D              cls:
  15++601D 11 00 00         ld de, 0
  15++6020 CD 3A 60       call gotoXY
  16++6023 3E 07            ld a, 7
  16++6025 CD 45 92       call Memory.setPage
  17++6028 AF               xor a
  17++6029 D3 FE          out (#fe), a
  18++602B 21 00 C0 11      ld hl, #c000, de, #c001, bc, 6911, (hl), a
  18++602F 01 C0 01 FF
  18++6033 1A 77
  18++6035 ED B0          ldir
  19++6037 C3 45 92         jp Memory.setPage
  20++603A
  21++603A
  22++603A              ; Set console coordinates
  23++603A              ; d = row(0..23), e = column (0..63)
  24++603A              gotoXY:
  25++603A              	;rr e;;;
  26++603A CB 3B        	srl e
  27++603C 3E 00        	ld a, 0
  28++603E 32 62 63     	ld (half_tile_screen), a
  29++6041 ED 53 60 63      ld (col_screen), de
  30++6045 C9               ret
  31++6046
  32++6046              disable:
  33++6046                  ; Nothing to disable
  34++6046 C9               ret
  35++6047
  36++6047              ; H - line
  37++6047              ; A - char
  38++6047              fillLine:
  39++6047 F5               push af
  40++6048 54 1E 00         ld d, h, e, 0
  40++604B CD 3A 60       call gotoXY
  41++604E F1               pop af
  42++604F 21 69 63 11      ld hl, fill_buff, de, fill_buff + 1, bc, 63, (hl), a
  42++6053 6A 63 01 3F
  42++6057 00 77
  42++6059 ED B0          ldir
  43++605B 21 69 63         ld hl, fill_buff
  43++605E C3 BC 60       jp printZ
  44++6061
  45++6061              usualLine:
  46++6061 47               ld b, a
  47++6062 0E 00            ld c, 0
  48++6064 CD 79 61         call bc_to_attr
  49++6067 3E 07            ld a, 7
  49++6069 CD 45 92       call Memory.setPage
  50++606C 36 07            ld (hl), #7
  51++606E 54 5D            ld de, hl
  52++6070 13               inc de
  53++6071 01 1F 00         ld bc, 31
  54++6074 ED B0            ldir
  55++6076 AF               xor a
  55++6077 CD 45 92       call Memory.setPage
  56++607A C9               ret
  57++607B
  58++607B              highlightLine:
  59++607B 47               ld b, a
  60++607C 0E 00            ld c, 0
  61++607E CD 79 61         call bc_to_attr
  62++6081 3E 07            ld a, 7
  62++6083 CD 45 92       call Memory.setPage
  63++6086 36 0C            ld (hl), #C
  64++6088 54 5D            ld de, hl
  65++608A 13               inc de
  66++608B 01 1F 00         ld bc, 31
  67++608E ED B0            ldir
  68++6090 AF               xor a
  68++6091 CD 45 92       call Memory.setPage
  69++6094 C9               ret
  70++6095
  71++6095              mvCR
  72++6095 ED 5B 60 63  	ld de, (col_screen)
  73++6099 14           	inc d
  74++609A 1E 00        	ld e, 0
  75++609C 3E 00        	ld a, 0
  76++609E 32 62 63     	ld (half_tile_screen), a
  77++60A1 C3 3A 60     	jp gotoXY
  78++60A4
  79++60A4              ; Print just one symbol
  80++60A4              ; A - symbol
  81++60A4              putC
  82++60A4 FE 0D            cp 13
  82++60A6 CA 95 60       jp z, mvCR
  83++60A9 21 68 63     	ld hl, single_symbol
  84++60AC 77           	ld (hl), a
  85++60AD 3E 07        	ld a, 7
  85++60AF CD 45 92       call Memory.setPage
  86++60B2 21 67 63         ld hl, single_symbol_print
  87++60B5 CD C7 60         call printL
  88++60B8 AF               xor a
  88++60B9 C3 45 92       jp Memory.setPage
  89++60BC
  90++60BC              ; Put string
  91++60BC              ; hl - string pointer that's begins from symbol count
  92++60BC              printZ
  93++60BC 7E               ld a, (hl)
  93++60BD A7             and a
  93++60BE C8             ret z
  94++60BF E5               push hl
  95++60C0 CD A4 60         call putC
  96++60C3 E1               pop hl
  97++60C4 23               inc hl
  98++60C5 18 F5            jr printZ
  99++60C7
 100++60C7              printL
 101++60C7 7E                   ld	a, (hl)
 102++60C8 A7           		and	a
 103++60C9 C8           		ret	z
 104++60CA
 105++60CA E5           		push	hl
 106++60CB CD 75 61     		call	calc_addr_attr
 107++60CE 3A 63 63     		ld	a,(attr_screen)
 108++60D1 77           		ld	(hl),a
 109++60D2 E1           		pop	hl
 110++60D3
 111++60D3 CD 64 61     		call	calc_addr_scr
 112++60D6
 113++60D6 3A 62 63     		ld	a,(half_tile_screen)
 114++60D9 CB 47        		bit	0,a
 115++60DB 7E           		ld	a,(hl)
 116++60DC C2 10 61     		jp	nz,print64_4
 117++60DF              print64_3
 118++60DF F5                   push    af
 119++60E0 E5           		push	hl
 120++60E1 CD 75 61     		call	calc_addr_attr
 121++60E4 3A 63 63     		ld	a,(attr_screen)
 122++60E7 77           		ld	(hl),a
 123++60E8 E1           		pop	hl
 124++60E9
 125++60E9 23                   inc     hl
 126++60EA E5                   push    hl
 127++60EB
 128++60EB 7E                   ld      a,(hl)
 129++60EC 6F           		ld	l,a
 130++60ED 26 00        		ld	h,0
 131++60EF 29           		add	hl,hl
 132++60F0 29           		add	hl,hl
 133++60F1 29           		add	hl,hl
 134++60F2 01 00 40             ld      bc,font64
 135++60F5 09                   add     hl,bc
 136++60F6
 137++60F6 D5                   push    de
 138++60F7
 139++60F7 06 06                ld      b,6
 140++60F9 AF           		xor	a
 141++60FA 12           		ld	(de),a
 142++60FB              print64_1
 143++60FB 14           	inc     d
 144++60FC 7E           	ld      a,(hl)
 145++60FD E6 F0        	and	#f0
 146++60FF 12           	ld      (de),a
 147++6100 23           	inc     hl
 148++6101 10 F8        	djnz    print64_1
 149++6103
 150++6103 14           	inc	d
 151++6104 AF           	xor	a
 152++6105 12           	ld	(de),a
 153++6106
 154++6106 3E 01        	ld	a,1
 155++6108 32 62 63     	ld	(half_tile_screen),a
 156++610B
 157++610B D1           	pop     de
 158++610C E1           	pop     hl
 159++610D F1           	pop     af
 160++610E
 161++610E 3D           	dec     a
 162++610F C8           	ret     z
 163++6110
 164++6110              print64_4
 165++6110 F5           	push    af
 166++6111
 167++6111 23           	inc     hl
 168++6112 E5           	push    hl
 169++6113
 170++6113 7E           	ld      a,(hl)
 171++6114 6F           	ld	l,a
 172++6115 26 00        	ld	h,0
 173++6117 29           	add	hl,hl
 174++6118 29           	add	hl,hl
 175++6119 29           	add	hl,hl
 176++611A 01 00 40     	ld      bc,font64
 177++611D 09           	add     hl,bc
 178++611E
 179++611E D5           	push    de
 180++611F
 181++611F 06 06        	ld      b,6
 182++6121 AF           	xor	a
 183++6122 12           	ld	(de),a
 184++6123              print64_2
 185++6123 14           	inc     d
 186++6124 7E           	ld      a,(hl)
 187++6125 E6 0F        	and     #0f
 188++6127 4F           	ld      c,a
 189++6128 1A           	ld      a,(de)
 190++6129 B1           	or      c
 191++612A 12           	ld      (de),a
 192++612B 23           	inc     hl
 193++612C 10 F5        	djnz    print64_2
 194++612E
 195++612E 14           	inc	d
 196++612F AF           	xor	a
 197++6130 12           	ld	(de),a
 198++6131
 199++6131 32 62 63     	ld	(half_tile_screen),a
 200++6134
 201++6134 D1           	pop     de
 202++6135
 203++6135 CD 3F 61     	call	move_cr64
 204++6138
 205++6138 E1           	pop     hl
 206++6139 F1           	pop     af
 207++613A 3D           	dec     a
 208++613B
 209++613B C2 DF 60     	jp      nz,print64_3
 210++613E
 211++613E C9           	ret
 212++613F
 213++613F              ; move cursor
 214++613F              move_cr64
 215++613F 13           	inc	de
 216++6140
 217++6140 21 60 63     	ld	hl,col_screen
 218++6143 34           	inc	(hl)
 219++6144 7E           	ld	a,(hl)
 220++6145
 221++6145 FE 20        	cp	32
 222++6147 D8           	ret	c
 223++6148
 224++6148 AF           	xor	a
 225++6149 32 62 63     	ld	(half_tile_screen),a
 226++614C 77           	ld	(hl),a
 227++614D 4F           	ld	c,a
 228++614E
 229++614E 23           	inc	hl
 230++614F 34           	inc	(hl)
 231++6150 7E           	ld	a,(hl)
 232++6151 47           	ld	b,a
 233++6152
 234++6152 FE 18        	cp	24
 235++6154 DA 60 61     	jp	c,move_cr64_01
 236++6157
 237++6157 3E 17        	ld	a,23
 238++6159 77           	ld	(hl),a
 239++615A 47           	ld	b,a
 240++615B
 241++615B C5           	push	bc
 242++615C CD 89 61     	call	scroll_up8
 243++615F C1           	pop	bc
 244++6160
 245++6160              move_cr64_01
 246++6160 CD 64 61     	call	calc_addr_scr
 247++6163 C9           	ret
 248++6164
 249++6164              calc_addr_scr
 250++6164 78           	ld      a,b
 251++6165 57           	ld      d,a
 252++6166 0F           	rrca
 253++6167 0F           	rrca
 254++6168 0F           	rrca
 255++6169 A7 E6 E0     	and     a,224
 256++616C 81           	add     a,c
 257++616D 5F           	ld      e,a
 258++616E 7A           	ld      a,d
 259++616F E6 18        	and     24
 260++6171 F6 C0        	or      #c0
 261++6173 57           	ld      d,a
 262++6174 C9           	ret
 263++6175
 264++6175              calc_addr_attr
 265++6175 ED 4B 60 63  	ld	bc,(col_screen)
 266++6179              bc_to_attr:
 267++6179 78           	ld	a,b
 268++617A 0F           	rrca
 269++617B 0F           	rrca
 270++617C 0F           	rrca
 271++617D 6F           	ld	l,a
 272++617E E6 1F        	and	31
 273++6180 F6 D8        	or	#d8
 274++6182 67           	ld	h,a
 275++6183 7D           	ld	a,l
 276++6184 E6 FC        	and	252
 277++6186 B1           	or	c
 278++6187 6F           	ld	l,a
 279++6188 C9           	ret
 280++6189
 281++6189              scroll_up8
 282++6189 21 E0 61     	ld	hl,table_addr_scr
 283++618C 06 B8        	ld	b,184
 284++618E
 285++618E              scroll_up8_01
 286++618E C5           	push	bc
 287++618F
 288++618F 5E           	ld	e,(hl)
 289++6190 23           	inc	hl
 290++6191 56           	ld	d,(hl)
 291++6192 23           	inc	hl
 292++6193
 293++6193 E5           	push	hl
 294++6194
 295++6194 01 0E 00     	ld	bc,14
 296++6197 09           	add	hl,bc
 297++6198 4E           	ld	c,(hl)
 298++6199 23           	inc	hl
 299++619A 46           	ld	b,(hl)
 300++619B
 301++619B 60           	ld	h,b
 302++619C 69           	ld	l,c
 303++619D
 304++619D 01 20 00     	ld	bc,32
 305++61A0 ED B0        	ldir
 306++61A2
 307++61A2 E1           	pop	hl
 308++61A3 C1           	pop	bc
 309++61A4 10 E8        	djnz	scroll_up8_01
 310++61A6
 311++61A6 06 08        	ld	b,8
 312++61A8
 313++61A8              scroll_up8_02
 314++61A8 C5           	push	bc
 315++61A9
 316++61A9 5E           	ld	e,(hl)
 317++61AA 23           	inc	hl
 318++61AB 56           	ld	d,(hl)
 319++61AC 23           	inc	hl
 320++61AD
 321++61AD E5           	push	hl
 322++61AE
 323++61AE 62           	ld	h,d
 324++61AF 6B           	ld	l,e
 325++61B0 13           	inc	de
 326++61B1 36 00        	ld	(hl),0
 327++61B3 01 1F 00     	ld	bc,31
 328++61B6 ED B0        	ldir
 329++61B8
 330++61B8 E1           	pop	hl
 331++61B9 C1           	pop	bc
 332++61BA 10 EC        	djnz	scroll_up8_02
 333++61BC 11 00 D8 21  	ld	de,#D800, hl,#D820, bc,736
 333++61C0 20 D8 01 E0
 333++61C4 02
 334++61C5 ED B0        	ldir
 335++61C7 1A           	ld	a,(de)
 336++61C8 21 E0 DA 11  	ld	hl,#dae0, de,#dae1, (hl),a, bc,31
 336++61CC E1 DA 77 01
 336++61D0 1F 00
 337++61D2 ED B0        	ldir
 338++61D4
 339++61D4 C9           	ret
 340++61D5
 341++61D5              font64 equ #4000 ; Using ZX-Spectrum screen as font buffer
 342++61D5 66 6F 6E 74  font_file db "font64.bin", 0
 342++61D9 36 34 2E 62
 342++61DD 69 6E 00
 343++61E0
 344++61E0
 345++61E0              table_addr_scr
 346++61E0 00 40 00 41  	defw	#4000,#4100,#4200,#4300,#4400,#4500,#4600,#4700
 346++61E4 00 42 00 43
 346++61E8 00 44 00 45
 346++61EC 00 46 00 47
 347++61F0 20 40 20 41  	defw	#4020,#4120,#4220,#4320,#4420,#4520,#4620,#4720
 347++61F4 20 42 20 43
 347++61F8 20 44 20 45
 347++61FC 20 46 20 47
 348++6200 40 40 40 41  	defw	#4040,#4140,#4240,#4340,#4440,#4540,#4640,#4740
 348++6204 40 42 40 43
 348++6208 40 44 40 45
 348++620C 40 46 40 47
 349++6210 60 40 60 41  	defw	#4060,#4160,#4260,#4360,#4460,#4560,#4660,#4760
 349++6214 60 42 60 43
 349++6218 60 44 60 45
 349++621C 60 46 60 47
 350++6220 80 40 80 41  	defw	#4080,#4180,#4280,#4380,#4480,#4580,#4680,#4780
 350++6224 80 42 80 43
 350++6228 80 44 80 45
 350++622C 80 46 80 47
 351++6230 A0 40 A0 41  	defw	#40a0,#41a0,#42a0,#43a0,#44a0,#45a0,#46a0,#47a0
 351++6234 A0 42 A0 43
 351++6238 A0 44 A0 45
 351++623C A0 46 A0 47
 352++6240 C0 40 C0 41  	defw	#40c0,#41c0,#42c0,#43c0,#44c0,#45c0,#46c0,#47c0
 352++6244 C0 42 C0 43
 352++6248 C0 44 C0 45
 352++624C C0 46 C0 47
 353++6250 E0 40 E0 41  	defw	#40e0,#41e0,#42e0,#43e0,#44e0,#45e0,#46e0,#47e0
 353++6254 E0 42 E0 43
 353++6258 E0 44 E0 45
 353++625C E0 46 E0 47
 354++6260
 355++6260 00 48 00 49  	defw	#4800,#4900,#4a00,#4b00,#4c00,#4d00,#4e00,#4f00
 355++6264 00 4A 00 4B
 355++6268 00 4C 00 4D
 355++626C 00 4E 00 4F
 356++6270 20 48 20 49  	defw	#4820,#4920,#4a20,#4b20,#4c20,#4d20,#4e20,#4f20
 356++6274 20 4A 20 4B
 356++6278 20 4C 20 4D
 356++627C 20 4E 20 4F
 357++6280 40 48 40 49  	defw	#4840,#4940,#4a40,#4b40,#4c40,#4d40,#4e40,#4f40
 357++6284 40 4A 40 4B
 357++6288 40 4C 40 4D
 357++628C 40 4E 40 4F
 358++6290 60 48 60 49  	defw	#4860,#4960,#4a60,#4b60,#4c60,#4d60,#4e60,#4f60
 358++6294 60 4A 60 4B
 358++6298 60 4C 60 4D
 358++629C 60 4E 60 4F
 359++62A0 80 48 80 49  	defw	#4880,#4980,#4a80,#4b80,#4c80,#4d80,#4e80,#4f80
 359++62A4 80 4A 80 4B
 359++62A8 80 4C 80 4D
 359++62AC 80 4E 80 4F
 360++62B0 A0 48 A0 49  	defw	#48a0,#49a0,#4aa0,#4ba0,#4ca0,#4da0,#4ea0,#4fa0
 360++62B4 A0 4A A0 4B
 360++62B8 A0 4C A0 4D
 360++62BC A0 4E A0 4F
 361++62C0 C0 48 C0 49  	defw	#48c0,#49c0,#4ac0,#4bc0,#4cc0,#4dc0,#4ec0,#4fc0
 361++62C4 C0 4A C0 4B
 361++62C8 C0 4C C0 4D
 361++62CC C0 4E C0 4F
 362++62D0 E0 48 E0 49  	defw	#48e0,#49e0,#4ae0,#4be0,#4ce0,#4de0,#4ee0,#4fe0
 362++62D4 E0 4A E0 4B
 362++62D8 E0 4C E0 4D
 362++62DC E0 4E E0 4F
 363++62E0
 364++62E0 00 50 00 51  	defw	#5000,#5100,#5200,#5300,#5400,#5500,#5600,#5700
 364++62E4 00 52 00 53
 364++62E8 00 54 00 55
 364++62EC 00 56 00 57
 365++62F0 20 50 20 51  	defw	#5020,#5120,#5220,#5320,#5420,#5520,#5620,#5720
 365++62F4 20 52 20 53
 365++62F8 20 54 20 55
 365++62FC 20 56 20 57
 366++6300 40 50 40 51  	defw	#5040,#5140,#5240,#5340,#5440,#5540,#5640,#5740
 366++6304 40 52 40 53
 366++6308 40 54 40 55
 366++630C 40 56 40 57
 367++6310 60 50 60 51  	defw	#5060,#5160,#5260,#5360,#5460,#5560,#5660,#5760
 367++6314 60 52 60 53
 367++6318 60 54 60 55
 367++631C 60 56 60 57
 368++6320 80 50 80 51  	defw	#5080,#5180,#5280,#5380,#5480,#5580,#5680,#5780
 368++6324 80 52 80 53
 368++6328 80 54 80 55
 368++632C 80 56 80 57
 369++6330 A0 50 A0 51  	defw	#50a0,#51a0,#52a0,#53a0,#54a0,#55a0,#56a0,#57a0
 369++6334 A0 52 A0 53
 369++6338 A0 54 A0 55
 369++633C A0 56 A0 57
 370++6340 C0 50 C0 51  	defw	#50c0,#51c0,#52c0,#53c0,#54c0,#55c0,#56c0,#57c0
 370++6344 C0 52 C0 53
 370++6348 C0 54 C0 55
 370++634C C0 56 C0 57
 371++6350 E0 50 E0 51  	defw	#50e0,#51e0,#52e0,#53e0,#54e0,#55e0,#56e0,#57e0
 371++6354 E0 52 E0 53
 371++6358 E0 54 E0 55
 371++635C E0 56 E0 57
 372++6360
 373++6360
 374++6360 00           col_screen			db	0
 375++6361 00           row_screen			db	0
 376++6362 00           half_tile_screen	db	0
 377++6363 07           attr_screen			db	07
 378++6364
 379++6364 00 00        col_screen_temp			dw	0
 380++6366 00           half_tile_screen_temp	db	0
 381++6367
 382++6367 01           single_symbol_print db 1
 383++6368 00           single_symbol 		db 0
 384++6369
 385++6369 00 00 00...  fill_buff ds 65
 386++63AA
 387++63AA                  endmodule
# file closed: vdp/zx.asm
  11++63AA                  ENDIF
  12++63AA
  13++63AA              	IFDEF NEDOOS
  14++63AA ~                include "nedotext.asm"
  15++63AA                  ENDIF
# file closed: vdp/index.asm
  16+ 63AA                  include "utils/index.asm"
# file opened: utils/index.asm
   1++63AA                  include "atoi.asm"
# file opened: utils/atoi.asm
   1++63AA              ; DE - buffer
   2++63AA              ; HL - output
   3++63AA              atohl:
   4++63AA 21 00 00         ld hl, 0
   5++63AD              .loop
   6++63AD 1A               ld a, (de)
   7++63AE 13               inc de
   8++63AF                  ; Sepparators
   9++63AF C5 E5            push bc, hl
  10++63B1 01 05 00             ld bc, sepparators_len
  11++63B4 21 CC 63             ld hl, sepparators
  12++63B7 ED B1                cpir
  13++63B9 E1 C1            pop hl, bc
  14++63BB C8               ret z
  15++63BC
  16++63BC D6 30            sub '0'
  17++63BE
  18++63BE C5               push bc
  19++63BF 4D                   ld c, l
  20++63C0 44                   ld b, h
  21++63C1
  22++63C1 29                   add hl, hl
  23++63C2 29                   add hl, hl
  24++63C3 09                   add hl, bc
  25++63C4 29                   add hl, hl
  26++63C5 4F                   ld c, a
  27++63C6 06 00                ld b, 0
  28++63C8 09                   add hl, bc
  29++63C9 C1               pop bc
  30++63CA 18 E1            jr .loop
  31++63CC
# file closed: utils/atoi.asm
   2++63CC                  include "constants.asm"
# file opened: utils/constants.asm
   1++63CC              TAB = 9
   2++63CC              CR = 13
   3++63CC              LF = 10
   4++63CC              NULL = 0
   5++63CC              SPACE = ' '
   6++63CC              ESC = 27
   7++63CC              BACKSPACE = 8
   8++63CC
   9++63CC                  IFDEF TIMEX80
  10++63CC ~            MIME_DOWNLOAD 	= #19
  11++63CC ~            MIME_LINK 		= #1A
  12++63CC ~            MIME_TEXT 		= #10
  13++63CC ~            MIME_IMAGE 		= #01
  14++63CC ~            MIME_MUSIC 		= #0e
  15++63CC ~            MIME_INPUT 		= #b3
  16++63CC ~            MIME_MOD 		= #0d
  17++63CC ~            MIME_SOUND      = 's' ;sound
  18++63CC ~
  19++63CC ~            BORDER_TOP = #b2
  20++63CC ~            BORDER_BOTTOM = #b1
  21++63CC                  ELSE
  22++63CC              	IFDEF MSX
  23++63CC ~            MIME_DOWNLOAD 	= 1
  24++63CC ~            MIME_LINK		= 2
  25++63CC ~            MIME_TEXT 		= 3
  26++63CC ~            MIME_IMAGE 		= 4
  27++63CC ~            MIME_MUSIC 		= 5
  28++63CC ~            MIME_INPUT 		= 6
  29++63CC ~            MIME_MOD      	= 7
  30++63CC ~            MIME_SOUND      = 's' ;sound
  31++63CC ~
  32++63CC ~            BORDER_TOP    = 7
  33++63CC ~            BORDER_BOTTOM = 8
  34++63CC              	ELSE
  35++63CC              MIME_DOWNLOAD = 1
  36++63CC              MIME_LINK     = 2
  37++63CC              MIME_TEXT     = 3
  38++63CC              MIME_IMAGE    = 6
  39++63CC              MIME_MUSIC    = 5
  40++63CC              MIME_INPUT    = 4
  41++63CC              MIME_MOD      = 7
  42++63CC              MIME_SOUND    = 's' ;sound
  43++63CC
  44++63CC              BORDER_TOP    = 9
  45++63CC              BORDER_BOTTOM = 8
  46++63CC              	ENDIF
  47++63CC
  48++63CC
  49++63CC
  50++63CC
  51++63CC              	ENDIF
  52++63CC
  53++63CC 0D 0A 09 00  sepparators db CR, LF, TAB, NULL, SPACE
  53++63D0 20
  54++63D1              sepparators_len = $ - sepparators
# file closed: utils/constants.asm
   3++63D1                  include "strutils.asm"
# file opened: utils/strutils.asm
   1++63D1              ; de - pointer
   2++63D1              ; hl - count
   3++63D1              strlen:
   4++63D1 21 00 00         ld hl, 0
   5++63D4              .loop
   6++63D4 1A               ld a, (de)
   7++63D5 A7               and a
   7++63D6 28 04          jr z, .exit
   8++63D8 23               inc hl
   9++63D9 13               inc de
  10++63DA 18 F8            jr .loop
  11++63DC              .exit
  12++63DC C9               ret
  13++63DD
  14++63DD                  module CompareBuff
  15++63DD
  16++63DD              ; Pushes A to buffer
  17++63DD              push
  18++63DD F5               push af
  19++63DE 06 20            ld b, 32
  19++63E0 21 29 64       ld hl, buffer + 1
  19++63E3 11 28 64       ld de, buffer
  20++63E6              .loop
  21++63E6 7E               ld a, (hl)
  21++63E7 12             ld (de), a
  21++63E8 23             inc hl
  21++63E9 13             inc de
  21++63EA 10 FA          djnz .loop
  22++63EC F1               pop af
  23++63ED 21 47 64         ld hl, buffer + 31
  23++63F0 77             ld (hl), a
  24++63F1 C9               ret
  25++63F2
  26++63F2              ; HL - Compare string(null terminated)
  27++63F2              ; A - 0 NOT Found
  28++63F2              ;     1 Found
  29++63F2              search:
  30++63F2 06 00            ld b, 0
  30++63F4 E5             push hl
  31++63F5              .loop:
  32++63F5 7E               ld a, (hl)
  32++63F6 23             inc hl
  32++63F7 04             inc b
  32++63F8 A7             and a
  32++63F9 C2 F5 63       jp nz, .loop
  33++63FC 05               dec b
  33++63FD E1             pop hl
  33++63FE C5             push bc
  33++63FF E5             push hl
  34++6400 E1               pop hl
  35++6401 11 48 64         ld de, buffer + 32
  36++6404              .sourceLoop
  37++6404 1B               dec de
  37++6405 10 FD          djnz .sourceLoop
  38++6407 C1               pop bc
  39++6408              .compare
  40++6408 C5               push bc
  40++6409 F5             push af
  41++640A 1A               ld a, (de)
  41++640B 47             ld b, a
  42++640C F1               pop af
  42++640D 7E             ld a, (hl)
  42++640E B8             cp b
  42++640F C1             pop bc
  42++6410 3E 00          ld a, 0
  42++6412 C0             ret nz
  43++6413 13               inc de
  43++6414 23             inc hl
  44++6415 10 F1            djnz .compare
  45++6417 3E 01            ld a, 1
  46++6419 C9               ret
  47++641A
  48++641A              clear:
  49++641A AF               xor a
  49++641B 21 28 64       ld hl, buffer
  49++641E 11 29 64       ld de, buffer + 1
  49++6421 01 20 00       ld bc, 32
  49++6424 77             ld (hl), a
  49++6425 ED B0          ldir
  50++6427 C9               ret
  51++6428
  52++6428 00 00 00...  buffer ds 32
  53++6448
  54++6448                  endmodule
# file closed: utils/strutils.asm
   4++6448                  IFDEF MSX
   5++6448 ~            	    include "bios.asm"
   6++6448                  ENDIF
   7++6448                  include "screen.asm"
# file opened: utils/screen.asm
   1++6448              LINE_LIMIT = 63
   2++6448
   3++6448                  IFDEF NEDOOS
   4++6448 ~            LINE_LIMIT = 79
   5++6448                  ENDIF
   6++6448
   7++6448                  IFDEF TIMEX80
   8++6448 ~            LINE_LIMIT = 84
   9++6448                  ENDIF
  10++6448
  11++6448                  IFDEF MSX
  12++6448 ~            LINE_LIMIT = 79
  13++6448                  ENDIF
  14++6448              ; HL - string pointer
  15++6448              print70Text:
  16++6448 06 3F            ld b, LINE_LIMIT
  17++644A              .loop
  18++644A 7E               ld a, (hl)
  19++644B A7               and a
  19++644C C8             ret z
  20++644D FE 0D            cp 13
  20++644F C8             ret z
  21++6450 FE 0A            cp 10
  21++6452 C8             ret z
  22++6453 C5               push bc
  23++6454 E5               push hl
  24++6455 CD A4 60         call TextMode.putC
  25++6458 E1               pop hl
  26++6459 23               inc hl
  27++645A C1               pop bc
  28++645B 05               dec b
  29++645C 78               ld a, b
  29++645D A7             and a
  29++645E C8             ret z
  30++645F C3 4A 64         jp .loop
  31++6462
  32++6462              ; HL - string pointer
  33++6462              print70Goph:
  34++6462 06 3F            ld b, LINE_LIMIT
  35++6464              .loop
  36++6464 7E               ld a, (hl)
  36++6465 FE 09          cp 09
  36++6467 C8             ret z
  37++6468 A7               and a
  37++6469 C8             ret z
  38++646A C5               push bc
  39++646B E5               push hl
  40++646C CD A4 60         call TextMode.putC
  41++646F E1               pop hl
  42++6470 23               inc hl
  43++6471 C1               pop bc
  44++6472 05               dec b
  45++6473 78               ld a, b
  45++6474 A7             and a
  45++6475 C8             ret z
  46++6476 C3 64 64         jp .loop
# file closed: utils/screen.asm
# file closed: utils/index.asm
  17+ 6479                  include "gopher/render/index.asm"
# file opened: gopher/render/index.asm
   1++6479                  MODULE Render
   2++6479              PER_PAGE = 22
   3++6479              CURSOR_OFFSET = 2
   4++6479                  include "row.asm"
# file opened: gopher/render/row.asm
   1++6479              ; A - row number
   2++6479              ; HL - pointer to row
   3++6479              renderRow:
   4++6479 C6 02            add CURSOR_OFFSET
   5++647B 57               ld d,a
   6++647C 1E 00            ld e,0
   7++647E CD 3A 60         call TextMode.gotoXY
   8++6481 7E               ld a,(hl)
   9++6482 E5               push hl
  10++6483 CD 8E 64         call getIcon
  11++6486 CD A4 60         call TextMode.putC
  12++6489 E1               pop hl
  13++648A 23               inc hl
  14++648B C3 62 64         jp print70Goph
  15++648E
  16++648E              ; A - gopher id char
  17++648E              getIcon:
  18++648E FE 69            cp 'i'
  18++6490 CA AF 64       jp z, .info
  19++6493 FE 39            cp '9'
  19++6495 CA B2 64       jp z, .down
  20++6498 FE 31            cp '1'
  20++649A CA 30 65       jp z, .page
  21++649D FE 30            cp '0'
  21++649F CA 33 65       jp z, .text
  22++64A2 FE 37            cp '7'
  22++64A4 CA 36 65       jp z, .input
  23++64A7 FE 73            cp 's'
  23++64A9 CA B2 64       jp z, .down
  24++64AC 3E 20            ld a, ' '
  25++64AE C9               ret
  26++64AF              .info
  27++64AF 3E 20            ld a, SPACE
  27++64B1 C9             ret
  28++64B2              .down
  29++64B2 54 5D            ld de, hl
  30++64B4 01 FF 00 3E      ld bc, #ff, a, TAB
  30++64B8 09
  30++64B9 ED B1          cpir
  31++64BB 78               ld a, b
  31++64BC B1             or c
  31++64BD 28 6E          jr z, .downExit
  32++64BF D5               push de
  33++64C0              .nameLoop
  34++64C0 7E               ld a, (hl)
  34++64C1 A7             and a
  34++64C2 28 10          jr z, .check
  35++64C4 FE 09            cp TAB
  35++64C6 28 0C          jr z, .check
  36++64C8 FE 0D            cp CR
  36++64CA 28 08          jr z, .check
  37++64CC E5               push hl
  38++64CD CD DD 63         call CompareBuff.push
  39++64D0 E1               pop hl
  40++64D1 23               inc hl
  41++64D2 18 EC            jr .nameLoop
  42++64D4              .check
  43++64D4 3A 72 65     	ld a,(saveTMode+1);���� ����� �������� ������, ����� �� ������� �� ������ Caps
  44++64D7 B7           	or a
  45++64D8 20 52        	jr nz,.checkExit
  46++64DA 21 45 65     	ld hl, scrExt1
  46++64DD CD F2 63       call CompareBuff.search
  46++64E0 A7             and a
  46++64E1 20 56          jr nz, .image
  47++64E3 21 4A 65         ld hl, scrExt2
  47++64E6 CD F2 63       call CompareBuff.search
  47++64E9 A7             and a
  47++64EA 20 4D          jr nz, .image
  48++64EC 3E 03            ld a, 3
  48++64EE 32 E4 93       ld (VTPL.SETUP), a ; 0 bit - looping, 1 bit - pt2 file
  49++64F1 21 59 65         ld hl, pt2Ext1
  49++64F4 CD F2 63       call CompareBuff.search
  49++64F7 A7             and a
  49++64F8 20 43          jr nz, .music
  50++64FA 21 5E 65         ld hl, pt2Ext2
  50++64FD CD F2 63       call CompareBuff.search
  50++6500 A7             and a
  50++6501 20 3A          jr nz, .music
  51++6503 3E 01            ld a, 1
  51++6505 32 E4 93       ld (VTPL.SETUP), a
  52++6508 21 4F 65         ld hl, pt3Ext1
  52++650B CD F2 63       call CompareBuff.search
  52++650E A7             and a
  52++650F 20 2C          jr nz, .music
  53++6511 21 54 65         ld hl, pt3Ext2
  53++6514 CD F2 63       call CompareBuff.search
  53++6517 A7             and a
  53++6518 20 23          jr nz, .music
  54++651A
  55++651A                  ; General Sound support
  56++651A                  ifdef GS
  57++651A 21 63 65         ld hl, modExt1
  57++651D CD F2 63       call CompareBuff.search
  57++6520 A7             and a
  57++6521 20 1E          jr nz, .mod
  58++6523 21 68 65         ld hl, modExt2
  58++6526 CD F2 63       call CompareBuff.search
  58++6529 A7             and a
  58++652A 20 15          jr nz, .mod
  59++652C                  endif
  60++652C
  61++652C              .checkExit
  62++652C E1               pop hl
  63++652D              .downExit
  64++652D 3E 01            ld a, MIME_DOWNLOAD
  64++652F C9             ret
  65++6530              .page
  66++6530 3E 02            ld a, MIME_LINK
  66++6532 C9             ret
  67++6533              .text
  68++6533 3E 03            ld a, MIME_TEXT
  68++6535 C9             ret
  69++6536              .input
  70++6536 3E 04            ld a, MIME_INPUT
  70++6538 C9             ret
  71++6539              .image
  72++6539 E1               pop hl
  72++653A 3E 06          ld a, MIME_IMAGE
  72++653C C9             ret
  73++653D              .music
  74++653D E1               pop hl
  74++653E 3E 05          ld a, MIME_MUSIC
  74++6540 C9             ret
  75++6541              .mod
  76++6541 E1               pop hl
  76++6542 3E 07          ld a, MIME_MOD
  76++6544 C9             ret
  77++6545
  78++6545 2E 73 63 72  scrExt1 db ".scr", 0
  78++6549 00
  79++654A 2E 53 43 52  scrExt2 db ".SCR", 0
  79++654E 00
  80++654F
  81++654F 2E 70 74 33  pt3Ext1 db ".pt3", 0
  81++6553 00
  82++6554 2E 50 54 33  pt3Ext2 db ".PT3", 0
  82++6558 00
  83++6559 2E 70 74 32  pt2Ext1 db ".pt2", 0
  83++655D 00
  84++655E 2E 50 54 32  pt2Ext2 db ".PT2", 0
  84++6562 00
  85++6563 2E 6D 6F 64  modExt1 db ".mod", 0
  85++6567 00
  86++6568 2E 4D 4F 44  modExt2 db ".MOD", 0
  86++656C 00
  87++656D
  88++656D              toggleSaveMode
  89++656D F5                       push af
  90++656E CD 77 6A     			call Console.waitForKeyUp
  91++6571 3E 00        saveTMode	ld a,0 ;Open/Save files
  92++6573 EE 01        			xor 1
  93++6575 32 72 65     			ld (saveTMode+1),a
  94++6578 00                       nop
  95++6579              printsavemode
  96++6579 11 00 01                 ld de, #0100
  97++657C CD 3A 60                 call TextMode.gotoXY
  98++657F 21 9D 65                 ld hl, playmodetext
  99++6582 3A 72 65                 ld a,(saveTMode+1)
 100++6585 B7                       or a
 101++6586 CA 8C 65                 jp z, playmodeselect
 102++6589 21 91 65                 ld hl, savemodetext
 103++658C              playmodeselect
 104++658C CD BC 60                 call TextMode.printZ
 105++658F F1           			pop af
 106++6590 C9           			ret
 107++6591
 108++6591              savemodetext
 109++6591 5B 53 61 76      db "[Save mode]",0
 109++6595 65 20 6D 6F
 109++6599 64 65 5D 00
 110++659D              playmodetext
 111++659D 5B 50 6C 61      db "[Play mode]",0
 111++65A1 79 20 6D 6F
 111++65A5 64 65 5D 00
# file closed: gopher/render/row.asm
   5++65A9                  include "buffer.asm"
# file opened: gopher/render/buffer.asm
   1++65A9              ; BC - line count
   2++65A9              findLine
   3++65A9 21 D0 9F         ld hl, outputBuffer
   4++65AC              findLine2
   5++65AC 78               ld a,b
   6++65AD B1               or c
   7++65AE CA DB 65         jp z, .checkEmpty
   8++65B1              .loop
   9++65B1 7E               ld a, (hl)
  10++65B2 A7               and a
  11++65B3 CA DE 65         jp z, .nope
  12++65B6 23               inc hl
  13++65B7 FE 0D            cp 13
  14++65B9 CA D1 65         jp z, .checkLF  ;13
  15++65BC FE 0A            cp 10
  15++65BE CA C4 65       jp z, .nextCheck     ;10
  16++65C1 C3 B1 65         jp .loop
  17++65C4              .nextCheck
  18++65C4 A7               and a
  19++65C5 CA DE 65         jp z, .nope
  20++65C8 0B               dec bc
  21++65C9 57               ld d,a
  22++65CA 78               ld a,b
  23++65CB B1               or c
  24++65CC 7A               ld a,d
  25++65CD C2 B1 65         jp nz, .loop
  26++65D0 C9               ret
  27++65D1              .checkLF
  28++65D1 7E               ld a, (hl)
  29++65D2 FE 0A            cp 10
  30++65D4 C2 C4 65         jp nz, .nextCheck    ;10
  31++65D7 23               inc hl
  32++65D8 C3 C4 65         jp  .nextCheck
  33++65DB              .checkEmpty
  34++65DB 7E               ld a, (hl)
  34++65DC A7             and a
  34++65DD C0             ret nz
  35++65DE              .nope
  36++65DE 21 00 00         ld hl, 0
  36++65E1 C9             ret
  37++65E2
# file closed: gopher/render/buffer.asm
   6++65E2                  include "ui.asm"
# file opened: gopher/render/ui.asm
   1++65E2                  IFDEF ZXSCR
   2++65E2                      DEFINE LEFT_TAB "[D]omain:                                  "
   3++65E2                      DEFINE SCREEN_WIDTH 64
   4++65E2                      DEFINE SCREEN64
   5++65E2                  ENDIF
   6++65E2
   7++65E2                  IFDEF TIMEX     ;UNKNOWN fallback to 64
   8++65E2 ~                    DEFINE LEFT_TAB "[D]omain:                                  "
   9++65E2 ~                    DEFINE SCREEN_WIDTH 64
  10++65E2 ~                    DEFINE SCREEN64
  11++65E2                  ENDIF
  12++65E2
  13++65E2                  IFDEF TIMEX80
  14++65E2 ~                    DEFINE LEFT_TAB "[D]omain:                                                      "
  15++65E2 ~                    DEFINE SCREEN_WIDTH 85
  16++65E2 ~                    DEFINE SCREEN85
  17++65E2                  ENDIF
  18++65E2
  19++65E2                  IFDEF NEDOOS
  20++65E2 ~                    DEFINE LEFT_TAB "[D]omain:                                                  "
  21++65E2 ~                    DEFINE SCREEN_WIDTH 80
  22++65E2 ~                    DEFINE SCREEN80
  23++65E2                  ENDIF
  24++65E2
  25++65E2                  IFDEF MSX
  26++65E2 ~                    DEFINE LEFT_TAB "[D]omain:                                              "
  27++65E2 ~                    DEFINE SCREEN_WIDTH 80
  28++65E2 ~                    DEFINE SCREEN80
  29++65E2                  ENDIF
  30++65E2              prepareScreen:
  31++65E2 CD 1D 60         call TextMode.cls
  32++65E5 21 B8 66         ld hl, header
  32++65E8 CD BC 60       call TextMode.printZ
  33++65EB 11 0A 00         ld de, #000A
  33++65EE CD 3A 60       call TextMode.gotoXY
  34++65F1 21 8C 89         ld hl, hostName
  34++65F4 CD BC 60       call TextMode.printZ
  35++65F7 AF               xor a
  35++65F8 CD 7B 60       call TextMode.highlightLine
  36++65FB
  37++65FB CD 79 65         call printsavemode
  38++65FE C9               ret
  39++65FF
  40++65FF              inputHost:
  41++65FF CD 77 6A         	call Console.waitForKeyUp
  42++6602              .loop
  43++6602 11 0A 00         ld de, #000A
  43++6605 CD 3A 60       call TextMode.gotoXY
  43++6608 21 8C 89       ld hl, hostName
  43++660B CD BC 60       call TextMode.printZ
  44++660E 3E 04            ld a, MIME_INPUT
  44++6610 CD A4 60       call TextMode.putC
  45++6613 3E 20            ld a, ' '
  45++6615 CD A4 60       call TextMode.putC
  46++6618              .wait
  47++6618 CD 90 6A         call Console.getC
  48++661B 5F               ld e, a
  49++661C FE 0C            cp Console.BACKSPACE
  49++661E 28 17          jr z, .removeChar
  50++6620 FE 0D            cp CR
  50++6622 CA 45 66       jp z, inputNavigate
  51++6625 FE 20            cp 32
  51++6627 38 EF          jr c, .wait
  52++6629              .putC
  53++6629 AF               xor a
  53++662A 21 8C 89 01    ld hl, hostName, bc, 48
  53++662E 30 00
  53++6630 ED B1          cpir
  54++6632 77               ld (hl), a
  54++6633 2B             dec hl
  54++6634 73             ld (hl), e
  55++6635 18 CB            jr .loop
  56++6637              .removeChar
  57++6637 AF               xor a
  58++6638 21 8C 89 01      ld hl, hostName, bc, 48
  58++663C 30 00
  58++663E ED B1          cpir
  59++6640 2B               dec hl
  59++6641 2B             dec hl
  59++6642 77             ld (hl), a
  60++6643 18 BD            jr .loop
  61++6645
  62++6645              inputNavigate:
  63++6645 21 8C 89 11      ld hl, hostName, de, domain
  63++6649 78 66
  64++664B 7E               ld a,(hl)
  65++664C A7               and a
  66++664D CA 05 74         jp z, History.load
  67++6650              .loop
  68++6650 7E               ld a, (hl)
  68++6651 A7             and a
  68++6652 28 05          jr z, .complete
  69++6654 12               ld (de), a
  69++6655 23 13          inc hl, de
  70++6657 18 F7            jr .loop
  71++6659              .complete
  72++6659 3E 09            ld a, TAB
  72++665B 12             ld (de), a
  72++665C 13             inc de
  73++665D 3E 37            ld a, '7'
  73++665F 12             ld (de), a
  73++6660 13             inc de
  74++6661 3E 30            ld a, '0'
  74++6663 12             ld (de), a
  74++6664 13             inc de
  75++6665 3E 0D            ld a, CR
  75++6667 12             ld (de), a
  75++6668 13             inc de
  76++6669 3E 0A            ld a, LF
  76++666B 12             ld (de), a
  76++666C 13             inc de
  77++666D 21 73 66         ld hl, navRow
  77++6670 C3 5E 74       jp History.navigate
  78++6673
  79++6673 31 20 09 2F  navRow db "1 ", TAB, "/", TAB
  79++6677 09
  80++6678 6E 69 68 69  domain db "nihirash.net"
  80++667C 72 61 73 68
  80++6680 2E 6E 65 74
  81++6684 00 00 00...      ds 64 - ($ - domain)
  82++66B8
  83++66B8 5B 44 5D 6F  header db "[D]omain:                                  ", "MRF "
  83++66BC 6D 61 69 6E
  83++66C0 3A 20 20 20
  83++66C4 20 20 20 20
  83++66C8 20 20 20 20
  83++66CC 20 20 20 20
  83++66D0 20 20 20 20
  83++66D4 20 20 20 20
  83++66D8 20 20 20 20
  83++66DC 20 20 20 20
  83++66E0 20 20 20 4D
  83++66E4 52 46 20
  84++66E7 31 2E 37            db "1.7"
  85++66EA 2E                  db "."
  86++66EB 32 39               db "29"
  87++66ED              	IFDEF MSX
  88++66ED ~                   db "    [MSX UNAPI]"
  89++66ED              	ENDIF
  90++66ED
  91++66ED                  IFDEF MB03
  92++66ED ~                   db " [MB03+]"
  93++66ED                     ENDIF
  94++66ED
  95++66ED                  IFDEF UNO
  96++66ED ~                   db " [UNO UART]"
  97++66ED                  ENDIF
  98++66ED
  99++66ED                  IFDEF AY
 100++66ED ~                   db " [AYWiFi]"
 101++66ED              	ENDIF
 102++66ED
 103++66ED                  IFDEF ZW
 104++66ED ~                   db "  [ZXWiFi]"
 105++66ED                  ENDIF
 106++66ED
 107++66ED                   IFDEF UARTATM
 108++66ED ~                   db " [ATM UART]"
 109++66ED                  ENDIF
 110++66ED
 111++66ED                  IFDEF UARTEVO
 112++66ED ~                    db " [EVO UART]"
 113++66ED                  ENDIF
 114++66ED
 115++66ED                  IFDEF UNOUART
 116++66ED ~                    db " [UNO UART]"
 117++66ED                  ENDIF
 118++66ED
 119++66ED                  IFDEF NEDONET
 120++66ED ~            	    db "  [nedoNET]"
 121++66ED              	ENDIF
 122++66ED
 123++66ED                  IFDEF AY56
 124++66ED 20 5B 41 59  	    db " [AYWiFi56]"
 124++66F1 57 69 46 69
 124++66F5 35 36 5D
 125++66F8              	ENDIF
 126++66F8 0D 00                db 13, 0
# file closed: gopher/render/ui.asm
   7++66FA                  include "gopher-page.asm"
# file opened: gopher/render/gopher-page.asm
   1++66FA              renderGopherScreen:
   2++66FA 3E FF            ld a, 255
   3++66FC 32 B4 92         ld (oldminutes), a
   4++66FF CD E2 65         call Render.prepareScreen
   5++6702
   6++6702 2A 79 78         ld hl, (page_offset)        ; HL - offset to 0 Row on screen
   7++6705 44 4D            ld bc,hl                    ; BC - offset to C Row on screen
   8++6707 CD A9 65         call Render.findLine        ;BC - Search this line  HL - Return pointer to page with offset
   9++670A 7C               ld a, h
  10++670B B5               or l
  11++670C 28 21            jr z, .exit2
  12++670E 7B               ld a, e
  13++670F AF               xor a
  14++6710 E5               push hl
  15++6711 CD 79 64         call renderRow
  16++6714 E1               pop hl
  17++6715
  18++6715 06 15            ld b, PER_PAGE-1
  19++6717
  20++6717              .loop
  21++6717 C5               push bc
  22++6718 3E 16            ld a, PER_PAGE
  23++671A 90               sub b
  24++671B 5F               ld e,a
  25++671C
  26++671C 01 01 00         ld bc, 1
  27++671F
  28++671F CD AC 65         call Render.findLine2   ;BC - Search this line  HL - Return pointer to page with offset
  29++6722
  30++6722 7C               ld a, h
  31++6723 B5               or l
  32++6724 28 06            jr z, .exit
  33++6726 7B               ld a, e
  34++6727 E5               push hl
  35++6728 CD 79 64         call renderRow
  36++672B E1               pop hl
  37++672C              .exit
  38++672C C1               pop bc
  39++672D 10 E8            djnz .loop
  40++672F              .exit2
  41++672F CD 3E 68         call showCursor
  42++6732 C9               ret
  43++6733
  44++6733              checkBorder:
  45++6733 3A 77 78         ld a, (cursor_position)
  45++6736 FE FF          cp #ff
  45++6738 CA 62 68       jp z, pageUp
  46++673B 3A 77 78         ld a, (cursor_position)
  46++673E FE 16          cp PER_PAGE
  46++6740 CA 95 68       jp z, pageDn
  47++6743 CD 3E 68         call showCursor
  48++6746 C3 49 67         jp workLoop
  49++6749
  50++6749              workLoop:
  51++6749 3A 88 69         ld a, (play_next)
  51++674C A7             and a
  51++674D C2 EE 67       jp nz, navigate
  52++6750
  53++6750                  dup 4
  54++6750 76          >    halt
  54++6751 76          >    halt
  54++6752 76          >    halt
  54++6753 76          >    halt
  55++6754                  edup
  56++6754              .nothing
  57++6754
  58++6754 76               halt
  59++6755 CD B3 92         call printRTC
  60++6758
  61++6758 CD A1 6A         call Console.peekC
  62++675B A7               and a
  62++675C CA 54 67       jp z, .nothing
  63++675F
  64++675F FE 31            cp '1'
  64++6761 CA EE 73       jp z, History.back
  65++6764 FE 32            cp '2'
  65++6766 CA EE 67       jp z, navigate
  66++6769 FE 33            cp '3'
  66++676B CA 4E 68       jp z, cursorDown
  67++676E FE 34            cp '4'
  67++6770 CA 58 68       jp z, cursorUp
  68++6773 FE 35            cp '5'
  68++6775 CA 62 68       jp z, pageUp
  69++6778 FE 38            cp '8'
  69++677A CA 95 68       jp z, pageDn
  70++677D FE 36            cp '6'
  70++677F CA 4E 68       jp z, cursorDown
  71++6782 FE 37            cp '7'
  71++6784 CA 58 68       jp z, cursorUp
  72++6787
  73++6787 FE 0A            cp Console.KEY_DN
  73++6789 CA 4E 68       jp z, cursorDown
  74++678C FE 61            cp 'a'
  74++678E CA 4E 68       jp z, cursorDown
  75++6791 FE 0B            cp Console.KEY_UP
  75++6793 CA 58 68       jp z, cursorUp
  76++6796 FE 71            cp 'q'
  76++6798 CA 58 68       jp z, cursorUp
  77++679B FE 08            cp Console.KEY_LT
  77++679D CA 62 68       jp z, pageUp
  78++67A0 FE 6F            cp 'o'
  78++67A2 CA 62 68       jp z, pageUp
  79++67A5 FE 09            cp Console.KEY_RT
  79++67A7 CA 95 68       jp z, pageDn
  80++67AA FE 70            cp 'p'
  80++67AC CA 95 68       jp z, pageDn
  81++67AF
  82++67AF FE 68            cp 'h'
  82++67B1 CA 5B 74       jp z, History.home
  83++67B4 FE 48            cp 'H'
  83++67B6 CA 5B 74       jp z, History.home
  84++67B9
  85++67B9 FE 62            cp 'b'
  85++67BB CA EE 73       jp z, History.back
  86++67BE FE 42            cp 'B'
  86++67C0 CA EE 73       jp z, History.back
  87++67C3 FE 0C            cp Console.BACKSPACE
  87++67C5 CA EE 73       jp z, History.back
  88++67C8
  89++67C8 FE 64            cp 'd'
  89++67CA CA FF 65       jp z, inputHost
  90++67CD FE 44            cp 'D'
  90++67CF CA FF 65       jp z, inputHost
  91++67D2
  92++67D2 FE 0D            cp CR
  92++67D4 CA EE 67       jp z, navigate
  93++67D7
  94++67D7 FE 53            cp 'S'
  94++67D9 CC 6D 65       call z, toggleSaveMode
  95++67DC FE 73        	cp 's'
  95++67DE CC 6D 65       call z, toggleSaveMode
  96++67E1
  97++67E1
  98++67E1                  IFDEF MSX
  99++67E1 ~                	cp ESC
  99++67E1 ~              jp z, exit
 100++67E1                  ENDIF
 101++67E1
 102++67E1                  IFDEF GS
 103++67E1 FE 4D            cp 'M'
 103++67E3 CC A7 92       call z, GeneralSound.toggleModule
 104++67E6 FE 6D            cp 'm'
 104++67E8 CC A7 92       call z, GeneralSound.toggleModule
 105++67EB                  ENDIF
 106++67EB
 107++67EB                  IFDEF TIMEX80
 108++67EB ~                cp 'T'
 108++67EB ~              call z, TextMode.toggleColor
 109++67EB ~                cp 't'
 109++67EB ~              call z, TextMode.toggleColor
 110++67EB                  ENDIF
 111++67EB
 112++67EB C3 49 67         jp workLoop
 113++67EE
 114++67EE              navigate:
 115++67EE CD 77 6A         call Console.waitForKeyUp
 116++67F1 AF               xor a
 116++67F2 32 88 69       ld (play_next), a
 117++67F5 CD 46 68         call hideCursor
 118++67F8 ED 4B 79 78      ld bc, (page_offset)
 119++67FC 2A 77 78         ld hl, (cursor_position)
 120++67FF 09               add hl,bc
 121++6800 44               ld b, h ;HHHHH
 122++6801 4D               ld c, l ;LLLLL
 123++6802 D5               push de
 124++6803 CD A9 65         call Render.findLine
 125++6806 D1               pop de
 126++6807 7E               ld a, (hl)
 127++6808 FE 31            cp '1'
 127++680A CA 27 68       jp z, .load
 128++680D FE 30            cp '0'
 128++680F CA 27 68       jp z, .load
 129++6812 FE 39            cp '9'
 129++6814 CA 27 68       jp z, .load
 130++6817 FE 37            cp '7'
 130++6819 CA 2F 68       jp z, .input
 131++681C FE 73            cp MIME_SOUND
 131++681E CA 27 68       jp z, .load
 132++6821 CD 3E 68         call showCursor
 133++6824 C3 49 67         jp workLoop
 134++6827              .load
 135++6827 E5               push hl
 136++6828 CD 8E 64         call getIcon
 137++682B E1               pop hl
 138++682C C3 5E 74         jp History.navigate
 139++682F              .input
 140++682F E5               push hl
 141++6830 CD 89 69         call DialogBox.inputBox
 142++6833 E1               pop hl
 143++6834 3A EE 69         ld a, (DialogBox.inputBuffer)
 143++6837 A7             and a
 143++6838 CA 05 74       jp z, History.load
 144++683B C3 27 68         jp .load
 145++683E
 146++683E              showCursor:
 147++683E 3A 77 78         ld a, (cursor_position)
 147++6841 C6 02          add CURSOR_OFFSET
 148++6843 C3 7B 60         jp TextMode.highlightLine
 149++6846
 150++6846              hideCursor:
 151++6846 3A 77 78         ld a, (cursor_position)
 151++6849 C6 02          add CURSOR_OFFSET
 152++684B C3 61 60         jp TextMode.usualLine
 153++684E
 154++684E              cursorDown:
 155++684E CD 46 68         call hideCursor
 156++6851 21 77 78         ld hl, cursor_position
 157++6854 34               inc (hl)
 158++6855 C3 33 67         jp checkBorder
 159++6858
 160++6858              cursorUp:
 161++6858 CD 46 68         call hideCursor
 162++685B 21 77 78         ld hl, cursor_position
 163++685E 35               dec (hl)
 164++685F C3 33 67         jp checkBorder
 165++6862
 166++6862              pageUp:
 167++6862 3A 79 78         ld a, (page_offset)
 167++6865 FE 00          cp 0
 167++6867 C2 75 68       jp nz, .pageUp2
 168++686A 3A 7A 78         ld a, (page_offset + 1)
 168++686D FE 00          cp 0
 168++686F C2 75 68       jp nz, .pageUp2
 169++6872 C3 8B 68         jp .skip
 170++6875              .pageUp2:
 171++6875 3E 15            ld a, PER_PAGE - 1
 171++6877 32 77 78       ld (cursor_position), a
 172++687A 2A 79 78         ld hl, (page_offset)
 173++687D 11 16 00         ld de,PER_PAGE
 174++6880 ED 52            sbc hl,de
 175++6882 22 79 78         ld (page_offset), hl
 176++6885              .exit
 177++6885 CD FA 66         call renderGopherScreen
 178++6888 C3 49 67         jp workLoop
 179++688B              .skip
 180++688B AF               xor a
 180++688C 32 77 78       ld (cursor_position), a
 180++688F CD FA 66       call renderGopherScreen
 180++6892 C3 49 67       jp workLoop
 181++6895
 182++6895              pageDn:
 183++6895 AF                xor a
 183++6896 32 77 78       ld (cursor_position), a
 184++6899 2A 79 78         ld hl,(page_offset)
 185++689C 11 16 00         ld de,PER_PAGE
 186++689F 19               add hl,de
 187++68A0 22 79 78         ld (page_offset), hl
 188++68A3 C3 85 68         jp pageUp.exit
 189++68A6
# file closed: gopher/render/gopher-page.asm
   8++68A6                  include "plaintext.asm"
# file opened: gopher/render/plaintext.asm
   1++68A6              renderPlainTextScreen:
   2++68A6 3E FF            ld a, 255
   3++68A8 32 B4 92         ld (oldminutes), a
   4++68AB CD E2 65         call prepareScreen
   5++68AE
   6++68AE 2A 79 78         ld hl, (page_offset)        ; HL - offset to 0 Row on screen
   7++68B1 44 4D            ld bc,hl                    ; BC - offset to C Row on screen
   8++68B3 CD A9 65         call Render.findLine        ;BC - Search this line  HL - Return pointer to page with offset
   9++68B6 7C               ld a, h
  10++68B7 B5               or l
  11++68B8 28 30            jr z, .exit2
  12++68BA AF               xor a
  13++68BB C6 02            add CURSOR_OFFSET
  13++68BD 57 1E 01       ld d, a, e, 1
  13++68C0 CD 3A 60       call TextMode.gotoXY
  14++68C3 CD 48 64         call print70Text
  15++68C6 06 15            ld b, PER_PAGE -1
  16++68C8              .loop
  17++68C8 C5               push bc
  18++68C9 3E 16            ld a, PER_PAGE
  19++68CB 90               sub b
  20++68CC 5F               ld e,a
  21++68CD 01 01 00         ld bc, 1
  22++68D0 CD AC 65         call Render.findLine2   ;BC - Search this line  HL - Return pointer to page with offset
  23++68D3 7C               ld a, h
  24++68D4 B5               or l
  25++68D5 28 10            jr z, .exit
  26++68D7 7B               ld a, e
  27++68D8 C6 02            add CURSOR_OFFSET
  27++68DA 57 1E 01       ld d, a, e, 1
  27++68DD CD 3A 60       call TextMode.gotoXY
  28++68E0 CD 48 64         call print70Text
  29++68E3 C1               pop bc
  30++68E4 10 E2            djnz .loop
  31++68E6 C9               ret
  32++68E7              .exit
  33++68E7 C1               pop bc
  34++68E8 10 DE            djnz .loop
  35++68EA              .exit2
  36++68EA CD 3E 68         call showCursor
  37++68ED C9               ret
  38++68EE              plainTextLoop:
  39++68EE CD B3 92         call printRTC
  40++68F1 CD 90 6A         call Console.getC
  41++68F4
  42++68F4 FE 31            cp '1'
  42++68F6 CA EE 73       jp z, History.back
  43++68F9 FE 32            cp '2'
  43++68FB CA EE 67       jp z, navigate
  44++68FE FE 35            cp '5'
  44++6900 CA 66 69       jp z, textUp
  45++6903 FE 38            cp '8'
  45++6905 CA 56 69       jp z, textDown
  46++6908 FE 08            cp Console.KEY_LT
  46++690A CA 66 69       jp z, textUp
  47++690D FE 09            cp Console.KEY_RT
  47++690F CA 56 69       jp z, textDown
  48++6912
  49++6912 FE 0A            cp Console.KEY_DN
  49++6914 CA 56 69       jp z, textDown
  50++6917 FE 61            cp 'a'
  50++6919 CA 56 69       jp z, textDown
  51++691C
  52++691C FE 0B            cp Console.KEY_UP
  52++691E CA 66 69       jp z, textUp
  53++6921 FE 71            cp 'q'
  53++6923 CA 66 69       jp z, textUp
  54++6926
  55++6926 FE 68            cp 'h'
  55++6928 CA 5B 74       jp z, History.home
  56++692B FE 48            cp 'H'
  56++692D CA 5B 74       jp z, History.home
  57++6930
  58++6930 FE 62            cp 'b'
  58++6932 CA EE 73       jp z, History.back
  59++6935 FE 42            cp 'B'
  59++6937 CA EE 73       jp z, History.back
  60++693A
  61++693A FE 64            cp 'd'
  61++693C CA FF 65       jp z, inputHost
  62++693F FE 44            cp 'D'
  62++6941 CA FF 65       jp z, inputHost
  63++6944
  64++6944 FE 0C            cp Console.BACKSPACE
  64++6946 CA EE 73       jp z, History.back
  65++6949
  66++6949                  IFDEF MSX
  67++6949 ~                	cp ESC
  67++6949 ~              jp z, exit
  68++6949                  ENDIF
  69++6949
  70++6949                  IFDEF GS
  71++6949 FE 4D            cp 'M'
  71++694B CC A7 92       call z, GeneralSound.toggleModule
  72++694E FE 6D            cp 'm'
  72++6950 CC A7 92       call z, GeneralSound.toggleModule
  73++6953                  ENDIF
  74++6953
  75++6953                  IFDEF TIMEX80
  76++6953 ~                cp 'T'
  76++6953 ~              call z, TextMode.toggleColor
  77++6953 ~                cp 't'
  77++6953 ~              call z, TextMode.toggleColor
  78++6953                  ENDIF
  79++6953
  80++6953 C3 EE 68         jp plainTextLoop
  81++6956
  82++6956
  83++6956              textDown:
  84++6956 2A 79 78         ld hl,(page_offset)
  85++6959 11 16 00         ld de,PER_PAGE
  86++695C 19               add hl,de
  87++695D 22 79 78         ld (page_offset), hl
  88++6960 CD A6 68         call renderPlainTextScreen
  89++6963 C3 EE 68         jp plainTextLoop
  90++6966
  91++6966              textUp:
  92++6966 3A 79 78         ld a, (page_offset)
  92++6969 FE 00          cp 0
  92++696B 20 0A          jr nz, .textUp2
  93++696D 3A 7A 78         ld a, (page_offset + 1)
  93++6970 FE 00          cp 0
  93++6972 20 03          jr nz, .textUp2
  94++6974 C3 EE 68         jp plainTextLoop
  95++6977
  96++6977              .textUp2:
  97++6977 2A 79 78         ld hl,(page_offset)
  98++697A 11 16 00         ld de,PER_PAGE
  99++697D ED 52            sbc hl,de
 100++697F 22 79 78         ld (page_offset), hl
 101++6982 CD A6 68         call renderPlainTextScreen
 102++6985 C3 EE 68         jp plainTextLoop
 103++6988
# file closed: gopher/render/plaintext.asm
   9++6988
  10++6988 00           play_next       db  0
  11++6989              position        EQU historyBlock.position
  12++6989              cursor_position EQU position + 2
  13++6989              page_offset     EQU position + 4
  14++6989
  15++6989                  ENDMODULE
  16++6989
  17++6989                  include "dialogbox.asm"
# file opened: gopher/render/dialogbox.asm
   1++6989                  module DialogBox
   2++6989
   3++6989              inputBox:
   4++6989 AF               xor a
   4++698A 32 EE 69       ld (inputBuffer), a
   5++698D              .noclear
   6++698D CD 4F 6A         call drawBox
   7++6990              .loop
   8++6990 11 05 0B         ld de, #0B05
   8++6993 CD 3A 60       call TextMode.gotoXY
   9++6996 21 EE 69         ld hl, inputBuffer
   9++6999 CD BC 60       call TextMode.printZ
  10++699C 3E 04            ld a, MIME_INPUT
  10++699E CD A4 60       call TextMode.putC
  10++69A1 3E 20          ld a, ' '
  10++69A3 CD A4 60       call TextMode.putC
  11++69A6              .checkkey
  12++69A6 CD A1 6A         call Console.peekC
  13++69A9 FE 00            cp 00
  13++69AB CA A6 69        jp z, .checkkey
  14++69AE FE 0D            cp CR
  14++69B0 C8             ret z
  15++69B1
  16++69B1                  IFNDEF MSX
  17++69B1                  dup 11
  18++69B1 76          >    halt
  18++69B2 76          >    halt
  18++69B3 76          >    halt
  18++69B4 76          >    halt
  18++69B5 76          >    halt
  18++69B6 76          >    halt
  18++69B7 76          >    halt
  18++69B8 76          >    halt
  18++69B9 76          >    halt
  18++69BA 76          >    halt
  18++69BB 76          >    halt
  19++69BC                  edup
  20++69BC                  ENDIF
  21++69BC
  22++69BC FE 0C            cp Console.BACKSPACE
  22++69BE 28 13          jr z, .removeChar
  23++69C0 FE 20            cp SPACE
  23++69C2 38 E2          jr c, .checkkey
  24++69C4              .putC
  25++69C4 5F               ld e, a
  26++69C5 AF               xor a
  26++69C6 21 EE 69 01    ld hl, inputBuffer, bc, #ff
  26++69CA FF 00
  26++69CC ED B1          cpir
  27++69CE 77               ld (hl), a
  27++69CF 2B             dec hl
  27++69D0 73             ld (hl), e
  28++69D1 18 BD            jr .loop
  29++69D3              .removeChar
  30++69D3 AF               xor a
  31++69D4 21 EE 69 01      ld hl, inputBuffer, bc, #ff
  31++69D8 FF 00
  31++69DA ED B1          cpir
  32++69DC E5               push hl
  33++69DD 11 EF 69             ld de, inputBuffer + 1
  34++69E0 B7                   or a
  34++69E1 ED 52          sbc hl, de
  35++69E3 7C                   ld a, h
  35++69E4 B5             or l
  36++69E5 E1               pop hl
  37++69E6 28 A8            jr z, .loop
  38++69E8 AF               xor a
  39++69E9 2B               dec hl
  39++69EA 2B             dec hl
  39++69EB 77             ld (hl), a
  40++69EC 18 A2            jr .loop
  41++69EE
  42++69EE
  43++69EE              namedownload
  44++69EE                  IFDEF NEDOOS
  45++69EE ~            		db "..",92,"downloads",92
  46++69EE                  ENDIF
  47++69EE
  48++69EE 00 00 00...  inputBuffer ds 80
  49++6A3E
  50++6A3E              msgBox:
  51++6A3E CD 47 6A         call msgNoWait
  52++6A41 06 96            ld b, 150
  53++6A43              .loop
  54++6A43 76               halt
  55++6A44 10 FD            djnz .loop
  56++6A46 C9               ret
  57++6A47
  58++6A47              msgNoWait:
  59++6A47 E5               push hl
  60++6A48 CD 4F 6A         call drawBox
  61++6A4B E1               pop hl
  62++6A4C C3 BC 60         jp TextMode.printZ
  63++6A4F
  64++6A4F              drawBox:
  65++6A4F 26 0A 3E 09      ld h, #0a, a, BORDER_TOP
  66++6A53 CD 47 60         call TextMode.fillLine
  67++6A56 26 0B 3E 20      ld h, #0b, a, ' '
  68++6A5A CD 47 60         call TextMode.fillLine
  69++6A5D 26 0C 3E 08      ld h, #0c, a, BORDER_BOTTOM
  70++6A61 CD 47 60         call TextMode.fillLine
  71++6A64 3E 0A            ld a, #0a
  72++6A66 CD 7B 60         call TextMode.highlightLine
  73++6A69 3E 0C            ld a, #0c
  74++6A6B CD 7B 60         call TextMode.highlightLine
  75++6A6E 11 03 0B         ld de,#0B03
  76++6A71 CD 3A 60         call TextMode.gotoXY
  77++6A74 C9               ret
  78++6A75                  endmodule
  79++6A75
# file closed: gopher/render/dialogbox.asm
# file closed: gopher/render/index.asm
  18+ 6A75                  include "dos/index.asm"
# file opened: dos/index.asm
   1++6A75              	IFDEF NEDOOS
   2++6A75 ~            	    include "nedoconsole.asm"
   3++6A75 ~            		include "nedoos.asm"
   4++6A75              	ENDIF
   5++6A75
   6++6A75              	IFDEF TRDOS
   7++6A75                  	include "console.asm"
# file opened: dos/console.asm
   1++6A75                  module Console
   2++6A75              KEY_UP = 11
   3++6A75              KEY_DN = 10
   4++6A75              KEY_LT = 8
   5++6A75              KEY_RT = 9
   6++6A75              BACKSPACE = 12
   7++6A75              BASIC_KEY = #5C08
   8++6A75 00           keyCode db 0
   9++6A76 00           tableShift db 0
  10++6A77
  11++6A77              waitForKeyUp:
  12++6A77 76           	halt
  13++6A78 AF              xor a
  13++6A79 DB FE          in a, (#fe)
  13++6A7B 2F             cpl
  13++6A7C E6 1F          and 31
  13++6A7E 20 F7          jr nz, waitForKeyUp
  14++6A80 32 08 5C        ld (BASIC_KEY), a
  15++6A83 C9              ret
  16++6A84
  17++6A84              keyWait:
  18++6A84                  dup 11
  19++6A84 76          >    halt
  19++6A85 76          >    halt
  19++6A86 76          >    halt
  19++6A87 76          >    halt
  19++6A88 76          >    halt
  19++6A89 76          >    halt
  19++6A8A 76          >    halt
  19++6A8B 76          >    halt
  19++6A8C 76          >    halt
  19++6A8D 76          >    halt
  19++6A8E 76          >    halt
  20++6A8F                  edup
  21++6A8F C9              ret
  22++6A90
  23++6A90              getC:
  24++6A90              getCint:       ; for nedoOS
  25++6A90 AF              xor a
  26++6A91 32 08 5C        ld (BASIC_KEY),a
  27++6A94              getC2:
  28++6A94 3A 08 5C        ld a,(BASIC_KEY)
  29++6A97 A7              and a
  29++6A98 28 FA          jr z, getC2
  30++6A9A 47              ld b,a
  31++6A9B AF              xor a
  31++6A9C 32 08 5C       ld (BASIC_KEY), a
  32++6A9F 78              ld a, b
  33++6AA0 C9              ret
  34++6AA1              ;0xE - to Russian
  35++6AA1              ;0xF - to Englich
  36++6AA1              peekC:
  37++6AA1 AF               xor a
  37++6AA2 32 08 5C       ld (BASIC_KEY),a
  38++6AA5 CD C5 6A         call inkey
  39++6AA8 FE 0E            cp 0xE
  40++6AAA CA B3 6A         jp z, toRus
  41++6AAD FE 0F            cp 0xF
  42++6AAF CA BD 6A         jp z, toEng
  43++6AB2 C9               ret
  44++6AB3              toRus
  45++6AB3 3E A0           ld a, russiantable - englishTable
  46++6AB5 32 76 6A        ld (tableShift), a
  47++6AB8 AF              xor a
  48++6AB9 CD 84 6A        call keyWait
  49++6ABC C9              ret
  50++6ABD              toEng
  51++6ABD AF              xor a
  52++6ABE 32 76 6A        ld (tableShift), a
  53++6AC1 CD 84 6A        call keyWait
  54++6AC4 C9              ret
  55++6AC5
  56++6AC5              inkey:
  57++6AC5 11 00 00        ld de,0
  58++6AC8 01 FE FE        ld bc,$fefe
  59++6ACB ED 78           in a,(c)
  60++6ACD F6 E1           or $e1
  61++6ACF FE FF           cp $ff
  62++6AD1 20 57           jr nz, .keyhitA
  63++6AD3
  64++6AD3 1E 05           ld e,5
  65++6AD5 06 FD           ld b,$fd
  66++6AD7 ED 78           in a,(c)
  67++6AD9 F6 E0           or $e0
  68++6ADB FE FF           cp $ff
  69++6ADD 20 4B           jr nz, .keyhitA
  70++6ADF
  71++6ADF 1E 0A           ld e,10
  72++6AE1 06 FB           ld b,$fb
  73++6AE3 ED 78           in a,(c)
  74++6AE5 F6 E0           or $e0
  75++6AE7 FE FF           cp $ff
  76++6AE9 20 3F           jr nz, .keyhitA
  77++6AEB
  78++6AEB 1E 0F           ld e,15
  79++6AED 06 F7           ld b,$f7
  80++6AEF ED 78           in a,(c)
  81++6AF1 F6 E0           or $e0
  82++6AF3 FE FF           cp $ff
  83++6AF5 20 33           jr nz, .keyhitA
  84++6AF7
  85++6AF7 1E 14           ld e,20
  86++6AF9 06 EF           ld b,$ef
  87++6AFB ED 78           in a,(c)
  88++6AFD F6 E0           or $e0
  89++6AFF FE FF           cp $ff
  90++6B01 20 27           jr nz, .keyhitA
  91++6B03
  92++6B03 1E 19           ld e,25
  93++6B05 06 DF           ld b,$df
  94++6B07 ED 78           in a,(c)
  95++6B09 F6 E0           or $e0
  96++6B0B FE FF           cp $ff
  97++6B0D 20 1B           jr nz, .keyhitA
  98++6B0F
  99++6B0F 1E 1E           ld e,30
 100++6B11 06 BF           ld b,$bf
 101++6B13 ED 78           in a,(c)
 102++6B15 F6 E0           or $e0
 103++6B17 FE FF           cp $ff
 104++6B19 20 0F           jr nz, .keyhitA
 105++6B1B
 106++6B1B 1E 23           ld e,35
 107++6B1D 06 7F           ld b,$7f
 108++6B1F ED 78           in a,(c)
 109++6B21 F6 E2           or $e2
 110++6B23 FE FF           cp $ff
 111++6B25 4F              ld c,a
 112++6B26 20 19           jr nz, .keyhitB
 113++6B28
 114++6B28              .nokey
 115++6B28 AF              xor a
 116++6B29 C9              ret
 117++6B2A
 118++6B2A              .keyhitA
 119++6B2A
 120++6B2A 4F              ld c,a
 121++6B2B
 122++6B2B 78              ld a,b
 123++6B2C 2F              cpl
 124++6B2D F6 81           or $81
 125++6B2F DB FE           in a,($fe)
 126++6B31 F6 E0           or $e0
 127++6B33 FE FF           cp $ff
 128++6B35 20 F1           jr nz, .nokey
 129++6B37
 130++6B37 3E 7F           ld a,$7f
 131++6B39 DB FE           in a,($fe)
 132++6B3B F6 E2           or $e2
 133++6B3D FE FF           cp $ff
 134++6B3F 20 E7           jr nz, .nokey
 135++6B41
 136++6B41              .keyhitB
 137++6B41
 138++6B41 06 00           ld b,0
 139++6B43 21 8F 6A        ld hl,.rowtbl-$e0
 140++6B46 09              add hl,bc
 141++6B47 7E              ld a,(hl)
 142++6B48 FE 05           cp 5
 143++6B4A 30 DC           jr nc, .nokey
 144++6B4C 83              add a,e
 145++6B4D 5F              ld e,a
 146++6B4E
 147++6B4E 21 8F 6B        ld  hl, englishTable
 148++6B51 19              add hl, de
 149++6B52 3A 76 6A        ld  a, (tableShift)
 150++6B55 5F              ld e, a
 151++6B56 19              add hl, de
 152++6B57 3E FE           ld a,$fe
 153++6B59 DB FE           in a,($fe)
 154++6B5B E6 01           and $01
 155++6B5D 20 03           jr nz, .nocaps
 156++6B5F 1E 28           ld e,40
 157++6B61 19              add hl,de
 158++6B62
 159++6B62              .nocaps
 160++6B62
 161++6B62 3E 7F           ld a,$7f
 162++6B64 DB FE           in a,($fe)
 163++6B66 E6 02           and $02
 164++6B68 20 03           jr nz, .nosym
 165++6B6A 1E 50           ld e,80
 166++6B6C 19              add hl,de
 167++6B6D
 168++6B6D              .nosym
 169++6B6D
 170++6B6D 7E              ld a,(hl)
 171++6B6E C9              ret
 172++6B6F
 173++6B6F              .rowtbl
 174++6B6F FF FF FF FF     defb 255,255,255,255,255,255,255
 174++6B73 FF FF FF
 175++6B76 FF FF FF FF     defb 255,255,255,255,255,255,255,255
 175++6B7A FF FF FF FF
 176++6B7E 04 FF FF FF     defb 4,255,255,255,255,255,255
 176++6B82 FF FF FF
 177++6B85 FF 03 FF FF     defb 255,3,255,255,255,2,255,1
 177++6B89 FF 02 FF 01
 178++6B8D 00 FF           defb 0,255
 179++6B8F
 180++6B8F              englishTable
 181++6B8F 00 7A 78 63     db 0,'z','x','c','v'      ; CAPS SHIFT, Z, X, C, V
 181++6B93 76
 182++6B94 61 73 64 66     db 'a','s','d','f','g'      ; A, S, D, F, G
 182++6B98 67
 183++6B99 71 77 65 72     db 'q','w','e','r','t'      ; Q, W, E, R, T
 183++6B9D 74
 184++6B9E 31 32 33 34     db '1','2','3','4','5'      ; 1, 2, 3, 4, 5
 184++6BA2 35
 185++6BA3 30 39 38 37     db '0','9','8','7','6'      ; 0, 9, 8, 7, 6
 185++6BA7 36
 186++6BA8 70 6F 69 75     db 'p','o','i','u','y'      ; P, O, I, U, Y
 186++6BAC 79
 187++6BAD 0D 6C 6B 6A     db 13,'l','k','j','h'       ; ENTER, L, K, J, H
 187++6BB1 68
 188++6BB2 20 00 6D 6E     db ' ',0,'m','n','b'      ; SPACE, SYM SHIFT, M, N, B
 188++6BB6 62
 189++6BB7
 190++6BB7                 ; the following are CAPS SHIFTed
 191++6BB7
 192++6BB7 00 5A 58 43     db 0,'Z','X','C','V'      ; CAPS SHIFT, Z, X, C, V
 192++6BBB 56
 193++6BBC 41 53 44 46     db 'A','S','D','F','G'      ; A, S, D, F, G
 193++6BC0 47
 194++6BC1 51 57 45 52     db 'Q','W','E','R','T'      ; Q, W, E, R, T
 194++6BC5 54
 195++6BC6 0E 06 80 81     db 14,6,128,129,8           ; 1, 2, 3, 4, 5
 195++6BCA 08
 196++6BCB 0C 00 09 0B     db 12,0,9,11,10             ; 0, 9, 8, 7, 6
 196++6BCF 0A
 197++6BD0 50 4F 49 55     db 'P','O','I','U','Y'      ; P, O, I, U, Y
 197++6BD4 59
 198++6BD5 0D 4C 4B 4A     db 13,'L','K','J','H'       ; ENTER, L, K, J, H
 198++6BD9 48
 199++6BDA 20 00 4D 4E     db ' ',0,'M','N','B'      ; SPACE, SYM SHIFT, M, N, B
 199++6BDE 42
 200++6BDF
 201++6BDF                 ; the following are SYM SHIFTed
 202++6BDF
 203++6BDF 00 3A 60 3F     db 0,':',96,'?','/'       ; CAPS SHIFT, Z, X, C, V
 203++6BE3 2F
 204++6BE4 7E 7C 5C 7B     db '~','|',92,'{','}'       ; A, S, D, F, G
 204++6BE8 7D
 205++6BE9 83 84 85 3C     db 131,132,133,'<','>'      ; Q, W, E, R, T
 205++6BED 3E
 206++6BEE 21 40 23 24     db '!','@','#','$','%'      ; 1, 2, 3, 4, 5
 206++6BF2 25
 207++6BF3 5F 29 28 27     db '_',')','(',39,'&'       ; 0, 9, 8, 7, 6
 207++6BF7 26
 208++6BF8 22 3B 82 5D     db 34,';',130,']','['       ; P, O, I, U, Y
 208++6BFC 5B
 209++6BFD 0D 3D 2B 2D     db 13,'=','+','-','^'       ; ENTER, L, K, J, H
 209++6C01 5E
 210++6C02 20 00 2E 2C     db ' ',0,'.',',','*'      ; SPACE, SYM SHIFT, M, N, B
 210++6C06 2A
 211++6C07
 212++6C07                 ; the following are CAPS SHIFTed and SYM SHIFTed ("CTRL" key)
 213++6C07
 214++6C07 00 1A 18 03     db 0,26,24,3,22           ; CAPS SHIFT, Z, X, C, V
 214++6C0B 16
 215++6C0C 01 13 04 06     db 1,19,4,6,7               ; A, S, D, F, G
 215++6C10 07
 216++6C11 11 17 05 12     db 17,23,5,18,20            ; Q, W, E, R, T
 216++6C15 14
 217++6C16 1B 1C 1D 1E     db 27,28,29,30,31           ; 1, 2, 3, 4, 5
 217++6C1A 1F
 218++6C1B 7F 00 86 60     db 127,0,134,'`',135      ; 0, 9, 8, 7, 6
 218++6C1F 87
 219++6C20 10 0F 09 15     db 16,15,9,21,25            ; P, O, I, U, Y
 219++6C24 19
 220++6C25 0D 0C 0B 0A     db 13,12,11,10,8            ; ENTER, L, K, J, H
 220++6C29 08
 221++6C2A 20 00 0D 0E     db ' ',0,13,14,2          ; SPACE, SYM SHIFT, M, N, B
 221++6C2E 02
 222++6C2F
 223++6C2F              russiantable
 224++6C2F 00 EF E7 E1     db 0,'','','',''      ; CAPS SHIFT, Z, X, C, V
 224++6C33 AC
 225++6C34 E4 EB A2 A0     db '','','','',''      ; A, S, D, F, G
 225++6C38 AF
 226++6C39 A9 E6 E3 AA     db '','','','',''      ; Q, W, E, R, T
 226++6C3D A5
 227++6C3E 31 32 33 34     db '1','2','3','4','5'      ; 1, 2, 3, 4, 5
 227++6C42 35
 228++6C43 30 39 38 37     db '0','9','8','7','6'      ; 0, 9, 8, 7, 6
 228++6C47 36
 229++6C48 A7 E9 E8 A3     db '','','','',''      ; P, O, I, U, Y
 229++6C4C AD
 230++6C4D 0D A4 AB AE     db 13,'','','',''       ; ENTER, L, K, J, H
 230++6C51 E0
 231++6C52 20 00 EC E2     db ' ',0,'','',''      ; SPACE, SYM SHIFT, M, N, B
 231++6C56 A8
 232++6C57
 233++6C57                 ; the following are CAPS SHIFTed
 234++6C57
 235++6C57 00 9F 97 91     db 0,'','','',''      ; CAPS SHIFT, Z, X, C, V
 235++6C5B 8C
 236++6C5C 94 9B 82 80     db '','','','',''      ; A, S, D, F, G
 236++6C60 8F
 237++6C61 89 96 93 8A     db '','','','',''      ; Q, W, E, R, T
 237++6C65 85
 238++6C66 0F 06 80 81     db 15,6,128,129,8            ; 1, 2, 3, 4, 5
 238++6C6A 08
 239++6C6B 0C 00 09 0B     db 12,0,9,11,10             ; 0, 9, 8, 7, 6
 239++6C6F 0A
 240++6C70 87 99 98 83     db '','','','',''      ; P, O, I, U, Y
 240++6C74 8D
 241++6C75 0D 84 8B 8E     db 13,'','','',''       ; ENTER, L, K, J, H
 241++6C79 90
 242++6C7A 20 00 9C 92     db ' ',0,'','',''      ; SPACE, SYM SHIFT, M, N, B
 242++6C7E 88
 243++6C7F
 244++6C7F                 ; the following are SYM SHIFTed
 245++6C7F
 246++6C7F 00 3A EE 3F     db 0,':','','?','/'       ; CAPS SHIFT, Z, X, C, V
 246++6C83 2F
 247++6C84 A1 ED 5C E5     db '','',92,'',''       ; A, S, D, F, G
 247++6C88 A6
 248++6C89 83 84 85 3C     db 131,132,133,'<','>'      ; Q, W, E, R, T
 248++6C8D 3E
 249++6C8E 21 40 23 24     db '!','@','#','$','%'      ; 1, 2, 3, 4, 5
 249++6C92 25
 250++6C93 5F 29 28 27     db '_',')','(',39,'&'       ; 0, 9, 8, 7, 6
 250++6C97 26
 251++6C98 22 3B 82 5D     db 34,';',130,']','['       ; P, O, I, U, Y
 251++6C9C 5B
 252++6C9D 0D 3D 2B 2D     db 13,'=','+','-','^'       ; ENTER, L, K, J, H
 252++6CA1 5E
 253++6CA2 20 00 2E 2C     db ' ',0,'.',',','*'      ; SPACE, SYM SHIFT, M, N, B
 253++6CA6 2A
 254++6CA7
 255++6CA7                 ; the following are CAPS SHIFTed and SYM SHIFTed ("CTRL" key)
 256++6CA7
 257++6CA7 00 1A 9E 03     db 0,26,'',3,22           ; CAPS SHIFT, Z, X, C, V
 257++6CAB 16
 258++6CAC 81 9D 04 95     db '','',4,'',''               ; A, S, D, F, G
 258++6CB0 86
 259++6CB1 11 17 05 12     db 17,23,5,18,20            ; Q, W, E, R, T
 259++6CB5 14
 260++6CB6 1B 1C 1D 1E     db 27,28,29,30,31           ; 1, 2, 3, 4, 5
 260++6CBA 1F
 261++6CBB 7F 00 86 60     db 127,0,134,'`',135      ; 0, 9, 8, 7, 6
 261++6CBF 87
 262++6CC0 10 0F 09 15     db 16,15,9,21,25            ; P, O, I, U, Y
 262++6CC4 19
 263++6CC5 0D 0C 0B 0A     db 13,12,11,10,8            ; ENTER, L, K, J, H
 263++6CC9 08
 264++6CCA 20 00 0D 0E     db ' ',0,13,14,2          ; SPACE, SYM SHIFT, M, N, B
 264++6CCE 02
 265++6CCF
 266++6CCF                  endmodule
# file closed: dos/console.asm
   8++6CCF              		include "trdos.asm"
# file opened: dos/trdos.asm
   1++6CCF              ;trdos driver (izzx)
   2++6CCF                  MODULE Dos
   3++6CCF              ; API methods
   4++6CCF              ESX_GETSETDRV = #89
   5++6CCF              ESX_FOPEN = #9A
   6++6CCF              ESX_FCLOSE = #9B
   7++6CCF              ESX_FSYNC = #9C
   8++6CCF              ESX_FREAD = #9D
   9++6CCF              ESX_FWRITE = #9E
  10++6CCF
  11++6CCF              ; File modes
  12++6CCF              FMODE_READ = #01
  13++6CCF              FMODE_WRITE = #06
  14++6CCF              FMODE_CREATE = #0E
  15++6CCF
  16++6CCF                  ; MACRO esxCall func
  17++6CCF                  ; rst #8 : db func
  18++6CCF                  ; ENDM
  19++6CCF
  20++6CCF              ;id = 0 䠩  
  21++6CCF              ;id = 1 䠩  ⥭
  22++6CCF              ;id = 2 䠩  
  23++6CCF              ;id = 3 䠩   ⨯ TRD
  24++6CCF              ;id = 4 䠩   ⨯ SCL
  25++6CCF
  26++6CCF              ; HL - filename in ASCIIZ
  27++6CCF              loadBuffer:
  28++6CCF 06 01            ld b, Dos.FMODE_READ
  28++6CD1 CD EB 6C       call Dos.fopen
  29++6CD4 F5               push af
  30++6CD5 21 D0 9F 01          ld hl, outputBuffer, bc, #ffff - outputBuffer
  30++6CD9 2F 60
  30++6CDB CD 42 6F       call Dos.fread
  31++6CDE 21 D0 9F             ld hl, outputBuffer
  31++6CE1 09             add hl, bc
  31++6CE2 AF             xor a
  31++6CE3 77             ld (hl), a
  31++6CE4 23             inc hl
  31++6CE5 77             ld (hl), a
  32++6CE6 F1               pop af
  33++6CE7 CD 36 6E         call Dos.fclose
  34++6CEA C9               ret
  35++6CEB
  36++6CEB
  37++6CEB              ; Returns:
  38++6CEB              ;  A - current drive
  39++6CEB              ; getDefaultDrive: ;  ᯮ
  40++6CEB                  ; ld a, 0 : esxCall ESX_GETSETDRV
  41++6CEB                  ; ret
  42++6CEB
  43++6CEB
  44++6CEB
  45++6CEB              ; Opens file on default drive
  46++6CEB              ; B - File mode
  47++6CEB              ; HL - File name
  48++6CEB              ; Returns:
  49++6CEB              ;  A - file stream id
  50++6CEB              fopen:
  51++6CEB                  ; push bc : push hl
  52++6CEB                  ; call getDefaultDrive
  53++6CEB                  ; pop ix : pop bc
  54++6CEB                  ; esxCall ESX_FOPEN
  55++6CEB                  ; ret
  56++6CEB 78           	ld a,b
  57++6CEC FE 01        	cp FMODE_READ ;᫨ ० ⨥ 䠩
  58++6CEE 28 06        	jr z,fopen_r
  59++6CF0 FE 0E        	cp FMODE_CREATE
  60++6CF2 28 39        	jr z,fopen_c ;᫨ ० ᮧ 䠩
  61++6CF4 18 34        	jr fopen_err ; 室
  62++6CF6
  63++6CF6              fopen_r	;⨥ 饣 䠩  ⥭ (id=1)
  64++6CF6              	; ld a,(#5D19) ; ᪮  㬮砭
  65++6CF6              	; ld 	(prev_drive),a ;
  66++6CF6 CD CC 72     			call format_name ;
  67++6CF9 0E 13        			ld      c,#13 ;move file info to syst var
  68++6CFB CD 32 6E                 call    call3d13
  69++6CFE 0E 0A                    ld      c,#0a ;find file
  70++6D00 CD 32 6E                 call    call3d13
  71++6D03 79                       ld      a,c
  72++6D04 FE FF        			cp 		#ff
  73++6D06 28 22        			jr 		z,fopen_err ;᫨  諨 䠩
  74++6D08 0E 08                    ld      c,#08 ;read file title
  75++6D0A CD 32 6E                 call    call3d13
  76++6D0D                          ;ld      hl,loadadr ;㤠
  77++6D0D ED 5B EB 5C              ld      de,(#5ceb) ;砫 䠩 ᥪ ஦
  78++6D11 ED 53 99 73              ld      (f_r_cur_trk),de
  79++6D15
  80++6D15 3A EA 5C                 ld      a,(#5cea)
  81++6D18 32 9B 73                 ld      (f_r_len_sec),a ;  ᥪ
  82++6D1B                          ;or      a
  83++6D1B                          ;ret     z    ;室 ᫨ ⮩
  84++6D1B
  85++6D1B ED 5B E8 5C  			ld de,(#5CE8) ;  䠩  ணࠬ   BASIC
  86++6D1F ED 53 9C 73  			ld      (f_r_len),de
  87++6D23
  88++6D23                          ; ld      de,(fcurtrk) ;⥪騥 ᥪ ஦
  89++6D23                          ; ld      (#5cf4),de ;⠭
  90++6D23 AF           			xor a
  91++6D24 3E 01        			ld 		a,1
  92++6D26 32 9E 73     			ld (f_r_flag),a ;䫠  䠩  ⥭ 
  93++6D29              			;id  㤥 1
  94++6D29 C9           	ret
  95++6D2A
  96++6D2A              fopen_err
  97++6D2A AF           	xor a ;᫨  䠩  뫨,  id = 0
  98++6D2B 37           	scf ;䫠 訡
  99++6D2C C9           	ret
 100++6D2D
 101++6D2D
 102++6D2D              fopen_c	;ᮧ  䠩 (id=2-4)
 103++6D2D              	; ld a,(#5D19) ; ᪮  㬮砭
 104++6D2D              	; ld 	(prev_drive),a ;
 105++6D2D CD CC 72     	call format_name ;
 106++6D30              	;᭨,  ࠧ    ࠧ稢
 107++6D30 21 75 73         ld hl, trdExt1
 107++6D33 CD F2 63       call CompareBuff.search
 107++6D36 A7             and a
 107++6D37 20 7B          jr nz, fopen_c_trd
 108++6D39 21 7A 73         ld hl, trdExt2
 108++6D3C CD F2 63       call CompareBuff.search
 108++6D3F A7             and a
 108++6D40 20 72          jr nz, fopen_c_trd
 109++6D42 21 7F 73     	ld hl, sclExt1
 109++6D45 CD F2 63       call CompareBuff.search
 109++6D48 A7             and a
 109++6D49 C2 D6 6D       jp nz, fopen_c_scl
 110++6D4C 21 84 73         ld hl, sclExt2
 110++6D4F CD F2 63       call CompareBuff.search
 110++6D52 A7             and a
 110++6D53 C2 D6 6D       jp nz, fopen_c_scl
 111++6D56
 112++6D56
 113++6D56              	;ᮧ ந쭮 䠩 (id=2)
 114++6D56 CD FE 6D     	call select_drive
 115++6D59 FE 79        	cp "y"
 116++6D5B 20 CD        	jr nz,fopen_err
 117++6D5D
 118++6D5D CD A6 6D     	call cat_buf_cls
 119++6D60
 120++6D60 21 00 48     	ld hl,cat_buf ;⠥ ⠫ ᪠
 121++6D63 11 00 00     	ld de,0
 122++6D66 01 05 09         ld      bc,#0905 ;
 123++6D69 CD 32 6E         call    call3d13
 124++6D6C
 125++6D6C 3A E4 50     	ld a,(cat_buf+8*256+#e4) ; 饥 ⢮ 䠩
 126++6D6F FE 80        	cp 128
 127++6D71 DA 7C 6D     	jp c,fopen_c2 ;᫨ 㦥 ᨬ
 128++6D74 21 DA 73         ld hl, file_err
 129++6D77 CD 3E 6A         call DialogBox.msgBox ;।०
 130++6D7A 18 AE        	jr fopen_err
 131++6D7C
 132++6D7C              fopen_c2
 133++6D7C 2A E5 50     	ld hl,(cat_buf+8*256+#e5) ; ⢮ ᢮ ᥪ஢  ᪥
 134++6D7F 7C           	ld a,h
 135++6D80 B5           	or l
 136++6D81 20 08        	jr nz,fopen_c3 ;᫨   
 137++6D83 21 DA 73         ld hl, file_err
 138++6D86 CD 3E 6A         call DialogBox.msgBox ;।०
 139++6D89 18 9F        	jr fopen_err
 140++6D8B
 141++6D8B              fopen_c3
 142++6D8B ED 5B E1 50  	ld de,(cat_buf+8*256+#e1) ; ᢮ ᥪ-஦
 143++6D8F ED 53 F4 5C      ld   (#5cf4),de ; 㤥  䠩
 144++6D93
 145++6D93 AF           	xor a
 146++6D94 32 AE 73     	ld (sec_shift),a ;६
 147++6D97 21 00 00     	ld hl,0
 148++6D9A 22 A3 73     	ld (f_w_len+0),hl
 149++6D9D 22 A5 73     	ld (f_w_len+2),hl
 150++6DA0 3E 02        	ld a,2 ;id 
 151++6DA2 32 A2 73     	ld (f_w_flag),a ;䫠  䠩   
 152++6DA5 C9           	ret
 153++6DA6
 154++6DA6
 155++6DA6              cat_buf_cls ;⪠  ⠫
 156++6DA6 21 00 48     	ld hl,cat_buf ;   ⠫ ᪥
 157++6DA9 11 01 48     	ld de,cat_buf+1
 158++6DAC 36 00        	ld (hl),0
 159++6DAE 01 FF 08     	ld bc,9*256-1
 160++6DB1 ED B0        	ldir
 161++6DB3 C9           	ret
 162++6DB4
 163++6DB4
 164++6DB4
 165++6DB4              fopen_c_trd	;⨥ 䠩  ࠧ稢 ࠧ trd (id=3)
 166++6DB4 CD FE 6D     	call select_drive
 167++6DB7 FE 79        	cp "y"
 168++6DB9 C2 2A 6D     	jp nz,fopen_err
 169++6DBC
 170++6DBC 11 00 00     	ld      de,0 ;砫 ᥪ ஦
 171++6DBF ED 53 F4 5C      ld      (#5cf4),de
 172++6DC3
 173++6DC3 AF           	xor a
 174++6DC4 32 AE 73     	ld (sec_shift),a ;६
 175++6DC7 21 00 00     	ld hl,0
 176++6DCA 22 A3 73     	ld (f_w_len+0),hl
 177++6DCD 22 A5 73     	ld (f_w_len+2),hl
 178++6DD0 3E 03        	ld a,3 ;id 
 179++6DD2 32 A2 73     	ld (f_w_flag),a ;䫠  trd   
 180++6DD5 C9           	ret
 181++6DD6
 182++6DD6
 183++6DD6
 184++6DD6              fopen_c_scl	;⨥ 䠩  ࠧ稢 ࠧ scl (id=4)
 185++6DD6 CD FE 6D     	call select_drive
 186++6DD9 FE 79        	cp "y"
 187++6DDB C2 2A 6D     	jp nz,fopen_err
 188++6DDE
 189++6DDE 11 00 00     	ld      de,0 ;砫 ᥪ ஦
 190++6DE1 ED 53 F4 5C      ld      (#5cf4),de
 191++6DE5
 192++6DE5 CD A6 6D     	call cat_buf_cls ; 
 193++6DE8
 194++6DE8 CD 41 71     	call scl_parse ; 横 ᡮન ࠧ
 195++6DEB
 196++6DEB AF           	xor a
 197++6DEC 32 AE 73     	ld (sec_shift),a ;६
 198++6DEF              	;ld (scl_que),a
 199++6DEF 21 00 00     	ld hl,0
 200++6DF2 22 A3 73     	ld (f_w_len+0),hl
 201++6DF5 22 A5 73     	ld (f_w_len+2),hl
 202++6DF8 3E 04        	ld a,4 ;id 
 203++6DFA 32 A2 73     	ld (f_w_flag),a ;䫠  scl   
 204++6DFD C9           	ret
 205++6DFE
 206++6DFE
 207++6DFE
 208++6DFE
 209++6DFE
 210++6DFE              select_drive	;  ᪮
 211++6DFE 3A 19 5D     	ld a,(#5D19) ; ᪮  㬮砭
 212++6E01 C6 41        	add a,"A"
 213++6E03 32 47 73     	ld (write_ima_d),a ;⠢ 㪢  
 214++6E06 21 3B 73         ld hl, write_ima
 215++6E09 CD 47 6A         call DialogBox.msgNoWait ;।०
 216++6E0C              WAITKEY_trd
 217++6E0C              	;halt
 218++6E0C CD 90 6A     	call Console.getC
 219++6E0F FE FF        	cp 255
 220++6E11 28 F9        	JR Z,WAITKEY_trd	;  
 221++6E13 FE 79        	cp "y"
 222++6E15 C8           	ret z
 223++6E16 FE 6E        	cp "n"
 224++6E18 C8           	ret z
 225++6E19 FE 61        	cp "a"
 226++6E1B 38 EF        	jr c,WAITKEY_trd
 227++6E1D FE 65        	cp "e"
 228++6E1F 30 EB        	jr nc,WAITKEY_trd
 229++6E21 D6 61        	sub "a"
 230++6E23 32 19 5D         ld      (#5d19) ,a
 231++6E26 0E 01            ld      c,1
 232++6E28 CD 32 6E         call    call3d13
 233++6E2B 0E 18            ld      c,#18
 234++6E2D CD 32 6E         call    call3d13
 235++6E30 18 CC        	jr select_drive
 236++6E32
 237++6E32
 238++6E32              ; restore_drive ;⠭ ᪮  㬮砭
 239++6E32              	; ld 	a,(prev_drive)
 240++6E32                  ; ld      (#5d19) ,a
 241++6E32                  ; ld      c,1
 242++6E32                  ; call    call3d13
 243++6E32                  ; ld      c,#18
 244++6E32                  ; call    call3d13
 245++6E32              	; ret
 246++6E32
 247++6E32
 248++6E32              call3d13 ;䨪  GMX
 249++6E32              	ifndef ZSGMX
 250++6E32 C3 13 3D         jp    #3d13
 251++6E35              	endif
 252++6E35
 253++6E35              	ifdef ZSGMX
 254++6E35 ~                call    #3d13
 255++6E35 ~            	exx
 256++6E35 ~            	call TextMode.gmxscron
 257++6E35 ~            	exx
 258++6E35              	endif
 259++6E35 C9           	ret
 260++6E36
 261++6E36
 262++6E36
 263++6E36              ; A - file stream id
 264++6E36              fclose:
 265++6E36                  ;esxCall ESX_FCLOSE
 266++6E36              	; push af
 267++6E36              ; WAITKEY2	XOR A:IN A,(#FE):CPL:AND #1F:JR Z,WAITKEY2
 268++6E36              	; pop af
 269++6E36 FE 02        	cp 2 ;᫨  䠩
 270++6E38 C2 2E 6F     	jp nz,fclose_scl
 271++6E3B
 272++6E3B              	; ⮪ 䠩
 273++6E3B 3A A7 73     	ld a,(write_end_flag) ;㦭 뢠 ⮪?
 274++6E3E B7           	or a
 275++6E3F 20 12        	jr nz,fclose_f ; 㦭
 276++6E41
 277++6E41 21 00 51     	ld hl,sec_buf
 278++6E44 01 06 01     	ld bc,#0106
 279++6E47 ED 5B F4 5C  	ld de,(#5cf4)
 280++6E4B CD 32 6E     	call call3d13
 281++6E4E
 282++6E4E 3E 30        	ld a,"0" ;  䠩
 283++6E50 32 ED 73     	ld (file_num),a
 284++6E53
 285++6E53              fclose_f ;ࠢ ⠫
 286++6E53 3A A5 73     	ld a,(f_w_len+2) ;ᠬ 訩   䠩
 287++6E56 2A A3 73     	ld hl,(f_w_len+0)
 288++6E59 B4           	or h
 289++6E5A B5           	or l
 290++6E5B CA 3A 6F     	jp z,fclose_ex ;室 ᫨  0
 291++6E5E
 292++6E5E              	;஢ન  
 293++6E5E 3A E4 50     	ld a,(cat_buf+8*256+#e4) ; 饥 ⢮ 䠩
 294++6E61 FE 80        	cp 128
 295++6E63 D2 3A 6F     	jp nc,fclose_ex ;᫨ 㦥 ᨬ
 296++6E66 2A E5 50     	ld hl,(cat_buf+8*256+#e5) ; ⢮ ᢮ ᥪ஢  ᪥
 297++6E69 7C           	ld a,h
 298++6E6A B5           	or l
 299++6E6B CA 3A 6F     	jp z,fclose_ex ;᫨  
 300++6E6E
 301++6E6E 3A A5 73     	ld a,(f_w_len+2) ;ᠬ 訩   䠩
 302++6E71 B7           	or a
 303++6E72 20 28        	jr nz,fclose_f_multi ;᫨ 䠩  255 ᥪ஢ (65280)
 304++6E74 3A A4 73     	ld a,(f_w_len+1)
 305++6E77 FE FF        	cp 255
 306++6E79 20 05        	jr nz,fclose_f1
 307++6E7B 3A A3 73     	ld a,(f_w_len+0)
 308++6E7E 20 1C        	jr nz,fclose_f_multi ;᫨ 䠩  255 ᥪ஢ (65280)
 309++6E80              fclose_f1
 310++6E80              	;䠩  ॢ蠥 ᨬ ࠧ  trdos
 311++6E80 ED 5B A3 73  	ld de,(f_w_len+0)
 312++6E84 21 94 73     	ld hl,f_name+11 ; 䠩
 313++6E87 73           	ld (hl),e
 314++6E88 23           	inc hl
 315++6E89 72           	ld (hl),d
 316++6E8A 23           	inc hl
 317++6E8B 3A A4 73     	ld a,(f_w_len+1) ; ᥪ஢
 318++6E8E 77           	ld (hl),a
 319++6E8F 3A A3 73     	ld a,(f_w_len+0) ; 訩
 320++6E92 B7           	or a
 321++6E93 28 01        	jr z,fclose_f2
 322++6E95 34           	inc (hl) ;४ ᥪ஢
 323++6E96              fclose_f2
 324++6E96 CD C8 6E     	call fclose_f_one ; ଠ
 325++6E99 C3 3A 6F     	jp fclose_ex ;⮢
 326++6E9C
 327++6E9C              fclose_f_multi ;䠩 让, 㤥 ᪮쪮 ᥩ  ⠫
 328++6E9C 3A ED 73     	ld a,(file_num)
 329++6E9F 32 90 73     	ld (f_name+7),a ;   
 330++6EA2
 331++6EA2 21 94 73     	ld hl,f_name+11 ; 䠩
 332++6EA5 36 00        	ld (hl),0
 333++6EA7 23           	inc hl
 334++6EA8 36 FF        	ld (hl),#ff ;65280
 335++6EAA 23           	inc hl
 336++6EAB              	; ᥪ஢
 337++6EAB 36 FF        	ld (hl),#ff
 338++6EAD CD C8 6E     	call fclose_f_one ; ଠ
 339++6EB0
 340++6EB0              	;  ᠭ
 341++6EB0 2A A4 73     	ld hl,(f_w_len+1) ;訩  । 
 342++6EB3 01 FF 00     	ld bc,255
 343++6EB6 A7           	and a
 344++6EB7 ED 42        	sbc hl,bc ; 255 ᥪ஢
 345++6EB9 22 A4 73     	ld (f_w_len+1),hl
 346++6EBC
 347++6EBC 3A ED 73     	ld a,(file_num)
 348++6EBF 3C           	inc a
 349++6EC0 32 ED 73     	ld (file_num),a
 350++6EC3 32 90 73     	ld (f_name+7),a ;   
 351++6EC6
 352++6EC6 18 8B        	jr fclose_f ;᭠砫
 353++6EC8
 354++6EC8
 355++6EC8              fclose_f_one ;   䠩
 356++6EC8 3A E4 50     			ld a,(cat_buf+8*256+#e4) ; 饥 ⢮ 䠩
 357++6ECB 6F           			ld l,a ;㧭   ᥪ 㤥   䠩
 358++6ECC 26 00        			ld h,0
 359++6ECE 29           			add hl,hl ;*2
 360++6ECF 29           			add hl,hl ;*4
 361++6ED0 29           			add hl,hl ;*8
 362++6ED1 29           			add hl,hl ;*16
 363++6ED2 7C           			ld a,h ;    ⠫
 364++6ED3 32 EC 73     			ld (sec_cat),a
 365++6ED6 01 00 48     			ld bc,cat_buf
 366++6ED9 09           			add hl,bc ; 㤥    䠩
 367++6EDA EB           			ex de,hl
 368++6EDB
 369++6EDB 21 89 73     			ld hl,f_name ;  䠩
 370++6EDE 01 10 00     			ld bc,16
 371++6EE1 ED B0        			ldir ;᪮஢
 372++6EE3 EB           			ex de,hl
 373++6EE4 2B           			dec hl
 374++6EE5 ED 5B E1 50  			ld de,(cat_buf+8*256+#e1) ; ᢮ ᥪ-஦ 祭
 375++6EE9 72           			ld (hl),d ;஦
 376++6EEA 2B           			dec hl
 377++6EEB 73           			ld (hl),e ;ᥪ
 378++6EEC
 379++6EEC 2E 00        			ld l,0 ; ᥪ 楫  ஢ 
 380++6EEE 16 00        			ld d,0
 381++6EF0 3A EC 73     			ld a,(sec_cat)
 382++6EF3 5F           			ld e,a ; ᥪ
 383++6EF4 01 06 01     			ld bc,#0106 ;1 ᥪ 
 384++6EF7 CD 32 6E     			call call3d13
 385++6EFA
 386++6EFA              			;㦥 ᥪ
 387++6EFA ED 5B E1 50  			ld de,(cat_buf+8*256+#e1) ; ᢮ ᥪ-஦
 388++6EFE 3A 96 73     			ld a,(f_name+13) ;ࠧ 䠩  ᥪ
 389++6F01 47           			ld b,a
 390++6F02 CD 2F 73     			call calc_next_pos2
 391++6F05 ED 53 E1 50  			ld (cat_buf+8*256+#e1),de
 392++6F09
 393++6F09 2A E5 50     			ld hl,(cat_buf+8*256+#e5) ; ⢮ ᢮ ᥪ஢  ᪥
 394++6F0C 3A 96 73     			ld a,(f_name+13) ;ࠧ 䠩  ᥪ
 395++6F0F 4F           			ld c,a
 396++6F10 06 00        			ld b,0
 397++6F12 A7           			and a
 398++6F13 ED 42        			sbc hl,bc
 399++6F15 30 03        			jr nc,fclose_f_one2
 400++6F17 21 00 00     			ld hl,0 ;᫨ 뫮 ⥫쭮
 401++6F1A              fclose_f_one2
 402++6F1A 22 E5 50     			ld (cat_buf+8*256+#e5),hl
 403++6F1D
 404++6F1D 21 E4 50     			ld hl,cat_buf+8*256+#e4 ; 饥 ⢮ 䠩
 405++6F20 34           			inc (hl)
 406++6F21
 407++6F21 21 00 50     			ld hl,cat_buf+8*256
 408++6F24 11 08 00     			ld de,#0008
 409++6F27 01 06 01     			ld bc,#0106 ;1 ᥪ 
 410++6F2A CD 32 6E     			call call3d13
 411++6F2D C9           			ret
 412++6F2E
 413++6F2E
 414++6F2E              fclose_scl
 415++6F2E FE 04        	cp 4 ;᫨ scl
 416++6F30 20 08        	jr nz,fclose_ex
 417++6F32 21 00 51     	ld hl,sec_buf ;
 418++6F35 06 01        	ld b,1
 419++6F37 CD 20 71     	call scl_write_buf ;襬 ⮪ scl, ᫨ 
 420++6F3A
 421++6F3A              fclose_ex
 422++6F3A AF           	xor a ;  뢠  䠩
 423++6F3B 32 9E 73     	ld (f_r_flag),a
 424++6F3E 32 A2 73     	ld (f_w_flag),a
 425++6F41              	;call restore_drive ; ,  
 426++6F41 C9               ret
 427++6F42
 428++6F42
 429++6F42
 430++6F42
 431++6F42              ; A - file stream id
 432++6F42              ; BC - length
 433++6F42              ; HL - buffer
 434++6F42              ; Returns
 435++6F42              ;  BC - length(how much was actually read)
 436++6F42              fread: ;(id=1)
 437++6F42                  ; push hl : pop ix
 438++6F42                  ; esxCall ESX_FREAD
 439++6F42              	; push af
 440++6F42              	; ld a,4
 441++6F42              	; out (254),a
 442++6F42              ; WAITKEY	XOR A:IN A,(#FE):CPL:AND #1F:JR Z,WAITKEY
 443++6F42              	; xor a
 444++6F42              	; out (254),a
 445++6F42              	; pop af
 446++6F42
 447++6F42 FE 01        	cp 1 ;id = 1?
 448++6F44 20 06        	jr nz,fread_no_chek ;室 ᫨  ⮪  = 1
 449++6F46 3A 9E 73     	ld a,(f_r_flag)
 450++6F49 B7           	or a
 451++6F4A 20 06        	jr nz,fread_chek ;䠩 㦥 ?
 452++6F4C              fread_no_chek ;室  訡
 453++6F4C AF           	xor a
 454++6F4D 37           	scf ;䫠 訡
 455++6F4E 01 00 00     	ld bc,0 ;祣   ⠫
 456++6F51 C9           	ret
 457++6F52
 458++6F52              fread_chek
 459++6F52 ED 4B 9A 73  	ld bc,(f_r_len_sec-1) ;㦠 䠩 楫,  ᬮ  , ᪮쪮  뫮 襭
 460++6F56 0E 05            ld      c,5 ;read ⠥ 楫묨 ᥪࠬ
 461++6F58 ED 5B 99 73  	ld de,(f_r_cur_trk)
 462++6F5C CD 32 6E         call    call3d13
 463++6F5F ED 4B 9C 73  	ld bc,(f_r_len) ;⨬ ᪮쪮 ⠫  ( 䠩)
 464++6F63 AF           	xor a ;䫠 ᨬ
 465++6F64 C9               ret
 466++6F65
 467++6F65              ; A - file stream id
 468++6F65              ; BC - length
 469++6F65              ; HL - buffer
 470++6F65              ; Returns:
 471++6F65              ;   BC - actually written bytes
 472++6F65              fwrite: ;
 473++6F65                  ; push hl : pop ix
 474++6F65                  ; esxCall ESX_FWRITE
 475++6F65
 476++6F65              	; push af
 477++6F65              	; ld a,2
 478++6F65              	; out (254),a
 479++6F65              ; WAITKEY1	XOR A:IN A,(#FE):CPL:AND #1F:JR Z,WAITKEY1
 480++6F65              	; xor a
 481++6F65              	; out (254),a
 482++6F65              	; pop af
 483++6F65
 484++6F65 FE 02        	cp 2 ;id = 2?
 485++6F67 28 0F        	jr z,fwrite_chek ;஢ઠ id ⮪
 486++6F69 FE 03        	cp 3 ;id = 3?
 487++6F6B 28 0B        	jr z,fwrite_chek_trd ;஢ઠ id ⮪
 488++6F6D FE 04        	cp 4 ;id = 4?
 489++6F6F CA 5B 70     	jp z,fwrite_chek_scl ;஢ઠ id ⮪
 490++6F72
 491++6F72
 492++6F72              fwrite_no_chek ;室  訡
 493++6F72 AF           	xor a
 494++6F73 37           	scf ;䫠 訡
 495++6F74 01 00 00     	ld bc,0 ;祣   ᠫ
 496++6F77 C9           	ret
 497++6F78
 498++6F78              fwrite_chek ; ந쭮 ⨯ 䠩 (id=2)
 499++6F78
 500++6F78              	; ⫨砥   trd,  室騩 ⮪  , ⫨  ⨨  ⨨ 䠩
 501++6F78
 502++6F78
 503++6F78
 504++6F78
 505++6F78
 506++6F78              fwrite_chek_trd ; trd 䠩 (ࠧ稢 ࠧ, id=3)
 507++6F78              	; ld a,2
 508++6F78              	; out (254),a
 509++6F78              ; WAITKEY_t	XOR A:IN A,(#FE):CPL:AND #1F:JR Z,WAITKEY_t
 510++6F78              	; xor a
 511++6F78              	; out (254),a
 512++6F78 3A A2 73     	ld a,(f_w_flag)
 513++6F7B B7           	or a
 514++6F7C 28 F4        	jr z,fwrite_no_chek ;䠩 㦥 ?
 515++6F7E ED 43 A8 73  	ld (temp_bc),bc ;
 516++6F82 22 AA 73     	ld (temp_hl),hl ; 
 517++6F85 78           	ld a,b
 518++6F86 B1           	or c
 519++6F87 28 E9        	jr z,fwrite_no_chek ; ᫨  0,  室
 520++6F89
 521++6F89              	;  ९ ᪠
 522++6F89 ED 5B F4 5C  	ld de,(#5cf4)
 523++6F8D 7A           	ld a,d
 524++6F8E FE A0        	cp #a0 ;᫥ ஦ 160
 525++6F90 30 E0        	jr nc,fwrite_no_chek
 526++6F92
 527++6F92 AF           	xor a
 528++6F93 32 B0 73     	ld (sec_part),a ;㫨 ६
 529++6F96 32 AF 73     	ld (sec_shift2),a
 530++6F99 32 B0 73     	ld (sec_shift2+1),a
 531++6F9C 32 B1 73     	ld (sec_shift_flag),a
 532++6F9F 32 A7 73     	ld (write_end_flag),a ;
 533++6FA2
 534++6FA2
 535++6FA2 3A AE 73     	ld a,(sec_shift)
 536++6FA5 B7           	or a
 537++6FA6 28 43        	jr z,fwrite_trd3 ;᫨ ᬥ饭 ,    ய⨬
 538++6FA8
 539++6FA8
 540++6FA8 4F           	ld c,a
 541++6FA9 06 00        	ld b,0
 542++6FAB 2A A8 73     	ld hl,(temp_bc) ;஢ઠ   楫 ᥪ
 543++6FAE 09           	add hl,bc
 544++6FAF
 545++6FAF 3E 01        	ld a,1
 546++6FB1 32 A7 73     	ld (write_end_flag),a ;䫠   㦭 뢠 ⮪
 547++6FB4
 548++6FB4 7C           	ld a,h
 549++6FB5 B7           	or a
 550++6FB6 20 05        	jr nz,fwrite_trd4
 551++6FB8 3E 01        	ld a,1
 552++6FBA 32 B1 73     	ld (sec_shift_flag),a ;䫠    ᥪ
 553++6FBD
 554++6FBD              fwrite_trd4
 555++6FBD 21 00 51     	ld hl,sec_buf ; ᫥ ᥪ
 556++6FC0 09           	add hl,bc ; ⮩ 窥 ⠭
 557++6FC1 EB           	ex de,hl
 558++6FC2 2A AA 73     	ld hl,(temp_hl) ;ᮥ 砫    ।
 559++6FC5              	; ld a,c
 560++6FC5              	; or a
 561++6FC5              	; jr nz,fwrite_trd2
 562++6FC5              	; inc b ;४
 563++6FC5              ; fwrite_trd2
 564++6FC5              	; ld c,a
 565++6FC5 AF           	xor a
 566++6FC6 91           	sub c
 567++6FC7 4F           	ld c,a ;᪮쪮 ⠫ ७   ᥪ
 568++6FC8 ED 43 AF 73  	ld (sec_shift2),bc ;࠭ ᪮쪮  
 569++6FCC ED B0        	ldir
 570++6FCE
 571++6FCE 3A B1 73     	ld a,(sec_shift_flag)
 572++6FD1 B7           	or a
 573++6FD2 20 17        	jr nz,fwrite_trd3 ;᫨ ᥪ      㤥
 574++6FD4
 575++6FD4 21 00 51     	ld hl,sec_buf
 576++6FD7 ED 5B F4 5C  	ld de,(#5cf4)
 577++6FDB              	;ld (f_w_cur_trk),de	; 
 578++6FDB 01 06 01         ld      bc,#0106 ;襬 1 ᥪ  
 579++6FDE CD 32 6E         call    call3d13
 580++6FE1 79           	ld a,c
 581++6FE2 FE FF        	cp 255
 582++6FE4 CA 72 6F     	jp z,fwrite_no_chek ;室 ᫨ 訡
 583++6FE7
 584++6FE7 AF           	xor a
 585++6FE8 32 A7 73     	ld (write_end_flag),a ;䫠  㦭 뢠 ⮪
 586++6FEB              	; ld de,(f_w_cur_trk) ;᫨ ᥪ   , ⠭  ன 樨
 587++6FEB              	; ld (#5cf4),de
 588++6FEB              	; ld b,1 ; ᥪ 
 589++6FEB              	; ld de,(f_w_cur_trk)
 590++6FEB              	; call calc_next_pos
 591++6FEB              	; ld (f_w_cur_trk),de
 592++6FEB
 593++6FEB              fwrite_trd3
 594++6FEB 2A AA 73     	ld hl,(temp_hl) ;襬 ⮪ 
 595++6FEE              	;ld a,(sec_shift)
 596++6FEE              	;ld c,a
 597++6FEE              	;ld b,0
 598++6FEE ED 4B AF 73  	ld bc,(sec_shift2)
 599++6FF2 09           	add hl,bc ; ⮩ 窨 襬
 600++6FF3 22 AC 73     	ld (temp_hl2),hl ;࠭ 砫  ண ᥪ
 601++6FF6
 602++6FF6 2A A8 73     	ld hl,(temp_bc) ;᫥   ⠭   ࠧ
 603++6FF9 A7           	and a
 604++6FFA ED 42        	sbc hl,bc ;⥬ ,    ࢮ ᥪ
 605++6FFC 4D           	ld c,l
 606++6FFD 44           	ld b,h
 607++6FFE 30 02        	jr nc,fwrite_trd5
 608++7000 06 00        	ld b,0 ;४ ᫨ 襫 
 609++7002              fwrite_trd5
 610++7002 2A AA 73     	ld hl,(temp_hl)
 611++7005 09           	add hl,bc
 612++7006
 613++7006 11 D0 9F     	ld de,outputBuffer
 614++7009 A7           	and a
 615++700A ED 52        	sbc hl,de
 616++700C
 617++700C 7D           	ld a,l
 618++700D 32 AE 73     	ld (sec_shift),a ;ᬥ饭  ᫥騩 ࠧ
 619++7010              	;ld hl,(temp_hl)
 620++7010
 621++7010
 622++7010              	; or a
 623++7010              	; jr z,fwrite_trd1
 624++7010              	; inc b  ;४ ⢠ ᥪ஢
 625++7010
 626++7010 78           	ld a,b ;㦭 ஢ઠ  ⢮ ᥪ஢!!!
 627++7011 32 B0 73     	ld (sec_part),a ; ᪮쪮 ᥪ஢  ன 
 628++7014
 629++7014              	;ld a,b
 630++7014 B7           	or a
 631++7015 28 16        	jr z,fwrite_trd1 ;᫨ ࠧ   ᥪ,  ய⨬ 
 632++7017
 633++7017 2A AC 73     	ld hl,(temp_hl2)
 634++701A              	;push bc
 635++701A ED 5B F4 5C  	ld de,(#5cf4)
 636++701E 0E 06            ld      c,6 ;襬 楫묨 ᥪࠬ
 637++7020 CD 32 6E         call    call3d13
 638++7023 79           	ld a,c
 639++7024              	;pop bc
 640++7024 FE FF        	cp 255
 641++7026 CA 72 6F     	jp z,fwrite_no_chek ;室 ᫨ 訡
 642++7029              	; ld de,(f_w_cur_trk)
 643++7029              	; call calc_next_pos
 644++7029              	; ld (f_w_cur_trk),de
 645++7029
 646++7029 AF           	xor a
 647++702A 32 A7 73     	ld (write_end_flag),a ;䫠  㦭 뢠 ⮪
 648++702D
 649++702D              fwrite_trd1
 650++702D 3A A7 73     	ld a,(write_end_flag) ;㦭 뢠 ⮪?
 651++7030 B7           	or a
 652++7031 20 12        	jr nz,fwrite_trd_ex ; 㦭
 653++7033
 654++7033 2A AC 73     	ld hl,(temp_hl2) ;࠭ ᠭ ⮪
 655++7036 3A B0 73     	ld a,(sec_part)
 656++7039 47           	ld b,a
 657++703A 0E 00        	ld c,0
 658++703C 09           	add hl,bc
 659++703D 11 00 51     	ld de,sec_buf
 660++7040 01 00 01     	ld bc,256
 661++7043 ED B0        	ldir
 662++7045              ;fwrite_trd2
 663++7045
 664++7045
 665++7045              fwrite_trd_ex
 666++7045 ED 4B A8 73  	ld bc,(temp_bc) ;⨬,  ᪮쪮 訢, ⮫쪮  ᠫ 
 667++7049              	;⠥   ᠭ
 668++7049 2A A3 73     	ld hl,(f_w_len)
 669++704C 09           	add hl,bc
 670++704D 22 A3 73     	ld (f_w_len),hl
 671++7050 30 07        	jr nc,fwrite_trd_ex1
 672++7052 2A A5 73     	ld hl,(f_w_len+2)
 673++7055 23           	inc hl
 674++7056 22 A5 73     	ld (f_w_len+2),hl
 675++7059
 676++7059              fwrite_trd_ex1
 677++7059 AF           	xor a ;䫠 ᨬ
 678++705A C9               ret
 679++705B
 680++705B
 681++705B
 682++705B
 683++705B
 684++705B              ;------------------scl----------------------
 685++705B              fwrite_chek_scl ; scl 䠩 (ࠧ稢 ࠧ, id=4)
 686++705B              	; ld a,2
 687++705B              	; out (254),a
 688++705B              ; WAITKEY_t	XOR A:IN A,(#FE):CPL:AND #1F:JR Z,WAITKEY_t
 689++705B              	; xor a
 690++705B              	; out (254),a
 691++705B 3A A2 73     	ld a,(f_w_flag)
 692++705E B7           	or a
 693++705F CA 72 6F     	jp z,fwrite_no_chek ;䠩 㦥 ?
 694++7062 ED 43 A8 73  	ld (temp_bc),bc ;
 695++7066 22 AA 73     	ld (temp_hl),hl ; 
 696++7069 78           	ld a,b
 697++706A B1           	or c
 698++706B CA 72 6F     	jp z,fwrite_no_chek ; ᫨  0,  室
 699++706E
 700++706E              	; ld a,b
 701++706E              	; or a
 702++706E              	; jr nz,testt1
 703++706E              	; nop
 704++706E
 705++706E              ; testt1
 706++706E
 707++706E AF           	xor a
 708++706F 32 B0 73     	ld (sec_part),a ;㫨 ६
 709++7072 32 AF 73     	ld (sec_shift2),a
 710++7075 32 B0 73     	ld (sec_shift2+1),a
 711++7078 32 B1 73     	ld (sec_shift_flag),a
 712++707B 32 A7 73     	ld (write_end_flag),a ;
 713++707E
 714++707E
 715++707E 3A AE 73     	ld a,(sec_shift)
 716++7081 B7           	or a
 717++7082 28 38        	jr z,fwrite_scl3 ;᫨ ᬥ饭 ,    ய⨬
 718++7084
 719++7084
 720++7084 4F           	ld c,a
 721++7085 06 00        	ld b,0
 722++7087 2A A8 73     	ld hl,(temp_bc) ;஢ઠ   楫 ᥪ
 723++708A 09           	add hl,bc
 724++708B
 725++708B 3E 01        	ld a,1
 726++708D 32 A7 73     	ld (write_end_flag),a ;䫠   㦭 뢠 ⮪
 727++7090
 728++7090 7C           	ld a,h
 729++7091 B7           	or a
 730++7092 20 05        	jr nz,fwrite_scl4
 731++7094 3E 01        	ld a,1
 732++7096 32 B1 73     	ld (sec_shift_flag),a ;䫠    ᥪ
 733++7099
 734++7099              fwrite_scl4
 735++7099 21 00 51     	ld hl,sec_buf ; ᫥ ᥪ
 736++709C 09           	add hl,bc ; ⮩ 窥 ⠭
 737++709D EB           	ex de,hl
 738++709E 2A AA 73     	ld hl,(temp_hl) ;ᮥ 砫    ।
 739++70A1              	; ld a,c
 740++70A1              	; or a
 741++70A1              	; jr nz,fwrite_scl2
 742++70A1              	; inc b ;४
 743++70A1              ; fwrite_scl2
 744++70A1              	; ld c,a
 745++70A1 AF           	xor a
 746++70A2 91           	sub c
 747++70A3 4F           	ld c,a ;᪮쪮 ⠫ ७   ᥪ
 748++70A4 ED 43 AF 73  	ld (sec_shift2),bc ;࠭ ᪮쪮  
 749++70A8 ED B0        	ldir
 750++70AA
 751++70AA 3A B1 73     	ld a,(sec_shift_flag)
 752++70AD B7           	or a
 753++70AE 20 0C        	jr nz,fwrite_scl3 ;᫨ ᥪ      㤥
 754++70B0
 755++70B0 21 00 51     	ld hl,sec_buf
 756++70B3              	;ld de,(#5cf4)
 757++70B3              	;ld (f_w_cur_trk),de	; 
 758++70B3 06 01            ld      b,#01 ;襬 1 ᥪ  
 759++70B5 CD 20 71         call    scl_write_buf
 760++70B8              	; ld a,c
 761++70B8              	; cp 255
 762++70B8              	; jp z,fwrite_no_chek ;室 ᫨ 訡
 763++70B8
 764++70B8 AF           	xor a
 765++70B9 32 A7 73     	ld (write_end_flag),a ;䫠  㦭 뢠 ⮪
 766++70BC              	; ld de,(f_w_cur_trk) ;᫨ ᥪ   , ⠭  ன 樨
 767++70BC              	; ld (#5cf4),de
 768++70BC              	; ld b,1 ; ᥪ 
 769++70BC              	; ld de,(f_w_cur_trk)
 770++70BC              	; call calc_next_pos
 771++70BC              	; ld (f_w_cur_trk),de
 772++70BC
 773++70BC              fwrite_scl3
 774++70BC 2A AA 73     	ld hl,(temp_hl) ;襬 ⮪ 
 775++70BF              	;ld a,(sec_shift)
 776++70BF              	;ld c,a
 777++70BF              	;ld b,0
 778++70BF ED 4B AF 73  	ld bc,(sec_shift2)
 779++70C3 09           	add hl,bc ; ⮩ 窨 襬
 780++70C4 22 AC 73     	ld (temp_hl2),hl ;࠭ 砫  ண ᥪ
 781++70C7
 782++70C7 2A A8 73     	ld hl,(temp_bc) ;᫥   ⠭   ࠧ
 783++70CA A7           	and a
 784++70CB ED 42        	sbc hl,bc ;⥬ ,    ࢮ ᥪ
 785++70CD 4D           	ld c,l
 786++70CE 44           	ld b,h
 787++70CF 30 02        	jr nc,fwrite_scl5
 788++70D1 06 00        	ld b,0 ;४ ᫨ 襫 
 789++70D3              fwrite_scl5
 790++70D3 2A AA 73     	ld hl,(temp_hl)
 791++70D6 09           	add hl,bc
 792++70D7
 793++70D7 11 D0 9F     	ld de,outputBuffer
 794++70DA A7           	and a
 795++70DB ED 52        	sbc hl,de
 796++70DD
 797++70DD 7D           	ld a,l
 798++70DE 32 AE 73     	ld (sec_shift),a ;ᬥ饭  ᫥騩 ࠧ
 799++70E1              	;ld hl,(temp_hl)
 800++70E1
 801++70E1
 802++70E1              	; or a
 803++70E1              	; jr z,fwrite_scl1
 804++70E1              	; inc b  ;४ ⢠ ᥪ஢
 805++70E1
 806++70E1 78           	ld a,b ;㦭 ஢ઠ  ⢮ ᥪ஢!!!
 807++70E2 32 B0 73     	ld (sec_part),a ; ᪮쪮 ᥪ஢  ன 
 808++70E5
 809++70E5              	;ld a,b
 810++70E5 B7           	or a
 811++70E6 28 0A        	jr z,fwrite_scl1 ;᫨ ࠧ   ᥪ,  ய⨬ 
 812++70E8
 813++70E8 2A AC 73     	ld hl,(temp_hl2)
 814++70EB              	;push bc
 815++70EB              	;ld de,(#5cf4)
 816++70EB                  ;ld      c,6 ;襬 楫묨 ᥪࠬ
 817++70EB CD 20 71         call    scl_write_buf
 818++70EE              	;ld a,c
 819++70EE              	;pop bc
 820++70EE              	; cp 255
 821++70EE              	; jp z,fwrite_no_chek ;室 ᫨ 訡
 822++70EE              	; ld de,(f_w_cur_trk)
 823++70EE              	; call calc_next_pos
 824++70EE              	; ld (f_w_cur_trk),de
 825++70EE
 826++70EE AF           	xor a
 827++70EF 32 A7 73     	ld (write_end_flag),a ;䫠  㦭 뢠 ⮪
 828++70F2
 829++70F2              fwrite_scl1
 830++70F2 3A A7 73     	ld a,(write_end_flag) ;㦭 뢠 ⮪?
 831++70F5 B7           	or a
 832++70F6 20 12        	jr nz,fwrite_scl_ex ; 㦭
 833++70F8
 834++70F8 2A AC 73     	ld hl,(temp_hl2) ;࠭ ᠭ ⮪
 835++70FB 3A B0 73     	ld a,(sec_part)
 836++70FE 47           	ld b,a
 837++70FF 0E 00        	ld c,0
 838++7101 09           	add hl,bc
 839++7102 11 00 51     	ld de,sec_buf
 840++7105 01 00 01     	ld bc,256
 841++7108 ED B0        	ldir
 842++710A              ;fwrite_scl2
 843++710A
 844++710A
 845++710A              fwrite_scl_ex
 846++710A ED 4B A8 73  	ld bc,(temp_bc) ;⨬,  ᪮쪮 訢, ⮫쪮  ᠫ 
 847++710E              	;⠥   ᠭ
 848++710E 2A A3 73     	ld hl,(f_w_len)
 849++7111 09           	add hl,bc
 850++7112 22 A3 73     	ld (f_w_len),hl
 851++7115 30 07        	jr nc,fwrite_scl_ex1
 852++7117 2A A5 73     	ld hl,(f_w_len+2)
 853++711A 23           	inc hl
 854++711B 22 A5 73     	ld (f_w_len+2),hl
 855++711E
 856++711E              fwrite_scl_ex1
 857++711E AF           	xor a ;䫠 ᨬ
 858++711F C9               ret
 859++7120
 860++7120
 861++7120
 862++7120
 863++7120
 864++7120
 865++7120              scl_write_buf ; ஬筮 
 866++7120 C5           	push bc ;᪮쪮 ⮢ 㪠  b
 867++7121 11 00 53     	ld de,scl_buf ;७ ᥪ  ६ 
 868++7124 01 00 01     	ld bc,256
 869++7127 ED B0        	ldir
 870++7129 22 D2 73     	ld (scl_temp_hl2),hl ;࠭  
 871++712C 3A BA 73     	ld a,(scl_que) ;஢ਬ 䫠  㦭 
 872++712F B7           	or a
 873++7130 28 08        	jr z,scl_write_buf_ret ; 㤥 뢠  ᫨  㦭
 874++7132 21 3A 71     	ld hl,scl_write_buf_ret ; 
 875++7135 E5           	push hl
 876++7136 2A CC 73     	ld hl,(scl_parse_ret_adr) ;  த ᭮ 横 ᡮન
 877++7139 E9           	jp (hl) ;⤠  256  
 878++713A              scl_write_buf_ret
 879++713A 2A D2 73     	ld hl,(scl_temp_hl2)
 880++713D C1           	pop bc
 881++713E 10 E0        	djnz scl_write_buf
 882++7140
 883++7140 C9           	ret
 884++7141
 885++7141
 886++7141
 887++7141              scl_parse ;ࠧ ࠧ scl  trd, ᭮ 横
 888++7141              	;  ᥪ
 889++7141              ; 樨   256 
 890++7141 22 D0 73     	ld (scl_temp_hl),hl
 891++7144 ED 53 D4 73  	ld (scl_temp_de),de
 892++7148 ED 43 D6 73  	ld (scl_temp_bc),bc
 893++714C 3E 01        	ld a,1
 894++714E 32 BA 73     	ld (scl_que),a ;稬 䫠  㦭 
 895++7151 21 58 71     	ld hl,scl_parse_ret ;࠭  
 896++7154 22 CC 73     	ld (scl_parse_ret_adr),hl
 897++7157 C9           	ret ;   
 898++7158              scl_parse_ret
 899++7158 AF           	xor a
 900++7159 32 BA 73     	ld (scl_que),a
 901++715C 2A D0 73     	ld hl,(scl_temp_hl)
 902++715F ED 5B D4 73  	ld de,(scl_temp_de)
 903++7163 ED 4B D6 73  	ld bc,(scl_temp_bc)
 904++7167
 905++7167 11 00 53     	ld de,scl_buf ;஢ઠ ⪨ ࠧ
 906++716A 21 B2 73     	ld hl,scl_sign
 907++716D 06 08        	ld b,8
 908++716F              scl_parse_chk
 909++716F 1A           	ld a,(de)
 910++7170 BE           	cp (hl)
 911++7171 20 06        	jr nz,scl_parse_chk_no
 912++7173 23           	inc hl
 913++7174 13           	inc de
 914++7175 10 F8        	djnz scl_parse_chk
 915++7177 18 10        	jr scl_parse_chk_ok
 916++7179              scl_parse_chk_no ;᫨  ᮢ,  宩 ࠧ
 917++7179 21 BB 73         ld hl, scl_err
 918++717C CD 3E 6A         call DialogBox.msgBox ;।०
 919++717F AF           	xor a
 920++7180 32 BA 73     	ld (scl_que),a ;몫稬 䫠  㦭 
 921++7183 3E 04        	ld a,4 ;஥ 䠩
 922++7185 CD 36 6E     	call fclose
 923++7188 C9           	ret
 924++7189              scl_parse_chk_ok ;ᨣ ࠢ쭠
 925++7189
 926++7189              ;ନ஢ ⠫
 927++7189 3A 08 53     	ld a,(scl_buf+8)
 928++718C 32 CF 73     	ld (scl_files),a ;ᥣ 䠩
 929++718F 32 CE 73     	ld (scl_cat_cycl),a ;横
 930++7192 21 09 53     	ld hl,scl_buf+9 ; ࢮ 
 931++7195 11 00 48     	ld de,cat_buf ; ନ㥬 ⠫ trd
 932++7198              scl_parse_cat2
 933++7198 06 0E        	ld b,14 ;14   
 934++719A              scl_parse_cat
 935++719A 7E           	ld a,(hl)
 936++719B 12           	ld (de),a
 937++719C 13           	inc de
 938++719D 2C           	inc l ; 㢥稢 ⮫쪮  । 襣 ॣ
 939++719E 20 26        	jr nz,scl_parse_cat1
 940++71A0              	;   ᫥騩 ᥪ
 941++71A0              ; 樨   256 
 942++71A0 22 D0 73     	ld (scl_temp_hl),hl
 943++71A3 ED 53 D4 73  	ld (scl_temp_de),de
 944++71A7 ED 43 D6 73  	ld (scl_temp_bc),bc
 945++71AB 3E 01        	ld a,1
 946++71AD 32 BA 73     	ld (scl_que),a ;稬 䫠  㦭 
 947++71B0 21 B7 71     	ld hl,scl_parse_ret1 ;࠭  
 948++71B3 22 CC 73     	ld (scl_parse_ret_adr),hl
 949++71B6 C9           	ret ;   
 950++71B7              scl_parse_ret1
 951++71B7 AF           	xor a
 952++71B8 32 BA 73     	ld (scl_que),a
 953++71BB 2A D0 73     	ld hl,(scl_temp_hl)
 954++71BE ED 5B D4 73  	ld de,(scl_temp_de)
 955++71C2 ED 4B D6 73  	ld bc,(scl_temp_bc)
 956++71C6
 957++71C6              scl_parse_cat1
 958++71C6 10 D2        	djnz scl_parse_cat
 959++71C8 13           	inc de
 960++71C9 13           	inc de
 961++71CA 3A CE 73     	ld a,(scl_cat_cycl)
 962++71CD 3D           	dec a
 963++71CE 32 CE 73     	ld (scl_cat_cycl),a
 964++71D1 20 C5        	jr nz,scl_parse_cat2
 965++71D3
 966++71D3 22 D0 73     	ld (scl_temp_hl),hl ;  ⠭
 967++71D6
 968++71D6              ; ᥪ஢  ஦
 969++71D6 DD E5        	push ix
 970++71D8 3A CF 73     	ld a,(scl_files)
 971++71DB 11 00 01     	ld de,#0100 ;  ࢮ ஦
 972++71DE DD 21 00 48  	ld ix,cat_buf
 973++71E2 DD 73 0E     	ld (ix+14),e
 974++71E5 DD 72 0F     	ld (ix+15),d
 975++71E8 21 00 00     	ld hl,0 ;饥 ⢮ ᥪ஢
 976++71EB              scl_cacl
 977++71EB 32 CE 73     	ld (scl_cat_cycl),a ;横
 978++71EE DD 7E 0D     	ld a,(ix+13) ; 䠩  ᥪ
 979++71F1 4F           	ld c,a
 980++71F2 06 00        	ld b,0
 981++71F4 09           	add hl,bc ;ᥪ஢
 982++71F5
 983++71F5 01 10 00     	ld bc,16
 984++71F8 DD 09        	add ix,bc
 985++71FA 47           	ld b,a
 986++71FB CD 2F 73     	call calc_next_pos
 987++71FE 3A CE 73     	ld a,(scl_cat_cycl)
 988++7201 FE 01        	cp 1
 989++7203 28 06        	jr z,scl_cacl2 ; ᫥ ࠧ யᨬ
 990++7205 DD 73 0E     	ld (ix+14),e
 991++7208 DD 72 0F     	ld (ix+15),d
 992++720B              scl_cacl2
 993++720B 3D           	dec a
 994++720C 20 DD        	jr nz,scl_cacl
 995++720E              	;⥯ 㧭  ᢮ ᥪ
 996++720E DD 7E 0D     	ld a,(ix+13) ; 䠩  ᥪ
 997++7211 4F           	ld c,a
 998++7212 06 00        	ld b,0
 999++7214 09           	add hl,bc
1000++7215              	; ld b,a
1001++7215              	; call calc_next_pos
1002++7215 ED 53 E1 50  	ld (cat_buf+8*256+#e1),de ; ᢮ ᥪ  ஦  ᪥
1003++7219 11 F0 09     	ld de,16*159
1004++721C EB           	ex de,hl
1005++721D A7           	and a
1006++721E ED 52        	sbc hl,de
1007++7220 22 E5 50     	ld (cat_buf+8*256+#e5),hl ;᫮ ᢮ ᥪ஢  ᪥
1008++7223 DD E1        	pop ix
1009++7225
1010++7225
1011++7225
1012++7225              ; ᮤন 䠩
1013++7225 3A CF 73     	ld a,(scl_files) ;ᥣ 䠩
1014++7228 32 CE 73     	ld (scl_cat_cycl),a ;横
1015++722B 21 0D 48     	ld hl,cat_buf+13 ; ࠧ ᥪ஢ 䠩
1016++722E 22 D8 73     	ld (cat_cur_adr),hl
1017++7231
1018++7231 21 00 01     	ld hl,#0100 ;稭  ࢮ ஦
1019++7234 22 F4 5C     	ld (#5cf4),hl
1020++7237              scl_parse_file2
1021++7237 2A D0 73     	ld hl,(scl_temp_hl) ; 
1022++723A ED 5B D8 73  	ld de,(cat_cur_adr) ; ᥪ ஦ 䠩
1023++723E              	;dec de
1024++723E 1A           	ld a,(de) ;⢮ ᥪ஢, 横
1025++723F 4F           	ld c,a
1026++7240              scl_parse_file3
1027++7240 11 00 55     	ld de,scl_buf2 ;   
1028++7243 06 00        	ld b,0 ;256   ᥪ, 横
1029++7245              scl_parse_file
1030++7245 7E           	ld a,(hl)
1031++7246 12           	ld (de),a
1032++7247 13           	inc de
1033++7248 2C           	inc l ; 㢥稢 ⮫쪮  । 襣 ॣ
1034++7249 20 26        	jr nz,scl_parse_file1
1035++724B              	;   ᫥騩 ᥪ
1036++724B              ; 樨   256 
1037++724B 22 D0 73     	ld (scl_temp_hl),hl
1038++724E ED 53 D4 73  	ld (scl_temp_de),de
1039++7252 ED 43 D6 73  	ld (scl_temp_bc),bc
1040++7256 3E 01        	ld a,1
1041++7258 32 BA 73     	ld (scl_que),a ;稬 䫠  㦭 
1042++725B 21 62 72     	ld hl,scl_parse_ret2 ;࠭  
1043++725E 22 CC 73     	ld (scl_parse_ret_adr),hl
1044++7261 C9           	ret ;   
1045++7262              scl_parse_ret2
1046++7262 AF           	xor a
1047++7263 32 BA 73     	ld (scl_que),a
1048++7266 2A D0 73     	ld hl,(scl_temp_hl)
1049++7269 ED 5B D4 73  	ld de,(scl_temp_de)
1050++726D ED 4B D6 73  	ld bc,(scl_temp_bc)
1051++7271
1052++7271              scl_parse_file1
1053++7271 10 D2        	djnz scl_parse_file
1054++7273 22 D0 73     	ld (scl_temp_hl),hl
1055++7276 ED 43 D6 73  	ld (scl_temp_bc),bc
1056++727A
1057++727A 21 00 55     	ld hl,scl_buf2 ;;襬  ᥪ
1058++727D ED 5B F4 5C  	ld  de,(#5cf4)
1059++7281 01 06 01         ld      bc,#0106 ;
1060++7284 CD 32 6E         call    call3d13
1061++7287              	; ld a,c
1062++7287              	; cp 255
1063++7287              	; jp z,fwrite_no_chek ;室 ᫨ 訡
1064++7287 2A D0 73     	ld hl,(scl_temp_hl)
1065++728A ED 4B D6 73  	ld bc,(scl_temp_bc)
1066++728E
1067++728E 0D           	dec c
1068++728F 20 AF        	jr nz,scl_parse_file3
1069++7291
1070++7291 2A D8 73     	ld hl,(cat_cur_adr) ; ᥪ ஦ 䠩
1071++7294              	; ld e,(hl)
1072++7294              	; inc hl
1073++7294              	; ld d,(hl)
1074++7294 01 10 00     	ld bc,16
1075++7297 09           	add hl,bc ; ᫥騩 䠩
1076++7298 22 D8 73     	ld (cat_cur_adr),hl
1077++729B
1078++729B
1079++729B 3A CE 73     	ld a,(scl_cat_cycl)
1080++729E 3D           	dec a
1081++729F 32 CE 73     	ld (scl_cat_cycl),a
1082++72A2 20 93        	jr nz,scl_parse_file2	; ᫥騩 䠩
1083++72A4
1084++72A4
1085++72A4
1086++72A4              ;ନ஢ ⥬ ᥪ 9 (8)
1087++72A4              	;
1088++72A4              	;ld (cat_buf+8*256+#e1),a ;// #E1  ᢮ ᥪ  ᪥
1089++72A4              	;
1090++72A4              	;ld (cat_buf+8*256+#e2),a ;// #E2  ᢮ ४
1091++72A4 3E 16        	ld a,#16
1092++72A6 32 E3 50     	ld (cat_buf+8*256+#e3),a ;// #E3 16 80 ஦, 2 ஭
1093++72A9 3A CF 73     	ld a,(scl_files)
1094++72AC 32 E4 50     	ld (cat_buf+8*256+#e4),a ;// #E4 饥 ⢮ 䠩 ᠭ  
1095++72AF              	;
1096++72AF              	;ld (cat_buf+8*256+#e5),a ;// #5,6 ᫮ ᢮ ᥪ஢  ᪥
1097++72AF              	;ld (cat_buf+8*256+#e6),a
1098++72AF 3E 10        	ld a,#10
1099++72B1 32 E7 50     	ld (cat_buf+8*256+#e7),a ;// #E7   #10,।騩 ਭ  TR-DOS
1100++72B4
1101++72B4 21 89 73     	ld hl,f_name ;襬  ᪠,   ⮣  䠩
1102++72B7 11 F5 50     	ld de,cat_buf+8*256+#f5 ;// #F5-#FC  ᪠  ASCII ଠ
1103++72BA 01 08 00     	ld bc,8
1104++72BD ED B0        	ldir
1105++72BF
1106++72BF 21 00 48     	ld hl,cat_buf ;襬 ⠫  
1107++72C2 11 00 00     	ld de,0
1108++72C5 01 06 09         ld      bc,#0906 ;
1109++72C8 CD 32 6E         call    call3d13
1110++72CB              	; ld a,c
1111++72CB              	; cp 255
1112++72CB              	; jp z,fwrite_no_chek ;室 ᫨ 訡
1113++72CB C9           	ret
1114++72CC
1115++72CC
1116++72CC              ;-----------scl end --------------------
1117++72CC
1118++72CC
1119++72CC
1120++72CC
1121++72CC
1122++72CC
1123++72CC
1124++72CC
1125++72CC
1126++72CC
1127++72CC              ; A - file stream id
1128++72CC              ; fsync:
1129++72CC              ;     esxCall ESX_FSYNC
1130++72CC                  ; ret
1131++72CC
1132++72CC
1133++72CC              ; HL - name (name.ext)
1134++72CC              ; Returns:
1135++72CC              ; HL - name (name    e)
1136++72CC              format_name ;  䠩  ⠭ trdos (8+1)
1137++72CC
1138++72CC              	;᭠砫 ஡㥬    , ᫨  
1139++72CC 22 AA 73     	ld (temp_hl),hl ;࠭  室 
1140++72CF 06 00        	ld b,#00 ;  255 ᨬ
1141++72D1              format_name5
1142++72D1 7E           	ld a,(hl)
1143++72D2 FE 2F        	cp "/" ;᫨  
1144++72D4 28 0D        	jr z,format_name_path_yep
1145++72D6 7E           	ld a,(hl)
1146++72D7 FE 2E        	cp "." ;᫨   諨  ७
1147++72D9 20 05        	jr nz,format_name6
1148++72DB 2A AA 73     	ld hl,(temp_hl) ;᫨ 諨  ७,  ⥩ ,   砫 
1149++72DE 18 04        	jr format_name_7 ; 室
1150++72E0              format_name6
1151++72E0 23           	inc hl
1152++72E1 10 EE        	djnz format_name5
1153++72E3
1154++72E3              format_name_path_yep ;諨
1155++72E3 23           	inc hl ;ய⨬  "/"
1156++72E4
1157++72E4              format_name_7
1158++72E4
1159++72E4 E5           	push hl ;⨬    
1160++72E5 21 89 73     	ld hl,f_name
1161++72E8 11 8A 73     	ld de,f_name+1
1162++72EB 36 20        	ld (hl)," "
1163++72ED 01 09 00     	ld bc,8+1
1164++72F0 ED B0        	ldir
1165++72F2 36 00        	ld (hl),0
1166++72F4 01 06 00     	ld bc,16-8-1-1
1167++72F7 ED B0        	ldir
1168++72F9 E1           	pop hl
1169++72FA
1170++72FA 01 FF 09     	ld bc,#09ff ;  9 ᨬ
1171++72FD 11 89 73     	ld de,f_name ;㤠
1172++7300              format_name2
1173++7300 7E           	ld a,(hl)
1174++7301 FE 2E        	cp "."
1175++7303 20 0C        	jr nz,format_name1
1176++7305 11 91 73     	ld de,f_name+8
1177++7308 23           	inc hl
1178++7309 ED A0        	ldi ;    ७ 3 㪢
1179++730B ED A0        	ldi
1180++730D ED A0        	ldi
1181++730F              	;ex de,hl ;࠭  室 ७
1182++730F 18 1A        	jr format_name_e
1183++7311              format_name1
1184++7311 ED A0        	ldi
1185++7313 10 EB        	djnz format_name2
1186++7315
1187++7315              	;᫨  , ய⨬ 譥  ७
1188++7315 06 00        	ld b,#00 ;  255 ᨬ
1189++7317              format_name3
1190++7317 7E           	ld a,(hl)
1191++7318 FE 2E        	cp "."
1192++731A 20 0C        	jr nz,format_name4
1193++731C 11 91 73     	ld de,f_name+8
1194++731F 23           	inc hl
1195++7320 ED A0        	ldi ;    ७ 3 㪢
1196++7322 ED A0        	ldi
1197++7324 ED A0        	ldi
1198++7326              	;ex de,hl ;࠭  室 ७
1199++7326 18 03        	jr format_name_e
1200++7328              format_name4
1201++7328 23           	inc hl
1202++7329 10 EC        	djnz format_name3
1203++732B
1204++732B              format_name_e ;室
1205++732B 21 89 73     	ld hl,f_name ; १
1206++732E C9           	ret
1207++732F
1208++732F              ; DE - trk/sec
1209++732F              ; B - sectors step
1210++732F              ; Returns:
1211++732F              ; DE - trk/sec
1212++732F              calc_next_pos		;  N ᥪ஢
1213++732F              			;ld b,4
1214++732F              			;ld  de,(#5ceb)
1215++732F              calc_next_pos2
1216++732F 1C           			inc e
1217++7330 7B           			ld a,e
1218++7331 FE 10        			cp 16
1219++7333 38 03        			jr c,calc_next_pos1
1220++7335 14           			inc d
1221++7336 1E 00        			ld e,0
1222++7338              calc_next_pos1
1223++7338              			;ld (#5ceb),de
1224++7338 10 F5        			djnz calc_next_pos2
1225++733A C9           			ret
1226++733B
1227++733B
1228++733B              ;testt db "123.trd"
1229++733B 53 65 6C 65  write_ima db "Select disk "
1229++733F 63 74 20 64
1229++7343 69 73 6B 20
1230++7347 41 3A 20 28  write_ima_d db "A: (A-D). "
1230++734B 41 2D 44 29
1230++734F 2E 20
1231++7351 41 6C 6C 20  		db "All data may be lost! Press Y or N.",0
1231++7355 64 61 74 61
1231++7359 20 6D 61 79
1231++735D 20 62 65 20
1231++7361 6C 6F 73 74
1231++7365 21 20 50 72
1231++7369 65 73 73 20
1231++736D 59 20 6F 72
1231++7371 20 4E 2E 00
1232++7375              ;prev_drive db 0 ;।騩  ᪮
1233++7375
1234++7375 2E 74 72 64  trdExt1 db ".trd", 0
1234++7379 00
1235++737A 2E 54 52 44  trdExt2 db ".TRD", 0
1235++737E 00
1236++737F
1237++737F 2E 73 63 6C  sclExt1 db ".scl", 0
1237++7383 00
1238++7384 2E 53 43 4C  sclExt2 db ".SCL", 0
1238++7388 00
1239++7389
1240++7389 00 00 00...  f_name ds 16 ; 䠩
1241++7399 00 00        f_r_cur_trk dw 	 0 ;⥪騥 ᥪ-஦ 䠩  ⥭
1242++739B 00           f_r_len_sec db 0 ; 䠩  ⥭  ᥪ
1243++739C 00 00        f_r_len dw 0; 䠩  
1244++739E 00           f_r_flag db 0 ;䫠   䠩  ⥭
1245++739F
1246++739F 00 00        f_w_cur_trk dw 	 0 ;⥪騥 ᥪ-஦ 䠩  
1247++73A1 00           f_w_len_sec db 0 ; 䠩    ᥪ
1248++73A2 00           f_w_flag db 0 ;䫠   䠩  
1249++73A3 00 00 00 00  f_w_len ds 4 ; ᠭ 
1250++73A7 00           write_end_flag db 0 ;䫠  㦭  ⮪
1251++73A8
1252++73A8 00 00        temp_bc dw 0 ;࠭ ॣ
1253++73AA 00 00        temp_hl dw 0 ;࠭ ॣ
1254++73AC 00 00        temp_hl2 dw 0 ;࠭ ॣ
1255++73AE
1256++73AE 00           sec_shift db 0 ;㪠⥫    ⠭ 
1257++73AF 00           sec_shift2 db 0 ;㪠⥫    ⠭  (⮪)
1258++73B0 00           sec_part db 0 ;᪮쪮 ᥪ஢  ன 樨  
1259++73B1 00           sec_shift_flag db 0 ;䫠   ᥪ  
1260++73B2
1261++73B2              ;ᥪ scl
1262++73B2 53 49 4E 43  scl_sign db "SINCLAIR" ;⪠
1262++73B6 4C 41 49 52
1263++73BA 00           scl_que db 0 ;䫠  樨 
1264++73BB 53 43 4C 20  scl_err db "SCL image error!",0
1264++73BF 69 6D 61 67
1264++73C3 65 20 65 72
1264++73C7 72 6F 72 21
1264++73CB 00
1265++73CC 00 00        scl_parse_ret_adr dw 0;    横
1266++73CE 00           scl_cat_cycl db 0 ;६ 横
1267++73CF 00           scl_files db 0 ;ᥣ 䠩
1268++73D0 00 00        scl_temp_hl dw 0;;࠭ ॣ
1269++73D2 00 00        scl_temp_hl2 dw 0;
1270++73D4 00 00        scl_temp_de dw 0;
1271++73D6 00 00        scl_temp_bc dw 0;
1272++73D8 00 00        cat_cur_adr dw 0;
1273++73DA              ;scl end
1274++73DA
1275++73DA              ;ᥪ ࠭  䠩
1276++73DA 4E 6F 74 20  file_err db "Not enough space!",0
1276++73DE 65 6E 6F 75
1276++73E2 67 68 20 73
1276++73E6 70 61 63 65
1276++73EA 21 00
1277++73EC 00           sec_cat db 0 ;ᥪ ⠫
1278++73ED 30           file_num db "0" ;    䠩
1279++73EE
1280++73EE              	;  #4000 
1281++73EE              cat_buf equ #4800 ;  ⮣ ᪠ 9*256
1282++73EE              sec_buf equ cat_buf + 9*256 ; ᥪ   256
1283++73EE              scl_buf equ sec_buf + 512 ;஬  256
1284++73EE              scl_buf2 equ scl_buf + 512 ;஬  256
1285++73EE
1286++73EE                  ENDMODULE
# file closed: dos/trdos.asm
   9++73EE              	ENDIF
  10++73EE
  11++73EE              	IFDEF ESXDOS
  12++73EE ~               		include "console.asm"
  13++73EE ~               		include "esxdos.asm"
  14++73EE              	ENDIF
  15++73EE
  16++73EE              	IFDEF P3DOS
  17++73EE ~               		include "console.asm"
  18++73EE ~               		include "p3dos.asm"
  19++73EE              	ENDIF
  20++73EE
# file closed: dos/index.asm
  19+ 73EE                  include "gopher/engine/history/index.asm"
# file opened: gopher/engine/history/index.asm
   1++73EE                  include "controler.asm"
# file opened: gopher/engine/history/controler.asm
   1++73EE                  module History
   2++73EE              back:
   3++73EE 3A 2E 75         ld a, (depth)
   3++73F1 FE 01          cp 1
   3++73F3 CA 05 74       jp z, load
   4++73F6 21 7D 78 11      ld hl, historyBlock + HistoryRecord, de, historyBlock, bc, (total - 1) * HistoryRecord
   4++73FA 2F 75 01 38
   4++73FE 0D
   4++73FF ED B0          ldir ; Move history up
   5++7401 21 2E 75         ld hl, depth
   5++7404 35             dec (hl)
   6++7405              ; Loads current resource
   7++7405              load:
   8++7405 21 22 74         ld hl, .msg
   8++7408 CD 47 6A       call DialogBox.msgNoWait
   9++740B AF               xor a
   9++740C 21 D0 9F 11    ld hl, outputBuffer, de, outputBuffer + 1
   9++7410 D1 9F
  10++7412              	IFDEF MSX
  11++7412 ~                	ld bc, (ramtop)
  12++7412 ~                	dec bc
  13++7412              	ELSE
  14++7412 01 2E 60         	ld bc, #ffff - outputBuffer - 1
  15++7415              	ENDIF
  16++7415
  17++7415 77               ld (hl), a
  18++7416 ED B0            ldir
  19++7418
  20++7418 3A 2F 75         ld a, (historyBlock.isFile)
  20++741B A7             and a
  20++741C C2 19 8A       jp nz, Fetcher.fetchFromFS
  21++741F C3 CC 89         jp Fetcher.fetchFromNet
  22++7422
  23++7422 20 20 20 20  .msg db "    Loading resource! Please wait! It will be here soon!", 0
  23++7426 4C 6F 61 64
  23++742A 69 6E 67 20
  23++742E 72 65 73 6F
  23++7432 75 72 63 65
  23++7436 21 20 50 6C
  23++743A 65 61 73 65
  23++743E 20 77 61 69
  23++7442 74 21 20 49
  23++7446 74 20 77 69
  23++744A 6C 6C 20 62
  23++744E 65 20 68 65
  23++7452 72 65 20 73
  23++7456 6F 6F 6E 21
  23++745A 00
  24++745B
  25++745B              home:
  26++745B 21 0C 75         ld hl, homePage
  27++745E              ; HL - gopher row
  28++745E              navigate:
  29++745E 54 5D            ld de, hl
  30++7460 CD 44 89         call UrlEncoder.isValidGopherRow
  31++7463 30 A0            jr nc, load ; Not valid - reload last
  32++7465 62 6B            ld hl, de
  33++7467 E5               push hl
  34++7468
  35++7468 E5               push hl
  36++7469 21 B4 85 11      ld hl, HistoryEnd - HistoryRecord, de, HistoryEnd, bc,  HistoryRecord * total
  36++746D 02 89 01 86
  36++7471 10
  36++7472 ED B8          lddr
  37++7474
  38++7474 ED 5B 75 78      ld de, (Render.position), (historyBlock.position + HistoryRecord), de
  38++7478 ED 53 C3 7B
  39++747C                  ; Clean up struct
  40++747C AF               xor a
  40++747D 21 2F 75 11    ld hl, historyBlock, de, historyBlock + 1, bc, historyBlockSize - 1, (hl), a
  40++7481 30 75 01 4D
  40++7485 03 77
  40++7487 ED B0          ldir
  41++7489 E1               pop hl
  42++748A
  43++748A                  ; Fill record
  44++748A 54 5D            ld de, hl
  45++748C CD 03 89         call UrlEncoder.isFile
  46++748F EB               ex hl, de
  47++7490 11 2F 75         ld de, historyBlock
  48++7493 12               ld (de), a
  48++7494 13             inc de
  49++7495 7E               ld a, (hl)
  49++7496 E5 D5          push hl, de
  49++7498 CD 8E 64       call Render.getIcon
  49++749B D1 E1          pop de, hl
  50++749D 12               ld (de), a
  50++749E 13             inc de
  51++749F 3E 09            ld a, 9
  52++74A1
  53++74A1 01 FF 01         ld bc, #1ff
  54++74A4
  55++74A4 ED B1            cpir
  56++74A6              .locatorCopy
  57++74A6 7E               ld a, (hl)
  57++74A7 FE 09          cp 9
  57++74A9 28 05          jr z, 1f
  58++74AB 12               ld (de), a
  58++74AC 23 13          inc hl, de
  59++74AE 18 F6            jr .locatorCopy
  60++74B0              1
  61++74B0 23               inc hl
  61++74B1 AF             xor a
  61++74B2 12             ld (de), a
  62++74B3 11 30 77         ld de, historyBlock.host
  63++74B6              .hostCopy
  64++74B6 7E               ld a, (hl)
  64++74B7 FE 09          cp 9
  64++74B9 28 05          jr z, 1f
  65++74BB 12               ld (de), a
  65++74BC 23 13          inc hl, de
  66++74BE 18 F6            jr .hostCopy
  67++74C0              1
  68++74C0 23               inc hl
  68++74C1 AF             xor a
  68++74C2 12             ld (de), a
  69++74C3 11 70 77         ld de, historyBlock.port
  70++74C6              .portCopy
  71++74C6 7E               ld a, (hl)
  72++74C7 FE 09            cp 9
  72++74C9 28 11          jr z, 1f
  73++74CB FE 0D            cp 13
  73++74CD 28 0D          jr z, 1f
  74++74CF FE 0A            cp 10
  74++74D1 28 09          jr z, 1f
  75++74D3 FE 00            cp 0
  75++74D5 28 05          jr z, 1f
  76++74D7 12               ld (de), a
  76++74D8 23 13          inc hl, de
  77++74DA 18 EA            jr .portCopy
  78++74DC AF           1   xor a
  78++74DD 12             ld (de), a
  79++74DE 21 EE 69 11      ld hl, DialogBox.inputBuffer, de, historyBlock.search, bc, #ff
  79++74E2 76 77 01 FF
  79++74E6 00
  79++74E7 ED B0          ldir
  80++74E9 11 00 00 ED      ld de, 0, (historyBlock.position), de
  80++74ED 53 75 78
  81++74F0 E1               pop hl
  82++74F1 3A 2E 75         ld a, (depth)
  82++74F4 FE 05          cp total
  82++74F6 30 04          jr nc, 1f
  83++74F8 3C               inc a
  83++74F9 32 2E 75       ld (depth), a
  84++74FC              1
  85++74FC 3A 30 75         ld a,(historyBlock.mediaType)
  85++74FF FE 01          cp MIME_DOWNLOAD
  85++7501 CA 1C 8B       jp z, Gopher.download
  86++7504
  87++7504                  ifdef GS
  88++7504 FE 07            cp MIME_MOD
  88++7506 CA BB 8A       jp z, Gopher.loadMod
  89++7509                  endif
  90++7509
  91++7509 C3 05 74         jp load
  92++750C
  93++750C              homePage:
  94++750C              	IFDEF MSX
  95++750C ~                	db "1Home", TAB, "index.gph"
  96++750C ~                	db TAB, "file", TAB, "70", CR, LF, 0
  97++750C                  ELSE
  98++750C 31 48 6F 6D      	db "1Home", TAB, "browser/index.gph"
  98++7510 65 09 62 72
  98++7514 6F 77 73 65
  98++7518 72 2F 69 6E
  98++751C 64 65 78 2E
  98++7520 67 70 68
  99++7523 09 66 69 6C      	db TAB, "file", TAB, "70", CR, LF, 0
  99++7527 65 09 37 30
  99++752B 0D 0A 00
 100++752E                  ENDIF
 101++752E                  endmodule
# file closed: gopher/engine/history/controler.asm
   2++752E                  include "model.asm"
# file opened: gopher/engine/history/model.asm
   1++752E              total   equ 5
   2++752E 00           depth   db 0
   3++752F
   4++752F              historyBlock:
   5++752F 00           .isFile    db  0
   6++7530 00           .mediaType db  0
   7++7531 00 00 00...  .locator   ds  #1ff
   8++7730 00 00 00...  .host      ds  64
   9++7770 00 00 00...  .port      ds  6
  10++7776 00 00 00...  .search    ds  #ff
  11++7875 00 00        .position  dw  #0000    ;position
  12++7877
  13++7877 00 00 00 00      db 0,0,0,0,0,0  ;cursor_position page_offset
  13++787B 00 00
  14++787D
  15++787D              historyBlockSize = $ - historyBlock
  16++787D
  17++787D              HistoryRecord EQU $ - historyBlock
  18++787D                  dup total
  19++787D 00 00 00... >    ds HistoryRecord
  19++7BCB 00 00 00... >    ds HistoryRecord
  19++7F19 00 00 00... >    ds HistoryRecord
  19++8267 00 00 00... >    ds HistoryRecord
  19++85B5 00 00 00... >    ds HistoryRecord
  20++8903                  edup
  21++8903              HistoryEnd equ $ - 1
  22++8903
# file closed: gopher/engine/history/model.asm
# file closed: gopher/engine/history/index.asm
  20+ 8903                  include "gopher/engine/urlencoder.asm"
# file opened: gopher/engine/urlencoder.asm
   1++8903                  MODULE UrlEncoder
   2++8903              ; HL - pointer to line in gopher page
   3++8903              ; C - flag set when it's file
   4++8903              isFile:
   5++8903              .findServerLoop
   6++8903 7E               ld a, (hl)
   6++8904 A7             and a
   6++8905 28 3B          jr z, .notFile
   6++8907 23             inc hl
   7++8908 FE 0D            cp 13
   7++890A 28 36          jr z, .notFile
   8++890C FE 09            cp 9
   8++890E 28 02          jr z, .skipPath
   9++8910 18 F1            jr .findServerLoop
  10++8912              .skipPath
  11++8912 7E               ld a, (hl)
  11++8913 A7             and a
  11++8914 28 2C          jr z, .notFile
  11++8916 23             inc hl
  12++8917 FE 0D            cp 13
  12++8919 28 27          jr z, .notFile
  13++891B FE 09            cp 9
  13++891D 28 02          jr z, .compareServer
  14++891F 18 F1            jr .skipPath
  15++8921              .compareServer
  16++8921 7E               ld a, (hl)
  16++8922 FE 66          cp "f"
  16++8924 20 1C          jr nz, .notFile
  16++8926 23             inc hl
  17++8927 7E               ld a, (hl)
  17++8928 FE 69          cp "i"
  17++892A 20 16          jr nz, .notFile
  17++892C 23             inc hl
  18++892D 7E               ld a, (hl)
  18++892E FE 6C          cp "l"
  18++8930 20 10          jr nz, .notFile
  18++8932 23             inc hl
  19++8933 7E               ld a, (hl)
  19++8934 FE 65          cp "e"
  19++8936 20 0A          jr nz, .notFile
  19++8938 23             inc hl
  20++8939 7E               ld a, (hl)
  20++893A FE 09          cp 9
  20++893C 20 04          jr nz, .notFile
  20++893E 23             inc hl
  21++893F 3E 01            ld a, 1
  22++8941 C9               ret
  23++8942              .notFile
  24++8942 AF               xor a
  25++8943 C9               ret
  26++8944
  27++8944              ; Is enough fields to encode
  28++8944              ; HL - pointer to line in gopher page
  29++8944              ; C - flag set when there is enough fields
  30++8944              isValidGopherRow:
  31++8944 7E               ld a, (hl)
  31++8945 A7             and a
  31++8946 28 FA          jr z, isFile.notFile
  31++8948 23             inc hl
  32++8949 FE 0D            cp 13
  32++894B 28 F5          jr z, isFile.notFile
  33++894D FE 09            cp 9
  33++894F 28 02          jr z, .skipPath
  34++8951 18 F1            jr isValidGopherRow
  35++8953              .skipPath
  36++8953 7E               ld a, (hl)
  36++8954 A7             and a
  36++8955 28 EB          jr z, isFile.notFile
  36++8957 23             inc hl
  37++8958 FE 0D            cp 13
  37++895A 28 E6          jr z, isFile.notFile
  38++895C FE 09            cp 9
  38++895E 28 02          jr z, .skipHost
  39++8960 18 F1            jr .skipPath
  40++8962              .skipHost
  41++8962 7E               ld a, (hl)
  41++8963 A7             and a
  41++8964 28 DC          jr z, isFile.notFile
  41++8966 23             inc hl
  42++8967 FE 0D            cp 13
  42++8969 28 D7          jr z, isFile.notFile
  43++896B FE 09            cp 9
  43++896D 28 02           jr z, .isValid
  44++896F 18 F1            jr .skipHost
  45++8971              .isValid:
  46++8971 37               scf
  47++8972 C9               ret
  48++8973
  49++8973              extractPath:
  50++8973 21 31 75 11      ld hl, historyBlock.locator, de, Gopher.requestbuffer, bc, #ff
  50++8977 12 8C 01 FF
  50++897B 00
  50++897C ED B0          ldir
  51++897E C9               ret
  52++897F
  53++897F              extractHostName:
  54++897F 21 30 77 11      ld hl, historyBlock.host, de, hostName, bc, 64
  54++8983 8C 89 01 40
  54++8987 00
  54++8988 ED B0          ldir
  55++898A C9               ret
  56++898B
  57++898B                  ENDMODULE
  58++898B
  59++898B              ;nameBuffer ds #ff, 0
  60++898B
  61++898B 00                    db 0
  62++898C 00 00 00...  hostName ds 64
# file closed: gopher/engine/urlencoder.asm
  21+ 89CC                  include "gopher/engine/fetcher.asm"
# file opened: gopher/engine/fetcher.asm
   1++89CC                  MODULE Fetcher
   2++89CC
   3++89CC              fetchFromNet:
   4++89CC
   5++89CC              	IFDEF MSX
   6++89CC ~                	call Gopher.makeRequest
   6++89CC ~              jr nz, .error
   7++89CC                  ELSE
   8++89CC CD 93 8A         	call Gopher.makeRequest
   8++89CF 38 06          jr c, .error
   9++89D1                  ENDIF
  10++89D1
  11++89D1 CD AB 8A         call Gopher.loadBuffer
  12++89D4 C3 25 8A         jp MediaProcessor.processResource
  13++89D7              .error
  14++89D7 21 E0 89         ld hl, .err
  14++89DA CD 3E 6A       call DialogBox.msgBox
  15++89DD C3 EE 73         jp History.back
  16++89E0
  17++89E0 44 6F 63 75  .err db "Document fetch error! Check your connection or hostname!", 0
  17++89E4 6D 65 6E 74
  17++89E8 20 66 65 74
  17++89EC 63 68 20 65
  17++89F0 72 72 6F 72
  17++89F4 21 20 43 68
  17++89F8 65 63 6B 20
  17++89FC 79 6F 75 72
  17++8A00 20 63 6F 6E
  17++8A04 6E 65 63 74
  17++8A08 69 6F 6E 20
  17++8A0C 6F 72 20 68
  17++8A10 6F 73 74 6E
  17++8A14 61 6D 65 21
  17++8A18 00
  18++8A19
  19++8A19
  20++8A19              fetchFromFS:
  21++8A19 CD 73 89         call UrlEncoder.extractPath
  22++8A1C              loadFile
  23++8A1C              	IFDEF MSX
  24++8A1C ~                ld de, Gopher.requestbuffer, a, FMODE_NO_WRITE
  25++8A1C ~                call Dos.fopen
  26++8A1C ~                ld a, b, (.fp), a
  27++8A1C ~                ld de, outputBuffer, hl, (ramtop)
  28++8A1C ~                call Dos.fread
  29++8A1C ~                ld a, (.fp), b, a
  30++8A1C ~                call Dos.fclose
  31++8A1C ~                jp MediaProcessor.processResource
  32++8A1C ~            .fp db 0
  33++8A1C              	ELSE
  34++8A1C 21 12 8C         ld hl, Gopher.requestbuffer
  35++8A1F CD CF 6C         call Dos.loadBuffer
  36++8A22 C3 25 8A         jp MediaProcessor.processResource
  37++8A25              	ENDIF
  38++8A25                  ENDMODULE
# file closed: gopher/engine/fetcher.asm
  22+ 8A25                  include "gopher/engine/media-processor.asm"
# file opened: gopher/engine/media-processor.asm
   1++8A25                  MODULE MediaProcessor
   2++8A25              processResource:
   3++8A25 CD 7F 89         call UrlEncoder.extractHostName
   4++8A28 3A 30 75         ld a, (historyBlock.mediaType)
   5++8A2B FE 05            cp MIME_MUSIC
   5++8A2D 28 17          jr z, processPT
   6++8A2F FE 02            cp MIME_LINK
   6++8A31 28 1F          jr z, processPage
   7++8A33 FE 04            cp MIME_INPUT
   7++8A35 28 1B          jr z, processPage
   8++8A37 FE 06            cp MIME_IMAGE
   8++8A39 CA 5A 93       jp z, ScreenViewer.display
   9++8A3C              	ifdef GS
  10++8A3C FE 07            cp MIME_MOD
  10++8A3E 28 0C          jr z, processMOD
  11++8A40              	endif
  12++8A40              ; Fallback to plain text
  13++8A40              processText:
  14++8A40 CD A6 68         call Render.renderPlainTextScreen
  15++8A43 C3 EE 68         jp   Render.plainTextLoop
  16++8A46
  17++8A46              processPT:
  18++8A46 CD 7F 93         call VortexProcessor.play
  19++8A49 C3 EE 73         jp History.back
  20++8A4C
  21++8A4C                  ifdef GS
  22++8A4C              processMOD:
  23++8A4C CD B5 92         call ModProcessor.play
  24++8A4F C3 EE 73         jp History.back
  25++8A52              	endif
  26++8A52
  27++8A52              processPage:
  28++8A52 3A 88 69         ld a, (Render.play_next)
  28++8A55 A7             and a
  28++8A56 20 06          jr nz, .playNext
  29++8A58 CD FA 66         call Render.renderGopherScreen
  30++8A5B C3 49 67         jp   Render.workLoop
  31++8A5E              .playNext
  32++8A5E 21 77 78         ld hl, Render.cursor_position
  33++8A61 34               inc (hl)
  34++8A62 CD FA 66         call Render.renderGopherScreen
  35++8A65 C3 33 67         jp Render.checkBorder
  36++8A68                  ENDMODULE
# file closed: gopher/engine/media-processor.asm
  23+ 8A68                  include "gopher/gopher.asm"
# file opened: gopher/gopher.asm
   1++8A68                  module Gopher
   2++8A68              ; HL - gopher row
   3++8A68              extractRequest:
   4++8A68 21 31 75         ld hl, historyBlock.locator
   5++8A6B 11 12 8C         ld de, requestbuffer
   6++8A6E              .loop
   7++8A6E 7E               ld a, (hl)
   8++8A6F 12               ld (de), a
   9++8A70 23               inc hl
  10++8A71 13               inc de
  11++8A72 FE 00            cp 0
  12++8A74 28 02            jr z, .search
  13++8A76 18 F6            jr .loop
  14++8A78              .search
  15++8A78 1B               dec de
  16++8A79 3A 30 75         ld a, (historyBlock.mediaType)
  17++8A7C FE 04            cp MIME_INPUT
  18++8A7E 20 10            jr nz, .exit
  19++8A80 21 76 77         ld hl, historyBlock.search
  20++8A83 3E 09            ld a, TAB
  21++8A85 12               ld (de), a
  22++8A86 13               inc de
  23++8A87              .searchCopy
  24++8A87 7E               ld a, (hl)
  25++8A88 A7               and a
  25++8A89 28 05          jr z, .exit
  26++8A8B 12               ld (de), a
  27++8A8C 23               inc hl
  27++8A8D 13             inc de
  28++8A8E 18 F7            jr .searchCopy
  29++8A90              .exit
  30++8A90 AF               xor a
  31++8A91 12               ld (de), a
  32++8A92 C9               ret
  33++8A93
  34++8A93
  35++8A93              makeRequest:
  36++8A93 CD 68 8A         call extractRequest
  37++8A96
  38++8A96 21 30 77         ld hl, historyBlock.host
  39++8A99 11 70 77         ld de, historyBlock.port
  40++8A9C CD 27 90         call Wifi.openTCP
  41++8A9F D8               ret c
  42++8AA0
  43++8AA0 21 12 8C         ld hl, requestbuffer
  44++8AA3 CD 17 91         call Wifi.tcpSendZ
  45++8AA6 AF               xor a
  45++8AA7 32 F2 8E       ld (Wifi.closed), a
  46++8AAA C9               ret
  47++8AAB
  48++8AAB
  49++8AAB              loadBuffer:
  50++8AAB 21 D0 9F         ld hl, outputBuffer
  51++8AAE 22 F0 8E         ld (Wifi.buffer_pointer), hl
  52++8AB1              .loop
  53++8AB1 CD 67 91         call Wifi.getPacket
  54++8AB4 3A F2 8E         ld a, (Wifi.closed)
  55++8AB7 A7               and a
  56++8AB8 C0               ret nz
  57++8AB9                  ;call Wifi.continue
  58++8AB9 18 F6            jr .loop
  59++8ABB
  60++8ABB                  ifdef GS
  61++8ABB              loadMod:
  62++8ABB AF               xor a
  62++8ABC CD 50 92       call GeneralSound.init
  63++8ABF 21 FC 8A         ld hl, .progress
  63++8AC2 CD 47 6A       call DialogBox.msgNoWait
  64++8AC5 CD 93 8A         call makeRequest
  64++8AC8 DA D7 89       jp c, Fetcher.fetchFromNet.error
  65++8ACB CD 5D 92         call GeneralSound.loadModule
  66++8ACE              .loop
  67++8ACE 21 D0 9F 22      ld hl, outputBuffer, (Wifi.buffer_pointer), hl
  67++8AD2 F0 8E
  68++8AD4 CD 67 91         call Wifi.getPacket
  69++8AD7 3A F2 8E         ld a, (Wifi.closed)
  69++8ADA A7             and a
  69++8ADB 20 19          jr nz, .exit
  70++8ADD 21 D0 9F ED      ld hl, outputBuffer, bc, (Wifi.bytes_avail)
  70++8AE1 4B EE 8E
  71++8AE4              .loadLoop
  72++8AE4 78               ld a, b
  72++8AE5 B1             or c
  72++8AE6 A7             and a
  72++8AE7 28 08          jr z, .nextFrame
  73++8AE9 7E               ld a, (hl)
  73++8AEA CD 70 92       call GeneralSound.sendByte
  74++8AED 0B               dec bc
  75++8AEE 23               inc hl
  76++8AEF 18 F3            jr .loadLoop
  77++8AF1              .nextFrame
  78++8AF1 CD F2 8B         call pulsing
  79++8AF4                  ;call Wifi.continue
  80++8AF4 18 D8            jr .loop
  81++8AF6              .exit
  82++8AF6 CD 78 92         call GeneralSound.finishLoadingModule
  83++8AF9                  ;jp History.back
  84++8AF9 C3 25 8A     	jp MediaProcessor.processResource
  85++8AFC 4D 4F 44 20  .progress db "MOD downloading directly to GS!", 0
  85++8B00 64 6F 77 6E
  85++8B04 6C 6F 61 64
  85++8B08 69 6E 67 20
  85++8B0C 64 69 72 65
  85++8B10 63 74 6C 79
  85++8B14 20 74 6F 20
  85++8B18 47 53 21 00
  86++8B1C                  endif
  87++8B1C
  88++8B1C              download:
  89++8B1C 11 31 75         ld de, historyBlock.locator
  90++8B1F 62 6B            ld hl, de
  91++8B21              .findFileName
  92++8B21 1A               ld a, (de)
  92++8B22 13             inc de
  93++8B23 FE 2F            cp '/'
  93++8B25 20 02          jr nz, .skip
  94++8B27 62 6B            ld hl, de
  95++8B29              .skip
  96++8B29 A7               and a
  96++8B2A 20 F5          jr nz, .findFileName
  97++8B2C              .copy
  98++8B2C                  ;; HL - filename pointer
  99++8B2C 11 EE 69         ld de, DialogBox.inputBuffer
 100++8B2F              .copyFileName
 101++8B2F 7E               ld a, (hl)
 101++8B30 A7             and a
 101++8B31 28 05          jr z, .finishCopy
 102++8B33
 103++8B33 12               ld (de), a
 103++8B34 23 13          inc hl, de
 104++8B36 18 F7            jr .copyFileName
 105++8B38              .finishCopy
 106++8B38 12               ld (de), a
 107++8B39 CD 8D 69         call DialogBox.inputBox.noclear
 108++8B3C 3A EE 69         ld a, (DialogBox.namedownload)
 108++8B3F A7             and a
 108++8B40 CA EE 73       jp z, History.back
 109++8B43
 110++8B43 CD 93 8A         call makeRequest
 110++8B46 DA D7 89       jp c, Fetcher.fetchFromNet.error
 111++8B49
 112++8B49 06 0E 21 EE      ld b, Dos.FMODE_CREATE, hl, DialogBox.namedownload
 112++8B4D 69
 113++8B4E CD EB 6C         call Dos.fopen
 114++8B51 32 EF 8B         ld (.fp), a
 115++8B54
 116++8B54 21 CA 8B         ld hl, .progress
 116++8B57 CD 47 6A       call DialogBox.msgNoWait
 117++8B5A              .loop
 118++8B5A 21 D0 9F 22      ld hl, outputBuffer, (Wifi.buffer_pointer), hl
 118++8B5E F0 8E
 119++8B60 CD 67 91         call Wifi.getPacket
 120++8B63 3A F2 8E         ld a, (Wifi.closed)
 120++8B66 A7             and a
 120++8B67 20 12          jr nz, .exit
 121++8B69
 122++8B69 3A EF 8B 21      ld a, (.fp), hl, outputBuffer, bc, (Wifi.bytes_avail)
 122++8B6D D0 9F ED 4B
 122++8B71 EE 8E
 123++8B73 CD 65 6F         call Dos.fwrite
 124++8B76 CD F2 8B         call pulsing
 125++8B79 18 DF            jr .loop
 126++8B7B              .exit
 127++8B7B 3A EF 8B         ld a, (.fp)
 128++8B7E CD 36 6E         call Dos.fclose
 129++8B81 C3 EE 73         jp History.back
 130++8B84              .error
 131++8B84 3A EF 8B         ld a, (.fp)
 132++8B87 CD 36 6E         call Dos.fclose
 133++8B8A 21 93 8B         ld hl, .err
 134++8B8D CD 3E 6A         call DialogBox.msgBox
 135++8B90 C3 EE 73         jp History.back
 136++8B93
 137++8B93 4F 70 65 72  .err db "Operation failed! Sorry! Check filename or disk space!",0
 137++8B97 61 74 69 6F
 137++8B9B 6E 20 66 61
 137++8B9F 69 6C 65 64
 137++8BA3 21 20 53 6F
 137++8BA7 72 72 79 21
 137++8BAB 20 43 68 65
 137++8BAF 63 6B 20 66
 137++8BB3 69 6C 65 6E
 137++8BB7 61 6D 65 20
 137++8BBB 6F 72 20 64
 137++8BBF 69 73 6B 20
 137++8BC3 73 70 61 63
 137++8BC7 65 21 00
 138++8BCA 44 6F 77 6E  .progress db "Downloading in progress! Wait a bit!", 0
 138++8BCE 6C 6F 61 64
 138++8BD2 69 6E 67 20
 138++8BD6 69 6E 20 70
 138++8BDA 72 6F 67 72
 138++8BDE 65 73 73 21
 138++8BE2 20 57 61 69
 138++8BE6 74 20 61 20
 138++8BEA 62 69 74 21
 138++8BEE 00
 139++8BEF 00           .fp db 0
 140++8BF0 00           socket db 0
 141++8BF1 20           pulsator db " "
 142++8BF2              pulsing
 143++8BF2 11 01 0B         ld de, #0B01
 143++8BF5 CD 3A 60       call TextMode.gotoXY
 144++8BF8 3A F1 8B         ld a, (pulsator)
 145++8BFB FE 2A            cp '*'
 146++8BFD CA 09 8C         jp z, printasterix
 147++8C00 CD A4 60         call TextMode.putC
 148++8C03 3E 2A            ld a, '*'
 149++8C05 32 F1 8B         ld (pulsator),a
 150++8C08 C9               ret
 151++8C09              printasterix
 152++8C09 CD A4 60         call TextMode.putC
 153++8C0C 3E 20            ld a, ' '
 154++8C0E 32 F1 8B         ld (pulsator),a
 155++8C11 C9               ret
 156++8C12
 157++8C12 00 00 00...  requestbuffer ds #1ff
 158++8E11                  endmodule
 159++8E11
# file closed: gopher/gopher.asm
  24+ 8E11                  include "drivers/index.asm"
# file opened: drivers/index.asm
   1++8E11                  IFDEF UNO
   2++8E11 ~                	include "uart-uno.asm"
   3++8E11                  ENDIF
   4++8E11
   5++8E11                  IFDEF UNOUART
   6++8E11 ~                	include "uart-uno.asm"
   7++8E11                  ENDIF
   8++8E11
   9++8E11                  IFDEF MB03
  10++8E11 ~                	include "uart-mb03.asm"
  11++8E11                  ENDIF
  12++8E11
  13++8E11                  IFDEF AY
  14++8E11 ~                	include "uart-ay.asm"
  15++8E11                  ENDIF
  16++8E11
  17++8E11                  IFDEF AY56
  18++8E11                  	include "uart-ay.asm"
# file opened: drivers/uart-ay.asm
   1++8E11              ; Copyright 2024 TIsland Crew
   2++8E11              ; SPDX-License-Identifier: Apache-2.0
   3++8E11
   4++8E11                  IFDEF AY56
   5++8E11                      INCLUDE "uart-ay-57600.asm"
# file opened: drivers/uart-ay-57600.asm
   1++8E11              ;
   2++8E11
   3++8E11                  MODULE UART5
   4++8E11
   5++8E11              ; https://cygnus.speccy.cz/download/zx128k_rs232/rs232_paul_farrow_57600_data_sequence_with_cts_flow_control.html
   6++8E11              ;   via https://cygnus.speccy.cz/popis_zx-spectrum_dg192k_rs232.php
   7++8E11
   8++8E11              ;==============================================================================
   9++8E11              ; RS232 - transmitting through AY-3-8912 without data flow control
  10++8E11              ;
  11++8E11              ; 57600bps (17.3611μs) 61.57813T on ZX128k, 61T will take 17.19811μs, error -0.9% (58146bps)
  12++8E11              ;                      60.76389T on ZX48k,  61T will take 17.42857μs, error +0.4% (57377bps)
  13++8E11              ;==============================================================================
  14++8E11              ; original author Paul Farrow - this is code disassembled from his RS232 ROM,
  15++8E11              ; but only RS232 part
  16++8E11
  17++8E11              RS232_CFGDTR:    ; enable/disable DTR check when sending
  18++8E11              ; NOTE: this is actually RTS line, IIRC it was a mistake carried on
  19++8E11              ; from the original Interface 1 docs
  20++8E11              ; A - flag, A=0 -- DTR disabled, A=0xff -- DTR enabled
  21++8E11 E6 40            and %01000000   ; Bit 6: RS232  DTR (in)  - 0=Device ready for data,     1=Busy
  22++8E13 32 A5 8E         ld (DTRFL), a   ; patch the code
  23++8E16 C9               ret
  24++8E17
  25++8E17              RS232_INIT:
  26++8E17 F3                   di
  27++8E18 CD 1D 8E             call SET_AY_PORTS
  28++8E1B FB                   ei
  29++8E1C C9                   ret
  30++8E1D
  31++8E1D              SET_AY_PORTS:
  32++8E1D 01 FD FF             ld  bc,$fffd        ; 10T   BC = FFFD, register port
  33++8E20 3E 07                ld  a,7             ; 7T    select AY register 7
  34++8E22 ED 79                out (c),a           ; 12T
  35++8E24 78                   ld  a,b             ; 4T    A = 255 / set IO port as output (1 on bit 6) and disable all sound channels
  36++8E25 06 BF                ld  b,$BF           ; 7T    BC = BFFD, data port
  37++8E27 ED 79                out (c),a           ; 12T
  38++8E29 47                   ld  b,a             ; 4T    BC = FFFD / AY register port
  39++8E2A 3E 0E                ld  a,14            ; 7T    select AY register 14 (I/O port)
  40++8E2C ED 79                out (c),a           ; 12T
  41++8E2E 78                   ld  a,b             ; 4T    A = FF
  42++8E2F 06 BF                ld  b,$BF           ; 7T    BC = BFFD / data port
  43++8E31 ED 79                out (c),a           ; 12T   write data byte 255, all bits high (like pullups?)
  44++8E33 C9                   ret                 ; 10T
  45++8E34
  46++8E34              ; total 10+7+12+4+7+12+4+7+12+7+4+12+10 = 108T
  47++8E34
  48++8E34              RS232_RD_BT:
  49++8E34 F3                   di
  50++8E35 CD 3A 8E             call SLOAD_AY_R
  51++8E38 FB                   ei
  52++8E39 C9                   ret
  53++8E3A
  54++8E3A              SLOAD_AY_R:
  55++8E3A 11 FB 80             ld  de,$80FB        ; 10T   D = 1000 0000, E = 1111 1011    (ZX 128k RS232 - *A2, A3, A6, *A7)
  56++8E3D 18 03                jr  SLOAD_AY        ; 12T   jump to common part
  57++8E3F
  58++8E3F              SLOAD_AY_K:
  59++8E3F 11 FE 20             ld  de,$20FE        ; 10T   D = 0010 0000, E = 1111 1110    (ZX 128k Keypad - *A0, A1, A4, *A5)
  60++8E42              SLOAD_AY:
  61++8E42 7B                   ld  a,e             ; 4T
  62++8E43 1E 00                ld  e,0             ; 7T
  63++8E45 21 FF BF             ld  hl,$BFFF        ; 10T   H = 1011 1111 (191 * 256 + 253 = 49149), L = 1111 1111 (255 * 256 + 253 = 65535)
  64++8E48 01 FD BF             ld  bc,$BFFD        ; 10T   AY data port
  65++8E4B ED 79                out (c),a           ; 12T   set CTS (ZX Spectrum is ready recieve data)
  66++8E4D 45                   ld  b,l             ; 4T    B = FF -> BC = FFFD
  67++8E4E              SLOAD_AY_WAIT:
  68++8E4E ED 78                in  a,(c)           ; 12T   read control port = IO port - repeat 3 times
  69++8E50 A2                   and d               ; 4T    check TxD (data from PC)
  70++8E51 28 2C                jr  z,SLOAD_AY_RD_1 ; 7/12T Z = start bit
  71++8E53 ED 78                in  a,(c)           ; 12T
  72++8E55 A2                   and d               ; 4T
  73++8E56 28 27                jr  z,SLOAD_AY_RD_1 ; 7/12T
  74++8E58 ED 78                in  a,(c)           ; 12T
  75++8E5A A2                   and d               ; 4T
  76++8E5B 28 22                jr  z,SLOAD_AY_RD_1 ; 7/12T
  77++8E5D 1D                   dec e               ; 4T    decrement counter
  78++8E5E 20 EE                jr  nz,SLOAD_AY_WAIT; 7/12T wait for start bit again if NZ
  79++8E60 ED 78                in  a,(c)           ; 12T
  80++8E62 A2                   and d               ; 4T
  81++8E63 28 1A                jr  z,SLOAD_AY_RD_1 ; 7/12T
  82++8E65 7D                   ld  a,l             ; 4T    A = FF
  83++8E66 44                   ld  b,h             ; 4T    B = BF -> BC = BFFD (what port is it selecting now?)
  84++8E67 ED 79                out (c),a           ; 12T
  85++8E69 45                   ld  b,l             ; 4T    B = FF -> BC = FFFD
  86++8E6A              SLOAD_AY_WAI2:
  87++8E6A ED 78                in  a,(c)           ; 12T   what port was read here?
  88++8E6C A2                   and d               ; 4T
  89++8E6D 28 11                jr  z,SLOAD_AY_RD_2 ; 7/12T
  90++8E6F ED 78                in  a,(c)           ; 12T
  91++8E71 A2                   and d               ; 4T
  92++8E72 28 0C                jr  z,SLOAD_AY_RD_2 ; 7/12T
  93++8E74 ED 78                in  a,(c)           ; 12T
  94++8E76 A2                   and d               ; 4T
  95++8E77 28 07                jr  z,SLOAD_AY_RD_2 ; 7/12T
  96++8E79 1D                   dec e               ; 4T
  97++8E7A C2 6A 8E             jp  nz,SLOAD_AY_WAI2; 10T
  98++8E7D AF                   xor a               ; 4T    CF=0
  99++8E7E C9                   ret                 ; 10T
 100++8E7F
 101++8E7F              ; start bit detected, read other bits (this is critical for precize timing)
 102++8E7F
 103++8E7F 00           SLOAD_AY_RD_1:  nop         ; 4T    only delay?
 104++8E80              SLOAD_AY_RD_2:
 105++8E80 7D                   ld  a,l             ; 4T    A = FF
 106++8E81 44                   ld  b,h             ; 4T    B = BF -> BC = BFFD
 107++8E82 ED 79                out (c),a           ; 12T   write FF to what register? 14?
 108++8E84 1E 80                ld  e,10000000b     ; 7T    this will be counter to 8
 109++8E86 45                   ld  b,l             ; 4T    B = FF -> BC = FFFD
 110++8E87              SLOAD_AY_BITL:
 111++8E87 ED 78                in  a,(c)           ; 12T   read AY I/O port
 112++8E89 DD BE 00             cp  (ix+0)          ; 19T   delay?
 113++8E8C A2                   and d               ; 4T    zero irrelevant bits, leave only one (bit 7 for RS232/MIDI connector)
 114++8E8D C6 FF                add a,255           ; 7T    activate carry flag if bit from serial port was H
 115++8E8F CB 1B                rr  e               ; 8T    8x rotate E to right and carry flag copy in bit 7
 116++8E91 30 F4                jr  nc,SLOAD_AY_BITL; 12/7T carry = last bit was read
 117++8E93 AF                   xor a               ; 4T    set Z flag, A = 0, only delay?
 118++8E94 7B                   ld  a,e             ; 4T    A = E
 119++8E95 37                   scf                 ; 4T    set carry flag
 120++8E96 C9                   ret                 ; 10T
 121++8E97
 122++8E97              ; ZX Spectrum 128k Keypad is using bits
 123++8E97              ;   A0  ?   output
 124++8E97              ;   A1  ?   output
 125++8E97              ;   A4  ?   input
 126++8E97              ;   A5  ?   input
 127++8E97              ;
 128++8E97              ; ZX Spectrum 128k RS232 is using bits
 129++8E97              ;   A2  CTS output      RTS
 130++8E97              ;   A3  RxD output      TxD
 131++8E97              ;   A6  DTR input       CTS
 132++8E97              ;   A7  TxD input       RxD
 133++8E97
 134++8E97              RS232_WR_BT:
 135++8E97 F3                   di
 136++8E98 E5 D5 C5             push hl, de, bc
 137++8E9B CD A3 8E             call SSAVE_AY_R
 138++8E9E C1 D1 E1             pop bc, de, hl
 139++8EA1 FB                   ei
 140++8EA2 C9                   ret
 141++8EA3
 142++8EA3              SSAVE_AY_R:
 143++8EA3              DTRFL    equ $ + 2
 144++8EA3 21 F6 40             ld  hl,$40F6        ; 10T       H = 0100 0000, L = 1111 0110    mask/bits for RS232/MIDI
 145++8EA6 18 03                jr  SSAVE_AY        ; 12T
 146++8EA8
 147++8EA8              SSAVE_AY_K:
 148++8EA8 21 FC 10             ld  hl,$10FC        ; 10T       H = 0001 0000, L = 1111 1100    mask/bits for KEYPAD
 149++8EAB              SSAVE_AY:
 150++8EAB 16 0A                ld  d,10            ; 7T        bit counter (start bit + 8 bits + stop bit)
 151++8EAD 01 FD FF             ld  bc,$FFFD        ; 10T       BC = FFFD / register port AY-3-8912
 152++8EB0 2F                   cpl                 ; 4T        invert A
 153++8EB1 5F                   ld  e,a             ; 4T        copy inverted data into E
 154++8EB2              ; wait for CTS or BREAK
 155++8EB2              SSAVE_AY_WFSB:  ; THE 'BREAK-KEY' SUBROUTINE https://skoolkid.github.io/rom/asm/1F54.html
 156++8EB2 CD 54 1F             call 0x1F54      ; 17T+(33|53T)  test BREAK / nc = BREAK was pressed
 157++8EB5 D0                   ret nc              ; 11/5T
 158++8EB6 ED 78                in  a,(c)           ; 12T       read AY I/O port
 159++8EB8 A4                   and h               ; 4T
 160++8EB9 20 F7                jr   nz,SSAVE_AY_WFSB    ; 12/7T     Z = CTS in low detected
 161++8EBB 06 BF                ld  b,$BF           ; 7T        BC = BFFD / data port AY-3-8912
 162++8EBD 37                   scf                 ; 4T        set carry
 163++8EBE              SSAVE_AY_LOOP:
 164++8EBE 38 04                jr  c,SSAVE_AY_OVER ; 12/7T
 165++8EC0 3E FE                ld  a,$FE           ; 7T        TxD = 1 (A3/A1)
 166++8EC2 18 04                jr  SSAVE_AY_OUT    ; 12T
 167++8EC4
 168++8EC4              SSAVE_AY_OVER:
 169++8EC4 7D                   ld  a,l             ; 4T        TxD = 0 (A3/A1)
 170++8EC5 C3 C8 8E             jp  SSAVE_AY_OUT    ; 10T
 171++8EC8
 172++8EC8              ; CTS detected from in  12+4+7+7+4+12+4+10 = 60T (still not transmitting anything)
 173++8EC8              ; start bit from out    12+8+4+12+12+4+10 = 62T
 174++8EC8              ; bit 1         12+8+4+12+7+7+12 = 62T
 175++8EC8              ; stop bit (nc)     12+8+4+12+7+7+12 = 62T
 176++8EC8
 177++8EC8              SSAVE_AY_OUT:
 178++8EC8 ED 79                out (c),a       ; 12T       write to AY I/O port
 179++8ECA CB 3B                srl e           ; 8T        shift right logical - shift data byte, 0 to bit 7, bit 0 to carry
 180++8ECC 15                   dec d           ; 4T        decrement bit counter
 181++8ECD 20 EF                jr  nz,SSAVE_AY_LOOP    ; 12/7T     jump if any bit left
 182++8ECF 37                   scf             ; 4T
 183++8ED0 C9                   ret             ; 10T
 184++8ED1
 185++8ED1              ; after stop bit 12+8+4+7+4+10 = 45T (and more)
 186++8ED1
 187++8ED1                  ENDMODULE; UART5
 188++8ED1
 189++8ED1              ; EOF vim: et:ai:ts=4:sw=4:
 190++8ED1
# file closed: drivers/uart-ay-57600.asm
   6++8ED1                      MODULE      Uart
   7++8ED1              init:
   8++8ED1 CD 17 8E             call UART5.RS232_INIT
   9++8ED4 AF                   xor a
  10++8ED5 C3 11 8E             jp UART5.RS232_CFGDTR
  11++8ED8
  12++8ED8              write       equ UART5.RS232_WR_BT
  13++8ED8              uartRead    equ UART5.RS232_RD_BT
  14++8ED8
  15++8ED8              read:
  16++8ED8 C5 D5 E5             push bc, de, hl
  17++8EDB CD 34 8E             call uartRead
  18++8EDE E1 D1 C1             pop hl, de, bc
  19++8EE1 D8                   ret c
  20++8EE2 18 F4                jr read
  21++8EE4
  22++8EE4                      ENDMODULE ; Uart
  23++8EE4                  ELSE
  24++8EE4 ~                    INCLUDE "uart-ay-128k.asm"
  25++8EE4                  ENDIF;UART_128K
  26++8EE4
  27++8EE4              ; EOF vim: et:ai:ts=4:sw=4:
# file closed: drivers/uart-ay.asm
  19++8EE4                  ENDIF
  20++8EE4
  21++8EE4                  IFDEF ZW
  22++8EE4 ~                	include "uart-zxwifi.asm"
  23++8EE4                  ENDIF
  24++8EE4
  25++8EE4              	include "utils.asm"
# file opened: drivers/utils.asm
   1++8EE4              ;;; Macroses!!!!
   2++8EE4                  MACRO EspSend Text
   3++8EE4 ~                ld hl, .txtB
   4++8EE4 ~                ld e, (.txtE - .txtB)
   5++8EE4 ~                call espSend
   6++8EE4 ~                jr .txtE
   7++8EE4 ~            .txtB
   8++8EE4 ~                db Text
   9++8EE4 ~            .txtE
  10++8EE4                  ENDM
  11++8EE4
  12++8EE4                  MACRO EspCmd Text
  13++8EE4 ~                ld hl, .txtB
  14++8EE4 ~                ld e, (.txtE - .txtB)
  15++8EE4 ~                call espSend
  16++8EE4 ~                jr .txtE
  17++8EE4 ~            .txtB
  18++8EE4 ~                db Text
  19++8EE4 ~                db 13, 10
  20++8EE4 ~            .txtE
  21++8EE4                  ENDM
  22++8EE4
  23++8EE4                  MACRO EspCmdOkErr text
  24++8EE4 ~                EspCmd text
  25++8EE4 ~                call checkOkErr
  26++8EE4                  ENDM
  27++8EE4
  28++8EE4              ; IN DE - string pointer
  29++8EE4              ; OUT HL - string len
  30++8EE4              strLen:
  31++8EE4 21 00 00         ld hl, 0
  32++8EE7              .loop
  33++8EE7 1A               ld a, (de)
  33++8EE8 A7             and a
  33++8EE9 C8             ret z
  34++8EEA 13 23            inc de, hl
  35++8EEC 18 F9            jr .loop
# file closed: drivers/utils.asm
  26++8EEE
  27++8EEE              	IFDEF UARTATM
  28++8EEE ~            		include "uart-atm.asm"
  29++8EEE              	ENDIF
  30++8EEE
  31++8EEE              	IFDEF UARTEVO
  32++8EEE ~            		include "uart-evo.asm"
  33++8EEE                  ENDIF
  34++8EEE
  35++8EEE              	IFDEF NEDONET
  36++8EEE ~            		include "nedowifi.asm"
  37++8EEE              	ELSE
  38++8EEE              	IFNDEF MSX
  39++8EEE              		include "wifi.asm"
# file opened: drivers/wifi.asm
   1++8EEE                  MODULE Wifi
   2++8EEE 00 00        bytes_avail dw 0
   3++8EF0 00 00        buffer_pointer dw 0
   4++8EF2 01           closed db 1
   5++8EF3              ; Initialize Wifi chip to work
   6++8EF3              init:
   7++8EF3
   8++8EF3 21 E5 8F         ld hl, .uartIniting
   8++8EF6 CD BC 60       call TextMode.printZ
   9++8EF9 CD D1 8E         call Uart.init
  10++8EFC 21 F6 8F         ld hl, .chipIniting
  10++8EFF CD BC 60       call TextMode.printZ
  11++8F02
  12++8F02                  EspCmdOkErr "ATE0"
  12++8F02             >    EspCmd "ATE0"
  12++8F02 21 0C 8F    >    ld hl, .txtB
  12++8F05 1E 06       >    ld e, (.txtE - .txtB)
  12++8F07 CD FA 90    >    call espSend
  12++8F0A 18 06       >    jr .txtE
  12++8F0C             >.txtB
  12++8F0C 41 54 45 30 >    db "ATE0"
  12++8F10 0D 0A       >    db 13, 10
  12++8F12             >.txtE
  12++8F12 CD 85 90    >    call checkOkErr
  13++8F15 DA C5 8F         jp c, .initError
  14++8F18
  15++8F18              ; Reading auth.pwd and send it to ESP
  16++8F18 21 33 A0 06      ld hl, creds, b, Dos.FMODE_READ
  16++8F1C 01
  16++8F1D CD EB 6C       call Dos.fopen
  17++8F20 F5               push af
  18++8F21 21 44 A0 01      ld hl,outputBuffer2, bc, 255
  18++8F25 FF 00
  18++8F27 CD 42 6F       call Dos.fread
  19++8F2A F1               pop af
  20++8F2B CD 36 6E         call Dos.fclose
  21++8F2E
  22++8F2E 21 0E 90         ld hl, .doneInit1
  22++8F31 CD BC 60       call TextMode.printZ
  23++8F34
  24++8F34 21 44 A0         ld hl,outputBuffer2
  25++8F37 CD 04 91         call espSendT
  26++8F3A 3E 0D            ld a, 13
  26++8F3C CD 97 8E       call Uart.write
  27++8F3F 3E 0A            ld a, 10
  27++8F41 CD 97 8E       call Uart.write
  28++8F44 CD 85 90         call checkOkErr
  29++8F47 DA C5 8F         jp c, .initError
  30++8F4A              ;
  31++8F4A                 	EspCmdOkErr "AT+CIPSERVER=0"
  31++8F4A             >    EspCmd "AT+CIPSERVER=0"
  31++8F4A 21 54 8F    >    ld hl, .txtB
  31++8F4D 1E 10       >    ld e, (.txtE - .txtB)
  31++8F4F CD FA 90    >    call espSend
  31++8F52 18 10       >    jr .txtE
  31++8F54             >.txtB
  31++8F54 41 54 2B 43 >    db "AT+CIPSERVER=0"
  31++8F58 49 50 53 45 >
  31++8F5C 52 56 45 52 >
  31++8F60 3D 30       >
  31++8F62 0D 0A       >    db 13, 10
  31++8F64             >.txtE
  31++8F64 CD 85 90    >    call checkOkErr
  32++8F67                  EspCmdOkErr "AT+CIPCLOSE" ; Close if there some connection was. Don't care about result
  32++8F67             >    EspCmd "AT+CIPCLOSE"
  32++8F67 21 71 8F    >    ld hl, .txtB
  32++8F6A 1E 0D       >    ld e, (.txtE - .txtB)
  32++8F6C CD FA 90    >    call espSend
  32++8F6F 18 0D       >    jr .txtE
  32++8F71             >.txtB
  32++8F71 41 54 2B 43 >    db "AT+CIPCLOSE"
  32++8F75 49 50 43 4C >
  32++8F79 4F 53 45    >
  32++8F7C 0D 0A       >    db 13, 10
  32++8F7E             >.txtE
  32++8F7E CD 85 90    >    call checkOkErr
  33++8F81                  EspCmdOkErr "AT+CIPMUX=0" ; Single connection mode
  33++8F81             >    EspCmd "AT+CIPMUX=0"
  33++8F81 21 8B 8F    >    ld hl, .txtB
  33++8F84 1E 0D       >    ld e, (.txtE - .txtB)
  33++8F86 CD FA 90    >    call espSend
  33++8F89 18 0D       >    jr .txtE
  33++8F8B             >.txtB
  33++8F8B 41 54 2B 43 >    db "AT+CIPMUX=0"
  33++8F8F 49 50 4D 55 >
  33++8F93 58 3D 30    >
  33++8F96 0D 0A       >    db 13, 10
  33++8F98             >.txtE
  33++8F98 CD 85 90    >    call checkOkErr
  34++8F9B DA C5 8F         jp c, .initError
  35++8F9E
  36++8F9E                  EspCmdOkErr "AT+CIPDINFO=0" ; Disable additional info
  36++8F9E             >    EspCmd "AT+CIPDINFO=0"
  36++8F9E 21 A8 8F    >    ld hl, .txtB
  36++8FA1 1E 0F       >    ld e, (.txtE - .txtB)
  36++8FA3 CD FA 90    >    call espSend
  36++8FA6 18 0F       >    jr .txtE
  36++8FA8             >.txtB
  36++8FA8 41 54 2B 43 >    db "AT+CIPDINFO=0"
  36++8FAC 49 50 44 49 >
  36++8FB0 4E 46 4F 3D >
  36++8FB4 30          >
  36++8FB5 0D 0A       >    db 13, 10
  36++8FB7             >.txtE
  36++8FB7 CD 85 90    >    call checkOkErr
  37++8FBA DA C5 8F         jp c, .initError
  38++8FBD
  39++8FBD 21 07 90         ld hl, .doneInit
  39++8FC0 CD BC 60       call TextMode.printZ
  40++8FC3
  41++8FC3 B7               or a
  42++8FC4 C9               ret
  43++8FC5              .initError
  44++8FC5 21 CD 8F         ld hl, .errMsg
  44++8FC8 CD 3E 6A       call DialogBox.msgBox
  45++8FCB 37               scf
  46++8FCC C9               ret
  47++8FCD 57 69 46 69  .errMsg      db "WiFi chip init failed!", "\r", 0
  47++8FD1 20 63 68 69
  47++8FD5 70 20 69 6E
  47++8FD9 69 74 20 66
  47++8FDD 61 69 6C 65
  47++8FE1 64 21 0D 00
  48++8FE5 55 61 72 74  .uartIniting db "Uart initing...", "\r", 0
  48++8FE9 20 69 6E 69
  48++8FED 74 69 6E 67
  48++8FF1 2E 2E 2E 0D
  48++8FF5 00
  49++8FF6 43 68 69 70  .chipIniting db "Chip initing...", "\r", 0
  49++8FFA 20 69 6E 69
  49++8FFE 74 69 6E 67
  49++9002 2E 2E 2E 0D
  49++9006 00
  50++9007 44 6F 6E 65  .doneInit    db "Done!","\r", 0
  50++900B 21 0D 00
  51++900E 53 65 6E 64  .doneInit1   db "Sending auth.pwd to ESP","\r", 0
  51++9012 69 6E 67 20
  51++9016 61 75 74 68
  51++901A 2E 70 77 64
  51++901E 20 74 6F 20
  51++9022 45 53 50 0D
  51++9026 00
  52++9027                  IFNDEF PROXY
  53++9027              ; HL - host pointer in gopher row
  54++9027              ; DE - port pointer in gopher row
  55++9027              openTCP:
  56++9027 D5               push de
  57++9028 E5               push hl
  58++9029                  EspCmdOkErr "AT+CIPCLOSE" ; Don't care about result. Just close if it didn't happens before
  58++9029             >    EspCmd "AT+CIPCLOSE"
  58++9029 21 33 90    >    ld hl, .txtB
  58++902C 1E 0D       >    ld e, (.txtE - .txtB)
  58++902E CD FA 90    >    call espSend
  58++9031 18 0D       >    jr .txtE
  58++9033             >.txtB
  58++9033 41 54 2B 43 >    db "AT+CIPCLOSE"
  58++9037 49 50 43 4C >
  58++903B 4F 53 45    >
  58++903E 0D 0A       >    db 13, 10
  58++9040             >.txtE
  58++9040 CD 85 90    >    call checkOkErr
  59++9043                  EspSend 'AT+CIPSTART="TCP","'
  59++9043 21 4D 90    >    ld hl, .txtB
  59++9046 1E 13       >    ld e, (.txtE - .txtB)
  59++9048 CD FA 90    >    call espSend
  59++904B 18 13       >    jr .txtE
  59++904D             >.txtB
  59++904D 41 54 2B 43 >    db 'AT+CIPSTART="TCP","'
  59++9051 49 50 53 54 >
  59++9055 41 52 54 3D >
  59++9059 22 54 43 50 >
  59++905D 22 2C 22    >
  59++9060             >.txtE
  60++9060 E1               pop hl
  61++9061 CD 04 91         call espSendT
  62++9064                  EspSend '",'
  62++9064 21 6E 90    >    ld hl, .txtB
  62++9067 1E 02       >    ld e, (.txtE - .txtB)
  62++9069 CD FA 90    >    call espSend
  62++906C 18 02       >    jr .txtE
  62++906E             >.txtB
  62++906E 22 2C       >    db '",'
  62++9070             >.txtE
  63++9070 E1               pop hl
  64++9071 CD 04 91         call espSendT
  65++9074 3E 0D            ld a, 13
  65++9076 CD 97 8E       call Uart.write
  66++9079 3E 0A            ld a, 10
  66++907B CD 97 8E       call Uart.write
  67++907E AF               xor a
  67++907F 32 F2 8E       ld (closed), a
  68++9082 C3 85 90         jp checkOkErr
  69++9085                  ENDIF
  70++9085
  71++9085
  72++9085
  73++9085              checkOkErr:
  74++9085 CD D8 8E         call Uart.read
  75++9088 FE 4F            cp 'O'
  75++908A CA 9A 90       jp z, .okStart ; OK
  76++908D FE 45            cp 'E'
  76++908F CA AF 90       jp z, .errStart ; ERROR
  77++9092 FE 46            cp 'F'
  77++9094 CA D4 90       jp z, .failStart ; FAIL
  78++9097 C3 85 90         jp checkOkErr
  79++909A              .okStart
  80++909A CD D8 8E         call Uart.read
  80++909D FE 4B          cp 'K'
  80++909F C2 85 90       jp nz, checkOkErr
  81++90A2 CD D8 8E         call Uart.read
  81++90A5 FE 0D          cp 13
  81++90A7 C2 85 90       jp nz, checkOkErr
  82++90AA CD F1 90         call .flushToLF
  83++90AD B7               or a
  84++90AE C9               ret
  85++90AF              .errStart
  86++90AF CD D8 8E         call Uart.read
  86++90B2 FE 52          cp 'R'
  86++90B4 C2 85 90       jp nz, checkOkErr
  87++90B7 CD D8 8E         call Uart.read
  87++90BA FE 52          cp 'R'
  87++90BC C2 85 90       jp nz, checkOkErr
  88++90BF CD D8 8E         call Uart.read
  88++90C2 FE 4F          cp 'O'
  88++90C4 C2 85 90       jp nz, checkOkErr
  89++90C7 CD D8 8E         call Uart.read
  89++90CA FE 52          cp 'R'
  89++90CC C2 85 90       jp nz, checkOkErr
  90++90CF CD F1 90         call .flushToLF
  91++90D2 37               scf
  92++90D3 C9               ret
  93++90D4              .failStart
  94++90D4 CD D8 8E         call Uart.read
  94++90D7 FE 41          cp 'A'
  94++90D9 C2 85 90       jp nz, checkOkErr
  95++90DC CD D8 8E         call Uart.read
  95++90DF FE 49          cp 'I'
  95++90E1 C2 85 90       jp nz, checkOkErr
  96++90E4 CD D8 8E         call Uart.read
  96++90E7 FE 4C          cp 'L'
  96++90E9 C2 85 90       jp nz, checkOkErr
  97++90EC CD F1 90         call .flushToLF
  98++90EF 37               scf
  99++90F0 C9               ret
 100++90F1              .flushToLF
 101++90F1 CD D8 8E         call Uart.read
 102++90F4 FE 0A            cp 10
 102++90F6 C2 F1 90       jp nz, .flushToLF
 103++90F9 C9               ret
 104++90FA
 105++90FA              ; Send buffer to UART
 106++90FA              ; HL - buff
 107++90FA              ; E - count
 108++90FA              espSend:
 109++90FA 7E               ld a, (hl)
 109++90FB CD 97 8E       call Uart.write
 110++90FE 23               inc hl
 111++90FF 1D               dec e
 112++9100 C2 FA 90         jp nz, espSend
 113++9103 C9               ret
 114++9104
 115++9104              ; HL - string that ends with one of the terminator(CR/LF/TAB/NULL)
 116++9104              espSendT:
 117++9104 7E               ld a, (hl)
 118++9105
 119++9105 A7               and a
 119++9106 C8             ret z
 120++9107 FE 09            cp 9
 120++9109 C8             ret z
 121++910A FE 0D            cp 13
 121++910C C8             ret z
 122++910D FE 0A            cp 10
 122++910F C8             ret z
 123++9110
 124++9110 CD 97 8E         call Uart.write
 125++9113 23               inc hl
 126++9114 C3 04 91         jp espSendT
 127++9117
 128++9117              ; HL - stringZ to send
 129++9117              ; Adds CR LF
 130++9117              tcpSendZ:
 131++9117 E5               push hl
 132++9118                  EspSend "AT+CIPSEND="
 132++9118 21 22 91    >    ld hl, .txtB
 132++911B 1E 0B       >    ld e, (.txtE - .txtB)
 132++911D CD FA 90    >    call espSend
 132++9120 18 0B       >    jr .txtE
 132++9122             >.txtB
 132++9122 41 54 2B 43 >    db "AT+CIPSEND="
 132++9126 49 50 53 45 >
 132++912A 4E 44 3D    >
 132++912D             >.txtE
 133++912D D1               pop de
 133++912E D5             push de
 134++912F CD E4 8E         call strLen
 135++9132 23               inc hl
 135++9133 23             inc hl ; +CRLF
 136++9134 CD 0A 92         call hlToNumEsp
 137++9137 3E 0D            ld a, 13
 137++9139 CD 97 8E       call Uart.write
 138++913C 3E 0A            ld a, 10
 138++913E CD 97 8E       call Uart.write
 139++9141 CD 85 90         call checkOkErr
 139++9144 D8             ret c
 140++9145              .wait
 141++9145 CD D8 8E         call Uart.read
 141++9148 FE 3E          cp '>'
 141++914A C2 45 91       jp nz, .wait
 142++914D E1               pop hl
 143++914E              .loop
 144++914E 7E               ld a, (hl)
 144++914F A7             and a
 144++9150 CA 5A 91       jp z, .exit
 145++9153 CD 97 8E         call Uart.write
 146++9156 23               inc hl
 147++9157 C3 4E 91         jp .loop
 148++915A              .exit
 149++915A 3E 0D            ld a, 13
 149++915C CD 97 8E       call Uart.write
 150++915F 3E 0A            ld a, 10
 150++9161 CD 97 8E       call Uart.write
 151++9164 C3 85 90         jp checkOkErr
 152++9167
 153++9167              getPacket:
 154++9167 CD D8 8E         call Uart.read
 155++916A FE 2B            cp '+'
 155++916C CA 89 91       jp z, .ipdBegun    ; "+IPD," packet
 156++916F FE 4F            cp 'O'
 156++9171 CA 77 91       jp z, .closedBegun ; It enough to check "OSED\n" :-)
 157++9174 C3 67 91         jp getPacket
 158++9177              .closedBegun
 159++9177 CD D8 8E         call Uart.read; : cp 'S' : jp nz, .closedBegun
 160++917A CD D8 8E         call Uart.read; : cp 'E' : jp nz, .closedBegun
 161++917D CD D8 8E         call Uart.read; : cp 'D' : jp nz, .closedBegun
 162++9180 CD D8 8E         call Uart.read; : cp 13 : jp nz, .closedBegun
 163++9183 3E 01            ld a, 1
 164++9185 32 F2 8E         ld (closed), a
 165++9188 C9               ret
 166++9189              .ipdBegun
 167++9189 CD D8 8E         call Uart.read; : cp 'I' : jp nz, .ipdBegun
 168++918C CD D8 8E         call Uart.read; : cp 'P' : jp nz, .ipdBegun
 169++918F CD D8 8E         call Uart.read; : cp 'D' : jp nz, .ipdBegun
 170++9192 CD D8 8E         call Uart.read  ;','
 171++9195 CD F2 91         call .count_ipd_lenght
 172++9198 22 EE 8E         ld (bytes_avail), hl
 173++919B                  ;ld de, hl
 174++919B EB               ex de,hl
 175++919C 2A F0 8E         ld hl, (buffer_pointer)
 176++919F              .readp
 177++919F 7C               ld a, h
 178++91A0 3C               inc a
 179++91A1 CA B3 91         jp z, .skipbuff
 180++91A4 CD D8 8E         call Uart.read
 181++91A7 77               ld (hl), a
 182++91A8 1B               dec de
 183++91A9 23               inc hl
 184++91AA 7A               ld a, d
 185++91AB B3               or e
 186++91AC C2 9F 91         jp nz, .readp
 187++91AF 22 F0 8E         ld (buffer_pointer), hl
 188++91B2 C9               ret
 189++91B3              .skipbuff
 190++91B3 CD D8 8E         call Uart.read
 191++91B6 1B               dec de
 192++91B7 7A               ld a, d
 193++91B8 B3               or e
 194++91B9 C2 B3 91         jp nz, .skipbuff
 195++91BC
 196++91BC CD 32 92             call flushToLF1
 197++91BF
 198++91BF 3E 01            ld a,1
 199++91C1 32 F2 8E     	ld (closed),a
 200++91C4 AF           	xor a
 201++91C5 32 EE 8E     	ld (bytes_avail),a
 202++91C8 21 CF 91         ld hl, .errMem
 202++91CB CD 3E 6A       call DialogBox.msgBox
 203++91CE C9               ret
 204++91CF              .errMem:
 205++91CF 4F 75 74 20  	db "Out of memory. Page loading error.",0
 205++91D3 6F 66 20 6D
 205++91D7 65 6D 6F 72
 205++91DB 79 2E 20 50
 205++91DF 61 67 65 20
 205++91E3 6C 6F 61 64
 205++91E7 69 6E 67 20
 205++91EB 65 72 72 6F
 205++91EF 72 2E 00
 206++91F2              .count_ipd_lenght
 207++91F2 21 00 00     		ld hl,0			; count lenght
 208++91F5 CD D8 8E     .cil1   call Uart.read
 209++91F8 FE 3A             	cp ':'
 210++91FA C8                   ret z
 211++91FB D6 30        		sub 0x30
 212++91FD 4D                   ld c,l
 213++91FE 44                   ld b,h
 214++91FF 29                   add hl,hl
 215++9200 29                   add hl,hl
 216++9201 09                   add hl,bc
 217++9202 29                   add hl,hl
 218++9203 4F                   ld c,a
 219++9204 06 00                ld b,0
 220++9206 09                   add hl,bc
 221++9207 C3 F5 91     		jp .cil1
 222++920A
 223++920A              ; Based on: https://wikiti.brandonw.net/index.php?title=Z80_Routines:Other:DispHL
 224++920A              ; HL - number
 225++920A              ; It will be written to UART
 226++920A              hlToNumEsp:
 227++920A 01 F0 D8     	ld	bc,-10000
 228++920D CD 23 92     	call	.n1
 229++9210 01 18 FC     	ld	bc,-1000
 230++9213 CD 23 92     	call	.n1
 231++9216 01 9C FF     	ld	bc,-100
 232++9219 CD 23 92     	call	.n1
 233++921C 0E F6        	ld	c,-10
 234++921E CD 23 92     	call	.n1
 235++9221 0E FF        	ld	c,-1
 236++9223 3E 2F        .n1	ld	a,'0'-1
 237++9225 3C           .n2	inc	a
 238++9226 09           	add	hl,bc
 239++9227 DA 25 92     	jp	c, .n2
 240++922A ED 42        	sbc	hl,bc
 241++922C C5               push bc
 242++922D CD 97 8E     	call Uart.write
 243++9230 C1               pop bc
 244++9231 C9               ret
 245++9232              flushToLF1
 246++9232 CD D8 8E         call Uart.read
 247++9235 FE 0A            cp 10
 247++9237 C2 32 92       jp nz, flushToLF1
 248++923A C9               ret
 249++923B                  ENDMODULE
# file closed: drivers/wifi.asm
  40++923B              	ENDIF
  41++923B              	ENDIF
  42++923B
  43++923B                  IFDEF NEDOOS
  44++923B ~                	include "rtc-nos.asm"
  45++923B                  ENDIF
  46++923B
  47++923B
  48++923B                  IFDEF SMUCRTC
  49++923B ~                	include "rtc-smuc.asm"
  50++923B                  ENDIF
  51++923B
  52++923B              	IFDEF MSX
  53++923B ~                    include "drivers/unapi/unapi.asm"
  54++923B ~                	include "drivers/unapi/tcp.asm"
  55++923B ~            		include "rtc-msx.asm"
  56++923B                  ELSE
  57++923B              		include "proxy.asm"
# file opened: drivers/proxy.asm
   1++923B                  IFDEF PROXY
   2++923B ~                MODULE Wifi
   3++923B ~            ; Same singature as wifi.openTCP
   4++923B ~            ; HL - host pointer in gopher row
   5++923B ~            ; DE - port pointer in gopher row
   6++923B ~            openTCP:
   7++923B ~                push de
   8++923B ~                push hl
   9++923B ~
  10++923B ~                xor a
  10++923B ~              ld hl, hostBuff, de, hostBuff + 1, bc, 102, (hl), a
  10++923B ~              ldir
  11++923B ~
  12++923B ~                EspCmdOkErr "AT+CIPCLOSE"
  13++923B ~                EspCmdOkErr 'AT+CIPSTART="TCP","138.68.76.243",6912' // Replace here for yourown proxy. If you wish
  14++923B ~                jr c, .error
  15++923B ~                pop hl
  15++923B ~              ld de, hostBuff
  16++923B ~            .copyHost
  17++923B ~                ld a, (hl)
  17++923B ~              and a
  17++923B ~              jr z, 1F
  17++923B ~              and a
  17++923B ~              jr z, 1F
  18++923B ~                ld (de), a
  18++923B ~              inc hl, de
  19++923B ~                jr .copyHost
  20++923B ~            1   xor a
  20++923B ~              ld (de), a
  21++923B ~                pop hl
  21++923B ~              ld de, portBuff
  22++923B ~            .copyPort
  23++923B ~                ld a, (hl)
  23++923B ~              and a
  23++923B ~              jr z, 1F
  23++923B ~              and a
  23++923B ~              jr z, 1F
  24++923B ~                ld (de), a
  24++923B ~              inc hl, de
  25++923B ~                jr .copyPort
  26++923B ~            1   ld hl, hostBuff
  26++923B ~              call tcpSendZ
  27++923B ~                ld hl, portBuff
  27++923B ~              call tcpSendZ
  28++923B ~                xor a
  28++923B ~              ld (closed), a
  29++923B ~                ret
  30++923B ~            .error
  31++923B ~                pop hl
  31++923B ~              pop de
  32++923B ~                ret
  33++923B ~
  34++923B ~            continue:
  35++923B ~                EspCmdOkErr "AT+CIPSEND=1"
  36++923B ~                ret c
  37++923B ~            .wait
  38++923B ~                call Uart.read
  38++923B ~              cp '>'
  38++923B ~              jr nz, .wait
  39++923B ~                ld a, 'c'
  39++923B ~              call Uart.write
  40++923B ~                jp checkOkErr
  41++923B ~
  42++923B ~            hostBuff ds 96
  43++923B ~            portBuff ds 7
  44++923B ~                ENDMODULE
  45++923B                  ENDIF
# file closed: drivers/proxy.asm
  58++923B              		include "memory.asm"
# file opened: drivers/memory.asm
   1++923B                  module Memory
   2++923B              BANKM = #5b5c
   3++923B              MEM_PORT = #7ffd
   4++923B
   5++923B              init:
   6++923B F3               di
   7++923C FD CB 01 A6      res 4, (iy + 1)
   8++9240
   9++9240 AF               xor a
   9++9241 CD 45 92       call setPage
  10++9244 C9               ret
  11++9245
  12++9245              ; a - page
  13++9245              setPage:
  14++9245 F6 18            or #18
  14++9247 32 5C 5B       ld (BANKM), a
  15++924A 01 FD 7F         ld bc, MEM_PORT
  15++924D ED 79          out (c), a
  16++924F C9               ret
  17++9250
  18++9250                  endmodule
# file closed: drivers/memory.asm
  59++9250              	ENDIF
  60++9250
  61++9250              	IFDEF GS
  62++9250              		include "general-sound.asm"
# file opened: drivers/general-sound.asm
   1++9250                  macro _WaitCommand
   2++9250 ~            .wait
   3++9250 ~                in a, (GeneralSound.CMD)
   4++9250 ~                rrca
   5++9250 ~                jr c, .wait
   6++9250                  endm
   7++9250
   8++9250                  macro _WaitData
   9++9250 ~            .wait
  10++9250 ~                in a, (GeneralSound.CMD)
  11++9250 ~                rlca
  12++9250 ~                jr c, .wait
  13++9250                  endm
  14++9250
  15++9250                  macro _SendCommand nn
  16++9250 ~                ld a, nn
  16++9250 ~              out (GeneralSound.CMD), a
  17++9250                  endm
  18++9250
  19++9250                  module GeneralSound
  20++9250              ;; Control ports
  21++9250              CMD  = 187
  22++9250              DATA = 179
  23++9250
  24++9250              ;; Commands
  25++9250              CMD_WARM_RESET      = #F3
  26++9250              CMD_COLD_RESET      = #F4
  27++9250              CMD_LOAD_MODULE     = #30
  28++9250              CMD_PLAY_MODULE     = #31
  29++9250              CMD_STOP_MODULE     = #32
  30++9250              CMD_CONTINUE_MODULE = #33
  31++9250              CMD_OPEN_STREAM     = #D1
  32++9250              CMD_CLOSE_STREAM    = #D2
  33++9250
  34++9250              ; A - 0 warm reset, other - cold
  35++9250              init:
  36++9250 A7               and a
  36++9251 20 05          jr nz, .cold
  37++9253                  _SendCommand CMD_WARM_RESET
  37++9253 3E F3       >    ld a, CMD_WARM_RESET
  37++9255 D3 BB       >  out (GeneralSound.CMD), a
  38++9257 C9               ret
  39++9258              .cold
  40++9258                  _SendCommand CMD_COLD_RESET
  40++9258 3E F4       >    ld a, CMD_COLD_RESET
  40++925A D3 BB       >  out (GeneralSound.CMD), a
  41++925C C9               ret
  42++925D
  43++925D              ;; Initializes loading module
  44++925D              loadModule:
  45++925D                  _SendCommand CMD_LOAD_MODULE
  45++925D 3E 30       >    ld a, CMD_LOAD_MODULE
  45++925F D3 BB       >  out (GeneralSound.CMD), a
  46++9261                  _WaitCommand
  46++9261             >.wait
  46++9261 DB BB       >    in a, (GeneralSound.CMD)
  46++9263 0F          >    rrca
  46++9264 38 FB       >    jr c, .wait
  47++9266                  _SendCommand CMD_OPEN_STREAM
  47++9266 3E D1       >    ld a, CMD_OPEN_STREAM
  47++9268 D3 BB       >  out (GeneralSound.CMD), a
  48++926A                  _WaitCommand
  48++926A             >.wait
  48++926A DB BB       >    in a, (GeneralSound.CMD)
  48++926C 0F          >    rrca
  48++926D 38 FB       >    jr c, .wait
  49++926F C9               ret
  50++9270
  51++9270              ;; Use it for streaming mod file
  52++9270              sendByte:
  53++9270 D3 B3            out (DATA), a
  54++9272                  _WaitData
  54++9272             >.wait
  54++9272 DB BB       >    in a, (GeneralSound.CMD)
  54++9274 07          >    rlca
  54++9275 38 FB       >    jr c, .wait
  55++9277 C9               ret
  56++9278
  57++9278              ;; Call it when module was loaded
  58++9278              finishLoadingModule:
  59++9278                  _SendCommand CMD_CLOSE_STREAM
  59++9278 3E D2       >    ld a, CMD_CLOSE_STREAM
  59++927A D3 BB       >  out (GeneralSound.CMD), a
  60++927C                  _WaitCommand
  60++927C             >.wait
  60++927C DB BB       >    in a, (GeneralSound.CMD)
  60++927E 0F          >    rrca
  60++927F 38 FB       >    jr c, .wait
  61++9281              rewind:
  62++9281 3E 01            ld a, 1
  62++9283 D3 B3          out (DATA), a
  63++9285                  _SendCommand CMD_PLAY_MODULE
  63++9285 3E 31       >    ld a, CMD_PLAY_MODULE
  63++9287 D3 BB       >  out (GeneralSound.CMD), a
  64++9289                  _WaitCommand
  64++9289             >.wait
  64++9289 DB BB       >    in a, (GeneralSound.CMD)
  64++928B 0F          >    rrca
  64++928C 38 FB       >    jr c, .wait
  65++928E 3E 01 32 B2      ld a, 1, (state),a
  65++9292 92
  66++9293 C9               ret
  67++9294
  68++9294              ;; Works like pause too
  69++9294              stopModule:
  70++9294 AF               xor a
  70++9295 32 B2 92       ld (state), a
  71++9298                  _SendCommand CMD_STOP_MODULE
  71++9298 3E 32       >    ld a, CMD_STOP_MODULE
  71++929A D3 BB       >  out (GeneralSound.CMD), a
  72++929C C9               ret
  73++929D
  74++929D              continueModule:
  75++929D 3E 01            ld a, 1
  75++929F 32 B2 92       ld (state), a
  76++92A2                  _SendCommand CMD_CONTINUE_MODULE
  76++92A2 3E 33       >    ld a, CMD_CONTINUE_MODULE
  76++92A4 D3 BB       >  out (GeneralSound.CMD), a
  77++92A6 C9               ret
  78++92A7
  79++92A7              ; Pauses resumes
  80++92A7              toggleModule:
  81++92A7 CD 77 6A         call Console.waitForKeyUp
  82++92AA 3A B2 92         ld a, (state)
  82++92AD A7             and a
  83++92AE 28 ED            jr z, continueModule
  84++92B0 18 E2            jr stopModule
  85++92B2
  86++92B2 00           state db 0
  87++92B3                  endmodule
# file closed: drivers/general-sound.asm
  63++92B3              	ENDIF
# file closed: drivers/index.asm
  25+ 92B3                  include "screen/rtc.asm"
# file opened: screen/rtc.asm
   1++92B3              printRTC
   2++92B3              	IFDEF RTC
   3++92B3 ~            	call Clock.readTime
   4++92B3 ~
   5++92B3 ~            	ld a, (oldminutes)
   6++92B3 ~            	ld d,a
   7++92B3 ~            	ld a, (minutes)
   8++92B3 ~            	cp d					; Update only if minutes changed
   9++92B3 ~            	ret z
  10++92B3 ~            	ld (oldminutes), a
  11++92B3 ~
  12++92B3 ~            	ld d,1 ;??? Y,X
  13++92B3 ~            	ld e,SCREEN_WIDTH - 7
  14++92B3 ~            	call TextMode.gotoXY
  15++92B3 ~            	ld a,'['
  16++92B3 ~            	call TextMode.putC
  17++92B3 ~            	ld h,0
  18++92B3 ~            	ld a,(hours) ;
  19++92B3 ~            	ld l,a
  20++92B3 ~            	call toDecimal
  21++92B3 ~            	ld hl,decimalS+3
  22++92B3 ~            	call TextMode.printZ
  23++92B3 ~            	ld a,':'
  24++92B3 ~            	call TextMode.putC
  25++92B3 ~            	ld h,0
  26++92B3 ~            	ld a,(minutes) ;
  27++92B3 ~            	ld l,a
  28++92B3 ~            	call toDecimal
  29++92B3 ~            	ld hl,decimalS+3
  30++92B3 ~            	call TextMode.printZ
  31++92B3 ~            	;ld a,':'
  32++92B3 ~            	;call TextMode.putC
  33++92B3 ~            	;ld h,0
  34++92B3 ~            	;ld a,(seconds) ;ᥪ㭤
  35++92B3 ~            	;ld l,a
  36++92B3 ~            	;call toDecimal
  37++92B3 ~            	;ld hl,decimalS+3
  38++92B3 ~            	;call TextMode.printZ
  39++92B3 ~            	ld a,']'
  40++92B3 ~            	call TextMode.putC
  41++92B3 ~            	ret
  42++92B3 ~
  43++92B3 ~            toDecimal		; 2   5  
  44++92B3 ~            				; 室  HL ᫮
  45++92B3 ~            	ld de,10000 ;⪨ 
  46++92B3 ~            	ld a,255
  47++92B3 ~            toDecimal10k
  48++92B3 ~            	and a
  49++92B3 ~            	sbc hl,de
  50++92B3 ~            	inc a
  51++92B3 ~            	jr nc,toDecimal10k
  52++92B3 ~            	add hl,de
  53++92B3 ~            	add a,48
  54++92B3 ~            	ld (decimalS),a
  55++92B3 ~            	ld de,1000 ;
  56++92B3 ~            	ld a,255
  57++92B3 ~            toDecimal1k
  58++92B3 ~            	and a
  59++92B3 ~            	sbc hl,de
  60++92B3 ~            	inc a
  61++92B3 ~            	jr nc,toDecimal1k
  62++92B3 ~            	add hl,de
  63++92B3 ~            	add a,48
  64++92B3 ~            	ld (decimalS+1),a
  65++92B3 ~            	ld de,100 ;⭨
  66++92B3 ~            	ld a,255
  67++92B3 ~            toDecimal01k
  68++92B3 ~            	and a
  69++92B3 ~            	sbc hl,de
  70++92B3 ~            	inc a
  71++92B3 ~            	jr nc,toDecimal01k
  72++92B3 ~            	add hl,de
  73++92B3 ~            	add a,48
  74++92B3 ~            	ld (decimalS+2),a
  75++92B3 ~            	ld de,10 ;⪨
  76++92B3 ~            	ld a,255
  77++92B3 ~            toDecimal001k
  78++92B3 ~            	and a
  79++92B3 ~            	sbc hl,de
  80++92B3 ~            	inc a
  81++92B3 ~            	jr nc,toDecimal001k
  82++92B3 ~            	add hl,de
  83++92B3 ~            	add a,48
  84++92B3 ~            	ld (decimalS+3),a
  85++92B3 ~            	ld de,1 ;
  86++92B3 ~            	ld a,255
  87++92B3 ~            toDecimal0001k
  88++92B3 ~            	and a
  89++92B3 ~            	sbc hl,de
  90++92B3 ~            	inc a
  91++92B3 ~            	jr nc,toDecimal0001k
  92++92B3 ~            	add hl,de
  93++92B3 ~            	add a,48
  94++92B3 ~            	ld (decimalS+4),a
  95++92B3 ~            	ret
  96++92B3 ~            hours
  97++92B3 ~            	db 0
  98++92B3 ~            minutes
  99++92B3 ~            	db 0
 100++92B3 ~            seconds
 101++92B3 ~            	db 0
 102++92B3 ~            decimalS	ds 7 ; 
 103++92B3              	ENDIF
 104++92B3 C9           	ret
 105++92B4              oldminutes		;  㡨  ᫮
 106++92B4 FF           	db 255
 107++92B5
 108++92B5
 109++92B5
 110++92B5
# file closed: screen/rtc.asm
  26+ 92B5
  27+ 92B5                  IFDEF NEDOOS
  28+ 92B5 ~                ;Gap about 8kb, CMD_SETMUSIC 0x4000 mandatory
  29+ 92B5 ~                ;Stack down from 0x4000
  30+ 92B5 ~                    include "screen/nedoscreen.asm"
  31+ 92B5 ~                    include "player/mod-processor.asm"
  32+ 92B5 ~                    include "player/vortexnedoos.asm"
  33+ 92B5 ~
  34+ 92B5 ~            start:
  35+ 92B5 ~            outputBuffer:
  36+ 92B5 ~                    ld sp, 0x4000
  37+ 92B5 ~                    ld c,nos.CMD_SETSYSDRV
  38+ 92B5 ~                 	ex af,af'
  39+ 92B5 ~            	    call nos.BDOS
  40+ 92B5              	ELSE
  41+ 92B5                      include "player/mod-processor.asm"
# file opened: player/mod-processor.asm
   1++92B5                  MODULE ModProcessor
   2++92B5                  ifdef GS
   3++92B5
   4++92B5                  macro _WaitCommand2
   5++92B5 ~            .wait
   6++92B5 ~                in a, (CMD)
   7++92B5 ~                rrca
   8++92B5 ~                jr c, .wait
   9++92B5                  endm
  10++92B5
  11++92B5                  macro _SendCommand2 nn
  12++92B5 ~                ld a, nn
  12++92B5 ~              out (CMD), a
  13++92B5                  endm
  14++92B5
  15++92B5              play:
  16++92B5 3E FF            ld a, 255
  17++92B7 32 B4 92         ld (oldminutes), a
  18++92BA
  19++92BA CD 77 6A         call Console.waitForKeyUp
  20++92BD
  21++92BD 21 12 8C         ld hl, Gopher.requestbuffer
  21++92C0 CD 47 6A       call DialogBox.msgNoWait
  22++92C3
  23++92C3                  ;ld a, 1, (Render.play_next), a
  24++92C3 AF           	xor a
  25++92C4 32 59 93     	ld (last_song_position),a
  26++92C7
  27++92C7 26 00 3E 20      ld h, #00, a, 32
  28++92CB CD 47 60         call TextMode.fillLine
  29++92CE 11 01 00         ld de, #0001
  29++92D1 CD 3A 60       call TextMode.gotoXY
  30++92D4 21 18 93         ld hl, message
  30++92D7 CD BC 60       call TextMode.printZ
  31++92DA 3E 00            ld a, #00
  32++92DC CD 7B 60         call TextMode.highlightLine
  33++92DF
  34++92DF              .loop
  35++92DF 76               halt
  36++92E0 AF               xor a
  37++92E1 CD A1 6A         call Console.peekC
  38++92E4 FE 0C            cp Console.BACKSPACE
  39++92E6 CA 12 93         jp z, .stopKey
  40++92E9 FE 20        	cp SPACE
  41++92EB CA 06 93         jp z, .playNext
  42++92EE
  43++92EE CD B3 92         call printRTC
  44++92F1
  45++92F1                 ;проверка что MOD начал играть сначала
  46++92F1                  _SendCommand2 CMD_GET_SONG_POSITION
  46++92F1 3E 60       >    ld a, CMD_GET_SONG_POSITION
  46++92F3 D3 BB       >  out (CMD), a
  47++92F5                  _WaitCommand2
  47++92F5             >.wait
  47++92F5 DB BB       >    in a, (CMD)
  47++92F7 0F          >    rrca
  47++92F8 38 FB       >    jr c, .wait
  48++92FA 3A 59 93     	ld a,(last_song_position) ;предыдущая позиция
  49++92FD 4F           	ld c,a
  50++92FE DB B3        	in a,(DATA) ;текущая позиция
  51++9300 32 59 93     	ld (last_song_position),a
  52++9303 B9           	cp c
  53++9304 30 D9        	jr nc, .loop ;если не меньше, продолжаем играть
  54++9306              .playNext
  55++9306 3E 01 32 88      ld a, 1, (Render.play_next), a ;флаг что надо будет играть следующий файл
  55++930A 69
  56++930B              .stop
  57++930B CD 94 92         call GeneralSound.stopModule
  58++930E
  59++930E CD 77 6A         call Console.waitForKeyUp
  60++9311 C9               ret
  61++9312              .stopKey
  62++9312 AF               xor a
  62++9313 32 88 69       ld (Render.play_next), a ;флаг что не надо играть следующий файл
  63++9316 18 F3            jr .stop
  64++9318
  65++9318              message
  66++9318                  IFDEF SCREEN64
  67++9318                  ENDIF
  68++9318                  IFDEF SCREEN80
  69++9318 ~                db "       "
  70++9318                  ENDIF
  71++9318                  IFDEF SCREEN85
  72++9318 ~                db "         "
  73++9318                  ENDIF
  74++9318
  75++9318 50 6C 61 79      db "Playing MODs [SPACE] for next song [BACKSPACE] for stop playing.", 0
  75++931C 69 6E 67 20
  75++9320 4D 4F 44 73
  75++9324 20 5B 53 50
  75++9328 41 43 45 5D
  75++932C 20 66 6F 72
  75++9330 20 6E 65 78
  75++9334 74 20 73 6F
  75++9338 6E 67 20 5B
  75++933C 42 41 43 4B
  75++9340 53 50 41 43
  75++9344 45 5D 20 66
  75++9348 6F 72 20 73
  75++934C 74 6F 70 20
  75++9350 70 6C 61 79
  75++9354 69 6E 67 2E
  75++9358 00
  76++9359
  77++9359              CMD_GET_SONG_POSITION     = #60
  78++9359 00           last_song_position db 0
  79++935A
  80++935A              ;; Control ports
  81++935A              CMD  = 187
  82++935A              DATA = 179
  83++935A                  endif
  84++935A                  ENDMODULE
  85++935A
# file closed: player/mod-processor.asm
  42+ 935A                      include "screen/screen.asm"
# file opened: screen/screen.asm
   1++935A                  module ScreenViewer
   2++935A              display:
   3++935A CD 77 6A         call Console.waitForKeyUp
   4++935D 3E 07            ld a, 7
   4++935F CD 45 92       call Memory.setPage
   5++9362 21 D0 9F 11      ld hl, outputBuffer, de, #c000, bc, 6912
   5++9366 00 C0 01 00
   5++936A 1B
   5++936B ED B0          ldir
   6++936D CD 46 60         call TextMode.disable
   7++9370              .wait
   8++9370 76           	halt
   9++9371 AF               xor a
   9++9372 DB FE          in a, (#fe)
   9++9374 2F             cpl
   9++9375 E6 1F          and 31
   9++9377 28 F7          jr z, .wait
  10++9379 CD 1D 60         call TextMode.cls
  11++937C C3 EE 73         jp History.back
  12++937F
  13++937F                  endmodule
# file closed: screen/screen.asm
  43+ 937F                      include "player/vortex-processor.asm"
# file opened: player/vortex-processor.asm
   1++937F                  MODULE VortexProcessor
   2++937F              	IFDEF MSX
   3++937F ~            play:
   4++937F ~                call Console.peekC
   4++937F ~              and a
   5++937F ~                jr nz, play
   6++937F ~
   7++937F ~                ld hl, message
   7++937F ~              call DialogBox.msgNoWait
   8++937F ~
   9++937F ~                ld hl, outputBuffer
   9++937F ~              call VTPL.INIT
  10++937F ~            .loop
  11++937F ~                halt
  11++937F ~              di
  11++937F ~              call VTPL.PLAY
  11++937F ~              ei
  12++937F ~                call Console.peekC
  12++937F ~              and a
  12++937F ~              jp nz, .stop
  13++937F ~                jr nc, .loop
  14++937F ~            .stop
  15++937F ~                call VTPL.MUTE
  16++937F ~            .wlp
  17++937F ~                call Console.peekC
  17++937F ~              and a
  18++937F ~                jr nz, .wlp
  19++937F ~                ret
  20++937F ~
  21++937F ~            message db "Press key to stop...", 0
  22++937F ~                ENDMODULE
  23++937F ~                include "msxplayer.asm"
  24++937F              	ELSE
  25++937F              play:
  26++937F 3E FF            ld a, 255
  27++9381 32 B4 92         ld (oldminutes), a
  28++9384
  29++9384 CD 77 6A         call Console.waitForKeyUp
  30++9387
  31++9387 21 C5 93         ld hl, message
  31++938A CD 47 6A       call DialogBox.msgNoWait
  32++938D
  33++938D 21 D0 9F         ld hl, outputBuffer
  33++9390 CD 1B 94       call VTPL.INIT
  34++9393
  35++9393
  36++9393 3E 01 32 88      ld a, 1, (Render.play_next), a
  36++9397 69
  37++9398
  38++9398                  IFDEF GS
  39++9398 CD 94 92         call GeneralSound.stopModule
  40++939B                  ENDIF
  41++939B              .loop
  42++939B 76               halt
  42++939C F3             di
  42++939D CD 3E 9C       call VTPL.PLAY
  42++93A0 FB             ei
  43++93A1 AF               xor a
  43++93A2 DB FE          in a, (#fe)
  43++93A4 2F             cpl
  43++93A5 E6 1F          and 31
  43++93A7 C2 BF 93       jp nz, .stopKey
  44++93AA CD B3 92         call printRTC
  45++93AD 3A E4 93         ld a, (VTPL.SETUP)
  45++93B0 17             rla
  45++93B1 30 E8          jr nc, .loop
  46++93B3 3E 01 32 88      ld a, 1, (Render.play_next), a
  46++93B7 69
  47++93B8              .stop
  48++93B8 CD 09 94         call VTPL.MUTE
  49++93BB
  50++93BB                  IFDEF AY
  51++93BB ~                call restoreAyState
  52++93BB                  ENDIF
  53++93BB
  54++93BB CD 77 6A         call Console.waitForKeyUp
  55++93BE C9               ret
  56++93BF              .stopKey
  57++93BF AF               xor a
  57++93C0 32 88 69       ld (Render.play_next), a
  58++93C3 18 F3            jr .stop
  59++93C5
  60++93C5                  IFDEF AY
  61++93C5 ~            restoreAyState:
  62++93C5 ~                ld a, #07
  63++93C5 ~                ld bc, #fffd
  64++93C5 ~                out (c), a
  65++93C5 ~                ld a, #fc
  66++93C5 ~                ld b, #bf
  67++93C5 ~                out (c), a ; Enable read mode
  68++93C5 ~
  69++93C5 ~                ld a, #0e
  70++93C5 ~                ld bc, #fffd
  71++93C5 ~                out (c), a
  72++93C5 ~                ret
  73++93C5              	ENDIF
  74++93C5 50 72 65 73  message db "Press key to stop...", 0
  74++93C9 73 20 6B 65
  74++93CD 79 20 74 6F
  74++93D1 20 73 74 6F
  74++93D5 70 2E 2E 2E
  74++93D9 00
  75++93DA                  ENDMODULE
  76++93DA                  include "player.asm"
# file opened: player/player.asm
   1++93DA              ;Universal PT2'n'PT3 Turbo Sound player for ZX Spectrum
   2++93DA              ;(c)2004-2007 S.V.Bulba <vorobey@mail.khstu.ru>
   3++93DA              ;Specially for AlCo
   4++93DA              ;http://bulba.untergrund.net/ (http://bulba.at.kz/)
   5++93DA              	MODULE VTPL
   6++93DA              ;Release number
   7++93DA              Release EQU "0"
   8++93DA              ;Conditional assembly
   9++93DA              ;1) Current position counters at (Vars1+0) and (Vars2+0)
  10++93DA              CurPosCounter=0
  11++93DA              ;2) Allow channels allocation bits at (START+10)
  12++93DA              ACBBAC=0
  13++93DA              ;3) Allow loop checking and disabling
  14++93DA              LoopChecker=1
  15++93DA              ;4) Insert official identificator
  16++93DA              Id=0
  17++93DA              ;5) Set IY for correct return to ZX Basic
  18++93DA              Basic=1
  19++93DA
  20++93DA              ;Features
  21++93DA              ;--------
  22++93DA              ;-Can be compiled at any address (i.e. no need rounding ORG
  23++93DA              ; address).
  24++93DA              ;-Variables (VARS) can be located at any address (not only after
  25++93DA              ; code block).
  26++93DA              ;-INIT subprogram checks PT3-module version and rightly
  27++93DA              ; generates both note and volume tables outside of code block
  28++93DA              ; (in VARS).
  29++93DA              ;-Two portamento (spc. command 3xxx) algorithms (depending of
  30++93DA              ; PT3 module version).
  31++93DA              ;-New 1.XX and 2.XX special command behaviour (only for PT v3.7
  32++93DA              ; and higher).
  33++93DA              ;-Any Tempo value are accepted (including Tempo=1 and Tempo=2).
  34++93DA              ;-TS modes: 2xPT3, 2xPT2 and PT v3.7 TS standard.
  35++93DA              ;-Fully compatible with Ay_Emul PT3 and PT2 players codes.
  36++93DA              ;-See also notes at the end of this source code.
  37++93DA
  38++93DA              ;Limitations
  39++93DA              ;-----------
  40++93DA              ;-Can run in RAM only (self-modified code is used).
  41++93DA              ;-PT2 position list must be end by #FF marker only.
  42++93DA
  43++93DA              ;Warning!!! PLAY subprogram can crash if no module are loaded
  44++93DA              ;into RAM or INIT subprogram was not called before.
  45++93DA
  46++93DA              ;Call MUTE or INIT one more time to mute sound after stopping
  47++93DA              ;playing
  48++93DA
  49++93DA              ;Test codes (commented)
  50++93DA              ;	LD A,32 ;SinglePT3(TS if TSPT3.7),ABC,Looped
  51++93DA              ;	LD (START+10),A
  52++93DA              ;	LD HL,#8000 ;Mod1
  53++93DA              ;	LD DE,#A000 ;Mod2 (optional)
  54++93DA              ;	CALL START+3
  55++93DA              ;	EI
  56++93DA              ;_LP	HALT
  57++93DA              ;	CALL START+5
  58++93DA              ;	XOR A
  59++93DA              ;	IN A,(#FE)
  60++93DA              ;	CPL
  61++93DA              ;	AND 15
  62++93DA              ;	JR Z,_LP
  63++93DA              ;	JR START+8
  64++93DA
  65++93DA              TonA	EQU 0
  66++93DA              TonB	EQU 2
  67++93DA              TonC	EQU 4
  68++93DA              Noise	EQU 6
  69++93DA              Mixer	EQU 7
  70++93DA              AmplA	EQU 8
  71++93DA              AmplB	EQU 9
  72++93DA              AmplC	EQU 10
  73++93DA              Env	EQU 11
  74++93DA              EnvTp	EQU 13
  75++93DA
  76++93DA              ;Entry and other points
  77++93DA              ;START initialize playing of modules at MDLADDR (single module)
  78++93DA              ;START+3 initialization with module address in HL and DE (TS)
  79++93DA              ;START+5 play one quark
  80++93DA              ;START+8 mute
  81++93DA              ;START+10 setup and status flags
  82++93DA
  83++93DA              START:
  84++93DA 21 D0 9F     	LD HL,outputBuffer ;DE - address of 2nd module for TS
  85++93DD 18 3C        	JR INIT
  86++93DF C3 3E 9C     	JP PLAY
  87++93E2 18 25        	JR MUTE
  88++93E4 00           SETUP	DB 0 ;set bit0, if you want to play without looping
  89++93E5              	     ;(optional);
  90++93E5              	     ;set bit1 for PT2 and reset for PT3 before
  91++93E5              	     ;calling INIT;
  92++93E5              	     ;bits2-3: %00-ABC, %01-ACB, %10-BAC (optional);
  93++93E5              	     ;bits4-5: %00-no TS, %01-2 modules TS, %10-
  94++93E5              	     ;autodetect PT3 TS-format by AlCo (PT 3.7+);
  95++93E5              	     ;Remark: old PT3 TS-format by AlCo (PT 3.6) is not
  96++93E5              	     ;documented and must be converted to new standard.
  97++93E5              	     ;bit6 is set each time, when loop point of 2nd TS
  98++93E5              	     ;module is passed (optional).
  99++93E5              	     ;bit7 is set each time, when loop point of 1st TS
 100++93E5              	     ;or of single module is passed (optional).
 101++93E5
 102++93E5              ;Identifier
 103++93E5              	IF Id
 104++93E5 ~            	DB "=UniPT2/PT3/TS-Player r.",Release,"="
 105++93E5              	ENDIF
 106++93E5
 107++93E5              	IF LoopChecker
 108++93E5 21 E4 93     CHECKLP	LD HL,SETUP
 109++93E8 FD CB 9E 46  	BIT 0,(IY-100+VRS.ModNum)
 110++93EC 28 04        	JR Z,CHL1
 111++93EE CB F6        	SET 6,(HL)
 112++93F0 18 02        	JR CHL2
 113++93F2 CB FE        CHL1	SET 7,(HL)
 114++93F4 CB 46        CHL2	BIT 0,(HL)
 115++93F6 C8           	RET Z
 116++93F7 E1           	POP HL
 117++93F8 FD 34 09     	INC (IY-100+VRS.DelyCnt)
 118++93FB FD 34 BA     	INC (IY-100+VRS.ChanA+CHP.NtSkCn)
 119++93FE AF           	XOR A
 120++93FF FD 77 1D     	LD (IY-100+VRS.AYREGS+AmplA),A
 121++9402 FD 77 1E     	LD (IY-100+VRS.AYREGS+AmplB),A
 122++9405 FD 77 1F     	LD (IY-100+VRS.AYREGS+AmplC),A
 123++9408 C9           	RET
 124++9409              	ENDIF
 125++9409
 126++9409 AF           MUTE: XOR A
 127++940A 67           	LD H,A
 128++940B 6F           	LD L,A
 129++940C 32 93 9D     	LD (VARS1+VRS.AYREGS+AmplA),A
 130++940F 22 94 9D     	LD (VARS1+VRS.AYREGS+AmplB),HL
 131++9412 32 1A 9E     	LD (VARS2+VRS.AYREGS+AmplA),A
 132++9415 22 1B 9E     	LD (VARS2+VRS.AYREGS+AmplB),HL
 133++9418 C3 56 9C     	JP ROUT
 134++941B
 135++941B              INIT:
 136++941B              ;HL - AddressOfModule
 137++941B              ;DE - AddresOf2ndModule
 138++941B D5           	PUSH DE
 139++941C E5           	PUSH HL
 140++941D 21 11 9D     	LD HL,VARS
 141++9420 36 00        	LD (HL),0
 142++9422 11 12 9D     	LD DE,VARS+1
 143++9425 01 0E 01     	LD BC,VAR0END-VARS-1
 144++9428 ED B0        	LDIR
 145++942A 23           	INC HL
 146++942B 22 74 9D     	LD (VARS1+VRS.AdInPtA),HL ;ptr to zero
 147++942E 22 FB 9D     	LD (VARS2+VRS.AdInPtA),HL
 148++9431
 149++9431 E1           	POP HL
 150++9432 FD 21 76 9D  	LD IY,VARS1+100
 151++9436 3A E4 93     	LD A,(START+10)
 152++9439 E6 02        	AND 2
 153++943B C2 C4 94     	JP NZ,I_PT2
 154++943E
 155++943E CD 11 96     	CALL INITPT3
 156++9441 21 18 1F     	LD HL,(e_-SamCnv-2)*256+#18
 157++9444 22 E4 99     	LD (SamCnv),HL
 158++9447 3E BA        	LD A,#BA
 159++9449 32 AF 99     	LD (OrnCP),A
 160++944C 32 DB 99     	LD (SamCP),A
 161++944F 3E 7B        	LD A,#7B
 162++9451 32 B2 99     	LD (OrnLD),A
 163++9454 32 DE 99     	LD (SamLD),A
 164++9457 3E 87        	LD A,#87
 165++9459 32 D5 99     	LD (SamClc2),A
 166++945C E1           	POP HL
 167++945D              	;Use version and ton table of 1st module
 168++945D DD 7E A9     	LD A,(IX+13-100) ;EXTRACT VERSION NUMBER
 169++9460 D6 30        	SUB #30
 170++9462 38 04        	JR C,L20
 171++9464 FE 0A        	CP 10
 172++9466 38 02        	JR C,L21
 173++9468 3E 06        L20	LD A,6
 174++946A 32 82 98     L21	LD (Version),A
 175++946D F5           	PUSH AF ;VolTable version
 176++946E FE 04        	CP 4
 177++9470 DD 7E FF     	LD A,(IX+99-100) ;TONE TABLE NUMBER
 178++9473 17           	RLA
 179++9474 E6 07        	AND 7
 180++9476 F5           	PUSH AF ;NoteTable number
 181++9477
 182++9477 FD 21 FD 9D  	LD IY,VARS2+100
 183++947B 3A E4 93     	LD A,(START+10)
 184++947E E6 30        	AND 48
 185++9480 28 37        	JR Z,NOTS
 186++9482 FE 10        	CP 16
 187++9484 28 27        	JR Z,TwoPT3s
 188++9486 3A 82 98     	LD A,(Version)
 189++9489 FE 07        	CP 7
 190++948B 38 2C        	JR C,NOTS
 191++948D DD 7E FE     	LD A,(IX+98-100) ;ALCO TS MARKER
 192++9490 FE 20        	CP #20
 193++9492 28 25        	JR Z,NOTS
 194++9494 21 12 9D     	LD HL,VARS1
 195++9497 11 99 9D     	LD DE,VARS2
 196++949A 01 87 00     	LD BC,VRS
 197++949D ED B0        	LDIR
 198++949F FD CB 9E CE  	SET 1,(IY-100+VRS.ModNum)
 199++94A3 4F           	LD C,A
 200++94A4 87           	ADD A,A
 201++94A5 81           	ADD A,C
 202++94A6 D6 02        	SUB 2
 203++94A8 32 49 9B     	LD (TSSub),A
 204++94AB 18 03        	JR AlCoTS_
 205++94AD CD 11 96     TwoPT3s	CALL INITPT3
 206++94B0 3E 01        AlCoTS_	LD A,1
 207++94B2 32 11 9D     	LD (is_ts),A
 208++94B5 FD CB 9E C6  	SET 0,(IY-100+VRS.ModNum)
 209++94B9
 210++94B9 01 CE 97     NOTS	LD BC,PT3PD
 211++94BC 21 00 00     	LD HL,0
 212++94BF 11 D9 9C     	LD DE,PT3EMPTYORN
 213++94C2 18 48        	JR INITCOMMON
 214++94C4
 215++94C4 CD 49 96     I_PT2	CALL INITPT2
 216++94C7 21 CB 51     	LD HL,#51CB
 217++94CA 22 E4 99     	LD (SamCnv),HL
 218++94CD 3E BB        	LD A,#BB
 219++94CF 32 AF 99     	LD (OrnCP),A
 220++94D2 32 DB 99     	LD (SamCP),A
 221++94D5 3E 7A        	LD A,#7A
 222++94D7 32 B2 99     	LD (OrnLD),A
 223++94DA 32 DE 99     	LD (SamLD),A
 224++94DD 3E 80        	LD A,#80
 225++94DF 32 D5 99     	LD (SamClc2),A
 226++94E2 E1           	POP HL
 227++94E3 3E 05        	LD A,5
 228++94E5 32 82 98     	LD (Version),A
 229++94E8 F5           	PUSH AF
 230++94E9 3E 02        	LD A,2
 231++94EB F5           	PUSH AF
 232++94EC
 233++94EC 3A E4 93     	LD A,(START+10)
 234++94EF E6 30        	AND 48
 235++94F1 28 10        	JR Z,NOTS2
 236++94F3
 237++94F3 FD 21 FD 9D  	LD IY,VARS2+100
 238++94F7 3E 01        	LD A,1
 239++94F9 32 11 9D     	LD (is_ts),A
 240++94FC FD CB 9E C6  	SET 0,(IY-100+VRS.ModNum)
 241++9500 CD 49 96     	CALL INITPT2
 242++9503
 243++9503 01 08 97     NOTS2	LD BC,PT2PD
 244++9506 21 87 86     	LD HL,#8687
 245++9509 11 2F 9E     	LD DE,PT2EMPTYORN
 246++950C
 247++950C              INITCOMMON
 248++950C
 249++950C              	IF Basic
 250++950C FD 21 3A 5C  	LD IY,#5C3A
 251++9510              	ENDIF
 252++9510
 253++9510 ED 43 B9 96  	LD (PTDEC),BC
 254++9514 22 4B 9B     	LD (PsCalc),HL
 255++9517 D5           	PUSH DE
 256++9518
 257++9518              ;note table data depacker
 258++9518              ;(c) Ivan Roshin
 259++9518 11 DC 9C     	LD DE,T_PACK
 260++951B 01 81 9E     	LD BC,T1_+(2*49)-1
 261++951E 1A           TP_0	LD A,(DE)
 262++951F 13           	INC DE
 263++9520 FE 1E        	CP 15*2
 264++9522 30 06        	JR NC,TP_1
 265++9524 67           	LD H,A
 266++9525 1A           	LD A,(DE)
 267++9526 6F           	LD L,A
 268++9527 13           	INC DE
 269++9528 18 07        	JR TP_2
 270++952A D5           TP_1	PUSH DE
 271++952B 16 00        	LD D,0
 272++952D 5F           	LD E,A
 273++952E 19           	ADD HL,DE
 274++952F 19           	ADD HL,DE
 275++9530 D1           	POP DE
 276++9531 7C           TP_2	LD A,H
 277++9532 02           	LD (BC),A
 278++9533 0B           	DEC BC
 279++9534 7D           	LD A,L
 280++9535 02           	LD (BC),A
 281++9536 0B           	DEC BC
player.asm(282): warning: value 0x1F0 is truncated to 8bit value: 0xF0
 282++9537 D6 F0        	SUB #F8*2
 283++9539 20 E3        	JR NZ,TP_0
 284++953B
 285++953B 3C           	INC A
 286++953C 32 7F 9D     	LD (VARS1+VRS.DelyCnt),A
 287++953F 32 06 9E     	LD (VARS2+VRS.DelyCnt),A
 288++9542 21 01 F0     	LD HL,#F001 ;H - CHP.Volume, L - CHP.NtSkCn
 289++9545 22 30 9D     	LD (VARS1+VRS.ChanA+CHP.NtSkCn),HL
 290++9548 22 4D 9D     	LD (VARS1+VRS.ChanB+CHP.NtSkCn),HL
 291++954B 22 6A 9D     	LD (VARS1+VRS.ChanC+CHP.NtSkCn),HL
 292++954E 22 B7 9D     	LD (VARS2+VRS.ChanA+CHP.NtSkCn),HL
 293++9551 22 D4 9D     	LD (VARS2+VRS.ChanB+CHP.NtSkCn),HL
 294++9554 22 F1 9D     	LD (VARS2+VRS.ChanC+CHP.NtSkCn),HL
 295++9557 E1           	POP HL
 296++9558 22 22 9D     	LD (VARS1+VRS.ChanA+CHP.OrnPtr),HL
 297++955B 22 3F 9D     	LD (VARS1+VRS.ChanB+CHP.OrnPtr),HL
 298++955E 22 5C 9D     	LD (VARS1+VRS.ChanC+CHP.OrnPtr),HL
 299++9561 22 A9 9D     	LD (VARS2+VRS.ChanA+CHP.OrnPtr),HL
 300++9564 22 C6 9D     	LD (VARS2+VRS.ChanB+CHP.OrnPtr),HL
 301++9567 22 E3 9D     	LD (VARS2+VRS.ChanC+CHP.OrnPtr),HL
 302++956A
 303++956A F1           	POP AF
 304++956B
 305++956B              ;NoteTableCreator (c) Ivan Roshin
 306++956B              ;A - NoteTableNumber*2+VersionForNoteTable
 307++956B              ;(xx1b - 3.xx..3.4r, xx0b - 3.4x..3.6x..VTII1.0)
 308++956B
 309++956B 21 89 9C     	LD HL,NT_DATA
 310++956E 16 00        	LD D,0
 311++9570 87           	ADD A,A
 312++9571 5F           	LD E,A
 313++9572 19           	ADD HL,DE
 314++9573 5E           	LD E,(HL)
 315++9574 23           	INC HL
 316++9575 CB 3B        	SRL E
 317++9577 9F           	SBC A,A
 318++9578 E6 A7        	AND #A7 ;#00 (NOP) or #A7 (AND A)
 319++957A 32 A2 95     	LD (L3),A
 320++957D EB           	EX DE,HL
 321++957E 01 20 9E     	LD BC,T1_
 322++9581 09           	ADD HL,BC
 323++9582
 324++9582 1A           	LD A,(DE)
player.asm(325): warning: value 0x9C99 is truncated to 8bit value: 0x99
 325++9583 C6 99        	ADD A,T_
 326++9585 4F           	LD C,A
 327++9586 CE 9C        	ADC A,T_/256
 328++9588 91           	SUB C
 329++9589 47           	LD B,A
 330++958A C5           	PUSH BC
 331++958B 11 10 9F     	LD DE,NT_
 332++958E D5           	PUSH DE
 333++958F
 334++958F 06 0C        	LD B,12
 335++9591 C5           L1	PUSH BC
 336++9592 4E           	LD C,(HL)
 337++9593 23           	INC HL
 338++9594 E5           	PUSH HL
 339++9595 46           	LD B,(HL)
 340++9596
 341++9596 D5           	PUSH DE
 342++9597 EB           	EX DE,HL
 343++9598 11 17 00     	LD DE,23
 344++959B DD 26 08     	LD IXH,8
 345++959E
 346++959E CB 38        L2	SRL B
 347++95A0 CB 19        	RR C
 348++95A2 19           L3	DB #19	;AND A or NOP
 349++95A3 79           	LD A,C
 350++95A4 8A           	ADC A,D	;=ADC 0
 351++95A5 77           	LD (HL),A
 352++95A6 23           	INC HL
 353++95A7 78           	LD A,B
 354++95A8 8A           	ADC A,D
 355++95A9 77           	LD (HL),A
 356++95AA 19           	ADD HL,DE
 357++95AB DD 25        	DEC IXH
 358++95AD 20 EF        	JR NZ,L2
 359++95AF
 360++95AF D1           	POP DE
 361++95B0 13           	INC DE
 362++95B1 13           	INC DE
 363++95B2 E1           	POP HL
 364++95B3 23           	INC HL
 365++95B4 C1           	POP BC
 366++95B5 10 DA        	DJNZ L1
 367++95B7
 368++95B7 E1           	POP HL
 369++95B8 D1           	POP DE
 370++95B9
 371++95B9 7B           	LD A,E
player.asm(372): warning: value 0x9CA5 is truncated to 8bit value: 0xA5
 372++95BA FE A5        	CP TCOLD_1
 373++95BC 20 05        	JR NZ,CORR_1
 374++95BE 3E FD        	LD A,#FD
 375++95C0 32 3E 9F     	LD (NT_+#2E),A
 376++95C3
 377++95C3 1A           CORR_1	LD A,(DE)
 378++95C4 A7           	AND A
 379++95C5 28 11        	JR Z,TC_EXIT
 380++95C7 1F           	RRA
 381++95C8 F5           	PUSH AF
 382++95C9 87           	ADD A,A
 383++95CA 4F           	LD C,A
 384++95CB 09           	ADD HL,BC
 385++95CC F1           	POP AF
 386++95CD 30 02        	JR NC,CORR_2
 387++95CF 35           	DEC (HL)
 388++95D0 35           	DEC (HL)
 389++95D1 34           CORR_2	INC (HL)
 390++95D2 A7           	AND A
 391++95D3 ED 42        	SBC HL,BC
 392++95D5 13           	INC DE
 393++95D6 18 EB        	JR CORR_1
 394++95D8
 395++95D8              TC_EXIT
 396++95D8
 397++95D8 F1           	POP AF
 398++95D9
 399++95D9              ;VolTableCreator (c) Ivan Roshin
 400++95D9              ;A - VersionForVolumeTable (0..4 - 3.xx..3.4x;
 401++95D9              			   ;5.. - 2.x,3.5x..3.6x..VTII1.0)
 402++95D9
 403++95D9 FE 05        	CP 5
 404++95DB 21 11 00     	LD HL,#11
 405++95DE 54           	LD D,H
 406++95DF 5C           	LD E,H
 407++95E0 3E 17        	LD A,#17
 408++95E2 30 03        	JR NC,M1
 409++95E4 2D           	DEC L
 410++95E5 5D           	LD E,L
 411++95E6 AF           	XOR A
 412++95E7 32 F8 95     M1      LD (M2),A
 413++95EA
 414++95EA DD 21 20 9E  	LD IX,VT_+16
 415++95EE
 416++95EE 0E 0F        	LD C,#F
 417++95F0 E5           INITV2  PUSH HL
 418++95F1
 419++95F1 19           	ADD HL,DE
 420++95F2 EB           	EX DE,HL
 421++95F3 ED 62        	SBC HL,HL
 422++95F5
 423++95F5 06 10        	LD B,#10
 424++95F7 7D           INITV1  LD A,L
 425++95F8 7D           M2      DB #7D
 426++95F9 7C           	LD A,H
 427++95FA CE 00        	ADC A,0
 428++95FC DD 77 00     	LD (IX),A
 429++95FF DD 23        	INC IX
 430++9601 19           	ADD HL,DE
 431++9602 10 F3        	DJNZ INITV1
 432++9604
 433++9604 E1           	POP HL
 434++9605 7B           	LD A,E
 435++9606 FE 77        	CP #77
 436++9608 20 01        	JR NZ,M3
 437++960A 1C           	INC E
 438++960B 0D           M3      DEC C
 439++960C 20 E2        	JR NZ,INITV2
 440++960E
 441++960E C3 56 9C     	JP ROUT
 442++9611
 443++9611 CD 84 96     INITPT3	CALL SETMDAD
 444++9614 E5           	PUSH HL
 445++9615 11 64 00     	LD DE,100
 446++9618 19           	ADD HL,DE
 447++9619 7E           	LD A,(HL)
 448++961A FD 77 08     	LD (IY-100+VRS.Delay),A
 449++961D E5           	PUSH HL
 450++961E DD E1        	POP IX
 451++9620 19           	ADD HL,DE
 452++9621 CD 92 96     	CALL SETCPPT
 453++9624 DD 5E 02     	LD E,(IX+102-100)
 454++9627 23           	INC HL
 455++9628
 456++9628              	IF CurPosCounter
 457++9628 ~            	LD (IY-100+VRS.PosSub),L
 458++9628              	ENDIF
 459++9628
 460++9628 19           	ADD HL,DE
 461++9629 CD 99 96     	CALL SETLPPT
 462++962C D1           	POP DE
 463++962D DD 6E 03     	LD L,(IX+103-100)
 464++9630 DD 66 04     	LD H,(IX+104-100)
 465++9633 19           	ADD HL,DE
 466++9634 CD 7D 96     	CALL SETPTPT
 467++9637 21 A9 00     	LD HL,169
 468++963A 19           	ADD HL,DE
 469++963B CD 8B 96     	CALL SETORPT
 470++963E 21 69 00     	LD HL,105
 471++9641 19           	ADD HL,DE
 472++9642
 473++9642 FD 75 FA     SETSMPT LD (IY-100+VRS.SamPtrs),L
 474++9645 FD 74 FB     	LD (IY-100+VRS.SamPtrs+1),H
 475++9648 C9           	RET
 476++9649
 477++9649 7E           INITPT2	LD A,(HL)
 478++964A FD 77 08     	LD (IY-100+VRS.Delay),A
 479++964D E5           	PUSH HL
 480++964E E5           	PUSH HL
 481++964F E5           	PUSH HL
 482++9650 23           	INC HL
 483++9651 23           	INC HL
 484++9652 7E           	LD A,(HL)
 485++9653 23           	INC HL
 486++9654 CD 42 96     	CALL SETSMPT
 487++9657 5E           	LD E,(HL)
 488++9658 23           	INC HL
 489++9659 56           	LD D,(HL)
 490++965A E1           	POP HL
 491++965B A7           	AND A
 492++965C ED 52        	SBC HL,DE
 493++965E CD 84 96     	CALL SETMDAD
 494++9661 E1           	POP HL
 495++9662 11 43 00     	LD DE,67
 496++9665 19           	ADD HL,DE
 497++9666 CD 8B 96     	CALL SETORPT
 498++9669 1E 20        	LD E,32
 499++966B 19           	ADD HL,DE
 500++966C 4E           	LD C,(HL)
 501++966D 23           	INC HL
 502++966E 46           	LD B,(HL)
 503++966F 1E 1E        	LD E,30
 504++9671 19           	ADD HL,DE
 505++9672 CD 92 96     	CALL SETCPPT
 506++9675 5F           	LD E,A
 507++9676 23           	INC HL
 508++9677
 509++9677              	IF CurPosCounter
 510++9677 ~            	LD (IY-100+VRS.PosSub),L
 511++9677              	ENDIF
 512++9677
 513++9677 19           	ADD HL,DE
 514++9678 CD 99 96     	CALL SETLPPT
 515++967B E1           	POP HL
 516++967C 09           	ADD HL,BC
 517++967D
 518++967D FD 75 FC     SETPTPT	LD (IY-100+VRS.PatsPtr),L
 519++9680 FD 74 FD     	LD (IY-100+VRS.PatsPtr+1),H
 520++9683 C9           	RET
 521++9684
 522++9684 FD 75 F6     SETMDAD	LD (IY-100+VRS.MODADDR),L
 523++9687 FD 74 F7     	LD (IY-100+VRS.MODADDR+1),H
 524++968A C9           	RET
 525++968B
 526++968B FD 75 F8     SETORPT	LD (IY-100+VRS.OrnPtrs),L
 527++968E FD 74 F9     	LD (IY-100+VRS.OrnPtrs+1),H
 528++9691 C9           	RET
 529++9692
 530++9692 FD 75 04     SETCPPT	LD (IY-100+VRS.CrPsPtr),L
 531++9695 FD 74 05     	LD (IY-100+VRS.CrPsPtr+1),H
 532++9698 C9           	RET
 533++9699
 534++9699 FD 75 06     SETLPPT	LD (IY-100+VRS.LPosPtr),L
 535++969C FD 74 07     	LD (IY-100+VRS.LPosPtr+1),H
 536++969F C9           	RET
 537++96A0
 538++96A0 FD 75 13     SETENBS	LD (IY-100+VRS.EnvBase),L
 539++96A3 FD 74 14     	LD (IY-100+VRS.EnvBase+1),H
 540++96A6 C9           	RET
 541++96A7
 542++96A7 FD 75 0C     SETESLD	LD (IY-100+VRS.CurESld),L
 543++96AA FD 74 0D     	LD (IY-100+VRS.CurESld+1),H
 544++96AD C9           	RET
 545++96AE
 546++96AE FD E5        GETIX	PUSH IY
 547++96B0 DD E1        	POP IX
 548++96B2 DD 19        	ADD IX,DE
 549++96B4 C9           	RET
 550++96B5
 551++96B5 CD AE 96     PTDECOD CALL GETIX
 552++96B8              PTDEC	EQU $+1
 553++96B8 C3 C3 C3     	JP #C3C3
 554++96BB
 555++96BB              ;PT2 pattern decoder
 556++96BB CD 51 99     PD2_SAM	CALL SETSAM
 557++96BE 18 4A        	JR PD2_LOOP
 558++96C0
 559++96C0 DD 77 08     PD2_EOff LD (IX-12+CHP.Env_En),A
 560++96C3 18 45        	JR PD2_LOOP
 561++96C5
 562++96C5 DD 36 08 10  PD2_ENV	LD (IX-12+CHP.Env_En),16
 563++96C9 FD 77 22     	LD (IY-100+VRS.AYREGS+EnvTp),A
 564++96CC 0A           	LD A,(BC)
 565++96CD 03           	INC BC
 566++96CE 6F           	LD L,A
 567++96CF 0A           	LD A,(BC)
 568++96D0 03           	INC BC
 569++96D1 67           	LD H,A
 570++96D2 CD A0 96     	CALL SETENBS
 571++96D5 18 33        	JR PD2_LOOP
 572++96D7
 573++96D7 CD 32 99     PD2_ORN	CALL SETORN
 574++96DA 18 2E        	JR PD2_LOOP
 575++96DC
 576++96DC 3C           PD2_SKIP INC A
 577++96DD DD 77 05     	LD (IX-12+CHP.NNtSkp),A
 578++96E0 18 28        	JR PD2_LOOP
 579++96E2
 580++96E2 0F           PD2_VOL	RRCA
 581++96E3 0F           	RRCA
 582++96E4 0F           	RRCA
 583++96E5 0F           	RRCA
 584++96E6 DD 77 10     	LD (IX-12+CHP.Volume),A
 585++96E9 18 1F        	JR PD2_LOOP
 586++96EB
 587++96EB CD 02 99     PD2_DEL	CALL C_DELAY
 588++96EE 18 1A        	JR PD2_LOOP
 589++96F0
 590++96F0 DD CB 09 D6  PD2_GLIS SET 2,(IX-12+CHP.Flags)
 591++96F4 3C           	INC A
 592++96F5 DD 77 0A     	LD (IX-12+CHP.TnSlDl),A
 593++96F8 DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 594++96FB 0A           	LD A,(BC)
 595++96FC 03           	INC BC
 596++96FD DD 77 0B             LD (IX-12+CHP.TSlStp),A
 597++9700 87           	ADD A,A
 598++9701 9F           	SBC A,A
 599++9702 DD 77 0C             LD (IX-12+CHP.TSlStp+1),A
 600++9705 37           	SCF
 601++9706 18 01        	JR PD2_LP2
 602++9708
 603++9708 A7           PT2PD	AND A
 604++9709
 605++9709 08           PD2_LP2	EX AF,AF'
 606++970A
 607++970A 0A           PD2_LOOP LD A,(BC)
 608++970B 03           	INC BC
 609++970C C6 20        	ADD A,#20
 610++970E 28 3F        	JR Z,PD2_REL
 611++9710 38 A9        	JR C,PD2_SAM
 612++9712 C6 60        	ADD A,96
 613++9714 38 3E        	JR C,PD2_NOTE
 614++9716 3C           	INC A
 615++9717 28 A7        	JR Z,PD2_EOff
 616++9719 C6 0F        	ADD A,15
 617++971B CA 31 98     	JP Z,PD_FIN
 618++971E 38 A5        	JR C,PD2_ENV
 619++9720 C6 10        	ADD A,#10
 620++9722 38 B3        	JR C,PD2_ORN
 621++9724 C6 40        	ADD A,#40
 622++9726 38 B4        	JR C,PD2_SKIP
 623++9728 C6 10        	ADD A,#10
 624++972A 38 B6        	JR C,PD2_VOL
 625++972C 3C           	INC A
 626++972D 28 BC        	JR Z,PD2_DEL
 627++972F 3C           	INC A
 628++9730 28 BE        	JR Z,PD2_GLIS
 629++9732 3C           	INC A
 630++9733 28 0A        	JR Z,PD2_PORT
 631++9735 3C           	INC A
 632++9736 28 12        	JR Z,PD2_STOP
 633++9738 0A           	LD A,(BC)
 634++9739 03           	INC BC
 635++973A DD 77 F7     	LD (IX-12+CHP.CrNsSl),A
 636++973D 18 CB        	JR PD2_LOOP
 637++973F
 638++973F DD CB 09 96  PD2_PORT RES 2,(IX-12+CHP.Flags)
 639++9743 0A           	LD A,(BC)
 640++9744 03           	INC BC
 641++9745 03           	INC BC ;ignoring precalc delta to right sound
 642++9746 03           	INC BC
 643++9747 37           	SCF
 644++9748 18 BF        	JR PD2_LP2
 645++974A
 646++974A DD 77 F9     PD2_STOP LD (IX-12+CHP.TSlCnt),A
 647++974D 18 BB        	JR PD2_LOOP
 648++974F
 649++974F DD 77 09     PD2_REL	LD (IX-12+CHP.Flags),A
 650++9752 18 2C        	JR PD2_EXIT
 651++9754
 652++9754 6F           PD2_NOTE LD L,A
 653++9755 DD 7E 06     	LD A,(IX-12+CHP.Note)
 654++9758 32 6B 98     	LD (PrNote+1),A
 655++975B DD 75 06     	LD (IX-12+CHP.Note),L
 656++975E AF           	XOR A
 657++975F DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 658++9762 DD CB 09 C6  	SET 0,(IX-12+CHP.Flags)
 659++9766 08           	EX AF,AF'
 660++9767 30 16        	JR NC,NOGLIS2
 661++9769 DD CB 09 56  	BIT 2,(IX-12+CHP.Flags)
 662++976D 20 0C        	JR NZ,NOPORT2
 663++976F 32 91 98     	LD (LoStep),A
 664++9772 87           	ADD A,A
 665++9773 9F           	SBC A,A
 666++9774 08           	EX AF,AF'
 667++9775 67           	LD H,A
 668++9776 6F           	LD L,A
 669++9777 3C           	INC A
 670++9778 CD 4C 98     	CALL SETPORT
 671++977B DD 36 F9 01  NOPORT2	LD (IX-12+CHP.TSlCnt),1
 672++977F AF           NOGLIS2	XOR A
 673++9780
 674++9780
 675++9780 DD 77 F5     PD2_EXIT LD (IX-12+CHP.PsInSm),A
 676++9783 DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 677++9786 DD 77 FA     	LD (IX-12+CHP.CrTnSl),A
 678++9789 DD 77 FB     	LD (IX-12+CHP.CrTnSl+1),A
 679++978C C3 31 98     	JP PD_FIN
 680++978F
 681++978F              ;PT3 pattern decoder
 682++978F DD 36 08 00  PD_OrSm	LD (IX-12+CHP.Env_En),0
 683++9793 CD 32 99     	CALL SETORN
 684++9796 0A           PD_SAM_	LD A,(BC)
 685++9797 03           	INC BC
 686++9798 0F           	RRCA
 687++9799
 688++9799 CD 51 99     PD_SAM	CALL SETSAM
 689++979C 18 3F        	JR PD_LOOP
 690++979E
 691++979E 0F           PD_VOL	RRCA
 692++979F 0F           	RRCA
 693++97A0 0F           	RRCA
 694++97A1 0F           	RRCA
 695++97A2 DD 77 10     	LD (IX-12+CHP.Volume),A
 696++97A5 18 39        	JR PD_LP2
 697++97A7
 698++97A7 DD 77 08     PD_EOff	LD (IX-12+CHP.Env_En),A
 699++97AA DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 700++97AD 18 31        	JR PD_LP2
 701++97AF
 702++97AF 3D           PD_SorE	DEC A
 703++97B0 20 07        	JR NZ,PD_ENV
 704++97B2 0A           	LD A,(BC)
 705++97B3 03           	INC BC
 706++97B4 DD 77 05     	LD (IX-12+CHP.NNtSkp),A
 707++97B7 18 27        	JR PD_LP2
 708++97B9
 709++97B9 CD 17 99     PD_ENV	CALL SETENV
 710++97BC 18 22        	JR PD_LP2
 711++97BE
 712++97BE CD 32 99     PD_ORN	CALL SETORN
 713++97C1 18 1A        	JR PD_LOOP
 714++97C3
 715++97C3 DD 77 08     PD_ESAM	LD (IX-12+CHP.Env_En),A
 716++97C6 DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 717++97C9 C4 17 99     	CALL NZ,SETENV
 718++97CC 18 C8        	JR PD_SAM_
 719++97CE
 720++97CE DD 7E 06     PT3PD	LD A,(IX-12+CHP.Note)
 721++97D1 32 6B 98     	LD (PrNote+1),A
 722++97D4 DD 6E FA     	LD L,(IX-12+CHP.CrTnSl)
 723++97D7 DD 66 FB     	LD H,(IX-12+CHP.CrTnSl+1)
 724++97DA 22 88 98     	LD (PrSlide+1),HL
 725++97DD
 726++97DD 11 10 20     PD_LOOP	LD DE,#2010
 727++97E0 0A           PD_LP2	LD A,(BC)
 728++97E1 03           	INC BC
 729++97E2 83           	ADD A,E
 730++97E3 38 AA        	JR C,PD_OrSm
 731++97E5 82           	ADD A,D
 732++97E6 28 49        	JR Z,PD_FIN
 733++97E8 38 AF        	JR C,PD_SAM
 734++97EA 83           	ADD A,E
 735++97EB 28 25        	JR Z,PD_REL
 736++97ED 38 AF        	JR C,PD_VOL
 737++97EF 83           	ADD A,E
 738++97F0 28 B5        	JR Z,PD_EOff
 739++97F2 38 BB        	JR C,PD_SorE
 740++97F4 C6 60        	ADD A,96
 741++97F6 38 20        	JR C,PD_NOTE
 742++97F8 83           	ADD A,E
 743++97F9 38 C3        	JR C,PD_ORN
 744++97FB 82           	ADD A,D
 745++97FC 38 0F        	JR C,PD_NOIS
 746++97FE 83           	ADD A,E
 747++97FF 38 C2        	JR C,PD_ESAM
 748++9801 87           	ADD A,A
 749++9802 5F           	LD E,A
player.asm(750): warning: value 0x1788D is truncated to 16bit value: 0x788D
 750++9803 21 8D 78     	LD HL,SPCCOMS+#FF20-#2000
 751++9806 19           	ADD HL,DE
 752++9807 5E           	LD E,(HL)
 753++9808 23           	INC HL
 754++9809 56           	LD D,(HL)
 755++980A D5           	PUSH DE
 756++980B 18 D0        	JR PD_LOOP
 757++980D
 758++980D FD 77 10     PD_NOIS	LD (IY-100+VRS.Ns_Base),A
 759++9810 18 CE        	JR PD_LP2
 760++9812
 761++9812 DD CB 09 86  PD_REL	RES 0,(IX-12+CHP.Flags)
 762++9816 18 08        	JR PD_RES
 763++9818
 764++9818 DD 77 06     PD_NOTE	LD (IX-12+CHP.Note),A
 765++981B DD CB 09 C6  	SET 0,(IX-12+CHP.Flags)
 766++981F AF           	XOR A
 767++9820
 768++9820 ED 73 2F 98  PD_RES	LD (PDSP_+1),SP
 769++9824 DD F9        	LD SP,IX
 770++9826 67           	LD H,A
 771++9827 6F           	LD L,A
 772++9828 E5           	PUSH HL
 773++9829 E5           	PUSH HL
 774++982A E5           	PUSH HL
 775++982B E5           	PUSH HL
 776++982C E5           	PUSH HL
 777++982D E5           	PUSH HL
 778++982E 31 31 31     PDSP_	LD SP,#3131
 779++9831
 780++9831 DD 7E 05     PD_FIN	LD A,(IX-12+CHP.NNtSkp)
 781++9834 DD 77 0F     	LD (IX-12+CHP.NtSkCn),A
 782++9837 C9           	RET
 783++9838
 784++9838 0A           C_PORTM LD A,(BC)
 785++9839 03           	INC BC
 786++983A              ;SKIP PRECALCULATED TONE DELTA (BECAUSE
 787++983A              ;CANNOT BE RIGHT AFTER PT3 COMPILATION)
 788++983A 03           	INC BC
 789++983B 03           	INC BC
 790++983C 08           	EX AF,AF'
 791++983D 0A           	LD A,(BC) ;SIGNED TONE STEP
 792++983E 03           	INC BC
 793++983F 32 91 98     	LD (LoStep),A
 794++9842 0A           	LD A,(BC)
 795++9843 03           	INC BC
 796++9844 A7           	AND A
 797++9845 08           	EX AF,AF'
 798++9846 DD 6E FA     	LD L,(IX-12+CHP.CrTnSl)
 799++9849 DD 66 FB     	LD H,(IX-12+CHP.CrTnSl+1)
 800++984C
 801++984C              ;Set portamento variables
 802++984C              ;A - Delay; A' - Hi(Step); ZF' - (A'=0); HL - CrTnSl
 803++984C
 804++984C DD CB 09 96  SETPORT	RES 2,(IX-12+CHP.Flags)
 805++9850 DD 77 0A     	LD (IX-12+CHP.TnSlDl),A
 806++9853 DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 807++9856 E5           	PUSH HL
 808++9857 11 10 9F     	LD DE,NT_
 809++985A DD 7E 06     	LD A,(IX-12+CHP.Note)
 810++985D DD 77 07     	LD (IX-12+CHP.SlToNt),A
 811++9860 87           	ADD A,A
 812++9861 6F           	LD L,A
 813++9862 26 00        	LD H,0
 814++9864 19           	ADD HL,DE
 815++9865 7E           	LD A,(HL)
 816++9866 23           	INC HL
 817++9867 66           	LD H,(HL)
 818++9868 6F           	LD L,A
 819++9869 E5           	PUSH HL
 820++986A 3E 3E        PrNote	LD A,#3E
 821++986C DD 77 06     	LD (IX-12+CHP.Note),A
 822++986F 87           	ADD A,A
 823++9870 6F           	LD L,A
 824++9871 26 00        	LD H,0
 825++9873 19           	ADD HL,DE
 826++9874 5E           	LD E,(HL)
 827++9875 23           	INC HL
 828++9876 56           	LD D,(HL)
 829++9877 E1           	POP HL
 830++9878 ED 52        	SBC HL,DE
 831++987A DD 75 0D     	LD (IX-12+CHP.TnDelt),L
 832++987D DD 74 0E     	LD (IX-12+CHP.TnDelt+1),H
 833++9880 D1           	POP DE
 834++9881              Version EQU $+1
 835++9881 3E 3E        	LD A,#3E
 836++9883 FE 06        	CP 6
 837++9885 38 09        	JR C,OLDPRTM ;Old 3xxx for PT v3.5-
 838++9887 11 11 11     PrSlide	LD DE,#1111
 839++988A DD 73 FA     	LD (IX-12+CHP.CrTnSl),E
 840++988D DD 72 FB     	LD (IX-12+CHP.CrTnSl+1),D
 841++9890              LoStep	EQU $+1
 842++9890 3E 3E        OLDPRTM	LD A,#3E
 843++9892 08           	EX AF,AF'
 844++9893 28 01        	JR Z,NOSIG
 845++9895 EB           	EX DE,HL
 846++9896 ED 52        NOSIG	SBC HL,DE
 847++9898 F2 A0 98     	JP P,SET_STP
 848++989B 2F           	CPL
 849++989C 08           	EX AF,AF'
 850++989D ED 44        	NEG
 851++989F 08           	EX AF,AF'
 852++98A0 DD 77 0C     SET_STP	LD (IX-12+CHP.TSlStp+1),A
 853++98A3 08           	EX AF,AF'
 854++98A4 DD 77 0B     	LD (IX-12+CHP.TSlStp),A
 855++98A7 DD 36 FE 00  	LD (IX-12+CHP.COnOff),0
 856++98AB C9           	RET
 857++98AC
 858++98AC DD CB 09 D6  C_GLISS	SET 2,(IX-12+CHP.Flags)
 859++98B0 0A           	LD A,(BC)
 860++98B1 03           	INC BC
 861++98B2 DD 77 0A     	LD (IX-12+CHP.TnSlDl),A
 862++98B5 A7           	AND A
 863++98B6 20 07        	JR NZ,GL36
 864++98B8 3A 82 98     	LD A,(Version) ;AlCo PT3.7+
 865++98BB FE 07        	CP 7
 866++98BD 9F           	SBC A,A
 867++98BE 3C           	INC A
 868++98BF DD 77 F9     GL36	LD (IX-12+CHP.TSlCnt),A
 869++98C2 0A           	LD A,(BC)
 870++98C3 03           	INC BC
 871++98C4 08           	EX AF,AF'
 872++98C5 0A           	LD A,(BC)
 873++98C6 03           	INC BC
 874++98C7 18 D7        	JR SET_STP
 875++98C9
 876++98C9 0A           C_SMPOS	LD A,(BC)
 877++98CA 03           	INC BC
 878++98CB DD 77 F5     	LD (IX-12+CHP.PsInSm),A
 879++98CE C9           	RET
 880++98CF
 881++98CF 0A           C_ORPOS	LD A,(BC)
 882++98D0 03           	INC BC
 883++98D1 DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 884++98D4 C9           	RET
 885++98D5
 886++98D5 0A           C_VIBRT	LD A,(BC)
 887++98D6 03           	INC BC
 888++98D7 DD 77 FF     	LD (IX-12+CHP.OnOffD),A
 889++98DA DD 77 FE     	LD (IX-12+CHP.COnOff),A
 890++98DD 0A           	LD A,(BC)
 891++98DE 03           	INC BC
 892++98DF DD 77 00     	LD (IX-12+CHP.OffOnD),A
 893++98E2 AF           	XOR A
 894++98E3 DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 895++98E6 DD 77 FA     	LD (IX-12+CHP.CrTnSl),A
 896++98E9 DD 77 FB     	LD (IX-12+CHP.CrTnSl+1),A
 897++98EC C9           	RET
 898++98ED
 899++98ED 0A           C_ENGLS	LD A,(BC)
 900++98EE 03           	INC BC
 901++98EF FD 77 0E     	LD (IY-100+VRS.Env_Del),A
 902++98F2 FD 77 0F     	LD (IY-100+VRS.CurEDel),A
 903++98F5 0A           	LD A,(BC)
 904++98F6 03           	INC BC
 905++98F7 6F           	LD L,A
 906++98F8 0A           	LD A,(BC)
 907++98F9 03           	INC BC
 908++98FA 67           	LD H,A
 909++98FB FD 75 0A     	LD (IY-100+VRS.ESldAdd),L
 910++98FE FD 74 0B     	LD (IY-100+VRS.ESldAdd+1),H
 911++9901 C9           	RET
 912++9902
 913++9902 0A           C_DELAY	LD A,(BC)
 914++9903 03           	INC BC
 915++9904 FD 77 08     	LD (IY-100+VRS.Delay),A
 916++9907 21 9B 9D     	LD HL,VARS2+VRS.ModNum ;if AlCo_TS
 917++990A CB 4E        	BIT 1,(HL)
 918++990C C8           	RET Z
 919++990D 32 7E 9D     	LD (VARS1+VRS.Delay),A
 920++9910 32 7F 9D     	LD (VARS1+VRS.DelyCnt),A
 921++9913 32 05 9E     	LD (VARS2+VRS.Delay),A
 922++9916 C9           	RET
 923++9917
 924++9917 DD 73 08     SETENV	LD (IX-12+CHP.Env_En),E
 925++991A FD 77 22     	LD (IY-100+VRS.AYREGS+EnvTp),A
 926++991D 0A           	LD A,(BC)
 927++991E 03           	INC BC
 928++991F 67           	LD H,A
 929++9920 0A           	LD A,(BC)
 930++9921 03           	INC BC
 931++9922 6F           	LD L,A
 932++9923 CD A0 96     	CALL SETENBS
 933++9926 AF           	XOR A
 934++9927 DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 935++992A FD 77 0F     	LD (IY-100+VRS.CurEDel),A
 936++992D 67           	LD H,A
 937++992E 6F           	LD L,A
 938++992F C3 A7 96     	JP SETESLD
 939++9932
 940++9932 87           SETORN	ADD A,A
 941++9933 5F           	LD E,A
 942++9934 16 00        	LD D,0
 943++9936 DD 72 F4     	LD (IX-12+CHP.PsInOr),D
 944++9939 FD 6E F8     	LD L,(IY-100+VRS.OrnPtrs)
 945++993C FD 66 F9     	LD H,(IY-100+VRS.OrnPtrs+1)
 946++993F 19           	ADD HL,DE
 947++9940 5E           	LD E,(HL)
 948++9941 23           	INC HL
 949++9942 56           	LD D,(HL)
 950++9943 FD 6E F6     	LD L,(IY-100+VRS.MODADDR)
 951++9946 FD 66 F7     	LD H,(IY-100+VRS.MODADDR+1)
 952++9949 19           	ADD HL,DE
 953++994A DD 75 01     	LD (IX-12+CHP.OrnPtr),L
 954++994D DD 74 02     	LD (IX-12+CHP.OrnPtr+1),H
 955++9950 C9           C_NOP	RET
 956++9951
 957++9951 87           SETSAM	ADD A,A
 958++9952 5F           	LD E,A
 959++9953 16 00        	LD D,0
 960++9955 FD 6E FA     	LD L,(IY-100+VRS.SamPtrs);
 961++9958 FD 66 FB     	LD H,(IY-100+VRS.SamPtrs+1);
 962++995B 19           	ADD HL,DE
 963++995C 5E           	LD E,(HL)
 964++995D 23           	INC HL
 965++995E 56           	LD D,(HL)
 966++995F FD 6E F6     	LD L,(IY-100+VRS.MODADDR)
 967++9962 FD 66 F7     	LD H,(IY-100+VRS.MODADDR+1)
 968++9965 19           	ADD HL,DE
 969++9966 DD 75 03     	LD (IX-12+CHP.SamPtr),L
 970++9969 DD 74 04     	LD (IX-12+CHP.SamPtr+1),H
 971++996C C9           	RET
 972++996D
 973++996D              ;ALL 16 ADDRESSES TO PROTECT FROM BROKEN PT3 MODULES
 974++996D 50 99        SPCCOMS DW C_NOP
 975++996F AC 98        	DW C_GLISS
 976++9971 38 98        	DW C_PORTM
 977++9973 C9 98        	DW C_SMPOS
 978++9975 CF 98        	DW C_ORPOS
 979++9977 D5 98        	DW C_VIBRT
 980++9979 50 99        	DW C_NOP
 981++997B 50 99        	DW C_NOP
 982++997D ED 98        	DW C_ENGLS
 983++997F 02 99        	DW C_DELAY
 984++9981 50 99        	DW C_NOP
 985++9983 50 99        	DW C_NOP
 986++9985 50 99        	DW C_NOP
 987++9987 50 99        	DW C_NOP
 988++9989 50 99        	DW C_NOP
 989++998B 50 99        	DW C_NOP
 990++998D
 991++998D CD AE 96     CHREGS	CALL GETIX
 992++9990 AF           	XOR A
 993++9991 32 CD 9B     	LD (Ampl),A
 994++9994 DD CB 15 46  	BIT 0,(IX+CHP.Flags)
 995++9998 E5           	PUSH HL
 996++9999 CA E0 9A     	JP Z,CH_EXIT
 997++999C ED 73 2A 9A  	LD (CSP_+1),SP
 998++99A0 DD 6E 0D     	LD L,(IX+CHP.OrnPtr)
 999++99A3 DD 66 0E     	LD H,(IX+CHP.OrnPtr+1)
1000++99A6 F9           	LD SP,HL
1001++99A7 D1           	POP DE
1002++99A8 67           	LD H,A
1003++99A9 DD 7E 00     	LD A,(IX+CHP.PsInOr)
1004++99AC 6F           	LD L,A
1005++99AD 39           	ADD HL,SP
1006++99AE 3C           	INC A
1007++99AF              		;PT2	PT3
1008++99AF 3C           OrnCP	INC A	;CP E	CP D
1009++99B0 38 01        	JR C,CH_ORPS
1010++99B2 01           OrnLD	DB 1	;LD A,D	LD A,E
1011++99B3 DD 77 00     CH_ORPS	LD (IX+CHP.PsInOr),A
1012++99B6 DD 7E 12     	LD A,(IX+CHP.Note)
1013++99B9 86           	ADD A,(HL)
1014++99BA F2 BE 99     	JP P,CH_NTP
1015++99BD AF           	XOR A
1016++99BE FE 60        CH_NTP	CP 96
1017++99C0 38 02        	JR C,CH_NOK
1018++99C2 3E 5F        	LD A,95
1019++99C4 87           CH_NOK	ADD A,A
1020++99C5 08           	EX AF,AF'
1021++99C6 DD 6E 0F     	LD L,(IX+CHP.SamPtr)
1022++99C9 DD 66 10     	LD H,(IX+CHP.SamPtr+1)
1023++99CC F9           	LD SP,HL
1024++99CD D1           	POP DE
1025++99CE 26 00        	LD H,0
1026++99D0 DD 7E 01     	LD A,(IX+CHP.PsInSm)
1027++99D3 47           	LD B,A
1028++99D4 87           	ADD A,A
1029++99D5 87           SamClc2	ADD A,A ;or ADD A,B for PT2
1030++99D6 6F           	LD L,A
1031++99D7 39           	ADD HL,SP
1032++99D8 F9           	LD SP,HL
1033++99D9 78           	LD A,B
1034++99DA 3C           	INC A
1035++99DB              		;PT2	PT3
1036++99DB 3C           SamCP	INC A	;CP E	CP D
1037++99DC 38 01        	JR C,CH_SMPS
1038++99DE 01           SamLD	DB 1	;LD A,D	LD A,E
1039++99DF DD 77 01     CH_SMPS	LD (IX+CHP.PsInSm),A
1040++99E2 C1           	POP BC
1041++99E3 E1           	POP HL
1042++99E4
1043++99E4              ;Convert PT2 sample to PT3
1044++99E4              		;PT2		PT3
1045++99E4 E1           SamCnv	POP HL  ;BIT 2,C	JR e_
1046++99E5 E1           	POP HL
1047++99E6 60           	LD H,B
1048++99E7 20 06        	JR NZ,$+8
1049++99E9 EB           	EX DE,HL
1050++99EA A7           	AND A
1051++99EB ED 62        	SBC HL,HL
1052++99ED ED 52        	SBC HL,DE
1053++99EF 51           	LD D,C
1054++99F0 CB 19        	RR C
1055++99F2 9F           	SBC A,A
1056++99F3 2F           	CPL
1057++99F4 E6 3E        	AND #3E
1058++99F6 CB 19        	RR C
1059++99F8 CB 18        	RR B
1060++99FA A1           	AND C
1061++99FB 4F           	LD C,A
1062++99FC 78           	LD A,B
1063++99FD 1F           	RRA
1064++99FE 1F           	RRA
1065++99FF CB 1A        	RR D
1066++9A01 1F           	RRA
1067++9A02 E6 9F        	AND #9F
1068++9A04 47           	LD B,A
1069++9A05
1070++9A05 DD 5E 08     e_	LD E,(IX+CHP.TnAcc)
1071++9A08 DD 56 09     	LD D,(IX+CHP.TnAcc+1)
1072++9A0B 19           	ADD HL,DE
1073++9A0C CB 70        	BIT 6,B
1074++9A0E 28 06        	JR Z,CH_NOAC
1075++9A10 DD 75 08     	LD (IX+CHP.TnAcc),L
1076++9A13 DD 74 09     	LD (IX+CHP.TnAcc+1),H
1077++9A16 EB           CH_NOAC EX DE,HL
1078++9A17 08           	EX AF,AF'
player.asm(1079): warning: value 0x9F10 is truncated to 8bit value: 0x10
1079++9A18 C6 10        	ADD A,NT_
1080++9A1A 6F           	LD L,A
1081++9A1B CE 9F        	ADC A,NT_/256
1082++9A1D 95           	SUB L
1083++9A1E 67           	LD H,A
1084++9A1F F9           	LD SP,HL
1085++9A20 E1           	POP HL
1086++9A21 19           	ADD HL,DE
1087++9A22 DD 5E 06     	LD E,(IX+CHP.CrTnSl)
1088++9A25 DD 56 07     	LD D,(IX+CHP.CrTnSl+1)
1089++9A28 19           	ADD HL,DE
1090++9A29 31 31 31     CSP_	LD SP,#3131
1091++9A2C E3           	EX (SP),HL
1092++9A2D AF           	XOR A
1093++9A2E DD B6 05     	OR (IX+CHP.TSlCnt)
1094++9A31 28 3E        	JR Z,CH_AMP
1095++9A33 DD 35 05     	DEC (IX+CHP.TSlCnt)
1096++9A36 20 39        	JR NZ,CH_AMP
1097++9A38 DD 7E 16     	LD A,(IX+CHP.TnSlDl)
1098++9A3B DD 77 05     	LD (IX+CHP.TSlCnt),A
1099++9A3E DD 6E 17     	LD L,(IX+CHP.TSlStp)
1100++9A41 DD 66 18     	LD H,(IX+CHP.TSlStp+1)
1101++9A44 7C           	LD A,H
1102++9A45 19           	ADD HL,DE
1103++9A46 DD 75 06     	LD (IX+CHP.CrTnSl),L
1104++9A49 DD 74 07     	LD (IX+CHP.CrTnSl+1),H
1105++9A4C DD CB 15 56  	BIT 2,(IX+CHP.Flags)
1106++9A50 20 1F        	JR NZ,CH_AMP
1107++9A52 DD 5E 19     	LD E,(IX+CHP.TnDelt)
1108++9A55 DD 56 1A     	LD D,(IX+CHP.TnDelt+1)
1109++9A58 A7           	AND A
1110++9A59 28 01        	JR Z,CH_STPP
1111++9A5B EB           	EX DE,HL
1112++9A5C ED 52        CH_STPP SBC HL,DE
1113++9A5E FA 71 9A     	JP M,CH_AMP
1114++9A61 DD 7E 13     	LD A,(IX+CHP.SlToNt)
1115++9A64 DD 77 12     	LD (IX+CHP.Note),A
1116++9A67 AF           	XOR A
1117++9A68 DD 77 05     	LD (IX+CHP.TSlCnt),A
1118++9A6B DD 77 06     	LD (IX+CHP.CrTnSl),A
1119++9A6E DD 77 07     	LD (IX+CHP.CrTnSl+1),A
1120++9A71 DD 7E 02     CH_AMP	LD A,(IX+CHP.CrAmSl)
1121++9A74 CB 79        	BIT 7,C
1122++9A76 28 13        	JR Z,CH_NOAM
1123++9A78 CB 71        	BIT 6,C
1124++9A7A 28 07        	JR Z,CH_AMIN
1125++9A7C FE 0F        	CP 15
1126++9A7E 28 0B        	JR Z,CH_NOAM
1127++9A80 3C           	INC A
1128++9A81 18 05        	JR CH_SVAM
1129++9A83 FE F1        CH_AMIN	CP -15
1130++9A85 28 04        	JR Z,CH_NOAM
1131++9A87 3D           	DEC A
1132++9A88 DD 77 02     CH_SVAM	LD (IX+CHP.CrAmSl),A
1133++9A8B 6F           CH_NOAM	LD L,A
1134++9A8C 78           	LD A,B
1135++9A8D E6 0F        	AND 15
1136++9A8F 85           	ADD A,L
1137++9A90 F2 94 9A     	JP P,CH_APOS
1138++9A93 AF           	XOR A
1139++9A94 FE 10        CH_APOS	CP 16
1140++9A96 38 02        	JR C,CH_VOL
1141++9A98 3E 0F        	LD A,15
1142++9A9A DD B6 1C     CH_VOL	OR (IX+CHP.Volume)
player.asm(1143): warning: value 0x9E10 is truncated to 8bit value: 0x10
1143++9A9D C6 10        	ADD A,VT_
1144++9A9F 6F           	LD L,A
1145++9AA0 CE 9E        	ADC A,VT_/256
1146++9AA2 95           	SUB L
1147++9AA3 67           	LD H,A
1148++9AA4 7E           	LD A,(HL)
1149++9AA5 CB 41        CH_ENV	BIT 0,C
1150++9AA7 20 03        	JR NZ,CH_NOEN
1151++9AA9 DD B6 14     	OR (IX+CHP.Env_En)
1152++9AAC 32 CD 9B     CH_NOEN	LD (Ampl),A
1153++9AAF CB 78        	BIT 7,B
1154++9AB1 79           	LD A,C
1155++9AB2 28 1A        	JR Z,NO_ENSL
1156++9AB4 17           	RLA
1157++9AB5 17           	RLA
1158++9AB6 CB 2F        	SRA A
1159++9AB8 CB 2F        	SRA A
1160++9ABA CB 2F        	SRA A
1161++9ABC DD 86 04     	ADD A,(IX+CHP.CrEnSl) ;SEE COMMENT BELOW
1162++9ABF CB 68        	BIT 5,B
1163++9AC1 28 03        	JR Z,NO_ENAC
1164++9AC3 DD 77 04     	LD (IX+CHP.CrEnSl),A
1165++9AC6 FD 86 12     NO_ENAC	ADD A,(IY-100+VRS.AddToEn) ;BUG IN PT3 - NEED WORD HERE
1166++9AC9 FD 77 12     	LD (IY-100+VRS.AddToEn),A
1167++9ACC 18 0E        	JR CH_MIX
1168++9ACE 1F           NO_ENSL RRA
1169++9ACF DD 86 03     	ADD A,(IX+CHP.CrNsSl)
1170++9AD2 FD 77 11     	LD (IY-100+VRS.AddToNs),A
1171++9AD5 CB 68        	BIT 5,B
1172++9AD7 28 03        	JR Z,CH_MIX
1173++9AD9 DD 77 03     	LD (IX+CHP.CrNsSl),A
1174++9ADC 78           CH_MIX	LD A,B
1175++9ADD 1F           	RRA
1176++9ADE E6 48        	AND #48
1177++9AE0 FD B6 1C     CH_EXIT	OR (IY-100+VRS.AYREGS+Mixer)
1178++9AE3 0F           	RRCA
1179++9AE4 FD 77 1C     	LD (IY-100+VRS.AYREGS+Mixer),A
1180++9AE7 E1           	POP HL
1181++9AE8 AF           	XOR A
1182++9AE9 DD B6 0A     	OR (IX+CHP.COnOff)
1183++9AEC C8           	RET Z
1184++9AED DD 35 0A     	DEC (IX+CHP.COnOff)
1185++9AF0 C0           	RET NZ
1186++9AF1 DD AE 15     	XOR (IX+CHP.Flags)
1187++9AF4 DD 77 15     	LD (IX+CHP.Flags),A
1188++9AF7 1F           	RRA
1189++9AF8 DD 7E 0B     	LD A,(IX+CHP.OnOffD)
1190++9AFB 38 03        	JR C,CH_ONDL
1191++9AFD DD 7E 0C     	LD A,(IX+CHP.OffOnD)
1192++9B00 DD 77 0A     CH_ONDL	LD (IX+CHP.COnOff),A
1193++9B03 C9           	RET
1194++9B04
1195++9B04 AF           PLAY_	XOR A
1196++9B05 FD 77 12     	LD (IY-100+VRS.AddToEn),A
1197++9B08 FD 77 1C     	LD (IY-100+VRS.AYREGS+Mixer),A
1198++9B0B 3D           	DEC A
1199++9B0C FD 77 22     	LD (IY-100+VRS.AYREGS+EnvTp),A
1200++9B0F FD 35 09     	DEC (IY-100+VRS.DelyCnt)
1201++9B12 C2 BA 9B     	JP NZ,PL2
1202++9B15 FD 35 BA     	DEC (IY-100+VRS.ChanA+CHP.NtSkCn)
1203++9B18 20 6C        	JR NZ,PL1B
1204++9B1A FD 4E FE     	LD C,(IY-100+VRS.AdInPtA)
1205++9B1D FD 46 FF     	LD B,(IY-100+VRS.AdInPtA+1)
1206++9B20 0A           	LD A,(BC)
1207++9B21 A7           	AND A
1208++9B22 20 56        	JR NZ,PL1A
1209++9B24 57           	LD D,A
1210++9B25 FD 77 10     	LD (IY-100+VRS.Ns_Base),A
1211++9B28 FD 6E 04     	LD L,(IY-100+VRS.CrPsPtr)
1212++9B2B FD 66 05     	LD H,(IY-100+VRS.CrPsPtr+1)
1213++9B2E 23           	INC HL
1214++9B2F 7E           	LD A,(HL)
1215++9B30 3C           	INC A
1216++9B31 20 0B        	JR NZ,PLNLP
1217++9B33
1218++9B33              	IF LoopChecker
1219++9B33 CD E5 93     	CALL CHECKLP
1220++9B36              	ENDIF
1221++9B36
1222++9B36 FD 6E 06     	LD L,(IY-100+VRS.LPosPtr)
1223++9B39 FD 66 07     	LD H,(IY-100+VRS.LPosPtr+1)
1224++9B3C 7E           	LD A,(HL)
1225++9B3D 3C           	INC A
1226++9B3E CD 92 96     PLNLP	CALL SETCPPT
1227++9B41 3D           	DEC A
1228++9B42 FD CB 9E 4E  	BIT 1,(IY-100+VRS.ModNum)
1229++9B46 28 03        	JR Z,NoAlCo
1230++9B48              TSSub	EQU $+1
1231++9B48 D6 D6        	SUB #D6
1232++9B4A 2F           	CPL
1233++9B4B              NoAlCo
1234++9B4B              		;PT2		PT3
1235++9B4B 3D           PsCalc	DEC A	;ADD A,A	NOP
1236++9B4C 3D           	DEC A	;ADD A,(HL)	NOP
1237++9B4D 87           	ADD A,A
1238++9B4E 5F           	LD E,A
1239++9B4F CB 12        	RL D
1240++9B51
1241++9B51              	IF CurPosCounter
1242++9B51 ~            	LD A,L
1243++9B51 ~            	SUB (IY-100+VRS.PosSub)
1244++9B51 ~            	LD (IY-100+VRS.CurPos),A
1245++9B51              	ENDIF
1246++9B51
1247++9B51 FD 6E FC     	LD L,(IY-100+VRS.PatsPtr)
1248++9B54 FD 66 FD     	LD H,(IY-100+VRS.PatsPtr+1)
1249++9B57 19           	ADD HL,DE
1250++9B58 FD 5E F6     	LD E,(IY-100+VRS.MODADDR)
1251++9B5B FD 56 F7     	LD D,(IY-100+VRS.MODADDR+1)
1252++9B5E ED 73 78 9B  	LD (PSP_+1),SP
1253++9B62 F9           	LD SP,HL
1254++9B63 E1           	POP HL
1255++9B64 19           	ADD HL,DE
1256++9B65 44           	LD B,H
1257++9B66 4D           	LD C,L
1258++9B67 E1           	POP HL
1259++9B68 19           	ADD HL,DE
1260++9B69 FD 75 00     	LD (IY-100+VRS.AdInPtB),L
1261++9B6C FD 74 01     	LD (IY-100+VRS.AdInPtB+1),H
1262++9B6F E1           	POP HL
1263++9B70 19           	ADD HL,DE
1264++9B71 FD 75 02     	LD (IY-100+VRS.AdInPtC),L
1265++9B74 FD 74 03     	LD (IY-100+VRS.AdInPtC+1),H
1266++9B77 31 31 31     PSP_	LD SP,#3131
1267++9B7A 11 AB FF     PL1A	LD DE,VRS.ChanA+12-100
1268++9B7D CD B5 96     	CALL PTDECOD
1269++9B80 FD 71 FE     	LD (IY-100+VRS.AdInPtA),C
1270++9B83 FD 70 FF     	LD (IY-100+VRS.AdInPtA+1),B
1271++9B86
1272++9B86 FD 35 D7     PL1B	DEC (IY-100+VRS.ChanB+CHP.NtSkCn)
1273++9B89 20 12        	JR NZ,PL1C
1274++9B8B 11 C8 FF     	LD DE,VRS.ChanB+12-100
1275++9B8E FD 4E 00     	LD C,(IY-100+VRS.AdInPtB)
1276++9B91 FD 46 01     	LD B,(IY-100+VRS.AdInPtB+1)
1277++9B94 CD B5 96     	CALL PTDECOD
1278++9B97 FD 71 00     	LD (IY-100+VRS.AdInPtB),C
1279++9B9A FD 70 01     	LD (IY-100+VRS.AdInPtB+1),B
1280++9B9D
1281++9B9D FD 35 F4     PL1C	DEC (IY-100+VRS.ChanC+CHP.NtSkCn)
1282++9BA0 20 12        	JR NZ,PL1D
1283++9BA2 11 E5 FF     	LD DE,VRS.ChanC+12-100
1284++9BA5 FD 4E 02     	LD C,(IY-100+VRS.AdInPtC)
1285++9BA8 FD 46 03     	LD B,(IY-100+VRS.AdInPtC+1)
1286++9BAB CD B5 96     	CALL PTDECOD
1287++9BAE FD 71 02     	LD (IY-100+VRS.AdInPtC),C
1288++9BB1 FD 70 03     	LD (IY-100+VRS.AdInPtC+1),B
1289++9BB4
1290++9BB4 FD 7E 08     PL1D	LD A,(IY-100+VRS.Delay)
1291++9BB7 FD 77 09     	LD (IY-100+VRS.DelyCnt),A
1292++9BBA
1293++9BBA 11 9F FF     PL2	LD DE,VRS.ChanA-100
1294++9BBD FD 6E 15     	LD L,(IY-100+VRS.AYREGS+TonA)
1295++9BC0 FD 66 16     	LD H,(IY-100+VRS.AYREGS+TonA+1)
1296++9BC3 CD 8D 99     	CALL CHREGS
1297++9BC6 FD 75 15     	LD (IY-100+VRS.AYREGS+TonA),L
1298++9BC9 FD 74 16     	LD (IY-100+VRS.AYREGS+TonA+1),H
1299++9BCC              Ampl	EQU $+1
1300++9BCC 3E 3E        	LD A,#3E
1301++9BCE FD 77 1D     	LD (IY-100+VRS.AYREGS+AmplA),A
1302++9BD1 11 BC FF     	LD DE,VRS.ChanB-100
1303++9BD4 FD 6E 17     	LD L,(IY-100+VRS.AYREGS+TonB)
1304++9BD7 FD 66 18     	LD H,(IY-100+VRS.AYREGS+TonB+1)
1305++9BDA CD 8D 99     	CALL CHREGS
1306++9BDD FD 75 17     	LD (IY-100+VRS.AYREGS+TonB),L
1307++9BE0 FD 74 18     	LD (IY-100+VRS.AYREGS+TonB+1),H
1308++9BE3 3A CD 9B     	LD A,(Ampl)
1309++9BE6 FD 77 1E     	LD (IY-100+VRS.AYREGS+AmplB),A
1310++9BE9 11 D9 FF     	LD DE,VRS.ChanC-100
1311++9BEC FD 6E 19     	LD L,(IY-100+VRS.AYREGS+TonC)
1312++9BEF FD 66 1A     	LD H,(IY-100+VRS.AYREGS+TonC+1)
1313++9BF2 CD 8D 99     	CALL CHREGS
1314++9BF5 FD 75 19     	LD (IY-100+VRS.AYREGS+TonC),L
1315++9BF8 FD 74 1A     	LD (IY-100+VRS.AYREGS+TonC+1),H
1316++9BFB 3A CD 9B     	LD A,(Ampl)
1317++9BFE FD 77 1F     	LD (IY-100+VRS.AYREGS+AmplC),A
1318++9C01
1319++9C01 FD 7E 10     	LD A,(IY-100+VRS.Ns_Base)
1320++9C04 FD 86 11     	ADD (IY-100+VRS.AddToNs)
1321++9C07 FD 77 1B     	LD (IY-100+VRS.AYREGS+Noise),A
1322++9C0A
1323++9C0A FD 7E 12     	LD A,(IY-100+VRS.AddToEn)
1324++9C0D 5F           	LD E,A
1325++9C0E 87           	ADD A,A
1326++9C0F 9F           	SBC A,A
1327++9C10 57           	LD D,A
1328++9C11 FD 6E 13     	LD L,(IY-100+VRS.EnvBase)
1329++9C14 FD 66 14     	LD H,(IY-100+VRS.EnvBase+1)
1330++9C17 19           	ADD HL,DE
1331++9C18 FD 5E 0C     	LD E,(IY-100+VRS.CurESld)
1332++9C1B FD 56 0D     	LD D,(IY-100+VRS.CurESld+1)
1333++9C1E 19           	ADD HL,DE
1334++9C1F FD 75 20     	LD (IY-100+VRS.AYREGS+Env),L
1335++9C22 FD 74 21     	LD (IY-100+VRS.AYREGS+Env+1),H
1336++9C25
1337++9C25 AF           	XOR A
1338++9C26 FD B6 0F     	OR (IY-100+VRS.CurEDel)
1339++9C29 C8           	RET Z
1340++9C2A FD 35 0F     	DEC (IY-100+VRS.CurEDel)
1341++9C2D C0           	RET NZ
1342++9C2E FD 7E 0E     	LD A,(IY-100+VRS.Env_Del)
1343++9C31 FD 77 0F     	LD (IY-100+VRS.CurEDel),A
1344++9C34 FD 6E 0A     	LD L,(IY-100+VRS.ESldAdd)
1345++9C37 FD 66 0B     	LD H,(IY-100+VRS.ESldAdd+1)
1346++9C3A 19           	ADD HL,DE
1347++9C3B C3 A7 96     	JP SETESLD
1348++9C3E
1349++9C3E FD 21 76 9D  PLAY    LD IY,VARS1+100
1350++9C42 CD 04 9B     	CALL PLAY_
1351++9C45 3A 11 9D     	LD A,(is_ts)
1352++9C48 A7           	AND A
1353++9C49 28 07        	JR Z,PL_nts
1354++9C4B FD 21 FD 9D  	LD IY,VARS2+100
1355++9C4F CD 04 9B     	CALL PLAY_
1356++9C52              PL_nts
1357++9C52              	IF Basic
1358++9C52 FD 21 3A 5C  	LD IY,#5C3A
1359++9C56              	ENDIF
1360++9C56
1361++9C56 01 FD FF     ROUT	LD BC,#FFFD
1362++9C59 3A 11 9D     	LD A,(is_ts)
1363++9C5C A7           	AND A
1364++9C5D 28 02        	JR Z,r_nts ;keep old standard
1365++9C5F ED 41        	OUT (C),B
1366++9C61 08           r_nts	EX AF,AF'
1367++9C62
1368++9C62              	IF ACBBAC
1369++9C62 ~            	LD IX,VARS1+VRS.AYREGS
1370++9C62              	ELSE
1371++9C62 21 8B 9D     	LD HL,VARS1+VRS.AYREGS
1372++9C65              	ENDIF
1373++9C65
1374++9C65 CD 71 9C     	CALL ROUT_
1375++9C68 08           	EX AF,AF'
1376++9C69 C8           	RET Z
1377++9C6A 42           	LD B,D
1378++9C6B 2F           	CPL
1379++9C6C ED 79        	OUT (C),A
1380++9C6E
1381++9C6E              	IF ACBBAC
1382++9C6E ~            	LD IX,VARS2+VRS.AYREGS
1383++9C6E              	ELSE
1384++9C6E 21 12 9E     	LD HL,VARS2+VRS.AYREGS
1385++9C71              	ENDIF
1386++9C71
1387++9C71              ROUT_
1388++9C71              	IF ACBBAC
1389++9C71 ~            	LD A,(SETUP)
1390++9C71 ~            	AND 12
1391++9C71 ~            	JR Z,ABC
1392++9C71 ~            	ADD A,CHTABLE
1393++9C71 ~            	LD E,A
1394++9C71 ~            	ADC A,CHTABLE/256
1395++9C71 ~            	SUB E
1396++9C71 ~            	LD D,A
1397++9C71 ~            	LD B,0
1398++9C71 ~            	PUSH IX
1399++9C71 ~            	POP HL
1400++9C71 ~            	LD A,(DE)
1401++9C71 ~            	INC DE
1402++9C71 ~            	LD C,A
1403++9C71 ~            	ADD HL,BC
1404++9C71 ~            	LD A,(IX+TonB)
1405++9C71 ~            	LD C,(HL)
1406++9C71 ~            	LD (IX+TonB),C
1407++9C71 ~            	LD (HL),A
1408++9C71 ~            	INC HL
1409++9C71 ~            	LD A,(IX+TonB+1)
1410++9C71 ~            	LD C,(HL)
1411++9C71 ~            	LD (IX+TonB+1),C
1412++9C71 ~            	LD (HL),A
1413++9C71 ~            	LD A,(DE)
1414++9C71 ~            	INC DE
1415++9C71 ~            	LD C,A
1416++9C71 ~            	ADD HL,BC
1417++9C71 ~            	LD A,(IX+AmplB)
1418++9C71 ~            	LD C,(HL)
1419++9C71 ~            	LD (IX+AmplB),C
1420++9C71 ~            	LD (HL),A
1421++9C71 ~            	LD A,(DE)
1422++9C71 ~            	INC DE
1423++9C71 ~            	LD (RxCA1),A
1424++9C71 ~            	XOR 8
1425++9C71 ~            	LD (RxCA2),A
1426++9C71 ~            	LD A,(DE)
1427++9C71 ~            	AND (IX+Mixer)
1428++9C71 ~            	LD E,A
1429++9C71 ~            	LD A,(IX+Mixer)
1430++9C71 ~            RxCA1	DB #E6
1431++9C71 ~            	AND %010010
1432++9C71 ~            	OR E
1433++9C71 ~            	LD E,A
1434++9C71 ~            	LD A,(IX+Mixer)
1435++9C71 ~            	AND %010010
1436++9C71 ~            RxCA2	OR E
1437++9C71 ~            	OR E
1438++9C71 ~            	LD (IX+Mixer),A
1439++9C71 ~            ABC
1440++9C71              	ENDIF
1441++9C71
1442++9C71 AF           	XOR A
1443++9C72 11 BF FF     	LD DE,#FFBF
1444++9C75
1445++9C75              	IF ACBBAC
1446++9C75 ~            	LD BC,#FFFD
1447++9C75 ~            	PUSH IX
1448++9C75 ~            	POP HL
1449++9C75              	ENDIF
1450++9C75
1451++9C75 ED 79        LOUT	OUT (C),A
1452++9C77 43           	LD B,E
1453++9C78 ED A3        	OUTI
1454++9C7A 42           	LD B,D
1455++9C7B 3C           	INC A
1456++9C7C FE 0D        	CP 13
1457++9C7E 20 F5        	JR NZ,LOUT
1458++9C80 ED 79        	OUT (C),A
1459++9C82 7E           	LD A,(HL)
1460++9C83 A7           	AND A
1461++9C84 F8           	RET M
1462++9C85 43           	LD B,E
1463++9C86 ED 79        	OUT (C),A
1464++9C88 C9           	RET
1465++9C89
1466++9C89              	IF ACBBAC
1467++9C89 ~            CHTABLE	EQU $-4
1468++9C89 ~            	DB 4,5,15,%001001,0,7,7,%100100
1469++9C89              	ENDIF
1470++9C89
1471++9C89 64           NT_DATA	DB (T_NEW_0-T1_)*2
1472++9C8A 2A           	DB TCNEW_0-T_
1473++9C8B 65           	DB (T_OLD_0-T1_)*2+1
1474++9C8C 00           	DB TCOLD_0-T_
1475++9C8D 01           	DB (T_NEW_1-T1_)*2+1
1476++9C8E 0C           	DB TCNEW_1-T_
1477++9C8F 01           	DB (T_OLD_1-T1_)*2+1
1478++9C90 0C           	DB TCOLD_1-T_
1479++9C91 94           	DB (T_NEW_2-T1_)*2
1480++9C92 35           	DB TCNEW_2-T_
1481++9C93 30           	DB (T_OLD_2-T1_)*2
1482++9C94 0E           	DB TCOLD_2-T_
1483++9C95 60           	DB (T_NEW_3-T1_)*2
1484++9C96 20           	DB TCNEW_3-T_
1485++9C97 60           	DB (T_OLD_3-T1_)*2
1486++9C98 21           	DB TCOLD_3-T_
1487++9C99
1488++9C99              T_
1489++9C99
1490++9C99 01 05 09 0B  TCOLD_0	DB #00+1,#04+1,#08+1,#0A+1,#0C+1,#0E+1,#12+1,#14+1
1490++9C9D 0D 0F 13 15
1491++9CA1 19 25 3D 00  	DB #18+1,#24+1,#3C+1,0
1492++9CA5 5D 00        TCOLD_1	DB #5C+1,0
1493++9CA7 31 37 4D 53  TCOLD_2	DB #30+1,#36+1,#4C+1,#52+1,#5E+1,#70+1,#82,#8C,#9C
1493++9CAB 5F 71 82 8C
1493++9CAF 9C
1494++9CB0 9E A0 A6 A8  	DB #9E,#A0,#A6,#A8,#AA,#AC,#AE,#AE,0
1494++9CB4 AA AC AE AE
1494++9CB8 00
1495++9CB9 57           TCNEW_3	DB #56+1
1496++9CBA 1F 23 25 29  TCOLD_3	DB #1E+1,#22+1,#24+1,#28+1,#2C+1,#2E+1,#32+1,#BE+1,0
1496++9CBE 2D 2F 33 BF
1496++9CC2 00
1497++9CC3 1D 21 23 27  TCNEW_0	DB #1C+1,#20+1,#22+1,#26+1,#2A+1,#2C+1,#30+1,#54+1
1497++9CC7 2B 2D 31 55
1498++9CCB BD BF 00     	DB #BC+1,#BE+1,0
1499++9CCE              TCNEW_1 EQU TCOLD_1
1500++9CCE 1B 21 25 29  TCNEW_2	DB #1A+1,#20+1,#24+1,#28+1,#2A+1,#3A+1,#4C+1,#5E+1
1500++9CD2 2B 3B 4D 5F
1501++9CD6 BB BD BF 00  	DB #BA+1,#BC+1,#BE+1,0
1502++9CDA
1503++9CDA              PT3EMPTYORN EQU $-1
1504++9CDA 01 00        	DB 1,0
1505++9CDC
1506++9CDC              ;first 12 values of tone tables (packed)
1507++9CDC
player.asm(1508): warning: value 0xDD8 is truncated to 8bit value: 0xD8
1508++9CDC 0D D8        T_PACK	DB #06EC*2/256,#06EC*2
1509++9CDE 69           	DB #0755-#06EC
1510++9CDF 70           	DB #07C5-#0755
1511++9CE0 76           	DB #083B-#07C5
1512++9CE1 7D           	DB #08B8-#083B
1513++9CE2 85           	DB #093D-#08B8
1514++9CE3 8D           	DB #09CA-#093D
1515++9CE4 95           	DB #0A5F-#09CA
1516++9CE5 9D           	DB #0AFC-#0A5F
1517++9CE6 A8           	DB #0BA4-#0AFC
1518++9CE7 B1           	DB #0C55-#0BA4
1519++9CE8 BB           	DB #0D10-#0C55
player.asm(1520): warning: value 0xCDA is truncated to 8bit value: 0xDA
1520++9CE9 0C DA        	DB #066D*2/256,#066D*2
1521++9CEB 62           	DB #06CF-#066D
1522++9CEC 68           	DB #0737-#06CF
1523++9CED 6D           	DB #07A4-#0737
1524++9CEE 75           	DB #0819-#07A4
1525++9CEF 7B           	DB #0894-#0819
1526++9CF0 83           	DB #0917-#0894
1527++9CF1 8A           	DB #09A1-#0917
1528++9CF2 92           	DB #0A33-#09A1
1529++9CF3 9C           	DB #0ACF-#0A33
1530++9CF4 A4           	DB #0B73-#0ACF
1531++9CF5 AF           	DB #0C22-#0B73
1532++9CF6 B8           	DB #0CDA-#0C22
player.asm(1533): warning: value 0xE08 is truncated to 8bit value: 0x08
1533++9CF7 0E 08        	DB #0704*2/256,#0704*2
1534++9CF9 6A           	DB #076E-#0704
1535++9CFA 72           	DB #07E0-#076E
1536++9CFB 78           	DB #0858-#07E0
1537++9CFC 7E           	DB #08D6-#0858
1538++9CFD 86           	DB #095C-#08D6
1539++9CFE 90           	DB #09EC-#095C
1540++9CFF 96           	DB #0A82-#09EC
1541++9D00 A0           	DB #0B22-#0A82
1542++9D01 AA           	DB #0BCC-#0B22
1543++9D02 B4           	DB #0C80-#0BCC
1544++9D03 BE           	DB #0D3E-#0C80
player.asm(1545): warning: value 0xFC0 is truncated to 8bit value: 0xC0
1545++9D04 0F C0        	DB #07E0*2/256,#07E0*2
1546++9D06 78           	DB #0858-#07E0
1547++9D07 88           	DB #08E0-#0858
1548++9D08 80           	DB #0960-#08E0
1549++9D09 90           	DB #09F0-#0960
1550++9D0A 98           	DB #0A88-#09F0
1551++9D0B A0           	DB #0B28-#0A88
1552++9D0C B0           	DB #0BD8-#0B28
1553++9D0D A8           	DB #0C80-#0BD8
1554++9D0E E0           	DB #0D60-#0C80
1555++9D0F B0           	DB #0E10-#0D60
1556++9D10 E8           	DB #0EF8-#0E10
1557++9D11
1558++9D11              ;vars from here can be stripped
1559++9D11              ;you can move VARS to any other address
1560++9D11
1561++9D11              VARS
1562++9D11
1563++9D11 00           is_ts	DB 0
1564++9D12
1565++9D12              ;ChannelsVars
1566++9D12              	STRUCT	CHP
1567++9D12 ~            ;reset group
1568++9D12 ~            PsInOr	DB 0
1569++9D12 ~            PsInSm	DB 0
1570++9D12 ~            CrAmSl	DB 0
1571++9D12 ~            CrNsSl	DB 0
1572++9D12 ~            CrEnSl	DB 0
1573++9D12 ~            TSlCnt	DB 0
1574++9D12 ~            CrTnSl	DW 0
1575++9D12 ~            TnAcc	DW 0
1576++9D12 ~            COnOff	DB 0
1577++9D12 ~            ;reset group
1578++9D12 ~
1579++9D12 ~            OnOffD	DB 0
1580++9D12 ~
1581++9D12 ~            ;IX for PTDECOD here (+12)
1582++9D12 ~            OffOnD	DB 0
1583++9D12 ~            OrnPtr	DW 0
1584++9D12 ~            SamPtr	DW 0
1585++9D12 ~            NNtSkp	DB 0
1586++9D12 ~            Note	DB 0
1587++9D12 ~            SlToNt	DB 0
1588++9D12 ~            Env_En	DB 0
1589++9D12 ~            Flags	DB 0
1590++9D12 ~             ;Enabled - 0, SimpleGliss - 2
1591++9D12 ~            TnSlDl	DB 0
1592++9D12 ~            TSlStp	DW 0
1593++9D12 ~            TnDelt	DW 0
1594++9D12 ~            NtSkCn	DB 0
1595++9D12 ~            Volume	DB 0
1596++9D12              	ENDS
1597++9D12
1598++9D12              	STRUCT	VRS
1599++9D12 ~
1600++9D12 ~            ;IF not works in STRUCT in SjASM :(
1601++9D12 ~            ;	IF CurPosCounter
1602++9D12 ~            CurPos	DB 0
1603++9D12 ~            PosSub	DB 0
1604++9D12 ~            ;	ENDIF
1605++9D12 ~
1606++9D12 ~            ModNum	DB 0 ;bit0: ChipNum
1607++9D12 ~            	     ;bit1: 1-reversed patterns order (AlCo TS)
1608++9D12 ~
1609++9D12 ~            ChanA	DS CHP
1610++9D12 ~            ChanB	DS CHP
1611++9D12 ~            ChanC	DS CHP
1612++9D12 ~
1613++9D12 ~            ;GlobalVars
1614++9D12 ~            MODADDR	DW 0
1615++9D12 ~            OrnPtrs	DW 0
1616++9D12 ~            SamPtrs	DW 0
1617++9D12 ~            PatsPtr	DW 0
1618++9D12 ~            AdInPtA	DW 0
1619++9D12 ~            AdInPtB	DW 0
1620++9D12 ~            AdInPtC	DW 0
1621++9D12 ~            CrPsPtr	DW 0
1622++9D12 ~            LPosPtr	DW 0
1623++9D12 ~            Delay	DB 0
1624++9D12 ~            DelyCnt	DB 0
1625++9D12 ~            ESldAdd	DW 0
1626++9D12 ~            CurESld	DW 0
1627++9D12 ~            Env_Del	DB 0
1628++9D12 ~            CurEDel	DB 0
1629++9D12 ~            Ns_Base	DB 0
1630++9D12 ~            AddToNs	DB 0
1631++9D12 ~            AddToEn	DB 0
1632++9D12 ~            EnvBase	DW 0
1633++9D12 ~            AYREGS	DS 14
1634++9D12              	ENDS
1635++9D12
1636++9D12 00 00 00...  VARS1	DS VRS
1637++9D99 00 00 00...  VARS2	DS VRS
1638++9E20
1639++9E20              VT_	EQU $-16
1640++9E20 00 00 00...  	DS 256-16 ;CreatedVolumeTableAddress
1641++9F10
1642++9F10              T1_	EQU VT_+16 ;Tone tables data depacked here
1643++9F10
1644++9F10              T_OLD_1	EQU T1_
1645++9F10              T_OLD_2	EQU T_OLD_1+24
1646++9F10              T_OLD_3	EQU T_OLD_2+24
1647++9F10              T_OLD_0	EQU T_OLD_3+2
1648++9F10              T_NEW_0	EQU T_OLD_0
1649++9F10              T_NEW_1	EQU T_OLD_1
1650++9F10              T_NEW_2	EQU T_NEW_0+24
1651++9F10              T_NEW_3	EQU T_OLD_3
1652++9F10
1653++9F10              PT2EMPTYORN EQU VT_+31 ;1,0,0 sequence
1654++9F10
1655++9F10 00 00 00...  NT_	DS 192 ;CreatedNoteTableAddress
1656++9FD0
1657++9FD0              VAR0END	EQU VT_+16 ;INIT zeroes from VARS to VAR0END-1
1658++9FD0
1659++9FD0              VARSEND EQU $
1660++9FD0
1661++9FD0              MDLADDR EQU outputBuffer
1662++9FD0
1663++9FD0              ;Release 0 steps:
1664++9FD0              ;04/21/2007
1665++9FD0              ;Works start (PTxPlay adaptation); first beta.
1666++9FD0              ;04/22/2007
1667++9FD0              ;Job finished; beta-testing.
1668++9FD0              ;04/23/2007
1669++9FD0              ;PT v3.7 TS mode corrected (after AlCo remarks).
1670++9FD0              ;04/29/2007
1671++9FD0              ;Added 1.XX and 2.XX special commands interpretation for PT3
1672++9FD0              ;modules of v3.7+.
1673++9FD0
1674++9FD0              ;Size (minimal build for ZX Spectrum):
1675++9FD0              ;Code block #908 bytes
1676++9FD0              ;Variables #2BF bytes (can be stripped)
1677++9FD0              ;Total size #908+#2BF=#BC7 (3015) bytes
1678++9FD0              	ENDMODULE
# file closed: player/player.asm
  77++9FD0                  ENDIF
# file closed: player/vortex-processor.asm
  44+ 9FD0
  45+ 9FD0              start:
  46+ 9FD0              outputBuffer:
  47+ 9FD0 F3                   di
  48+ 9FD1 AF                   xor a
  48+ 9FD2 32 6A 5C       ld (#5c6a), a  ; Thank you, Mario Prato, for feedback
  49+ 9FD5 32 00 5C             ld (#5c00),a
  50+ 9FD8 31 00 60             ld sp, asmOrg
  51+ 9FDB CD 3B 92             call Memory.init
  52+ 9FDE AF                   xor a
  52+ 9FDF D3 FE          out (#fe),a
  53+ 9FE1 FB                   ei
  54+ 9FE2
  55+ 9FE2 3E 07                ld a, 7
  55+ 9FE4 CD 45 92       call Memory.setPage
  56+ 9FE7                      ;; Logo
  57+ 9FE7 21 22 A0 06          ld hl, logo, b, Dos.FMODE_READ
  57+ 9FEB 01
  57+ 9FEC CD EB 6C       call Dos.fopen
  58+ 9FEF F5                   push af
  59+ 9FF0 21 00 C0 01          ld hl, #c000, bc, 6912
  59+ 9FF4 00 1B
  59+ 9FF6 CD 42 6F       call Dos.fread
  60+ 9FF9 F1                   pop af
  61+ 9FFA CD 36 6E             call Dos.fclose
  62+ 9FFD
  63+ 9FFD 06 32                ld b, 50
  64+ 9FFF 76           1       halt
  65+ A000 10 FD                djnz 1b
  66+ A002                  ENDIF
  67+ A002
  68+ A002 CD 03 60         call TextMode.init
  69+ A005 21 11 A0     	ld hl, initing
  69+ A008 CD BC 60       call TextMode.printZ
  70+ A00B
  71+ A00B                  IFNDEF NOINIT
  72+ A00B CD F3 8E       	    call Wifi.init
  73+ A00E                  ENDIF
  74+ A00E
  75+ A00E C3 5B 74         jp History.home
  76+ A011
  77+ A011 49 6E 69 74  initing db "Initing Wifi...", "\r", 0
  77+ A015 69 6E 67 20
  77+ A019 57 69 66 69
  77+ A01D 2E 2E 2E 0D
  77+ A021 00
  78+ A022 62 72 6F 77  logo    db "browser/logo.scr", 0
  78+ A026 73 65 72 2F
  78+ A02A 6C 6F 67 6F
  78+ A02E 2E 73 63 72
  78+ A032 00
  79+ A033 62 72 6F 77  creds   db "browser/auth.pwd", 0
  79+ A037 73 65 72 2F
  79+ A03B 61 75 74 68
  79+ A03F 2E 70 77 64
  79+ A043 00
  80+ A044              outputBuffer2:
  81+ A044 41 54 45 30      db  "ATE0", 0
  81+ A048 00
  82+ A049                  display "ENDS: ", $
  83+ A049                  display "Buff size", #ffff - $
  84+ A049
  85+ A049              	IFDEF TRDOS
  86+ A049              		SAVETRD "TRD/MRF.TRD",|"AY56-64.C",asmOrg, $ - asmOrg
  87+ A049              	        ELSE
  88+ A049 ~            			    savebin BINNAME, asmOrg, $ - asmOrg
  89+ A049                 	ENDIF
  90+ A049
# file closed: main-all.asm
  17  A049                  ENDIF
# file closed: main.asm
