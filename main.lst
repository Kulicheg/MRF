# file opened: main.asm
   1  0000                  DEFINE TCP_BUF_SIZE 1024
   2  0000              ; Generate version string
   3  0000                  LUA ALLPASS
   4  0000 ~                v = tostring(sj.get_define("V"))
   5  0000 ~                maj = string.sub(v, 1,1)
   6  0000 ~                min = string.sub(v, 2,2)
   7  0000 ~                sj.insert_define("VERSION_STRING", "\"" .. maj .. "." .. min .. "\"")
   8  0000 ~
   9  0000 ~                b = tostring(sj.get_define("BLD"))
  10  0000 ~                sj.insert_define("BUILD_STRING", "\"" .. b .. "\"")
  11  0000                  ENDLUA
  12  0000
  13  0000                  IFDEF MSX
  14  0000 ~                    include "main-msx.asm"
  15  0000                  ELSE
  16  0000                      include "main-all.asm"
# file opened: main-all.asm
   1+ 0000                  device	zxspectrum128
   2+ 0000                  IFDEF NEDOOS
   3+ 0000 ~            	DEFINE CRLF "\r\n"
   4+ 0000 ~                    MODULE nos
   5+ 0000 ~                        include "../_sdk/sysdefs.asm"
   6+ 0000 ~                    ENDMODULE
   7+ 0000 ~                    org nos.PROGSTART
   8+ 0000                      ELSE
   9+ 0000              	DEFINE CRLF "\r"
  10+ 0000                      org 24576
  11+ 6000                  ENDIF
  12+ 6000              asmOrg:
  13+ 6000                  align 256
  14+ 6000 C3 E2 97         jp start
  15+ 6003                  include "vdp/index.asm"
# file opened: vdp/index.asm
   1++6003                  IFDEF TIMEX
   2++6003 ~                include "timex.asm"
   3++6003                  ENDIF
   4++6003
   5++6003                  IFDEF TIMEX80
   6++6003 ~                include "timex80.asm"
   7++6003                  ENDIF
   8++6003
   9++6003                  IFDEF ZXSCR
  10++6003                  include "zx.asm"
# file opened: vdp/zx.asm
   1++6003              COLOR=1
   2++6003              ;; Usual speccy screen driver
   3++6003                  module TextMode
   4++6003              init:
   5++6003 21 D5 61 06      ld hl, font_file, b, Dos.FMODE_READ
   5++6007 01
   6++6008 CD 6B 6C         call Dos.fopen
   7++600B F5               push af
   8++600C 01 00 08 21      ld bc, 2048, hl, font64
   8++6010 00 40
   9++6012 CD 58 6D         call Dos.fread
  10++6015 F1               pop af
  11++6016 CD 44 6D         call Dos.fclose
  12++6019 AF           	xor a
  12++601A D3 FE          out (#fe), a
  13++601C C9           	ret
  14++601D              cls:
  15++601D 11 00 00         ld de, 0
  15++6020 CD 3A 60       call gotoXY
  16++6023 3E 07            ld a, 7
  16++6025 CD BE 8A       call Memory.setPage
  17++6028 AF               xor a
  17++6029 D3 FE          out (#fe), a
  18++602B 21 00 C0 11      ld hl, #c000, de, #c001, bc, 6911, (hl), a
  18++602F 01 C0 01 FF
  18++6033 1A 77
  18++6035 ED B0          ldir
  19++6037 C3 BE 8A         jp Memory.setPage
  20++603A
  21++603A
  22++603A              ; Set console coordinates
  23++603A              ; d = row(0..23), e = column (0..63)
  24++603A              gotoXY:
  25++603A              	;rr e;;;
  26++603A CB 3B        	srl e
  27++603C 3E 00        	ld a, 0
  28++603E 32 62 63     	ld (half_tile_screen), a
  29++6041 ED 53 60 63      ld (col_screen), de
  30++6045 C9               ret
  31++6046
  32++6046              disable:
  33++6046                  ; Nothing to disable
  34++6046 C9               ret
  35++6047
  36++6047              ; H - line
  37++6047              ; A - char
  38++6047              fillLine:
  39++6047 F5               push af
  40++6048 54 1E 00         ld d, h, e, 0
  40++604B CD 3A 60       call gotoXY
  41++604E F1               pop af
  42++604F 21 69 63 11      ld hl, fill_buff, de, fill_buff + 1, bc, 63, (hl), a
  42++6053 6A 63 01 3F
  42++6057 00 77
  42++6059 ED B0          ldir
  43++605B 21 69 63         ld hl, fill_buff
  43++605E C3 BC 60       jp printZ
  44++6061
  45++6061              usualLine:
  46++6061 47               ld b, a
  47++6062 0E 00            ld c, 0
  48++6064 CD 79 61         call bc_to_attr
  49++6067 3E 07            ld a, 7
  49++6069 CD BE 8A       call Memory.setPage
  50++606C 36 07            ld (hl), #7
  51++606E 54 5D            ld de, hl
  52++6070 13               inc de
  53++6071 01 1F 00         ld bc, 31
  54++6074 ED B0            ldir
  55++6076 AF               xor a
  55++6077 CD BE 8A       call Memory.setPage
  56++607A C9               ret
  57++607B
  58++607B              highlightLine:
  59++607B 47               ld b, a
  60++607C 0E 00            ld c, 0
  61++607E CD 79 61         call bc_to_attr
  62++6081 3E 07            ld a, 7
  62++6083 CD BE 8A       call Memory.setPage
  63++6086 36 0C            ld (hl), #C
  64++6088 54 5D            ld de, hl
  65++608A 13               inc de
  66++608B 01 1F 00         ld bc, 31
  67++608E ED B0            ldir
  68++6090 AF               xor a
  68++6091 CD BE 8A       call Memory.setPage
  69++6094 C9               ret
  70++6095
  71++6095              mvCR
  72++6095 ED 5B 60 63  	ld de, (col_screen)
  73++6099 14           	inc d
  74++609A 1E 00        	ld e, 0
  75++609C 3E 00        	ld a, 0
  76++609E 32 62 63     	ld (half_tile_screen), a
  77++60A1 C3 3A 60     	jp gotoXY
  78++60A4
  79++60A4              ; Print just one symbol
  80++60A4              ; A - symbol
  81++60A4              putC
  82++60A4 FE 0D            cp 13
  82++60A6 CA 95 60       jp z, mvCR
  83++60A9 21 68 63     	ld hl, single_symbol
  84++60AC 77           	ld (hl), a
  85++60AD 3E 07        	ld a, 7
  85++60AF CD BE 8A       call Memory.setPage
  86++60B2 21 67 63         ld hl, single_symbol_print
  87++60B5 CD C7 60         call printL
  88++60B8 AF               xor a
  88++60B9 C3 BE 8A       jp Memory.setPage
  89++60BC
  90++60BC              ; Put string
  91++60BC              ; hl - string pointer that's begins from symbol count
  92++60BC              printZ
  93++60BC 7E               ld a, (hl)
  93++60BD A7             and a
  93++60BE C8             ret z
  94++60BF E5               push hl
  95++60C0 CD A4 60         call putC
  96++60C3 E1               pop hl
  97++60C4 23               inc hl
  98++60C5 18 F5            jr printZ
  99++60C7
 100++60C7              printL
 101++60C7 7E                   ld	a, (hl)
 102++60C8 A7           		and	a
 103++60C9 C8           		ret	z
 104++60CA
 105++60CA E5           		push	hl
 106++60CB CD 75 61     		call	calc_addr_attr
 107++60CE 3A 63 63     		ld	a,(attr_screen)
 108++60D1 77           		ld	(hl),a
 109++60D2 E1           		pop	hl
 110++60D3
 111++60D3 CD 64 61     		call	calc_addr_scr
 112++60D6
 113++60D6 3A 62 63     		ld	a,(half_tile_screen)
 114++60D9 CB 47        		bit	0,a
 115++60DB 7E           		ld	a,(hl)
 116++60DC C2 10 61     		jp	nz,print64_4
 117++60DF              print64_3
 118++60DF F5                   push    af
 119++60E0 E5           		push	hl
 120++60E1 CD 75 61     		call	calc_addr_attr
 121++60E4 3A 63 63     		ld	a,(attr_screen)
 122++60E7 77           		ld	(hl),a
 123++60E8 E1           		pop	hl
 124++60E9
 125++60E9 23                   inc     hl
 126++60EA E5                   push    hl
 127++60EB
 128++60EB 7E                   ld      a,(hl)
 129++60EC 6F           		ld	l,a
 130++60ED 26 00        		ld	h,0
 131++60EF 29           		add	hl,hl
 132++60F0 29           		add	hl,hl
 133++60F1 29           		add	hl,hl
 134++60F2 01 00 40             ld      bc,font64
 135++60F5 09                   add     hl,bc
 136++60F6
 137++60F6 D5                   push    de
 138++60F7
 139++60F7 06 06                ld      b,6
 140++60F9 AF           		xor	a
 141++60FA 12           		ld	(de),a
 142++60FB              print64_1
 143++60FB 14           	inc     d
 144++60FC 7E           	ld      a,(hl)
 145++60FD E6 F0        	and	#f0
 146++60FF 12           	ld      (de),a
 147++6100 23           	inc     hl
 148++6101 10 F8        	djnz    print64_1
 149++6103
 150++6103 14           	inc	d
 151++6104 AF           	xor	a
 152++6105 12           	ld	(de),a
 153++6106
 154++6106 3E 01        	ld	a,1
 155++6108 32 62 63     	ld	(half_tile_screen),a
 156++610B
 157++610B D1           	pop     de
 158++610C E1           	pop     hl
 159++610D F1           	pop     af
 160++610E
 161++610E 3D           	dec     a
 162++610F C8           	ret     z
 163++6110
 164++6110              print64_4
 165++6110 F5           	push    af
 166++6111
 167++6111 23           	inc     hl
 168++6112 E5           	push    hl
 169++6113
 170++6113 7E           	ld      a,(hl)
 171++6114 6F           	ld	l,a
 172++6115 26 00        	ld	h,0
 173++6117 29           	add	hl,hl
 174++6118 29           	add	hl,hl
 175++6119 29           	add	hl,hl
 176++611A 01 00 40     	ld      bc,font64
 177++611D 09           	add     hl,bc
 178++611E
 179++611E D5           	push    de
 180++611F
 181++611F 06 06        	ld      b,6
 182++6121 AF           	xor	a
 183++6122 12           	ld	(de),a
 184++6123              print64_2
 185++6123 14           	inc     d
 186++6124 7E           	ld      a,(hl)
 187++6125 E6 0F        	and     #0f
 188++6127 4F           	ld      c,a
 189++6128 1A           	ld      a,(de)
 190++6129 B1           	or      c
 191++612A 12           	ld      (de),a
 192++612B 23           	inc     hl
 193++612C 10 F5        	djnz    print64_2
 194++612E
 195++612E 14           	inc	d
 196++612F AF           	xor	a
 197++6130 12           	ld	(de),a
 198++6131
 199++6131 32 62 63     	ld	(half_tile_screen),a
 200++6134
 201++6134 D1           	pop     de
 202++6135
 203++6135 CD 3F 61     	call	move_cr64
 204++6138
 205++6138 E1           	pop     hl
 206++6139 F1           	pop     af
 207++613A 3D           	dec     a
 208++613B
 209++613B C2 DF 60     	jp      nz,print64_3
 210++613E
 211++613E C9           	ret
 212++613F
 213++613F              ; move cursor
 214++613F              move_cr64
 215++613F 13           	inc	de
 216++6140
 217++6140 21 60 63     	ld	hl,col_screen
 218++6143 34           	inc	(hl)
 219++6144 7E           	ld	a,(hl)
 220++6145
 221++6145 FE 20        	cp	32
 222++6147 D8           	ret	c
 223++6148
 224++6148 AF           	xor	a
 225++6149 32 62 63     	ld	(half_tile_screen),a
 226++614C 77           	ld	(hl),a
 227++614D 4F           	ld	c,a
 228++614E
 229++614E 23           	inc	hl
 230++614F 34           	inc	(hl)
 231++6150 7E           	ld	a,(hl)
 232++6151 47           	ld	b,a
 233++6152
 234++6152 FE 18        	cp	24
 235++6154 DA 60 61     	jp	c,move_cr64_01
 236++6157
 237++6157 3E 17        	ld	a,23
 238++6159 77           	ld	(hl),a
 239++615A 47           	ld	b,a
 240++615B
 241++615B C5           	push	bc
 242++615C CD 89 61     	call	scroll_up8
 243++615F C1           	pop	bc
 244++6160
 245++6160              move_cr64_01
 246++6160 CD 64 61     	call	calc_addr_scr
 247++6163 C9           	ret
 248++6164
 249++6164              calc_addr_scr
 250++6164 78           	ld      a,b
 251++6165 57           	ld      d,a
 252++6166 0F           	rrca
 253++6167 0F           	rrca
 254++6168 0F           	rrca
 255++6169 A7 E6 E0     	and     a,224
 256++616C 81           	add     a,c
 257++616D 5F           	ld      e,a
 258++616E 7A           	ld      a,d
 259++616F E6 18        	and     24
 260++6171 F6 C0        	or      #c0
 261++6173 57           	ld      d,a
 262++6174 C9           	ret
 263++6175
 264++6175              calc_addr_attr
 265++6175 ED 4B 60 63  	ld	bc,(col_screen)
 266++6179              bc_to_attr:
 267++6179 78           	ld	a,b
 268++617A 0F           	rrca
 269++617B 0F           	rrca
 270++617C 0F           	rrca
 271++617D 6F           	ld	l,a
 272++617E E6 1F        	and	31
 273++6180 F6 D8        	or	#d8
 274++6182 67           	ld	h,a
 275++6183 7D           	ld	a,l
 276++6184 E6 FC        	and	252
 277++6186 B1           	or	c
 278++6187 6F           	ld	l,a
 279++6188 C9           	ret
 280++6189
 281++6189              scroll_up8
 282++6189 21 E0 61     	ld	hl,table_addr_scr
 283++618C 06 B8        	ld	b,184
 284++618E
 285++618E              scroll_up8_01
 286++618E C5           	push	bc
 287++618F
 288++618F 5E           	ld	e,(hl)
 289++6190 23           	inc	hl
 290++6191 56           	ld	d,(hl)
 291++6192 23           	inc	hl
 292++6193
 293++6193 E5           	push	hl
 294++6194
 295++6194 01 0E 00     	ld	bc,14
 296++6197 09           	add	hl,bc
 297++6198 4E           	ld	c,(hl)
 298++6199 23           	inc	hl
 299++619A 46           	ld	b,(hl)
 300++619B
 301++619B 60           	ld	h,b
 302++619C 69           	ld	l,c
 303++619D
 304++619D 01 20 00     	ld	bc,32
 305++61A0 ED B0        	ldir
 306++61A2
 307++61A2 E1           	pop	hl
 308++61A3 C1           	pop	bc
 309++61A4 10 E8        	djnz	scroll_up8_01
 310++61A6
 311++61A6 06 08        	ld	b,8
 312++61A8
 313++61A8              scroll_up8_02
 314++61A8 C5           	push	bc
 315++61A9
 316++61A9 5E           	ld	e,(hl)
 317++61AA 23           	inc	hl
 318++61AB 56           	ld	d,(hl)
 319++61AC 23           	inc	hl
 320++61AD
 321++61AD E5           	push	hl
 322++61AE
 323++61AE 62           	ld	h,d
 324++61AF 6B           	ld	l,e
 325++61B0 13           	inc	de
 326++61B1 36 00        	ld	(hl),0
 327++61B3 01 1F 00     	ld	bc,31
 328++61B6 ED B0        	ldir
 329++61B8
 330++61B8 E1           	pop	hl
 331++61B9 C1           	pop	bc
 332++61BA 10 EC        	djnz	scroll_up8_02
 333++61BC 11 00 D8 21  	ld	de,#D800, hl,#D820, bc,736
 333++61C0 20 D8 01 E0
 333++61C4 02
 334++61C5 ED B0        	ldir
 335++61C7 1A           	ld	a,(de)
 336++61C8 21 E0 DA 11  	ld	hl,#dae0, de,#dae1, (hl),a, bc,31
 336++61CC E1 DA 77 01
 336++61D0 1F 00
 337++61D2 ED B0        	ldir
 338++61D4
 339++61D4 C9           	ret
 340++61D5
 341++61D5              font64 equ #4000 ; Using ZX-Spectrum screen as font buffer
 342++61D5 66 6F 6E 74  font_file db "font64.bin", 0
 342++61D9 36 34 2E 62
 342++61DD 69 6E 00
 343++61E0
 344++61E0
 345++61E0              table_addr_scr
 346++61E0 00 40 00 41  	defw	#4000,#4100,#4200,#4300,#4400,#4500,#4600,#4700
 346++61E4 00 42 00 43
 346++61E8 00 44 00 45
 346++61EC 00 46 00 47
 347++61F0 20 40 20 41  	defw	#4020,#4120,#4220,#4320,#4420,#4520,#4620,#4720
 347++61F4 20 42 20 43
 347++61F8 20 44 20 45
 347++61FC 20 46 20 47
 348++6200 40 40 40 41  	defw	#4040,#4140,#4240,#4340,#4440,#4540,#4640,#4740
 348++6204 40 42 40 43
 348++6208 40 44 40 45
 348++620C 40 46 40 47
 349++6210 60 40 60 41  	defw	#4060,#4160,#4260,#4360,#4460,#4560,#4660,#4760
 349++6214 60 42 60 43
 349++6218 60 44 60 45
 349++621C 60 46 60 47
 350++6220 80 40 80 41  	defw	#4080,#4180,#4280,#4380,#4480,#4580,#4680,#4780
 350++6224 80 42 80 43
 350++6228 80 44 80 45
 350++622C 80 46 80 47
 351++6230 A0 40 A0 41  	defw	#40a0,#41a0,#42a0,#43a0,#44a0,#45a0,#46a0,#47a0
 351++6234 A0 42 A0 43
 351++6238 A0 44 A0 45
 351++623C A0 46 A0 47
 352++6240 C0 40 C0 41  	defw	#40c0,#41c0,#42c0,#43c0,#44c0,#45c0,#46c0,#47c0
 352++6244 C0 42 C0 43
 352++6248 C0 44 C0 45
 352++624C C0 46 C0 47
 353++6250 E0 40 E0 41  	defw	#40e0,#41e0,#42e0,#43e0,#44e0,#45e0,#46e0,#47e0
 353++6254 E0 42 E0 43
 353++6258 E0 44 E0 45
 353++625C E0 46 E0 47
 354++6260
 355++6260 00 48 00 49  	defw	#4800,#4900,#4a00,#4b00,#4c00,#4d00,#4e00,#4f00
 355++6264 00 4A 00 4B
 355++6268 00 4C 00 4D
 355++626C 00 4E 00 4F
 356++6270 20 48 20 49  	defw	#4820,#4920,#4a20,#4b20,#4c20,#4d20,#4e20,#4f20
 356++6274 20 4A 20 4B
 356++6278 20 4C 20 4D
 356++627C 20 4E 20 4F
 357++6280 40 48 40 49  	defw	#4840,#4940,#4a40,#4b40,#4c40,#4d40,#4e40,#4f40
 357++6284 40 4A 40 4B
 357++6288 40 4C 40 4D
 357++628C 40 4E 40 4F
 358++6290 60 48 60 49  	defw	#4860,#4960,#4a60,#4b60,#4c60,#4d60,#4e60,#4f60
 358++6294 60 4A 60 4B
 358++6298 60 4C 60 4D
 358++629C 60 4E 60 4F
 359++62A0 80 48 80 49  	defw	#4880,#4980,#4a80,#4b80,#4c80,#4d80,#4e80,#4f80
 359++62A4 80 4A 80 4B
 359++62A8 80 4C 80 4D
 359++62AC 80 4E 80 4F
 360++62B0 A0 48 A0 49  	defw	#48a0,#49a0,#4aa0,#4ba0,#4ca0,#4da0,#4ea0,#4fa0
 360++62B4 A0 4A A0 4B
 360++62B8 A0 4C A0 4D
 360++62BC A0 4E A0 4F
 361++62C0 C0 48 C0 49  	defw	#48c0,#49c0,#4ac0,#4bc0,#4cc0,#4dc0,#4ec0,#4fc0
 361++62C4 C0 4A C0 4B
 361++62C8 C0 4C C0 4D
 361++62CC C0 4E C0 4F
 362++62D0 E0 48 E0 49  	defw	#48e0,#49e0,#4ae0,#4be0,#4ce0,#4de0,#4ee0,#4fe0
 362++62D4 E0 4A E0 4B
 362++62D8 E0 4C E0 4D
 362++62DC E0 4E E0 4F
 363++62E0
 364++62E0 00 50 00 51  	defw	#5000,#5100,#5200,#5300,#5400,#5500,#5600,#5700
 364++62E4 00 52 00 53
 364++62E8 00 54 00 55
 364++62EC 00 56 00 57
 365++62F0 20 50 20 51  	defw	#5020,#5120,#5220,#5320,#5420,#5520,#5620,#5720
 365++62F4 20 52 20 53
 365++62F8 20 54 20 55
 365++62FC 20 56 20 57
 366++6300 40 50 40 51  	defw	#5040,#5140,#5240,#5340,#5440,#5540,#5640,#5740
 366++6304 40 52 40 53
 366++6308 40 54 40 55
 366++630C 40 56 40 57
 367++6310 60 50 60 51  	defw	#5060,#5160,#5260,#5360,#5460,#5560,#5660,#5760
 367++6314 60 52 60 53
 367++6318 60 54 60 55
 367++631C 60 56 60 57
 368++6320 80 50 80 51  	defw	#5080,#5180,#5280,#5380,#5480,#5580,#5680,#5780
 368++6324 80 52 80 53
 368++6328 80 54 80 55
 368++632C 80 56 80 57
 369++6330 A0 50 A0 51  	defw	#50a0,#51a0,#52a0,#53a0,#54a0,#55a0,#56a0,#57a0
 369++6334 A0 52 A0 53
 369++6338 A0 54 A0 55
 369++633C A0 56 A0 57
 370++6340 C0 50 C0 51  	defw	#50c0,#51c0,#52c0,#53c0,#54c0,#55c0,#56c0,#57c0
 370++6344 C0 52 C0 53
 370++6348 C0 54 C0 55
 370++634C C0 56 C0 57
 371++6350 E0 50 E0 51  	defw	#50e0,#51e0,#52e0,#53e0,#54e0,#55e0,#56e0,#57e0
 371++6354 E0 52 E0 53
 371++6358 E0 54 E0 55
 371++635C E0 56 E0 57
 372++6360
 373++6360
 374++6360 00           col_screen			db	0
 375++6361 00           row_screen			db	0
 376++6362 00           half_tile_screen	db	0
 377++6363 07           attr_screen			db	07
 378++6364
 379++6364 00 00        col_screen_temp			dw	0
 380++6366 00           half_tile_screen_temp	db	0
 381++6367
 382++6367 01           single_symbol_print db 1
 383++6368 00           single_symbol 		db 0
 384++6369
 385++6369 00 00 00...  fill_buff ds 65
 386++63AA
 387++63AA                  endmodule
# file closed: vdp/zx.asm
  11++63AA                  ENDIF
  12++63AA
  13++63AA              	IFDEF NEDOOS
  14++63AA ~                include "nedotext.asm"
  15++63AA                  ENDIF
# file closed: vdp/index.asm
  16+ 63AA                  include "utils/index.asm"
# file opened: utils/index.asm
   1++63AA                  include "atoi.asm"
# file opened: utils/atoi.asm
   1++63AA              ; DE - buffer
   2++63AA              ; HL - output
   3++63AA              atohl:
   4++63AA 21 00 00         ld hl, 0
   5++63AD              .loop
   6++63AD 1A               ld a, (de)
   7++63AE 13               inc de
   8++63AF                  ; Sepparators
   9++63AF C5 E5            push bc, hl
  10++63B1 01 05 00             ld bc, sepparators_len
  11++63B4 21 CC 63             ld hl, sepparators
  12++63B7 ED B1                cpir
  13++63B9 E1 C1            pop hl, bc
  14++63BB C8               ret z
  15++63BC
  16++63BC D6 30            sub '0'
  17++63BE
  18++63BE C5               push bc
  19++63BF 4D                   ld c, l
  20++63C0 44                   ld b, h
  21++63C1
  22++63C1 29                   add hl, hl
  23++63C2 29                   add hl, hl
  24++63C3 09                   add hl, bc
  25++63C4 29                   add hl, hl
  26++63C5 4F                   ld c, a
  27++63C6 06 00                ld b, 0
  28++63C8 09                   add hl, bc
  29++63C9 C1               pop bc
  30++63CA 18 E1            jr .loop
  31++63CC
# file closed: utils/atoi.asm
   2++63CC                  include "constants.asm"
# file opened: utils/constants.asm
   1++63CC              TAB = 9
   2++63CC              CR = 13
   3++63CC              LF = 10
   4++63CC              NULL = 0
   5++63CC              SPACE = ' '
   6++63CC              ESC = 27
   7++63CC              BACKSPACE = 8
   8++63CC
   9++63CC                  IFDEF TIMEX80
  10++63CC ~            MIME_DOWNLOAD 	= #19
  11++63CC ~            MIME_LINK 		= #1A
  12++63CC ~            MIME_TEXT 		= #10
  13++63CC ~            MIME_IMAGE 		= #01
  14++63CC ~            MIME_MUSIC 		= #0e
  15++63CC ~            MIME_INPUT 		= #b3
  16++63CC ~            MIME_MOD 		= #0d
  17++63CC ~
  18++63CC ~            BORDER_TOP = #b2
  19++63CC ~            BORDER_BOTTOM = #b1
  20++63CC                  ELSE
  21++63CC              	IFDEF MSX
  22++63CC ~            MIME_DOWNLOAD 	= 1
  23++63CC ~            MIME_LINK		= 2
  24++63CC ~            MIME_TEXT 		= 3
  25++63CC ~            MIME_IMAGE 		= 4
  26++63CC ~            MIME_MUSIC 		= 5
  27++63CC ~            MIME_INPUT 		= 6
  28++63CC ~            MIME_MOD      	= 7
  29++63CC ~            BORDER_TOP    = 7
  30++63CC ~            BORDER_BOTTOM = 8
  31++63CC              	ELSE
  32++63CC              MIME_DOWNLOAD = 1
  33++63CC              MIME_LINK     = 2
  34++63CC              MIME_TEXT     = 3
  35++63CC              MIME_IMAGE    = 6
  36++63CC              MIME_MUSIC    = 5
  37++63CC              MIME_INPUT    = 4
  38++63CC              MIME_MOD      = 7
  39++63CC
  40++63CC              BORDER_TOP    = 9
  41++63CC              BORDER_BOTTOM = 8
  42++63CC              	ENDIF
  43++63CC
  44++63CC
  45++63CC
  46++63CC
  47++63CC              	ENDIF
  48++63CC
  49++63CC 0D 0A 09 00  sepparators db CR, LF, TAB, NULL, SPACE
  49++63D0 20
  50++63D1              sepparators_len = $ - sepparators
# file closed: utils/constants.asm
   3++63D1                  include "strutils.asm"
# file opened: utils/strutils.asm
   1++63D1              ; de - pointer
   2++63D1              ; hl - count
   3++63D1              strlen:
   4++63D1 21 00 00         ld hl, 0
   5++63D4              .loop
   6++63D4 1A               ld a, (de)
   7++63D5 A7               and a
   7++63D6 28 04          jr z, .exit
   8++63D8 23               inc hl
   9++63D9 13               inc de
  10++63DA 18 F8            jr .loop
  11++63DC              .exit
  12++63DC C9               ret
  13++63DD
  14++63DD                  module CompareBuff
  15++63DD
  16++63DD              ; Pushes A to buffer
  17++63DD              push
  18++63DD F5               push af
  19++63DE 06 20            ld b, 32
  19++63E0 21 29 64       ld hl, buffer + 1
  19++63E3 11 28 64       ld de, buffer
  20++63E6              .loop
  21++63E6 7E               ld a, (hl)
  21++63E7 12             ld (de), a
  21++63E8 23             inc hl
  21++63E9 13             inc de
  21++63EA 10 FA          djnz .loop
  22++63EC F1               pop af
  23++63ED 21 47 64         ld hl, buffer + 31
  23++63F0 77             ld (hl), a
  24++63F1 C9               ret
  25++63F2
  26++63F2              ; HL - Compare string(null terminated)
  27++63F2              ; A - 0 NOT Found
  28++63F2              ;     1 Found
  29++63F2              search:
  30++63F2 06 00            ld b, 0
  30++63F4 E5             push hl
  31++63F5              .loop:
  32++63F5 7E               ld a, (hl)
  32++63F6 23             inc hl
  32++63F7 04             inc b
  32++63F8 A7             and a
  32++63F9 C2 F5 63       jp nz, .loop
  33++63FC 05               dec b
  33++63FD E1             pop hl
  33++63FE C5             push bc
  33++63FF E5             push hl
  34++6400 E1               pop hl
  35++6401 11 48 64         ld de, buffer + 32
  36++6404              .sourceLoop
  37++6404 1B               dec de
  37++6405 10 FD          djnz .sourceLoop
  38++6407 C1               pop bc
  39++6408              .compare
  40++6408 C5               push bc
  40++6409 F5             push af
  41++640A 1A               ld a, (de)
  41++640B 47             ld b, a
  42++640C F1               pop af
  42++640D 7E             ld a, (hl)
  42++640E B8             cp b
  42++640F C1             pop bc
  42++6410 3E 00          ld a, 0
  42++6412 C0             ret nz
  43++6413 13               inc de
  43++6414 23             inc hl
  44++6415 10 F1            djnz .compare
  45++6417 3E 01            ld a, 1
  46++6419 C9               ret
  47++641A
  48++641A              clear:
  49++641A AF               xor a
  49++641B 21 28 64       ld hl, buffer
  49++641E 11 29 64       ld de, buffer + 1
  49++6421 01 20 00       ld bc, 32
  49++6424 77             ld (hl), a
  49++6425 ED B0          ldir
  50++6427 C9               ret
  51++6428
  52++6428 00 00 00...  buffer ds 32
  53++6448
  54++6448                  endmodule
# file closed: utils/strutils.asm
   4++6448                  IFDEF MSX
   5++6448 ~            	    include "bios.asm"
   6++6448                  ENDIF
   7++6448                  include "screen.asm"
# file opened: utils/screen.asm
   1++6448              LINE_LIMIT = 63
   2++6448
   3++6448                  IFDEF NEDOOS
   4++6448 ~            LINE_LIMIT = 79
   5++6448                  ENDIF
   6++6448
   7++6448                  IFDEF TIMEX80
   8++6448 ~            LINE_LIMIT = 84
   9++6448                  ENDIF
  10++6448
  11++6448                  IFDEF MSX
  12++6448 ~            LINE_LIMIT = 79
  13++6448                  ENDIF
  14++6448              ; HL - string pointer
  15++6448              print70Text:
  16++6448 06 3F            ld b, LINE_LIMIT
  17++644A              .loop
  18++644A 7E               ld a, (hl)
  19++644B A7               and a
  19++644C C8             ret z
  20++644D FE 0D            cp 13
  20++644F C8             ret z
  21++6450 FE 0A            cp 10
  21++6452 C8             ret z
  22++6453 C5               push bc
  23++6454 E5               push hl
  24++6455 CD A4 60         call TextMode.putC
  25++6458 E1               pop hl
  26++6459 23               inc hl
  27++645A C1               pop bc
  28++645B 05               dec b
  29++645C 78               ld a, b
  29++645D A7             and a
  29++645E C8             ret z
  30++645F C3 4A 64         jp .loop
  31++6462
  32++6462              ; HL - string pointer
  33++6462              print70Goph:
  34++6462 06 3F            ld b, LINE_LIMIT
  35++6464              .loop
  36++6464 7E               ld a, (hl)
  36++6465 FE 09          cp 09
  36++6467 C8             ret z
  37++6468 A7               and a
  37++6469 C8             ret z
  38++646A C5               push bc
  39++646B E5               push hl
  40++646C CD A4 60         call TextMode.putC
  41++646F E1               pop hl
  42++6470 23               inc hl
  43++6471 C1               pop bc
  44++6472 05               dec b
  45++6473 78               ld a, b
  45++6474 A7             and a
  45++6475 C8             ret z
  46++6476 C3 64 64         jp .loop
# file closed: utils/screen.asm
# file closed: utils/index.asm
  17+ 6479                  include "gopher/render/index.asm"
# file opened: gopher/render/index.asm
   1++6479                  MODULE Render
   2++6479              PER_PAGE = 22
   3++6479              CURSOR_OFFSET = 2
   4++6479                  include "row.asm"
# file opened: gopher/render/row.asm
   1++6479              ; A - row number
   2++6479              ; HL - pointer to row
   3++6479              renderRow:
   4++6479 C6 02            add CURSOR_OFFSET
   5++647B 57               ld d,a
   6++647C 1E 00            ld e,0
   7++647E CD 3A 60         call TextMode.gotoXY
   8++6481 7E               ld a,(hl)
   9++6482 E5               push hl
  10++6483 CD 8E 64         call getIcon
  11++6486 CD A4 60         call TextMode.putC
  12++6489 E1               pop hl
  13++648A 23               inc hl
  14++648B C3 62 64         jp print70Goph
  15++648E
  16++648E              ; A - gopher id char
  17++648E              getIcon:
  18++648E FE 69            cp 'i'
  18++6490 CA AA 64       jp z, .info
  19++6493 FE 39            cp '9'
  19++6495 CA AD 64       jp z, .down
  20++6498 FE 31            cp '1'
  20++649A CA 13 65       jp z, .page
  21++649D FE 30            cp '0'
  21++649F CA 16 65       jp z, .text
  22++64A2 FE 37            cp '7'
  22++64A4 CA 19 65       jp z, .input
  23++64A7 3E 20            ld a, ' '
  24++64A9 C9               ret
  25++64AA              .info
  26++64AA 3E 20            ld a, SPACE
  26++64AC C9             ret
  27++64AD              .down
  28++64AD 54 5D            ld de, hl
  29++64AF 01 FF 00 3E      ld bc, #ff, a, TAB
  29++64B3 09
  29++64B4 ED B1          cpir
  30++64B6 78               ld a, b
  30++64B7 B1             or c
  30++64B8 28 56          jr z, .downExit
  31++64BA D5               push de
  32++64BB              .nameLoop
  33++64BB 7E               ld a, (hl)
  33++64BC A7             and a
  33++64BD 28 10          jr z, .check
  34++64BF FE 09            cp TAB
  34++64C1 28 0C          jr z, .check
  35++64C3 FE 0D            cp CR
  35++64C5 28 08          jr z, .check
  36++64C7 E5               push hl
  37++64C8 CD DD 63         call CompareBuff.push
  38++64CB E1               pop hl
  39++64CC 23               inc hl
  40++64CD 18 EC            jr .nameLoop
  41++64CF              .check
  42++64CF 21 28 65         ld hl, scrExt1
  42++64D2 CD F2 63       call CompareBuff.search
  42++64D5 A7             and a
  42++64D6 20 44          jr nz, .image
  43++64D8 21 2D 65         ld hl, scrExt2
  43++64DB CD F2 63       call CompareBuff.search
  43++64DE A7             and a
  43++64DF 20 3B          jr nz, .image
  44++64E1 3E 03            ld a, 3
  44++64E3 32 D1 8B       ld (VTPL.SETUP), a ; 0 bit - looping, 1 bit - pt2 file
  45++64E6 21 3C 65         ld hl, pt2Ext1
  45++64E9 CD F2 63       call CompareBuff.search
  45++64EC A7             and a
  45++64ED 20 31          jr nz, .music
  46++64EF 21 41 65         ld hl, pt2Ext2
  46++64F2 CD F2 63       call CompareBuff.search
  46++64F5 A7             and a
  46++64F6 20 28          jr nz, .music
  47++64F8 3E 01            ld a, 1
  47++64FA 32 D1 8B       ld (VTPL.SETUP), a
  48++64FD 21 32 65         ld hl, pt3Ext1
  48++6500 CD F2 63       call CompareBuff.search
  48++6503 A7             and a
  48++6504 20 1A          jr nz, .music
  49++6506 21 37 65         ld hl, pt3Ext2
  49++6509 CD F2 63       call CompareBuff.search
  49++650C A7             and a
  49++650D 20 11          jr nz, .music
  50++650F
  51++650F                  ; General Sound support
  52++650F                  ifdef GS
  53++650F ~                ld hl, modExt1
  53++650F ~              call CompareBuff.search
  53++650F ~              and a
  53++650F ~              jr nz, .mod
  54++650F ~                ld hl, modExt2
  54++650F ~              call CompareBuff.search
  54++650F ~              and a
  54++650F ~              jr nz, .mod
  55++650F                  endif
  56++650F
  57++650F              .checkExit
  58++650F E1               pop hl
  59++6510              .downExit
  60++6510 3E 01            ld a, MIME_DOWNLOAD
  60++6512 C9             ret
  61++6513              .page
  62++6513 3E 02            ld a, MIME_LINK
  62++6515 C9             ret
  63++6516              .text
  64++6516 3E 03            ld a, MIME_TEXT
  64++6518 C9             ret
  65++6519              .input
  66++6519 3E 04            ld a, MIME_INPUT
  66++651B C9             ret
  67++651C              .image
  68++651C E1               pop hl
  68++651D 3E 06          ld a, MIME_IMAGE
  68++651F C9             ret
  69++6520              .music
  70++6520 E1               pop hl
  70++6521 3E 05          ld a, MIME_MUSIC
  70++6523 C9             ret
  71++6524              .mod
  72++6524 E1               pop hl
  72++6525 3E 07          ld a, MIME_MOD
  72++6527 C9             ret
  73++6528
  74++6528 2E 73 63 72  scrExt1 db ".scr", 0
  74++652C 00
  75++652D 2E 53 43 52  scrExt2 db ".SCR", 0
  75++6531 00
  76++6532
  77++6532 2E 70 74 33  pt3Ext1 db ".pt3", 0
  77++6536 00
  78++6537 2E 50 54 33  pt3Ext2 db ".PT3", 0
  78++653B 00
  79++653C 2E 70 74 32  pt2Ext1 db ".pt2", 0
  79++6540 00
  80++6541 2E 50 54 32  pt2Ext2 db ".PT2", 0
  80++6545 00
  81++6546 2E 6D 6F 64  modExt1 db ".mod", 0
  81++654A 00
  82++654B 2E 4D 4F 44  modExt2 db ".MOD", 0
  82++654F 00
# file closed: gopher/render/row.asm
   5++6550                  include "buffer.asm"
# file opened: gopher/render/buffer.asm
   1++6550              ; BC - line count
   2++6550              findLine
   3++6550 21 E2 97         ld hl, outputBuffer
   4++6553              findLine2
   5++6553 78               ld a,b
   6++6554 B1               or c
   7++6555 CA 82 65         jp z, .checkEmpty
   8++6558              .loop
   9++6558 7E               ld a, (hl)
  10++6559 A7               and a
  11++655A CA 85 65         jp z, .nope
  12++655D 23               inc hl
  13++655E FE 0D            cp 13
  14++6560 CA 78 65         jp z, .checkLF  ;13
  15++6563 FE 0A            cp 10
  15++6565 CA 6B 65       jp z, .nextCheck     ;10
  16++6568 C3 58 65         jp .loop
  17++656B              .nextCheck
  18++656B A7               and a
  19++656C CA 85 65         jp z, .nope
  20++656F 0B               dec bc
  21++6570 57               ld d,a
  22++6571 78               ld a,b
  23++6572 B1               or c
  24++6573 7A               ld a,d
  25++6574 C2 58 65         jp nz, .loop
  26++6577 C9               ret
  27++6578              .checkLF
  28++6578 7E               ld a, (hl)
  29++6579 FE 0A            cp 10
  30++657B C2 6B 65         jp nz, .nextCheck    ;10
  31++657E 23               inc hl
  32++657F C3 6B 65         jp  .nextCheck
  33++6582              .checkEmpty
  34++6582 7E               ld a, (hl)
  34++6583 A7             and a
  34++6584 C0             ret nz
  35++6585              .nope
  36++6585 21 00 00         ld hl, 0
  36++6588 C9             ret
  37++6589
# file closed: gopher/render/buffer.asm
   6++6589                  include "ui.asm"
# file opened: gopher/render/ui.asm
   1++6589                  IFDEF ZXSCR
   2++6589                      DEFINE LEFT_TAB "[D]omain:                                  "
   3++6589                      DEFINE SCREEN_WIDTH 64
   4++6589                      DEFINE SCREEN64
   5++6589                  ENDIF
   6++6589
   7++6589                  IFDEF TIMEX     ;UNKNOWM fallback to 64
   8++6589 ~                    DEFINE LEFT_TAB "[D]omain:                                  "
   9++6589 ~                    DEFINE SCREEN_WIDTH 64
  10++6589 ~                    DEFINE SCREEN64
  11++6589                  ENDIF
  12++6589
  13++6589                  IFDEF TIMEX80
  14++6589 ~                    DEFINE LEFT_TAB "[D]omain:                                                      "
  15++6589 ~                    DEFINE SCREEN_WIDTH 85
  16++6589 ~                    DEFINE SCREEN85
  17++6589                  ENDIF
  18++6589
  19++6589                  IFDEF NEDOOS
  20++6589 ~                    DEFINE LEFT_TAB "[D]omain:                                                  "
  21++6589 ~                    DEFINE SCREEN_WIDTH 80
  22++6589 ~                    DEFINE SCREEN80
  23++6589                  ENDIF
  24++6589
  25++6589                  IFDEF MSX
  26++6589 ~                    DEFINE LEFT_TAB "[D]omain:                                              "
  27++6589 ~                    DEFINE SCREEN_WIDTH 80
  28++6589 ~                    DEFINE SCREEN80
  29++6589                  ENDIF
  30++6589              prepareScreen:
  31++6589 CD 1D 60         call TextMode.cls
  32++658C 21 5C 66         ld hl, header
  32++658F CD BC 60       call TextMode.printZ
  33++6592 11 0A 00         ld de, #000A
  33++6595 CD 3A 60       call TextMode.gotoXY
  34++6598 21 A0 82         ld hl, hostName
  34++659B CD BC 60       call TextMode.printZ
  35++659E AF               xor a
  35++659F CD 7B 60       call TextMode.highlightLine
  36++65A2 C9               ret
  37++65A3
  38++65A3              inputHost:
  39++65A3 CD F7 69         	call Console.waitForKeyUp
  40++65A6              .loop
  41++65A6 11 0A 00         ld de, #000A
  41++65A9 CD 3A 60       call TextMode.gotoXY
  41++65AC 21 A0 82       ld hl, hostName
  41++65AF CD BC 60       call TextMode.printZ
  42++65B2 3E 04            ld a, MIME_INPUT
  42++65B4 CD A4 60       call TextMode.putC
  43++65B7 3E 20            ld a, ' '
  43++65B9 CD A4 60       call TextMode.putC
  44++65BC              .wait
  45++65BC CD 10 6A         call Console.getC
  46++65BF 5F               ld e, a
  47++65C0 FE 0C            cp Console.BACKSPACE
  47++65C2 28 17          jr z, .removeChar
  48++65C4 FE 0D            cp CR
  48++65C6 CA E9 65       jp z, inputNavigate
  49++65C9 FE 20            cp 32
  49++65CB 38 EF          jr c, .wait
  50++65CD              .putC
  51++65CD AF               xor a
  51++65CE 21 A0 82 01    ld hl, hostName, bc, 48
  51++65D2 30 00
  51++65D4 ED B1          cpir
  52++65D6 77               ld (hl), a
  52++65D7 2B             dec hl
  52++65D8 73             ld (hl), e
  53++65D9 18 CB            jr .loop
  54++65DB              .removeChar
  55++65DB AF               xor a
  56++65DC 21 A0 82 01      ld hl, hostName, bc, 48
  56++65E0 30 00
  56++65E2 ED B1          cpir
  57++65E4 2B               dec hl
  57++65E5 2B             dec hl
  57++65E6 77             ld (hl), a
  58++65E7 18 BD            jr .loop
  59++65E9
  60++65E9              inputNavigate:
  61++65E9 21 A0 82 11      ld hl, hostName, de, domain
  61++65ED 1C 66
  62++65EF 7E               ld a,(hl)
  63++65F0 A7               and a
  64++65F1 CA 17 72         jp z, History.load
  65++65F4              .loop
  66++65F4 7E               ld a, (hl)
  66++65F5 A7             and a
  66++65F6 28 05          jr z, .complete
  67++65F8 12               ld (de), a
  67++65F9 23 13          inc hl, de
  68++65FB 18 F7            jr .loop
  69++65FD              .complete
  70++65FD 3E 09            ld a, TAB
  70++65FF 12             ld (de), a
  70++6600 13             inc de
  71++6601 3E 37            ld a, '7'
  71++6603 12             ld (de), a
  71++6604 13             inc de
  72++6605 3E 30            ld a, '0'
  72++6607 12             ld (de), a
  72++6608 13             inc de
  73++6609 3E 0D            ld a, CR
  73++660B 12             ld (de), a
  73++660C 13             inc de
  74++660D 3E 0A            ld a, LF
  74++660F 12             ld (de), a
  74++6610 13             inc de
  75++6611 21 17 66         ld hl, navRow
  75++6614 C3 70 72       jp History.navigate
  76++6617
  77++6617 31 20 09 2F  navRow db "1 ", TAB, "/", TAB
  77++661B 09
  78++661C 6E 69 68 69  domain db "nihirash.net"
  78++6620 72 61 73 68
  78++6624 2E 6E 65 74
  79++6628 00 00 00...      ds 64 - ($ - domain)
  80++665C
  81++665C 5B 44 5D 6F  header db "[D]omain:                                  ", "MRF "
  81++6660 6D 61 69 6E
  81++6664 3A 20 20 20
  81++6668 20 20 20 20
  81++666C 20 20 20 20
  81++6670 20 20 20 20
  81++6674 20 20 20 20
  81++6678 20 20 20 20
  81++667C 20 20 20 20
  81++6680 20 20 20 20
  81++6684 20 20 20 4D
  81++6688 52 46 20
  82++668B 31 2E 37            db "1.7"
  83++668E 2E                  db "."
  84++668F 31 37               db "17"
  85++6691              	IFDEF MSX
  86++6691 ~                   db "    [MSX UNAPI]",13, 0
  87++6691              	ENDIF
  88++6691
  89++6691                  IFDEF MB03
  90++6691 ~                   db " [MB03+]",13, 0
  91++6691                     ENDIF
  92++6691
  93++6691                  IFDEF UNO
  94++6691 ~                   db " [UNO UART]",13, 0
  95++6691                  ENDIF
  96++6691
  97++6691                  IFDEF AY
  98++6691 ~                   db " [AYWIFI]",13, 0
  99++6691              	ENDIF
 100++6691
 101++6691                  IFDEF ZW
 102++6691 20 20 5B 5A         db "  [ZXWiFi]",13, 0
 102++6695 58 57 69 46
 102++6699 69 5D 0D 00
 103++669D                  ENDIF
 104++669D
 105++669D                   IFDEF UARTATM
 106++669D ~                   db " [ATM UART]",13, 0
 107++669D                  ENDIF
 108++669D
 109++669D                  IFDEF UARTEVO
 110++669D ~                    db " [EVO UART]",13, 0
 111++669D                  ENDIF
 112++669D
 113++669D                  IFDEF UNOUART
 114++669D ~                    db " [UNO UART]",13, 0
 115++669D                  ENDIF
 116++669D
 117++669D                  IFDEF NEDONET
 118++669D ~            	    db "  [nedoNET]",13, 0
 119++669D              	ENDIF
 120++669D
# file closed: gopher/render/ui.asm
   7++669D                  include "gopher-page.asm"
# file opened: gopher/render/gopher-page.asm
   1++669D              renderGopherScreen:
   2++669D 3E FF            ld a, 255
   3++669F 32 6E 8B         ld (oldminutes), a
   4++66A2 CD 89 65         call Render.prepareScreen
   5++66A5
   6++66A5 2A 8E 75         ld hl, (page_offset)        ; HL - offset to 0 Row on screen
   7++66A8 44 4D            ld bc,hl                    ; BC - offset to C Row on screen
   8++66AA CD 50 65         call Render.findLine        ;BC - Search this line  HL - Return pointer to page with offset
   9++66AD 7C               ld a, h
  10++66AE B5               or l
  11++66AF 28 21            jr z, .exit2
  12++66B1 7B               ld a, e
  13++66B2 AF               xor a
  14++66B3 E5               push hl
  15++66B4 CD 79 64         call renderRow
  16++66B7 E1               pop hl
  17++66B8
  18++66B8 06 15            ld b, PER_PAGE-1
  19++66BA
  20++66BA              .loop
  21++66BA C5               push bc
  22++66BB 3E 16            ld a, PER_PAGE
  23++66BD 90               sub b
  24++66BE 5F               ld e,a
  25++66BF
  26++66BF 01 01 00         ld bc, 1
  27++66C2
  28++66C2 CD 53 65         call Render.findLine2   ;BC - Search this line  HL - Return pointer to page with offset
  29++66C5
  30++66C5 7C               ld a, h
  31++66C6 B5               or l
  32++66C7 28 06            jr z, .exit
  33++66C9 7B               ld a, e
  34++66CA E5               push hl
  35++66CB CD 79 64         call renderRow
  36++66CE E1               pop hl
  37++66CF              .exit
  38++66CF C1               pop bc
  39++66D0 10 E8            djnz .loop
  40++66D2              .exit2
  41++66D2 CD C8 67         call showCursor
  42++66D5 C9               ret
  43++66D6
  44++66D6              checkBorder:
  45++66D6 3A 8C 75         ld a, (cursor_position)
  45++66D9 FE FF          cp #ff
  45++66DB CA EC 67       jp z, pageUp
  46++66DE 3A 8C 75         ld a, (cursor_position)
  46++66E1 FE 16          cp PER_PAGE
  46++66E3 CA 1F 68       jp z, pageDn
  47++66E6 CD C8 67         call showCursor
  48++66E9 C3 EC 66         jp workLoop
  49++66EC
  50++66EC              workLoop:
  51++66EC 3A 08 69         ld a, (play_next)
  51++66EF A7             and a
  51++66F0 C2 7D 67       jp nz, navigate
  52++66F3
  53++66F3                  dup 4
  54++66F3 76          >    halt
  54++66F4 76          >    halt
  54++66F5 76          >    halt
  54++66F6 76          >    halt
  55++66F7                  edup
  56++66F7              .nothing
  57++66F7
  58++66F7 76               halt
  59++66F8 CD C9 8A         call printRTC
  60++66FB
  61++66FB CD 21 6A         call Console.peekC
  62++66FE A7               and a
  62++66FF CA F7 66       jp z, .nothing
  63++6702
  64++6702 FE 31            cp '1'
  64++6704 CA 00 72       jp z, History.back
  65++6707 FE 32            cp '2'
  65++6709 CA 7D 67       jp z, navigate
  66++670C FE 33            cp '3'
  66++670E CA D8 67       jp z, cursorDown
  67++6711 FE 34            cp '4'
  67++6713 CA E2 67       jp z, cursorUp
  68++6716 FE 35            cp '5'
  68++6718 CA EC 67       jp z, pageUp
  69++671B FE 38            cp '8'
  69++671D CA 1F 68       jp z, pageDn
  70++6720 FE 36            cp '6'
  70++6722 CA D8 67       jp z, cursorDown
  71++6725 FE 37            cp '7'
  71++6727 CA E2 67       jp z, cursorUp
  72++672A
  73++672A FE 0A            cp Console.KEY_DN
  73++672C CA D8 67       jp z, cursorDown
  74++672F FE 61            cp 'a'
  74++6731 CA D8 67       jp z, cursorDown
  75++6734 FE 0B            cp Console.KEY_UP
  75++6736 CA E2 67       jp z, cursorUp
  76++6739 FE 71            cp 'q'
  76++673B CA E2 67       jp z, cursorUp
  77++673E FE 08            cp Console.KEY_LT
  77++6740 CA EC 67       jp z, pageUp
  78++6743 FE 6F            cp 'o'
  78++6745 CA EC 67       jp z, pageUp
  79++6748 FE 09            cp Console.KEY_RT
  79++674A CA 1F 68       jp z, pageDn
  80++674D FE 70            cp 'p'
  80++674F CA 1F 68       jp z, pageDn
  81++6752
  82++6752 FE 68            cp 'h'
  82++6754 CA 6D 72       jp z, History.home
  83++6757 FE 48            cp 'H'
  83++6759 CA 6D 72       jp z, History.home
  84++675C
  85++675C FE 62            cp 'b'
  85++675E CA 00 72       jp z, History.back
  86++6761 FE 42            cp 'B'
  86++6763 CA 00 72       jp z, History.back
  87++6766 FE 0C            cp Console.BACKSPACE
  87++6768 CA 00 72       jp z, History.back
  88++676B
  89++676B FE 64            cp 'd'
  89++676D CA A3 65       jp z, inputHost
  90++6770 FE 44            cp 'D'
  90++6772 CA A3 65       jp z, inputHost
  91++6775
  92++6775 FE 0D            cp CR
  92++6777 CA 7D 67       jp z, navigate
  93++677A
  94++677A                  IFDEF MSX
  95++677A ~                	cp ESC
  95++677A ~              jp z, exit
  96++677A                  ENDIF
  97++677A
  98++677A                  IFDEF GS
  99++677A ~                cp 'M'
  99++677A ~              call z, GeneralSound.toggleModule
 100++677A ~                cp 'm'
 100++677A ~              call z, GeneralSound.toggleModule
 101++677A ~                cp 'g'
 101++677A ~              call z, GeneralSound.toggleDownload
 102++677A ~                cp 'G'
 102++677A ~              call z, GeneralSound.toggleDownload
 103++677A                  ENDIF
 104++677A
 105++677A                  IFDEF TIMEX80
 106++677A ~                cp 'T'
 106++677A ~              call z, TextMode.toggleColor
 107++677A ~                cp 't'
 107++677A ~              call z, TextMode.toggleColor
 108++677A                  ENDIF
 109++677A
 110++677A C3 EC 66         jp workLoop
 111++677D
 112++677D              navigate:
 113++677D CD F7 69         call Console.waitForKeyUp
 114++6780 AF               xor a
 114++6781 32 08 69       ld (play_next), a
 115++6784 CD D0 67         call hideCursor
 116++6787 ED 4B 8E 75      ld bc, (page_offset)
 117++678B 2A 8C 75         ld hl, (cursor_position)
 118++678E 09               add hl,bc
 119++678F 44               ld b, h ;HHHHH
 120++6790 4D               ld c, l ;LLLLL
 121++6791 D5               push de
 122++6792 CD 50 65         call Render.findLine
 123++6795 D1               pop de
 124++6796 7E               ld a, (hl)
 125++6797 FE 31            cp '1'
 125++6799 CA B1 67       jp z, .load
 126++679C FE 30            cp '0'
 126++679E CA B1 67       jp z, .load
 127++67A1 FE 39            cp '9'
 127++67A3 CA B1 67       jp z, .load
 128++67A6 FE 37            cp '7'
 128++67A8 CA B9 67       jp z, .input
 129++67AB CD C8 67         call showCursor
 130++67AE C3 EC 66         jp workLoop
 131++67B1              .load
 132++67B1 E5               push hl
 133++67B2 CD 8E 64         call getIcon
 134++67B5 E1               pop hl
 135++67B6 C3 70 72         jp History.navigate
 136++67B9              .input
 137++67B9 E5               push hl
 138++67BA CD 09 69         call DialogBox.inputBox
 139++67BD E1               pop hl
 140++67BE 3A 6E 69         ld a, (DialogBox.inputBuffer)
 140++67C1 A7             and a
 140++67C2 CA 17 72       jp z, History.load
 141++67C5 C3 B1 67         jp .load
 142++67C8
 143++67C8              showCursor:
 144++67C8 3A 8C 75         ld a, (cursor_position)
 144++67CB C6 02          add CURSOR_OFFSET
 145++67CD C3 7B 60         jp TextMode.highlightLine
 146++67D0
 147++67D0              hideCursor:
 148++67D0 3A 8C 75         ld a, (cursor_position)
 148++67D3 C6 02          add CURSOR_OFFSET
 149++67D5 C3 61 60         jp TextMode.usualLine
 150++67D8
 151++67D8              cursorDown:
 152++67D8 CD D0 67         call hideCursor
 153++67DB 21 8C 75         ld hl, cursor_position
 154++67DE 34               inc (hl)
 155++67DF C3 D6 66         jp checkBorder
 156++67E2
 157++67E2              cursorUp:
 158++67E2 CD D0 67         call hideCursor
 159++67E5 21 8C 75         ld hl, cursor_position
 160++67E8 35               dec (hl)
 161++67E9 C3 D6 66         jp checkBorder
 162++67EC
 163++67EC              pageUp:
 164++67EC 3A 8E 75         ld a, (page_offset)
 164++67EF FE 00          cp 0
 164++67F1 C2 FF 67       jp nz, .pageUp2
 165++67F4 3A 8F 75         ld a, (page_offset + 1)
 165++67F7 FE 00          cp 0
 165++67F9 C2 FF 67       jp nz, .pageUp2
 166++67FC C3 15 68         jp .skip
 167++67FF              .pageUp2:
 168++67FF 3E 15            ld a, PER_PAGE - 1
 168++6801 32 8C 75       ld (cursor_position), a
 169++6804 2A 8E 75         ld hl, (page_offset)
 170++6807 11 16 00         ld de,PER_PAGE
 171++680A ED 52            sbc hl,de
 172++680C 22 8E 75         ld (page_offset), hl
 173++680F              .exit
 174++680F CD 9D 66         call renderGopherScreen
 175++6812 C3 EC 66         jp workLoop
 176++6815              .skip
 177++6815 AF               xor a
 177++6816 32 8C 75       ld (cursor_position), a
 177++6819 CD 9D 66       call renderGopherScreen
 177++681C C3 EC 66       jp workLoop
 178++681F
 179++681F              pageDn:
 180++681F AF                xor a
 180++6820 32 8C 75       ld (cursor_position), a
 181++6823 2A 8E 75         ld hl,(page_offset)
 182++6826 11 16 00         ld de,PER_PAGE
 183++6829 19               add hl,de
 184++682A 22 8E 75         ld (page_offset), hl
 185++682D C3 0F 68         jp pageUp.exit
 186++6830
# file closed: gopher/render/gopher-page.asm
   8++6830                  include "plaintext.asm"
# file opened: gopher/render/plaintext.asm
   1++6830              renderPlainTextScreen:
   2++6830 3E FF            ld a, 255
   3++6832 32 6E 8B         ld (oldminutes), a
   4++6835 CD 89 65         call prepareScreen
   5++6838
   6++6838 2A 8E 75         ld hl, (page_offset)        ; HL - offset to 0 Row on screen
   7++683B 44 4D            ld bc,hl                    ; BC - offset to C Row on screen
   8++683D CD 50 65         call Render.findLine        ;BC - Search this line  HL - Return pointer to page with offset
   9++6840 7C               ld a, h
  10++6841 B5               or l
  11++6842 28 30            jr z, .exit2
  12++6844 AF               xor a
  13++6845 C6 02            add CURSOR_OFFSET
  13++6847 57 1E 01       ld d, a, e, 1
  13++684A CD 3A 60       call TextMode.gotoXY
  14++684D CD 48 64         call print70Text
  15++6850 06 15            ld b, PER_PAGE -1
  16++6852              .loop
  17++6852 C5               push bc
  18++6853 3E 16            ld a, PER_PAGE
  19++6855 90               sub b
  20++6856 5F               ld e,a
  21++6857 01 01 00         ld bc, 1
  22++685A CD 53 65         call Render.findLine2   ;BC - Search this line  HL - Return pointer to page with offset
  23++685D 7C               ld a, h
  24++685E B5               or l
  25++685F 28 10            jr z, .exit
  26++6861 7B               ld a, e
  27++6862 C6 02            add CURSOR_OFFSET
  27++6864 57 1E 01       ld d, a, e, 1
  27++6867 CD 3A 60       call TextMode.gotoXY
  28++686A CD 48 64         call print70Text
  29++686D C1               pop bc
  30++686E 10 E2            djnz .loop
  31++6870 C9               ret
  32++6871              .exit
  33++6871 C1               pop bc
  34++6872 10 DE            djnz .loop
  35++6874              .exit2
  36++6874 CD C8 67         call showCursor
  37++6877 C9               ret
  38++6878              plainTextLoop:
  39++6878 CD C9 8A         call printRTC
  40++687B CD 10 6A         call Console.getC
  41++687E
  42++687E FE 31            cp '1'
  42++6880 CA 00 72       jp z, History.back
  43++6883 FE 32            cp '2'
  43++6885 CA 7D 67       jp z, navigate
  44++6888 FE 35            cp '5'
  44++688A CA E6 68       jp z, textUp
  45++688D FE 38            cp '8'
  45++688F CA D6 68       jp z, textDown
  46++6892 FE 08            cp Console.KEY_LT
  46++6894 CA E6 68       jp z, textUp
  47++6897 FE 09            cp Console.KEY_RT
  47++6899 CA D6 68       jp z, textDown
  48++689C
  49++689C FE 0A            cp Console.KEY_DN
  49++689E CA D6 68       jp z, textDown
  50++68A1 FE 61            cp 'a'
  50++68A3 CA D6 68       jp z, textDown
  51++68A6
  52++68A6 FE 0B            cp Console.KEY_UP
  52++68A8 CA E6 68       jp z, textUp
  53++68AB FE 71            cp 'q'
  53++68AD CA E6 68       jp z, textUp
  54++68B0
  55++68B0 FE 68            cp 'h'
  55++68B2 CA 6D 72       jp z, History.home
  56++68B5 FE 48            cp 'H'
  56++68B7 CA 6D 72       jp z, History.home
  57++68BA
  58++68BA FE 62            cp 'b'
  58++68BC CA 00 72       jp z, History.back
  59++68BF FE 42            cp 'B'
  59++68C1 CA 00 72       jp z, History.back
  60++68C4
  61++68C4 FE 64            cp 'd'
  61++68C6 CA A3 65       jp z, inputHost
  62++68C9 FE 44            cp 'D'
  62++68CB CA A3 65       jp z, inputHost
  63++68CE
  64++68CE FE 0C            cp Console.BACKSPACE
  64++68D0 CA 00 72       jp z, History.back
  65++68D3
  66++68D3                  IFDEF MSX
  67++68D3 ~                	cp ESC
  67++68D3 ~              jp z, exit
  68++68D3                  ENDIF
  69++68D3
  70++68D3                  IFDEF GS
  71++68D3 ~                cp 'M'
  71++68D3 ~              call z, GeneralSound.toggleModule
  72++68D3 ~                cp 'm'
  72++68D3 ~              call z, GeneralSound.toggleModule
  73++68D3                  ENDIF
  74++68D3
  75++68D3                  IFDEF TIMEX80
  76++68D3 ~                cp 'T'
  76++68D3 ~              call z, TextMode.toggleColor
  77++68D3 ~                cp 't'
  77++68D3 ~              call z, TextMode.toggleColor
  78++68D3                  ENDIF
  79++68D3
  80++68D3 C3 78 68         jp plainTextLoop
  81++68D6
  82++68D6
  83++68D6              textDown:
  84++68D6 2A 8E 75         ld hl,(page_offset)
  85++68D9 11 16 00         ld de,PER_PAGE
  86++68DC 19               add hl,de
  87++68DD 22 8E 75         ld (page_offset), hl
  88++68E0 CD 30 68         call renderPlainTextScreen
  89++68E3 C3 78 68         jp plainTextLoop
  90++68E6
  91++68E6              textUp:
  92++68E6 3A 8E 75         ld a, (page_offset)
  92++68E9 FE 00          cp 0
  92++68EB 20 0A          jr nz, .textUp2
  93++68ED 3A 8F 75         ld a, (page_offset + 1)
  93++68F0 FE 00          cp 0
  93++68F2 20 03          jr nz, .textUp2
  94++68F4 C3 78 68         jp plainTextLoop
  95++68F7
  96++68F7              .textUp2:
  97++68F7 2A 8E 75         ld hl,(page_offset)
  98++68FA 11 16 00         ld de,PER_PAGE
  99++68FD ED 52            sbc hl,de
 100++68FF 22 8E 75         ld (page_offset), hl
 101++6902 CD 30 68         call renderPlainTextScreen
 102++6905 C3 78 68         jp plainTextLoop
 103++6908
# file closed: gopher/render/plaintext.asm
   9++6908
  10++6908 00           play_next       db  0
  11++6909              position        EQU historyBlock.position
  12++6909              cursor_position EQU position + 2
  13++6909              page_offset     EQU position + 4
  14++6909
  15++6909                  ENDMODULE
  16++6909
  17++6909                  include "dialogbox.asm"
# file opened: gopher/render/dialogbox.asm
   1++6909                  module DialogBox
   2++6909
   3++6909              inputBox:
   4++6909 AF               xor a
   4++690A 32 6E 69       ld (inputBuffer), a
   5++690D              .noclear
   6++690D CD CF 69         call drawBox
   7++6910              .loop
   8++6910 11 05 0B         ld de, #0B05
   8++6913 CD 3A 60       call TextMode.gotoXY
   9++6916 21 6E 69         ld hl, inputBuffer
   9++6919 CD BC 60       call TextMode.printZ
  10++691C 3E 04            ld a, MIME_INPUT
  10++691E CD A4 60       call TextMode.putC
  10++6921 3E 20          ld a, ' '
  10++6923 CD A4 60       call TextMode.putC
  11++6926              .checkkey
  12++6926 CD 21 6A         call Console.peekC
  13++6929 FE 00            cp 00
  13++692B CA 26 69        jp z, .checkkey
  14++692E FE 0D            cp CR
  14++6930 C8             ret z
  15++6931
  16++6931                  IFNDEF MSX
  17++6931                  dup 11
  18++6931 76          >    halt
  18++6932 76          >    halt
  18++6933 76          >    halt
  18++6934 76          >    halt
  18++6935 76          >    halt
  18++6936 76          >    halt
  18++6937 76          >    halt
  18++6938 76          >    halt
  18++6939 76          >    halt
  18++693A 76          >    halt
  18++693B 76          >    halt
  19++693C                  edup
  20++693C                  ENDIF
  21++693C
  22++693C FE 0C            cp Console.BACKSPACE
  22++693E 28 13          jr z, .removeChar
  23++6940 FE 20            cp SPACE
  23++6942 38 E2          jr c, .checkkey
  24++6944              .putC
  25++6944 5F               ld e, a
  26++6945 AF               xor a
  26++6946 21 6E 69 01    ld hl, inputBuffer, bc, #ff
  26++694A FF 00
  26++694C ED B1          cpir
  27++694E 77               ld (hl), a
  27++694F 2B             dec hl
  27++6950 73             ld (hl), e
  28++6951 18 BD            jr .loop
  29++6953              .removeChar
  30++6953 AF               xor a
  31++6954 21 6E 69 01      ld hl, inputBuffer, bc, #ff
  31++6958 FF 00
  31++695A ED B1          cpir
  32++695C E5               push hl
  33++695D 11 6F 69             ld de, inputBuffer + 1
  34++6960 B7                   or a
  34++6961 ED 52          sbc hl, de
  35++6963 7C                   ld a, h
  35++6964 B5             or l
  36++6965 E1               pop hl
  37++6966 28 A8            jr z, .loop
  38++6968 AF               xor a
  39++6969 2B               dec hl
  39++696A 2B             dec hl
  39++696B 77             ld (hl), a
  40++696C 18 A2            jr .loop
  41++696E
  42++696E
  43++696E              namedownload
  44++696E                  IFDEF NEDOOS
  45++696E ~            		db "..",92,"downloads",92
  46++696E                  ENDIF
  47++696E
  48++696E 00 00 00...  inputBuffer ds 80
  49++69BE
  50++69BE              msgBox:
  51++69BE CD C7 69         call msgNoWait
  52++69C1 06 96            ld b, 150
  53++69C3              .loop
  54++69C3 76               halt
  55++69C4 10 FD            djnz .loop
  56++69C6 C9               ret
  57++69C7
  58++69C7              msgNoWait:
  59++69C7 E5               push hl
  60++69C8 CD CF 69         call drawBox
  61++69CB E1               pop hl
  62++69CC C3 BC 60         jp TextMode.printZ
  63++69CF
  64++69CF              drawBox:
  65++69CF 26 0A 3E 09      ld h, #0a, a, BORDER_TOP
  66++69D3 CD 47 60         call TextMode.fillLine
  67++69D6 26 0B 3E 20      ld h, #0b, a, ' '
  68++69DA CD 47 60         call TextMode.fillLine
  69++69DD 26 0C 3E 08      ld h, #0c, a, BORDER_BOTTOM
  70++69E1 CD 47 60         call TextMode.fillLine
  71++69E4 3E 0A            ld a, #0a
  72++69E6 CD 7B 60         call TextMode.highlightLine
  73++69E9 3E 0C            ld a, #0c
  74++69EB CD 7B 60         call TextMode.highlightLine
  75++69EE 11 03 0B         ld de,#0B03
  76++69F1 CD 3A 60         call TextMode.gotoXY
  77++69F4 C9               ret
  78++69F5                  endmodule
  79++69F5
# file closed: gopher/render/dialogbox.asm
# file closed: gopher/render/index.asm
  18+ 69F5                  include "dos/index.asm"
# file opened: dos/index.asm
   1++69F5              	IFDEF NEDOOS
   2++69F5 ~            	    include "nedoconsole.asm"
   3++69F5 ~            		include "nedoos.asm"
   4++69F5              	ENDIF
   5++69F5
   6++69F5              	IFDEF TRDOS
   7++69F5                  	include "console.asm"
# file opened: dos/console.asm
   1++69F5                  module Console
   2++69F5              KEY_UP = 11
   3++69F5              KEY_DN = 10
   4++69F5              KEY_LT = 8
   5++69F5              KEY_RT = 9
   6++69F5              BACKSPACE = 12
   7++69F5              BASIC_KEY = #5C08
   8++69F5 00           keyCode db 0
   9++69F6 00           tableShift db 0
  10++69F7
  11++69F7              waitForKeyUp:
  12++69F7 76           	halt
  13++69F8 AF              xor a
  13++69F9 DB FE          in a, (#fe)
  13++69FB 2F             cpl
  13++69FC E6 1F          and 31
  13++69FE 20 F7          jr nz, waitForKeyUp
  14++6A00 32 08 5C        ld (BASIC_KEY), a
  15++6A03 C9              ret
  16++6A04
  17++6A04              keyWait:
  18++6A04                  dup 11
  19++6A04 76          >    halt
  19++6A05 76          >    halt
  19++6A06 76          >    halt
  19++6A07 76          >    halt
  19++6A08 76          >    halt
  19++6A09 76          >    halt
  19++6A0A 76          >    halt
  19++6A0B 76          >    halt
  19++6A0C 76          >    halt
  19++6A0D 76          >    halt
  19++6A0E 76          >    halt
  20++6A0F                  edup
  21++6A0F C9              ret
  22++6A10
  23++6A10              getC:
  24++6A10              getCint:       ; for nedoOS
  25++6A10 AF              xor a
  26++6A11 32 08 5C        ld (BASIC_KEY),a
  27++6A14              getC2:
  28++6A14 3A 08 5C        ld a,(BASIC_KEY)
  29++6A17 A7              and a
  29++6A18 28 FA          jr z, getC2
  30++6A1A 47              ld b,a
  31++6A1B AF              xor a
  31++6A1C 32 08 5C       ld (BASIC_KEY), a
  32++6A1F 78              ld a, b
  33++6A20 C9              ret
  34++6A21              ;0xE - to Russian
  35++6A21              ;0xF - to Englich
  36++6A21              peekC:
  37++6A21 AF               xor a
  37++6A22 32 08 5C       ld (BASIC_KEY),a
  38++6A25 CD 45 6A         call inkey
  39++6A28 FE 0E            cp 0xE
  40++6A2A CA 33 6A         jp z, toRus
  41++6A2D FE 0F            cp 0xF
  42++6A2F CA 3D 6A         jp z, toEng
  43++6A32 C9               ret
  44++6A33              toRus
  45++6A33 3E A0           ld a, russiantable - englishTable
  46++6A35 32 F6 69        ld (tableShift), a
  47++6A38 AF              xor a
  48++6A39 CD 04 6A        call keyWait
  49++6A3C C9              ret
  50++6A3D              toEng
  51++6A3D AF              xor a
  52++6A3E 32 F6 69        ld (tableShift), a
  53++6A41 CD 04 6A        call keyWait
  54++6A44 C9              ret
  55++6A45
  56++6A45              inkey:
  57++6A45 11 00 00        ld de,0
  58++6A48 01 FE FE        ld bc,$fefe
  59++6A4B ED 78           in a,(c)
  60++6A4D F6 E1           or $e1
  61++6A4F FE FF           cp $ff
  62++6A51 20 57           jr nz, .keyhitA
  63++6A53
  64++6A53 1E 05           ld e,5
  65++6A55 06 FD           ld b,$fd
  66++6A57 ED 78           in a,(c)
  67++6A59 F6 E0           or $e0
  68++6A5B FE FF           cp $ff
  69++6A5D 20 4B           jr nz, .keyhitA
  70++6A5F
  71++6A5F 1E 0A           ld e,10
  72++6A61 06 FB           ld b,$fb
  73++6A63 ED 78           in a,(c)
  74++6A65 F6 E0           or $e0
  75++6A67 FE FF           cp $ff
  76++6A69 20 3F           jr nz, .keyhitA
  77++6A6B
  78++6A6B 1E 0F           ld e,15
  79++6A6D 06 F7           ld b,$f7
  80++6A6F ED 78           in a,(c)
  81++6A71 F6 E0           or $e0
  82++6A73 FE FF           cp $ff
  83++6A75 20 33           jr nz, .keyhitA
  84++6A77
  85++6A77 1E 14           ld e,20
  86++6A79 06 EF           ld b,$ef
  87++6A7B ED 78           in a,(c)
  88++6A7D F6 E0           or $e0
  89++6A7F FE FF           cp $ff
  90++6A81 20 27           jr nz, .keyhitA
  91++6A83
  92++6A83 1E 19           ld e,25
  93++6A85 06 DF           ld b,$df
  94++6A87 ED 78           in a,(c)
  95++6A89 F6 E0           or $e0
  96++6A8B FE FF           cp $ff
  97++6A8D 20 1B           jr nz, .keyhitA
  98++6A8F
  99++6A8F 1E 1E           ld e,30
 100++6A91 06 BF           ld b,$bf
 101++6A93 ED 78           in a,(c)
 102++6A95 F6 E0           or $e0
 103++6A97 FE FF           cp $ff
 104++6A99 20 0F           jr nz, .keyhitA
 105++6A9B
 106++6A9B 1E 23           ld e,35
 107++6A9D 06 7F           ld b,$7f
 108++6A9F ED 78           in a,(c)
 109++6AA1 F6 E2           or $e2
 110++6AA3 FE FF           cp $ff
 111++6AA5 4F              ld c,a
 112++6AA6 20 19           jr nz, .keyhitB
 113++6AA8
 114++6AA8              .nokey
 115++6AA8 AF              xor a
 116++6AA9 C9              ret
 117++6AAA
 118++6AAA              .keyhitA
 119++6AAA
 120++6AAA 4F              ld c,a
 121++6AAB
 122++6AAB 78              ld a,b
 123++6AAC 2F              cpl
 124++6AAD F6 81           or $81
 125++6AAF DB FE           in a,($fe)
 126++6AB1 F6 E0           or $e0
 127++6AB3 FE FF           cp $ff
 128++6AB5 20 F1           jr nz, .nokey
 129++6AB7
 130++6AB7 3E 7F           ld a,$7f
 131++6AB9 DB FE           in a,($fe)
 132++6ABB F6 E2           or $e2
 133++6ABD FE FF           cp $ff
 134++6ABF 20 E7           jr nz, .nokey
 135++6AC1
 136++6AC1              .keyhitB
 137++6AC1
 138++6AC1 06 00           ld b,0
 139++6AC3 21 0F 6A        ld hl,.rowtbl-$e0
 140++6AC6 09              add hl,bc
 141++6AC7 7E              ld a,(hl)
 142++6AC8 FE 05           cp 5
 143++6ACA 30 DC           jr nc, .nokey
 144++6ACC 83              add a,e
 145++6ACD 5F              ld e,a
 146++6ACE
 147++6ACE 21 0F 6B        ld  hl, englishTable
 148++6AD1 19              add hl, de
 149++6AD2 3A F6 69        ld  a, (tableShift)
 150++6AD5 5F              ld e, a
 151++6AD6 19              add hl, de
 152++6AD7 3E FE           ld a,$fe
 153++6AD9 DB FE           in a,($fe)
 154++6ADB E6 01           and $01
 155++6ADD 20 03           jr nz, .nocaps
 156++6ADF 1E 28           ld e,40
 157++6AE1 19              add hl,de
 158++6AE2
 159++6AE2              .nocaps
 160++6AE2
 161++6AE2 3E 7F           ld a,$7f
 162++6AE4 DB FE           in a,($fe)
 163++6AE6 E6 02           and $02
 164++6AE8 20 03           jr nz, .nosym
 165++6AEA 1E 50           ld e,80
 166++6AEC 19              add hl,de
 167++6AED
 168++6AED              .nosym
 169++6AED
 170++6AED 7E              ld a,(hl)
 171++6AEE C9              ret
 172++6AEF
 173++6AEF              .rowtbl
 174++6AEF FF FF FF FF     defb 255,255,255,255,255,255,255
 174++6AF3 FF FF FF
 175++6AF6 FF FF FF FF     defb 255,255,255,255,255,255,255,255
 175++6AFA FF FF FF FF
 176++6AFE 04 FF FF FF     defb 4,255,255,255,255,255,255
 176++6B02 FF FF FF
 177++6B05 FF 03 FF FF     defb 255,3,255,255,255,2,255,1
 177++6B09 FF 02 FF 01
 178++6B0D 00 FF           defb 0,255
 179++6B0F
 180++6B0F              englishTable
 181++6B0F 00 7A 78 63     db 0,'z','x','c','v'      ; CAPS SHIFT, Z, X, C, V
 181++6B13 76
 182++6B14 61 73 64 66     db 'a','s','d','f','g'      ; A, S, D, F, G
 182++6B18 67
 183++6B19 71 77 65 72     db 'q','w','e','r','t'      ; Q, W, E, R, T
 183++6B1D 74
 184++6B1E 31 32 33 34     db '1','2','3','4','5'      ; 1, 2, 3, 4, 5
 184++6B22 35
 185++6B23 30 39 38 37     db '0','9','8','7','6'      ; 0, 9, 8, 7, 6
 185++6B27 36
 186++6B28 70 6F 69 75     db 'p','o','i','u','y'      ; P, O, I, U, Y
 186++6B2C 79
 187++6B2D 0D 6C 6B 6A     db 13,'l','k','j','h'       ; ENTER, L, K, J, H
 187++6B31 68
 188++6B32 20 00 6D 6E     db ' ',0,'m','n','b'      ; SPACE, SYM SHIFT, M, N, B
 188++6B36 62
 189++6B37
 190++6B37                 ; the following are CAPS SHIFTed
 191++6B37
 192++6B37 00 5A 58 43     db 0,'Z','X','C','V'      ; CAPS SHIFT, Z, X, C, V
 192++6B3B 56
 193++6B3C 41 53 44 46     db 'A','S','D','F','G'      ; A, S, D, F, G
 193++6B40 47
 194++6B41 51 57 45 52     db 'Q','W','E','R','T'      ; Q, W, E, R, T
 194++6B45 54
 195++6B46 0E 06 80 81     db 14,6,128,129,8           ; 1, 2, 3, 4, 5
 195++6B4A 08
 196++6B4B 0C 00 09 0B     db 12,0,9,11,10             ; 0, 9, 8, 7, 6
 196++6B4F 0A
 197++6B50 50 4F 49 55     db 'P','O','I','U','Y'      ; P, O, I, U, Y
 197++6B54 59
 198++6B55 0D 4C 4B 4A     db 13,'L','K','J','H'       ; ENTER, L, K, J, H
 198++6B59 48
 199++6B5A 20 00 4D 4E     db ' ',0,'M','N','B'      ; SPACE, SYM SHIFT, M, N, B
 199++6B5E 42
 200++6B5F
 201++6B5F                 ; the following are SYM SHIFTed
 202++6B5F
 203++6B5F 00 3A 60 3F     db 0,':',96,'?','/'       ; CAPS SHIFT, Z, X, C, V
 203++6B63 2F
 204++6B64 7E 7C 5C 7B     db '~','|',92,'{','}'       ; A, S, D, F, G
 204++6B68 7D
 205++6B69 83 84 85 3C     db 131,132,133,'<','>'      ; Q, W, E, R, T
 205++6B6D 3E
 206++6B6E 21 40 23 24     db '!','@','#','$','%'      ; 1, 2, 3, 4, 5
 206++6B72 25
 207++6B73 5F 29 28 27     db '_',')','(',39,'&'       ; 0, 9, 8, 7, 6
 207++6B77 26
 208++6B78 22 3B 82 5D     db 34,';',130,']','['       ; P, O, I, U, Y
 208++6B7C 5B
 209++6B7D 0D 3D 2B 2D     db 13,'=','+','-','^'       ; ENTER, L, K, J, H
 209++6B81 5E
 210++6B82 20 00 2E 2C     db ' ',0,'.',',','*'      ; SPACE, SYM SHIFT, M, N, B
 210++6B86 2A
 211++6B87
 212++6B87                 ; the following are CAPS SHIFTed and SYM SHIFTed ("CTRL" key)
 213++6B87
 214++6B87 00 1A 18 03     db 0,26,24,3,22           ; CAPS SHIFT, Z, X, C, V
 214++6B8B 16
 215++6B8C 01 13 04 06     db 1,19,4,6,7               ; A, S, D, F, G
 215++6B90 07
 216++6B91 11 17 05 12     db 17,23,5,18,20            ; Q, W, E, R, T
 216++6B95 14
 217++6B96 1B 1C 1D 1E     db 27,28,29,30,31           ; 1, 2, 3, 4, 5
 217++6B9A 1F
 218++6B9B 7F 00 86 60     db 127,0,134,'`',135      ; 0, 9, 8, 7, 6
 218++6B9F 87
 219++6BA0 10 0F 09 15     db 16,15,9,21,25            ; P, O, I, U, Y
 219++6BA4 19
 220++6BA5 0D 0C 0B 0A     db 13,12,11,10,8            ; ENTER, L, K, J, H
 220++6BA9 08
 221++6BAA 20 00 0D 0E     db ' ',0,13,14,2          ; SPACE, SYM SHIFT, M, N, B
 221++6BAE 02
 222++6BAF
 223++6BAF              russiantable
 224++6BAF 00 EF E7 E1     db 0,'','','',''      ; CAPS SHIFT, Z, X, C, V
 224++6BB3 AC
 225++6BB4 E4 EB A2 A0     db '','','','',''      ; A, S, D, F, G
 225++6BB8 AF
 226++6BB9 A9 E6 E3 AA     db '','','','',''      ; Q, W, E, R, T
 226++6BBD A5
 227++6BBE 31 32 33 34     db '1','2','3','4','5'      ; 1, 2, 3, 4, 5
 227++6BC2 35
 228++6BC3 30 39 38 37     db '0','9','8','7','6'      ; 0, 9, 8, 7, 6
 228++6BC7 36
 229++6BC8 A7 E9 E8 A3     db '','','','',''      ; P, O, I, U, Y
 229++6BCC AD
 230++6BCD 0D A4 AB AE     db 13,'','','',''       ; ENTER, L, K, J, H
 230++6BD1 E0
 231++6BD2 20 00 EC E2     db ' ',0,'','',''      ; SPACE, SYM SHIFT, M, N, B
 231++6BD6 A8
 232++6BD7
 233++6BD7                 ; the following are CAPS SHIFTed
 234++6BD7
 235++6BD7 00 9F 97 91     db 0,'','','',''      ; CAPS SHIFT, Z, X, C, V
 235++6BDB 8C
 236++6BDC 94 9B 82 80     db '','','','',''      ; A, S, D, F, G
 236++6BE0 8F
 237++6BE1 89 96 93 8A     db '','','','',''      ; Q, W, E, R, T
 237++6BE5 85
 238++6BE6 0F 06 80 81     db 15,6,128,129,8            ; 1, 2, 3, 4, 5
 238++6BEA 08
 239++6BEB 0C 00 09 0B     db 12,0,9,11,10             ; 0, 9, 8, 7, 6
 239++6BEF 0A
 240++6BF0 87 99 98 83     db '','','','',''      ; P, O, I, U, Y
 240++6BF4 8D
 241++6BF5 0D 84 8B 8E     db 13,'','','',''       ; ENTER, L, K, J, H
 241++6BF9 90
 242++6BFA 20 00 9C 92     db ' ',0,'','',''      ; SPACE, SYM SHIFT, M, N, B
 242++6BFE 88
 243++6BFF
 244++6BFF                 ; the following are SYM SHIFTed
 245++6BFF
 246++6BFF 00 3A EE 3F     db 0,':','','?','/'       ; CAPS SHIFT, Z, X, C, V
 246++6C03 2F
 247++6C04 A1 ED 5C E5     db '','',92,'',''       ; A, S, D, F, G
 247++6C08 A6
 248++6C09 83 84 85 3C     db 131,132,133,'<','>'      ; Q, W, E, R, T
 248++6C0D 3E
 249++6C0E 21 40 23 24     db '!','@','#','$','%'      ; 1, 2, 3, 4, 5
 249++6C12 25
 250++6C13 5F 29 28 27     db '_',')','(',39,'&'       ; 0, 9, 8, 7, 6
 250++6C17 26
 251++6C18 22 3B 82 5D     db 34,';',130,']','['       ; P, O, I, U, Y
 251++6C1C 5B
 252++6C1D 0D 3D 2B 2D     db 13,'=','+','-','^'       ; ENTER, L, K, J, H
 252++6C21 5E
 253++6C22 20 00 2E 2C     db ' ',0,'.',',','*'      ; SPACE, SYM SHIFT, M, N, B
 253++6C26 2A
 254++6C27
 255++6C27                 ; the following are CAPS SHIFTed and SYM SHIFTed ("CTRL" key)
 256++6C27
 257++6C27 00 1A 9E 03     db 0,26,'',3,22           ; CAPS SHIFT, Z, X, C, V
 257++6C2B 16
 258++6C2C 81 9D 04 95     db '','',4,'',''               ; A, S, D, F, G
 258++6C30 86
 259++6C31 11 17 05 12     db 17,23,5,18,20            ; Q, W, E, R, T
 259++6C35 14
 260++6C36 1B 1C 1D 1E     db 27,28,29,30,31           ; 1, 2, 3, 4, 5
 260++6C3A 1F
 261++6C3B 7F 00 86 60     db 127,0,134,'`',135      ; 0, 9, 8, 7, 6
 261++6C3F 87
 262++6C40 10 0F 09 15     db 16,15,9,21,25            ; P, O, I, U, Y
 262++6C44 19
 263++6C45 0D 0C 0B 0A     db 13,12,11,10,8            ; ENTER, L, K, J, H
 263++6C49 08
 264++6C4A 20 00 0D 0E     db ' ',0,13,14,2          ; SPACE, SYM SHIFT, M, N, B
 264++6C4E 02
 265++6C4F
 266++6C4F                  endmodule
# file closed: dos/console.asm
   8++6C4F              		include "trdos.asm"
# file opened: dos/trdos.asm
   1++6C4F              ;trdos driver (izzx)
   2++6C4F                  MODULE Dos
   3++6C4F              ; API methods
   4++6C4F              ESX_GETSETDRV = #89
   5++6C4F              ESX_FOPEN = #9A
   6++6C4F              ESX_FCLOSE = #9B
   7++6C4F              ESX_FSYNC = #9C
   8++6C4F              ESX_FREAD = #9D
   9++6C4F              ESX_FWRITE = #9E
  10++6C4F
  11++6C4F              ; File modes
  12++6C4F              FMODE_READ = #01
  13++6C4F              FMODE_WRITE = #06
  14++6C4F              FMODE_CREATE = #0E
  15++6C4F
  16++6C4F                  ; MACRO esxCall func
  17++6C4F                  ; rst #8 : db func
  18++6C4F                  ; ENDM
  19++6C4F
  20++6C4F              ;id = 0   
  21++6C4F              ;id = 1   
  22++6C4F              ;id = 2   
  23++6C4F              ;id = 3     TRD
  24++6C4F              ;id = 4     SCL
  25++6C4F
  26++6C4F              ; HL - filename in ASCIIZ
  27++6C4F              loadBuffer:
  28++6C4F 06 01            ld b, Dos.FMODE_READ
  28++6C51 CD 6B 6C       call Dos.fopen
  29++6C54 F5               push af
  30++6C55 21 E2 97 01          ld hl, outputBuffer, bc, #ffff - outputBuffer
  30++6C59 1D 68
  30++6C5B CD 58 6D       call Dos.fread
  31++6C5E 21 E2 97             ld hl, outputBuffer
  31++6C61 09             add hl, bc
  31++6C62 AF             xor a
  31++6C63 77             ld (hl), a
  31++6C64 23             inc hl
  31++6C65 77             ld (hl), a
  32++6C66 F1               pop af
  33++6C67 CD 44 6D         call Dos.fclose
  34++6C6A C9               ret
  35++6C6B
  36++6C6B
  37++6C6B              ; Returns:
  38++6C6B              ;  A - current drive
  39++6C6B              ; getDefaultDrive: ;  
  40++6C6B                  ; ld a, 0 : esxCall ESX_GETSETDRV
  41++6C6B                  ; ret
  42++6C6B
  43++6C6B
  44++6C6B
  45++6C6B              ; Opens file on default drive
  46++6C6B              ; B - File mode
  47++6C6B              ; HL - File name
  48++6C6B              ; Returns:
  49++6C6B              ;  A - file stream id
  50++6C6B              fopen:
  51++6C6B                  ; push bc : push hl
  52++6C6B                  ; call getDefaultDrive
  53++6C6B                  ; pop ix : pop bc
  54++6C6B                  ; esxCall ESX_FOPEN
  55++6C6B                  ; ret
  56++6C6B 78           	ld a,b
  57++6C6C FE 01        	cp FMODE_READ ;   
  58++6C6E 28 06        	jr z,fopen_r
  59++6C70 FE 0E        	cp FMODE_CREATE
  60++6C72 28 39        	jr z,fopen_c ;   
  61++6C74 18 34        	jr fopen_err ; 
  62++6C76
  63++6C76              fopen_r	;     (id=1)
  64++6C76 CD DB 70     			call format_name ;
  65++6C79 0E 13        			ld      c,#13 ;move file info to syst var
  66++6C7B CD 13 3D                 call    #3d13
  67++6C7E 0E 0A                    ld      c,#0a ;find file
  68++6C80 CD 13 3D                 call    #3d13
  69++6C83 79                       ld      a,c
  70++6C84 FE FF        			cp 		#ff
  71++6C86 28 22        			jr 		z,fopen_err ;   
  72++6C88 0E 08                    ld      c,#08 ;read file title
  73++6C8A CD 13 3D                 call    #3d13
  74++6C8D                          ;ld      hl,loadadr ;
  75++6C8D ED 5B EB 5C              ld      de,(#5ceb) ;   
  76++6C91 ED 53 87 71              ld      (f_r_cur_trk),de
  77++6C95
  78++6C95 3A EA 5C                 ld      a,(#5cea)
  79++6C98 32 89 71                 ld      (f_r_len_sec),a ;  
  80++6C9B                          ;or      a
  81++6C9B                          ;ret     z    ;  
  82++6C9B
  83++6C9B ED 5B E8 5C  			ld de,(#5CE8) ;       BASIC
  84++6C9F ED 53 8A 71  			ld      (f_r_len),de
  85++6CA3
  86++6CA3                          ; ld      de,(fcurtrk) ;  
  87++6CA3                          ; ld      (#5cf4),de ;
  88++6CA3 AF           			xor a
  89++6CA4 3E 01        			ld 		a,1
  90++6CA6 32 8C 71     			ld (f_r_flag),a ;     
  91++6CA9              			;id   1
  92++6CA9 C9           	ret
  93++6CAA
  94++6CAA              fopen_err
  95++6CAA AF           	xor a ;    ,  id = 0
  96++6CAB 37           	scf ; 
  97++6CAC C9           	ret
  98++6CAD
  99++6CAD
 100++6CAD              fopen_c	;   (id=2-4)
 101++6CAD CD DB 70     	call format_name ;
 102++6CB0              	;,      
 103++6CB0 21 6A 71         ld hl, trdExt1
 103++6CB3 CD F2 63       call CompareBuff.search
 103++6CB6 A7             and a
 103++6CB7 20 1D          jr nz, fopen_c_trd
 104++6CB9 21 6F 71         ld hl, trdExt2
 104++6CBC CD F2 63       call CompareBuff.search
 104++6CBF A7             and a
 104++6CC0 20 14          jr nz, fopen_c_trd
 105++6CC2 21 74 71     	ld hl, sclExt1
 105++6CC5 CD F2 63       call CompareBuff.search
 105++6CC8 A7             and a
 105++6CC9 20 3A          jr nz, fopen_c_scl
 106++6CCB 21 79 71         ld hl, sclExt2
 106++6CCE CD F2 63       call CompareBuff.search
 106++6CD1 A7             and a
 106++6CD2 20 31          jr nz, fopen_c_scl
 107++6CD4
 108++6CD4
 109++6CD4              fopen_c_2	;  
 110++6CD4 18 D4        	jr 		fopen_err ; 
 111++6CD6
 112++6CD6              	; ld      c,#13 ;move file info to syst var
 113++6CD6                  ; call    #3d13
 114++6CD6              	; ld de,256 ;  1 
 115++6CD6              	; ld hl,#4000 ;    
 116++6CD6                  ; ld      c,#0b ;  CODE
 117++6CD6                  ; call    #3d13
 118++6CD6                  ; ld      a,c
 119++6CD6              	; cp 		#ff
 120++6CD6              	; jr 		z,fopen_err ; 
 121++6CD6
 122++6CD6                  ; ld      de,(#5ceb) ;   
 123++6CD6                  ; ld      (f_w_cur_trk),de
 124++6CD6                  ; ld      a,(#5cea)
 125++6CD6                  ; ld      (f_w_len_sec),a ;  
 126++6CD6              	; xor a ;id   2
 127++6CD6              	; ld a,2
 128++6CD6              	; ld (f_w_flag),a ;     
 129++6CD6              	; ret
 130++6CD6
 131++6CD6
 132++6CD6
 133++6CD6
 134++6CD6
 135++6CD6              fopen_c_trd	;     trd (id=3)
 136++6CD6 3A 19 5D     	ld a,(#5D19) ;   
 137++6CD9 C6 41        	add a,"A"
 138++6CDB 32 50 71     	ld (write_ima_d),a ;   
 139++6CDE 21 3B 71         ld hl, write_ima
 140++6CE1 CD BE 69         call DialogBox.msgBox ;
 141++6CE4              WAITKEY_trd
 142++6CE4 3A 04 5C     	ld 		a,(23556)
 143++6CE7 FE FF        	cp 255
 144++6CE9 28 F9        	JR Z,WAITKEY_trd	;  
 145++6CEB
 146++6CEB 11 00 00     	ld      de,0 ;  
 147++6CEE ED 53 F4 5C      ld      (#5cf4),de
 148++6CF2 AF           	xor a
 149++6CF3 32 9C 71     	ld (sec_shift),a ;
 150++6CF6 21 00 00     	ld hl,0
 151++6CF9 22 91 71     	ld (f_w_len+0),hl
 152++6CFC 22 93 71     	ld (f_w_len+2),hl
 153++6CFF 3E 03        	ld a,3 ;id 
 154++6D01 32 90 71     	ld (f_w_flag),a ;  trd   
 155++6D04 C9           	ret
 156++6D05
 157++6D05
 158++6D05
 159++6D05
 160++6D05              fopen_c_scl	;     scl (id=4)
 161++6D05 3A 19 5D     	ld a,(#5D19) ;   
 162++6D08 C6 41        	add a,"A"
 163++6D0A 32 50 71     	ld (write_ima_d),a ;   
 164++6D0D 21 3B 71         ld hl, write_ima
 165++6D10 CD BE 69         call DialogBox.msgBox ;
 166++6D13              WAITKEY_scl
 167++6D13 3A 04 5C     	ld 		a,(23556)
 168++6D16 FE FF        	cp 255
 169++6D18 28 F9        	JR Z,WAITKEY_scl	;  
 170++6D1A
 171++6D1A 11 00 00     	ld      de,0 ;  
 172++6D1D ED 53 F4 5C      ld      (#5cf4),de
 173++6D21
 174++6D21 21 00 48     	ld hl,cat_buf ;    
 175++6D24 11 01 48     	ld de,cat_buf+1
 176++6D27 36 00        	ld (hl),0
 177++6D29 01 FF 08     	ld bc,9*256-1
 178++6D2C ED B0        	ldir
 179++6D2E
 180++6D2E CD 50 6F     	call scl_parse ;   
 181++6D31
 182++6D31 AF           	xor a
 183++6D32 32 9C 71     	ld (sec_shift),a ;
 184++6D35              	;ld (scl_que),a
 185++6D35 21 00 00     	ld hl,0
 186++6D38 22 91 71     	ld (f_w_len+0),hl
 187++6D3B 22 93 71     	ld (f_w_len+2),hl
 188++6D3E 3E 04        	ld a,4 ;id 
 189++6D40 32 90 71     	ld (f_w_flag),a ;  scl   
 190++6D43 C9           	ret
 191++6D44
 192++6D44
 193++6D44
 194++6D44              ; A - file stream id
 195++6D44              fclose:
 196++6D44                  ;esxCall ESX_FCLOSE
 197++6D44              	; push af
 198++6D44              ; WAITKEY2	XOR A:IN A,(#FE):CPL:AND #1F:JR Z,WAITKEY2
 199++6D44              	; pop af
 200++6D44 FE 04        	cp 4 ; scl
 201++6D46 20 08        	jr nz,fclose2
 202++6D48 21 00 51     	ld hl,sec_buf ;
 203++6D4B 06 01        	ld b,1
 204++6D4D CD 2F 6F     	call scl_write_buf ;  scl,  
 205++6D50
 206++6D50              fclose2
 207++6D50 AF           	xor a ;    
 208++6D51 32 8C 71     	ld (f_r_flag),a
 209++6D54 32 90 71     	ld (f_w_flag),a
 210++6D57 C9               ret
 211++6D58
 212++6D58
 213++6D58
 214++6D58
 215++6D58              ; A - file stream id
 216++6D58              ; BC - length
 217++6D58              ; HL - buffer
 218++6D58              ; Returns
 219++6D58              ;  BC - length(how much was actually read)
 220++6D58              fread: ;(id=1)
 221++6D58                  ; push hl : pop ix
 222++6D58                  ; esxCall ESX_FREAD
 223++6D58              	; push af
 224++6D58              	; ld a,4
 225++6D58              	; out (254),a
 226++6D58              ; WAITKEY	XOR A:IN A,(#FE):CPL:AND #1F:JR Z,WAITKEY
 227++6D58              	; xor a
 228++6D58              	; out (254),a
 229++6D58              	; pop af
 230++6D58
 231++6D58 FE 01        	cp 1 ;id = 1?
 232++6D5A 20 06        	jr nz,fread_no_chek ;     = 1
 233++6D5C 3A 8C 71     	ld a,(f_r_flag)
 234++6D5F B7           	or a
 235++6D60 20 06        	jr nz,fread_chek ;  ?
 236++6D62              fread_no_chek ;  
 237++6D62 AF           	xor a
 238++6D63 37           	scf ; 
 239++6D64 01 00 00     	ld bc,0 ;   
 240++6D67 C9           	ret
 241++6D68
 242++6D68              fread_chek
 243++6D68 ED 4B 88 71  	ld bc,(f_r_len_sec-1) ;  ,    ,    
 244++6D6C 0E 05            ld      c,5 ;read   
 245++6D6E ED 5B 87 71  	ld de,(f_r_cur_trk)
 246++6D72 CD 13 3D         call    #3d13
 247++6D75 ED 4B 8A 71  	ld bc,(f_r_len) ;    ( )
 248++6D79 AF           	xor a ; 
 249++6D7A C9               ret
 250++6D7B
 251++6D7B              ; A - file stream id
 252++6D7B              ; BC - length
 253++6D7B              ; HL - buffer
 254++6D7B              ; Returns:
 255++6D7B              ;   BC - actually written bytes
 256++6D7B              fwrite: ;
 257++6D7B                  ; push hl : pop ix
 258++6D7B                  ; esxCall ESX_FWRITE
 259++6D7B
 260++6D7B              	; push af
 261++6D7B              	; ld a,2
 262++6D7B              	; out (254),a
 263++6D7B              ; WAITKEY1	XOR A:IN A,(#FE):CPL:AND #1F:JR Z,WAITKEY1
 264++6D7B              	; xor a
 265++6D7B              	; out (254),a
 266++6D7B              	; pop af
 267++6D7B
 268++6D7B FE 02        	cp 2 ;id = 2?
 269++6D7D 28 0F        	jr z,fwrite_chek ; id 
 270++6D7F FE 03        	cp 3 ;id = 3?
 271++6D81 28 0D        	jr z,fwrite_chek_trd ; id 
 272++6D83 FE 04        	cp 4 ;id = 4?
 273++6D85 CA 6A 6E     	jp z,fwrite_chek_scl ; id 
 274++6D88
 275++6D88
 276++6D88              fwrite_no_chek ;  
 277++6D88 AF           	xor a
 278++6D89 37           	scf ; 
 279++6D8A 01 00 00     	ld bc,0 ;   
 280++6D8D C9           	ret
 281++6D8E
 282++6D8E              fwrite_chek ;   
 283++6D8E 18 F8        	jr fwrite_no_chek ; 
 284++6D90              	; ld a,(f_w_flag)
 285++6D90              	; or a
 286++6D90              	; jr z,fwrite_no_chek ;  ?
 287++6D90              	; ld (temp_bc),bc
 288++6D90              	; ;ld bc,(f_r_len_sec-1) ;
 289++6D90                  ; ld      c,6 ;  
 290++6D90              	; ld de,(f_w_cur_trk)
 291++6D90                  ; call    #3d13
 292++6D90              	; ld bc,(temp_bc) ;,   ,    
 293++6D90              	; xor a ; 
 294++6D90                  ; ret
 295++6D90
 296++6D90
 297++6D90
 298++6D90
 299++6D90
 300++6D90              fwrite_chek_trd ; trd  ( )
 301++6D90              	; ld a,2
 302++6D90              	; out (254),a
 303++6D90              ; WAITKEY_t	XOR A:IN A,(#FE):CPL:AND #1F:JR Z,WAITKEY_t
 304++6D90              	; xor a
 305++6D90              	; out (254),a
 306++6D90 3A 90 71     	ld a,(f_w_flag)
 307++6D93 B7           	or a
 308++6D94 28 F2        	jr z,fwrite_no_chek ;  ?
 309++6D96 ED 43 96 71  	ld (temp_bc),bc ;
 310++6D9A 22 98 71     	ld (temp_hl),hl ; 
 311++6D9D 78           	ld a,b
 312++6D9E B1           	or c
 313++6D9F 28 E7        	jr z,fwrite_no_chek ;   0,  
 314++6DA1
 315++6DA1              	; ld a,b
 316++6DA1              	; or a
 317++6DA1              	; jr nz,testt1
 318++6DA1              	; nop
 319++6DA1
 320++6DA1              ; testt1
 321++6DA1
 322++6DA1 AF           	xor a
 323++6DA2 32 9E 71     	ld (sec_part),a ; 
 324++6DA5 32 9D 71     	ld (sec_shift2),a
 325++6DA8 32 9E 71     	ld (sec_shift2+1),a
 326++6DAB 32 9F 71     	ld (sec_shift_flag),a
 327++6DAE 32 95 71     	ld (write_end_flag),a ;
 328++6DB1
 329++6DB1
 330++6DB1 3A 9C 71     	ld a,(sec_shift)
 331++6DB4 B7           	or a
 332++6DB5 28 43        	jr z,fwrite_trd3 ;  ,    
 333++6DB7
 334++6DB7
 335++6DB7 4F           	ld c,a
 336++6DB8 06 00        	ld b,0
 337++6DBA 2A 96 71     	ld hl,(temp_bc) ;    
 338++6DBD 09           	add hl,bc
 339++6DBE
 340++6DBE 3E 01        	ld a,1
 341++6DC0 32 95 71     	ld (write_end_flag),a ;     
 342++6DC3
 343++6DC3 7C           	ld a,h
 344++6DC4 B7           	or a
 345++6DC5 20 05        	jr nz,fwrite_trd4
 346++6DC7 3E 01        	ld a,1
 347++6DC9 32 9F 71     	ld (sec_shift_flag),a ;    
 348++6DCC
 349++6DCC              fwrite_trd4
 350++6DCC 21 00 51     	ld hl,sec_buf ;  
 351++6DCF 09           	add hl,bc ;   
 352++6DD0 EB           	ex de,hl
 353++6DD1 2A 98 71     	ld hl,(temp_hl) ;     
 354++6DD4              	; ld a,c
 355++6DD4              	; or a
 356++6DD4              	; jr nz,fwrite_trd2
 357++6DD4              	; inc b ;
 358++6DD4              ; fwrite_trd2
 359++6DD4              	; ld c,a
 360++6DD4 AF           	xor a
 361++6DD5 91           	sub c
 362++6DD6 4F           	ld c,a ;     
 363++6DD7 ED 43 9D 71  	ld (sec_shift2),bc ;   
 364++6DDB ED B0        	ldir
 365++6DDD
 366++6DDD 3A 9F 71     	ld a,(sec_shift_flag)
 367++6DE0 B7           	or a
 368++6DE1 20 17        	jr nz,fwrite_trd3 ;       
 369++6DE3
 370++6DE3 21 00 51     	ld hl,sec_buf
 371++6DE6 ED 5B F4 5C  	ld de,(#5cf4)
 372++6DEA              	;ld (f_w_cur_trk),de	; 
 373++6DEA 01 06 01         ld      bc,#0106 ; 1   
 374++6DED CD 13 3D         call    #3d13
 375++6DF0 79           	ld a,c
 376++6DF1 FE FF        	cp 255
 377++6DF3 CA 88 6D     	jp z,fwrite_no_chek ;  
 378++6DF6
 379++6DF6 AF           	xor a
 380++6DF7 32 95 71     	ld (write_end_flag),a ;    
 381++6DFA              	; ld de,(f_w_cur_trk) ;    ,    
 382++6DFA              	; ld (#5cf4),de
 383++6DFA              	; ld b,1 ;  
 384++6DFA              	; ld de,(f_w_cur_trk)
 385++6DFA              	; call calc_next_pos
 386++6DFA              	; ld (f_w_cur_trk),de
 387++6DFA
 388++6DFA              fwrite_trd3
 389++6DFA 2A 98 71     	ld hl,(temp_hl) ;  
 390++6DFD              	;ld a,(sec_shift)
 391++6DFD              	;ld c,a
 392++6DFD              	;ld b,0
 393++6DFD ED 4B 9D 71  	ld bc,(sec_shift2)
 394++6E01 09           	add hl,bc ;   
 395++6E02 22 9A 71     	ld (temp_hl2),hl ;    
 396++6E05
 397++6E05 2A 96 71     	ld hl,(temp_bc) ;      
 398++6E08 A7           	and a
 399++6E09 ED 42        	sbc hl,bc ; ,     
 400++6E0B 4D           	ld c,l
 401++6E0C 44           	ld b,h
 402++6E0D 30 02        	jr nc,fwrite_trd5
 403++6E0F 06 00        	ld b,0 ;   
 404++6E11              fwrite_trd5
 405++6E11 2A 98 71     	ld hl,(temp_hl)
 406++6E14 09           	add hl,bc
 407++6E15
 408++6E15 11 E2 97     	ld de,outputBuffer
 409++6E18 A7           	and a
 410++6E19 ED 52        	sbc hl,de
 411++6E1B
 412++6E1B 7D           	ld a,l
 413++6E1C 32 9C 71     	ld (sec_shift),a ;   
 414++6E1F              	;ld hl,(temp_hl)
 415++6E1F
 416++6E1F
 417++6E1F              	; or a
 418++6E1F              	; jr z,fwrite_trd1
 419++6E1F              	; inc b  ;  
 420++6E1F
 421++6E1F 78           	ld a,b ;    !!!
 422++6E20 32 9E 71     	ld (sec_part),a ;     
 423++6E23
 424++6E23              	;ld a,b
 425++6E23 B7           	or a
 426++6E24 28 16        	jr z,fwrite_trd1 ;    ,   
 427++6E26
 428++6E26 2A 9A 71     	ld hl,(temp_hl2)
 429++6E29              	;push bc
 430++6E29 ED 5B F4 5C  	ld de,(#5cf4)
 431++6E2D 0E 06            ld      c,6 ;  
 432++6E2F CD 13 3D         call    #3d13
 433++6E32 79           	ld a,c
 434++6E33              	;pop bc
 435++6E33 FE FF        	cp 255
 436++6E35 CA 88 6D     	jp z,fwrite_no_chek ;  
 437++6E38              	; ld de,(f_w_cur_trk)
 438++6E38              	; call calc_next_pos
 439++6E38              	; ld (f_w_cur_trk),de
 440++6E38
 441++6E38 AF           	xor a
 442++6E39 32 95 71     	ld (write_end_flag),a ;    
 443++6E3C
 444++6E3C              fwrite_trd1
 445++6E3C 3A 95 71     	ld a,(write_end_flag) ;  ?
 446++6E3F B7           	or a
 447++6E40 20 12        	jr nz,fwrite_trd_ex ; 
 448++6E42
 449++6E42 2A 9A 71     	ld hl,(temp_hl2) ;  
 450++6E45 3A 9E 71     	ld a,(sec_part)
 451++6E48 47           	ld b,a
 452++6E49 0E 00        	ld c,0
 453++6E4B 09           	add hl,bc
 454++6E4C 11 00 51     	ld de,sec_buf
 455++6E4F 01 00 01     	ld bc,256
 456++6E52 ED B0        	ldir
 457++6E54              ;fwrite_trd2
 458++6E54
 459++6E54
 460++6E54              fwrite_trd_ex
 461++6E54 ED 4B 96 71  	ld bc,(temp_bc) ;,   ,    
 462++6E58              	;   
 463++6E58 2A 91 71     	ld hl,(f_w_len)
 464++6E5B 09           	add hl,bc
 465++6E5C 22 91 71     	ld (f_w_len),hl
 466++6E5F 30 07        	jr nc,fwrite_trd_ex1
 467++6E61 2A 93 71     	ld hl,(f_w_len+2)
 468++6E64 23           	inc hl
 469++6E65 22 93 71     	ld (f_w_len+2),hl
 470++6E68
 471++6E68              fwrite_trd_ex1
 472++6E68 AF           	xor a ; 
 473++6E69 C9               ret
 474++6E6A
 475++6E6A
 476++6E6A
 477++6E6A
 478++6E6A
 479++6E6A              ;------------------scl----------------------
 480++6E6A              fwrite_chek_scl ; scl  ( )
 481++6E6A              	; ld a,2
 482++6E6A              	; out (254),a
 483++6E6A              ; WAITKEY_t	XOR A:IN A,(#FE):CPL:AND #1F:JR Z,WAITKEY_t
 484++6E6A              	; xor a
 485++6E6A              	; out (254),a
 486++6E6A 3A 90 71     	ld a,(f_w_flag)
 487++6E6D B7           	or a
 488++6E6E CA 88 6D     	jp z,fwrite_no_chek ;  ?
 489++6E71 ED 43 96 71  	ld (temp_bc),bc ;
 490++6E75 22 98 71     	ld (temp_hl),hl ; 
 491++6E78 78           	ld a,b
 492++6E79 B1           	or c
 493++6E7A CA 88 6D     	jp z,fwrite_no_chek ;   0,  
 494++6E7D
 495++6E7D              	; ld a,b
 496++6E7D              	; or a
 497++6E7D              	; jr nz,testt1
 498++6E7D              	; nop
 499++6E7D
 500++6E7D              ; testt1
 501++6E7D
 502++6E7D AF           	xor a
 503++6E7E 32 9E 71     	ld (sec_part),a ; 
 504++6E81 32 9D 71     	ld (sec_shift2),a
 505++6E84 32 9E 71     	ld (sec_shift2+1),a
 506++6E87 32 9F 71     	ld (sec_shift_flag),a
 507++6E8A 32 95 71     	ld (write_end_flag),a ;
 508++6E8D
 509++6E8D
 510++6E8D 3A 9C 71     	ld a,(sec_shift)
 511++6E90 B7           	or a
 512++6E91 28 38        	jr z,fwrite_scl3 ;  ,    
 513++6E93
 514++6E93
 515++6E93 4F           	ld c,a
 516++6E94 06 00        	ld b,0
 517++6E96 2A 96 71     	ld hl,(temp_bc) ;    
 518++6E99 09           	add hl,bc
 519++6E9A
 520++6E9A 3E 01        	ld a,1
 521++6E9C 32 95 71     	ld (write_end_flag),a ;     
 522++6E9F
 523++6E9F 7C           	ld a,h
 524++6EA0 B7           	or a
 525++6EA1 20 05        	jr nz,fwrite_scl4
 526++6EA3 3E 01        	ld a,1
 527++6EA5 32 9F 71     	ld (sec_shift_flag),a ;    
 528++6EA8
 529++6EA8              fwrite_scl4
 530++6EA8 21 00 51     	ld hl,sec_buf ;  
 531++6EAB 09           	add hl,bc ;   
 532++6EAC EB           	ex de,hl
 533++6EAD 2A 98 71     	ld hl,(temp_hl) ;     
 534++6EB0              	; ld a,c
 535++6EB0              	; or a
 536++6EB0              	; jr nz,fwrite_scl2
 537++6EB0              	; inc b ;
 538++6EB0              ; fwrite_scl2
 539++6EB0              	; ld c,a
 540++6EB0 AF           	xor a
 541++6EB1 91           	sub c
 542++6EB2 4F           	ld c,a ;     
 543++6EB3 ED 43 9D 71  	ld (sec_shift2),bc ;   
 544++6EB7 ED B0        	ldir
 545++6EB9
 546++6EB9 3A 9F 71     	ld a,(sec_shift_flag)
 547++6EBC B7           	or a
 548++6EBD 20 0C        	jr nz,fwrite_scl3 ;       
 549++6EBF
 550++6EBF 21 00 51     	ld hl,sec_buf
 551++6EC2              	;ld de,(#5cf4)
 552++6EC2              	;ld (f_w_cur_trk),de	; 
 553++6EC2 06 01            ld      b,#01 ; 1   
 554++6EC4 CD 2F 6F         call    scl_write_buf
 555++6EC7              	; ld a,c
 556++6EC7              	; cp 255
 557++6EC7              	; jp z,fwrite_no_chek ;  
 558++6EC7
 559++6EC7 AF           	xor a
 560++6EC8 32 95 71     	ld (write_end_flag),a ;    
 561++6ECB              	; ld de,(f_w_cur_trk) ;    ,    
 562++6ECB              	; ld (#5cf4),de
 563++6ECB              	; ld b,1 ;  
 564++6ECB              	; ld de,(f_w_cur_trk)
 565++6ECB              	; call calc_next_pos
 566++6ECB              	; ld (f_w_cur_trk),de
 567++6ECB
 568++6ECB              fwrite_scl3
 569++6ECB 2A 98 71     	ld hl,(temp_hl) ;  
 570++6ECE              	;ld a,(sec_shift)
 571++6ECE              	;ld c,a
 572++6ECE              	;ld b,0
 573++6ECE ED 4B 9D 71  	ld bc,(sec_shift2)
 574++6ED2 09           	add hl,bc ;   
 575++6ED3 22 9A 71     	ld (temp_hl2),hl ;    
 576++6ED6
 577++6ED6 2A 96 71     	ld hl,(temp_bc) ;      
 578++6ED9 A7           	and a
 579++6EDA ED 42        	sbc hl,bc ; ,     
 580++6EDC 4D           	ld c,l
 581++6EDD 44           	ld b,h
 582++6EDE 30 02        	jr nc,fwrite_scl5
 583++6EE0 06 00        	ld b,0 ;   
 584++6EE2              fwrite_scl5
 585++6EE2 2A 98 71     	ld hl,(temp_hl)
 586++6EE5 09           	add hl,bc
 587++6EE6
 588++6EE6 11 E2 97     	ld de,outputBuffer
 589++6EE9 A7           	and a
 590++6EEA ED 52        	sbc hl,de
 591++6EEC
 592++6EEC 7D           	ld a,l
 593++6EED 32 9C 71     	ld (sec_shift),a ;   
 594++6EF0              	;ld hl,(temp_hl)
 595++6EF0
 596++6EF0
 597++6EF0              	; or a
 598++6EF0              	; jr z,fwrite_scl1
 599++6EF0              	; inc b  ;  
 600++6EF0
 601++6EF0 78           	ld a,b ;    !!!
 602++6EF1 32 9E 71     	ld (sec_part),a ;     
 603++6EF4
 604++6EF4              	;ld a,b
 605++6EF4 B7           	or a
 606++6EF5 28 0A        	jr z,fwrite_scl1 ;    ,   
 607++6EF7
 608++6EF7 2A 9A 71     	ld hl,(temp_hl2)
 609++6EFA              	;push bc
 610++6EFA              	;ld de,(#5cf4)
 611++6EFA                  ;ld      c,6 ;  
 612++6EFA CD 2F 6F         call    scl_write_buf
 613++6EFD              	;ld a,c
 614++6EFD              	;pop bc
 615++6EFD              	; cp 255
 616++6EFD              	; jp z,fwrite_no_chek ;  
 617++6EFD              	; ld de,(f_w_cur_trk)
 618++6EFD              	; call calc_next_pos
 619++6EFD              	; ld (f_w_cur_trk),de
 620++6EFD
 621++6EFD AF           	xor a
 622++6EFE 32 95 71     	ld (write_end_flag),a ;    
 623++6F01
 624++6F01              fwrite_scl1
 625++6F01 3A 95 71     	ld a,(write_end_flag) ;  ?
 626++6F04 B7           	or a
 627++6F05 20 12        	jr nz,fwrite_scl_ex ; 
 628++6F07
 629++6F07 2A 9A 71     	ld hl,(temp_hl2) ;  
 630++6F0A 3A 9E 71     	ld a,(sec_part)
 631++6F0D 47           	ld b,a
 632++6F0E 0E 00        	ld c,0
 633++6F10 09           	add hl,bc
 634++6F11 11 00 51     	ld de,sec_buf
 635++6F14 01 00 01     	ld bc,256
 636++6F17 ED B0        	ldir
 637++6F19              ;fwrite_scl2
 638++6F19
 639++6F19
 640++6F19              fwrite_scl_ex
 641++6F19 ED 4B 96 71  	ld bc,(temp_bc) ;,   ,    
 642++6F1D              	;   
 643++6F1D 2A 91 71     	ld hl,(f_w_len)
 644++6F20 09           	add hl,bc
 645++6F21 22 91 71     	ld (f_w_len),hl
 646++6F24 30 07        	jr nc,fwrite_scl_ex1
 647++6F26 2A 93 71     	ld hl,(f_w_len+2)
 648++6F29 23           	inc hl
 649++6F2A 22 93 71     	ld (f_w_len+2),hl
 650++6F2D
 651++6F2D              fwrite_scl_ex1
 652++6F2D AF           	xor a ; 
 653++6F2E C9               ret
 654++6F2F
 655++6F2F
 656++6F2F
 657++6F2F
 658++6F2F
 659++6F2F
 660++6F2F              scl_write_buf ;  
 661++6F2F C5           	push bc ;    b
 662++6F30 11 00 53     	ld de,scl_buf ;    
 663++6F33 01 00 01     	ld bc,256
 664++6F36 ED B0        	ldir
 665++6F38 22 C0 71     	ld (scl_temp_hl2),hl ;  
 666++6F3B 3A A8 71     	ld a,(scl_que) ;    
 667++6F3E B7           	or a
 668++6F3F 28 08        	jr z,scl_write_buf_ret ;      
 669++6F41 21 49 6F     	ld hl,scl_write_buf_ret ; 
 670++6F44 E5           	push hl
 671++6F45 2A BA 71     	ld hl,(scl_parse_ret_adr) ;     
 672++6F48 E9           	jp (hl) ;  256  
 673++6F49              scl_write_buf_ret
 674++6F49 2A C0 71     	ld hl,(scl_temp_hl2)
 675++6F4C C1           	pop bc
 676++6F4D 10 E0        	djnz scl_write_buf
 677++6F4F
 678++6F4F C9           	ret
 679++6F50
 680++6F50
 681++6F50
 682++6F50              scl_parse ;  scl  trd,  
 683++6F50              	;  
 684++6F50              ;    256 
 685++6F50 22 BE 71     	ld (scl_temp_hl),hl
 686++6F53 ED 53 C2 71  	ld (scl_temp_de),de
 687++6F57 ED 43 C4 71  	ld (scl_temp_bc),bc
 688++6F5B 3E 01        	ld a,1
 689++6F5D 32 A8 71     	ld (scl_que),a ;    
 690++6F60 21 67 6F     	ld hl,scl_parse_ret ;  
 691++6F63 22 BA 71     	ld (scl_parse_ret_adr),hl
 692++6F66 C9           	ret ;   
 693++6F67              scl_parse_ret
 694++6F67 AF           	xor a
 695++6F68 32 A8 71     	ld (scl_que),a
 696++6F6B 2A BE 71     	ld hl,(scl_temp_hl)
 697++6F6E ED 5B C2 71  	ld de,(scl_temp_de)
 698++6F72 ED 4B C4 71  	ld bc,(scl_temp_bc)
 699++6F76
 700++6F76 11 00 53     	ld de,scl_buf ;  
 701++6F79 21 A0 71     	ld hl,scl_sign
 702++6F7C 06 08        	ld b,8
 703++6F7E              scl_parse_chk
 704++6F7E 1A           	ld a,(de)
 705++6F7F BE           	cp (hl)
 706++6F80 20 06        	jr nz,scl_parse_chk_no
 707++6F82 23           	inc hl
 708++6F83 13           	inc de
 709++6F84 10 F8        	djnz scl_parse_chk
 710++6F86 18 10        	jr scl_parse_chk_ok
 711++6F88              scl_parse_chk_no ;  ,   
 712++6F88 21 A9 71         ld hl, scl_err
 713++6F8B CD BE 69         call DialogBox.msgBox ;
 714++6F8E AF           	xor a
 715++6F8F 32 A8 71     	ld (scl_que),a ;    
 716++6F92 3E 04        	ld a,4 ; 
 717++6F94 CD 44 6D     	call fclose
 718++6F97 C9           	ret
 719++6F98              scl_parse_chk_ok ; 
 720++6F98
 721++6F98              ; 
 722++6F98 3A 08 53     	ld a,(scl_buf+8)
 723++6F9B 32 BD 71     	ld (scl_files),a ; 
 724++6F9E 32 BC 71     	ld (scl_cat_cycl),a ;
 725++6FA1 21 09 53     	ld hl,scl_buf+9 ;  
 726++6FA4 11 00 48     	ld de,cat_buf ;   trd
 727++6FA7              scl_parse_cat2
 728++6FA7 06 0E        	ld b,14 ;14   
 729++6FA9              scl_parse_cat
 730++6FA9 7E           	ld a,(hl)
 731++6FAA 12           	ld (de),a
 732++6FAB 13           	inc de
 733++6FAC 2C           	inc l ;      
 734++6FAD 20 26        	jr nz,scl_parse_cat1
 735++6FAF              	;    
 736++6FAF              ;    256 
 737++6FAF 22 BE 71     	ld (scl_temp_hl),hl
 738++6FB2 ED 53 C2 71  	ld (scl_temp_de),de
 739++6FB6 ED 43 C4 71  	ld (scl_temp_bc),bc
 740++6FBA 3E 01        	ld a,1
 741++6FBC 32 A8 71     	ld (scl_que),a ;    
 742++6FBF 21 C6 6F     	ld hl,scl_parse_ret1 ;  
 743++6FC2 22 BA 71     	ld (scl_parse_ret_adr),hl
 744++6FC5 C9           	ret ;   
 745++6FC6              scl_parse_ret1
 746++6FC6 AF           	xor a
 747++6FC7 32 A8 71     	ld (scl_que),a
 748++6FCA 2A BE 71     	ld hl,(scl_temp_hl)
 749++6FCD ED 5B C2 71  	ld de,(scl_temp_de)
 750++6FD1 ED 4B C4 71  	ld bc,(scl_temp_bc)
 751++6FD5
 752++6FD5              scl_parse_cat1
 753++6FD5 10 D2        	djnz scl_parse_cat
 754++6FD7 13           	inc de
 755++6FD8 13           	inc de
 756++6FD9 3A BC 71     	ld a,(scl_cat_cycl)
 757++6FDC 3D           	dec a
 758++6FDD 32 BC 71     	ld (scl_cat_cycl),a
 759++6FE0 20 C5        	jr nz,scl_parse_cat2
 760++6FE2
 761++6FE2 22 BE 71     	ld (scl_temp_hl),hl ;  
 762++6FE5
 763++6FE5              ;   
 764++6FE5 DD E5        	push ix
 765++6FE7 3A BD 71     	ld a,(scl_files)
 766++6FEA 11 00 01     	ld de,#0100 ;   
 767++6FED DD 21 00 48  	ld ix,cat_buf
 768++6FF1 DD 73 0E     	ld (ix+14),e
 769++6FF4 DD 72 0F     	ld (ix+15),d
 770++6FF7 21 00 00     	ld hl,0 ;  
 771++6FFA              scl_cacl
 772++6FFA 32 BC 71     	ld (scl_cat_cycl),a ;
 773++6FFD DD 7E 0D     	ld a,(ix+13) ;   
 774++7000 4F           	ld c,a
 775++7001 06 00        	ld b,0
 776++7003 09           	add hl,bc ;
 777++7004
 778++7004 01 10 00     	ld bc,16
 779++7007 DD 09        	add ix,bc
 780++7009 47           	ld b,a
 781++700A CD 2F 71     	call calc_next_pos
 782++700D 3A BC 71     	ld a,(scl_cat_cycl)
 783++7010 FE 01        	cp 1
 784++7012 28 06        	jr z,scl_cacl2 ;   
 785++7014 DD 73 0E     	ld (ix+14),e
 786++7017 DD 72 0F     	ld (ix+15),d
 787++701A              scl_cacl2
 788++701A 3D           	dec a
 789++701B 20 DD        	jr nz,scl_cacl
 790++701D              	;    
 791++701D DD 7E 0D     	ld a,(ix+13) ;   
 792++7020 4F           	ld c,a
 793++7021 06 00        	ld b,0
 794++7023 09           	add hl,bc
 795++7024              	; ld b,a
 796++7024              	; call calc_next_pos
 797++7024 ED 53 E1 50  	ld (cat_buf+8*256+#e1),de ;      
 798++7028 11 F0 09     	ld de,16*159
 799++702B EB           	ex de,hl
 800++702C A7           	and a
 801++702D ED 52        	sbc hl,de
 802++702F 22 E5 50     	ld (cat_buf+8*256+#e5),hl ;    
 803++7032 DD E1        	pop ix
 804++7034
 805++7034
 806++7034
 807++7034              ;  
 808++7034 3A BD 71     	ld a,(scl_files) ; 
 809++7037 32 BC 71     	ld (scl_cat_cycl),a ;
 810++703A 21 0D 48     	ld hl,cat_buf+13 ;   
 811++703D 22 C6 71     	ld (cat_cur_adr),hl
 812++7040
 813++7040 21 00 01     	ld hl,#0100 ;   
 814++7043 22 F4 5C     	ld (#5cf4),hl
 815++7046              scl_parse_file2
 816++7046 2A BE 71     	ld hl,(scl_temp_hl) ; 
 817++7049 ED 5B C6 71  	ld de,(cat_cur_adr) ;   
 818++704D              	;dec de
 819++704D 1A           	ld a,(de) ; , 
 820++704E 4F           	ld c,a
 821++704F              scl_parse_file3
 822++704F 11 00 55     	ld de,scl_buf2 ;   
 823++7052 06 00        	ld b,0 ;256   , 
 824++7054              scl_parse_file
 825++7054 7E           	ld a,(hl)
 826++7055 12           	ld (de),a
 827++7056 13           	inc de
 828++7057 2C           	inc l ;      
 829++7058 20 26        	jr nz,scl_parse_file1
 830++705A              	;    
 831++705A              ;    256 
 832++705A 22 BE 71     	ld (scl_temp_hl),hl
 833++705D ED 53 C2 71  	ld (scl_temp_de),de
 834++7061 ED 43 C4 71  	ld (scl_temp_bc),bc
 835++7065 3E 01        	ld a,1
 836++7067 32 A8 71     	ld (scl_que),a ;    
 837++706A 21 71 70     	ld hl,scl_parse_ret2 ;  
 838++706D 22 BA 71     	ld (scl_parse_ret_adr),hl
 839++7070 C9           	ret ;   
 840++7071              scl_parse_ret2
 841++7071 AF           	xor a
 842++7072 32 A8 71     	ld (scl_que),a
 843++7075 2A BE 71     	ld hl,(scl_temp_hl)
 844++7078 ED 5B C2 71  	ld de,(scl_temp_de)
 845++707C ED 4B C4 71  	ld bc,(scl_temp_bc)
 846++7080
 847++7080              scl_parse_file1
 848++7080 10 D2        	djnz scl_parse_file
 849++7082 22 BE 71     	ld (scl_temp_hl),hl
 850++7085 ED 43 C4 71  	ld (scl_temp_bc),bc
 851++7089
 852++7089 21 00 55     	ld hl,scl_buf2 ;;  
 853++708C ED 5B F4 5C  	ld  de,(#5cf4)
 854++7090 01 06 01         ld      bc,#0106 ;
 855++7093 CD 13 3D         call    #3d13
 856++7096              	; ld a,c
 857++7096              	; cp 255
 858++7096              	; jp z,fwrite_no_chek ;  
 859++7096 2A BE 71     	ld hl,(scl_temp_hl)
 860++7099 ED 4B C4 71  	ld bc,(scl_temp_bc)
 861++709D
 862++709D 0D           	dec c
 863++709E 20 AF        	jr nz,scl_parse_file3
 864++70A0
 865++70A0 2A C6 71     	ld hl,(cat_cur_adr) ;   
 866++70A3              	; ld e,(hl)
 867++70A3              	; inc hl
 868++70A3              	; ld d,(hl)
 869++70A3 01 10 00     	ld bc,16
 870++70A6 09           	add hl,bc ;  
 871++70A7 22 C6 71     	ld (cat_cur_adr),hl
 872++70AA
 873++70AA
 874++70AA 3A BC 71     	ld a,(scl_cat_cycl)
 875++70AD 3D           	dec a
 876++70AE 32 BC 71     	ld (scl_cat_cycl),a
 877++70B1 20 93        	jr nz,scl_parse_file2	;  
 878++70B3
 879++70B3
 880++70B3
 881++70B3              ;   9 (8)
 882++70B3              	;
 883++70B3              	;ld (cat_buf+8*256+#e1),a ;// #E1     
 884++70B3              	;
 885++70B3              	;ld (cat_buf+8*256+#e2),a ;// #E2   
 886++70B3 3E 16        	ld a,#16
 887++70B5 32 E3 50     	ld (cat_buf+8*256+#e3),a ;// #E3 16 80 , 2 
 888++70B8 3A BD 71     	ld a,(scl_files)
 889++70BB 32 E4 50     	ld (cat_buf+8*256+#e4),a ;// #E4      
 890++70BE              	;
 891++70BE              	;ld (cat_buf+8*256+#e5),a ;// #5,6     
 892++70BE              	;ld (cat_buf+8*256+#e6),a
 893++70BE 3E 10        	ld a,#10
 894++70C0 32 E7 50     	ld (cat_buf+8*256+#e7),a ;// #E7   #10,   TR-DOS
 895++70C3
 896++70C3 21 7E 71     	ld hl,f_name ;  ,     
 897++70C6 11 F5 50     	ld de,cat_buf+8*256+#f5 ;// #F5-#FC    ASCII 
 898++70C9 01 08 00     	ld bc,8
 899++70CC ED B0        	ldir
 900++70CE
 901++70CE 21 00 48     	ld hl,cat_buf ;   
 902++70D1 11 00 00     	ld de,0
 903++70D4 01 06 09         ld      bc,#0906 ;
 904++70D7 CD 13 3D         call    #3d13
 905++70DA              	; ld a,c
 906++70DA              	; cp 255
 907++70DA              	; jp z,fwrite_no_chek ;  
 908++70DA C9           	ret
 909++70DB
 910++70DB
 911++70DB              ;-----------scl end --------------------
 912++70DB
 913++70DB
 914++70DB
 915++70DB
 916++70DB
 917++70DB
 918++70DB
 919++70DB
 920++70DB
 921++70DB
 922++70DB              ; A - file stream id
 923++70DB              ; fsync:
 924++70DB              ;     esxCall ESX_FSYNC
 925++70DB                  ; ret
 926++70DB
 927++70DB
 928++70DB              ; HL - name (name.ext)
 929++70DB              ; Returns:
 930++70DB              ; HL - name (name    e)
 931++70DB              format_name ;     trdos (8+1)
 932++70DB
 933++70DB              	;     ,   
 934++70DB 22 98 71     	ld (temp_hl),hl ;   
 935++70DE 06 00        	ld b,#00 ;  255 
 936++70E0              format_name5
 937++70E0 7E           	ld a,(hl)
 938++70E1 FE 2F        	cp "/" ;  
 939++70E3 28 0D        	jr z,format_name_path_yep
 940++70E5 7E           	ld a,(hl)
 941++70E6 FE 2E        	cp "." ;     
 942++70E8 20 05        	jr nz,format_name6
 943++70EA 2A 98 71     	ld hl,(temp_hl) ;   ,   ,    
 944++70ED 18 04        	jr format_name_7 ; 
 945++70EF              format_name6
 946++70EF 23           	inc hl
 947++70F0 10 EE        	djnz format_name5
 948++70F2
 949++70F2              format_name_path_yep ;
 950++70F2 23           	inc hl ;  "/"
 951++70F3
 952++70F3              format_name_7
 953++70F3
 954++70F3
 955++70F3 E5           	push hl ;    
 956++70F4 21 7E 71     	ld hl,f_name
 957++70F7 11 7F 71     	ld de,f_name+1
 958++70FA 36 20        	ld (hl)," "
 959++70FC 01 08 00     	ld bc,8
 960++70FF ED B0        	ldir
 961++7101 E1           	pop hl
 962++7102
 963++7102 01 FF 09     	ld bc,#09ff ;  9 
 964++7105 11 7E 71     	ld de,f_name ;
 965++7108              format_name2
 966++7108 7E           	ld a,(hl)
 967++7109 FE 2E        	cp "."
 968++710B 20 08        	jr nz,format_name1
 969++710D 23           	inc hl
 970++710E 7E           	ld a,(hl)
 971++710F 32 86 71     	ld (f_name+8),a ;      
 972++7112 EB           	ex de,hl ;   
 973++7113 18 16        	jr format_name_e
 974++7115              format_name1
 975++7115 ED A0        	ldi
 976++7117 10 EF        	djnz format_name2
 977++7119
 978++7119              	;  ,    
 979++7119 06 00        	ld b,#00 ;  255 
 980++711B              format_name3
 981++711B 7E           	ld a,(hl)
 982++711C FE 2E        	cp "."
 983++711E 20 08        	jr nz,format_name4
 984++7120 23           	inc hl
 985++7121 7E           	ld a,(hl)
 986++7122 32 86 71     	ld (f_name+8),a ;      
 987++7125 EB           	ex de,hl ;   
 988++7126 18 03        	jr format_name_e
 989++7128              format_name4
 990++7128 23           	inc hl
 991++7129 10 F0        	djnz format_name3
 992++712B
 993++712B              format_name_e ;
 994++712B 21 7E 71     	ld hl,f_name ; 
 995++712E C9           	ret
 996++712F
 997++712F              ; DE - trk/sec
 998++712F              ; B - sectors step
 999++712F              ; Returns:
1000++712F              ; DE - trk/sec
1001++712F              calc_next_pos		;  N 
1002++712F              			;ld b,4
1003++712F              			;ld  de,(#5ceb)
1004++712F              calc_next_pos2
1005++712F 1C           			inc e
1006++7130 7B           			ld a,e
1007++7131 FE 10        			cp 16
1008++7133 38 03        			jr c,calc_next_pos1
1009++7135 14           			inc d
1010++7136 1E 00        			ld e,0
1011++7138              calc_next_pos1
1012++7138              			;ld (#5ceb),de
1013++7138 10 F5        			djnz calc_next_pos2
1014++713A C9           			ret
1015++713B
1016++713B
1017++713B              ;testt db "123.trd"
1018++713B 49 6E 73 65  write_ima db "Insert disk to drive "
1018++713F 72 74 20 64
1018++7143 69 73 6B 20
1018++7147 74 6F 20 64
1018++714B 72 69 76 65
1018++714F 20
1019++7150 41 2E 20     write_ima_d db "A. "
1020++7153 41 6C 6C 20  		db "All data will be lost!",0
1020++7157 64 61 74 61
1020++715B 20 77 69 6C
1020++715F 6C 20 62 65
1020++7163 20 6C 6F 73
1020++7167 74 21 00
1021++716A
1022++716A 2E 74 72 64  trdExt1 db ".trd", 0
1022++716E 00
1023++716F 2E 54 52 44  trdExt2 db ".TRD", 0
1023++7173 00
1024++7174
1025++7174 2E 73 63 6C  sclExt1 db ".scl", 0
1025++7178 00
1026++7179 2E 53 43 4C  sclExt2 db ".SCL", 0
1026++717D 00
1027++717E
1028++717E 00 00 00...  f_name ds 9 ; 
1029++7187 00 00        f_r_cur_trk dw 	 0 ; -   
1030++7189 00           f_r_len_sec db 0 ;     
1031++718A 00 00        f_r_len dw 0;   
1032++718C 00           f_r_flag db 0 ;     
1033++718D
1034++718D 00 00        f_w_cur_trk dw 	 0 ; -   
1035++718F 00           f_w_len_sec db 0 ;     
1036++7190 00           f_w_flag db 0 ;     
1037++7191 00 00 00 00  f_w_len ds 4 ;  
1038++7195 00           write_end_flag db 0 ;    
1039++7196
1040++7196 00 00        temp_bc dw 0 ; 
1041++7198 00 00        temp_hl dw 0 ; 
1042++719A 00 00        temp_hl2 dw 0 ; 
1043++719C
1044++719C 00           sec_shift db 0 ;     
1045++719D 00           sec_shift2 db 0 ;      ()
1046++719E 00           sec_part db 0 ;      
1047++719F 00           sec_shift_flag db 0 ;     
1048++71A0
1049++71A0              ; scl
1050++71A0 53 49 4E 43  scl_sign db "SINCLAIR" ;
1050++71A4 4C 41 49 52
1051++71A8 00           scl_que db 0 ;   
1052++71A9 53 43 4C 20  scl_err db "SCL image error!",0
1052++71AD 69 6D 61 67
1052++71B1 65 20 65 72
1052++71B5 72 6F 72 21
1052++71B9 00
1053++71BA 00 00        scl_parse_ret_adr dw 0;    
1054++71BC 00           scl_cat_cycl db 0 ; 
1055++71BD 00           scl_files db 0 ; 
1056++71BE 00 00        scl_temp_hl dw 0;; 
1057++71C0 00 00        scl_temp_hl2 dw 0;
1058++71C2 00 00        scl_temp_de dw 0;
1059++71C4 00 00        scl_temp_bc dw 0;
1060++71C6 00 00        cat_cur_adr dw 0;
1061++71C8              ;scl end
1062++71C8 00 00 00...  	align 256 ;
1063++7200              	;  #4000 
1064++7200              cat_buf equ #4800 ;    9*256
1065++7200              sec_buf equ cat_buf + 9*256 ;    256
1066++7200              scl_buf equ sec_buf + 512 ;  256
1067++7200              scl_buf2 equ scl_buf + 512 ;  256
1068++7200
1069++7200                  ENDMODULE
# file closed: dos/trdos.asm
   9++7200              	ENDIF
  10++7200
  11++7200              	IFDEF ESXDOS
  12++7200 ~               		include "console.asm"
  13++7200 ~               		include "esxdos.asm"
  14++7200              	ENDIF
  15++7200
  16++7200              	IFDEF P3DOS
  17++7200 ~               		include "console.asm"
  18++7200 ~               		include "p3dos.asm"
  19++7200              	ENDIF
  20++7200
# file closed: dos/index.asm
  19+ 7200                  include "gopher/engine/history/index.asm"
# file opened: gopher/engine/history/index.asm
   1++7200                  include "controler.asm"
# file opened: gopher/engine/history/controler.asm
   1++7200                  module History
   2++7200              back:
   3++7200 3A 43 73         ld a, (depth)
   3++7203 FE 01          cp 1
   3++7205 CA 17 72       jp z, load
   4++7208 21 92 75 11      ld hl, historyBlock + HistoryRecord, de, historyBlock, bc, (total - 1) * HistoryRecord
   4++720C 44 73 01 38
   4++7210 09
   4++7211 ED B0          ldir ; Move history up
   5++7213 21 43 73         ld hl, depth
   5++7216 35             dec (hl)
   6++7217              ; Loads current resource
   7++7217              load:
   8++7217 21 34 72         ld hl, .msg
   8++721A CD C7 69       call DialogBox.msgNoWait
   9++721D AF               xor a
   9++721E 21 E2 97 11    ld hl, outputBuffer, de, outputBuffer + 1
   9++7222 E3 97
  10++7224              	IFDEF MSX
  11++7224 ~                	ld bc, (ramtop)
  12++7224 ~                	dec bc
  13++7224              	ELSE
  14++7224 01 1C 68         	ld bc, #ffff - outputBuffer - 1
  15++7227              	ENDIF
  16++7227
  17++7227 77               ld (hl), a
  18++7228 ED B0            ldir
  19++722A
  20++722A 3A 44 73         ld a, (historyBlock.isFile)
  20++722D A7             and a
  20++722E C2 2D 83       jp nz, Fetcher.fetchFromFS
  21++7231 C3 E0 82         jp Fetcher.fetchFromNet
  22++7234
  23++7234 20 20 20 20  .msg db "    Loading resource! Please wait! It will be here soon!", 0
  23++7238 4C 6F 61 64
  23++723C 69 6E 67 20
  23++7240 72 65 73 6F
  23++7244 75 72 63 65
  23++7248 21 20 50 6C
  23++724C 65 61 73 65
  23++7250 20 77 61 69
  23++7254 74 21 20 49
  23++7258 74 20 77 69
  23++725C 6C 6C 20 62
  23++7260 65 20 68 65
  23++7264 72 65 20 73
  23++7268 6F 6F 6E 21
  23++726C 00
  24++726D
  25++726D              home:
  26++726D 21 21 73         ld hl, homePage
  27++7270              ; HL - gopher row
  28++7270              navigate:
  29++7270 54 5D            ld de, hl
  30++7272 CD 59 81         call UrlEncoder.isValidGopherRow
  31++7275 30 A0            jr nc, load ; Not valid - reload last
  32++7277 62 6B            ld hl, de
  33++7279 E5               push hl
  34++727A
  35++727A E5               push hl
  36++727B 21 C9 7E 11      ld hl, HistoryEnd - HistoryRecord, de, HistoryEnd, bc,  HistoryRecord * total
  36++727F 17 81 01 86
  36++7283 0B
  36++7284 ED B8          lddr
  37++7286
  38++7286 ED 5B 8A 75      ld de, (Render.position), (historyBlock.position + HistoryRecord), de
  38++728A ED 53 D8 77
  39++728E                  ; Clean up struct
  40++728E AF               xor a
  40++728F 21 44 73 11    ld hl, historyBlock, de, historyBlock + 1, bc, historyBlockSize - 1, (hl), a
  40++7293 45 73 01 4D
  40++7297 02 77
  40++7299 ED B0          ldir
  41++729B E1               pop hl
  42++729C
  43++729C                  ; Fill record
  44++729C 54 5D            ld de, hl
  45++729E CD 18 81         call UrlEncoder.isFile
  46++72A1 EB               ex hl, de
  47++72A2 11 44 73         ld de, historyBlock
  48++72A5 12               ld (de), a
  48++72A6 13             inc de
  49++72A7 7E               ld a, (hl)
  49++72A8 E5 D5          push hl, de
  49++72AA CD 8E 64       call Render.getIcon
  49++72AD D1 E1          pop de, hl
  50++72AF 12               ld (de), a
  50++72B0 13             inc de
  51++72B1 3E 09            ld a, 9
  52++72B3
  53++72B3                  IFDEF MSX
  54++72B3 ~                	ld bc, #ff
  55++72B3                  ELSE
  56++72B3 01 FF 00         	ld bc, #ff
  57++72B6                  ENDIF
  58++72B6
  59++72B6 ED B1            cpir
  60++72B8              .locatorCopy
  61++72B8 7E               ld a, (hl)
  61++72B9 FE 09          cp 9
  61++72BB 28 05          jr z, 1f
  62++72BD 12               ld (de), a
  62++72BE 23 13          inc hl, de
  63++72C0 18 F6            jr .locatorCopy
  64++72C2              1
  65++72C2 23               inc hl
  65++72C3 AF             xor a
  65++72C4 12             ld (de), a
  66++72C5 11 45 74         ld de, historyBlock.host
  67++72C8              .hostCopy
  68++72C8 7E               ld a, (hl)
  68++72C9 FE 09          cp 9
  68++72CB 28 05          jr z, 1f
  69++72CD 12               ld (de), a
  69++72CE 23 13          inc hl, de
  70++72D0 18 F6            jr .hostCopy
  71++72D2              1
  72++72D2 23               inc hl
  72++72D3 AF             xor a
  72++72D4 12             ld (de), a
  73++72D5 11 85 74         ld de, historyBlock.port
  74++72D8              .portCopy
  75++72D8 7E               ld a, (hl)
  76++72D9 FE 09            cp 9
  76++72DB 28 11          jr z, 1f
  77++72DD FE 0D            cp 13
  77++72DF 28 0D          jr z, 1f
  78++72E1 FE 0A            cp 10
  78++72E3 28 09          jr z, 1f
  79++72E5 FE 00            cp 0
  79++72E7 28 05          jr z, 1f
  80++72E9 12               ld (de), a
  80++72EA 23 13          inc hl, de
  81++72EC 18 EA            jr .portCopy
  82++72EE AF           1   xor a
  82++72EF 12             ld (de), a
  83++72F0 21 6E 69 11      ld hl, DialogBox.inputBuffer, de, historyBlock.search, bc, #ff
  83++72F4 8B 74 01 FF
  83++72F8 00
  83++72F9 ED B0          ldir
  84++72FB 11 00 00 ED      ld de, 0, (historyBlock.position), de
  84++72FF 53 8A 75
  85++7302 E1               pop hl
  86++7303 3A 43 73         ld a, (depth)
  86++7306 FE 05          cp total
  86++7308 30 04          jr nc, 1f
  87++730A 3C               inc a
  87++730B 32 43 73       ld (depth), a
  88++730E              1
  89++730E 3A 45 73         ld a,(historyBlock.mediaType)
  89++7311 FE 01          cp MIME_DOWNLOAD
  89++7313 CA C8 83       jp z, Gopher.download
  90++7316
  91++7316                  ifdef GS
  92++7316 ~                ld a,(historyBlock.mediaType)
  93++7316 ~                cp MIME_MOD
  94++7316 ~                jp nz,load
  95++7316 ~                ld a,(GeneralSound.GSdownType)
  96++7316 ~                xor 1
  97++7316 ~                jp z, downMod2file
  98++7316 ~
  99++7316 ~            downMod2GS
 100++7316 ~                jp Gopher.loadMod
 101++7316 ~            downMod2file
 102++7316 ~                jp Gopher.download
 103++7316                  else
 104++7316 3A 45 73         ld a,(historyBlock.mediaType)
 104++7319 FE 07          cp MIME_MOD
 104++731B CA C8 83       jp z, Gopher.download
 105++731E                  endif
 106++731E
 107++731E C3 17 72         jp load
 108++7321
 109++7321              homePage:
 110++7321              	IFDEF MSX
 111++7321 ~                	db "1Home", TAB, "index.gph"
 112++7321 ~                	db TAB, "file", TAB, "70", CR, LF, 0
 113++7321                  ELSE
 114++7321 31 48 6F 6D      	db "1Home", TAB, "browser/index.gph"
 114++7325 65 09 62 72
 114++7329 6F 77 73 65
 114++732D 72 2F 69 6E
 114++7331 64 65 78 2E
 114++7335 67 70 68
 115++7338 09 66 69 6C      	db TAB, "file", TAB, "70", CR, LF, 0
 115++733C 65 09 37 30
 115++7340 0D 0A 00
 116++7343                  ENDIF
 117++7343                  endmodule
# file closed: gopher/engine/history/controler.asm
   2++7343                  include "model.asm"
# file opened: gopher/engine/history/model.asm
   1++7343              total   equ 5
   2++7343 00           depth   db 0
   3++7344
   4++7344              historyBlock:
   5++7344 00           .isFile    db  0
   6++7345 00           .mediaType db  0
   7++7346 00 00 00...  .locator   ds  #ff
   8++7445 00 00 00...  .host      ds  64
   9++7485 00 00 00...  .port      ds  6
  10++748B 00 00 00...  .search    ds  #ff
  11++758A 00 00        .position  dw  #0000    ;position
  12++758C
  13++758C 00 00 00 00      db 0,0,0,0,0,0  ;cursor_position page_offset
  13++7590 00 00
  14++7592
  15++7592              historyBlockSize = $ - historyBlock
  16++7592
  17++7592              HistoryRecord EQU $ - historyBlock
  18++7592                  dup total
  19++7592 00 00 00... >    ds HistoryRecord
  19++77E0 00 00 00... >    ds HistoryRecord
  19++7A2E 00 00 00... >    ds HistoryRecord
  19++7C7C 00 00 00... >    ds HistoryRecord
  19++7ECA 00 00 00... >    ds HistoryRecord
  20++8118                  edup
  21++8118              HistoryEnd equ $ - 1
  22++8118
# file closed: gopher/engine/history/model.asm
# file closed: gopher/engine/history/index.asm
  20+ 8118                  include "gopher/engine/urlencoder.asm"
# file opened: gopher/engine/urlencoder.asm
   1++8118                  MODULE UrlEncoder
   2++8118              ; HL - pointer to line in gopher page
   3++8118              ; C - flag set when it's file
   4++8118              isFile:
   5++8118              .findServerLoop
   6++8118 7E               ld a, (hl)
   6++8119 A7             and a
   6++811A 28 3B          jr z, .notFile
   6++811C 23             inc hl
   7++811D FE 0D            cp 13
   7++811F 28 36          jr z, .notFile
   8++8121 FE 09            cp 9
   8++8123 28 02          jr z, .skipPath
   9++8125 18 F1            jr .findServerLoop
  10++8127              .skipPath
  11++8127 7E               ld a, (hl)
  11++8128 A7             and a
  11++8129 28 2C          jr z, .notFile
  11++812B 23             inc hl
  12++812C FE 0D            cp 13
  12++812E 28 27          jr z, .notFile
  13++8130 FE 09            cp 9
  13++8132 28 02          jr z, .compareServer
  14++8134 18 F1            jr .skipPath
  15++8136              .compareServer
  16++8136 7E               ld a, (hl)
  16++8137 FE 66          cp "f"
  16++8139 20 1C          jr nz, .notFile
  16++813B 23             inc hl
  17++813C 7E               ld a, (hl)
  17++813D FE 69          cp "i"
  17++813F 20 16          jr nz, .notFile
  17++8141 23             inc hl
  18++8142 7E               ld a, (hl)
  18++8143 FE 6C          cp "l"
  18++8145 20 10          jr nz, .notFile
  18++8147 23             inc hl
  19++8148 7E               ld a, (hl)
  19++8149 FE 65          cp "e"
  19++814B 20 0A          jr nz, .notFile
  19++814D 23             inc hl
  20++814E 7E               ld a, (hl)
  20++814F FE 09          cp 9
  20++8151 20 04          jr nz, .notFile
  20++8153 23             inc hl
  21++8154 3E 01            ld a, 1
  22++8156 C9               ret
  23++8157              .notFile
  24++8157 AF               xor a
  25++8158 C9               ret
  26++8159
  27++8159              ; Is enough fields to encode
  28++8159              ; HL - pointer to line in gopher page
  29++8159              ; C - flag set when there is enough fields
  30++8159              isValidGopherRow:
  31++8159 7E               ld a, (hl)
  31++815A A7             and a
  31++815B 28 FA          jr z, isFile.notFile
  31++815D 23             inc hl
  32++815E FE 0D            cp 13
  32++8160 28 F5          jr z, isFile.notFile
  33++8162 FE 09            cp 9
  33++8164 28 02          jr z, .skipPath
  34++8166 18 F1            jr isValidGopherRow
  35++8168              .skipPath
  36++8168 7E               ld a, (hl)
  36++8169 A7             and a
  36++816A 28 EB          jr z, isFile.notFile
  36++816C 23             inc hl
  37++816D FE 0D            cp 13
  37++816F 28 E6          jr z, isFile.notFile
  38++8171 FE 09            cp 9
  38++8173 28 02          jr z, .skipHost
  39++8175 18 F1            jr .skipPath
  40++8177              .skipHost
  41++8177 7E               ld a, (hl)
  41++8178 A7             and a
  41++8179 28 DC          jr z, isFile.notFile
  41++817B 23             inc hl
  42++817C FE 0D            cp 13
  42++817E 28 D7          jr z, isFile.notFile
  43++8180 FE 09            cp 9
  43++8182 28 02           jr z, .isValid
  44++8184 18 F1            jr .skipHost
  45++8186              .isValid:
  46++8186 37               scf
  47++8187 C9               ret
  48++8188
  49++8188              extractPath:
  50++8188 21 46 73 11      ld hl, historyBlock.locator, de, nameBuffer, bc, #ff
  50++818C A0 81 01 FF
  50++8190 00
  50++8191 ED B0          ldir
  51++8193 C9               ret
  52++8194
  53++8194              extractHostName:
  54++8194 21 45 74 11      ld hl, historyBlock.host, de, hostName, bc, 64
  54++8198 A0 82 01 40
  54++819C 00
  54++819D ED B0          ldir
  55++819F C9               ret
  56++81A0
  57++81A0                  ENDMODULE
  58++81A0
  59++81A0 00 00 00...  nameBuffer ds #ff, 0
  60++829F
  61++829F 00                    db 0
  62++82A0 00 00 00...  hostName ds 64
# file closed: gopher/engine/urlencoder.asm
  21+ 82E0                  include "gopher/engine/fetcher.asm"
# file opened: gopher/engine/fetcher.asm
   1++82E0                  MODULE Fetcher
   2++82E0
   3++82E0              fetchFromNet:
   4++82E0
   5++82E0              	IFDEF MSX
   6++82E0 ~                	call Gopher.makeRequest
   6++82E0 ~              jr nz, .error
   7++82E0                  ELSE
   8++82E0 CD 9D 83         	call Gopher.makeRequest
   8++82E3 38 06          jr c, .error
   9++82E5                  ENDIF
  10++82E5
  11++82E5 CD B5 83         call Gopher.loadBuffer
  12++82E8 C3 39 83         jp MediaProcessor.processResource
  13++82EB              .error
  14++82EB 21 F4 82         ld hl, .err
  14++82EE CD BE 69       call DialogBox.msgBox
  15++82F1 C3 00 72         jp History.back
  16++82F4
  17++82F4 44 6F 63 75  .err db "Document fetch error! Check your connection or hostname!", 0
  17++82F8 6D 65 6E 74
  17++82FC 20 66 65 74
  17++8300 63 68 20 65
  17++8304 72 72 6F 72
  17++8308 21 20 43 68
  17++830C 65 63 6B 20
  17++8310 79 6F 75 72
  17++8314 20 63 6F 6E
  17++8318 6E 65 63 74
  17++831C 69 6F 6E 20
  17++8320 6F 72 20 68
  17++8324 6F 73 74 6E
  17++8328 61 6D 65 21
  17++832C 00
  18++832D
  19++832D
  20++832D              fetchFromFS:
  21++832D CD 88 81         call UrlEncoder.extractPath
  22++8330              loadFile
  23++8330              	IFDEF MSX
  24++8330 ~                ld de, nameBuffer, a, FMODE_NO_WRITE
  25++8330 ~                call Dos.fopen
  26++8330 ~                ld a, b, (.fp), a
  27++8330 ~                ld de, outputBuffer, hl, (ramtop)
  28++8330 ~                call Dos.fread
  29++8330 ~                ld a, (.fp), b, a
  30++8330 ~                call Dos.fclose
  31++8330 ~                jp MediaProcessor.processResource
  32++8330 ~            .fp db 0
  33++8330              	ELSE
  34++8330 21 A0 81         ld hl, nameBuffer
  35++8333 CD 4F 6C         call Dos.loadBuffer
  36++8336 C3 39 83         jp MediaProcessor.processResource
  37++8339              	ENDIF
  38++8339                  ENDMODULE
# file closed: gopher/engine/fetcher.asm
  22+ 8339                  include "gopher/engine/media-processor.asm"
# file opened: gopher/engine/media-processor.asm
   1++8339                  MODULE MediaProcessor
   2++8339              processResource:
   3++8339 CD 94 81         call UrlEncoder.extractHostName
   4++833C 3A 45 73         ld a, (historyBlock.mediaType)
   5++833F FE 05            cp MIME_MUSIC
   5++8341 28 13          jr z, processPT
   6++8343 FE 02            cp MIME_LINK
   6++8345 28 15          jr z, processPage
   7++8347 FE 04            cp MIME_INPUT
   7++8349 28 11          jr z, processPage
   8++834B FE 06            cp MIME_IMAGE
   8++834D CA BD 97       jp z, ScreenViewer.display
   9++8350              	ifdef GS
  10++8350 ~                cp MIME_MOD
  10++8350 ~              jr z, processMOD
  11++8350              	endif
  12++8350              ; Fallback to plain text
  13++8350              processText:
  14++8350 CD 30 68         call Render.renderPlainTextScreen
  15++8353 C3 78 68         jp   Render.plainTextLoop
  16++8356
  17++8356              processPT:
  18++8356 CD 6F 8B         call VortexProcessor.play
  19++8359 C3 00 72         jp History.back
  20++835C
  21++835C                  ifdef GS
  22++835C ~            processMOD:
  23++835C ~                call ModProcessor.play
  24++835C ~                jp History.back
  25++835C              	endif
  26++835C
  27++835C              processPage:
  28++835C 3A 08 69         ld a, (Render.play_next)
  28++835F A7             and a
  28++8360 20 06          jr nz, .playNext
  29++8362 CD 9D 66         call Render.renderGopherScreen
  30++8365 C3 EC 66         jp   Render.workLoop
  31++8368              .playNext
  32++8368 21 8C 75         ld hl, Render.cursor_position
  33++836B 34               inc (hl)
  34++836C CD 9D 66         call Render.renderGopherScreen
  35++836F C3 D6 66         jp Render.checkBorder
  36++8372                  ENDMODULE
# file closed: gopher/engine/media-processor.asm
  23+ 8372                  include "gopher/gopher.asm"
# file opened: gopher/gopher.asm
   1++8372                  module Gopher
   2++8372              ; HL - gopher row
   3++8372              extractRequest:
   4++8372 21 46 73         ld hl, historyBlock.locator
   5++8375 11 BE 84         ld de, requestbuffer
   6++8378              .loop
   7++8378 7E               ld a, (hl)
   8++8379 12               ld (de), a
   9++837A 23               inc hl
  10++837B 13               inc de
  11++837C FE 00            cp 0
  12++837E 28 02            jr z, .search
  13++8380 18 F6            jr .loop
  14++8382              .search
  15++8382 1B               dec de
  16++8383 3A 45 73         ld a, (historyBlock.mediaType)
  17++8386 FE 04            cp MIME_INPUT
  18++8388 20 10            jr nz, .exit
  19++838A 21 8B 74         ld hl, historyBlock.search
  20++838D 3E 09            ld a, TAB
  21++838F 12               ld (de), a
  22++8390 13               inc de
  23++8391              .searchCopy
  24++8391 7E               ld a, (hl)
  25++8392 A7               and a
  25++8393 28 05          jr z, .exit
  26++8395 12               ld (de), a
  27++8396 23               inc hl
  27++8397 13             inc de
  28++8398 18 F7            jr .searchCopy
  29++839A              .exit
  30++839A AF               xor a
  31++839B 12               ld (de), a
  32++839C C9               ret
  33++839D
  34++839D
  35++839D              makeRequest:
  36++839D CD 72 83         call extractRequest
  37++83A0
  38++83A0 21 45 74         ld hl, historyBlock.host
  39++83A3 11 85 74         ld de, historyBlock.port
  40++83A6 CD 6B 88         call Wifi.openTCP
  41++83A9 D8               ret c
  42++83AA
  43++83AA 21 BE 84         ld hl, requestbuffer
  44++83AD CD 5C 89         call Wifi.tcpSendZ
  45++83B0 AF               xor a
  45++83B1 32 36 87       ld (Wifi.closed), a
  46++83B4 C9               ret
  47++83B5
  48++83B5
  49++83B5              loadBuffer:
  50++83B5 21 E2 97         ld hl, outputBuffer
  51++83B8 22 34 87         ld (Wifi.buffer_pointer), hl
  52++83BB              .loop
  53++83BB CD AC 89         call Wifi.getPacket
  54++83BE 3A 36 87         ld a, (Wifi.closed)
  54++83C1 A7             and a
  54++83C2 C0             ret nz
  55++83C3 CD C9 88         call Wifi.continue
  56++83C6 18 F3            jr .loop
  57++83C8
  58++83C8                  ifdef GS
  59++83C8 ~            loadMod:
  60++83C8 ~                xor a
  60++83C8 ~              call GeneralSound.init
  61++83C8 ~                ld hl, .progress
  61++83C8 ~              call DialogBox.msgNoWait
  62++83C8 ~                call makeRequest
  62++83C8 ~              jp c, Fetcher.fetchFromNet.error
  63++83C8 ~                call GeneralSound.loadModule
  64++83C8 ~            .loop
  65++83C8 ~                ld hl, outputBuffer, (Wifi.buffer_pointer), hl
  66++83C8 ~                call Wifi.getPacket
  67++83C8 ~                ld a, (Wifi.closed)
  67++83C8 ~              and a
  67++83C8 ~              jr nz, .exit
  68++83C8 ~                ld hl, outputBuffer, bc, (Wifi.bytes_avail)
  69++83C8 ~            .loadLoop
  70++83C8 ~                ld a, b
  70++83C8 ~              or c
  70++83C8 ~              and a
  70++83C8 ~              jr z, .nextFrame
  71++83C8 ~                ld a, (hl)
  71++83C8 ~              call GeneralSound.sendByte
  72++83C8 ~                dec bc
  73++83C8 ~                inc hl
  74++83C8 ~                jr .loadLoop
  75++83C8 ~            .nextFrame
  76++83C8 ~                call pulsing
  77++83C8 ~                ;call Wifi.continue
  78++83C8 ~                jr .loop
  79++83C8 ~            .exit
  80++83C8 ~                call GeneralSound.finishLoadingModule
  81++83C8 ~                ;jp History.back
  82++83C8 ~            	jp MediaProcessor.processResource
  83++83C8 ~            .progress db "MOD downloading directly to GS!", 0
  84++83C8                  endif
  85++83C8
  86++83C8              download:
  87++83C8 11 46 73         ld de, historyBlock.locator
  88++83CB 62 6B            ld hl, de
  89++83CD              .findFileName
  90++83CD 1A               ld a, (de)
  90++83CE 13             inc de
  91++83CF FE 2F            cp '/'
  91++83D1 20 02          jr nz, .skip
  92++83D3 62 6B            ld hl, de
  93++83D5              .skip
  94++83D5 A7               and a
  94++83D6 20 F5          jr nz, .findFileName
  95++83D8              .copy
  96++83D8                  ;; HL - filename pointer
  97++83D8 11 6E 69         ld de, DialogBox.inputBuffer
  98++83DB              .copyFileName
  99++83DB 7E               ld a, (hl)
  99++83DC A7             and a
  99++83DD 28 05          jr z, .finishCopy
 100++83DF
 101++83DF 12               ld (de), a
 101++83E0 23 13          inc hl, de
 102++83E2 18 F7            jr .copyFileName
 103++83E4              .finishCopy
 104++83E4 12               ld (de), a
 105++83E5 CD 0D 69         call DialogBox.inputBox.noclear
 106++83E8 3A 6E 69         ld a, (DialogBox.namedownload)
 106++83EB A7             and a
 106++83EC CA 00 72       jp z, History.back
 107++83EF
 108++83EF CD 9D 83         call makeRequest
 108++83F2 DA EB 82       jp c, Fetcher.fetchFromNet.error
 109++83F5
 110++83F5 06 0E 21 6E      ld b, Dos.FMODE_CREATE, hl, DialogBox.namedownload
 110++83F9 69
 111++83FA CD 6B 6C         call Dos.fopen
 112++83FD 32 9B 84         ld (.fp), a
 113++8400
 114++8400 21 76 84         ld hl, .progress
 114++8403 CD C7 69       call DialogBox.msgNoWait
 115++8406              .loop
 116++8406 21 E2 97 22      ld hl, outputBuffer, (Wifi.buffer_pointer), hl
 116++840A 34 87
 117++840C CD AC 89         call Wifi.getPacket
 118++840F 3A 36 87         ld a, (Wifi.closed)
 118++8412 A7             and a
 118++8413 20 12          jr nz, .exit
 119++8415
 120++8415 3A 9B 84 21      ld a, (.fp), hl, outputBuffer, bc, (Wifi.bytes_avail)
 120++8419 E2 97 ED 4B
 120++841D 32 87
 121++841F CD 7B 6D         call Dos.fwrite
 122++8422 CD 9E 84         call pulsing
 123++8425 18 DF            jr .loop
 124++8427              .exit
 125++8427 3A 9B 84         ld a, (.fp)
 126++842A CD 44 6D         call Dos.fclose
 127++842D C3 00 72         jp History.back
 128++8430              .error
 129++8430 3A 9B 84         ld a, (.fp)
 130++8433 CD 44 6D         call Dos.fclose
 131++8436 21 3F 84         ld hl, .err
 132++8439 CD BE 69         call DialogBox.msgBox
 133++843C C3 00 72         jp History.back
 134++843F
 135++843F 4F 70 65 72  .err db "Operation failed! Sorry! Check filename or disk space!",0
 135++8443 61 74 69 6F
 135++8447 6E 20 66 61
 135++844B 69 6C 65 64
 135++844F 21 20 53 6F
 135++8453 72 72 79 21
 135++8457 20 43 68 65
 135++845B 63 6B 20 66
 135++845F 69 6C 65 6E
 135++8463 61 6D 65 20
 135++8467 6F 72 20 64
 135++846B 69 73 6B 20
 135++846F 73 70 61 63
 135++8473 65 21 00
 136++8476 44 6F 77 6E  .progress db "Downloading in progress! Wait a bit!", 0
 136++847A 6C 6F 61 64
 136++847E 69 6E 67 20
 136++8482 69 6E 20 70
 136++8486 72 6F 67 72
 136++848A 65 73 73 21
 136++848E 20 57 61 69
 136++8492 74 20 61 20
 136++8496 62 69 74 21
 136++849A 00
 137++849B 00           .fp db 0
 138++849C 00           socket db 0
 139++849D 20           pulsator db " "
 140++849E              pulsing
 141++849E 11 01 0B         ld de, #0B01
 141++84A1 CD 3A 60       call TextMode.gotoXY
 142++84A4 3A 9D 84         ld a, (pulsator)
 143++84A7 FE 2A            cp '*'
 144++84A9 CA B5 84         jp z, printasterix
 145++84AC CD A4 60         call TextMode.putC
 146++84AF 3E 2A            ld a, '*'
 147++84B1 32 9D 84         ld (pulsator),a
 148++84B4 C9               ret
 149++84B5              printasterix
 150++84B5 CD A4 60         call TextMode.putC
 151++84B8 3E 20            ld a, ' '
 152++84BA 32 9D 84         ld (pulsator),a
 153++84BD C9               ret
 154++84BE
 155++84BE 00 00 00...  requestbuffer ds #1ff
 156++86BD                  endmodule
 157++86BD
# file closed: gopher/gopher.asm
  24+ 86BD                  include "drivers/index.asm"
# file opened: drivers/index.asm
   1++86BD                  IFDEF UNO
   2++86BD ~                	include "uart-uno.asm"
   3++86BD                  ENDIF
   4++86BD
   5++86BD                  IFDEF UNOUART
   6++86BD ~                	include "uart-uno.asm"
   7++86BD                  ENDIF
   8++86BD
   9++86BD                  IFDEF MB03
  10++86BD ~                	include "uart-mb03.asm"
  11++86BD                  ENDIF
  12++86BD
  13++86BD                  IFDEF AY
  14++86BD ~                	include "uart-ay.asm"
  15++86BD                  ENDIF
  16++86BD
  17++86BD                  IFDEF ZW
  18++86BD                  	include "uart-zxwifi.asm"
# file opened: drivers/uart-zxwifi.asm
   1++86BD              ; This driver works with 16c550 uart that's support AFE
   2++86BD                  module Uart
   3++86BD              ; Make init shorter and readable:-)
   4++86BD                  macro outp port, value
   5++86BD ~            	ld b, port
   6++86BD ~            	ld c, #EF
   7++86BD ~                ld a, value
   8++86BD ~                out (c), a
   9++86BD                  endm
  10++86BD
  11++86BD              ; Internal port constants
  12++86BD              RBR_THR = #F8
  13++86BD              IER     = RBR_THR + 1
  14++86BD              IIR_FCR = RBR_THR + 2
  15++86BD              LCR     = RBR_THR + 3
  16++86BD              MCR     = RBR_THR + 4
  17++86BD              LSR     = RBR_THR + 5
  18++86BD              MSR     = RBR_THR + 6
  19++86BD              SR      = RBR_THR + 7
  20++86BD
  21++86BD
  22++86BD              init:
  23++86BD                  IFDEF GZ
  24++86BD ~                outp MCR,     #0d  // Assert RTS
  25++86BD ~                outp IIR_FCR, #87  // Enable fifo 8 level, and clear it
  26++86BD ~                outp LCR,     #83  // 8n1, DLAB=1
  27++86BD ~                outp RBR_THR, 12  //(divider 12)
  28++86BD ~                outp IER,     #00  // (divider 0). Divider is 16 bit, so we get (#0002 divider)
  29++86BD ~
  30++86BD ~                outp LCR,     #03 // 8n1, DLAB=0
  31++86BD ~                outp IER,     #00 // Disable int
  32++86BD ~                outp MCR,     #2f // Enable AFE
  33++86BD ~                ret
  34++86BD                  ELSE
  35++86BD                  outp MCR,     #0d  // Assert RTS
  35++86BD 06 FC       >	ld b, MCR
  35++86BF 0E EF       >	ld c, #EF
  35++86C1 3E 0D       >    ld a, #0d
  35++86C3 ED 79       >    out (c), a
  36++86C5                  outp IIR_FCR, #87  // Enable fifo 8 level, and clear it
  36++86C5 06 FA       >	ld b, IIR_FCR
  36++86C7 0E EF       >	ld c, #EF
  36++86C9 3E 87       >    ld a, #87
  36++86CB ED 79       >    out (c), a
  37++86CD                  outp LCR,     #83  // 8n1, DLAB=1
  37++86CD 06 FB       >	ld b, LCR
  37++86CF 0E EF       >	ld c, #EF
  37++86D1 3E 83       >    ld a, #83
  37++86D3 ED 79       >    out (c), a
  38++86D5                  outp RBR_THR, 1  // 115200 (divider 1)
  38++86D5 06 F8       >	ld b, RBR_THR
  38++86D7 0E EF       >	ld c, #EF
  38++86D9 3E 01       >    ld a, 1
  38++86DB ED 79       >    out (c), a
  39++86DD                  outp IER,     #00  // (divider 0). Divider is 16 bit, so we get (#0002 divider)
  39++86DD 06 F9       >	ld b, IER
  39++86DF 0E EF       >	ld c, #EF
  39++86E1 3E 00       >    ld a, #00
  39++86E3 ED 79       >    out (c), a
  40++86E5
  41++86E5                  outp LCR,     #03 // 8n1, DLAB=0
  41++86E5 06 FB       >	ld b, LCR
  41++86E7 0E EF       >	ld c, #EF
  41++86E9 3E 03       >    ld a, #03
  41++86EB ED 79       >    out (c), a
  42++86ED                  outp IER,     #00 // Disable int
  42++86ED 06 F9       >	ld b, IER
  42++86EF 0E EF       >	ld c, #EF
  42++86F1 3E 00       >    ld a, #00
  42++86F3 ED 79       >    out (c), a
  43++86F5                  outp MCR,     #2f // Enable AFE
  43++86F5 06 FC       >	ld b, MCR
  43++86F7 0E EF       >	ld c, #EF
  43++86F9 3E 2F       >    ld a, #2f
  43++86FB ED 79       >    out (c), a
  44++86FD
  45++86FD C9               ret
  46++86FE                  ENDIF
  47++86FE              retry_rec_count_max equ 50 ; 1    
  48++86FE
  49++86FE              ; Flag C <- Data available
  50++86FE              ; isAvailable:
  51++86FE                  ; ld a, LSR
  52++86FE                  ; in a, (#EF)
  53++86FE                  ; rrca
  54++86FE                  ; ret
  55++86FE
  56++86FE              ; Non-blocking read
  57++86FE              ; Flag C <- is byte was readen
  58++86FE              ; A <- byte
  59++86FE              ; read1:
  60++86FE                  ; ld a, LSR
  61++86FE                  ; in a, (#EF)
  62++86FE                  ; rrca
  63++86FE                  ; ret nc
  64++86FE                  ; ld a, RBR_THR
  65++86FE                  ; in a, (#EF)
  66++86FE                  ; scf
  67++86FE                  ; ret
  68++86FE
  69++86FE              ; Tries read byte with timeout
  70++86FE              ; Flag C <- is byte read
  71++86FE              ; A <- byte
  72++86FE              read:
  73++86FE AF           	xor a ;4
  74++86FF 32 78 5C     	ld (#5C78),a ;   ;13
  75++8702              .wait
  76++8702 3E FD            ld a, LSR
  77++8704 DB EF            in a, (#EF)
  78++8706 0F               rrca
  79++8707 30 05        	jr nc, .readW
  80++8709 3E F8            ld a, RBR_THR
  81++870B DB EF            in a, (#EF)
  82++870D C9           	ret
  83++870E              .readW
  84++870E 3A 78 5C     	ld a,(#5C78)
  85++8711 FE 32        	cp retry_rec_count_max
  86++8713 38 ED        	jr c, .wait ; 
  87++8715 AF           	xor a ;     
  88++8716 C9           	ret
  89++8717
  90++8717
  91++8717
  92++8717
  93++8717              ; Blocking read
  94++8717              ; A <- Byte
  95++8717              ; readB:
  96++8717                  ; ld a, LSR
  97++8717                  ; in a, (#EF)
  98++8717                  ; rrca
  99++8717                  ; jr nc, readB
 100++8717              	; ld a, RBR_THR
 101++8717                  ; in a, (#EF)
 102++8717                  ; ret
 103++8717
 104++8717              ; A -> byte to send
 105++8717              write:
 106++8717 F5               push af
 107++8718              .wait
 108++8718 3E FD        	ld a, LSR
 109++871A DB EF            in a, (#EF)
 110++871C E6 20            and #20
 111++871E 28 F8            jr z, .wait
 112++8720 F1               pop af
 113++8721 06 F8        	ld b, RBR_THR
 114++8723 0E EF        	ld c, #EF
 115++8725 ED 79            out (c), a
 116++8727 C9               ret
 117++8728
 118++8728                  endmodule
# file closed: drivers/uart-zxwifi.asm
  19++8728                  ENDIF
  20++8728
  21++8728              	include "utils.asm"
# file opened: drivers/utils.asm
   1++8728              ;;; Macroses!!!!
   2++8728                  MACRO EspSend Text
   3++8728 ~                ld hl, .txtB
   4++8728 ~                ld e, (.txtE - .txtB)
   5++8728 ~                call espSend
   6++8728 ~                jr .txtE
   7++8728 ~            .txtB
   8++8728 ~                db Text
   9++8728 ~            .txtE
  10++8728                  ENDM
  11++8728
  12++8728                  MACRO EspCmd Text
  13++8728 ~                ld hl, .txtB
  14++8728 ~                ld e, (.txtE - .txtB)
  15++8728 ~                call espSend
  16++8728 ~                jr .txtE
  17++8728 ~            .txtB
  18++8728 ~                db Text
  19++8728 ~                db 13, 10
  20++8728 ~            .txtE
  21++8728                  ENDM
  22++8728
  23++8728                  MACRO EspCmdOkErr text
  24++8728 ~                EspCmd text
  25++8728 ~                call checkOkErr
  26++8728                  ENDM
  27++8728
  28++8728              ; IN DE - string pointer
  29++8728              ; OUT HL - string len
  30++8728              strLen:
  31++8728 21 00 00         ld hl, 0
  32++872B              .loop
  33++872B 1A               ld a, (de)
  33++872C A7             and a
  33++872D C8             ret z
  34++872E 13 23            inc de, hl
  35++8730 18 F9            jr .loop
# file closed: drivers/utils.asm
  22++8732
  23++8732              	IFDEF UARTATM
  24++8732 ~            		include "uart-atm.asm"
  25++8732              	ENDIF
  26++8732
  27++8732              	IFDEF UARTEVO
  28++8732 ~            		include "uart-evo.asm"
  29++8732                  ENDIF
  30++8732
  31++8732              	IFDEF NEDONET
  32++8732 ~            		include "nedowifi.asm"
  33++8732              	ELSE
  34++8732              	IFNDEF MSX
  35++8732              		include "wifi.asm"
# file opened: drivers/wifi.asm
   1++8732                  MODULE Wifi
   2++8732 00 00        bytes_avail dw 0
   3++8734 00 00        buffer_pointer dw 0
   4++8736 01           closed db 1
   5++8737              ; Initialize Wifi chip to work
   6++8737              init:
   7++8737
   8++8737 21 29 88         ld hl, .uartIniting
   8++873A CD BC 60       call TextMode.printZ
   9++873D CD BD 86         call Uart.init
  10++8740 21 3A 88         ld hl, .chipIniting
  10++8743 CD BC 60       call TextMode.printZ
  11++8746
  12++8746                  EspCmdOkErr "ATE0"
  12++8746             >    EspCmd "ATE0"
  12++8746 21 50 87    >    ld hl, .txtB
  12++8749 1E 06       >    ld e, (.txtE - .txtB)
  12++874B CD 3F 89    >    call espSend
  12++874E 18 06       >    jr .txtE
  12++8750             >.txtB
  12++8750 41 54 45 30 >    db "ATE0"
  12++8754 0D 0A       >    db 13, 10
  12++8756             >.txtE
  12++8756 CD CA 88    >    call checkOkErr
  13++8759 DA 09 88         jp c, .initError
  14++875C
  15++875C              ; Reading auth.pwd and send it to ESP
  16++875C 21 42 98 06      ld hl, creds, b, Dos.FMODE_READ
  16++8760 01
  16++8761 CD 6B 6C       call Dos.fopen
  17++8764 F5               push af
  18++8765 21 53 98 01      ld hl,outputBuffer2, bc, 255
  18++8769 FF 00
  18++876B CD 58 6D       call Dos.fread
  19++876E F1               pop af
  20++876F CD 44 6D         call Dos.fclose
  21++8772
  22++8772 21 52 88         ld hl, .doneInit1
  22++8775 CD BC 60       call TextMode.printZ
  23++8778
  24++8778 21 53 98         ld hl,outputBuffer2
  25++877B CD 49 89         call espSendT
  26++877E 3E 0D            ld a, 13
  26++8780 CD 17 87       call Uart.write
  27++8783 3E 0A            ld a, 10
  27++8785 CD 17 87       call Uart.write
  28++8788 CD CA 88         call checkOkErr
  29++878B DA 09 88         jp c, .initError
  30++878E              ;
  31++878E                 	EspCmdOkErr "AT+CIPSERVER=0"
  31++878E             >    EspCmd "AT+CIPSERVER=0"
  31++878E 21 98 87    >    ld hl, .txtB
  31++8791 1E 10       >    ld e, (.txtE - .txtB)
  31++8793 CD 3F 89    >    call espSend
  31++8796 18 10       >    jr .txtE
  31++8798             >.txtB
  31++8798 41 54 2B 43 >    db "AT+CIPSERVER=0"
  31++879C 49 50 53 45 >
  31++87A0 52 56 45 52 >
  31++87A4 3D 30       >
  31++87A6 0D 0A       >    db 13, 10
  31++87A8             >.txtE
  31++87A8 CD CA 88    >    call checkOkErr
  32++87AB                  EspCmdOkErr "AT+CIPCLOSE" ; Close if there some connection was. Don't care about result
  32++87AB             >    EspCmd "AT+CIPCLOSE"
  32++87AB 21 B5 87    >    ld hl, .txtB
  32++87AE 1E 0D       >    ld e, (.txtE - .txtB)
  32++87B0 CD 3F 89    >    call espSend
  32++87B3 18 0D       >    jr .txtE
  32++87B5             >.txtB
  32++87B5 41 54 2B 43 >    db "AT+CIPCLOSE"
  32++87B9 49 50 43 4C >
  32++87BD 4F 53 45    >
  32++87C0 0D 0A       >    db 13, 10
  32++87C2             >.txtE
  32++87C2 CD CA 88    >    call checkOkErr
  33++87C5                  EspCmdOkErr "AT+CIPMUX=0" ; Single connection mode
  33++87C5             >    EspCmd "AT+CIPMUX=0"
  33++87C5 21 CF 87    >    ld hl, .txtB
  33++87C8 1E 0D       >    ld e, (.txtE - .txtB)
  33++87CA CD 3F 89    >    call espSend
  33++87CD 18 0D       >    jr .txtE
  33++87CF             >.txtB
  33++87CF 41 54 2B 43 >    db "AT+CIPMUX=0"
  33++87D3 49 50 4D 55 >
  33++87D7 58 3D 30    >
  33++87DA 0D 0A       >    db 13, 10
  33++87DC             >.txtE
  33++87DC CD CA 88    >    call checkOkErr
  34++87DF DA 09 88         jp c, .initError
  35++87E2
  36++87E2                  EspCmdOkErr "AT+CIPDINFO=0" ; Disable additional info
  36++87E2             >    EspCmd "AT+CIPDINFO=0"
  36++87E2 21 EC 87    >    ld hl, .txtB
  36++87E5 1E 0F       >    ld e, (.txtE - .txtB)
  36++87E7 CD 3F 89    >    call espSend
  36++87EA 18 0F       >    jr .txtE
  36++87EC             >.txtB
  36++87EC 41 54 2B 43 >    db "AT+CIPDINFO=0"
  36++87F0 49 50 44 49 >
  36++87F4 4E 46 4F 3D >
  36++87F8 30          >
  36++87F9 0D 0A       >    db 13, 10
  36++87FB             >.txtE
  36++87FB CD CA 88    >    call checkOkErr
  37++87FE DA 09 88         jp c, .initError
  38++8801
  39++8801 21 4B 88         ld hl, .doneInit
  39++8804 CD BC 60       call TextMode.printZ
  40++8807
  41++8807 B7               or a
  42++8808 C9               ret
  43++8809              .initError
  44++8809 21 11 88         ld hl, .errMsg
  44++880C CD BE 69       call DialogBox.msgBox
  45++880F 37               scf
  46++8810 C9               ret
  47++8811 57 69 46 69  .errMsg      db "WiFi chip init failed!", "\r", 0
  47++8815 20 63 68 69
  47++8819 70 20 69 6E
  47++881D 69 74 20 66
  47++8821 61 69 6C 65
  47++8825 64 21 0D 00
  48++8829 55 61 72 74  .uartIniting db "Uart initing...", "\r", 0
  48++882D 20 69 6E 69
  48++8831 74 69 6E 67
  48++8835 2E 2E 2E 0D
  48++8839 00
  49++883A 43 68 69 70  .chipIniting db "Chip initing...", "\r", 0
  49++883E 20 69 6E 69
  49++8842 74 69 6E 67
  49++8846 2E 2E 2E 0D
  49++884A 00
  50++884B 44 6F 6E 65  .doneInit    db "Done!","\r", 0
  50++884F 21 0D 00
  51++8852 53 65 6E 64  .doneInit1   db "Sending auth.pwd to ESP","\r", 0
  51++8856 69 6E 67 20
  51++885A 61 75 74 68
  51++885E 2E 70 77 64
  51++8862 20 74 6F 20
  51++8866 45 53 50 0D
  51++886A 00
  52++886B                  IFNDEF PROXY
  53++886B              ; HL - host pointer in gopher row
  54++886B              ; DE - port pointer in gopher row
  55++886B              openTCP:
  56++886B D5               push de
  57++886C E5               push hl
  58++886D                  EspCmdOkErr "AT+CIPCLOSE" ; Don't care about result. Just close if it didn't happens before
  58++886D             >    EspCmd "AT+CIPCLOSE"
  58++886D 21 77 88    >    ld hl, .txtB
  58++8870 1E 0D       >    ld e, (.txtE - .txtB)
  58++8872 CD 3F 89    >    call espSend
  58++8875 18 0D       >    jr .txtE
  58++8877             >.txtB
  58++8877 41 54 2B 43 >    db "AT+CIPCLOSE"
  58++887B 49 50 43 4C >
  58++887F 4F 53 45    >
  58++8882 0D 0A       >    db 13, 10
  58++8884             >.txtE
  58++8884 CD CA 88    >    call checkOkErr
  59++8887                  EspSend 'AT+CIPSTART="TCP","'
  59++8887 21 91 88    >    ld hl, .txtB
  59++888A 1E 13       >    ld e, (.txtE - .txtB)
  59++888C CD 3F 89    >    call espSend
  59++888F 18 13       >    jr .txtE
  59++8891             >.txtB
  59++8891 41 54 2B 43 >    db 'AT+CIPSTART="TCP","'
  59++8895 49 50 53 54 >
  59++8899 41 52 54 3D >
  59++889D 22 54 43 50 >
  59++88A1 22 2C 22    >
  59++88A4             >.txtE
  60++88A4 E1               pop hl
  61++88A5 CD 49 89         call espSendT
  62++88A8                  EspSend '",'
  62++88A8 21 B2 88    >    ld hl, .txtB
  62++88AB 1E 02       >    ld e, (.txtE - .txtB)
  62++88AD CD 3F 89    >    call espSend
  62++88B0 18 02       >    jr .txtE
  62++88B2             >.txtB
  62++88B2 22 2C       >    db '",'
  62++88B4             >.txtE
  63++88B4 E1               pop hl
  64++88B5 CD 49 89         call espSendT
  65++88B8 3E 0D            ld a, 13
  65++88BA CD 17 87       call Uart.write
  66++88BD 3E 0A            ld a, 10
  66++88BF CD 17 87       call Uart.write
  67++88C2 AF               xor a
  67++88C3 32 36 87       ld (closed), a
  68++88C6 C3 CA 88         jp checkOkErr
  69++88C9
  70++88C9              continue:
  71++88C9 C9               ret
  72++88CA                  ENDIF
  73++88CA
  74++88CA
  75++88CA
  76++88CA              checkOkErr:
  77++88CA CD FE 86         call Uart.read
  78++88CD FE 4F            cp 'O'
  78++88CF CA DF 88       jp z, .okStart ; OK
  79++88D2 FE 45            cp 'E'
  79++88D4 CA F4 88       jp z, .errStart ; ERROR
  80++88D7 FE 46            cp 'F'
  80++88D9 CA 19 89       jp z, .failStart ; FAIL
  81++88DC C3 CA 88         jp checkOkErr
  82++88DF              .okStart
  83++88DF CD FE 86         call Uart.read
  83++88E2 FE 4B          cp 'K'
  83++88E4 C2 CA 88       jp nz, checkOkErr
  84++88E7 CD FE 86         call Uart.read
  84++88EA FE 0D          cp 13
  84++88EC C2 CA 88       jp nz, checkOkErr
  85++88EF CD 36 89         call .flushToLF
  86++88F2 B7               or a
  87++88F3 C9               ret
  88++88F4              .errStart
  89++88F4 CD FE 86         call Uart.read
  89++88F7 FE 52          cp 'R'
  89++88F9 C2 CA 88       jp nz, checkOkErr
  90++88FC CD FE 86         call Uart.read
  90++88FF FE 52          cp 'R'
  90++8901 C2 CA 88       jp nz, checkOkErr
  91++8904 CD FE 86         call Uart.read
  91++8907 FE 4F          cp 'O'
  91++8909 C2 CA 88       jp nz, checkOkErr
  92++890C CD FE 86         call Uart.read
  92++890F FE 52          cp 'R'
  92++8911 C2 CA 88       jp nz, checkOkErr
  93++8914 CD 36 89         call .flushToLF
  94++8917 37               scf
  95++8918 C9               ret
  96++8919              .failStart
  97++8919 CD FE 86         call Uart.read
  97++891C FE 41          cp 'A'
  97++891E C2 CA 88       jp nz, checkOkErr
  98++8921 CD FE 86         call Uart.read
  98++8924 FE 49          cp 'I'
  98++8926 C2 CA 88       jp nz, checkOkErr
  99++8929 CD FE 86         call Uart.read
  99++892C FE 4C          cp 'L'
  99++892E C2 CA 88       jp nz, checkOkErr
 100++8931 CD 36 89         call .flushToLF
 101++8934 37               scf
 102++8935 C9               ret
 103++8936              .flushToLF
 104++8936 CD FE 86         call Uart.read
 105++8939 FE 0A            cp 10
 105++893B C2 36 89       jp nz, .flushToLF
 106++893E C9               ret
 107++893F
 108++893F              ; Send buffer to UART
 109++893F              ; HL - buff
 110++893F              ; E - count
 111++893F              espSend:
 112++893F 7E               ld a, (hl)
 112++8940 CD 17 87       call Uart.write
 113++8943 23               inc hl
 114++8944 1D               dec e
 115++8945 C2 3F 89         jp nz, espSend
 116++8948 C9               ret
 117++8949
 118++8949              ; HL - string that ends with one of the terminator(CR/LF/TAB/NULL)
 119++8949              espSendT:
 120++8949 7E               ld a, (hl)
 121++894A
 122++894A A7               and a
 122++894B C8             ret z
 123++894C FE 09            cp 9
 123++894E C8             ret z
 124++894F FE 0D            cp 13
 124++8951 C8             ret z
 125++8952 FE 0A            cp 10
 125++8954 C8             ret z
 126++8955
 127++8955 CD 17 87         call Uart.write
 128++8958 23               inc hl
 129++8959 C3 49 89         jp espSendT
 130++895C
 131++895C              ; HL - stringZ to send
 132++895C              ; Adds CR LF
 133++895C              tcpSendZ:
 134++895C E5               push hl
 135++895D                  EspSend "AT+CIPSEND="
 135++895D 21 67 89    >    ld hl, .txtB
 135++8960 1E 0B       >    ld e, (.txtE - .txtB)
 135++8962 CD 3F 89    >    call espSend
 135++8965 18 0B       >    jr .txtE
 135++8967             >.txtB
 135++8967 41 54 2B 43 >    db "AT+CIPSEND="
 135++896B 49 50 53 45 >
 135++896F 4E 44 3D    >
 135++8972             >.txtE
 136++8972 D1               pop de
 136++8973 D5             push de
 137++8974 CD 28 87         call strLen
 138++8977 23               inc hl
 138++8978 23             inc hl ; +CRLF
 139++8979 CD 41 8A         call hlToNumEsp
 140++897C 3E 0D            ld a, 13
 140++897E CD 17 87       call Uart.write
 141++8981 3E 0A            ld a, 10
 141++8983 CD 17 87       call Uart.write
 142++8986 CD CA 88         call checkOkErr
 142++8989 D8             ret c
 143++898A              .wait
 144++898A CD FE 86         call Uart.read
 144++898D FE 3E          cp '>'
 144++898F C2 8A 89       jp nz, .wait
 145++8992 E1               pop hl
 146++8993              .loop
 147++8993 7E               ld a, (hl)
 147++8994 A7             and a
 147++8995 CA 9F 89       jp z, .exit
 148++8998 CD 17 87         call Uart.write
 149++899B 23               inc hl
 150++899C C3 93 89         jp .loop
 151++899F              .exit
 152++899F 3E 0D            ld a, 13
 152++89A1 CD 17 87       call Uart.write
 153++89A4 3E 0A            ld a, 10
 153++89A6 CD 17 87       call Uart.write
 154++89A9 C3 CA 88         jp checkOkErr
 155++89AC
 156++89AC              getPacket:
 157++89AC CD FE 86         call Uart.read
 158++89AF FE 2B            cp '+'
 158++89B1 CA E2 89       jp z, .ipdBegun    ; "+IPD," packet
 159++89B4 FE 4F            cp 'O'
 159++89B6 CA BC 89       jp z, .closedBegun ; It enough to check "OSED\n" :-)
 160++89B9 C3 AC 89         jp getPacket
 161++89BC              .closedBegun
 162++89BC CD FE 86         call Uart.read
 162++89BF FE 53          cp 'S'
 162++89C1 C2 BC 89       jp nz, .closedBegun
 163++89C4 CD FE 86         call Uart.read
 163++89C7 FE 45          cp 'E'
 163++89C9 C2 BC 89       jp nz, .closedBegun
 164++89CC CD FE 86         call Uart.read
 164++89CF FE 44          cp 'D'
 164++89D1 C2 BC 89       jp nz, .closedBegun
 165++89D4 CD FE 86         call Uart.read
 165++89D7 FE 0D          cp 13
 165++89D9 C2 BC 89       jp nz, .closedBegun
 166++89DC 3E 01 32 36      ld a, 1, (closed), a
 166++89E0 87
 167++89E1 C9               ret
 168++89E2              .ipdBegun
 169++89E2 CD FE 86         call Uart.read
 169++89E5 FE 49          cp 'I'
 169++89E7 C2 E2 89       jp nz, .ipdBegun
 170++89EA CD FE 86         call Uart.read
 170++89ED FE 50          cp 'P'
 170++89EF C2 E2 89       jp nz, .ipdBegun
 171++89F2 CD FE 86         call Uart.read
 171++89F5 FE 44          cp 'D'
 171++89F7 C2 E2 89       jp nz, .ipdBegun
 172++89FA CD FE 86         call Uart.read  ;Comma
 173++89FD CD 27 8A         call .count_ipd_lenght
 173++8A00 22 32 87       ld (bytes_avail), hl
 174++8A03 54 5D            ld de, hl
 175++8A05 2A 34 87         ld hl, (buffer_pointer)
 176++8A08              .readp
 177++8A08 7C               ld a, h
 177++8A09 FE FF          cp #ff
 177++8A0B D2 1D 8A       jp nc, .skipbuff
 178++8A0E CD FE 86         call Uart.read
 179++8A11 77               ld (hl), a
 180++8A12 1B               dec de
 181++8A13 23               inc hl
 182++8A14 7A               ld a, d
 182++8A15 B3             or e
 182++8A16 C2 08 8A       jp nz, .readp
 183++8A19 22 34 87         ld (buffer_pointer), hl
 184++8A1C C9               ret
 185++8A1D              .skipbuff
 186++8A1D CD FE 86         call Uart.read
 187++8A20 1B               dec de
 187++8A21 7A             ld a, d
 187++8A22 B3             or e
 187++8A23 C2 1D 8A       jp nz, .skipbuff
 188++8A26 C9               ret
 189++8A27              .count_ipd_lenght
 190++8A27 21 00 00     		ld hl,0			; count lenght
 191++8A2A E5           .cil1	push  hl
 192++8A2B CD FE 86             call Uart.read
 193++8A2E E1                   pop hl
 194++8A2F FE 3A        		cp ':'
 195++8A31 C8                   ret z
 196++8A32 D6 30        		sub 0x30
 197++8A34 4D                   ld c,l
 198++8A35 44                   ld b,h
 199++8A36 29                   add hl,hl
 200++8A37 29                   add hl,hl
 201++8A38 09                   add hl,bc
 202++8A39 29                   add hl,hl
 203++8A3A 4F                   ld c,a
 204++8A3B 06 00                ld b,0
 205++8A3D 09                   add hl,bc
 206++8A3E C3 2A 8A     		jp .cil1
 207++8A41
 208++8A41              ; Based on: https://wikiti.brandonw.net/index.php?title=Z80_Routines:Other:DispHL
 209++8A41              ; HL - number
 210++8A41              ; It will be written to UART
 211++8A41              hlToNumEsp:
 212++8A41 01 F0 D8     	ld	bc,-10000
 213++8A44 CD 5A 8A     	call	.n1
 214++8A47 01 18 FC     	ld	bc,-1000
 215++8A4A CD 5A 8A     	call	.n1
 216++8A4D 01 9C FF     	ld	bc,-100
 217++8A50 CD 5A 8A     	call	.n1
 218++8A53 0E F6        	ld	c,-10
 219++8A55 CD 5A 8A     	call	.n1
 220++8A58 0E FF        	ld	c,-1
 221++8A5A 3E 2F        .n1	ld	a,'0'-1
 222++8A5C 3C           .n2	inc	a
 223++8A5D 09           	add	hl,bc
 224++8A5E DA 5C 8A     	jp	c, .n2
 225++8A61 ED 42        	sbc	hl,bc
 226++8A63 C5               push bc
 227++8A64 CD 17 87     	call Uart.write
 228++8A67 C1               pop bc
 229++8A68 C9               ret
 230++8A69              flushToLF1
 231++8A69 CD FE 86         call Uart.read
 232++8A6C FE 0A            cp 10
 232++8A6E C2 69 8A       jp nz, flushToLF1
 233++8A71 C9               ret
 234++8A72                  ENDMODULE
# file closed: drivers/wifi.asm
  36++8A72              	ENDIF
  37++8A72              	ENDIF
  38++8A72
  39++8A72                  IFDEF NEDOOS
  40++8A72 ~                	include "rtc-nos.asm"
  41++8A72                  ENDIF
  42++8A72
  43++8A72
  44++8A72                  IFDEF SMUCRTC
  45++8A72                  	include "rtc-smuc.asm"
# file opened: drivers/rtc-smuc.asm
   1++8A72              ;clock driver SMUC
   2++8A72              	module Clock
   3++8A72              ; .:	CY=1,   CMOS 
   4++8A72              	; C  /;
   5++8A72              	; B - /;
   6++8A72              	; E - /;
   7++8A72
   8++8A72              readTime
   9++8A72 01 BA DF     	ld bc,#DFBA
  10++8A75 3E 04        	ld a,4 ;
  11++8A77 CD AD 8A     	call out3d2f
  12++8A7A 3E 0A        	ld a,10 ;
  13++8A7C              readTimeCL
  14++8A7C 3D           	dec a
  15++8A7D 20 FD        	jr nz,readTimeCL
  16++8A7F CD A6 8A     	call in3d2f
  17++8A82 FE FF        	cp 255 ;  
  18++8A84 37           	scf
  19++8A85 C8           	ret z
  20++8A86 5F           	ld e,a
  21++8A87 3E 02        	ld a,2 ;
  22++8A89 CD AD 8A     	call out3d2f
  23++8A8C 3E 0A        	ld a,10 ;
  24++8A8E              readTimeCL2
  25++8A8E 3D           	dec a
  26++8A8F 20 FD        	jr nz,readTimeCL2
  27++8A91 CD A6 8A     	call in3d2f
  28++8A94 47           	ld b,a
  29++8A95 B7           	or a
  30++8A96              ;  
  31++8A96 30 01        	jr nc,read_time_ok
  32++8A98              	; ld hl,mes_no_RTC
  33++8A98              	; call print_mes
  34++8A98              	; scf
  35++8A98 C9           	ret ;
  36++8A99              read_time_ok
  37++8A99 7B           	ld a,e ;
  38++8A9A 32 63 8B     	ld (hours),a
  39++8A9D 78           	ld a,b ;
  40++8A9E 32 64 8B     	ld (minutes),a
  41++8AA1 79           	ld a,c ;
  42++8AA2 32 65 8B     	ld (seconds),a
  43++8AA5 C9           	ret
  44++8AA6
  45++8AA6              in3d2f
  46++8AA6 21 F3 3F     	ld hl,#3ff3
  47++8AA9 E5           	push hl
  48++8AAA C3 2F 3D     	jp #3d2f
  49++8AAD
  50++8AAD              out3d2f
  51++8AAD 21 53 2A     	ld hl,#2A53
  52++8AB0 E5           	push hl
  53++8AB1 C3 2F 3D     	jp #3d2f
  54++8AB4                  endmodule
  55++8AB4
# file closed: drivers/rtc-smuc.asm
  46++8AB4                  ENDIF
  47++8AB4
  48++8AB4              	IFDEF MSX
  49++8AB4 ~                    include "drivers/unapi/unapi.asm"
  50++8AB4 ~                	include "drivers/unapi/tcp.asm"
  51++8AB4 ~            		include "rtc-msx.asm"
  52++8AB4                  ELSE
  53++8AB4              		include "proxy.asm"
# file opened: drivers/proxy.asm
   1++8AB4                  IFDEF PROXY
   2++8AB4 ~                MODULE Wifi
   3++8AB4 ~            ; Same singature as wifi.openTCP
   4++8AB4 ~            ; HL - host pointer in gopher row
   5++8AB4 ~            ; DE - port pointer in gopher row
   6++8AB4 ~            openTCP:
   7++8AB4 ~                push de
   8++8AB4 ~                push hl
   9++8AB4 ~
  10++8AB4 ~                xor a
  10++8AB4 ~              ld hl, hostBuff, de, hostBuff + 1, bc, 102, (hl), a
  10++8AB4 ~              ldir
  11++8AB4 ~
  12++8AB4 ~                EspCmdOkErr "AT+CIPCLOSE"
  13++8AB4 ~                EspCmdOkErr 'AT+CIPSTART="TCP","138.68.76.243",6912' // Replace here for yourown proxy. If you wish
  14++8AB4 ~                jr c, .error
  15++8AB4 ~                pop hl
  15++8AB4 ~              ld de, hostBuff
  16++8AB4 ~            .copyHost
  17++8AB4 ~                ld a, (hl)
  17++8AB4 ~              and a
  17++8AB4 ~              jr z, 1F
  17++8AB4 ~              and a
  17++8AB4 ~              jr z, 1F
  18++8AB4 ~                ld (de), a
  18++8AB4 ~              inc hl, de
  19++8AB4 ~                jr .copyHost
  20++8AB4 ~            1   xor a
  20++8AB4 ~              ld (de), a
  21++8AB4 ~                pop hl
  21++8AB4 ~              ld de, portBuff
  22++8AB4 ~            .copyPort
  23++8AB4 ~                ld a, (hl)
  23++8AB4 ~              and a
  23++8AB4 ~              jr z, 1F
  23++8AB4 ~              and a
  23++8AB4 ~              jr z, 1F
  24++8AB4 ~                ld (de), a
  24++8AB4 ~              inc hl, de
  25++8AB4 ~                jr .copyPort
  26++8AB4 ~            1   ld hl, hostBuff
  26++8AB4 ~              call tcpSendZ
  27++8AB4 ~                ld hl, portBuff
  27++8AB4 ~              call tcpSendZ
  28++8AB4 ~                xor a
  28++8AB4 ~              ld (closed), a
  29++8AB4 ~                ret
  30++8AB4 ~            .error
  31++8AB4 ~                pop hl
  31++8AB4 ~              pop de
  32++8AB4 ~                ret
  33++8AB4 ~
  34++8AB4 ~            continue:
  35++8AB4 ~                EspCmdOkErr "AT+CIPSEND=1"
  36++8AB4 ~                ret c
  37++8AB4 ~            .wait
  38++8AB4 ~                call Uart.read
  38++8AB4 ~              cp '>'
  38++8AB4 ~              jr nz, .wait
  39++8AB4 ~                ld a, 'c'
  39++8AB4 ~              call Uart.write
  40++8AB4 ~                jp checkOkErr
  41++8AB4 ~
  42++8AB4 ~            hostBuff ds 96
  43++8AB4 ~            portBuff ds 7
  44++8AB4 ~                ENDMODULE
  45++8AB4                  ENDIF
# file closed: drivers/proxy.asm
  54++8AB4              		include "memory.asm"
# file opened: drivers/memory.asm
   1++8AB4                  module Memory
   2++8AB4              BANKM = #5b5c
   3++8AB4              MEM_PORT = #7ffd
   4++8AB4
   5++8AB4              init:
   6++8AB4 F3               di
   7++8AB5 FD CB 01 A6      res 4, (iy + 1)
   8++8AB9
   9++8AB9 AF               xor a
   9++8ABA CD BE 8A       call setPage
  10++8ABD C9               ret
  11++8ABE
  12++8ABE              ; a - page
  13++8ABE              setPage:
  14++8ABE F6 18            or #18
  14++8AC0 32 5C 5B       ld (BANKM), a
  15++8AC3 01 FD 7F         ld bc, MEM_PORT
  15++8AC6 ED 79          out (c), a
  16++8AC8 C9               ret
  17++8AC9
  18++8AC9                  endmodule
# file closed: drivers/memory.asm
  55++8AC9              	ENDIF
  56++8AC9
  57++8AC9              	IFDEF GS
  58++8AC9 ~            		include "general-sound.asm"
  59++8AC9              	ENDIF
# file closed: drivers/index.asm
  25+ 8AC9                  include "screen/rtc.asm"
# file opened: screen/rtc.asm
   1++8AC9              printRTC
   2++8AC9              	IFDEF RTC
   3++8AC9 CD 72 8A     	call Clock.readTime
   4++8ACC
   5++8ACC 3A 6E 8B     	ld a, (oldminutes)
   6++8ACF 57           	ld d,a
   7++8AD0 3A 64 8B     	ld a, (minutes)
   8++8AD3 BA           	cp d					; Update only if minutes changed
   9++8AD4 C8           	ret z
  10++8AD5 32 6E 8B     	ld (oldminutes), a
  11++8AD8
  12++8AD8 16 01        	ld d,1 ; Y,X
  13++8ADA 1E 39        	ld e,64 - 7
  14++8ADC CD 3A 60     	call TextMode.gotoXY
  15++8ADF 3E 5B        	ld a,'['
  16++8AE1 CD A4 60     	call TextMode.putC
  17++8AE4 26 00        	ld h,0
  18++8AE6 3A 63 8B     	ld a,(hours) ;
  19++8AE9 6F           	ld l,a
  20++8AEA CD 0D 8B     	call toDecimal
  21++8AED 21 69 8B     	ld hl,decimalS+3
  22++8AF0 CD BC 60     	call TextMode.printZ
  23++8AF3 3E 3A        	ld a,':'
  24++8AF5 CD A4 60     	call TextMode.putC
  25++8AF8 26 00        	ld h,0
  26++8AFA 3A 64 8B     	ld a,(minutes) ;
  27++8AFD 6F           	ld l,a
  28++8AFE CD 0D 8B     	call toDecimal
  29++8B01 21 69 8B     	ld hl,decimalS+3
  30++8B04 CD BC 60     	call TextMode.printZ
  31++8B07              	;ld a,':'
  32++8B07              	;call TextMode.putC
  33++8B07              	;ld h,0
  34++8B07              	;ld a,(seconds) ;
  35++8B07              	;ld l,a
  36++8B07              	;call toDecimal
  37++8B07              	;ld hl,decimalS+3
  38++8B07              	;call TextMode.printZ
  39++8B07 3E 5D        	ld a,']'
  40++8B09 CD A4 60     	call TextMode.putC
  41++8B0C C9           	ret
  42++8B0D
  43++8B0D              toDecimal		; 2   5  
  44++8B0D              				;   HL 
  45++8B0D 11 10 27     	ld de,10000 ; 
  46++8B10 3E FF        	ld a,255
  47++8B12              toDecimal10k
  48++8B12 A7           	and a
  49++8B13 ED 52        	sbc hl,de
  50++8B15 3C           	inc a
  51++8B16 30 FA        	jr nc,toDecimal10k
  52++8B18 19           	add hl,de
  53++8B19 C6 30        	add a,48
  54++8B1B 32 66 8B     	ld (decimalS),a
  55++8B1E 11 E8 03     	ld de,1000 ;
  56++8B21 3E FF        	ld a,255
  57++8B23              toDecimal1k
  58++8B23 A7           	and a
  59++8B24 ED 52        	sbc hl,de
  60++8B26 3C           	inc a
  61++8B27 30 FA        	jr nc,toDecimal1k
  62++8B29 19           	add hl,de
  63++8B2A C6 30        	add a,48
  64++8B2C 32 67 8B     	ld (decimalS+1),a
  65++8B2F 11 64 00     	ld de,100 ;
  66++8B32 3E FF        	ld a,255
  67++8B34              toDecimal01k
  68++8B34 A7           	and a
  69++8B35 ED 52        	sbc hl,de
  70++8B37 3C           	inc a
  71++8B38 30 FA        	jr nc,toDecimal01k
  72++8B3A 19           	add hl,de
  73++8B3B C6 30        	add a,48
  74++8B3D 32 68 8B     	ld (decimalS+2),a
  75++8B40 11 0A 00     	ld de,10 ;
  76++8B43 3E FF        	ld a,255
  77++8B45              toDecimal001k
  78++8B45 A7           	and a
  79++8B46 ED 52        	sbc hl,de
  80++8B48 3C           	inc a
  81++8B49 30 FA        	jr nc,toDecimal001k
  82++8B4B 19           	add hl,de
  83++8B4C C6 30        	add a,48
  84++8B4E 32 69 8B     	ld (decimalS+3),a
  85++8B51 11 01 00     	ld de,1 ;
  86++8B54 3E FF        	ld a,255
  87++8B56              toDecimal0001k
  88++8B56 A7           	and a
  89++8B57 ED 52        	sbc hl,de
  90++8B59 3C           	inc a
  91++8B5A 30 FA        	jr nc,toDecimal0001k
  92++8B5C 19           	add hl,de
  93++8B5D C6 30        	add a,48
  94++8B5F 32 6A 8B     	ld (decimalS+4),a
  95++8B62 C9           	ret
  96++8B63              hours
  97++8B63 00           	db 0
  98++8B64              minutes
  99++8B64 00           	db 0
 100++8B65              seconds
 101++8B65 00           	db 0
 102++8B66 00 00 00...  decimalS	ds 7 ; 
 103++8B6D              	ENDIF
 104++8B6D C9           	ret
 105++8B6E              oldminutes		;    
 106++8B6E FF           	db 255
 107++8B6F
 108++8B6F
 109++8B6F
 110++8B6F
# file closed: screen/rtc.asm
  26+ 8B6F
  27+ 8B6F                  IFDEF NEDOOS
  28+ 8B6F ~                    include "screen/nedoscreen.asm"
  29+ 8B6F ~                    include "player/vortexnedoos.asm"
  30+ 8B6F ~                    include "player/mod-processor.asm"
  31+ 8B6F ~            start:
  32+ 8B6F ~            outputBuffer:
  33+ 8B6F ~                    ld sp, 0x4000
  34+ 8B6F ~                    ld c,nos.CMD_SETSYSDRV
  35+ 8B6F ~                 	ex af,af'
  36+ 8B6F ~            	    call nos.BDOS
  37+ 8B6F              	ELSE
  38+ 8B6F                      include "player/vortex-processor.asm"
# file opened: player/vortex-processor.asm
   1++8B6F                  MODULE VortexProcessor
   2++8B6F              	IFDEF MSX
   3++8B6F ~            play:
   4++8B6F ~                call Console.peekC
   4++8B6F ~              and a
   5++8B6F ~                jr nz, play
   6++8B6F ~
   7++8B6F ~                ld hl, message
   7++8B6F ~              call DialogBox.msgNoWait
   8++8B6F ~
   9++8B6F ~                ld hl, outputBuffer
   9++8B6F ~              call VTPL.INIT
  10++8B6F ~            .loop
  11++8B6F ~                halt
  11++8B6F ~              di
  11++8B6F ~              call VTPL.PLAY
  11++8B6F ~              ei
  12++8B6F ~                call Console.peekC
  12++8B6F ~              and a
  12++8B6F ~              jp nz, .stop
  13++8B6F ~                jr nc, .loop
  14++8B6F ~            .stop
  15++8B6F ~                call VTPL.MUTE
  16++8B6F ~            .wlp
  17++8B6F ~                call Console.peekC
  17++8B6F ~              and a
  18++8B6F ~                jr nz, .wlp
  19++8B6F ~                ret
  20++8B6F ~
  21++8B6F ~            message db "Press key to stop...", 0
  22++8B6F ~                ENDMODULE
  23++8B6F ~                include "msxplayer.asm"
  24++8B6F              	ELSE
  25++8B6F              play:
  26++8B6F 3E FF            ld a, 255
  27++8B71 32 6E 8B         ld (oldminutes), a
  28++8B74
  29++8B74 CD F7 69         call Console.waitForKeyUp
  30++8B77
  31++8B77 21 B2 8B         ld hl, message
  31++8B7A CD C7 69       call DialogBox.msgNoWait
  32++8B7D
  33++8B7D 21 E2 97         ld hl, outputBuffer
  33++8B80 CD 08 8C       call VTPL.INIT
  34++8B83
  35++8B83
  36++8B83 3E 01 32 08      ld a, 1, (Render.play_next), a
  36++8B87 69
  37++8B88
  38++8B88                  IFDEF GS
  39++8B88 ~                call GeneralSound.stopModule
  40++8B88                  ENDIF
  41++8B88              .loop
  42++8B88 76               halt
  42++8B89 F3             di
  42++8B8A CD 2B 94       call VTPL.PLAY
  42++8B8D FB             ei
  43++8B8E AF               xor a
  43++8B8F DB FE          in a, (#fe)
  43++8B91 2F             cpl
  43++8B92 E6 1F          and 31
  43++8B94 C2 AC 8B       jp nz, .stopKey
  44++8B97 CD C9 8A         call printRTC
  45++8B9A 3A D1 8B         ld a, (VTPL.SETUP)
  45++8B9D 17             rla
  45++8B9E 30 E8          jr nc, .loop
  46++8BA0 3E 01 32 08      ld a, 1, (Render.play_next), a
  46++8BA4 69
  47++8BA5              .stop
  48++8BA5 CD F6 8B         call VTPL.MUTE
  49++8BA8
  50++8BA8                  IFDEF AY
  51++8BA8 ~                call restoreAyState
  52++8BA8                  ENDIF
  53++8BA8
  54++8BA8 CD F7 69         call Console.waitForKeyUp
  55++8BAB C9               ret
  56++8BAC              .stopKey
  57++8BAC AF               xor a
  57++8BAD 32 08 69       ld (Render.play_next), a
  58++8BB0 18 F3            jr .stop
  59++8BB2
  60++8BB2                  IFDEF AY
  61++8BB2 ~            restoreAyState:
  62++8BB2 ~                ld a, #07
  63++8BB2 ~                ld bc, #fffd
  64++8BB2 ~                out (c), a
  65++8BB2 ~                ld a, #fc
  66++8BB2 ~                ld b, #bf
  67++8BB2 ~                out (c), a ; Enable read mode
  68++8BB2 ~
  69++8BB2 ~                ld a, #0e
  70++8BB2 ~                ld bc, #fffd
  71++8BB2 ~                out (c), a
  72++8BB2 ~                ret
  73++8BB2              	ENDIF
  74++8BB2 50 72 65 73  message db "Press key to stop...", 0
  74++8BB6 73 20 6B 65
  74++8BBA 79 20 74 6F
  74++8BBE 20 73 74 6F
  74++8BC2 70 2E 2E 2E
  74++8BC6 00
  75++8BC7                  ENDMODULE
  76++8BC7                  include "player.asm"
# file opened: player/player.asm
   1++8BC7              ;Universal PT2'n'PT3 Turbo Sound player for ZX Spectrum
   2++8BC7              ;(c)2004-2007 S.V.Bulba <vorobey@mail.khstu.ru>
   3++8BC7              ;Specially for AlCo
   4++8BC7              ;http://bulba.untergrund.net/ (http://bulba.at.kz/)
   5++8BC7              	MODULE VTPL
   6++8BC7              ;Release number
   7++8BC7              Release EQU "0"
   8++8BC7              ;Conditional assembly
   9++8BC7              ;1) Current position counters at (Vars1+0) and (Vars2+0)
  10++8BC7              CurPosCounter=0
  11++8BC7              ;2) Allow channels allocation bits at (START+10)
  12++8BC7              ACBBAC=0
  13++8BC7              ;3) Allow loop checking and disabling
  14++8BC7              LoopChecker=1
  15++8BC7              ;4) Insert official identificator
  16++8BC7              Id=0
  17++8BC7              ;5) Set IY for correct return to ZX Basic
  18++8BC7              Basic=1
  19++8BC7
  20++8BC7              ;Features
  21++8BC7              ;--------
  22++8BC7              ;-Can be compiled at any address (i.e. no need rounding ORG
  23++8BC7              ; address).
  24++8BC7              ;-Variables (VARS) can be located at any address (not only after
  25++8BC7              ; code block).
  26++8BC7              ;-INIT subprogram checks PT3-module version and rightly
  27++8BC7              ; generates both note and volume tables outside of code block
  28++8BC7              ; (in VARS).
  29++8BC7              ;-Two portamento (spc. command 3xxx) algorithms (depending of
  30++8BC7              ; PT3 module version).
  31++8BC7              ;-New 1.XX and 2.XX special command behaviour (only for PT v3.7
  32++8BC7              ; and higher).
  33++8BC7              ;-Any Tempo value are accepted (including Tempo=1 and Tempo=2).
  34++8BC7              ;-TS modes: 2xPT3, 2xPT2 and PT v3.7 TS standard.
  35++8BC7              ;-Fully compatible with Ay_Emul PT3 and PT2 players codes.
  36++8BC7              ;-See also notes at the end of this source code.
  37++8BC7
  38++8BC7              ;Limitations
  39++8BC7              ;-----------
  40++8BC7              ;-Can run in RAM only (self-modified code is used).
  41++8BC7              ;-PT2 position list must be end by #FF marker only.
  42++8BC7
  43++8BC7              ;Warning!!! PLAY subprogram can crash if no module are loaded
  44++8BC7              ;into RAM or INIT subprogram was not called before.
  45++8BC7
  46++8BC7              ;Call MUTE or INIT one more time to mute sound after stopping
  47++8BC7              ;playing
  48++8BC7
  49++8BC7              ;Test codes (commented)
  50++8BC7              ;	LD A,32 ;SinglePT3(TS if TSPT3.7),ABC,Looped
  51++8BC7              ;	LD (START+10),A
  52++8BC7              ;	LD HL,#8000 ;Mod1
  53++8BC7              ;	LD DE,#A000 ;Mod2 (optional)
  54++8BC7              ;	CALL START+3
  55++8BC7              ;	EI
  56++8BC7              ;_LP	HALT
  57++8BC7              ;	CALL START+5
  58++8BC7              ;	XOR A
  59++8BC7              ;	IN A,(#FE)
  60++8BC7              ;	CPL
  61++8BC7              ;	AND 15
  62++8BC7              ;	JR Z,_LP
  63++8BC7              ;	JR START+8
  64++8BC7
  65++8BC7              TonA	EQU 0
  66++8BC7              TonB	EQU 2
  67++8BC7              TonC	EQU 4
  68++8BC7              Noise	EQU 6
  69++8BC7              Mixer	EQU 7
  70++8BC7              AmplA	EQU 8
  71++8BC7              AmplB	EQU 9
  72++8BC7              AmplC	EQU 10
  73++8BC7              Env	EQU 11
  74++8BC7              EnvTp	EQU 13
  75++8BC7
  76++8BC7              ;Entry and other points
  77++8BC7              ;START initialize playing of modules at MDLADDR (single module)
  78++8BC7              ;START+3 initialization with module address in HL and DE (TS)
  79++8BC7              ;START+5 play one quark
  80++8BC7              ;START+8 mute
  81++8BC7              ;START+10 setup and status flags
  82++8BC7
  83++8BC7              START:
  84++8BC7 21 E2 97     	LD HL,outputBuffer ;DE - address of 2nd module for TS
  85++8BCA 18 3C        	JR INIT
  86++8BCC C3 2B 94     	JP PLAY
  87++8BCF 18 25        	JR MUTE
  88++8BD1 00           SETUP	DB 0 ;set bit0, if you want to play without looping
  89++8BD2              	     ;(optional);
  90++8BD2              	     ;set bit1 for PT2 and reset for PT3 before
  91++8BD2              	     ;calling INIT;
  92++8BD2              	     ;bits2-3: %00-ABC, %01-ACB, %10-BAC (optional);
  93++8BD2              	     ;bits4-5: %00-no TS, %01-2 modules TS, %10-
  94++8BD2              	     ;autodetect PT3 TS-format by AlCo (PT 3.7+);
  95++8BD2              	     ;Remark: old PT3 TS-format by AlCo (PT 3.6) is not
  96++8BD2              	     ;documented and must be converted to new standard.
  97++8BD2              	     ;bit6 is set each time, when loop point of 2nd TS
  98++8BD2              	     ;module is passed (optional).
  99++8BD2              	     ;bit7 is set each time, when loop point of 1st TS
 100++8BD2              	     ;or of single module is passed (optional).
 101++8BD2
 102++8BD2              ;Identifier
 103++8BD2              	IF Id
 104++8BD2 ~            	DB "=UniPT2/PT3/TS-Player r.",Release,"="
 105++8BD2              	ENDIF
 106++8BD2
 107++8BD2              	IF LoopChecker
 108++8BD2 21 D1 8B     CHECKLP	LD HL,SETUP
 109++8BD5 FD CB 9E 46  	BIT 0,(IY-100+VRS.ModNum)
 110++8BD9 28 04        	JR Z,CHL1
 111++8BDB CB F6        	SET 6,(HL)
 112++8BDD 18 02        	JR CHL2
 113++8BDF CB FE        CHL1	SET 7,(HL)
 114++8BE1 CB 46        CHL2	BIT 0,(HL)
 115++8BE3 C8           	RET Z
 116++8BE4 E1           	POP HL
 117++8BE5 FD 34 09     	INC (IY-100+VRS.DelyCnt)
 118++8BE8 FD 34 BA     	INC (IY-100+VRS.ChanA+CHP.NtSkCn)
 119++8BEB AF           	XOR A
 120++8BEC FD 77 1D     	LD (IY-100+VRS.AYREGS+AmplA),A
 121++8BEF FD 77 1E     	LD (IY-100+VRS.AYREGS+AmplB),A
 122++8BF2 FD 77 1F     	LD (IY-100+VRS.AYREGS+AmplC),A
 123++8BF5 C9           	RET
 124++8BF6              	ENDIF
 125++8BF6
 126++8BF6 AF           MUTE: XOR A
 127++8BF7 67           	LD H,A
 128++8BF8 6F           	LD L,A
 129++8BF9 32 80 95     	LD (VARS1+VRS.AYREGS+AmplA),A
 130++8BFC 22 81 95     	LD (VARS1+VRS.AYREGS+AmplB),HL
 131++8BFF 32 07 96     	LD (VARS2+VRS.AYREGS+AmplA),A
 132++8C02 22 08 96     	LD (VARS2+VRS.AYREGS+AmplB),HL
 133++8C05 C3 43 94     	JP ROUT
 134++8C08
 135++8C08              INIT:
 136++8C08              ;HL - AddressOfModule
 137++8C08              ;DE - AddresOf2ndModule
 138++8C08 D5           	PUSH DE
 139++8C09 E5           	PUSH HL
 140++8C0A 21 FE 94     	LD HL,VARS
 141++8C0D 36 00        	LD (HL),0
 142++8C0F 11 FF 94     	LD DE,VARS+1
 143++8C12 01 0E 01     	LD BC,VAR0END-VARS-1
 144++8C15 ED B0        	LDIR
 145++8C17 23           	INC HL
 146++8C18 22 61 95     	LD (VARS1+VRS.AdInPtA),HL ;ptr to zero
 147++8C1B 22 E8 95     	LD (VARS2+VRS.AdInPtA),HL
 148++8C1E
 149++8C1E E1           	POP HL
 150++8C1F FD 21 63 95  	LD IY,VARS1+100
 151++8C23 3A D1 8B     	LD A,(START+10)
 152++8C26 E6 02        	AND 2
 153++8C28 C2 B1 8C     	JP NZ,I_PT2
 154++8C2B
 155++8C2B CD FE 8D     	CALL INITPT3
 156++8C2E 21 18 1F     	LD HL,(e_-SamCnv-2)*256+#18
 157++8C31 22 D1 91     	LD (SamCnv),HL
 158++8C34 3E BA        	LD A,#BA
 159++8C36 32 9C 91     	LD (OrnCP),A
 160++8C39 32 C8 91     	LD (SamCP),A
 161++8C3C 3E 7B        	LD A,#7B
 162++8C3E 32 9F 91     	LD (OrnLD),A
 163++8C41 32 CB 91     	LD (SamLD),A
 164++8C44 3E 87        	LD A,#87
 165++8C46 32 C2 91     	LD (SamClc2),A
 166++8C49 E1           	POP HL
 167++8C4A              	;Use version and ton table of 1st module
 168++8C4A DD 7E A9     	LD A,(IX+13-100) ;EXTRACT VERSION NUMBER
 169++8C4D D6 30        	SUB #30
 170++8C4F 38 04        	JR C,L20
 171++8C51 FE 0A        	CP 10
 172++8C53 38 02        	JR C,L21
 173++8C55 3E 06        L20	LD A,6
 174++8C57 32 6F 90     L21	LD (Version),A
 175++8C5A F5           	PUSH AF ;VolTable version
 176++8C5B FE 04        	CP 4
 177++8C5D DD 7E FF     	LD A,(IX+99-100) ;TONE TABLE NUMBER
 178++8C60 17           	RLA
 179++8C61 E6 07        	AND 7
 180++8C63 F5           	PUSH AF ;NoteTable number
 181++8C64
 182++8C64 FD 21 EA 95  	LD IY,VARS2+100
 183++8C68 3A D1 8B     	LD A,(START+10)
 184++8C6B E6 30        	AND 48
 185++8C6D 28 37        	JR Z,NOTS
 186++8C6F FE 10        	CP 16
 187++8C71 28 27        	JR Z,TwoPT3s
 188++8C73 3A 6F 90     	LD A,(Version)
 189++8C76 FE 07        	CP 7
 190++8C78 38 2C        	JR C,NOTS
 191++8C7A DD 7E FE     	LD A,(IX+98-100) ;ALCO TS MARKER
 192++8C7D FE 20        	CP #20
 193++8C7F 28 25        	JR Z,NOTS
 194++8C81 21 FF 94     	LD HL,VARS1
 195++8C84 11 86 95     	LD DE,VARS2
 196++8C87 01 87 00     	LD BC,VRS
 197++8C8A ED B0        	LDIR
 198++8C8C FD CB 9E CE  	SET 1,(IY-100+VRS.ModNum)
 199++8C90 4F           	LD C,A
 200++8C91 87           	ADD A,A
 201++8C92 81           	ADD A,C
 202++8C93 D6 02        	SUB 2
 203++8C95 32 36 93     	LD (TSSub),A
 204++8C98 18 03        	JR AlCoTS_
 205++8C9A CD FE 8D     TwoPT3s	CALL INITPT3
 206++8C9D 3E 01        AlCoTS_	LD A,1
 207++8C9F 32 FE 94     	LD (is_ts),A
 208++8CA2 FD CB 9E C6  	SET 0,(IY-100+VRS.ModNum)
 209++8CA6
 210++8CA6 01 BB 8F     NOTS	LD BC,PT3PD
 211++8CA9 21 00 00     	LD HL,0
 212++8CAC 11 C6 94     	LD DE,PT3EMPTYORN
 213++8CAF 18 48        	JR INITCOMMON
 214++8CB1
 215++8CB1 CD 36 8E     I_PT2	CALL INITPT2
 216++8CB4 21 CB 51     	LD HL,#51CB
 217++8CB7 22 D1 91     	LD (SamCnv),HL
 218++8CBA 3E BB        	LD A,#BB
 219++8CBC 32 9C 91     	LD (OrnCP),A
 220++8CBF 32 C8 91     	LD (SamCP),A
 221++8CC2 3E 7A        	LD A,#7A
 222++8CC4 32 9F 91     	LD (OrnLD),A
 223++8CC7 32 CB 91     	LD (SamLD),A
 224++8CCA 3E 80        	LD A,#80
 225++8CCC 32 C2 91     	LD (SamClc2),A
 226++8CCF E1           	POP HL
 227++8CD0 3E 05        	LD A,5
 228++8CD2 32 6F 90     	LD (Version),A
 229++8CD5 F5           	PUSH AF
 230++8CD6 3E 02        	LD A,2
 231++8CD8 F5           	PUSH AF
 232++8CD9
 233++8CD9 3A D1 8B     	LD A,(START+10)
 234++8CDC E6 30        	AND 48
 235++8CDE 28 10        	JR Z,NOTS2
 236++8CE0
 237++8CE0 FD 21 EA 95  	LD IY,VARS2+100
 238++8CE4 3E 01        	LD A,1
 239++8CE6 32 FE 94     	LD (is_ts),A
 240++8CE9 FD CB 9E C6  	SET 0,(IY-100+VRS.ModNum)
 241++8CED CD 36 8E     	CALL INITPT2
 242++8CF0
 243++8CF0 01 F5 8E     NOTS2	LD BC,PT2PD
 244++8CF3 21 87 86     	LD HL,#8687
 245++8CF6 11 1C 96     	LD DE,PT2EMPTYORN
 246++8CF9
 247++8CF9              INITCOMMON
 248++8CF9
 249++8CF9              	IF Basic
 250++8CF9 FD 21 3A 5C  	LD IY,#5C3A
 251++8CFD              	ENDIF
 252++8CFD
 253++8CFD ED 43 A6 8E  	LD (PTDEC),BC
 254++8D01 22 38 93     	LD (PsCalc),HL
 255++8D04 D5           	PUSH DE
 256++8D05
 257++8D05              ;note table data depacker
 258++8D05              ;(c) Ivan Roshin
 259++8D05 11 C9 94     	LD DE,T_PACK
 260++8D08 01 6E 96     	LD BC,T1_+(2*49)-1
 261++8D0B 1A           TP_0	LD A,(DE)
 262++8D0C 13           	INC DE
 263++8D0D FE 1E        	CP 15*2
 264++8D0F 30 06        	JR NC,TP_1
 265++8D11 67           	LD H,A
 266++8D12 1A           	LD A,(DE)
 267++8D13 6F           	LD L,A
 268++8D14 13           	INC DE
 269++8D15 18 07        	JR TP_2
 270++8D17 D5           TP_1	PUSH DE
 271++8D18 16 00        	LD D,0
 272++8D1A 5F           	LD E,A
 273++8D1B 19           	ADD HL,DE
 274++8D1C 19           	ADD HL,DE
 275++8D1D D1           	POP DE
 276++8D1E 7C           TP_2	LD A,H
 277++8D1F 02           	LD (BC),A
 278++8D20 0B           	DEC BC
 279++8D21 7D           	LD A,L
 280++8D22 02           	LD (BC),A
 281++8D23 0B           	DEC BC
player.asm(282): warning: value 0x1F0 is truncated to 8bit value: 0xF0
 282++8D24 D6 F0        	SUB #F8*2
 283++8D26 20 E3        	JR NZ,TP_0
 284++8D28
 285++8D28 3C           	INC A
 286++8D29 32 6C 95     	LD (VARS1+VRS.DelyCnt),A
 287++8D2C 32 F3 95     	LD (VARS2+VRS.DelyCnt),A
 288++8D2F 21 01 F0     	LD HL,#F001 ;H - CHP.Volume, L - CHP.NtSkCn
 289++8D32 22 1D 95     	LD (VARS1+VRS.ChanA+CHP.NtSkCn),HL
 290++8D35 22 3A 95     	LD (VARS1+VRS.ChanB+CHP.NtSkCn),HL
 291++8D38 22 57 95     	LD (VARS1+VRS.ChanC+CHP.NtSkCn),HL
 292++8D3B 22 A4 95     	LD (VARS2+VRS.ChanA+CHP.NtSkCn),HL
 293++8D3E 22 C1 95     	LD (VARS2+VRS.ChanB+CHP.NtSkCn),HL
 294++8D41 22 DE 95     	LD (VARS2+VRS.ChanC+CHP.NtSkCn),HL
 295++8D44 E1           	POP HL
 296++8D45 22 0F 95     	LD (VARS1+VRS.ChanA+CHP.OrnPtr),HL
 297++8D48 22 2C 95     	LD (VARS1+VRS.ChanB+CHP.OrnPtr),HL
 298++8D4B 22 49 95     	LD (VARS1+VRS.ChanC+CHP.OrnPtr),HL
 299++8D4E 22 96 95     	LD (VARS2+VRS.ChanA+CHP.OrnPtr),HL
 300++8D51 22 B3 95     	LD (VARS2+VRS.ChanB+CHP.OrnPtr),HL
 301++8D54 22 D0 95     	LD (VARS2+VRS.ChanC+CHP.OrnPtr),HL
 302++8D57
 303++8D57 F1           	POP AF
 304++8D58
 305++8D58              ;NoteTableCreator (c) Ivan Roshin
 306++8D58              ;A - NoteTableNumber*2+VersionForNoteTable
 307++8D58              ;(xx1b - 3.xx..3.4r, xx0b - 3.4x..3.6x..VTII1.0)
 308++8D58
 309++8D58 21 76 94     	LD HL,NT_DATA
 310++8D5B 16 00        	LD D,0
 311++8D5D 87           	ADD A,A
 312++8D5E 5F           	LD E,A
 313++8D5F 19           	ADD HL,DE
 314++8D60 5E           	LD E,(HL)
 315++8D61 23           	INC HL
 316++8D62 CB 3B        	SRL E
 317++8D64 9F           	SBC A,A
 318++8D65 E6 A7        	AND #A7 ;#00 (NOP) or #A7 (AND A)
 319++8D67 32 8F 8D     	LD (L3),A
 320++8D6A EB           	EX DE,HL
 321++8D6B 01 0D 96     	LD BC,T1_
 322++8D6E 09           	ADD HL,BC
 323++8D6F
 324++8D6F 1A           	LD A,(DE)
player.asm(325): warning: value 0x9486 is truncated to 8bit value: 0x86
 325++8D70 C6 86        	ADD A,T_
 326++8D72 4F           	LD C,A
 327++8D73 CE 94        	ADC A,T_/256
 328++8D75 91           	SUB C
 329++8D76 47           	LD B,A
 330++8D77 C5           	PUSH BC
 331++8D78 11 FD 96     	LD DE,NT_
 332++8D7B D5           	PUSH DE
 333++8D7C
 334++8D7C 06 0C        	LD B,12
 335++8D7E C5           L1	PUSH BC
 336++8D7F 4E           	LD C,(HL)
 337++8D80 23           	INC HL
 338++8D81 E5           	PUSH HL
 339++8D82 46           	LD B,(HL)
 340++8D83
 341++8D83 D5           	PUSH DE
 342++8D84 EB           	EX DE,HL
 343++8D85 11 17 00     	LD DE,23
 344++8D88 DD 26 08     	LD IXH,8
 345++8D8B
 346++8D8B CB 38        L2	SRL B
 347++8D8D CB 19        	RR C
 348++8D8F 19           L3	DB #19	;AND A or NOP
 349++8D90 79           	LD A,C
 350++8D91 8A           	ADC A,D	;=ADC 0
 351++8D92 77           	LD (HL),A
 352++8D93 23           	INC HL
 353++8D94 78           	LD A,B
 354++8D95 8A           	ADC A,D
 355++8D96 77           	LD (HL),A
 356++8D97 19           	ADD HL,DE
 357++8D98 DD 25        	DEC IXH
 358++8D9A 20 EF        	JR NZ,L2
 359++8D9C
 360++8D9C D1           	POP DE
 361++8D9D 13           	INC DE
 362++8D9E 13           	INC DE
 363++8D9F E1           	POP HL
 364++8DA0 23           	INC HL
 365++8DA1 C1           	POP BC
 366++8DA2 10 DA        	DJNZ L1
 367++8DA4
 368++8DA4 E1           	POP HL
 369++8DA5 D1           	POP DE
 370++8DA6
 371++8DA6 7B           	LD A,E
player.asm(372): warning: value 0x9492 is truncated to 8bit value: 0x92
 372++8DA7 FE 92        	CP TCOLD_1
 373++8DA9 20 05        	JR NZ,CORR_1
 374++8DAB 3E FD        	LD A,#FD
 375++8DAD 32 2B 97     	LD (NT_+#2E),A
 376++8DB0
 377++8DB0 1A           CORR_1	LD A,(DE)
 378++8DB1 A7           	AND A
 379++8DB2 28 11        	JR Z,TC_EXIT
 380++8DB4 1F           	RRA
 381++8DB5 F5           	PUSH AF
 382++8DB6 87           	ADD A,A
 383++8DB7 4F           	LD C,A
 384++8DB8 09           	ADD HL,BC
 385++8DB9 F1           	POP AF
 386++8DBA 30 02        	JR NC,CORR_2
 387++8DBC 35           	DEC (HL)
 388++8DBD 35           	DEC (HL)
 389++8DBE 34           CORR_2	INC (HL)
 390++8DBF A7           	AND A
 391++8DC0 ED 42        	SBC HL,BC
 392++8DC2 13           	INC DE
 393++8DC3 18 EB        	JR CORR_1
 394++8DC5
 395++8DC5              TC_EXIT
 396++8DC5
 397++8DC5 F1           	POP AF
 398++8DC6
 399++8DC6              ;VolTableCreator (c) Ivan Roshin
 400++8DC6              ;A - VersionForVolumeTable (0..4 - 3.xx..3.4x;
 401++8DC6              			   ;5.. - 2.x,3.5x..3.6x..VTII1.0)
 402++8DC6
 403++8DC6 FE 05        	CP 5
 404++8DC8 21 11 00     	LD HL,#11
 405++8DCB 54           	LD D,H
 406++8DCC 5C           	LD E,H
 407++8DCD 3E 17        	LD A,#17
 408++8DCF 30 03        	JR NC,M1
 409++8DD1 2D           	DEC L
 410++8DD2 5D           	LD E,L
 411++8DD3 AF           	XOR A
 412++8DD4 32 E5 8D     M1      LD (M2),A
 413++8DD7
 414++8DD7 DD 21 0D 96  	LD IX,VT_+16
 415++8DDB
 416++8DDB 0E 0F        	LD C,#F
 417++8DDD E5           INITV2  PUSH HL
 418++8DDE
 419++8DDE 19           	ADD HL,DE
 420++8DDF EB           	EX DE,HL
 421++8DE0 ED 62        	SBC HL,HL
 422++8DE2
 423++8DE2 06 10        	LD B,#10
 424++8DE4 7D           INITV1  LD A,L
 425++8DE5 7D           M2      DB #7D
 426++8DE6 7C           	LD A,H
 427++8DE7 CE 00        	ADC A,0
 428++8DE9 DD 77 00     	LD (IX),A
 429++8DEC DD 23        	INC IX
 430++8DEE 19           	ADD HL,DE
 431++8DEF 10 F3        	DJNZ INITV1
 432++8DF1
 433++8DF1 E1           	POP HL
 434++8DF2 7B           	LD A,E
 435++8DF3 FE 77        	CP #77
 436++8DF5 20 01        	JR NZ,M3
 437++8DF7 1C           	INC E
 438++8DF8 0D           M3      DEC C
 439++8DF9 20 E2        	JR NZ,INITV2
 440++8DFB
 441++8DFB C3 43 94     	JP ROUT
 442++8DFE
 443++8DFE CD 71 8E     INITPT3	CALL SETMDAD
 444++8E01 E5           	PUSH HL
 445++8E02 11 64 00     	LD DE,100
 446++8E05 19           	ADD HL,DE
 447++8E06 7E           	LD A,(HL)
 448++8E07 FD 77 08     	LD (IY-100+VRS.Delay),A
 449++8E0A E5           	PUSH HL
 450++8E0B DD E1        	POP IX
 451++8E0D 19           	ADD HL,DE
 452++8E0E CD 7F 8E     	CALL SETCPPT
 453++8E11 DD 5E 02     	LD E,(IX+102-100)
 454++8E14 23           	INC HL
 455++8E15
 456++8E15              	IF CurPosCounter
 457++8E15 ~            	LD (IY-100+VRS.PosSub),L
 458++8E15              	ENDIF
 459++8E15
 460++8E15 19           	ADD HL,DE
 461++8E16 CD 86 8E     	CALL SETLPPT
 462++8E19 D1           	POP DE
 463++8E1A DD 6E 03     	LD L,(IX+103-100)
 464++8E1D DD 66 04     	LD H,(IX+104-100)
 465++8E20 19           	ADD HL,DE
 466++8E21 CD 6A 8E     	CALL SETPTPT
 467++8E24 21 A9 00     	LD HL,169
 468++8E27 19           	ADD HL,DE
 469++8E28 CD 78 8E     	CALL SETORPT
 470++8E2B 21 69 00     	LD HL,105
 471++8E2E 19           	ADD HL,DE
 472++8E2F
 473++8E2F FD 75 FA     SETSMPT LD (IY-100+VRS.SamPtrs),L
 474++8E32 FD 74 FB     	LD (IY-100+VRS.SamPtrs+1),H
 475++8E35 C9           	RET
 476++8E36
 477++8E36 7E           INITPT2	LD A,(HL)
 478++8E37 FD 77 08     	LD (IY-100+VRS.Delay),A
 479++8E3A E5           	PUSH HL
 480++8E3B E5           	PUSH HL
 481++8E3C E5           	PUSH HL
 482++8E3D 23           	INC HL
 483++8E3E 23           	INC HL
 484++8E3F 7E           	LD A,(HL)
 485++8E40 23           	INC HL
 486++8E41 CD 2F 8E     	CALL SETSMPT
 487++8E44 5E           	LD E,(HL)
 488++8E45 23           	INC HL
 489++8E46 56           	LD D,(HL)
 490++8E47 E1           	POP HL
 491++8E48 A7           	AND A
 492++8E49 ED 52        	SBC HL,DE
 493++8E4B CD 71 8E     	CALL SETMDAD
 494++8E4E E1           	POP HL
 495++8E4F 11 43 00     	LD DE,67
 496++8E52 19           	ADD HL,DE
 497++8E53 CD 78 8E     	CALL SETORPT
 498++8E56 1E 20        	LD E,32
 499++8E58 19           	ADD HL,DE
 500++8E59 4E           	LD C,(HL)
 501++8E5A 23           	INC HL
 502++8E5B 46           	LD B,(HL)
 503++8E5C 1E 1E        	LD E,30
 504++8E5E 19           	ADD HL,DE
 505++8E5F CD 7F 8E     	CALL SETCPPT
 506++8E62 5F           	LD E,A
 507++8E63 23           	INC HL
 508++8E64
 509++8E64              	IF CurPosCounter
 510++8E64 ~            	LD (IY-100+VRS.PosSub),L
 511++8E64              	ENDIF
 512++8E64
 513++8E64 19           	ADD HL,DE
 514++8E65 CD 86 8E     	CALL SETLPPT
 515++8E68 E1           	POP HL
 516++8E69 09           	ADD HL,BC
 517++8E6A
 518++8E6A FD 75 FC     SETPTPT	LD (IY-100+VRS.PatsPtr),L
 519++8E6D FD 74 FD     	LD (IY-100+VRS.PatsPtr+1),H
 520++8E70 C9           	RET
 521++8E71
 522++8E71 FD 75 F6     SETMDAD	LD (IY-100+VRS.MODADDR),L
 523++8E74 FD 74 F7     	LD (IY-100+VRS.MODADDR+1),H
 524++8E77 C9           	RET
 525++8E78
 526++8E78 FD 75 F8     SETORPT	LD (IY-100+VRS.OrnPtrs),L
 527++8E7B FD 74 F9     	LD (IY-100+VRS.OrnPtrs+1),H
 528++8E7E C9           	RET
 529++8E7F
 530++8E7F FD 75 04     SETCPPT	LD (IY-100+VRS.CrPsPtr),L
 531++8E82 FD 74 05     	LD (IY-100+VRS.CrPsPtr+1),H
 532++8E85 C9           	RET
 533++8E86
 534++8E86 FD 75 06     SETLPPT	LD (IY-100+VRS.LPosPtr),L
 535++8E89 FD 74 07     	LD (IY-100+VRS.LPosPtr+1),H
 536++8E8C C9           	RET
 537++8E8D
 538++8E8D FD 75 13     SETENBS	LD (IY-100+VRS.EnvBase),L
 539++8E90 FD 74 14     	LD (IY-100+VRS.EnvBase+1),H
 540++8E93 C9           	RET
 541++8E94
 542++8E94 FD 75 0C     SETESLD	LD (IY-100+VRS.CurESld),L
 543++8E97 FD 74 0D     	LD (IY-100+VRS.CurESld+1),H
 544++8E9A C9           	RET
 545++8E9B
 546++8E9B FD E5        GETIX	PUSH IY
 547++8E9D DD E1        	POP IX
 548++8E9F DD 19        	ADD IX,DE
 549++8EA1 C9           	RET
 550++8EA2
 551++8EA2 CD 9B 8E     PTDECOD CALL GETIX
 552++8EA5              PTDEC	EQU $+1
 553++8EA5 C3 C3 C3     	JP #C3C3
 554++8EA8
 555++8EA8              ;PT2 pattern decoder
 556++8EA8 CD 3E 91     PD2_SAM	CALL SETSAM
 557++8EAB 18 4A        	JR PD2_LOOP
 558++8EAD
 559++8EAD DD 77 08     PD2_EOff LD (IX-12+CHP.Env_En),A
 560++8EB0 18 45        	JR PD2_LOOP
 561++8EB2
 562++8EB2 DD 36 08 10  PD2_ENV	LD (IX-12+CHP.Env_En),16
 563++8EB6 FD 77 22     	LD (IY-100+VRS.AYREGS+EnvTp),A
 564++8EB9 0A           	LD A,(BC)
 565++8EBA 03           	INC BC
 566++8EBB 6F           	LD L,A
 567++8EBC 0A           	LD A,(BC)
 568++8EBD 03           	INC BC
 569++8EBE 67           	LD H,A
 570++8EBF CD 8D 8E     	CALL SETENBS
 571++8EC2 18 33        	JR PD2_LOOP
 572++8EC4
 573++8EC4 CD 1F 91     PD2_ORN	CALL SETORN
 574++8EC7 18 2E        	JR PD2_LOOP
 575++8EC9
 576++8EC9 3C           PD2_SKIP INC A
 577++8ECA DD 77 05     	LD (IX-12+CHP.NNtSkp),A
 578++8ECD 18 28        	JR PD2_LOOP
 579++8ECF
 580++8ECF 0F           PD2_VOL	RRCA
 581++8ED0 0F           	RRCA
 582++8ED1 0F           	RRCA
 583++8ED2 0F           	RRCA
 584++8ED3 DD 77 10     	LD (IX-12+CHP.Volume),A
 585++8ED6 18 1F        	JR PD2_LOOP
 586++8ED8
 587++8ED8 CD EF 90     PD2_DEL	CALL C_DELAY
 588++8EDB 18 1A        	JR PD2_LOOP
 589++8EDD
 590++8EDD DD CB 09 D6  PD2_GLIS SET 2,(IX-12+CHP.Flags)
 591++8EE1 3C           	INC A
 592++8EE2 DD 77 0A     	LD (IX-12+CHP.TnSlDl),A
 593++8EE5 DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 594++8EE8 0A           	LD A,(BC)
 595++8EE9 03           	INC BC
 596++8EEA DD 77 0B             LD (IX-12+CHP.TSlStp),A
 597++8EED 87           	ADD A,A
 598++8EEE 9F           	SBC A,A
 599++8EEF DD 77 0C             LD (IX-12+CHP.TSlStp+1),A
 600++8EF2 37           	SCF
 601++8EF3 18 01        	JR PD2_LP2
 602++8EF5
 603++8EF5 A7           PT2PD	AND A
 604++8EF6
 605++8EF6 08           PD2_LP2	EX AF,AF'
 606++8EF7
 607++8EF7 0A           PD2_LOOP LD A,(BC)
 608++8EF8 03           	INC BC
 609++8EF9 C6 20        	ADD A,#20
 610++8EFB 28 3F        	JR Z,PD2_REL
 611++8EFD 38 A9        	JR C,PD2_SAM
 612++8EFF C6 60        	ADD A,96
 613++8F01 38 3E        	JR C,PD2_NOTE
 614++8F03 3C           	INC A
 615++8F04 28 A7        	JR Z,PD2_EOff
 616++8F06 C6 0F        	ADD A,15
 617++8F08 CA 1E 90     	JP Z,PD_FIN
 618++8F0B 38 A5        	JR C,PD2_ENV
 619++8F0D C6 10        	ADD A,#10
 620++8F0F 38 B3        	JR C,PD2_ORN
 621++8F11 C6 40        	ADD A,#40
 622++8F13 38 B4        	JR C,PD2_SKIP
 623++8F15 C6 10        	ADD A,#10
 624++8F17 38 B6        	JR C,PD2_VOL
 625++8F19 3C           	INC A
 626++8F1A 28 BC        	JR Z,PD2_DEL
 627++8F1C 3C           	INC A
 628++8F1D 28 BE        	JR Z,PD2_GLIS
 629++8F1F 3C           	INC A
 630++8F20 28 0A        	JR Z,PD2_PORT
 631++8F22 3C           	INC A
 632++8F23 28 12        	JR Z,PD2_STOP
 633++8F25 0A           	LD A,(BC)
 634++8F26 03           	INC BC
 635++8F27 DD 77 F7     	LD (IX-12+CHP.CrNsSl),A
 636++8F2A 18 CB        	JR PD2_LOOP
 637++8F2C
 638++8F2C DD CB 09 96  PD2_PORT RES 2,(IX-12+CHP.Flags)
 639++8F30 0A           	LD A,(BC)
 640++8F31 03           	INC BC
 641++8F32 03           	INC BC ;ignoring precalc delta to right sound
 642++8F33 03           	INC BC
 643++8F34 37           	SCF
 644++8F35 18 BF        	JR PD2_LP2
 645++8F37
 646++8F37 DD 77 F9     PD2_STOP LD (IX-12+CHP.TSlCnt),A
 647++8F3A 18 BB        	JR PD2_LOOP
 648++8F3C
 649++8F3C DD 77 09     PD2_REL	LD (IX-12+CHP.Flags),A
 650++8F3F 18 2C        	JR PD2_EXIT
 651++8F41
 652++8F41 6F           PD2_NOTE LD L,A
 653++8F42 DD 7E 06     	LD A,(IX-12+CHP.Note)
 654++8F45 32 58 90     	LD (PrNote+1),A
 655++8F48 DD 75 06     	LD (IX-12+CHP.Note),L
 656++8F4B AF           	XOR A
 657++8F4C DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 658++8F4F DD CB 09 C6  	SET 0,(IX-12+CHP.Flags)
 659++8F53 08           	EX AF,AF'
 660++8F54 30 16        	JR NC,NOGLIS2
 661++8F56 DD CB 09 56  	BIT 2,(IX-12+CHP.Flags)
 662++8F5A 20 0C        	JR NZ,NOPORT2
 663++8F5C 32 7E 90     	LD (LoStep),A
 664++8F5F 87           	ADD A,A
 665++8F60 9F           	SBC A,A
 666++8F61 08           	EX AF,AF'
 667++8F62 67           	LD H,A
 668++8F63 6F           	LD L,A
 669++8F64 3C           	INC A
 670++8F65 CD 39 90     	CALL SETPORT
 671++8F68 DD 36 F9 01  NOPORT2	LD (IX-12+CHP.TSlCnt),1
 672++8F6C AF           NOGLIS2	XOR A
 673++8F6D
 674++8F6D
 675++8F6D DD 77 F5     PD2_EXIT LD (IX-12+CHP.PsInSm),A
 676++8F70 DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 677++8F73 DD 77 FA     	LD (IX-12+CHP.CrTnSl),A
 678++8F76 DD 77 FB     	LD (IX-12+CHP.CrTnSl+1),A
 679++8F79 C3 1E 90     	JP PD_FIN
 680++8F7C
 681++8F7C              ;PT3 pattern decoder
 682++8F7C DD 36 08 00  PD_OrSm	LD (IX-12+CHP.Env_En),0
 683++8F80 CD 1F 91     	CALL SETORN
 684++8F83 0A           PD_SAM_	LD A,(BC)
 685++8F84 03           	INC BC
 686++8F85 0F           	RRCA
 687++8F86
 688++8F86 CD 3E 91     PD_SAM	CALL SETSAM
 689++8F89 18 3F        	JR PD_LOOP
 690++8F8B
 691++8F8B 0F           PD_VOL	RRCA
 692++8F8C 0F           	RRCA
 693++8F8D 0F           	RRCA
 694++8F8E 0F           	RRCA
 695++8F8F DD 77 10     	LD (IX-12+CHP.Volume),A
 696++8F92 18 39        	JR PD_LP2
 697++8F94
 698++8F94 DD 77 08     PD_EOff	LD (IX-12+CHP.Env_En),A
 699++8F97 DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 700++8F9A 18 31        	JR PD_LP2
 701++8F9C
 702++8F9C 3D           PD_SorE	DEC A
 703++8F9D 20 07        	JR NZ,PD_ENV
 704++8F9F 0A           	LD A,(BC)
 705++8FA0 03           	INC BC
 706++8FA1 DD 77 05     	LD (IX-12+CHP.NNtSkp),A
 707++8FA4 18 27        	JR PD_LP2
 708++8FA6
 709++8FA6 CD 04 91     PD_ENV	CALL SETENV
 710++8FA9 18 22        	JR PD_LP2
 711++8FAB
 712++8FAB CD 1F 91     PD_ORN	CALL SETORN
 713++8FAE 18 1A        	JR PD_LOOP
 714++8FB0
 715++8FB0 DD 77 08     PD_ESAM	LD (IX-12+CHP.Env_En),A
 716++8FB3 DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 717++8FB6 C4 04 91     	CALL NZ,SETENV
 718++8FB9 18 C8        	JR PD_SAM_
 719++8FBB
 720++8FBB DD 7E 06     PT3PD	LD A,(IX-12+CHP.Note)
 721++8FBE 32 58 90     	LD (PrNote+1),A
 722++8FC1 DD 6E FA     	LD L,(IX-12+CHP.CrTnSl)
 723++8FC4 DD 66 FB     	LD H,(IX-12+CHP.CrTnSl+1)
 724++8FC7 22 75 90     	LD (PrSlide+1),HL
 725++8FCA
 726++8FCA 11 10 20     PD_LOOP	LD DE,#2010
 727++8FCD 0A           PD_LP2	LD A,(BC)
 728++8FCE 03           	INC BC
 729++8FCF 83           	ADD A,E
 730++8FD0 38 AA        	JR C,PD_OrSm
 731++8FD2 82           	ADD A,D
 732++8FD3 28 49        	JR Z,PD_FIN
 733++8FD5 38 AF        	JR C,PD_SAM
 734++8FD7 83           	ADD A,E
 735++8FD8 28 25        	JR Z,PD_REL
 736++8FDA 38 AF        	JR C,PD_VOL
 737++8FDC 83           	ADD A,E
 738++8FDD 28 B5        	JR Z,PD_EOff
 739++8FDF 38 BB        	JR C,PD_SorE
 740++8FE1 C6 60        	ADD A,96
 741++8FE3 38 20        	JR C,PD_NOTE
 742++8FE5 83           	ADD A,E
 743++8FE6 38 C3        	JR C,PD_ORN
 744++8FE8 82           	ADD A,D
 745++8FE9 38 0F        	JR C,PD_NOIS
 746++8FEB 83           	ADD A,E
 747++8FEC 38 C2        	JR C,PD_ESAM
 748++8FEE 87           	ADD A,A
 749++8FEF 5F           	LD E,A
player.asm(750): warning: value 0x1707A is truncated to 16bit value: 0x707A
 750++8FF0 21 7A 70     	LD HL,SPCCOMS+#FF20-#2000
 751++8FF3 19           	ADD HL,DE
 752++8FF4 5E           	LD E,(HL)
 753++8FF5 23           	INC HL
 754++8FF6 56           	LD D,(HL)
 755++8FF7 D5           	PUSH DE
 756++8FF8 18 D0        	JR PD_LOOP
 757++8FFA
 758++8FFA FD 77 10     PD_NOIS	LD (IY-100+VRS.Ns_Base),A
 759++8FFD 18 CE        	JR PD_LP2
 760++8FFF
 761++8FFF DD CB 09 86  PD_REL	RES 0,(IX-12+CHP.Flags)
 762++9003 18 08        	JR PD_RES
 763++9005
 764++9005 DD 77 06     PD_NOTE	LD (IX-12+CHP.Note),A
 765++9008 DD CB 09 C6  	SET 0,(IX-12+CHP.Flags)
 766++900C AF           	XOR A
 767++900D
 768++900D ED 73 1C 90  PD_RES	LD (PDSP_+1),SP
 769++9011 DD F9        	LD SP,IX
 770++9013 67           	LD H,A
 771++9014 6F           	LD L,A
 772++9015 E5           	PUSH HL
 773++9016 E5           	PUSH HL
 774++9017 E5           	PUSH HL
 775++9018 E5           	PUSH HL
 776++9019 E5           	PUSH HL
 777++901A E5           	PUSH HL
 778++901B 31 31 31     PDSP_	LD SP,#3131
 779++901E
 780++901E DD 7E 05     PD_FIN	LD A,(IX-12+CHP.NNtSkp)
 781++9021 DD 77 0F     	LD (IX-12+CHP.NtSkCn),A
 782++9024 C9           	RET
 783++9025
 784++9025 0A           C_PORTM LD A,(BC)
 785++9026 03           	INC BC
 786++9027              ;SKIP PRECALCULATED TONE DELTA (BECAUSE
 787++9027              ;CANNOT BE RIGHT AFTER PT3 COMPILATION)
 788++9027 03           	INC BC
 789++9028 03           	INC BC
 790++9029 08           	EX AF,AF'
 791++902A 0A           	LD A,(BC) ;SIGNED TONE STEP
 792++902B 03           	INC BC
 793++902C 32 7E 90     	LD (LoStep),A
 794++902F 0A           	LD A,(BC)
 795++9030 03           	INC BC
 796++9031 A7           	AND A
 797++9032 08           	EX AF,AF'
 798++9033 DD 6E FA     	LD L,(IX-12+CHP.CrTnSl)
 799++9036 DD 66 FB     	LD H,(IX-12+CHP.CrTnSl+1)
 800++9039
 801++9039              ;Set portamento variables
 802++9039              ;A - Delay; A' - Hi(Step); ZF' - (A'=0); HL - CrTnSl
 803++9039
 804++9039 DD CB 09 96  SETPORT	RES 2,(IX-12+CHP.Flags)
 805++903D DD 77 0A     	LD (IX-12+CHP.TnSlDl),A
 806++9040 DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 807++9043 E5           	PUSH HL
 808++9044 11 FD 96     	LD DE,NT_
 809++9047 DD 7E 06     	LD A,(IX-12+CHP.Note)
 810++904A DD 77 07     	LD (IX-12+CHP.SlToNt),A
 811++904D 87           	ADD A,A
 812++904E 6F           	LD L,A
 813++904F 26 00        	LD H,0
 814++9051 19           	ADD HL,DE
 815++9052 7E           	LD A,(HL)
 816++9053 23           	INC HL
 817++9054 66           	LD H,(HL)
 818++9055 6F           	LD L,A
 819++9056 E5           	PUSH HL
 820++9057 3E 3E        PrNote	LD A,#3E
 821++9059 DD 77 06     	LD (IX-12+CHP.Note),A
 822++905C 87           	ADD A,A
 823++905D 6F           	LD L,A
 824++905E 26 00        	LD H,0
 825++9060 19           	ADD HL,DE
 826++9061 5E           	LD E,(HL)
 827++9062 23           	INC HL
 828++9063 56           	LD D,(HL)
 829++9064 E1           	POP HL
 830++9065 ED 52        	SBC HL,DE
 831++9067 DD 75 0D     	LD (IX-12+CHP.TnDelt),L
 832++906A DD 74 0E     	LD (IX-12+CHP.TnDelt+1),H
 833++906D D1           	POP DE
 834++906E              Version EQU $+1
 835++906E 3E 3E        	LD A,#3E
 836++9070 FE 06        	CP 6
 837++9072 38 09        	JR C,OLDPRTM ;Old 3xxx for PT v3.5-
 838++9074 11 11 11     PrSlide	LD DE,#1111
 839++9077 DD 73 FA     	LD (IX-12+CHP.CrTnSl),E
 840++907A DD 72 FB     	LD (IX-12+CHP.CrTnSl+1),D
 841++907D              LoStep	EQU $+1
 842++907D 3E 3E        OLDPRTM	LD A,#3E
 843++907F 08           	EX AF,AF'
 844++9080 28 01        	JR Z,NOSIG
 845++9082 EB           	EX DE,HL
 846++9083 ED 52        NOSIG	SBC HL,DE
 847++9085 F2 8D 90     	JP P,SET_STP
 848++9088 2F           	CPL
 849++9089 08           	EX AF,AF'
 850++908A ED 44        	NEG
 851++908C 08           	EX AF,AF'
 852++908D DD 77 0C     SET_STP	LD (IX-12+CHP.TSlStp+1),A
 853++9090 08           	EX AF,AF'
 854++9091 DD 77 0B     	LD (IX-12+CHP.TSlStp),A
 855++9094 DD 36 FE 00  	LD (IX-12+CHP.COnOff),0
 856++9098 C9           	RET
 857++9099
 858++9099 DD CB 09 D6  C_GLISS	SET 2,(IX-12+CHP.Flags)
 859++909D 0A           	LD A,(BC)
 860++909E 03           	INC BC
 861++909F DD 77 0A     	LD (IX-12+CHP.TnSlDl),A
 862++90A2 A7           	AND A
 863++90A3 20 07        	JR NZ,GL36
 864++90A5 3A 6F 90     	LD A,(Version) ;AlCo PT3.7+
 865++90A8 FE 07        	CP 7
 866++90AA 9F           	SBC A,A
 867++90AB 3C           	INC A
 868++90AC DD 77 F9     GL36	LD (IX-12+CHP.TSlCnt),A
 869++90AF 0A           	LD A,(BC)
 870++90B0 03           	INC BC
 871++90B1 08           	EX AF,AF'
 872++90B2 0A           	LD A,(BC)
 873++90B3 03           	INC BC
 874++90B4 18 D7        	JR SET_STP
 875++90B6
 876++90B6 0A           C_SMPOS	LD A,(BC)
 877++90B7 03           	INC BC
 878++90B8 DD 77 F5     	LD (IX-12+CHP.PsInSm),A
 879++90BB C9           	RET
 880++90BC
 881++90BC 0A           C_ORPOS	LD A,(BC)
 882++90BD 03           	INC BC
 883++90BE DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 884++90C1 C9           	RET
 885++90C2
 886++90C2 0A           C_VIBRT	LD A,(BC)
 887++90C3 03           	INC BC
 888++90C4 DD 77 FF     	LD (IX-12+CHP.OnOffD),A
 889++90C7 DD 77 FE     	LD (IX-12+CHP.COnOff),A
 890++90CA 0A           	LD A,(BC)
 891++90CB 03           	INC BC
 892++90CC DD 77 00     	LD (IX-12+CHP.OffOnD),A
 893++90CF AF           	XOR A
 894++90D0 DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 895++90D3 DD 77 FA     	LD (IX-12+CHP.CrTnSl),A
 896++90D6 DD 77 FB     	LD (IX-12+CHP.CrTnSl+1),A
 897++90D9 C9           	RET
 898++90DA
 899++90DA 0A           C_ENGLS	LD A,(BC)
 900++90DB 03           	INC BC
 901++90DC FD 77 0E     	LD (IY-100+VRS.Env_Del),A
 902++90DF FD 77 0F     	LD (IY-100+VRS.CurEDel),A
 903++90E2 0A           	LD A,(BC)
 904++90E3 03           	INC BC
 905++90E4 6F           	LD L,A
 906++90E5 0A           	LD A,(BC)
 907++90E6 03           	INC BC
 908++90E7 67           	LD H,A
 909++90E8 FD 75 0A     	LD (IY-100+VRS.ESldAdd),L
 910++90EB FD 74 0B     	LD (IY-100+VRS.ESldAdd+1),H
 911++90EE C9           	RET
 912++90EF
 913++90EF 0A           C_DELAY	LD A,(BC)
 914++90F0 03           	INC BC
 915++90F1 FD 77 08     	LD (IY-100+VRS.Delay),A
 916++90F4 21 88 95     	LD HL,VARS2+VRS.ModNum ;if AlCo_TS
 917++90F7 CB 4E        	BIT 1,(HL)
 918++90F9 C8           	RET Z
 919++90FA 32 6B 95     	LD (VARS1+VRS.Delay),A
 920++90FD 32 6C 95     	LD (VARS1+VRS.DelyCnt),A
 921++9100 32 F2 95     	LD (VARS2+VRS.Delay),A
 922++9103 C9           	RET
 923++9104
 924++9104 DD 73 08     SETENV	LD (IX-12+CHP.Env_En),E
 925++9107 FD 77 22     	LD (IY-100+VRS.AYREGS+EnvTp),A
 926++910A 0A           	LD A,(BC)
 927++910B 03           	INC BC
 928++910C 67           	LD H,A
 929++910D 0A           	LD A,(BC)
 930++910E 03           	INC BC
 931++910F 6F           	LD L,A
 932++9110 CD 8D 8E     	CALL SETENBS
 933++9113 AF           	XOR A
 934++9114 DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 935++9117 FD 77 0F     	LD (IY-100+VRS.CurEDel),A
 936++911A 67           	LD H,A
 937++911B 6F           	LD L,A
 938++911C C3 94 8E     	JP SETESLD
 939++911F
 940++911F 87           SETORN	ADD A,A
 941++9120 5F           	LD E,A
 942++9121 16 00        	LD D,0
 943++9123 DD 72 F4     	LD (IX-12+CHP.PsInOr),D
 944++9126 FD 6E F8     	LD L,(IY-100+VRS.OrnPtrs)
 945++9129 FD 66 F9     	LD H,(IY-100+VRS.OrnPtrs+1)
 946++912C 19           	ADD HL,DE
 947++912D 5E           	LD E,(HL)
 948++912E 23           	INC HL
 949++912F 56           	LD D,(HL)
 950++9130 FD 6E F6     	LD L,(IY-100+VRS.MODADDR)
 951++9133 FD 66 F7     	LD H,(IY-100+VRS.MODADDR+1)
 952++9136 19           	ADD HL,DE
 953++9137 DD 75 01     	LD (IX-12+CHP.OrnPtr),L
 954++913A DD 74 02     	LD (IX-12+CHP.OrnPtr+1),H
 955++913D C9           C_NOP	RET
 956++913E
 957++913E 87           SETSAM	ADD A,A
 958++913F 5F           	LD E,A
 959++9140 16 00        	LD D,0
 960++9142 FD 6E FA     	LD L,(IY-100+VRS.SamPtrs);
 961++9145 FD 66 FB     	LD H,(IY-100+VRS.SamPtrs+1);
 962++9148 19           	ADD HL,DE
 963++9149 5E           	LD E,(HL)
 964++914A 23           	INC HL
 965++914B 56           	LD D,(HL)
 966++914C FD 6E F6     	LD L,(IY-100+VRS.MODADDR)
 967++914F FD 66 F7     	LD H,(IY-100+VRS.MODADDR+1)
 968++9152 19           	ADD HL,DE
 969++9153 DD 75 03     	LD (IX-12+CHP.SamPtr),L
 970++9156 DD 74 04     	LD (IX-12+CHP.SamPtr+1),H
 971++9159 C9           	RET
 972++915A
 973++915A              ;ALL 16 ADDRESSES TO PROTECT FROM BROKEN PT3 MODULES
 974++915A 3D 91        SPCCOMS DW C_NOP
 975++915C 99 90        	DW C_GLISS
 976++915E 25 90        	DW C_PORTM
 977++9160 B6 90        	DW C_SMPOS
 978++9162 BC 90        	DW C_ORPOS
 979++9164 C2 90        	DW C_VIBRT
 980++9166 3D 91        	DW C_NOP
 981++9168 3D 91        	DW C_NOP
 982++916A DA 90        	DW C_ENGLS
 983++916C EF 90        	DW C_DELAY
 984++916E 3D 91        	DW C_NOP
 985++9170 3D 91        	DW C_NOP
 986++9172 3D 91        	DW C_NOP
 987++9174 3D 91        	DW C_NOP
 988++9176 3D 91        	DW C_NOP
 989++9178 3D 91        	DW C_NOP
 990++917A
 991++917A CD 9B 8E     CHREGS	CALL GETIX
 992++917D AF           	XOR A
 993++917E 32 BA 93     	LD (Ampl),A
 994++9181 DD CB 15 46  	BIT 0,(IX+CHP.Flags)
 995++9185 E5           	PUSH HL
 996++9186 CA CD 92     	JP Z,CH_EXIT
 997++9189 ED 73 17 92  	LD (CSP_+1),SP
 998++918D DD 6E 0D     	LD L,(IX+CHP.OrnPtr)
 999++9190 DD 66 0E     	LD H,(IX+CHP.OrnPtr+1)
1000++9193 F9           	LD SP,HL
1001++9194 D1           	POP DE
1002++9195 67           	LD H,A
1003++9196 DD 7E 00     	LD A,(IX+CHP.PsInOr)
1004++9199 6F           	LD L,A
1005++919A 39           	ADD HL,SP
1006++919B 3C           	INC A
1007++919C              		;PT2	PT3
1008++919C 3C           OrnCP	INC A	;CP E	CP D
1009++919D 38 01        	JR C,CH_ORPS
1010++919F 01           OrnLD	DB 1	;LD A,D	LD A,E
1011++91A0 DD 77 00     CH_ORPS	LD (IX+CHP.PsInOr),A
1012++91A3 DD 7E 12     	LD A,(IX+CHP.Note)
1013++91A6 86           	ADD A,(HL)
1014++91A7 F2 AB 91     	JP P,CH_NTP
1015++91AA AF           	XOR A
1016++91AB FE 60        CH_NTP	CP 96
1017++91AD 38 02        	JR C,CH_NOK
1018++91AF 3E 5F        	LD A,95
1019++91B1 87           CH_NOK	ADD A,A
1020++91B2 08           	EX AF,AF'
1021++91B3 DD 6E 0F     	LD L,(IX+CHP.SamPtr)
1022++91B6 DD 66 10     	LD H,(IX+CHP.SamPtr+1)
1023++91B9 F9           	LD SP,HL
1024++91BA D1           	POP DE
1025++91BB 26 00        	LD H,0
1026++91BD DD 7E 01     	LD A,(IX+CHP.PsInSm)
1027++91C0 47           	LD B,A
1028++91C1 87           	ADD A,A
1029++91C2 87           SamClc2	ADD A,A ;or ADD A,B for PT2
1030++91C3 6F           	LD L,A
1031++91C4 39           	ADD HL,SP
1032++91C5 F9           	LD SP,HL
1033++91C6 78           	LD A,B
1034++91C7 3C           	INC A
1035++91C8              		;PT2	PT3
1036++91C8 3C           SamCP	INC A	;CP E	CP D
1037++91C9 38 01        	JR C,CH_SMPS
1038++91CB 01           SamLD	DB 1	;LD A,D	LD A,E
1039++91CC DD 77 01     CH_SMPS	LD (IX+CHP.PsInSm),A
1040++91CF C1           	POP BC
1041++91D0 E1           	POP HL
1042++91D1
1043++91D1              ;Convert PT2 sample to PT3
1044++91D1              		;PT2		PT3
1045++91D1 E1           SamCnv	POP HL  ;BIT 2,C	JR e_
1046++91D2 E1           	POP HL
1047++91D3 60           	LD H,B
1048++91D4 20 06        	JR NZ,$+8
1049++91D6 EB           	EX DE,HL
1050++91D7 A7           	AND A
1051++91D8 ED 62        	SBC HL,HL
1052++91DA ED 52        	SBC HL,DE
1053++91DC 51           	LD D,C
1054++91DD CB 19        	RR C
1055++91DF 9F           	SBC A,A
1056++91E0 2F           	CPL
1057++91E1 E6 3E        	AND #3E
1058++91E3 CB 19        	RR C
1059++91E5 CB 18        	RR B
1060++91E7 A1           	AND C
1061++91E8 4F           	LD C,A
1062++91E9 78           	LD A,B
1063++91EA 1F           	RRA
1064++91EB 1F           	RRA
1065++91EC CB 1A        	RR D
1066++91EE 1F           	RRA
1067++91EF E6 9F        	AND #9F
1068++91F1 47           	LD B,A
1069++91F2
1070++91F2 DD 5E 08     e_	LD E,(IX+CHP.TnAcc)
1071++91F5 DD 56 09     	LD D,(IX+CHP.TnAcc+1)
1072++91F8 19           	ADD HL,DE
1073++91F9 CB 70        	BIT 6,B
1074++91FB 28 06        	JR Z,CH_NOAC
1075++91FD DD 75 08     	LD (IX+CHP.TnAcc),L
1076++9200 DD 74 09     	LD (IX+CHP.TnAcc+1),H
1077++9203 EB           CH_NOAC EX DE,HL
1078++9204 08           	EX AF,AF'
player.asm(1079): warning: value 0x96FD is truncated to 8bit value: 0xFD
1079++9205 C6 FD        	ADD A,NT_
1080++9207 6F           	LD L,A
1081++9208 CE 96        	ADC A,NT_/256
1082++920A 95           	SUB L
1083++920B 67           	LD H,A
1084++920C F9           	LD SP,HL
1085++920D E1           	POP HL
1086++920E 19           	ADD HL,DE
1087++920F DD 5E 06     	LD E,(IX+CHP.CrTnSl)
1088++9212 DD 56 07     	LD D,(IX+CHP.CrTnSl+1)
1089++9215 19           	ADD HL,DE
1090++9216 31 31 31     CSP_	LD SP,#3131
1091++9219 E3           	EX (SP),HL
1092++921A AF           	XOR A
1093++921B DD B6 05     	OR (IX+CHP.TSlCnt)
1094++921E 28 3E        	JR Z,CH_AMP
1095++9220 DD 35 05     	DEC (IX+CHP.TSlCnt)
1096++9223 20 39        	JR NZ,CH_AMP
1097++9225 DD 7E 16     	LD A,(IX+CHP.TnSlDl)
1098++9228 DD 77 05     	LD (IX+CHP.TSlCnt),A
1099++922B DD 6E 17     	LD L,(IX+CHP.TSlStp)
1100++922E DD 66 18     	LD H,(IX+CHP.TSlStp+1)
1101++9231 7C           	LD A,H
1102++9232 19           	ADD HL,DE
1103++9233 DD 75 06     	LD (IX+CHP.CrTnSl),L
1104++9236 DD 74 07     	LD (IX+CHP.CrTnSl+1),H
1105++9239 DD CB 15 56  	BIT 2,(IX+CHP.Flags)
1106++923D 20 1F        	JR NZ,CH_AMP
1107++923F DD 5E 19     	LD E,(IX+CHP.TnDelt)
1108++9242 DD 56 1A     	LD D,(IX+CHP.TnDelt+1)
1109++9245 A7           	AND A
1110++9246 28 01        	JR Z,CH_STPP
1111++9248 EB           	EX DE,HL
1112++9249 ED 52        CH_STPP SBC HL,DE
1113++924B FA 5E 92     	JP M,CH_AMP
1114++924E DD 7E 13     	LD A,(IX+CHP.SlToNt)
1115++9251 DD 77 12     	LD (IX+CHP.Note),A
1116++9254 AF           	XOR A
1117++9255 DD 77 05     	LD (IX+CHP.TSlCnt),A
1118++9258 DD 77 06     	LD (IX+CHP.CrTnSl),A
1119++925B DD 77 07     	LD (IX+CHP.CrTnSl+1),A
1120++925E DD 7E 02     CH_AMP	LD A,(IX+CHP.CrAmSl)
1121++9261 CB 79        	BIT 7,C
1122++9263 28 13        	JR Z,CH_NOAM
1123++9265 CB 71        	BIT 6,C
1124++9267 28 07        	JR Z,CH_AMIN
1125++9269 FE 0F        	CP 15
1126++926B 28 0B        	JR Z,CH_NOAM
1127++926D 3C           	INC A
1128++926E 18 05        	JR CH_SVAM
1129++9270 FE F1        CH_AMIN	CP -15
1130++9272 28 04        	JR Z,CH_NOAM
1131++9274 3D           	DEC A
1132++9275 DD 77 02     CH_SVAM	LD (IX+CHP.CrAmSl),A
1133++9278 6F           CH_NOAM	LD L,A
1134++9279 78           	LD A,B
1135++927A E6 0F        	AND 15
1136++927C 85           	ADD A,L
1137++927D F2 81 92     	JP P,CH_APOS
1138++9280 AF           	XOR A
1139++9281 FE 10        CH_APOS	CP 16
1140++9283 38 02        	JR C,CH_VOL
1141++9285 3E 0F        	LD A,15
1142++9287 DD B6 1C     CH_VOL	OR (IX+CHP.Volume)
player.asm(1143): warning: value 0x95FD is truncated to 8bit value: 0xFD
1143++928A C6 FD        	ADD A,VT_
1144++928C 6F           	LD L,A
1145++928D CE 95        	ADC A,VT_/256
1146++928F 95           	SUB L
1147++9290 67           	LD H,A
1148++9291 7E           	LD A,(HL)
1149++9292 CB 41        CH_ENV	BIT 0,C
1150++9294 20 03        	JR NZ,CH_NOEN
1151++9296 DD B6 14     	OR (IX+CHP.Env_En)
1152++9299 32 BA 93     CH_NOEN	LD (Ampl),A
1153++929C CB 78        	BIT 7,B
1154++929E 79           	LD A,C
1155++929F 28 1A        	JR Z,NO_ENSL
1156++92A1 17           	RLA
1157++92A2 17           	RLA
1158++92A3 CB 2F        	SRA A
1159++92A5 CB 2F        	SRA A
1160++92A7 CB 2F        	SRA A
1161++92A9 DD 86 04     	ADD A,(IX+CHP.CrEnSl) ;SEE COMMENT BELOW
1162++92AC CB 68        	BIT 5,B
1163++92AE 28 03        	JR Z,NO_ENAC
1164++92B0 DD 77 04     	LD (IX+CHP.CrEnSl),A
1165++92B3 FD 86 12     NO_ENAC	ADD A,(IY-100+VRS.AddToEn) ;BUG IN PT3 - NEED WORD HERE
1166++92B6 FD 77 12     	LD (IY-100+VRS.AddToEn),A
1167++92B9 18 0E        	JR CH_MIX
1168++92BB 1F           NO_ENSL RRA
1169++92BC DD 86 03     	ADD A,(IX+CHP.CrNsSl)
1170++92BF FD 77 11     	LD (IY-100+VRS.AddToNs),A
1171++92C2 CB 68        	BIT 5,B
1172++92C4 28 03        	JR Z,CH_MIX
1173++92C6 DD 77 03     	LD (IX+CHP.CrNsSl),A
1174++92C9 78           CH_MIX	LD A,B
1175++92CA 1F           	RRA
1176++92CB E6 48        	AND #48
1177++92CD FD B6 1C     CH_EXIT	OR (IY-100+VRS.AYREGS+Mixer)
1178++92D0 0F           	RRCA
1179++92D1 FD 77 1C     	LD (IY-100+VRS.AYREGS+Mixer),A
1180++92D4 E1           	POP HL
1181++92D5 AF           	XOR A
1182++92D6 DD B6 0A     	OR (IX+CHP.COnOff)
1183++92D9 C8           	RET Z
1184++92DA DD 35 0A     	DEC (IX+CHP.COnOff)
1185++92DD C0           	RET NZ
1186++92DE DD AE 15     	XOR (IX+CHP.Flags)
1187++92E1 DD 77 15     	LD (IX+CHP.Flags),A
1188++92E4 1F           	RRA
1189++92E5 DD 7E 0B     	LD A,(IX+CHP.OnOffD)
1190++92E8 38 03        	JR C,CH_ONDL
1191++92EA DD 7E 0C     	LD A,(IX+CHP.OffOnD)
1192++92ED DD 77 0A     CH_ONDL	LD (IX+CHP.COnOff),A
1193++92F0 C9           	RET
1194++92F1
1195++92F1 AF           PLAY_	XOR A
1196++92F2 FD 77 12     	LD (IY-100+VRS.AddToEn),A
1197++92F5 FD 77 1C     	LD (IY-100+VRS.AYREGS+Mixer),A
1198++92F8 3D           	DEC A
1199++92F9 FD 77 22     	LD (IY-100+VRS.AYREGS+EnvTp),A
1200++92FC FD 35 09     	DEC (IY-100+VRS.DelyCnt)
1201++92FF C2 A7 93     	JP NZ,PL2
1202++9302 FD 35 BA     	DEC (IY-100+VRS.ChanA+CHP.NtSkCn)
1203++9305 20 6C        	JR NZ,PL1B
1204++9307 FD 4E FE     	LD C,(IY-100+VRS.AdInPtA)
1205++930A FD 46 FF     	LD B,(IY-100+VRS.AdInPtA+1)
1206++930D 0A           	LD A,(BC)
1207++930E A7           	AND A
1208++930F 20 56        	JR NZ,PL1A
1209++9311 57           	LD D,A
1210++9312 FD 77 10     	LD (IY-100+VRS.Ns_Base),A
1211++9315 FD 6E 04     	LD L,(IY-100+VRS.CrPsPtr)
1212++9318 FD 66 05     	LD H,(IY-100+VRS.CrPsPtr+1)
1213++931B 23           	INC HL
1214++931C 7E           	LD A,(HL)
1215++931D 3C           	INC A
1216++931E 20 0B        	JR NZ,PLNLP
1217++9320
1218++9320              	IF LoopChecker
1219++9320 CD D2 8B     	CALL CHECKLP
1220++9323              	ENDIF
1221++9323
1222++9323 FD 6E 06     	LD L,(IY-100+VRS.LPosPtr)
1223++9326 FD 66 07     	LD H,(IY-100+VRS.LPosPtr+1)
1224++9329 7E           	LD A,(HL)
1225++932A 3C           	INC A
1226++932B CD 7F 8E     PLNLP	CALL SETCPPT
1227++932E 3D           	DEC A
1228++932F FD CB 9E 4E  	BIT 1,(IY-100+VRS.ModNum)
1229++9333 28 03        	JR Z,NoAlCo
1230++9335              TSSub	EQU $+1
1231++9335 D6 D6        	SUB #D6
1232++9337 2F           	CPL
1233++9338              NoAlCo
1234++9338              		;PT2		PT3
1235++9338 3D           PsCalc	DEC A	;ADD A,A	NOP
1236++9339 3D           	DEC A	;ADD A,(HL)	NOP
1237++933A 87           	ADD A,A
1238++933B 5F           	LD E,A
1239++933C CB 12        	RL D
1240++933E
1241++933E              	IF CurPosCounter
1242++933E ~            	LD A,L
1243++933E ~            	SUB (IY-100+VRS.PosSub)
1244++933E ~            	LD (IY-100+VRS.CurPos),A
1245++933E              	ENDIF
1246++933E
1247++933E FD 6E FC     	LD L,(IY-100+VRS.PatsPtr)
1248++9341 FD 66 FD     	LD H,(IY-100+VRS.PatsPtr+1)
1249++9344 19           	ADD HL,DE
1250++9345 FD 5E F6     	LD E,(IY-100+VRS.MODADDR)
1251++9348 FD 56 F7     	LD D,(IY-100+VRS.MODADDR+1)
1252++934B ED 73 65 93  	LD (PSP_+1),SP
1253++934F F9           	LD SP,HL
1254++9350 E1           	POP HL
1255++9351 19           	ADD HL,DE
1256++9352 44           	LD B,H
1257++9353 4D           	LD C,L
1258++9354 E1           	POP HL
1259++9355 19           	ADD HL,DE
1260++9356 FD 75 00     	LD (IY-100+VRS.AdInPtB),L
1261++9359 FD 74 01     	LD (IY-100+VRS.AdInPtB+1),H
1262++935C E1           	POP HL
1263++935D 19           	ADD HL,DE
1264++935E FD 75 02     	LD (IY-100+VRS.AdInPtC),L
1265++9361 FD 74 03     	LD (IY-100+VRS.AdInPtC+1),H
1266++9364 31 31 31     PSP_	LD SP,#3131
1267++9367 11 AB FF     PL1A	LD DE,VRS.ChanA+12-100
1268++936A CD A2 8E     	CALL PTDECOD
1269++936D FD 71 FE     	LD (IY-100+VRS.AdInPtA),C
1270++9370 FD 70 FF     	LD (IY-100+VRS.AdInPtA+1),B
1271++9373
1272++9373 FD 35 D7     PL1B	DEC (IY-100+VRS.ChanB+CHP.NtSkCn)
1273++9376 20 12        	JR NZ,PL1C
1274++9378 11 C8 FF     	LD DE,VRS.ChanB+12-100
1275++937B FD 4E 00     	LD C,(IY-100+VRS.AdInPtB)
1276++937E FD 46 01     	LD B,(IY-100+VRS.AdInPtB+1)
1277++9381 CD A2 8E     	CALL PTDECOD
1278++9384 FD 71 00     	LD (IY-100+VRS.AdInPtB),C
1279++9387 FD 70 01     	LD (IY-100+VRS.AdInPtB+1),B
1280++938A
1281++938A FD 35 F4     PL1C	DEC (IY-100+VRS.ChanC+CHP.NtSkCn)
1282++938D 20 12        	JR NZ,PL1D
1283++938F 11 E5 FF     	LD DE,VRS.ChanC+12-100
1284++9392 FD 4E 02     	LD C,(IY-100+VRS.AdInPtC)
1285++9395 FD 46 03     	LD B,(IY-100+VRS.AdInPtC+1)
1286++9398 CD A2 8E     	CALL PTDECOD
1287++939B FD 71 02     	LD (IY-100+VRS.AdInPtC),C
1288++939E FD 70 03     	LD (IY-100+VRS.AdInPtC+1),B
1289++93A1
1290++93A1 FD 7E 08     PL1D	LD A,(IY-100+VRS.Delay)
1291++93A4 FD 77 09     	LD (IY-100+VRS.DelyCnt),A
1292++93A7
1293++93A7 11 9F FF     PL2	LD DE,VRS.ChanA-100
1294++93AA FD 6E 15     	LD L,(IY-100+VRS.AYREGS+TonA)
1295++93AD FD 66 16     	LD H,(IY-100+VRS.AYREGS+TonA+1)
1296++93B0 CD 7A 91     	CALL CHREGS
1297++93B3 FD 75 15     	LD (IY-100+VRS.AYREGS+TonA),L
1298++93B6 FD 74 16     	LD (IY-100+VRS.AYREGS+TonA+1),H
1299++93B9              Ampl	EQU $+1
1300++93B9 3E 3E        	LD A,#3E
1301++93BB FD 77 1D     	LD (IY-100+VRS.AYREGS+AmplA),A
1302++93BE 11 BC FF     	LD DE,VRS.ChanB-100
1303++93C1 FD 6E 17     	LD L,(IY-100+VRS.AYREGS+TonB)
1304++93C4 FD 66 18     	LD H,(IY-100+VRS.AYREGS+TonB+1)
1305++93C7 CD 7A 91     	CALL CHREGS
1306++93CA FD 75 17     	LD (IY-100+VRS.AYREGS+TonB),L
1307++93CD FD 74 18     	LD (IY-100+VRS.AYREGS+TonB+1),H
1308++93D0 3A BA 93     	LD A,(Ampl)
1309++93D3 FD 77 1E     	LD (IY-100+VRS.AYREGS+AmplB),A
1310++93D6 11 D9 FF     	LD DE,VRS.ChanC-100
1311++93D9 FD 6E 19     	LD L,(IY-100+VRS.AYREGS+TonC)
1312++93DC FD 66 1A     	LD H,(IY-100+VRS.AYREGS+TonC+1)
1313++93DF CD 7A 91     	CALL CHREGS
1314++93E2 FD 75 19     	LD (IY-100+VRS.AYREGS+TonC),L
1315++93E5 FD 74 1A     	LD (IY-100+VRS.AYREGS+TonC+1),H
1316++93E8 3A BA 93     	LD A,(Ampl)
1317++93EB FD 77 1F     	LD (IY-100+VRS.AYREGS+AmplC),A
1318++93EE
1319++93EE FD 7E 10     	LD A,(IY-100+VRS.Ns_Base)
1320++93F1 FD 86 11     	ADD (IY-100+VRS.AddToNs)
1321++93F4 FD 77 1B     	LD (IY-100+VRS.AYREGS+Noise),A
1322++93F7
1323++93F7 FD 7E 12     	LD A,(IY-100+VRS.AddToEn)
1324++93FA 5F           	LD E,A
1325++93FB 87           	ADD A,A
1326++93FC 9F           	SBC A,A
1327++93FD 57           	LD D,A
1328++93FE FD 6E 13     	LD L,(IY-100+VRS.EnvBase)
1329++9401 FD 66 14     	LD H,(IY-100+VRS.EnvBase+1)
1330++9404 19           	ADD HL,DE
1331++9405 FD 5E 0C     	LD E,(IY-100+VRS.CurESld)
1332++9408 FD 56 0D     	LD D,(IY-100+VRS.CurESld+1)
1333++940B 19           	ADD HL,DE
1334++940C FD 75 20     	LD (IY-100+VRS.AYREGS+Env),L
1335++940F FD 74 21     	LD (IY-100+VRS.AYREGS+Env+1),H
1336++9412
1337++9412 AF           	XOR A
1338++9413 FD B6 0F     	OR (IY-100+VRS.CurEDel)
1339++9416 C8           	RET Z
1340++9417 FD 35 0F     	DEC (IY-100+VRS.CurEDel)
1341++941A C0           	RET NZ
1342++941B FD 7E 0E     	LD A,(IY-100+VRS.Env_Del)
1343++941E FD 77 0F     	LD (IY-100+VRS.CurEDel),A
1344++9421 FD 6E 0A     	LD L,(IY-100+VRS.ESldAdd)
1345++9424 FD 66 0B     	LD H,(IY-100+VRS.ESldAdd+1)
1346++9427 19           	ADD HL,DE
1347++9428 C3 94 8E     	JP SETESLD
1348++942B
1349++942B FD 21 63 95  PLAY    LD IY,VARS1+100
1350++942F CD F1 92     	CALL PLAY_
1351++9432 3A FE 94     	LD A,(is_ts)
1352++9435 A7           	AND A
1353++9436 28 07        	JR Z,PL_nts
1354++9438 FD 21 EA 95  	LD IY,VARS2+100
1355++943C CD F1 92     	CALL PLAY_
1356++943F              PL_nts
1357++943F              	IF Basic
1358++943F FD 21 3A 5C  	LD IY,#5C3A
1359++9443              	ENDIF
1360++9443
1361++9443 01 FD FF     ROUT	LD BC,#FFFD
1362++9446 3A FE 94     	LD A,(is_ts)
1363++9449 A7           	AND A
1364++944A 28 02        	JR Z,r_nts ;keep old standard
1365++944C ED 41        	OUT (C),B
1366++944E 08           r_nts	EX AF,AF'
1367++944F
1368++944F              	IF ACBBAC
1369++944F ~            	LD IX,VARS1+VRS.AYREGS
1370++944F              	ELSE
1371++944F 21 78 95     	LD HL,VARS1+VRS.AYREGS
1372++9452              	ENDIF
1373++9452
1374++9452 CD 5E 94     	CALL ROUT_
1375++9455 08           	EX AF,AF'
1376++9456 C8           	RET Z
1377++9457 42           	LD B,D
1378++9458 2F           	CPL
1379++9459 ED 79        	OUT (C),A
1380++945B
1381++945B              	IF ACBBAC
1382++945B ~            	LD IX,VARS2+VRS.AYREGS
1383++945B              	ELSE
1384++945B 21 FF 95     	LD HL,VARS2+VRS.AYREGS
1385++945E              	ENDIF
1386++945E
1387++945E              ROUT_
1388++945E              	IF ACBBAC
1389++945E ~            	LD A,(SETUP)
1390++945E ~            	AND 12
1391++945E ~            	JR Z,ABC
1392++945E ~            	ADD A,CHTABLE
1393++945E ~            	LD E,A
1394++945E ~            	ADC A,CHTABLE/256
1395++945E ~            	SUB E
1396++945E ~            	LD D,A
1397++945E ~            	LD B,0
1398++945E ~            	PUSH IX
1399++945E ~            	POP HL
1400++945E ~            	LD A,(DE)
1401++945E ~            	INC DE
1402++945E ~            	LD C,A
1403++945E ~            	ADD HL,BC
1404++945E ~            	LD A,(IX+TonB)
1405++945E ~            	LD C,(HL)
1406++945E ~            	LD (IX+TonB),C
1407++945E ~            	LD (HL),A
1408++945E ~            	INC HL
1409++945E ~            	LD A,(IX+TonB+1)
1410++945E ~            	LD C,(HL)
1411++945E ~            	LD (IX+TonB+1),C
1412++945E ~            	LD (HL),A
1413++945E ~            	LD A,(DE)
1414++945E ~            	INC DE
1415++945E ~            	LD C,A
1416++945E ~            	ADD HL,BC
1417++945E ~            	LD A,(IX+AmplB)
1418++945E ~            	LD C,(HL)
1419++945E ~            	LD (IX+AmplB),C
1420++945E ~            	LD (HL),A
1421++945E ~            	LD A,(DE)
1422++945E ~            	INC DE
1423++945E ~            	LD (RxCA1),A
1424++945E ~            	XOR 8
1425++945E ~            	LD (RxCA2),A
1426++945E ~            	LD A,(DE)
1427++945E ~            	AND (IX+Mixer)
1428++945E ~            	LD E,A
1429++945E ~            	LD A,(IX+Mixer)
1430++945E ~            RxCA1	DB #E6
1431++945E ~            	AND %010010
1432++945E ~            	OR E
1433++945E ~            	LD E,A
1434++945E ~            	LD A,(IX+Mixer)
1435++945E ~            	AND %010010
1436++945E ~            RxCA2	OR E
1437++945E ~            	OR E
1438++945E ~            	LD (IX+Mixer),A
1439++945E ~            ABC
1440++945E              	ENDIF
1441++945E
1442++945E AF           	XOR A
1443++945F 11 BF FF     	LD DE,#FFBF
1444++9462
1445++9462              	IF ACBBAC
1446++9462 ~            	LD BC,#FFFD
1447++9462 ~            	PUSH IX
1448++9462 ~            	POP HL
1449++9462              	ENDIF
1450++9462
1451++9462 ED 79        LOUT	OUT (C),A
1452++9464 43           	LD B,E
1453++9465 ED A3        	OUTI
1454++9467 42           	LD B,D
1455++9468 3C           	INC A
1456++9469 FE 0D        	CP 13
1457++946B 20 F5        	JR NZ,LOUT
1458++946D ED 79        	OUT (C),A
1459++946F 7E           	LD A,(HL)
1460++9470 A7           	AND A
1461++9471 F8           	RET M
1462++9472 43           	LD B,E
1463++9473 ED 79        	OUT (C),A
1464++9475 C9           	RET
1465++9476
1466++9476              	IF ACBBAC
1467++9476 ~            CHTABLE	EQU $-4
1468++9476 ~            	DB 4,5,15,%001001,0,7,7,%100100
1469++9476              	ENDIF
1470++9476
1471++9476 64           NT_DATA	DB (T_NEW_0-T1_)*2
1472++9477 2A           	DB TCNEW_0-T_
1473++9478 65           	DB (T_OLD_0-T1_)*2+1
1474++9479 00           	DB TCOLD_0-T_
1475++947A 01           	DB (T_NEW_1-T1_)*2+1
1476++947B 0C           	DB TCNEW_1-T_
1477++947C 01           	DB (T_OLD_1-T1_)*2+1
1478++947D 0C           	DB TCOLD_1-T_
1479++947E 94           	DB (T_NEW_2-T1_)*2
1480++947F 35           	DB TCNEW_2-T_
1481++9480 30           	DB (T_OLD_2-T1_)*2
1482++9481 0E           	DB TCOLD_2-T_
1483++9482 60           	DB (T_NEW_3-T1_)*2
1484++9483 20           	DB TCNEW_3-T_
1485++9484 60           	DB (T_OLD_3-T1_)*2
1486++9485 21           	DB TCOLD_3-T_
1487++9486
1488++9486              T_
1489++9486
1490++9486 01 05 09 0B  TCOLD_0	DB #00+1,#04+1,#08+1,#0A+1,#0C+1,#0E+1,#12+1,#14+1
1490++948A 0D 0F 13 15
1491++948E 19 25 3D 00  	DB #18+1,#24+1,#3C+1,0
1492++9492 5D 00        TCOLD_1	DB #5C+1,0
1493++9494 31 37 4D 53  TCOLD_2	DB #30+1,#36+1,#4C+1,#52+1,#5E+1,#70+1,#82,#8C,#9C
1493++9498 5F 71 82 8C
1493++949C 9C
1494++949D 9E A0 A6 A8  	DB #9E,#A0,#A6,#A8,#AA,#AC,#AE,#AE,0
1494++94A1 AA AC AE AE
1494++94A5 00
1495++94A6 57           TCNEW_3	DB #56+1
1496++94A7 1F 23 25 29  TCOLD_3	DB #1E+1,#22+1,#24+1,#28+1,#2C+1,#2E+1,#32+1,#BE+1,0
1496++94AB 2D 2F 33 BF
1496++94AF 00
1497++94B0 1D 21 23 27  TCNEW_0	DB #1C+1,#20+1,#22+1,#26+1,#2A+1,#2C+1,#30+1,#54+1
1497++94B4 2B 2D 31 55
1498++94B8 BD BF 00     	DB #BC+1,#BE+1,0
1499++94BB              TCNEW_1 EQU TCOLD_1
1500++94BB 1B 21 25 29  TCNEW_2	DB #1A+1,#20+1,#24+1,#28+1,#2A+1,#3A+1,#4C+1,#5E+1
1500++94BF 2B 3B 4D 5F
1501++94C3 BB BD BF 00  	DB #BA+1,#BC+1,#BE+1,0
1502++94C7
1503++94C7              PT3EMPTYORN EQU $-1
1504++94C7 01 00        	DB 1,0
1505++94C9
1506++94C9              ;first 12 values of tone tables (packed)
1507++94C9
player.asm(1508): warning: value 0xDD8 is truncated to 8bit value: 0xD8
1508++94C9 0D D8        T_PACK	DB #06EC*2/256,#06EC*2
1509++94CB 69           	DB #0755-#06EC
1510++94CC 70           	DB #07C5-#0755
1511++94CD 76           	DB #083B-#07C5
1512++94CE 7D           	DB #08B8-#083B
1513++94CF 85           	DB #093D-#08B8
1514++94D0 8D           	DB #09CA-#093D
1515++94D1 95           	DB #0A5F-#09CA
1516++94D2 9D           	DB #0AFC-#0A5F
1517++94D3 A8           	DB #0BA4-#0AFC
1518++94D4 B1           	DB #0C55-#0BA4
1519++94D5 BB           	DB #0D10-#0C55
player.asm(1520): warning: value 0xCDA is truncated to 8bit value: 0xDA
1520++94D6 0C DA        	DB #066D*2/256,#066D*2
1521++94D8 62           	DB #06CF-#066D
1522++94D9 68           	DB #0737-#06CF
1523++94DA 6D           	DB #07A4-#0737
1524++94DB 75           	DB #0819-#07A4
1525++94DC 7B           	DB #0894-#0819
1526++94DD 83           	DB #0917-#0894
1527++94DE 8A           	DB #09A1-#0917
1528++94DF 92           	DB #0A33-#09A1
1529++94E0 9C           	DB #0ACF-#0A33
1530++94E1 A4           	DB #0B73-#0ACF
1531++94E2 AF           	DB #0C22-#0B73
1532++94E3 B8           	DB #0CDA-#0C22
player.asm(1533): warning: value 0xE08 is truncated to 8bit value: 0x08
1533++94E4 0E 08        	DB #0704*2/256,#0704*2
1534++94E6 6A           	DB #076E-#0704
1535++94E7 72           	DB #07E0-#076E
1536++94E8 78           	DB #0858-#07E0
1537++94E9 7E           	DB #08D6-#0858
1538++94EA 86           	DB #095C-#08D6
1539++94EB 90           	DB #09EC-#095C
1540++94EC 96           	DB #0A82-#09EC
1541++94ED A0           	DB #0B22-#0A82
1542++94EE AA           	DB #0BCC-#0B22
1543++94EF B4           	DB #0C80-#0BCC
1544++94F0 BE           	DB #0D3E-#0C80
player.asm(1545): warning: value 0xFC0 is truncated to 8bit value: 0xC0
1545++94F1 0F C0        	DB #07E0*2/256,#07E0*2
1546++94F3 78           	DB #0858-#07E0
1547++94F4 88           	DB #08E0-#0858
1548++94F5 80           	DB #0960-#08E0
1549++94F6 90           	DB #09F0-#0960
1550++94F7 98           	DB #0A88-#09F0
1551++94F8 A0           	DB #0B28-#0A88
1552++94F9 B0           	DB #0BD8-#0B28
1553++94FA A8           	DB #0C80-#0BD8
1554++94FB E0           	DB #0D60-#0C80
1555++94FC B0           	DB #0E10-#0D60
1556++94FD E8           	DB #0EF8-#0E10
1557++94FE
1558++94FE              ;vars from here can be stripped
1559++94FE              ;you can move VARS to any other address
1560++94FE
1561++94FE              VARS
1562++94FE
1563++94FE 00           is_ts	DB 0
1564++94FF
1565++94FF              ;ChannelsVars
1566++94FF              	STRUCT	CHP
1567++94FF ~            ;reset group
1568++94FF ~            PsInOr	DB 0
1569++94FF ~            PsInSm	DB 0
1570++94FF ~            CrAmSl	DB 0
1571++94FF ~            CrNsSl	DB 0
1572++94FF ~            CrEnSl	DB 0
1573++94FF ~            TSlCnt	DB 0
1574++94FF ~            CrTnSl	DW 0
1575++94FF ~            TnAcc	DW 0
1576++94FF ~            COnOff	DB 0
1577++94FF ~            ;reset group
1578++94FF ~
1579++94FF ~            OnOffD	DB 0
1580++94FF ~
1581++94FF ~            ;IX for PTDECOD here (+12)
1582++94FF ~            OffOnD	DB 0
1583++94FF ~            OrnPtr	DW 0
1584++94FF ~            SamPtr	DW 0
1585++94FF ~            NNtSkp	DB 0
1586++94FF ~            Note	DB 0
1587++94FF ~            SlToNt	DB 0
1588++94FF ~            Env_En	DB 0
1589++94FF ~            Flags	DB 0
1590++94FF ~             ;Enabled - 0, SimpleGliss - 2
1591++94FF ~            TnSlDl	DB 0
1592++94FF ~            TSlStp	DW 0
1593++94FF ~            TnDelt	DW 0
1594++94FF ~            NtSkCn	DB 0
1595++94FF ~            Volume	DB 0
1596++94FF              	ENDS
1597++94FF
1598++94FF              	STRUCT	VRS
1599++94FF ~
1600++94FF ~            ;IF not works in STRUCT in SjASM :(
1601++94FF ~            ;	IF CurPosCounter
1602++94FF ~            CurPos	DB 0
1603++94FF ~            PosSub	DB 0
1604++94FF ~            ;	ENDIF
1605++94FF ~
1606++94FF ~            ModNum	DB 0 ;bit0: ChipNum
1607++94FF ~            	     ;bit1: 1-reversed patterns order (AlCo TS)
1608++94FF ~
1609++94FF ~            ChanA	DS CHP
1610++94FF ~            ChanB	DS CHP
1611++94FF ~            ChanC	DS CHP
1612++94FF ~
1613++94FF ~            ;GlobalVars
1614++94FF ~            MODADDR	DW 0
1615++94FF ~            OrnPtrs	DW 0
1616++94FF ~            SamPtrs	DW 0
1617++94FF ~            PatsPtr	DW 0
1618++94FF ~            AdInPtA	DW 0
1619++94FF ~            AdInPtB	DW 0
1620++94FF ~            AdInPtC	DW 0
1621++94FF ~            CrPsPtr	DW 0
1622++94FF ~            LPosPtr	DW 0
1623++94FF ~            Delay	DB 0
1624++94FF ~            DelyCnt	DB 0
1625++94FF ~            ESldAdd	DW 0
1626++94FF ~            CurESld	DW 0
1627++94FF ~            Env_Del	DB 0
1628++94FF ~            CurEDel	DB 0
1629++94FF ~            Ns_Base	DB 0
1630++94FF ~            AddToNs	DB 0
1631++94FF ~            AddToEn	DB 0
1632++94FF ~            EnvBase	DW 0
1633++94FF ~            AYREGS	DS 14
1634++94FF              	ENDS
1635++94FF
1636++94FF 00 00 00...  VARS1	DS VRS
1637++9586 00 00 00...  VARS2	DS VRS
1638++960D
1639++960D              VT_	EQU $-16
1640++960D 00 00 00...  	DS 256-16 ;CreatedVolumeTableAddress
1641++96FD
1642++96FD              T1_	EQU VT_+16 ;Tone tables data depacked here
1643++96FD
1644++96FD              T_OLD_1	EQU T1_
1645++96FD              T_OLD_2	EQU T_OLD_1+24
1646++96FD              T_OLD_3	EQU T_OLD_2+24
1647++96FD              T_OLD_0	EQU T_OLD_3+2
1648++96FD              T_NEW_0	EQU T_OLD_0
1649++96FD              T_NEW_1	EQU T_OLD_1
1650++96FD              T_NEW_2	EQU T_NEW_0+24
1651++96FD              T_NEW_3	EQU T_OLD_3
1652++96FD
1653++96FD              PT2EMPTYORN EQU VT_+31 ;1,0,0 sequence
1654++96FD
1655++96FD 00 00 00...  NT_	DS 192 ;CreatedNoteTableAddress
1656++97BD
1657++97BD              VAR0END	EQU VT_+16 ;INIT zeroes from VARS to VAR0END-1
1658++97BD
1659++97BD              VARSEND EQU $
1660++97BD
1661++97BD              MDLADDR EQU outputBuffer
1662++97BD
1663++97BD              ;Release 0 steps:
1664++97BD              ;04/21/2007
1665++97BD              ;Works start (PTxPlay adaptation); first beta.
1666++97BD              ;04/22/2007
1667++97BD              ;Job finished; beta-testing.
1668++97BD              ;04/23/2007
1669++97BD              ;PT v3.7 TS mode corrected (after AlCo remarks).
1670++97BD              ;04/29/2007
1671++97BD              ;Added 1.XX and 2.XX special commands interpretation for PT3
1672++97BD              ;modules of v3.7+.
1673++97BD
1674++97BD              ;Size (minimal build for ZX Spectrum):
1675++97BD              ;Code block #908 bytes
1676++97BD              ;Variables #2BF bytes (can be stripped)
1677++97BD              ;Total size #908+#2BF=#BC7 (3015) bytes
1678++97BD              	ENDMODULE
# file closed: player/player.asm
  77++97BD                  ENDIF
# file closed: player/vortex-processor.asm
  39+ 97BD                      include "player/mod-processor.asm"
# file opened: player/mod-processor.asm
   1++97BD                  MODULE ModProcessor
   2++97BD                  ifdef GS
   3++97BD ~
   4++97BD ~                macro GS_WaitCommand2
   5++97BD ~            .wait
   6++97BD ~                in a, (CMD)
   7++97BD ~                rrca
   8++97BD ~                jr c, .wait
   9++97BD ~                endm
  10++97BD ~
  11++97BD ~                macro GS_SendCommand2 nn
  12++97BD ~                ld a, nn
  12++97BD ~              out (CMD), a
  13++97BD ~                endm
  14++97BD ~
  15++97BD ~            play:
  16++97BD ~                ld a, 255
  17++97BD ~                ld (oldminutes), a
  18++97BD ~
  19++97BD ~                call Console.waitForKeyUp
  20++97BD ~
  21++97BD ~                ld hl, Gopher.requestbuffer
  21++97BD ~              call DialogBox.msgNoWait
  22++97BD ~
  23++97BD ~                ;ld a, 1, (Render.play_next), a
  24++97BD ~            	xor a
  25++97BD ~            	ld (last_song_position),a
  26++97BD ~
  27++97BD ~                ld h, #00, a, 32
  28++97BD ~                call TextMode.fillLine
  29++97BD ~                ld de, #0001
  29++97BD ~              call TextMode.gotoXY
  30++97BD ~                ld hl, message
  30++97BD ~              call TextMode.printZ
  31++97BD ~                ld a, #00
  32++97BD ~                call TextMode.highlightLine
  33++97BD ~
  34++97BD ~            .loop
  35++97BD ~                halt
  36++97BD ~                xor a
  37++97BD ~                call Console.peekC
  38++97BD ~                cp Console.BACKSPACE
  39++97BD ~                jp z, .stopKey
  40++97BD ~            	cp SPACE
  41++97BD ~                jp z, .playNext
  42++97BD ~
  43++97BD ~                call printRTC
  44++97BD ~
  45++97BD ~               ;  MOD   
  46++97BD ~                GS_SendCommand2 CMD_GET_SONG_POSITION
  47++97BD ~                GS_WaitCommand2
  48++97BD ~            	ld a,(last_song_position) ; 
  49++97BD ~            	ld c,a
  50++97BD ~            	in a,(DATA) ; 
  51++97BD ~            	ld (last_song_position),a
  52++97BD ~            	cp c
  53++97BD ~            	jr nc, .loop ;  ,  
  54++97BD ~            .playNext
  55++97BD ~                ld a, 1, (Render.play_next), a ;      
  56++97BD ~            .stop
  57++97BD ~                call GeneralSound.stopModule
  58++97BD ~
  59++97BD ~                call Console.waitForKeyUp
  60++97BD ~                ret
  61++97BD ~            .stopKey
  62++97BD ~                xor a
  62++97BD ~              ld (Render.play_next), a ;      
  63++97BD ~                jr .stop
  64++97BD ~
  65++97BD ~            message
  66++97BD ~                IFDEF SCREEN64
  67++97BD ~                ENDIF
  68++97BD ~                IFDEF SCREEN80
  69++97BD ~                db "       "
  70++97BD ~                ENDIF
  71++97BD ~                IFDEF SCREEN85
  72++97BD ~                db "         "
  73++97BD ~                ENDIF
  74++97BD ~
  75++97BD ~                db "Playing MODs [SPACE] for next song [BACKSPACE] for stop playing.", 0
  76++97BD ~
  77++97BD ~            CMD_GET_SONG_POSITION     = #60
  78++97BD ~            last_song_position db 0
  79++97BD ~
  80++97BD ~            ;; Control ports
  81++97BD ~            CMD  = 187
  82++97BD ~            DATA = 179
  83++97BD                  endif
  84++97BD                  ENDMODULE
  85++97BD
# file closed: player/mod-processor.asm
  40+ 97BD                      include "screen/screen.asm"
# file opened: screen/screen.asm
   1++97BD                  module ScreenViewer
   2++97BD              display:
   3++97BD CD F7 69         call Console.waitForKeyUp
   4++97C0 3E 07            ld a, 7
   4++97C2 CD BE 8A       call Memory.setPage
   5++97C5 21 E2 97 11      ld hl, outputBuffer, de, #c000, bc, 6912
   5++97C9 00 C0 01 00
   5++97CD 1B
   5++97CE ED B0          ldir
   6++97D0 CD 46 60         call TextMode.disable
   7++97D3              .wait
   8++97D3 76           	halt
   9++97D4 AF               xor a
   9++97D5 DB FE          in a, (#fe)
   9++97D7 2F             cpl
   9++97D8 E6 1F          and 31
   9++97DA 28 F7          jr z, .wait
  10++97DC CD 1D 60         call TextMode.cls
  11++97DF C3 00 72         jp History.back
  12++97E2
  13++97E2                  endmodule
# file closed: screen/screen.asm
  41+ 97E2              start:
  42+ 97E2              outputBuffer:
  43+ 97E2 F3                   di
  44+ 97E3 AF                   xor a
  44+ 97E4 32 6A 5C       ld (#5c6a), a  ; Thank you, Mario Prato, for feedback
  45+ 97E7 32 00 5C             ld (#5c00),a
  46+ 97EA 31 00 60             ld sp, asmOrg
  47+ 97ED CD B4 8A             call Memory.init
  48+ 97F0 AF                   xor a
  48+ 97F1 D3 FE          out (#fe),a
  49+ 97F3 FB                   ei
  50+ 97F4
  51+ 97F4 3E 07                ld a, 7
  51+ 97F6 CD BE 8A       call Memory.setPage
  52+ 97F9                      ;; Logo
  53+ 97F9 21 31 98 06          ld hl, logo, b, Dos.FMODE_READ
  53+ 97FD 01
  53+ 97FE CD 6B 6C       call Dos.fopen
  54+ 9801 F5                   push af
  55+ 9802 21 00 C0 01          ld hl, #c000, bc, 6912
  55+ 9806 00 1B
  55+ 9808 CD 58 6D       call Dos.fread
  56+ 980B F1                   pop af
  57+ 980C CD 44 6D             call Dos.fclose
  58+ 980F
  59+ 980F 06 32                ld b, 50
  60+ 9811 76           1       halt
  61+ 9812 10 FD                djnz 1b
  62+ 9814                  ENDIF
  63+ 9814
  64+ 9814 CD 03 60         call TextMode.init
  65+ 9817 21 20 98     	ld hl, initing
  65+ 981A CD BC 60       call TextMode.printZ
  66+ 981D
  67+ 981D                  IFNDEF NOINIT
  68+ 981D ~              	    call Wifi.init
  69+ 981D                  ENDIF
  70+ 981D
  71+ 981D C3 6D 72         jp History.home
  72+ 9820
  73+ 9820 49 6E 69 74  initing db "Initing Wifi...", "\r", 0
  73+ 9824 69 6E 67 20
  73+ 9828 57 69 66 69
  73+ 982C 2E 2E 2E 0D
  73+ 9830 00
  74+ 9831 62 72 6F 77  logo    db "browser/logo.scr", 0
  74+ 9835 73 65 72 2F
  74+ 9839 6C 6F 67 6F
  74+ 983D 2E 73 63 72
  74+ 9841 00
  75+ 9842 62 72 6F 77  creds   db "browser/auth.pwd", 0
  75+ 9846 73 65 72 2F
  75+ 984A 61 75 74 68
  75+ 984E 2E 70 77 64
  75+ 9852 00
  76+ 9853              outputBuffer2:
  77+ 9853 41 54 45 30      db  "ATE0", 0
  77+ 9857 00
  78+ 9858
  79+ 9858                  display "ENDS: ", $
  80+ 9858                  display "Buff size", #ffff - $
  81+ 9858                  IFDEF NEDOOS
  82+ 9858 ~                    savebin "moon.com", asmOrg, $ - asmOrg
  83+ 9858                  ELSE
  84+ 9858              		IFDEF TRDOS
  85+ 9858              			SAVETRD "MOONR.TRD",|"moon.C",asmOrg, $ - asmOrg
  86+ 9858              		ELSE
  87+ 9858 ~            			savebin "moon.bin", asmOrg, $ - asmOrg
  88+ 9858              	    	ENDIF
  89+ 9858                  ENDIF
  90+ 9858
# file closed: main-all.asm
  17  9858                  ENDIF
# file closed: main.asm
