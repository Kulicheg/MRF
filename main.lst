# file opened: main.asm
   1  0000                  DEFINE TCP_BUF_SIZE 1024
   2  0000              ; Generate version string
   3  0000                  LUA ALLPASS
   4  0000 ~                v = tostring(sj.get_define("V"))
   5  0000 ~                maj = string.sub(v, 1,1)
   6  0000 ~                min = string.sub(v, 2,2)
   7  0000 ~                sj.insert_define("VERSION_STRING", "\"" .. maj .. "." .. min .. "\"")
   8  0000 ~
   9  0000 ~                b = tostring(sj.get_define("BLD"))
  10  0000 ~                sj.insert_define("BUILD_STRING", "\"" .. b .. "\"")
  11  0000                  ENDLUA
  12  0000
  13  0000                  IFDEF MSX
  14  0000 ~                    include "main-msx.asm"
  15  0000                  ELSE
  16  0000                      include "main-all.asm"
# file opened: main-all.asm
   1+ 0000                  device	zxspectrum128
   2+ 0000                  IFDEF NEDOOS
   3+ 0000              	DEFINE CRLF "\r\n"
   4+ 0000                      MODULE nos
   5+ 0000                          include "../_sdk/sysdefs.asm"
# file opened: ../_sdk/sysdefs.asm
   1++0000              BDOS=0x0005
   2++0000              COMMANDLINE=0x0080
   3++0000              COMMANDLINE_sz=0x0080
   4++0000              PROGSTART=0x0100
   5++0000
   6++0000              ;from userkrnl.asm:
   7++0000              curpg4000=0x0043
   8++0000              curpg16k=curpg4000;0x0043
   9++0000              curpg8000=0x0049
  10++0000              curpg32klow=curpg8000;0x0049
  11++0000              curpgc000=0x004f
  12++0000              curpg32khigh=curpgc000;0x004f
  13++0000              user_scr0_low=0x0017
  14++0000              user_scr0_high=0x0035
  15++0000              user_scr1_low=0x0036
  16++0000              user_scr1_high=0x0037
  17++0000
  18++0000              MAXPATH_sz=256;64
  19++0000              DIRMAXFILENAME64=64 ;including EOL
  20++0000
  21++0000              ;------------------------СТРУКТУРЫ CP/M --------------------------------------
  22++0000              ;from CP/M (try to avoid use!):
  23++0000              CMD_PRCHAR=0x05 ;e=char
  24++0000              CMD_SETDRV=0x0e ;e=drive ;out: a!=0 => not mounted, [l=number of drives]
  25++0000              CMD_FOPEN=0x0f ;de = pointer to unopened FCB
  26++0000              CMD_FCLOSE=0x10 ;de = pointer to opened FCB
  27++0000              CMD_FSEARCHFIRST=0x11 ;de = pointer to unopened FCB (filename with ????????), read matching FCB to DTA. DTA had to set every time
  28++0000              CMD_FSEARCHNEXT=0x12 ;(NOT CP/M compatible!!!)de = pointer to unopened FCB (filename with ????????), read matching FCB to DTA. DTA had to set every time
  29++0000              CMD_FDEL=0x13 ;DEPRECATED!!!!! ;DE = Pointer to unopened FCB
  30++0000              CMD_FREAD=0x14 ;DE = Pointer to opened FCB, read 128 bytes in DTA, out: a=128^bytes actually read (not CP/M!)
  31++0000              CMD_FWRITE=0x15 ;DE = Pointer to opened FCB, write 128 bytes from DTA
  32++0000              CMD_FCREATE=0x16 ;DE = Pointer to unopened FCB
  33++0000              CMD_SETDTA=0x1a ;DE = data transfer address (DTA)
  34++0000              CMD_RNDRD=0x21 ;DE = Pointer to opened FCB. The file position is defined by the three byte random record number in the FCB (bytes 21h...23h). TP uses 21,22
  35++0000              CMD_RNDWR=0x22 ;DE = Pointer to opened FCB. The file position is defined by the three byte random record number in the FCB (bytes 21h...23h). TP uses 21,22
  36++0000
  37++0000              ;from MSX-DOS:
  38++0000              CMD_SEEKHANDLE=0x4a ;b=file handle, dehl=offset [signed, a=method:0=begin,1=cur,2=end TODO]
  39++0000              CMD_OPENHANDLE=0x43 ;DE = Drive/path/file ASCIIZ string
  40++0000                                      ;[A = Open mode. b0 set => no write, b1 set => no read, b2 set => inheritable, b3..b7   -  must be clear]
  41++0000                                      ;out: B = new file handle, A=error
  42++0000              CMD_CREATEHANDLE=0x44 ;DE = Drive/path/file ASCIIZ string
  43++0000                                      ;[A = Open mode. b0 set => no write, b1 set => no read, b2 set => inheritable, b3..b7   -  must be clear]
  44++0000                                      ;[B = b0..b6 = Required attributes, b7 = Create new flag]
  45++0000                                      ;out: B = new file handle, A=error
  46++0000              CMD_CLOSEHANDLE=0x45 ;B = file handle, out: A=error
  47++0000              CMD_READHANDLE=0x48 ;B = file handle, DE = Buffer address, HL = Number of bytes to read, out: HL = Number of bytes actually read, A=error(=0)
  48++0000              CMD_WRITEHANDLE=0x49 ;B = file handle, DE = Buffer address, HL = Number of bytes to write, out: HL = Number of bytes actually written, A=error(=0)
  49++0000              CMD_RENAME=0x4e ;DE = Drive/path/file ASCIIZ string, HL = New filename ASCIIZ string (NOT MSXDOS compatible! with Drive/path!) ;RENAME OR MOVE FILE
  50++0000              CMD_CHDIR=0x5a ;DE = Pointer to ASCIIZ string. Out A=error
  51++0000              CMD_PARSEFNAME=0x5c ;NOT RECOMMENDED ;de(dotname) -> hl(cpmname) ;out: de=pointer to termination character, hl=buffer filled in
  52++0000              CMD_GETPATH=0x5e ;DE = Pointer to MAXPATH_sz byte buffer ;out: DE = Filled in with whole path string (WITH DRIVE! Finished by slash only if root dir), HL = Pointer to start of last item
  53++0000              CMD_DELETE=0x4d ;DE = Drive/path/file ASCIIZ string, out: A = Error
  54++0000
  55++0000              ;invented:
  56++0000              CMD_GETPAL=0xc8 ;de=palette (32 bytes)
  57++0000              CMD_SETTIME=0xc9 ;ix=date, hl=time
  58++0000              CMD_GETMEMPORTS=0xca ;out: ix=memport0000, bc=memport4000, de=memport8000, hl=memportc000
  59++0000              CMD_GETPAGEOWNER=0x0cb ;e=page ;out: e=owner id (0=free, 0xff=system)
  60++0000              CMD_GETCONFIG=0xcc ;out: H=system drive, L= 1-Evo 2-ATM2 3-ATM3 6-p2.666, E=pgsys(system page), D= TR-DOS page, IXBC=SVN revision
  61++0000              CMD_GETCHILDRESULT=0xcd ;hl=childresult
  62++0000              CMD_RESERV_1=0xce
  63++0000              CMD_OPENDIR=0xcf ;de=path
  64++0000              CMD_READDIR=0xd0 ;de=buf for FILINFO (if no LNAME, use FNAME), 0x00 in FILINFO_FNAME = end dir
  65++0000              CMD_HIDEFROMPARENT=0xd1 ;for tasks with their own screen handling ;hl=result
  66++0000              CMD_SETSTDINOUT=0xd2 ;b=id, e=stdin, d=stdout, h=stderr
  67++0000              CMD_GETSTDINOUT=0xd3 ;e=stdin, d=stdout, h=stderr, l=hgt of stdout
  68++0000              CMD_PLAYCOVOX=0xd4 ;hl=data (0xc000+, 0x00=end), de=pagetable (0x0000+), hx=delay (18=11kHz, 7=22kHz, 1=44kHz)
  69++0000              CMD_SETMUSIC=0xd5 ;hl=muzaddr (0x4000..0x7fff, 0=killmuz), a=muzpg (pages in 0x8000, 0xc000 are taken from current user memory)
  70++0000              CMD_READSECTORS=0xd6 ;b=drive, de=buffer, ixhl=sector number, a=count ;out: a=error
  71++0000              CMD_WRITESECTORS=0xd7 ;b=drive, de=buffer, ixhl=sector number, a=count ;out: a=error
  72++0000              CMD_SETBORDER=0xd8 ;e=0..15
  73++0000              CMD_SETWAITING=0xd9 ;don't use directly! ;set WAITING state for current task
  74++0000              CMD_GETFILESIZE=0xda ;b=handle, out: dehl=file size
  75++0000              CMD_WIZNETOPEN=0xdb ;A=SOCKET, L=subfunction (see sys_h.asm)
  76++0000              CMD_WIZNETCLOSE=0xdc ;A=SOCKET, E=(0 - закрыть сразу, 1 - закрыть только если буфер отправки пуст)
  77++0000              CMD_WIZNETREAD=0xdd 	;if TCP: A=SOCKET, de=buffer_ptr, HL=sizeof(buffer)
  78++0000              						;else:	 A=SOCKET, IX=buffer_ptr, HL=sizeof(buffer), de=sockaddr_in ptr
  79++0000              						;out: HL=count if HL < 0 then A=error
  80++0000              CMD_WIZNETWRITE=0xde 	;if TCP: A=SOCKET, de=buffer_ptr, HL=sizeof(buffer)
  81++0000              						;else:	 A=SOCKET, IX=buffer_ptr, HL=sizeof(buffer), de=sockaddr_in ptr
  82++0000              						;out: HL=count if HL < 0 then A=error
  83++0000              CMD_DROPAPP=0xdf ;e=id
  84++0000              CMD_GETAPPMAINPAGES=0xe0 ;e=id ;out: d,e,h,l=pages in 0000,4000,8000,c000, c=flags, a=error
  85++0000              CMD_GETXY=0xe1 ;OBSOLETE ;out: de=yx ;GET CURSOR POSITION
  86++0000              CMD_GETTIME=0xe2 ;out: ix=date, hl=time
  87++0000              CMD_GETFILETIME=0xe3 ;de=Drive/path/file ASCIIZ string, out: ix=date, hl=time
  88++0000              CMD_SETFILETIME=0xe4 ;de=Drive/path/file ASCIIZ string, ix=date, hl=time
  89++0000              CMD_TELLHANDLE=0xe5 ;b=file handle, out: dehl=offset ;GET POSITION IN FILE
  90++0000              CMD_SCROLLUP=0xe6 ;OBSOLETE ;de=topyx, hl=hgt,wid ;x, wid even ;TEXTMODE ONLY
  91++0000              CMD_SCROLLDOWN=0xe7 ;OBSOLETE ;de=topyx, hl=hgt,wid ;x, wid even ;TEXTMODE ONLY
  92++0000              CMD_GETFILINFO=0xe8 ;de=filename, hl=buf[FILINFO_sz] to get FILINFO
  93++0000              CMD_SETMAINPAGE=0xe9 ;e=page for 0x0000
  94++0000              CMD_SETSYSDRV=0xea ;out: a!=0 => not mounted, l=number of drives
  95++0000              CMD_MKDIR=0xeb ;DE = Pointer to ASCIIZ string, out: a
  96++0000              CMD_CHECKPID=0xec ;e=id ;check if this child(!) app exists, out: a!=0 => OK, or else a=0
  97++0000              CMD_FREEZEAPP=0xed ;e=id ;disable app and make non-graphic
  98++0000              CMD_GETATTR=0xee ;DEPRECATED!!! ;out: a ;READ ATTR AT CURSOR POSITION
  99++0000              CMD_MOUNT=0xef ;e=drive, out: a
 100++0000              CMD_GETKEYMATRIX=0xf0 ;out: bcdehlix = halfrows cs...space
 101++0000              CMD_GETTIMER=0xf1 ;out: dehl=timer
 102++0000              CMD_YIELD=0xf2 ;schedule to another app (use YIELD macro instead of HALT!!!)
 103++0000              CMD_RUNAPP=0xf3 ;e=id ;ACTIVATE DISABLED APP
 104++0000              CMD_NEWAPP=0xf4 ;out: b=id, a=error, dehl=newapp pages in 0000,4000,8000,c000 ;MAKE NEW DISABLED APP
 105++0000              CMD_PRATTR=0xf5 ;OBSOLETE ;e=color byte ;DRAW ATTR AT CURSOR POSITION
 106++0000              CMD_CLS=0xf6 ;e=color byte
 107++0000              CMD_SETCOLOR=0xf7 ;e=color byte
 108++0000              CMD_SETXY=0xf8 ;de=yx ;SET CURSOR POSITION
 109++0000              CMD_SETGFX=0xf9 ;e=0:EGA, e=2:MC, e=3:6912, e=6:text ;+8 for noturbo ;+0x80 for auto screen pages keeping ;+SET FOCUS ;e=-1: disable gfx (out: e=old gfxmode)
 110++0000              CMD_SETPAL=0xfa ;de=palette (32 bytes)
 111++0000              CMD_GETMAINPAGES=0xfb ;out: d,e,h,l=pages in 0000,4000,8000,c000, c=flags, b=id
 112++0000              CMD_NEWPAGE=0xfc ;out: a=0 (OK)/!=0 (fail), e=page
 113++0000              CMD_DELPAGE=0xfd ;e=page ;GIVE SOME PAGE BACK TO THE OS
 114++0000              CMD_SETSCREEN=0xfe ;e=screen=0..1
 115++0000              CMD_YIELDKEEP=0xff
 116++0000
 117++0000              ;	STRUCT FILINFO
 118++0000              FILINFO_FSIZE=0;	        DWORD		;/* FILE SIZE */
 119++0000              FILINFO_FDATE=4;	        WORD		;/* LAST MODIFIED DATE */
 120++0000              FILINFO_FTIME=6;	        WORD		;/* LAST MODIFIED TIME */
 121++0000              FILINFO_FATTRIB=8;	        BYTE		;/* ATTRIBUTE */
 122++0000              FILINFO_FNAME=9;	        BLOCK 13,0	;/* SHORT FILE NAME (8.3 FORMAT with dot and terminator) */
 123++0000              FILINFO_LNAME=22;	        BLOCK DIRMAXFILENAME64,0	;/* LONG FILE NAME (ASCIIZ) */
 124++0000              FILINFO_sz=FILINFO_LNAME+DIRMAXFILENAME64
 125++0000
 126++0000              ;        STRUCT FCB
 127++0000              FCB_drv=0 ;drv             BYTE; /* drive number */
 128++0000              FCB_FNAME=1 ;FNAME           BLOCK 11;
 129++0000              FCB_EXTENTNUMBERLO=12 ;EXTENTNUMBERLO  BYTE; ;NU
 130++0000              FCB_FATTRIB=13 ;FATTRIB         BYTE;
 131++0000              FCB_EXTENTNUMBERHI=14 ;EXTENTNUMBERHI  BYTE; ;NU
 132++0000              FCB_RECORDCOUNT=15 ;RECORDCOUNT     BYTE; ;NU
 133++0000              FCB_FSIZE=16 ;FSIZE           DWORD;
 134++0000              FCB_FTIME=20 ;FTIME           WORD;
 135++0000              FCB_FFSFCB=22 ;FFSFCB          WORD; /* TRDOSFCB или FIL */
 136++0000              FCB_DIRPOS=24 ;DIRPOS          WORD; /* привязка к точке поиска */
 137++0000              ;RESERVED        BLOCK 2 ;reserved (14 in MS-DOS???)
 138++0000              FCB_RECORDSIZE=28 ;RECORDSIZE      WORD; /* must be 128 */
 139++0000              FCB_FDATE=30 ;FDATE           WORD
 140++0000              FCB_FRECORD=32 ;FRECORD         BYTE; /*номер записи внутри экстента*/
 141++0000              ;	ENDS
 142++0000              FCB_sz=33
 143++0000
 144++0000              FATTRIB_DIR=0x10 ;mask for FCB_FATTRIB
 145++0000
 146++0000              ;Application flags:
 147++0000
 148++0000              factive=0 ;0=zombie, 1=scheduled ;TODO есть сообщения: SET при добавлении сообщения, RES при взятии последнего сообщения
 149++0000              fchildfinished=1 ;устанавливается при завершении дочернего процесса (чтобы в этом случае проскочить SETWAITING), сбрасывается по GETCHILDRESULT
 150++0000              ;fcritical=4 (чтобы не портить hl)
 151++0000              fgfx=5 ;app can take focus
 152++0000              ;ffocus=6 ;app has focus (only one can)
 153++0000              fwaiting=7 ;app is waiting for another app, can't take focus by hand
 154++0000
 155++0000              ;Internal keyboard values:
 156++0000
 157++0000              extbase=0xb0 ;with H=1 ;can't mix with 32..127 ;temporary internal code
 158++0000              csbase=0xf3 ;temporary internal code
 159++0000              extenter=csbase+12 ;temporary internal code
 160++0000              graphlock=extenter ;temporary internal code
 161++0000              csnoshifts=0;NOKEY ;cs release result for AltGr ;temporary internal code
 162++0000              csspace=27 ;temporary internal code
 163++0000              csss=9 ;Tab ;temporary internal code
 164++0000              key_extspace=0;NOKEY ;extbase+14 ;unusable because happens simultaneously with extZ because of keyboard matrix
 165++0000              cssspress=csss ;temporary internal code (impossible to type without AltGr before language recoding)
 166++0000              ssnoshifts=0xd1 ;temporary internal code (impossible to type without AltGr before language recoding)
 167++0000              ext0=extbase+0
 168++0000              ext1=extbase+1
 169++0000              ext2=extbase+2
 170++0000              ext3=extbase+3
 171++0000              ext4=extbase+4
 172++0000              ext5=extbase+5
 173++0000              ext6=extbase+6
 174++0000              ext7=extbase+7
 175++0000              ext8=extbase+8
 176++0000              ext9=extbase+9
 177++0000              cs0=8 ;as extH (CP/M) ;csbase+0 reserved
 178++0000              cs1=csbase+1 ;readable only in keynolang (switches language)
 179++0000              cs2=csbase+2 ;readable only in keynolang (switches Caps Lock)
 180++0000              cs3=csbase+3
 181++0000              cs4=csbase+4
 182++0000              cs5=csbase+5
 183++0000              cs6=csbase+6
 184++0000              cs7=csbase+7
 185++0000              cs8=csbase+8
 186++0000              cs9=csbase+9
 187++0000
 188++0000              ;Usable key codes:
 189++0000
 190++0000              extA=1
 191++0000              extB=2
 192++0000              extC=3
 193++0000              extD=4
 194++0000              extE=5
 195++0000              extF=6
 196++0000              extG=7
 197++0000              extH=8 ;as cs0 (BackSpace)
 198++0000              extI=9 ;as csss (Tab)
 199++0000              extJ=10
 200++0000              extK=11
 201++0000              extL=12
 202++0000              extM=13 ;as Enter
 203++0000              extN=14
 204++0000              extO=15
 205++0000              extP=16
 206++0000              extQ=17
 207++0000              extR=18
 208++0000              extS=19
 209++0000              extT=20
 210++0000              extU=21
 211++0000              extV=22
 212++0000              extW=23
 213++0000              extX=24
 214++0000              extY=25
 215++0000              extZ=26
 216++0000
 217++0000              ss0='_'
 218++0000              ss1='!'
 219++0000              ss2='@'
 220++0000              ss3='#'
 221++0000              ss4='$'
 222++0000              ss5='%'
 223++0000              ss6='&'
 224++0000              ss7=0x27;'\''
 225++0000              ss8='('
 226++0000              ss9=')'
 227++0000              ssA='~'
 228++0000              ssB='*'
 229++0000              ssC='?'
 230++0000              ssD=0x5c;'\\'
 231++0000              ssE=30;extbase+30
 232++0000              ssF='{'
 233++0000              ssG='}'
 234++0000              ssH='^'
 235++0000              ssI=127;extbase+12
 236++0000              ssJ='-'
 237++0000              ssK='+'
 238++0000              ssL='='
 239++0000              ssM='.'
 240++0000              ssN=','
 241++0000              ssO=';'
 242++0000              ssP=0x22;'"'
 243++0000              ssQ=28;extbase+28
 244++0000              ssR='<'
 245++0000              ssS='|'
 246++0000              ssT='>'
 247++0000              ssU=']'
 248++0000              ssV='/'
 249++0000              ssW=29;extbase+29
 250++0000              ssX='`'
 251++0000              ssY='['
 252++0000              ssZ=':'
 253++0000
 254++0000              key_home=ssQ
 255++0000              key_end=ssE
 256++0000              key_ins=ssW
 257++0000              key_enter=13
 258++0000              key_left=cs5
 259++0000              key_right=cs8
 260++0000              key_up=cs7
 261++0000              key_down=cs6
 262++0000              key_pgup=cs3
 263++0000              key_pgdown=cs4
 264++0000              key_backspace=cs0
 265++0000              key_del=cs9
 266++0000              key_ssleft=ext5
 267++0000              key_ssright=ext8
 268++0000              key_ssup=ext7
 269++0000              key_ssdown=ext6
 270++0000              key_sspgup=ext3
 271++0000              key_sspgdown=ext4
 272++0000              key_ssbackspace=ext0
 273++0000              key_ssdel=ext9
 274++0000              key_tab=csss
 275++0000              key_esc=csspace
 276++0000              key_csenter=csbase+10
 277++0000              key_ssspace=csbase+11
 278++0000              key_F1=ext1
 279++0000              key_F2=ext2
 280++0000              key_F3=ext3
 281++0000              key_F4=ext4
 282++0000              key_F5=ext5
 283++0000              key_F6=ext6
 284++0000              key_F7=ext7
 285++0000              key_F8=ext8
 286++0000              key_F9=ext9
 287++0000              key_F10=ext0
 288++0000
 289++0000              NOKEY=0
 290++0000              key_redraw=31 ;if equal to ssEnter, then scheduling through idle will catch ssEnter twice
 291++0000              ;single ext (Tab) is returned at key release (TODO keypress in keynolang)
 292++0000              ;single ss, cs keypresses are not returned, or else CP/M-like apps can't filter them out (TODO in keynolang, and all other key releases too)
 293++0000
# file closed: ../_sdk/sysdefs.asm
   6+ 0000                      ENDMODULE
   7+ 0000                      org nos.PROGSTART
   8+ 0100                      ELSE
   9+ 0100 ~            	DEFINE CRLF "\r"
  10+ 0100 ~                    org 24576
  11+ 0100                  ENDIF
  12+ 0100              asmOrg:
  13+ 0100                  align 256
  14+ 0100 C3 A3 4C         jp start
  15+ 0103                  include "vdp/index.asm"
# file opened: vdp/index.asm
   1++0103                  IFDEF TIMEX
   2++0103 ~                include "timex.asm"
   3++0103                  ENDIF
   4++0103
   5++0103                  IFDEF TIMEX80
   6++0103 ~                include "timex80.asm"
   7++0103                  ENDIF
   8++0103
   9++0103                  IFDEF ZXSCR
  10++0103 ~                include "zx.asm"
  11++0103                  ENDIF
  12++0103
  13++0103              	IFDEF NEDOOS
  14++0103                  include "nedotext.asm"
# file opened: vdp/nedotext.asm
   1++0103
   2++0103                  MODULE TextMode
   3++0103 00           pg4	defb 0
   4++0104 00           pg0	defb 0
   5++0105 00           pgC	defb 0
   6++0106 00           pg8	defb 0
   7++0107              init
   8++0107 0E D1        	ld c,nos.CMD_HIDEFROMPARENT
   9++0109 CD 05 00     	call nos.BDOS
  10++010C 1E 86        	ld e,0x86
  11++010E 0E F9        	ld c,nos.CMD_SETGFX
  12++0110 CD 05 00     	call nos.BDOS
  13++0113 0E F2        	ld c,nos.CMD_YIELD
  14++0115 CD 05 00     	call nos.BDOS
  15++0118 0E FB        	ld c,nos.CMD_GETMAINPAGES
  16++011A CD 05 00     	call nos.BDOS
  17++011D ED 53 03 01  	ld (pg4),de
  18++0121 22 05 01     	ld (pgC),hl
  19++0124 C3 30 01     	jp cls
  20++0127
  21++0127              printZ
  22++0127 7E           	ld a,(hl)
  23++0128 B7           	or a
  24++0129 C8           	ret z
  25++012A 23           	inc hl
  26++012B E5           	push hl
  27++012C D7           	rst 0x10
  28++012D E1           	pop hl
  29++012E 18 F7        	jr printZ
  30++0130
  31++0130              cls
  32++0130 1E 07        	ld e,7
  33++0132 0E F6        	ld c,nos.CMD_CLS
  34++0134 C3 05 00     	jp nos.BDOS
  35++0137
  36++0137              putC
  37++0137 C3 10 00     	jp 0x0010
  38++013A
  39++013A              gotoXY
  40++013A E5           	push hl
  41++013B 0E F8        	ld c,nos.CMD_SETXY
  42++013D CD 05 00     	call nos.BDOS
  43++0140 E1           	pop hl
  44++0141 C9           	ret
  45++0142
  46++0142              fillLine:
  47++0142 54 1E 00         ld d, h, e, 0
  47++0145 CD 3A 01       call gotoXY
  48++0148 06 50            ld b, 80
  49++014A              .loop
  50++014A F5 C5            push af, bc
  51++014C D7               rst 0x10
  52++014D C1 F1            pop bc, af
  53++014F 10 F9            djnz .loop
  54++0151 C9               ret
  55++0152
  56++0152              usualLine
  57++0152 57           	ld d,a
  58++0153 1E 00        	ld e,0
  59++0155              .mloop
  60++0155 D5           	push de
  61++0156 0E F8        	ld c,nos.CMD_SETXY
  62++0158 CD 05 00     	call nos.BDOS
  63++015B 1E 07        	ld e,7
  64++015D 0E F5        	ld c,nos.CMD_PRATTR
  65++015F CD 05 00     	call nos.BDOS
  66++0162 D1           	pop de
  67++0163 1C           	inc e
  68++0164 7B           	ld a,e
  69++0165 FE 50        	cp 80
  70++0167 20 EC        	jr nz,.mloop
  71++0169 C9           	ret
  72++016A
  73++016A              highlightLine
  74++016A 57           	ld d,a
  75++016B 1E 00        	ld e,0
  76++016D              .mloop
  77++016D D5           	push de
  78++016E 0E F8        	ld c,nos.CMD_SETXY
  79++0170 CD 05 00     	call nos.BDOS
  80++0173 1E 4F        	ld e,79
  81++0175 0E F5        	ld c,nos.CMD_PRATTR
  82++0177 CD 05 00     	call nos.BDOS
  83++017A D1           	pop de
  84++017B 1C           	inc e
  85++017C 7B           	ld a,e
  86++017D FE 50        	cp 80
  87++017F 20 EC        	jr nz,.mloop
  88++0181 C9           	ret
  89++0182                  ENDMODULE
  90++0182
# file closed: vdp/nedotext.asm
  15++0182                  ENDIF
# file closed: vdp/index.asm
  16+ 0182                  include "utils/index.asm"
# file opened: utils/index.asm
   1++0182                  include "atoi.asm"
# file opened: utils/atoi.asm
   1++0182              ; DE - buffer
   2++0182              ; HL - output
   3++0182              atohl:
   4++0182 21 00 00         ld hl, 0
   5++0185              .loop
   6++0185 1A               ld a, (de)
   7++0186 13               inc de
   8++0187                  ; Sepparators
   9++0187 C5 E5            push bc, hl
  10++0189 01 05 00             ld bc, sepparators_len
  11++018C 21 A4 01             ld hl, sepparators
  12++018F ED B1                cpir
  13++0191 E1 C1            pop hl, bc
  14++0193 C8               ret z
  15++0194
  16++0194 D6 30            sub '0'
  17++0196
  18++0196 C5               push bc
  19++0197 4D                   ld c, l
  20++0198 44                   ld b, h
  21++0199
  22++0199 29                   add hl, hl
  23++019A 29                   add hl, hl
  24++019B 09                   add hl, bc
  25++019C 29                   add hl, hl
  26++019D 4F                   ld c, a
  27++019E 06 00                ld b, 0
  28++01A0 09                   add hl, bc
  29++01A1 C1               pop bc
  30++01A2 18 E1            jr .loop
  31++01A4
# file closed: utils/atoi.asm
   2++01A4                  include "constants.asm"
# file opened: utils/constants.asm
   1++01A4              TAB = 9
   2++01A4              CR = 13
   3++01A4              LF = 10
   4++01A4              NULL = 0
   5++01A4              SPACE = ' '
   6++01A4              ESC = 27
   7++01A4              BACKSPACE = 8
   8++01A4
   9++01A4                  IFDEF TIMEX80
  10++01A4 ~            MIME_DOWNLOAD 	= #19
  11++01A4 ~            MIME_LINK 		= #1A
  12++01A4 ~            MIME_TEXT 		= #10
  13++01A4 ~            MIME_IMAGE 		= #01
  14++01A4 ~            MIME_MUSIC 		= #0e
  15++01A4 ~            MIME_INPUT 		= #b3
  16++01A4 ~            MIME_MOD 		= #0d
  17++01A4 ~            MIME_SOUND      = 's' ;sound
  18++01A4 ~
  19++01A4 ~            BORDER_TOP = #b2
  20++01A4 ~            BORDER_BOTTOM = #b1
  21++01A4                  ELSE
  22++01A4              	IFDEF MSX
  23++01A4 ~            MIME_DOWNLOAD 	= 1
  24++01A4 ~            MIME_LINK		= 2
  25++01A4 ~            MIME_TEXT 		= 3
  26++01A4 ~            MIME_IMAGE 		= 4
  27++01A4 ~            MIME_MUSIC 		= 5
  28++01A4 ~            MIME_INPUT 		= 6
  29++01A4 ~            MIME_MOD      	= 7
  30++01A4 ~            MIME_SOUND      = 's' ;sound
  31++01A4 ~
  32++01A4 ~            BORDER_TOP    = 7
  33++01A4 ~            BORDER_BOTTOM = 8
  34++01A4              	ELSE
  35++01A4              MIME_DOWNLOAD = 1
  36++01A4              MIME_LINK     = 2
  37++01A4              MIME_TEXT     = 3
  38++01A4              MIME_IMAGE    = 6
  39++01A4              MIME_MUSIC    = 5
  40++01A4              MIME_INPUT    = 4
  41++01A4              MIME_MOD      = 7
  42++01A4              MIME_SOUND    = 's' ;sound
  43++01A4
  44++01A4              BORDER_TOP    = 9
  45++01A4              BORDER_BOTTOM = 8
  46++01A4              	ENDIF
  47++01A4
  48++01A4
  49++01A4
  50++01A4
  51++01A4              	ENDIF
  52++01A4
  53++01A4 0D 0A 09 00  sepparators db CR, LF, TAB, NULL, SPACE
  53++01A8 20
  54++01A9              sepparators_len = $ - sepparators
# file closed: utils/constants.asm
   3++01A9                  include "strutils.asm"
# file opened: utils/strutils.asm
   1++01A9              ; de - pointer
   2++01A9              ; hl - count
   3++01A9              strlen:
   4++01A9 21 00 00         ld hl, 0
   5++01AC              .loop
   6++01AC 1A               ld a, (de)
   7++01AD A7               and a
   7++01AE 28 04          jr z, .exit
   8++01B0 23               inc hl
   9++01B1 13               inc de
  10++01B2 18 F8            jr .loop
  11++01B4              .exit
  12++01B4 C9               ret
  13++01B5
  14++01B5                  module CompareBuff
  15++01B5
  16++01B5              ; Pushes A to buffer
  17++01B5              push
  18++01B5 F5               push af
  19++01B6 06 20            ld b, 32
  19++01B8 21 01 02       ld hl, buffer + 1
  19++01BB 11 00 02       ld de, buffer
  20++01BE              .loop
  21++01BE 7E               ld a, (hl)
  21++01BF 12             ld (de), a
  21++01C0 23             inc hl
  21++01C1 13             inc de
  21++01C2 10 FA          djnz .loop
  22++01C4 F1               pop af
  23++01C5 21 1F 02         ld hl, buffer + 31
  23++01C8 77             ld (hl), a
  24++01C9 C9               ret
  25++01CA
  26++01CA              ; HL - Compare string(null terminated)
  27++01CA              ; A - 0 NOT Found
  28++01CA              ;     1 Found
  29++01CA              search:
  30++01CA 06 00            ld b, 0
  30++01CC E5             push hl
  31++01CD              .loop:
  32++01CD 7E               ld a, (hl)
  32++01CE 23             inc hl
  32++01CF 04             inc b
  32++01D0 A7             and a
  32++01D1 C2 CD 01       jp nz, .loop
  33++01D4 05               dec b
  33++01D5 E1             pop hl
  33++01D6 C5             push bc
  33++01D7 E5             push hl
  34++01D8 E1               pop hl
  35++01D9 11 20 02         ld de, buffer + 32
  36++01DC              .sourceLoop
  37++01DC 1B               dec de
  37++01DD 10 FD          djnz .sourceLoop
  38++01DF C1               pop bc
  39++01E0              .compare
  40++01E0 C5               push bc
  40++01E1 F5             push af
  41++01E2 1A               ld a, (de)
  41++01E3 47             ld b, a
  42++01E4 F1               pop af
  42++01E5 7E             ld a, (hl)
  42++01E6 B8             cp b
  42++01E7 C1             pop bc
  42++01E8 3E 00          ld a, 0
  42++01EA C0             ret nz
  43++01EB 13               inc de
  43++01EC 23             inc hl
  44++01ED 10 F1            djnz .compare
  45++01EF 3E 01            ld a, 1
  46++01F1 C9               ret
  47++01F2
  48++01F2              clear:
  49++01F2 AF               xor a
  49++01F3 21 00 02       ld hl, buffer
  49++01F6 11 01 02       ld de, buffer + 1
  49++01F9 01 20 00       ld bc, 32
  49++01FC 77             ld (hl), a
  49++01FD ED B0          ldir
  50++01FF C9               ret
  51++0200
  52++0200 00 00 00...  buffer ds 32
  53++0220
  54++0220                  endmodule
# file closed: utils/strutils.asm
   4++0220                  IFDEF MSX
   5++0220 ~            	    include "bios.asm"
   6++0220                  ENDIF
   7++0220                  include "screen.asm"
# file opened: utils/screen.asm
   1++0220              LINE_LIMIT = 63
   2++0220
   3++0220                  IFDEF NEDOOS
   4++0220              LINE_LIMIT = 79
   5++0220                  ENDIF
   6++0220
   7++0220                  IFDEF TIMEX80
   8++0220 ~            LINE_LIMIT = 84
   9++0220                  ENDIF
  10++0220
  11++0220                  IFDEF MSX
  12++0220 ~            LINE_LIMIT = 79
  13++0220                  ENDIF
  14++0220              ; HL - string pointer
  15++0220              print70Text:
  16++0220 06 4F            ld b, LINE_LIMIT
  17++0222              .loop
  18++0222 7E               ld a, (hl)
  19++0223 A7               and a
  19++0224 C8             ret z
  20++0225 FE 0D            cp 13
  20++0227 C8             ret z
  21++0228 FE 0A            cp 10
  21++022A C8             ret z
  22++022B C5               push bc
  23++022C E5               push hl
  24++022D CD 37 01         call TextMode.putC
  25++0230 E1               pop hl
  26++0231 23               inc hl
  27++0232 C1               pop bc
  28++0233 05               dec b
  29++0234 78               ld a, b
  29++0235 A7             and a
  29++0236 C8             ret z
  30++0237 C3 22 02         jp .loop
  31++023A
  32++023A              ; HL - string pointer
  33++023A              print70Goph:
  34++023A 06 4F            ld b, LINE_LIMIT
  35++023C              .loop
  36++023C 7E               ld a, (hl)
  36++023D FE 09          cp 09
  36++023F C8             ret z
  37++0240 A7               and a
  37++0241 C8             ret z
  38++0242 C5               push bc
  39++0243 E5               push hl
  40++0244 CD 37 01         call TextMode.putC
  41++0247 E1               pop hl
  42++0248 23               inc hl
  43++0249 C1               pop bc
  44++024A 05               dec b
  45++024B 78               ld a, b
  45++024C A7             and a
  45++024D C8             ret z
  46++024E C3 3C 02         jp .loop
# file closed: utils/screen.asm
# file closed: utils/index.asm
  17+ 0251                  include "gopher/render/index.asm"
# file opened: gopher/render/index.asm
   1++0251                  MODULE Render
   2++0251              PER_PAGE = 22
   3++0251              CURSOR_OFFSET = 2
   4++0251                  include "row.asm"
# file opened: gopher/render/row.asm
   1++0251              ; A - row number
   2++0251              ; HL - pointer to row
   3++0251              renderRow:
   4++0251 C6 02            add CURSOR_OFFSET
   5++0253 57               ld d,a
   6++0254 1E 00            ld e,0
   7++0256 CD 3A 01         call TextMode.gotoXY
   8++0259 7E               ld a,(hl)
   9++025A E5               push hl
  10++025B CD 66 02         call getIcon
  11++025E CD 37 01         call TextMode.putC
  12++0261 E1               pop hl
  13++0262 23               inc hl
  14++0263 C3 3A 02         jp print70Goph
  15++0266
  16++0266              ; A - gopher id char
  17++0266              getIcon:
  18++0266 FE 69            cp 'i'
  18++0268 CA 87 02       jp z, .info
  19++026B FE 39            cp '9'
  19++026D CA 8A 02       jp z, .down
  20++0270 FE 31            cp '1'
  20++0272 CA 08 03       jp z, .page
  21++0275 FE 30            cp '0'
  21++0277 CA 0B 03       jp z, .text
  22++027A FE 37            cp '7'
  22++027C CA 0E 03       jp z, .input
  23++027F FE 73            cp 's'
  23++0281 CA 8A 02       jp z, .down
  24++0284 3E 20            ld a, ' '
  25++0286 C9               ret
  26++0287              .info
  27++0287 3E 20            ld a, SPACE
  27++0289 C9             ret
  28++028A              .down
  29++028A 54 5D            ld de, hl
  30++028C 01 FF 00 3E      ld bc, #ff, a, TAB
  30++0290 09
  30++0291 ED B1          cpir
  31++0293 78               ld a, b
  31++0294 B1             or c
  31++0295 28 6E          jr z, .downExit
  32++0297 D5               push de
  33++0298              .nameLoop
  34++0298 7E               ld a, (hl)
  34++0299 A7             and a
  34++029A 28 10          jr z, .check
  35++029C FE 09            cp TAB
  35++029E 28 0C          jr z, .check
  36++02A0 FE 0D            cp CR
  36++02A2 28 08          jr z, .check
  37++02A4 E5               push hl
  38++02A5 CD B5 01         call CompareBuff.push
  39++02A8 E1               pop hl
  40++02A9 23               inc hl
  41++02AA 18 EC            jr .nameLoop
  42++02AC              .check
  43++02AC 3A 4A 03     	ld a,(saveMode+1);я┐╜я┐╜я┐╜я┐╜ я┐╜я┐╜я┐╜я┐╜я┐╜ я┐╜я┐╜я┐╜я┐╜я┐╜я┐╜я┐╜я┐╜ я┐╜я┐╜я┐╜я┐╜я┐╜я┐╜, я┐╜я┐╜я┐╜я┐╜я┐╜ я┐╜я┐╜ я┐╜я┐╜я┐╜я┐╜я┐╜я┐╜я┐╜ я┐╜я┐╜ я┐╜я┐╜я┐╜я┐╜я┐╜я┐╜ Caps
  44++02AF B7           	or a
  45++02B0 20 52        	jr nz,.checkExit
  46++02B2 21 1D 03     	ld hl, scrExt1
  46++02B5 CD CA 01       call CompareBuff.search
  46++02B8 A7             and a
  46++02B9 20 56          jr nz, .image
  47++02BB 21 22 03         ld hl, scrExt2
  47++02BE CD CA 01       call CompareBuff.search
  47++02C1 A7             and a
  47++02C2 20 4D          jr nz, .image
  48++02C4 3E 03            ld a, 3
  48++02C6 32 0A 40       ld (VTPL.SETUP), a ; 0 bit - looping, 1 bit - pt2 file
  49++02C9 21 31 03         ld hl, pt2Ext1
  49++02CC CD CA 01       call CompareBuff.search
  49++02CF A7             and a
  49++02D0 20 43          jr nz, .music
  50++02D2 21 36 03         ld hl, pt2Ext2
  50++02D5 CD CA 01       call CompareBuff.search
  50++02D8 A7             and a
  50++02D9 20 3A          jr nz, .music
  51++02DB 3E 01            ld a, 1
  51++02DD 32 0A 40       ld (VTPL.SETUP), a
  52++02E0 21 27 03         ld hl, pt3Ext1
  52++02E3 CD CA 01       call CompareBuff.search
  52++02E6 A7             and a
  52++02E7 20 2C          jr nz, .music
  53++02E9 21 2C 03         ld hl, pt3Ext2
  53++02EC CD CA 01       call CompareBuff.search
  53++02EF A7             and a
  53++02F0 20 23          jr nz, .music
  54++02F2
  55++02F2                  ; General Sound support
  56++02F2                  ifdef GS
  57++02F2 21 3B 03         ld hl, modExt1
  57++02F5 CD CA 01       call CompareBuff.search
  57++02F8 A7             and a
  57++02F9 20 1E          jr nz, .mod
  58++02FB 21 40 03         ld hl, modExt2
  58++02FE CD CA 01       call CompareBuff.search
  58++0301 A7             and a
  58++0302 20 15          jr nz, .mod
  59++0304                  endif
  60++0304
  61++0304              .checkExit
  62++0304 E1               pop hl
  63++0305              .downExit
  64++0305 3E 01            ld a, MIME_DOWNLOAD
  64++0307 C9             ret
  65++0308              .page
  66++0308 3E 02            ld a, MIME_LINK
  66++030A C9             ret
  67++030B              .text
  68++030B 3E 03            ld a, MIME_TEXT
  68++030D C9             ret
  69++030E              .input
  70++030E 3E 04            ld a, MIME_INPUT
  70++0310 C9             ret
  71++0311              .image
  72++0311 E1               pop hl
  72++0312 3E 06          ld a, MIME_IMAGE
  72++0314 C9             ret
  73++0315              .music
  74++0315 E1               pop hl
  74++0316 3E 05          ld a, MIME_MUSIC
  74++0318 C9             ret
  75++0319              .mod
  76++0319 E1               pop hl
  76++031A 3E 07          ld a, MIME_MOD
  76++031C C9             ret
  77++031D
  78++031D 2E 73 63 72  scrExt1 db ".scr", 0
  78++0321 00
  79++0322 2E 53 43 52  scrExt2 db ".SCR", 0
  79++0326 00
  80++0327
  81++0327 2E 70 74 33  pt3Ext1 db ".pt3", 0
  81++032B 00
  82++032C 2E 50 54 33  pt3Ext2 db ".PT3", 0
  82++0330 00
  83++0331 2E 70 74 32  pt2Ext1 db ".pt2", 0
  83++0335 00
  84++0336 2E 50 54 32  pt2Ext2 db ".PT2", 0
  84++033A 00
  85++033B 2E 6D 6F 64  modExt1 db ".mod", 0
  85++033F 00
  86++0340 2E 4D 4F 44  modExt2 db ".MOD", 0
  86++0344 00
  87++0345
  88++0345              toggleSaveMode
  89++0345 F5           			push af
  90++0346 CD 51 08     			call Console.waitForKeyUp
  91++0349 3E 00        saveMode	ld a,0 ; я┐╜я┐╜я┐╜я┐╜ Open/Save files
  92++034B EE 01        			xor 1
  93++034D 32 4A 03     			ld (saveMode+1),a
  94++0350 F1           			pop af
  95++0351 C9           			ret
# file closed: gopher/render/row.asm
   5++0352                  include "buffer.asm"
# file opened: gopher/render/buffer.asm
   1++0352              ; BC - line count
   2++0352              findLine
   3++0352 21 A3 4C         ld hl, outputBuffer
   4++0355              findLine2
   5++0355 78               ld a,b
   6++0356 B1               or c
   7++0357 CA 84 03         jp z, .checkEmpty
   8++035A              .loop
   9++035A 7E               ld a, (hl)
  10++035B A7               and a
  11++035C CA 87 03         jp z, .nope
  12++035F 23               inc hl
  13++0360 FE 0D            cp 13
  14++0362 CA 7A 03         jp z, .checkLF  ;13
  15++0365 FE 0A            cp 10
  15++0367 CA 6D 03       jp z, .nextCheck     ;10
  16++036A C3 5A 03         jp .loop
  17++036D              .nextCheck
  18++036D A7               and a
  19++036E CA 87 03         jp z, .nope
  20++0371 0B               dec bc
  21++0372 57               ld d,a
  22++0373 78               ld a,b
  23++0374 B1               or c
  24++0375 7A               ld a,d
  25++0376 C2 5A 03         jp nz, .loop
  26++0379 C9               ret
  27++037A              .checkLF
  28++037A 7E               ld a, (hl)
  29++037B FE 0A            cp 10
  30++037D C2 6D 03         jp nz, .nextCheck    ;10
  31++0380 23               inc hl
  32++0381 C3 6D 03         jp  .nextCheck
  33++0384              .checkEmpty
  34++0384 7E               ld a, (hl)
  34++0385 A7             and a
  34++0386 C0             ret nz
  35++0387              .nope
  36++0387 21 00 00         ld hl, 0
  36++038A C9             ret
  37++038B
# file closed: gopher/render/buffer.asm
   6++038B                  include "ui.asm"
# file opened: gopher/render/ui.asm
   1++038B                  IFDEF ZXSCR
   2++038B ~                    DEFINE LEFT_TAB "[D]omain:                                  "
   3++038B ~                    DEFINE SCREEN_WIDTH 64
   4++038B ~                    DEFINE SCREEN64
   5++038B                  ENDIF
   6++038B
   7++038B                  IFDEF TIMEX     ;UNKNOWM fallback to 64
   8++038B ~                    DEFINE LEFT_TAB "[D]omain:                                  "
   9++038B ~                    DEFINE SCREEN_WIDTH 64
  10++038B ~                    DEFINE SCREEN64
  11++038B                  ENDIF
  12++038B
  13++038B                  IFDEF TIMEX80
  14++038B ~                    DEFINE LEFT_TAB "[D]omain:                                                      "
  15++038B ~                    DEFINE SCREEN_WIDTH 85
  16++038B ~                    DEFINE SCREEN85
  17++038B                  ENDIF
  18++038B
  19++038B                  IFDEF NEDOOS
  20++038B                      DEFINE LEFT_TAB "[D]omain:                                                  "
  21++038B                      DEFINE SCREEN_WIDTH 80
  22++038B                      DEFINE SCREEN80
  23++038B                  ENDIF
  24++038B
  25++038B                  IFDEF MSX
  26++038B ~                    DEFINE LEFT_TAB "[D]omain:                                              "
  27++038B ~                    DEFINE SCREEN_WIDTH 80
  28++038B ~                    DEFINE SCREEN80
  29++038B                  ENDIF
  30++038B              prepareScreen:
  31++038B CD 30 01         call TextMode.cls
  32++038E 21 5E 04         ld hl, header
  32++0391 CD 27 01       call TextMode.printZ
  33++0394 11 0A 00         ld de, #000A
  33++0397 CD 3A 01       call TextMode.gotoXY
  34++039A 21 5F 19         ld hl, hostName
  34++039D CD 27 01       call TextMode.printZ
  35++03A0 AF               xor a
  35++03A1 CD 6A 01       call TextMode.highlightLine
  36++03A4 C9               ret
  37++03A5
  38++03A5              inputHost:
  39++03A5 CD 51 08         	call Console.waitForKeyUp
  40++03A8              .loop
  41++03A8 11 0A 00         ld de, #000A
  41++03AB CD 3A 01       call TextMode.gotoXY
  41++03AE 21 5F 19       ld hl, hostName
  41++03B1 CD 27 01       call TextMode.printZ
  42++03B4 3E 04            ld a, MIME_INPUT
  42++03B6 CD 37 01       call TextMode.putC
  43++03B9 3E 20            ld a, ' '
  43++03BB CD 37 01       call TextMode.putC
  44++03BE              .wait
  45++03BE CD 38 08         call Console.getC
  46++03C1 5F               ld e, a
  47++03C2 FE 08            cp Console.BACKSPACE
  47++03C4 28 17          jr z, .removeChar
  48++03C6 FE 0D            cp CR
  48++03C8 CA EB 03       jp z, inputNavigate
  49++03CB FE 20            cp 32
  49++03CD 38 EF          jr c, .wait
  50++03CF              .putC
  51++03CF AF               xor a
  51++03D0 21 5F 19 01    ld hl, hostName, bc, 48
  51++03D4 30 00
  51++03D6 ED B1          cpir
  52++03D8 77               ld (hl), a
  52++03D9 2B             dec hl
  52++03DA 73             ld (hl), e
  53++03DB 18 CB            jr .loop
  54++03DD              .removeChar
  55++03DD AF               xor a
  56++03DE 21 5F 19 01      ld hl, hostName, bc, 48
  56++03E2 30 00
  56++03E4 ED B1          cpir
  57++03E6 2B               dec hl
  57++03E7 2B             dec hl
  57++03E8 77             ld (hl), a
  58++03E9 18 BD            jr .loop
  59++03EB
  60++03EB              inputNavigate:
  61++03EB 21 5F 19 11      ld hl, hostName, de, domain
  61++03EF 1E 04
  62++03F1 7E               ld a,(hl)
  63++03F2 A7               and a
  64++03F3 CA D9 08         jp z, History.load
  65++03F6              .loop
  66++03F6 7E               ld a, (hl)
  66++03F7 A7             and a
  66++03F8 28 05          jr z, .complete
  67++03FA 12               ld (de), a
  67++03FB 23 13          inc hl, de
  68++03FD 18 F7            jr .loop
  69++03FF              .complete
  70++03FF 3E 09            ld a, TAB
  70++0401 12             ld (de), a
  70++0402 13             inc de
  71++0403 3E 37            ld a, '7'
  71++0405 12             ld (de), a
  71++0406 13             inc de
  72++0407 3E 30            ld a, '0'
  72++0409 12             ld (de), a
  72++040A 13             inc de
  73++040B 3E 0D            ld a, CR
  73++040D 12             ld (de), a
  73++040E 13             inc de
  74++040F 3E 0A            ld a, LF
  74++0411 12             ld (de), a
  74++0412 13             inc de
  75++0413 21 19 04         ld hl, navRow
  75++0416 C3 32 09       jp History.navigate
  76++0419
  77++0419 31 20 09 2F  navRow db "1 ", TAB, "/", TAB
  77++041D 09
  78++041E 6E 69 68 69  domain db "nihirash.net"
  78++0422 72 61 73 68
  78++0426 2E 6E 65 74
  79++042A 00 00 00...      ds 64 - ($ - domain)
  80++045E
  81++045E 5B 44 5D 6F  header db "[D]omain:                                                  ", "MRF "
  81++0462 6D 61 69 6E
  81++0466 3A 20 20 20
  81++046A 20 20 20 20
  81++046E 20 20 20 20
  81++0472 20 20 20 20
  81++0476 20 20 20 20
  81++047A 20 20 20 20
  81++047E 20 20 20 20
  81++0482 20 20 20 20
  81++0486 20 20 20 20
  81++048A 20 20 20 20
  81++048E 20 20 20 20
  81++0492 20 20 20 20
  81++0496 20 20 20 4D
  81++049A 52 46 20
  82++049D 31 2E 37            db "1.7"
  83++04A0 2E                  db "."
  84++04A1 32 31               db "21"
  85++04A3              	IFDEF MSX
  86++04A3 ~                   db "    [MSX UNAPI]",13, 0
  87++04A3              	ENDIF
  88++04A3
  89++04A3                  IFDEF MB03
  90++04A3 ~                   db " [MB03+]",13, 0
  91++04A3                     ENDIF
  92++04A3
  93++04A3                  IFDEF UNO
  94++04A3 ~                   db " [UNO UART]",13, 0
  95++04A3                  ENDIF
  96++04A3
  97++04A3                  IFDEF AY
  98++04A3 ~                   db " [AYWIFI]",13, 0
  99++04A3              	ENDIF
 100++04A3
 101++04A3                  IFDEF ZW
 102++04A3 ~                   db "  [ZXWiFi]",13, 0
 103++04A3                  ENDIF
 104++04A3
 105++04A3                   IFDEF UARTATM
 106++04A3 ~                   db " [ATM UART]",13, 0
 107++04A3                  ENDIF
 108++04A3
 109++04A3                  IFDEF UARTEVO
 110++04A3 ~                    db " [EVO UART]",13, 0
 111++04A3                  ENDIF
 112++04A3
 113++04A3                  IFDEF UNOUART
 114++04A3 ~                    db " [UNO UART]",13, 0
 115++04A3                  ENDIF
 116++04A3
 117++04A3                  IFDEF NEDONET
 118++04A3 20 20 5B 6E  	    db "  [nedoNET]",13, 0
 118++04A7 65 64 6F 4E
 118++04AB 45 54 5D 0D
 118++04AF 00
 119++04B0              	ENDIF
 120++04B0
# file closed: gopher/render/ui.asm
   7++04B0                  include "gopher-page.asm"
# file opened: gopher/render/gopher-page.asm
   1++04B0              renderGopherScreen:
   2++04B0 3E FF            ld a, 255
   3++04B2 32 4C 21         ld (oldminutes), a
   4++04B5 CD 8B 03         call Render.prepareScreen
   5++04B8
   6++04B8 2A 4D 0C         ld hl, (page_offset)        ; HL - offset to 0 Row on screen
   7++04BB 44 4D            ld bc,hl                    ; BC - offset to C Row on screen
   8++04BD CD 52 03         call Render.findLine        ;BC - Search this line  HL - Return pointer to page with offset
   9++04C0 7C               ld a, h
  10++04C1 B5               or l
  11++04C2 28 21            jr z, .exit2
  12++04C4 7B               ld a, e
  13++04C5 AF               xor a
  14++04C6 E5               push hl
  15++04C7 CD 51 02         call renderRow
  16++04CA E1               pop hl
  17++04CB
  18++04CB 06 15            ld b, PER_PAGE-1
  19++04CD
  20++04CD              .loop
  21++04CD C5               push bc
  22++04CE 3E 16            ld a, PER_PAGE
  23++04D0 90               sub b
  24++04D1 5F               ld e,a
  25++04D2
  26++04D2 01 01 00         ld bc, 1
  27++04D5
  28++04D5 CD 55 03         call Render.findLine2   ;BC - Search this line  HL - Return pointer to page with offset
  29++04D8
  30++04D8 7C               ld a, h
  31++04D9 B5               or l
  32++04DA 28 06            jr z, .exit
  33++04DC 7B               ld a, e
  34++04DD E5               push hl
  35++04DE CD 51 02         call renderRow
  36++04E1 E1               pop hl
  37++04E2              .exit
  38++04E2 C1               pop bc
  39++04E3 10 E8            djnz .loop
  40++04E5              .exit2
  41++04E5 CD F4 05         call showCursor
  42++04E8 C9               ret
  43++04E9
  44++04E9              checkBorder:
  45++04E9 3A 4B 0C         ld a, (cursor_position)
  45++04EC FE FF          cp #ff
  45++04EE CA 18 06       jp z, pageUp
  46++04F1 3A 4B 0C         ld a, (cursor_position)
  46++04F4 FE 16          cp PER_PAGE
  46++04F6 CA 4B 06       jp z, pageDn
  47++04F9 CD F4 05         call showCursor
  48++04FC C3 FF 04         jp workLoop
  49++04FF
  50++04FF              workLoop:
  51++04FF 3A 3E 07         ld a, (play_next)
  51++0502 A7             and a
  51++0503 C2 A4 05       jp nz, navigate
  52++0506
  53++0506                  dup 4
  54++0506 76          >    halt
  54++0507 76          >    halt
  54++0508 76          >    halt
  54++0509 76          >    halt
  55++050A                  edup
  56++050A              .nothing
  57++050A
  58++050A 76               halt
  59++050B CD A7 20         call printRTC
  60++050E
  61++050E CD 44 08         call Console.peekC
  62++0511 A7               and a
  62++0512 CA 0A 05       jp z, .nothing
  63++0515
  64++0515 FE 31            cp '1'
  64++0517 CA C2 08       jp z, History.back
  65++051A FE 32            cp '2'
  65++051C CA A4 05       jp z, navigate
  66++051F FE 33            cp '3'
  66++0521 CA 04 06       jp z, cursorDown
  67++0524 FE 34            cp '4'
  67++0526 CA 0E 06       jp z, cursorUp
  68++0529 FE 35            cp '5'
  68++052B CA 18 06       jp z, pageUp
  69++052E FE 38            cp '8'
  69++0530 CA 4B 06       jp z, pageDn
  70++0533 FE 36            cp '6'
  70++0535 CA 04 06       jp z, cursorDown
  71++0538 FE 37            cp '7'
  71++053A CA 0E 06       jp z, cursorUp
  72++053D
  73++053D FE F9            cp Console.KEY_DN
  73++053F CA 04 06       jp z, cursorDown
  74++0542 FE 61            cp 'a'
  74++0544 CA 04 06       jp z, cursorDown
  75++0547 FE FA            cp Console.KEY_UP
  75++0549 CA 0E 06       jp z, cursorUp
  76++054C FE 71            cp 'q'
  76++054E CA 0E 06       jp z, cursorUp
  77++0551 FE F8            cp Console.KEY_LT
  77++0553 CA 18 06       jp z, pageUp
  78++0556 FE 6F            cp 'o'
  78++0558 CA 18 06       jp z, pageUp
  79++055B FE FB            cp Console.KEY_RT
  79++055D CA 4B 06       jp z, pageDn
  80++0560 FE 70            cp 'p'
  80++0562 CA 4B 06       jp z, pageDn
  81++0565
  82++0565 FE 68            cp 'h'
  82++0567 CA 2F 09       jp z, History.home
  83++056A FE 48            cp 'H'
  83++056C CA 2F 09       jp z, History.home
  84++056F
  85++056F FE 62            cp 'b'
  85++0571 CA C2 08       jp z, History.back
  86++0574 FE 42            cp 'B'
  86++0576 CA C2 08       jp z, History.back
  87++0579 FE 08            cp Console.BACKSPACE
  87++057B CA C2 08       jp z, History.back
  88++057E
  89++057E FE 64            cp 'd'
  89++0580 CA A5 03       jp z, inputHost
  90++0583 FE 44            cp 'D'
  90++0585 CA A5 03       jp z, inputHost
  91++0588
  92++0588 FE 0D            cp CR
  92++058A CA A4 05       jp z, navigate
  93++058D
  94++058D FE 53            cp 'S'
  94++058F CC 45 03       call z, toggleSaveMode
  95++0592 FE 73        	cp 's'
  95++0594 CC 45 03       call z, toggleSaveMode
  96++0597
  97++0597
  98++0597                  IFDEF MSX
  99++0597 ~                	cp ESC
  99++0597 ~              jp z, exit
 100++0597                  ENDIF
 101++0597
 102++0597                  IFDEF GS
 103++0597 FE 4D            cp 'M'
 103++0599 CC 9B 20       call z, GeneralSound.toggleModule
 104++059C FE 6D            cp 'm'
 104++059E CC 9B 20       call z, GeneralSound.toggleModule
 105++05A1                  ENDIF
 106++05A1
 107++05A1                  IFDEF TIMEX80
 108++05A1 ~                cp 'T'
 108++05A1 ~              call z, TextMode.toggleColor
 109++05A1 ~                cp 't'
 109++05A1 ~              call z, TextMode.toggleColor
 110++05A1                  ENDIF
 111++05A1
 112++05A1 C3 FF 04         jp workLoop
 113++05A4
 114++05A4              navigate:
 115++05A4 CD 51 08         call Console.waitForKeyUp
 116++05A7 AF               xor a
 116++05A8 32 3E 07       ld (play_next), a
 117++05AB CD FC 05         call hideCursor
 118++05AE ED 4B 4D 0C      ld bc, (page_offset)
 119++05B2 2A 4B 0C         ld hl, (cursor_position)
 120++05B5 09               add hl,bc
 121++05B6 44               ld b, h ;HHHHH
 122++05B7 4D               ld c, l ;LLLLL
 123++05B8 D5               push de
 124++05B9 CD 52 03         call Render.findLine
 125++05BC D1               pop de
 126++05BD 7E               ld a, (hl)
 127++05BE FE 31            cp '1'
 127++05C0 CA DD 05       jp z, .load
 128++05C3 FE 30            cp '0'
 128++05C5 CA DD 05       jp z, .load
 129++05C8 FE 39            cp '9'
 129++05CA CA DD 05       jp z, .load
 130++05CD FE 37            cp '7'
 130++05CF CA E5 05       jp z, .input
 131++05D2 FE 73            cp MIME_SOUND
 131++05D4 CA DD 05       jp z, .load
 132++05D7 CD F4 05         call showCursor
 133++05DA C3 FF 04         jp workLoop
 134++05DD              .load
 135++05DD E5               push hl
 136++05DE CD 66 02         call getIcon
 137++05E1 E1               pop hl
 138++05E2 C3 32 09         jp History.navigate
 139++05E5              .input
 140++05E5 E5               push hl
 141++05E6 CD 3F 07         call DialogBox.inputBox
 142++05E9 E1               pop hl
 143++05EA 3A B1 07         ld a, (DialogBox.inputBuffer)
 143++05ED A7             and a
 143++05EE CA D9 08       jp z, History.load
 144++05F1 C3 DD 05         jp .load
 145++05F4
 146++05F4              showCursor:
 147++05F4 3A 4B 0C         ld a, (cursor_position)
 147++05F7 C6 02          add CURSOR_OFFSET
 148++05F9 C3 6A 01         jp TextMode.highlightLine
 149++05FC
 150++05FC              hideCursor:
 151++05FC 3A 4B 0C         ld a, (cursor_position)
 151++05FF C6 02          add CURSOR_OFFSET
 152++0601 C3 52 01         jp TextMode.usualLine
 153++0604
 154++0604              cursorDown:
 155++0604 CD FC 05         call hideCursor
 156++0607 21 4B 0C         ld hl, cursor_position
 157++060A 34               inc (hl)
 158++060B C3 E9 04         jp checkBorder
 159++060E
 160++060E              cursorUp:
 161++060E CD FC 05         call hideCursor
 162++0611 21 4B 0C         ld hl, cursor_position
 163++0614 35               dec (hl)
 164++0615 C3 E9 04         jp checkBorder
 165++0618
 166++0618              pageUp:
 167++0618 3A 4D 0C         ld a, (page_offset)
 167++061B FE 00          cp 0
 167++061D C2 2B 06       jp nz, .pageUp2
 168++0620 3A 4E 0C         ld a, (page_offset + 1)
 168++0623 FE 00          cp 0
 168++0625 C2 2B 06       jp nz, .pageUp2
 169++0628 C3 41 06         jp .skip
 170++062B              .pageUp2:
 171++062B 3E 15            ld a, PER_PAGE - 1
 171++062D 32 4B 0C       ld (cursor_position), a
 172++0630 2A 4D 0C         ld hl, (page_offset)
 173++0633 11 16 00         ld de,PER_PAGE
 174++0636 ED 52            sbc hl,de
 175++0638 22 4D 0C         ld (page_offset), hl
 176++063B              .exit
 177++063B CD B0 04         call renderGopherScreen
 178++063E C3 FF 04         jp workLoop
 179++0641              .skip
 180++0641 AF               xor a
 180++0642 32 4B 0C       ld (cursor_position), a
 180++0645 CD B0 04       call renderGopherScreen
 180++0648 C3 FF 04       jp workLoop
 181++064B
 182++064B              pageDn:
 183++064B AF                xor a
 183++064C 32 4B 0C       ld (cursor_position), a
 184++064F 2A 4D 0C         ld hl,(page_offset)
 185++0652 11 16 00         ld de,PER_PAGE
 186++0655 19               add hl,de
 187++0656 22 4D 0C         ld (page_offset), hl
 188++0659 C3 3B 06         jp pageUp.exit
 189++065C
# file closed: gopher/render/gopher-page.asm
   8++065C                  include "plaintext.asm"
# file opened: gopher/render/plaintext.asm
   1++065C              renderPlainTextScreen:
   2++065C 3E FF            ld a, 255
   3++065E 32 4C 21         ld (oldminutes), a
   4++0661 CD 8B 03         call prepareScreen
   5++0664
   6++0664 2A 4D 0C         ld hl, (page_offset)        ; HL - offset to 0 Row on screen
   7++0667 44 4D            ld bc,hl                    ; BC - offset to C Row on screen
   8++0669 CD 52 03         call Render.findLine        ;BC - Search this line  HL - Return pointer to page with offset
   9++066C 7C               ld a, h
  10++066D B5               or l
  11++066E 28 30            jr z, .exit2
  12++0670 AF               xor a
  13++0671 C6 02            add CURSOR_OFFSET
  13++0673 57 1E 01       ld d, a, e, 1
  13++0676 CD 3A 01       call TextMode.gotoXY
  14++0679 CD 20 02         call print70Text
  15++067C 06 15            ld b, PER_PAGE -1
  16++067E              .loop
  17++067E C5               push bc
  18++067F 3E 16            ld a, PER_PAGE
  19++0681 90               sub b
  20++0682 5F               ld e,a
  21++0683 01 01 00         ld bc, 1
  22++0686 CD 55 03         call Render.findLine2   ;BC - Search this line  HL - Return pointer to page with offset
  23++0689 7C               ld a, h
  24++068A B5               or l
  25++068B 28 10            jr z, .exit
  26++068D 7B               ld a, e
  27++068E C6 02            add CURSOR_OFFSET
  27++0690 57 1E 01       ld d, a, e, 1
  27++0693 CD 3A 01       call TextMode.gotoXY
  28++0696 CD 20 02         call print70Text
  29++0699 C1               pop bc
  30++069A 10 E2            djnz .loop
  31++069C C9               ret
  32++069D              .exit
  33++069D C1               pop bc
  34++069E 10 DE            djnz .loop
  35++06A0              .exit2
  36++06A0 CD F4 05         call showCursor
  37++06A3 C9               ret
  38++06A4              plainTextLoop:
  39++06A4 CD A7 20         call printRTC
  40++06A7 CD 38 08         call Console.getC
  41++06AA
  42++06AA FE 31            cp '1'
  42++06AC CA C2 08       jp z, History.back
  43++06AF FE 32            cp '2'
  43++06B1 CA A4 05       jp z, navigate
  44++06B4 FE 35            cp '5'
  44++06B6 CA 1C 07       jp z, textUp
  45++06B9 FE 38            cp '8'
  45++06BB CA 0C 07       jp z, textDown
  46++06BE FE F8            cp Console.KEY_LT
  46++06C0 CA 1C 07       jp z, textUp
  47++06C3 FE FB            cp Console.KEY_RT
  47++06C5 CA 0C 07       jp z, textDown
  48++06C8
  49++06C8 FE F9            cp Console.KEY_DN
  49++06CA CA 0C 07       jp z, textDown
  50++06CD FE 61            cp 'a'
  50++06CF CA 0C 07       jp z, textDown
  51++06D2
  52++06D2 FE FA            cp Console.KEY_UP
  52++06D4 CA 1C 07       jp z, textUp
  53++06D7 FE 71            cp 'q'
  53++06D9 CA 1C 07       jp z, textUp
  54++06DC
  55++06DC FE 68            cp 'h'
  55++06DE CA 2F 09       jp z, History.home
  56++06E1 FE 48            cp 'H'
  56++06E3 CA 2F 09       jp z, History.home
  57++06E6
  58++06E6 FE 62            cp 'b'
  58++06E8 CA C2 08       jp z, History.back
  59++06EB FE 42            cp 'B'
  59++06ED CA C2 08       jp z, History.back
  60++06F0
  61++06F0 FE 64            cp 'd'
  61++06F2 CA A5 03       jp z, inputHost
  62++06F5 FE 44            cp 'D'
  62++06F7 CA A5 03       jp z, inputHost
  63++06FA
  64++06FA FE 08            cp Console.BACKSPACE
  64++06FC CA C2 08       jp z, History.back
  65++06FF
  66++06FF                  IFDEF MSX
  67++06FF ~                	cp ESC
  67++06FF ~              jp z, exit
  68++06FF                  ENDIF
  69++06FF
  70++06FF                  IFDEF GS
  71++06FF FE 4D            cp 'M'
  71++0701 CC 9B 20       call z, GeneralSound.toggleModule
  72++0704 FE 6D            cp 'm'
  72++0706 CC 9B 20       call z, GeneralSound.toggleModule
  73++0709                  ENDIF
  74++0709
  75++0709                  IFDEF TIMEX80
  76++0709 ~                cp 'T'
  76++0709 ~              call z, TextMode.toggleColor
  77++0709 ~                cp 't'
  77++0709 ~              call z, TextMode.toggleColor
  78++0709                  ENDIF
  79++0709
  80++0709 C3 A4 06         jp plainTextLoop
  81++070C
  82++070C
  83++070C              textDown:
  84++070C 2A 4D 0C         ld hl,(page_offset)
  85++070F 11 16 00         ld de,PER_PAGE
  86++0712 19               add hl,de
  87++0713 22 4D 0C         ld (page_offset), hl
  88++0716 CD 5C 06         call renderPlainTextScreen
  89++0719 C3 A4 06         jp plainTextLoop
  90++071C
  91++071C              textUp:
  92++071C 3A 4D 0C         ld a, (page_offset)
  92++071F FE 00          cp 0
  92++0721 20 0A          jr nz, .textUp2
  93++0723 3A 4E 0C         ld a, (page_offset + 1)
  93++0726 FE 00          cp 0
  93++0728 20 03          jr nz, .textUp2
  94++072A C3 A4 06         jp plainTextLoop
  95++072D
  96++072D              .textUp2:
  97++072D 2A 4D 0C         ld hl,(page_offset)
  98++0730 11 16 00         ld de,PER_PAGE
  99++0733 ED 52            sbc hl,de
 100++0735 22 4D 0C         ld (page_offset), hl
 101++0738 CD 5C 06         call renderPlainTextScreen
 102++073B C3 A4 06         jp plainTextLoop
 103++073E
# file closed: gopher/render/plaintext.asm
   9++073E
  10++073E 00           play_next       db  0
  11++073F              position        EQU historyBlock.position
  12++073F              cursor_position EQU position + 2
  13++073F              page_offset     EQU position + 4
  14++073F
  15++073F                  ENDMODULE
  16++073F
  17++073F                  include "dialogbox.asm"
# file opened: gopher/render/dialogbox.asm
   1++073F                  module DialogBox
   2++073F
   3++073F              inputBox:
   4++073F AF               xor a
   4++0740 32 B1 07       ld (inputBuffer), a
   5++0743              .noclear
   6++0743 CD 12 08         call drawBox
   7++0746              .loop
   8++0746 11 05 0B         ld de, #0B05
   8++0749 CD 3A 01       call TextMode.gotoXY
   9++074C 21 B1 07         ld hl, inputBuffer
   9++074F CD 27 01       call TextMode.printZ
  10++0752 3E 04            ld a, MIME_INPUT
  10++0754 CD 37 01       call TextMode.putC
  10++0757 3E 20          ld a, ' '
  10++0759 CD 37 01       call TextMode.putC
  11++075C              .checkkey
  12++075C CD 44 08         call Console.peekC
  13++075F FE 00            cp 00
  13++0761 CA 5C 07        jp z, .checkkey
  14++0764 FE 0D            cp CR
  14++0766 C8             ret z
  15++0767
  16++0767                  IFNDEF MSX
  17++0767                  dup 11
  18++0767 76          >    halt
  18++0768 76          >    halt
  18++0769 76          >    halt
  18++076A 76          >    halt
  18++076B 76          >    halt
  18++076C 76          >    halt
  18++076D 76          >    halt
  18++076E 76          >    halt
  18++076F 76          >    halt
  18++0770 76          >    halt
  18++0771 76          >    halt
  19++0772                  edup
  20++0772                  ENDIF
  21++0772
  22++0772 FE 08            cp Console.BACKSPACE
  22++0774 28 13          jr z, .removeChar
  23++0776 FE 20            cp SPACE
  23++0778 38 E2          jr c, .checkkey
  24++077A              .putC
  25++077A 5F               ld e, a
  26++077B AF               xor a
  26++077C 21 B1 07 01    ld hl, inputBuffer, bc, #ff
  26++0780 FF 00
  26++0782 ED B1          cpir
  27++0784 77               ld (hl), a
  27++0785 2B             dec hl
  27++0786 73             ld (hl), e
  28++0787 18 BD            jr .loop
  29++0789              .removeChar
  30++0789 AF               xor a
  31++078A 21 B1 07 01      ld hl, inputBuffer, bc, #ff
  31++078E FF 00
  31++0790 ED B1          cpir
  32++0792 E5               push hl
  33++0793 11 B2 07             ld de, inputBuffer + 1
  34++0796 B7                   or a
  34++0797 ED 52          sbc hl, de
  35++0799 7C                   ld a, h
  35++079A B5             or l
  36++079B E1               pop hl
  37++079C 28 A8            jr z, .loop
  38++079E AF               xor a
  39++079F 2B               dec hl
  39++07A0 2B             dec hl
  39++07A1 77             ld (hl), a
  40++07A2 18 A2            jr .loop
  41++07A4
  42++07A4
  43++07A4              namedownload
  44++07A4                  IFDEF NEDOOS
  45++07A4 2E 2E 5C 64  		db "..",92,"downloads",92
  45++07A8 6F 77 6E 6C
  45++07AC 6F 61 64 73
  45++07B0 5C
  46++07B1                  ENDIF
  47++07B1
  48++07B1 00 00 00...  inputBuffer ds 80
  49++0801
  50++0801              msgBox:
  51++0801 CD 0A 08         call msgNoWait
  52++0804 06 96            ld b, 150
  53++0806              .loop
  54++0806 76               halt
  55++0807 10 FD            djnz .loop
  56++0809 C9               ret
  57++080A
  58++080A              msgNoWait:
  59++080A E5               push hl
  60++080B CD 12 08         call drawBox
  61++080E E1               pop hl
  62++080F C3 27 01         jp TextMode.printZ
  63++0812
  64++0812              drawBox:
  65++0812 26 0A 3E 09      ld h, #0a, a, BORDER_TOP
  66++0816 CD 42 01         call TextMode.fillLine
  67++0819 26 0B 3E 20      ld h, #0b, a, ' '
  68++081D CD 42 01         call TextMode.fillLine
  69++0820 26 0C 3E 08      ld h, #0c, a, BORDER_BOTTOM
  70++0824 CD 42 01         call TextMode.fillLine
  71++0827 3E 0A            ld a, #0a
  72++0829 CD 6A 01         call TextMode.highlightLine
  73++082C 3E 0C            ld a, #0c
  74++082E CD 6A 01         call TextMode.highlightLine
  75++0831 11 03 0B         ld de,#0B03
  76++0834 CD 3A 01         call TextMode.gotoXY
  77++0837 C9               ret
  78++0838                  endmodule
  79++0838
# file closed: gopher/render/dialogbox.asm
# file closed: gopher/render/index.asm
  18+ 0838                  include "dos/index.asm"
# file opened: dos/index.asm
   1++0838              	IFDEF NEDOOS
   2++0838              	    include "nedoconsole.asm"
# file opened: dos/nedoconsole.asm
   1++0838
   2++0838              	    module Console
   3++0838              KEY_UP = nos.key_up
   4++0838              KEY_DN = nos.key_down
   5++0838              KEY_LT = nos.key_left
   6++0838              KEY_RT = nos.key_right
   7++0838              BACKSPACE = nos.key_backspace
   8++0838              getC:
   9++0838 CD 44 08         call inkey
  10++083B              .loop
  11++083B F5               push af
  12++083C CD 44 08         call inkey
  13++083F C1               pop bc
  14++0840 B8               cp b
  15++0841 28 F8            jr z, .loop
  16++0843              .exit
  17++0843 C9               ret
  18++0844
  19++0844              peekC:
  20++0844              inkey
  21++0844 0E F2        	ld c,nos.CMD_YIELD
  22++0846 CD 05 00     	call nos.BDOS
  23++0849 CF           	rst 0x08
  24++084A 79           	ld a,c
  25++084B FE 1B        	cp nos.key_esc
  26++084D CA 00 00     	jp z,0x0000
  27++0850 C9           	ret
  28++0851              waitForKeyUp
  29++0851 CD 44 08     	call inkey
  30++0854 B7           	or a
  31++0855 C8           	ret z
  32++0856 18 F9        	jr waitForKeyUp
  33++0858
  34++0858
  35++0858              getCint:
  36++0858 CD 64 08         call inkey2
  37++085B              .loop2
  38++085B F5               push af
  39++085C CD 64 08         call inkey2
  40++085F C1               pop bc
  41++0860 B8               cp b
  42++0861 28 F8            jr z, .loop2
  43++0863              .exit2
  44++0863 C9               ret
  45++0864
  46++0864              peekCint:
  47++0864              inkey2
  48++0864 0E F2        	ld c,nos.CMD_YIELD
  49++0866 CD 05 00     	call nos.BDOS
  50++0869 CF           	rst 0x08
  51++086A FE 1B        	cp nos.key_esc
  52++086C CA 00 00     	jp z,0x0000
  53++086F C9           	ret
  54++0870              waitForKeyUp2
  55++0870 CD 64 08     	call inkey2
  56++0873 B7           	or a
  57++0874 C8           	ret z
  58++0875 18 F9        	jr waitForKeyUp2
  59++0877
  60++0877                  ENDMODULE
  61++0877
# file closed: dos/nedoconsole.asm
   3++0877              		include "nedoos.asm"
# file opened: dos/nedoos.asm
   1++0877              	MODULE Dos
   2++0877
   3++0877              FMODE_READ = #01
   4++0877              FMODE_CREATE = #0E
   5++0877
   6++0877              ; HL - filename in ASCIIZ
   7++0877              loadBuffer:
   8++0877 06 01            ld b, Dos.FMODE_READ
   8++0879 CD 94 08       call Dos.fopen
   9++087C F5               push af
  10++087D 21 A3 4C 01          ld hl, outputBuffer, bc, #ffff - outputBuffer
  10++0881 5C B3
  10++0883 CD B6 08       call Dos.fread
  11++0886 21 A3 4C             ld hl, outputBuffer
  11++0889 09             add hl, bc
  11++088A AF             xor a
  11++088B 77             ld (hl), a
  11++088C 23             inc hl
  11++088D 77             ld (hl), a
  12++088E F1               pop af
  13++088F CD AF 08         call Dos.fclose
  14++0892 C9               ret
  15++0893 C9           	ret
  16++0894
  17++0894              ; Opens file on default drive
  18++0894              ; B - File mode
  19++0894              ; HL - File name
  20++0894              ; Returns:
  21++0894              ;  A - file stream id
  22++0894              fopen
  23++0894 EB           	ex de,hl
  24++0895 0E 43        	ld c,nos.CMD_OPENHANDLE
  25++0897 78           	ld a,b
  26++0898 FE 0E        	cp FMODE_CREATE
  27++089A 20 02        	jr nz,.noncreate
  28++089C 0E 44        	ld c,nos.CMD_CREATEHANDLE
  29++089E              .noncreate
  30++089E CD 05 00     	call nos.BDOS
  31++08A1 78           	ld a,b
  32++08A2 C9           	ret
  33++08A3
  34++08A3              ; A - file stream id
  35++08A3              ; BC - length
  36++08A3              ; HL - buffer
  37++08A3              ; Returns:
  38++08A3              ;   BC - actually written bytes
  39++08A3              fwrite
  40++08A3 EB           	ex de,hl
  41++08A4 60           	ld h,b
  42++08A5 69           	ld l,c
  43++08A6 47           	ld b,a
  44++08A7 0E 49        	ld c,nos.CMD_WRITEHANDLE
  45++08A9 CD 05 00     	call nos.BDOS
  46++08AC 44           	ld b,h
  47++08AD 4D           	ld c,l
  48++08AE C9           	ret
  49++08AF
  50++08AF              ; A - file stream id
  51++08AF              fclose
  52++08AF 47           	ld b,a
  53++08B0 0E 45        	ld c,nos.CMD_CLOSEHANDLE
  54++08B2 CD 05 00     	call nos.BDOS
  55++08B5 C9           	ret
  56++08B6
  57++08B6              ; A - file stream id
  58++08B6              ; BC - length
  59++08B6              ; HL - buffer
  60++08B6              ; Returns
  61++08B6              ;  BC - length(how much was actually read)
  62++08B6              fread:
  63++08B6 EB           	ex de,hl
  64++08B7 60           	ld h,b
  65++08B8 69           	ld l,c
  66++08B9 47           	ld b,a
  67++08BA 0E 48        	ld c,nos.CMD_READHANDLE
  68++08BC CD 05 00     	call nos.BDOS
  69++08BF 44           	ld b,h
  70++08C0 4D           	ld c,l
  71++08C1 C9           	ret
  72++08C2                  ENDMODULE
  73++08C2
# file closed: dos/nedoos.asm
   4++08C2              	ENDIF
   5++08C2
   6++08C2              	IFDEF TRDOS
   7++08C2 ~                	include "console.asm"
   8++08C2 ~            		include "trdos.asm"
   9++08C2              	ENDIF
  10++08C2
  11++08C2              	IFDEF ESXDOS
  12++08C2 ~               		include "console.asm"
  13++08C2 ~               		include "esxdos.asm"
  14++08C2              	ENDIF
  15++08C2
  16++08C2              	IFDEF P3DOS
  17++08C2 ~               		include "console.asm"
  18++08C2 ~               		include "p3dos.asm"
  19++08C2              	ENDIF
  20++08C2
# file closed: dos/index.asm
  19+ 08C2                  include "gopher/engine/history/index.asm"
# file opened: gopher/engine/history/index.asm
   1++08C2                  include "controler.asm"
# file opened: gopher/engine/history/controler.asm
   1++08C2                  module History
   2++08C2              back:
   3++08C2 3A 02 0A         ld a, (depth)
   3++08C5 FE 01          cp 1
   3++08C7 CA D9 08       jp z, load
   4++08CA 21 51 0C 11      ld hl, historyBlock + HistoryRecord, de, historyBlock, bc, (total - 1) * HistoryRecord
   4++08CE 03 0A 01 38
   4++08D2 09
   4++08D3 ED B0          ldir ; Move history up
   5++08D5 21 02 0A         ld hl, depth
   5++08D8 35             dec (hl)
   6++08D9              ; Loads current resource
   7++08D9              load:
   8++08D9 21 F6 08         ld hl, .msg
   8++08DC CD 0A 08       call DialogBox.msgNoWait
   9++08DF AF               xor a
   9++08E0 21 A3 4C 11    ld hl, outputBuffer, de, outputBuffer + 1
   9++08E4 A4 4C
  10++08E6              	IFDEF MSX
  11++08E6 ~                	ld bc, (ramtop)
  12++08E6 ~                	dec bc
  13++08E6              	ELSE
  14++08E6 01 5B B3         	ld bc, #ffff - outputBuffer - 1
  15++08E9              	ENDIF
  16++08E9
  17++08E9 77               ld (hl), a
  18++08EA ED B0            ldir
  19++08EC
  20++08EC 3A 03 0A         ld a, (historyBlock.isFile)
  20++08EF A7             and a
  20++08F0 C2 EC 19       jp nz, Fetcher.fetchFromFS
  21++08F3 C3 9F 19         jp Fetcher.fetchFromNet
  22++08F6
  23++08F6 20 20 20 20  .msg db "    Loading resource! Please wait! It will be here soon!", 0
  23++08FA 4C 6F 61 64
  23++08FE 69 6E 67 20
  23++0902 72 65 73 6F
  23++0906 75 72 63 65
  23++090A 21 20 50 6C
  23++090E 65 61 73 65
  23++0912 20 77 61 69
  23++0916 74 21 20 49
  23++091A 74 20 77 69
  23++091E 6C 6C 20 62
  23++0922 65 20 68 65
  23++0926 72 65 20 73
  23++092A 6F 6F 6E 21
  23++092E 00
  24++092F
  25++092F              home:
  26++092F 21 E0 09         ld hl, homePage
  27++0932              ; HL - gopher row
  28++0932              navigate:
  29++0932 54 5D            ld de, hl
  30++0934 CD 18 18         call UrlEncoder.isValidGopherRow
  31++0937 30 A0            jr nc, load ; Not valid - reload last
  32++0939 62 6B            ld hl, de
  33++093B E5               push hl
  34++093C
  35++093C E5               push hl
  36++093D 21 88 15 11      ld hl, HistoryEnd - HistoryRecord, de, HistoryEnd, bc,  HistoryRecord * total
  36++0941 D6 17 01 86
  36++0945 0B
  36++0946 ED B8          lddr
  37++0948
  38++0948 ED 5B 49 0C      ld de, (Render.position), (historyBlock.position + HistoryRecord), de
  38++094C ED 53 97 0E
  39++0950                  ; Clean up struct
  40++0950 AF               xor a
  40++0951 21 03 0A 11    ld hl, historyBlock, de, historyBlock + 1, bc, historyBlockSize - 1, (hl), a
  40++0955 04 0A 01 4D
  40++0959 02 77
  40++095B ED B0          ldir
  41++095D E1               pop hl
  42++095E
  43++095E                  ; Fill record
  44++095E 54 5D            ld de, hl
  45++0960 CD D7 17         call UrlEncoder.isFile
  46++0963 EB               ex hl, de
  47++0964 11 03 0A         ld de, historyBlock
  48++0967 12               ld (de), a
  48++0968 13             inc de
  49++0969 7E               ld a, (hl)
  49++096A E5 D5          push hl, de
  49++096C CD 66 02       call Render.getIcon
  49++096F D1 E1          pop de, hl
  50++0971 12               ld (de), a
  50++0972 13             inc de
  51++0973 3E 09            ld a, 9
  52++0975
  53++0975                  IFDEF MSX
  54++0975 ~                	ld bc, #ff
  55++0975                  ELSE
  56++0975 01 FF 00         	ld bc, #ff
  57++0978                  ENDIF
  58++0978
  59++0978 ED B1            cpir
  60++097A              .locatorCopy
  61++097A 7E               ld a, (hl)
  61++097B FE 09          cp 9
  61++097D 28 05          jr z, 1f
  62++097F 12               ld (de), a
  62++0980 23 13          inc hl, de
  63++0982 18 F6            jr .locatorCopy
  64++0984              1
  65++0984 23               inc hl
  65++0985 AF             xor a
  65++0986 12             ld (de), a
  66++0987 11 04 0B         ld de, historyBlock.host
  67++098A              .hostCopy
  68++098A 7E               ld a, (hl)
  68++098B FE 09          cp 9
  68++098D 28 05          jr z, 1f
  69++098F 12               ld (de), a
  69++0990 23 13          inc hl, de
  70++0992 18 F6            jr .hostCopy
  71++0994              1
  72++0994 23               inc hl
  72++0995 AF             xor a
  72++0996 12             ld (de), a
  73++0997 11 44 0B         ld de, historyBlock.port
  74++099A              .portCopy
  75++099A 7E               ld a, (hl)
  76++099B FE 09            cp 9
  76++099D 28 11          jr z, 1f
  77++099F FE 0D            cp 13
  77++09A1 28 0D          jr z, 1f
  78++09A3 FE 0A            cp 10
  78++09A5 28 09          jr z, 1f
  79++09A7 FE 00            cp 0
  79++09A9 28 05          jr z, 1f
  80++09AB 12               ld (de), a
  80++09AC 23 13          inc hl, de
  81++09AE 18 EA            jr .portCopy
  82++09B0 AF           1   xor a
  82++09B1 12             ld (de), a
  83++09B2 21 B1 07 11      ld hl, DialogBox.inputBuffer, de, historyBlock.search, bc, #ff
  83++09B6 4A 0B 01 FF
  83++09BA 00
  83++09BB ED B0          ldir
  84++09BD 11 00 00 ED      ld de, 0, (historyBlock.position), de
  84++09C1 53 49 0C
  85++09C4 E1               pop hl
  86++09C5 3A 02 0A         ld a, (depth)
  86++09C8 FE 05          cp total
  86++09CA 30 04          jr nc, 1f
  87++09CC 3C               inc a
  87++09CD 32 02 0A       ld (depth), a
  88++09D0              1
  89++09D0 3A 04 0A         ld a,(historyBlock.mediaType)
  89++09D3 FE 01          cp MIME_DOWNLOAD
  89++09D5 CA F2 1A       jp z, Gopher.download
  90++09D8
  91++09D8                  ifdef GS
  92++09D8 FE 07            cp MIME_MOD
  92++09DA CA 91 1A       jp z, Gopher.loadMod
  93++09DD                  endif
  94++09DD
  95++09DD C3 D9 08         jp load
  96++09E0
  97++09E0              homePage:
  98++09E0              	IFDEF MSX
  99++09E0 ~                	db "1Home", TAB, "index.gph"
 100++09E0 ~                	db TAB, "file", TAB, "70", CR, LF, 0
 101++09E0                  ELSE
 102++09E0 31 48 6F 6D      	db "1Home", TAB, "browser/index.gph"
 102++09E4 65 09 62 72
 102++09E8 6F 77 73 65
 102++09EC 72 2F 69 6E
 102++09F0 64 65 78 2E
 102++09F4 67 70 68
 103++09F7 09 66 69 6C      	db TAB, "file", TAB, "70", CR, LF, 0
 103++09FB 65 09 37 30
 103++09FF 0D 0A 00
 104++0A02                  ENDIF
 105++0A02                  endmodule
# file closed: gopher/engine/history/controler.asm
   2++0A02                  include "model.asm"
# file opened: gopher/engine/history/model.asm
   1++0A02              total   equ 5
   2++0A02 00           depth   db 0
   3++0A03
   4++0A03              historyBlock:
   5++0A03 00           .isFile    db  0
   6++0A04 00           .mediaType db  0
   7++0A05 00 00 00...  .locator   ds  #ff
   8++0B04 00 00 00...  .host      ds  64
   9++0B44 00 00 00...  .port      ds  6
  10++0B4A 00 00 00...  .search    ds  #ff
  11++0C49 00 00        .position  dw  #0000    ;position
  12++0C4B
  13++0C4B 00 00 00 00      db 0,0,0,0,0,0  ;cursor_position page_offset
  13++0C4F 00 00
  14++0C51
  15++0C51              historyBlockSize = $ - historyBlock
  16++0C51
  17++0C51              HistoryRecord EQU $ - historyBlock
  18++0C51                  dup total
  19++0C51 00 00 00... >    ds HistoryRecord
  19++0E9F 00 00 00... >    ds HistoryRecord
  19++10ED 00 00 00... >    ds HistoryRecord
  19++133B 00 00 00... >    ds HistoryRecord
  19++1589 00 00 00... >    ds HistoryRecord
  20++17D7                  edup
  21++17D7              HistoryEnd equ $ - 1
  22++17D7
# file closed: gopher/engine/history/model.asm
# file closed: gopher/engine/history/index.asm
  20+ 17D7                  include "gopher/engine/urlencoder.asm"
# file opened: gopher/engine/urlencoder.asm
   1++17D7                  MODULE UrlEncoder
   2++17D7              ; HL - pointer to line in gopher page
   3++17D7              ; C - flag set when it's file
   4++17D7              isFile:
   5++17D7              .findServerLoop
   6++17D7 7E               ld a, (hl)
   6++17D8 A7             and a
   6++17D9 28 3B          jr z, .notFile
   6++17DB 23             inc hl
   7++17DC FE 0D            cp 13
   7++17DE 28 36          jr z, .notFile
   8++17E0 FE 09            cp 9
   8++17E2 28 02          jr z, .skipPath
   9++17E4 18 F1            jr .findServerLoop
  10++17E6              .skipPath
  11++17E6 7E               ld a, (hl)
  11++17E7 A7             and a
  11++17E8 28 2C          jr z, .notFile
  11++17EA 23             inc hl
  12++17EB FE 0D            cp 13
  12++17ED 28 27          jr z, .notFile
  13++17EF FE 09            cp 9
  13++17F1 28 02          jr z, .compareServer
  14++17F3 18 F1            jr .skipPath
  15++17F5              .compareServer
  16++17F5 7E               ld a, (hl)
  16++17F6 FE 66          cp "f"
  16++17F8 20 1C          jr nz, .notFile
  16++17FA 23             inc hl
  17++17FB 7E               ld a, (hl)
  17++17FC FE 69          cp "i"
  17++17FE 20 16          jr nz, .notFile
  17++1800 23             inc hl
  18++1801 7E               ld a, (hl)
  18++1802 FE 6C          cp "l"
  18++1804 20 10          jr nz, .notFile
  18++1806 23             inc hl
  19++1807 7E               ld a, (hl)
  19++1808 FE 65          cp "e"
  19++180A 20 0A          jr nz, .notFile
  19++180C 23             inc hl
  20++180D 7E               ld a, (hl)
  20++180E FE 09          cp 9
  20++1810 20 04          jr nz, .notFile
  20++1812 23             inc hl
  21++1813 3E 01            ld a, 1
  22++1815 C9               ret
  23++1816              .notFile
  24++1816 AF               xor a
  25++1817 C9               ret
  26++1818
  27++1818              ; Is enough fields to encode
  28++1818              ; HL - pointer to line in gopher page
  29++1818              ; C - flag set when there is enough fields
  30++1818              isValidGopherRow:
  31++1818 7E               ld a, (hl)
  31++1819 A7             and a
  31++181A 28 FA          jr z, isFile.notFile
  31++181C 23             inc hl
  32++181D FE 0D            cp 13
  32++181F 28 F5          jr z, isFile.notFile
  33++1821 FE 09            cp 9
  33++1823 28 02          jr z, .skipPath
  34++1825 18 F1            jr isValidGopherRow
  35++1827              .skipPath
  36++1827 7E               ld a, (hl)
  36++1828 A7             and a
  36++1829 28 EB          jr z, isFile.notFile
  36++182B 23             inc hl
  37++182C FE 0D            cp 13
  37++182E 28 E6          jr z, isFile.notFile
  38++1830 FE 09            cp 9
  38++1832 28 02          jr z, .skipHost
  39++1834 18 F1            jr .skipPath
  40++1836              .skipHost
  41++1836 7E               ld a, (hl)
  41++1837 A7             and a
  41++1838 28 DC          jr z, isFile.notFile
  41++183A 23             inc hl
  42++183B FE 0D            cp 13
  42++183D 28 D7          jr z, isFile.notFile
  43++183F FE 09            cp 9
  43++1841 28 02           jr z, .isValid
  44++1843 18 F1            jr .skipHost
  45++1845              .isValid:
  46++1845 37               scf
  47++1846 C9               ret
  48++1847
  49++1847              extractPath:
  50++1847 21 05 0A 11      ld hl, historyBlock.locator, de, nameBuffer, bc, #ff
  50++184B 5F 18 01 FF
  50++184F 00
  50++1850 ED B0          ldir
  51++1852 C9               ret
  52++1853
  53++1853              extractHostName:
  54++1853 21 04 0B 11      ld hl, historyBlock.host, de, hostName, bc, 64
  54++1857 5F 19 01 40
  54++185B 00
  54++185C ED B0          ldir
  55++185E C9               ret
  56++185F
  57++185F                  ENDMODULE
  58++185F
  59++185F 00 00 00...  nameBuffer ds #ff, 0
  60++195E
  61++195E 00                    db 0
  62++195F 00 00 00...  hostName ds 64
# file closed: gopher/engine/urlencoder.asm
  21+ 199F                  include "gopher/engine/fetcher.asm"
# file opened: gopher/engine/fetcher.asm
   1++199F                  MODULE Fetcher
   2++199F
   3++199F              fetchFromNet:
   4++199F
   5++199F              	IFDEF MSX
   6++199F ~                	call Gopher.makeRequest
   6++199F ~              jr nz, .error
   7++199F                  ELSE
   8++199F CD 66 1A         	call Gopher.makeRequest
   8++19A2 38 06          jr c, .error
   9++19A4                  ENDIF
  10++19A4
  11++19A4 CD 7E 1A         call Gopher.loadBuffer
  12++19A7 C3 F8 19         jp MediaProcessor.processResource
  13++19AA              .error
  14++19AA 21 B3 19         ld hl, .err
  14++19AD CD 01 08       call DialogBox.msgBox
  15++19B0 C3 C2 08         jp History.back
  16++19B3
  17++19B3 44 6F 63 75  .err db "Document fetch error! Check your connection or hostname!", 0
  17++19B7 6D 65 6E 74
  17++19BB 20 66 65 74
  17++19BF 63 68 20 65
  17++19C3 72 72 6F 72
  17++19C7 21 20 43 68
  17++19CB 65 63 6B 20
  17++19CF 79 6F 75 72
  17++19D3 20 63 6F 6E
  17++19D7 6E 65 63 74
  17++19DB 69 6F 6E 20
  17++19DF 6F 72 20 68
  17++19E3 6F 73 74 6E
  17++19E7 61 6D 65 21
  17++19EB 00
  18++19EC
  19++19EC
  20++19EC              fetchFromFS:
  21++19EC CD 47 18         call UrlEncoder.extractPath
  22++19EF              loadFile
  23++19EF              	IFDEF MSX
  24++19EF ~                ld de, nameBuffer, a, FMODE_NO_WRITE
  25++19EF ~                call Dos.fopen
  26++19EF ~                ld a, b, (.fp), a
  27++19EF ~                ld de, outputBuffer, hl, (ramtop)
  28++19EF ~                call Dos.fread
  29++19EF ~                ld a, (.fp), b, a
  30++19EF ~                call Dos.fclose
  31++19EF ~                jp MediaProcessor.processResource
  32++19EF ~            .fp db 0
  33++19EF              	ELSE
  34++19EF 21 5F 18         ld hl, nameBuffer
  35++19F2 CD 77 08         call Dos.loadBuffer
  36++19F5 C3 F8 19         jp MediaProcessor.processResource
  37++19F8              	ENDIF
  38++19F8                  ENDMODULE
# file closed: gopher/engine/fetcher.asm
  22+ 19F8                  include "gopher/engine/media-processor.asm"
# file opened: gopher/engine/media-processor.asm
   1++19F8                  MODULE MediaProcessor
   2++19F8              processResource:
   3++19F8 CD 53 18         call UrlEncoder.extractHostName
   4++19FB 3A 04 0A         ld a, (historyBlock.mediaType)
   5++19FE FE 05            cp MIME_MUSIC
   5++1A00 28 17          jr z, processPT
   6++1A02 FE 02            cp MIME_LINK
   6++1A04 28 1F          jr z, processPage
   7++1A06 FE 04            cp MIME_INPUT
   7++1A08 28 1B          jr z, processPage
   8++1A0A FE 06            cp MIME_IMAGE
   8++1A0C CA 4D 21       jp z, ScreenViewer.display
   9++1A0F              	ifdef GS
  10++1A0F FE 07            cp MIME_MOD
  10++1A11 28 0C          jr z, processMOD
  11++1A13              	endif
  12++1A13              ; Fallback to plain text
  13++1A13              processText:
  14++1A13 CD 5C 06         call Render.renderPlainTextScreen
  15++1A16 C3 A4 06         jp   Render.plainTextLoop
  16++1A19
  17++1A19              processPT:
  18++1A19 CD 7D 21         call VortexProcessor.play
  19++1A1C C3 C2 08         jp History.back
  20++1A1F
  21++1A1F                  ifdef GS
  22++1A1F              processMOD:
  23++1A1F CD F7 4B         call ModProcessor.play
  24++1A22 C3 C2 08         jp History.back
  25++1A25              	endif
  26++1A25
  27++1A25              processPage:
  28++1A25 3A 3E 07         ld a, (Render.play_next)
  28++1A28 A7             and a
  28++1A29 20 06          jr nz, .playNext
  29++1A2B CD B0 04         call Render.renderGopherScreen
  30++1A2E C3 FF 04         jp   Render.workLoop
  31++1A31              .playNext
  32++1A31 21 4B 0C         ld hl, Render.cursor_position
  33++1A34 34               inc (hl)
  34++1A35 CD B0 04         call Render.renderGopherScreen
  35++1A38 C3 E9 04         jp Render.checkBorder
  36++1A3B                  ENDMODULE
# file closed: gopher/engine/media-processor.asm
  23+ 1A3B                  include "gopher/gopher.asm"
# file opened: gopher/gopher.asm
   1++1A3B                  module Gopher
   2++1A3B              ; HL - gopher row
   3++1A3B              extractRequest:
   4++1A3B 21 05 0A         ld hl, historyBlock.locator
   5++1A3E 11 E8 1B         ld de, requestbuffer
   6++1A41              .loop
   7++1A41 7E               ld a, (hl)
   8++1A42 12               ld (de), a
   9++1A43 23               inc hl
  10++1A44 13               inc de
  11++1A45 FE 00            cp 0
  12++1A47 28 02            jr z, .search
  13++1A49 18 F6            jr .loop
  14++1A4B              .search
  15++1A4B 1B               dec de
  16++1A4C 3A 04 0A         ld a, (historyBlock.mediaType)
  17++1A4F FE 04            cp MIME_INPUT
  18++1A51 20 10            jr nz, .exit
  19++1A53 21 4A 0B         ld hl, historyBlock.search
  20++1A56 3E 09            ld a, TAB
  21++1A58 12               ld (de), a
  22++1A59 13               inc de
  23++1A5A              .searchCopy
  24++1A5A 7E               ld a, (hl)
  25++1A5B A7               and a
  25++1A5C 28 05          jr z, .exit
  26++1A5E 12               ld (de), a
  27++1A5F 23               inc hl
  27++1A60 13             inc de
  28++1A61 18 F7            jr .searchCopy
  29++1A63              .exit
  30++1A63 AF               xor a
  31++1A64 12               ld (de), a
  32++1A65 C9               ret
  33++1A66
  34++1A66
  35++1A66              makeRequest:
  36++1A66 CD 3B 1A         call extractRequest
  37++1A69
  38++1A69 21 04 0B         ld hl, historyBlock.host
  39++1A6C 11 44 0B         ld de, historyBlock.port
  40++1A6F CD A2 1E         call Wifi.openTCP
  41++1A72 D8               ret c
  42++1A73
  43++1A73 21 E8 1B         ld hl, requestbuffer
  44++1A76 CD F9 1D         call Wifi.tcpSendZ
  45++1A79 AF               xor a
  45++1A7A 32 E4 1E       ld (Wifi.closed), a
  46++1A7D C9               ret
  47++1A7E
  48++1A7E
  49++1A7E              loadBuffer:
  50++1A7E 21 A3 4C         ld hl, outputBuffer
  51++1A81 22 E7 1E         ld (Wifi.buffer_pointer), hl
  52++1A84              .loop
  53++1A84 CD 1B 1E         call Wifi.getPacket
  54++1A87 3A E4 1E         ld a, (Wifi.closed)
  54++1A8A A7             and a
  54++1A8B C0             ret nz
  55++1A8C CD A1 1E         call Wifi.continue
  56++1A8F 18 F3            jr .loop
  57++1A91
  58++1A91                  ifdef GS
  59++1A91              loadMod:
  60++1A91 AF               xor a
  60++1A92 CD 44 20       call GeneralSound.init
  61++1A95 21 D2 1A         ld hl, .progress
  61++1A98 CD 0A 08       call DialogBox.msgNoWait
  62++1A9B CD 66 1A         call makeRequest
  62++1A9E DA AA 19       jp c, Fetcher.fetchFromNet.error
  63++1AA1 CD 51 20         call GeneralSound.loadModule
  64++1AA4              .loop
  65++1AA4 21 A3 4C 22      ld hl, outputBuffer, (Wifi.buffer_pointer), hl
  65++1AA8 E7 1E
  66++1AAA CD 1B 1E         call Wifi.getPacket
  67++1AAD 3A E4 1E         ld a, (Wifi.closed)
  67++1AB0 A7             and a
  67++1AB1 20 19          jr nz, .exit
  68++1AB3 21 A3 4C ED      ld hl, outputBuffer, bc, (Wifi.bytes_avail)
  68++1AB7 4B E5 1E
  69++1ABA              .loadLoop
  70++1ABA 78               ld a, b
  70++1ABB B1             or c
  70++1ABC A7             and a
  70++1ABD 28 08          jr z, .nextFrame
  71++1ABF 7E               ld a, (hl)
  71++1AC0 CD 64 20       call GeneralSound.sendByte
  72++1AC3 0B               dec bc
  73++1AC4 23               inc hl
  74++1AC5 18 F3            jr .loadLoop
  75++1AC7              .nextFrame
  76++1AC7 CD C8 1B         call pulsing
  77++1ACA                  ;call Wifi.continue
  78++1ACA 18 D8            jr .loop
  79++1ACC              .exit
  80++1ACC CD 6C 20         call GeneralSound.finishLoadingModule
  81++1ACF                  ;jp History.back
  82++1ACF C3 F8 19     	jp MediaProcessor.processResource
  83++1AD2 4D 4F 44 20  .progress db "MOD downloading directly to GS!", 0
  83++1AD6 64 6F 77 6E
  83++1ADA 6C 6F 61 64
  83++1ADE 69 6E 67 20
  83++1AE2 64 69 72 65
  83++1AE6 63 74 6C 79
  83++1AEA 20 74 6F 20
  83++1AEE 47 53 21 00
  84++1AF2                  endif
  85++1AF2
  86++1AF2              download:
  87++1AF2 11 05 0A         ld de, historyBlock.locator
  88++1AF5 62 6B            ld hl, de
  89++1AF7              .findFileName
  90++1AF7 1A               ld a, (de)
  90++1AF8 13             inc de
  91++1AF9 FE 2F            cp '/'
  91++1AFB 20 02          jr nz, .skip
  92++1AFD 62 6B            ld hl, de
  93++1AFF              .skip
  94++1AFF A7               and a
  94++1B00 20 F5          jr nz, .findFileName
  95++1B02              .copy
  96++1B02                  ;; HL - filename pointer
  97++1B02 11 B1 07         ld de, DialogBox.inputBuffer
  98++1B05              .copyFileName
  99++1B05 7E               ld a, (hl)
  99++1B06 A7             and a
  99++1B07 28 05          jr z, .finishCopy
 100++1B09
 101++1B09 12               ld (de), a
 101++1B0A 23 13          inc hl, de
 102++1B0C 18 F7            jr .copyFileName
 103++1B0E              .finishCopy
 104++1B0E 12               ld (de), a
 105++1B0F CD 43 07         call DialogBox.inputBox.noclear
 106++1B12 3A A4 07         ld a, (DialogBox.namedownload)
 106++1B15 A7             and a
 106++1B16 CA C2 08       jp z, History.back
 107++1B19
 108++1B19 CD 66 1A         call makeRequest
 108++1B1C DA AA 19       jp c, Fetcher.fetchFromNet.error
 109++1B1F
 110++1B1F 06 0E 21 A4      ld b, Dos.FMODE_CREATE, hl, DialogBox.namedownload
 110++1B23 07
 111++1B24 CD 94 08         call Dos.fopen
 112++1B27 32 C5 1B         ld (.fp), a
 113++1B2A
 114++1B2A 21 A0 1B         ld hl, .progress
 114++1B2D CD 0A 08       call DialogBox.msgNoWait
 115++1B30              .loop
 116++1B30 21 A3 4C 22      ld hl, outputBuffer, (Wifi.buffer_pointer), hl
 116++1B34 E7 1E
 117++1B36 CD 1B 1E         call Wifi.getPacket
 118++1B39 3A E4 1E         ld a, (Wifi.closed)
 118++1B3C A7             and a
 118++1B3D 20 12          jr nz, .exit
 119++1B3F
 120++1B3F 3A C5 1B 21      ld a, (.fp), hl, outputBuffer, bc, (Wifi.bytes_avail)
 120++1B43 A3 4C ED 4B
 120++1B47 E5 1E
 121++1B49 CD A3 08         call Dos.fwrite
 122++1B4C CD C8 1B         call pulsing
 123++1B4F 18 DF            jr .loop
 124++1B51              .exit
 125++1B51 3A C5 1B         ld a, (.fp)
 126++1B54 CD AF 08         call Dos.fclose
 127++1B57 C3 C2 08         jp History.back
 128++1B5A              .error
 129++1B5A 3A C5 1B         ld a, (.fp)
 130++1B5D CD AF 08         call Dos.fclose
 131++1B60 21 69 1B         ld hl, .err
 132++1B63 CD 01 08         call DialogBox.msgBox
 133++1B66 C3 C2 08         jp History.back
 134++1B69
 135++1B69 4F 70 65 72  .err db "Operation failed! Sorry! Check filename or disk space!",0
 135++1B6D 61 74 69 6F
 135++1B71 6E 20 66 61
 135++1B75 69 6C 65 64
 135++1B79 21 20 53 6F
 135++1B7D 72 72 79 21
 135++1B81 20 43 68 65
 135++1B85 63 6B 20 66
 135++1B89 69 6C 65 6E
 135++1B8D 61 6D 65 20
 135++1B91 6F 72 20 64
 135++1B95 69 73 6B 20
 135++1B99 73 70 61 63
 135++1B9D 65 21 00
 136++1BA0 44 6F 77 6E  .progress db "Downloading in progress! Wait a bit!", 0
 136++1BA4 6C 6F 61 64
 136++1BA8 69 6E 67 20
 136++1BAC 69 6E 20 70
 136++1BB0 72 6F 67 72
 136++1BB4 65 73 73 21
 136++1BB8 20 57 61 69
 136++1BBC 74 20 61 20
 136++1BC0 62 69 74 21
 136++1BC4 00
 137++1BC5 00           .fp db 0
 138++1BC6 00           socket db 0
 139++1BC7 20           pulsator db " "
 140++1BC8              pulsing
 141++1BC8 11 01 0B         ld de, #0B01
 141++1BCB CD 3A 01       call TextMode.gotoXY
 142++1BCE 3A C7 1B         ld a, (pulsator)
 143++1BD1 FE 2A            cp '*'
 144++1BD3 CA DF 1B         jp z, printasterix
 145++1BD6 CD 37 01         call TextMode.putC
 146++1BD9 3E 2A            ld a, '*'
 147++1BDB 32 C7 1B         ld (pulsator),a
 148++1BDE C9               ret
 149++1BDF              printasterix
 150++1BDF CD 37 01         call TextMode.putC
 151++1BE2 3E 20            ld a, ' '
 152++1BE4 32 C7 1B         ld (pulsator),a
 153++1BE7 C9               ret
 154++1BE8
 155++1BE8 00 00 00...  requestbuffer ds #1ff
 156++1DE7                  endmodule
 157++1DE7
# file closed: gopher/gopher.asm
  24+ 1DE7                  include "drivers/index.asm"
# file opened: drivers/index.asm
   1++1DE7                  IFDEF UNO
   2++1DE7 ~                	include "uart-uno.asm"
   3++1DE7                  ENDIF
   4++1DE7
   5++1DE7                  IFDEF UNOUART
   6++1DE7 ~                	include "uart-uno.asm"
   7++1DE7                  ENDIF
   8++1DE7
   9++1DE7                  IFDEF MB03
  10++1DE7 ~                	include "uart-mb03.asm"
  11++1DE7                  ENDIF
  12++1DE7
  13++1DE7                  IFDEF AY
  14++1DE7 ~                	include "uart-ay.asm"
  15++1DE7                  ENDIF
  16++1DE7
  17++1DE7                  IFDEF ZW
  18++1DE7 ~                	include "uart-zxwifi.asm"
  19++1DE7                  ENDIF
  20++1DE7
  21++1DE7              	include "utils.asm"
# file opened: drivers/utils.asm
   1++1DE7              ;;; Macroses!!!!
   2++1DE7                  MACRO EspSend Text
   3++1DE7 ~                ld hl, .txtB
   4++1DE7 ~                ld e, (.txtE - .txtB)
   5++1DE7 ~                call espSend
   6++1DE7 ~                jr .txtE
   7++1DE7 ~            .txtB
   8++1DE7 ~                db Text
   9++1DE7 ~            .txtE
  10++1DE7                  ENDM
  11++1DE7
  12++1DE7                  MACRO EspCmd Text
  13++1DE7 ~                ld hl, .txtB
  14++1DE7 ~                ld e, (.txtE - .txtB)
  15++1DE7 ~                call espSend
  16++1DE7 ~                jr .txtE
  17++1DE7 ~            .txtB
  18++1DE7 ~                db Text
  19++1DE7 ~                db 13, 10
  20++1DE7 ~            .txtE
  21++1DE7                  ENDM
  22++1DE7
  23++1DE7                  MACRO EspCmdOkErr text
  24++1DE7 ~                EspCmd text
  25++1DE7 ~                call checkOkErr
  26++1DE7                  ENDM
  27++1DE7
  28++1DE7              ; IN DE - string pointer
  29++1DE7              ; OUT HL - string len
  30++1DE7              strLen:
  31++1DE7 21 00 00         ld hl, 0
  32++1DEA              .loop
  33++1DEA 1A               ld a, (de)
  33++1DEB A7             and a
  33++1DEC C8             ret z
  34++1DED 13 23            inc de, hl
  35++1DEF 18 F9            jr .loop
# file closed: drivers/utils.asm
  22++1DF1
  23++1DF1              	IFDEF UARTATM
  24++1DF1 ~            		include "uart-atm.asm"
  25++1DF1              	ENDIF
  26++1DF1
  27++1DF1              	IFDEF UARTEVO
  28++1DF1 ~            		include "uart-evo.asm"
  29++1DF1                  ENDIF
  30++1DF1
  31++1DF1              	IFDEF NEDONET
  32++1DF1              		include "nedowifi.asm"
# file opened: drivers/nedowifi.asm
   1++1DF1                  MODULE Wifi
   2++1DF1              	macro OS_NETSOCKET ;D=address family (2=inet, 23=inet6), E=socket type (0x01 tcp/ip, 0x02 icmp, 0x03 udp/ip) ;out: L=SOCKET (if L < 0 then A=error)
   3++1DF1 ~            		ld l,0x01
   4++1DF1 ~            		ld c,nos.CMD_WIZNETOPEN
   5++1DF1 ~            		call nos.BDOS
   6++1DF1              	endm
   7++1DF1              	macro OS_NETCONNECT;A=SOCKET, DE=sockaddr ptr {unsigned char sin_family /*net type*/; unsigned short sin_port; struct in_addr sin_addr /*4 bytes IP*/; char sin_zero[8];}; out: if HL < 0 then A=error
   8++1DF1 ~            		ld l,0x03
   9++1DF1 ~            		ld c,nos.CMD_WIZNETOPEN
  10++1DF1 ~            		ex af,af'
  11++1DF1 ~            		call nos.BDOS
  12++1DF1              	endm
  13++1DF1              	macro OS_WIZNETWRITE;A=SOCKET, de=buffer_ptr, HL=sizeof(buffer) ; out: HL=count if HL < 0 then A=error
  14++1DF1 ~            		ld c,nos.CMD_WIZNETWRITE
  15++1DF1 ~            		ex af,af'
  16++1DF1 ~            		call nos.BDOS
  17++1DF1              	endm
  18++1DF1              	macro OS_WIZNETREAD;A=SOCKET, de=buffer_ptr, HL=sizeof(buffer) ; out: HL=count if HL < 0 then A=error
  19++1DF1 ~            		ld c,nos.CMD_WIZNETREAD
  20++1DF1 ~            		ex af,af'
  21++1DF1 ~            		call nos.BDOS
  22++1DF1              	endm
  23++1DF1              	macro OS_NETSHUTDOWN;A=SOCKET ; out: if HL < 0 then A=error
  24++1DF1 ~            		ld l,0x02
  25++1DF1 ~            		ld c,nos.CMD_WIZNETOPEN
  26++1DF1 ~            		ex af,af'
  27++1DF1 ~            		call nos.BDOS
  28++1DF1              	endm
  29++1DF1
  30++1DF1              	macro OS_GETDNS;DE= ptr to DNS buffer(4 bytes)
  31++1DF1 ~            		ld l, 0x08
  32++1DF1 ~            		ld c, nos.CMD_WIZNETOPEN
  33++1DF1 ~            		ex af,af' ;'
  34++1DF1 ~            		call nos.BDOS ;c=CMD
  35++1DF1              	endm
  36++1DF1
  37++1DF1              	macro OS_YIELD
  38++1DF1 ~            		push bc
  39++1DF1 ~                	ld c,nos.CMD_YIELD
  40++1DF1 ~                    call nos.BDOS
  41++1DF1 ~                    pop bc
  42++1DF1              	endm
  43++1DF1
  44++1DF1              init:
  45++1DF1              ; Nothing to init there
  46++1DF1 C9           	ret
  47++1DF2
  48++1DF2              host_ia:
  49++1DF2              .curport=$+1
  50++1DF2 00 00 50 08  	defb 0,0,80,8,8,8,8
  50++1DF6 08 08 08
  51++1DF9
  52++1DF9              tcpSendZ
  53++1DF9 E5           	push hl
  54++1DFA D1           	pop de
  55++1DFB D5           	push de
  56++1DFC CD E7 1D     	call strLen
  57++1DFF D1           	pop de
  58++1E00 3A 06 20     	ld a,(sock_fd)
  59++1E03              	OS_WIZNETWRITE
  59++1E03 0E DE       >		ld c,nos.CMD_WIZNETWRITE
  59++1E05 08          >		ex af,af'
  59++1E06 CD 05 00    >		call nos.BDOS
  60++1E09 21 02 00     	ld hl,2
  61++1E0C 11 19 1E     	ld de,.rn
  62++1E0F 3A 06 20     	ld a,(sock_fd)
  63++1E12              	OS_WIZNETWRITE
  63++1E12 0E DE       >		ld c,nos.CMD_WIZNETWRITE
  63++1E14 08          >		ex af,af'
  63++1E15 CD 05 00    >		call nos.BDOS
  64++1E18 C9           	ret
  65++1E19 0D 0A        .rn defb "\r\n"
  66++1E1B
  67++1E1B              getPacket
  68++1E1B              ;if A = op8 then the C flag is reset, and Z is set.
  69++1E1B              ;If A < op8, C is set and Z is reset.
  70++1E1B              ;If A > op8 then both C and Z are reset
  71++1E1B ED 5B E7 1E      ld de,(buffer_pointer)
  72++1E1F 3E FB        	ld a,0xfb
  73++1E21 BA           	cp d
  74++1E22 D2 58 1E     	jp nc, letsgo
  75++1E25 21 35 1E     	ld hl, .errMem
  75++1E28 CD 01 08       call DialogBox.msgBox
  76++1E2B 3E 01        	ld a,1
  77++1E2D 32 E4 1E     	ld (closed),a
  78++1E30 AF           	xor a
  79++1E31 32 E5 1E     	ld (bytes_avail),a
  80++1E34 C9           	ret
  81++1E35              .errMem:
  82++1E35 4F 75 74 20  	db "Out of memory. Page loading error.",0
  82++1E39 6F 66 20 6D
  82++1E3D 65 6D 6F 72
  82++1E41 79 2E 20 50
  82++1E45 61 67 65 20
  82++1E49 6C 6F 61 64
  82++1E4D 69 6E 67 20
  82++1E51 65 72 72 6F
  82++1E55 72 2E 00
  83++1E58              letsgo:
  84++1E58 ED 5B E7 1E      ld de,(buffer_pointer)
  85++1E5C 21 00 04         ld hl,1024
  86++1E5F 3A 06 20         ld a,(sock_fd)
  87++1E62              	OS_WIZNETREAD
  87++1E62 0E DD       >		ld c,nos.CMD_WIZNETREAD
  87++1E64 08          >		ex af,af'
  87++1E65 CD 05 00    >		call nos.BDOS
  88++1E68 CB 7C            BIT 7,H
  89++1E6A 28 24            JR Z,RECEIVED	;╨╛╤И╨╕╨▒╨╛╨║ ╨╜╨╡╤В
  90++1E6C FE 23        	CP 35   ;ERR_EAGAIN
  91++1E6E CA 58 1E         jp z, letsgo
  92++1E71                  ;╨╛╨▒╤А╨░╨▒╨╛╤В╨║╨░ ╨╛╤И╨╕╨▒╨║╨╕
  93++1E71 3E 01            ld a,1
  94++1E73 32 E4 1E         ld (closed), a
  95++1E76 3A 06 20         LD	a,(sock_fd)
  96++1E79 1E 00            LD	E,0
  97++1E7B              	OS_NETSHUTDOWN
  97++1E7B 2E 02       >		ld l,0x02
  97++1E7D 0E DB       >		ld c,nos.CMD_WIZNETOPEN
  97++1E7F 08          >		ex af,af'
  97++1E80 CD 05 00    >		call nos.BDOS
  98++1E83 2A E7 1E     	ld hl,(buffer_pointer)
  99++1E86 11 A3 4C     	ld de,outputBuffer
 100++1E89 B7           	or a
 101++1E8A ED 52        	sbc hl,de
 102++1E8C 22 E5 1E         ld (bytes_avail),HL
 103++1E8F C9               ret
 104++1E90              RECEIVED
 105++1E90 EB           	ex hl,de
 106++1E91 2A E7 1E         ld hl,(buffer_pointer)
 107++1E94 19           	add hl,de
 108++1E95 22 E7 1E     	ld (buffer_pointer),hl
 109++1E98 11 A3 4C     	ld de,outputBuffer
 110++1E9B B7           	or a
 111++1E9C ED 52        	sbc hl,de
 112++1E9E 22 E5 1E         ld (bytes_avail),HL
 113++1EA1              continue
 114++1EA1 C9               ret
 115++1EA2
 116++1EA2
 117++1EA2              openTCP ;DE - port_str, HL - domain name
 118++1EA2 E5           	push hl
 119++1EA3 CD 82 01     	call atohl
 120++1EA6 7C 65 6F     	ld a,h,h,l,l,a
 121++1EA9 22 F3 1D     	ld (host_ia.curport),hl
 122++1EAC D1           	pop de
 123++1EAD CD 00 1F     	call dns_resolver
 124++1EB0 7C           	ld a,h
 124++1EB1 B5             or l
 124++1EB2 CA E9 1E       jp z,reqErr
 125++1EB5 11 F5 1D     	ld de,host_ia+3
 126++1EB8 01 04 00     	ld bc,4
 127++1EBB ED B0        	ldir
 128++1EBD 11 01 02     	ld de,1+(2<<8)
 129++1EC0              	OS_NETSOCKET
 129++1EC0 2E 01       >		ld l,0x01
 129++1EC2 0E DB       >		ld c,nos.CMD_WIZNETOPEN
 129++1EC4 CD 05 00    >		call nos.BDOS
 130++1EC7 7D           	ld a,l
 130++1EC8 B7             or a
 130++1EC9 FA E9 1E       jp m,reqErr
 131++1ECC 32 06 20     	ld (sock_fd),a
 132++1ECF 11 F2 1D     	ld de,host_ia
 133++1ED2              	OS_NETCONNECT
 133++1ED2 2E 03       >		ld l,0x03
 133++1ED4 0E DB       >		ld c,nos.CMD_WIZNETOPEN
 133++1ED6 08          >		ex af,af'
 133++1ED7 CD 05 00    >		call nos.BDOS
 134++1EDA 7D               ld a,l
 134++1EDB B7             or a
 134++1EDC FA E9 1E       jp m,reqErr
 135++1EDF AF               xor a
 135++1EE0 32 E4 1E       ld (closed), a
 136++1EE3 C9           	ret
 137++1EE4
 138++1EE4              closed
 139++1EE4 01               defb 1
 140++1EE5              bytes_avail
 141++1EE5 00 00            defw 0
 142++1EE7              buffer_pointer
 143++1EE7 00 00            defw 0
 144++1EE9
 145++1EE9              reqErr
 146++1EE9 21 F1 1E         ld hl, .errMsg
 146++1EEC CD 01 08       call DialogBox.msgBox
 147++1EEF 37               scf
 148++1EF0 C9               ret
 149++1EF1 53 6F 63 6B  .errMsg db "Socket failed!",0
 149++1EF5 65 74 20 66
 149++1EF9 61 69 6C 65
 149++1EFD 64 21 00
 150++1F00
 151++1F00              dns_resolver:		;DE-domain name
 152++1F00 ED 53 23 1F      ld (.httphostname),de
 153++1F04 3E FE            ld a,254
 154++1F06 32 85 1F         ld (.dns_err_count),a
 155++1F09              .dns_err_loop
 156++1F09              	;push de
 157++1F09 21 F9 1F     	ld hl,.dns_head
 158++1F0C 11 A3 4C     	ld de,outputBuffer
 159++1F0F 01 06 00     	ld bc,6
 160++1F12 ED B0        	ldir
 161++1F14 EB           	ex de,hl
 162++1F15 11 AA 4C     	ld de,outputBuffer+7
 163++1F18 70           	ld (hl),b;0
 164++1F19 0E F9        	ld  c,256-7
 165++1F1B ED B0        	ldir
 166++1F1D 11 AF 4C     	ld de,outputBuffer+12
 167++1F20 62           	ld h,d
 168++1F21 6B           	ld l,e
 169++1F22 01 23 1F     	ld bc,.httphostname ;pop bc
 170++1F25              .httphostname=$-2
 171++1F25              .name_loop:
 172++1F25 23           	inc hl
 173++1F26 0A           	ld a,(bc)
 174++1F27 77           	ld (hl),a
 175++1F28 03           	inc bc
 176++1F29 FE 2E        	cp '.'
 177++1F2B 28 03        	jr z,.is_dot
 178++1F2D B7           	or a
 179++1F2E 20 F5        	jr nz,.name_loop
 180++1F30              .is_dot:
 181++1F30 ED 52        	sbc hl,de
 182++1F32 EB           	ex de,hl
 183++1F33 1D           	dec e
 184++1F34 73           	ld (hl),e
 185++1F35 1C           	inc e
 186++1F36 19           	add hl,de
 187++1F37 54           	ld d,h
 188++1F38 5D           	ld e,l
 189++1F39 B7           	or a
 190++1F3A 20 E9        	jr nz,.name_loop
 191++1F3C 3C           	inc a
 192++1F3D 23           	inc hl
 193++1F3E 23           	inc hl
 194++1F3F 77           	ld (hl),a
 195++1F40 23           	inc hl
 196++1F41 23           	inc hl
 197++1F42 77           	ld (hl),a
 198++1F43 23           	inc hl
 199++1F44 E5           	push hl
 200++1F45              ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 201++1F45 3A 02 20     	ld a, (.dns_ia2)
 202++1F48 FE 00        	cp 0
 203++1F4A C2 58 1F     	jp nz, .skipgetdns
 204++1F4D 11 02 20     	ld de, .dns_ia2;DE= ptr to DNS buffer(4 bytes)
 205++1F50              	OS_GETDNS
 205++1F50 2E 08       >		ld l, 0x08
 205++1F52 0E DB       >		ld c, nos.CMD_WIZNETOPEN
 205++1F54 08          >		ex af,af' ;'
 205++1F55 CD 05 00    >		call nos.BDOS ;c=CMD
 206++1F58              ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 207++1F58              .skipgetdns:
 208++1F58 11 03 02     	ld de,0x0203
 209++1F5B                  OS_NETSOCKET
 209++1F5B 2E 01       >		ld l,0x01
 209++1F5D 0E DB       >		ld c,nos.CMD_WIZNETOPEN
 209++1F5F CD 05 00    >		call nos.BDOS
 210++1F62 7D           	ld a,l
 211++1F63 32 06 20     	ld (sock_fd),a
 212++1F66 B7           	or a
 213++1F67 FA D6 1F     	jp m,.dns_exiterr
 214++1F6A E1           	pop hl
 215++1F6B E5           	push hl
 216++1F6C 11 5D B3     	ld de,0xffff&(-outputBuffer)
 217++1F6F 19           	add hl,de
 218++1F70 3A 06 20     	LD	a,(sock_fd)
 219++1F73 DD 21 A3 4C  	LD	IX,outputBuffer
 220++1F77 11 FF 1F     	LD	DE,.dns_ia
 221++1F7A              	OS_WIZNETWRITE
 221++1F7A 0E DE       >		ld c,nos.CMD_WIZNETWRITE
 221++1F7C 08          >		ex af,af'
 221++1F7D CD 05 00    >		call nos.BDOS
 222++1F80 CB 7C        	bit 7,h
 223++1F82 20 2F        	jr nz,.dns_exitcode
 224++1F84              .dns_err_count=$+1
 225++1F84 06 20        	ld b,32
 226++1F86 18 07        	jr .recv_wait1
 227++1F88              .recv_wait:
 228++1F88 C5                   push bc
 229++1F89 0E F2                ld c,nos.CMD_YIELD
 230++1F8B CD 05 00             call nos.BDOS
 231++1F8E C1                   pop bc
 232++1F8F              .recv_wait1:
 233++1F8F C5           	push bc
 234++1F90 21 00 01     	ld hl,256
 235++1F93 3A 06 20     	LD	a,(sock_fd)
 236++1F96 11 A3 4C     	LD	DE,outputBuffer
 237++1F99 DD 21 A3 4C  	LD	IX,outputBuffer
 238++1F9D              	OS_WIZNETREAD
 238++1F9D 0E DD       >		ld c,nos.CMD_WIZNETREAD
 238++1F9F 08          >		ex af,af'
 238++1FA0 CD 05 00    >		call nos.BDOS
 239++1FA3 C1           	pop bc
 240++1FA4 CB 7C        	bit 7,h
 241++1FA6 28 04        	jr z,.recv_wait_end
 242++1FA8 10 DE        	djnz .recv_wait
 243++1FAA 18 2A        	jr .dns_exiterr
 244++1FAC              .recv_wait_end:
 245++1FAC 3A A6 4C     	ld a,(outputBuffer+3)
 246++1FAF E6 0F        	and 0x0f
 247++1FB1 20 23        	jr nz,.dns_exiterr
 248++1FB3              .dns_exitcode:
 249++1FB3 3A 06 20     	LD	a,(sock_fd)
 250++1FB6 1E 00        	LD	E,0
 251++1FB8              	OS_NETSHUTDOWN
 251++1FB8 2E 02       >		ld l,0x02
 251++1FBA 0E DB       >		ld c,nos.CMD_WIZNETOPEN
 251++1FBC 08          >		ex af,af'
 251++1FBD CD 05 00    >		call nos.BDOS
 252++1FC0 E1           	pop hl
 253++1FC1              .reqpars_l
 254++1FC1 23           	inc hl
 255++1FC2 23           	inc hl
 256++1FC3 23           	inc hl
 257++1FC4 7E           	ld a,(hl)
 258++1FC5 11 07 00     	ld de,7
 259++1FC8 19           	add hl,de
 260++1FC9 46           	ld b,(hl)
 261++1FCA 23           	inc hl
 262++1FCB 4E           	ld c,(hl)
 263++1FCC 23           	inc hl
 264++1FCD 3D           	dec a
 265++1FCE C8           	ret z
 266++1FCF FE 04        	cp 4
 267++1FD1 20 22        	jr nz,.exiterr1
 268++1FD3 09           	add hl,bc
 269++1FD4 18 EB        	jr .reqpars_l
 270++1FD6              .dns_exiterr:
 271++1FD6 F1           	pop af
 272++1FD7 3A 06 20     	LD	a,(sock_fd)
 273++1FDA 1E 00        	LD	E,0
 274++1FDC              	OS_NETSHUTDOWN
 274++1FDC 2E 02       >		ld l,0x02
 274++1FDE 0E DB       >		ld c,nos.CMD_WIZNETOPEN
 274++1FE0 08          >		ex af,af'
 274++1FE1 CD 05 00    >		call nos.BDOS
 275++1FE4 3A 85 1F         ld a,(.dns_err_count)
 276++1FE7 87               add a,a
 277++1FE8 32 85 1F         ld (.dns_err_count),a
 278++1FEB              	OS_YIELD
 278++1FEB C5          >		push bc
 278++1FEC 0E F2       >    	ld c,nos.CMD_YIELD
 278++1FEE CD 05 00    >        call nos.BDOS
 278++1FF1 C1          >        pop bc
 279++1FF2 D2 09 1F         jp nc,.dns_err_loop
 280++1FF5              .exiterr1:
 281++1FF5 21 00 00         ld hl,0
 282++1FF8 C9           	ret
 283++1FF9              .dns_head
 284++1FF9 11 22 01 00  	defb 0x11,0x22,0x01,0x00,0x00,0x01
 284++1FFD 00 01
 285++1FFF
 286++1FFF              ;struct sockaddr_in {unsigned char sin_family;unsigned short sin_port;
 287++1FFF              ;	struct in_addr sin_addr;char sin_zero[8];};
 288++1FFF              .dns_ia:
 289++1FFF 00           	defb 0
 290++2000 00 35                db 0,53 ;port (big endian)
 291++2002              .dns_ia2:
 292++2002 00 00 00 00          db 0,0,0,0 ;ip (big endian)
 293++2006
 294++2006 00           sock_fd     defb 0
 295++2007                  ENDMODULE
# file closed: drivers/nedowifi.asm
  33++2007              	ELSE
  34++2007 ~            	IFNDEF MSX
  35++2007 ~            		include "wifi.asm"
  36++2007 ~            	ENDIF
  37++2007              	ENDIF
  38++2007
  39++2007                  IFDEF NEDOOS
  40++2007                  	include "rtc-nos.asm"
# file opened: drivers/rtc-nos.asm
   1++2007              ;clock driver nedoOS
   2++2007              	module Clock
   3++2007              readTime
   4++2007 0E E2        	ld c,nos.CMD_GETTIME
   5++2009 CD 05 00         call nos.BDOS		;out: ix=date, hl=time
   6++200C F3           	di
   7++200D DD E5        	push ix
   8++200F C1           	pop bc
   9++2010 FB           	ei
  10++2011
  11++2011 E5           	push hl
  12++2012 D1           	pop de
  13++2013 7B           	ld a,e
  14++2014 87               add a,a
  15++2015 E6 3F            and 63	;seconds
  16++2017 32 43 21     	ld (seconds),a
  17++201A
  18++201A 7A           	ld a,d
  19++201B 1F               rra
  20++201C 1F               rra
  21++201D 1F               rra
  22++201E E6 1F            and 31 		;hours
  23++2020 32 41 21     	ld (hours),a
  24++2023
  25++2023 EB               ex de,hl
  26++2024 29               add hl,hl
  27++2025 29               add hl,hl
  28++2026 29               add hl,hl
  29++2027 EB               ex de,hl
  30++2028 7A               ld a,d
  31++2029 E6 3F            and 63       ;minutes
  32++202B 32 42 21      	ld (minutes),a
  33++202E
  34++202E              ;   ld a,h
  35++202E              ;   srl a
  36++202E              ;   ;sub 20
  37++202E              ;   ld (year),a
  38++202E              ;   ld a,l
  39++202E              ;   and 31
  40++202E              ;   ld (day),a
  41++202E              ;   add hl,hl
  42++202E              ;   add hl,hl
  43++202E              ;   add hl,hl
  44++202E              ;   ld a,h
  45++202E              ;   and 15
  46++202E              ;   ld (month),a
  47++202E
  48++202E
  49++202E C9             	ret
  50++202F                  endmodule
  51++202F
# file closed: drivers/rtc-nos.asm
  41++202F                  ENDIF
  42++202F
  43++202F
  44++202F                  IFDEF SMUCRTC
  45++202F ~                	include "rtc-smuc.asm"
  46++202F                  ENDIF
  47++202F
  48++202F              	IFDEF MSX
  49++202F ~                    include "drivers/unapi/unapi.asm"
  50++202F ~                	include "drivers/unapi/tcp.asm"
  51++202F ~            		include "rtc-msx.asm"
  52++202F                  ELSE
  53++202F              		include "proxy.asm"
# file opened: drivers/proxy.asm
   1++202F                  IFDEF PROXY
   2++202F ~                MODULE Wifi
   3++202F ~            ; Same singature as wifi.openTCP
   4++202F ~            ; HL - host pointer in gopher row
   5++202F ~            ; DE - port pointer in gopher row
   6++202F ~            openTCP:
   7++202F ~                push de
   8++202F ~                push hl
   9++202F ~
  10++202F ~                xor a
  10++202F ~              ld hl, hostBuff, de, hostBuff + 1, bc, 102, (hl), a
  10++202F ~              ldir
  11++202F ~
  12++202F ~                EspCmdOkErr "AT+CIPCLOSE"
  13++202F ~                EspCmdOkErr 'AT+CIPSTART="TCP","138.68.76.243",6912' // Replace here for yourown proxy. If you wish
  14++202F ~                jr c, .error
  15++202F ~                pop hl
  15++202F ~              ld de, hostBuff
  16++202F ~            .copyHost
  17++202F ~                ld a, (hl)
  17++202F ~              and a
  17++202F ~              jr z, 1F
  17++202F ~              and a
  17++202F ~              jr z, 1F
  18++202F ~                ld (de), a
  18++202F ~              inc hl, de
  19++202F ~                jr .copyHost
  20++202F ~            1   xor a
  20++202F ~              ld (de), a
  21++202F ~                pop hl
  21++202F ~              ld de, portBuff
  22++202F ~            .copyPort
  23++202F ~                ld a, (hl)
  23++202F ~              and a
  23++202F ~              jr z, 1F
  23++202F ~              and a
  23++202F ~              jr z, 1F
  24++202F ~                ld (de), a
  24++202F ~              inc hl, de
  25++202F ~                jr .copyPort
  26++202F ~            1   ld hl, hostBuff
  26++202F ~              call tcpSendZ
  27++202F ~                ld hl, portBuff
  27++202F ~              call tcpSendZ
  28++202F ~                xor a
  28++202F ~              ld (closed), a
  29++202F ~                ret
  30++202F ~            .error
  31++202F ~                pop hl
  31++202F ~              pop de
  32++202F ~                ret
  33++202F ~
  34++202F ~            continue:
  35++202F ~                EspCmdOkErr "AT+CIPSEND=1"
  36++202F ~                ret c
  37++202F ~            .wait
  38++202F ~                call Uart.read
  38++202F ~              cp '>'
  38++202F ~              jr nz, .wait
  39++202F ~                ld a, 'c'
  39++202F ~              call Uart.write
  40++202F ~                jp checkOkErr
  41++202F ~
  42++202F ~            hostBuff ds 96
  43++202F ~            portBuff ds 7
  44++202F ~                ENDMODULE
  45++202F                  ENDIF
# file closed: drivers/proxy.asm
  54++202F              		include "memory.asm"
# file opened: drivers/memory.asm
   1++202F                  module Memory
   2++202F              BANKM = #5b5c
   3++202F              MEM_PORT = #7ffd
   4++202F
   5++202F              init:
   6++202F F3               di
   7++2030 FD CB 01 A6      res 4, (iy + 1)
   8++2034
   9++2034 AF               xor a
   9++2035 CD 39 20       call setPage
  10++2038 C9               ret
  11++2039
  12++2039              ; a - page
  13++2039              setPage:
  14++2039 F6 18            or #18
  14++203B 32 5C 5B       ld (BANKM), a
  15++203E 01 FD 7F         ld bc, MEM_PORT
  15++2041 ED 79          out (c), a
  16++2043 C9               ret
  17++2044
  18++2044                  endmodule
# file closed: drivers/memory.asm
  55++2044              	ENDIF
  56++2044
  57++2044              	IFDEF GS
  58++2044              		include "general-sound.asm"
# file opened: drivers/general-sound.asm
   1++2044                  macro _WaitCommand
   2++2044 ~            .wait
   3++2044 ~                in a, (GeneralSound.CMD)
   4++2044 ~                rrca
   5++2044 ~                jr c, .wait
   6++2044                  endm
   7++2044
   8++2044                  macro _WaitData
   9++2044 ~            .wait
  10++2044 ~                in a, (GeneralSound.CMD)
  11++2044 ~                rlca
  12++2044 ~                jr c, .wait
  13++2044                  endm
  14++2044
  15++2044                  macro _SendCommand nn
  16++2044 ~                ld a, nn
  16++2044 ~              out (GeneralSound.CMD), a
  17++2044                  endm
  18++2044
  19++2044                  module GeneralSound
  20++2044              ;; Control ports
  21++2044              CMD  = 187
  22++2044              DATA = 179
  23++2044
  24++2044              ;; Commands
  25++2044              CMD_WARM_RESET      = #F3
  26++2044              CMD_COLD_RESET      = #F4
  27++2044              CMD_LOAD_MODULE     = #30
  28++2044              CMD_PLAY_MODULE     = #31
  29++2044              CMD_STOP_MODULE     = #32
  30++2044              CMD_CONTINUE_MODULE = #33
  31++2044              CMD_OPEN_STREAM     = #D1
  32++2044              CMD_CLOSE_STREAM    = #D2
  33++2044
  34++2044              ; A - 0 warm reset, other - cold
  35++2044              init:
  36++2044 A7               and a
  36++2045 20 05          jr nz, .cold
  37++2047                  _SendCommand CMD_WARM_RESET
  37++2047 3E F3       >    ld a, CMD_WARM_RESET
  37++2049 D3 BB       >  out (GeneralSound.CMD), a
  38++204B C9               ret
  39++204C              .cold
  40++204C                  _SendCommand CMD_COLD_RESET
  40++204C 3E F4       >    ld a, CMD_COLD_RESET
  40++204E D3 BB       >  out (GeneralSound.CMD), a
  41++2050 C9               ret
  42++2051
  43++2051              ;; Initializes loading module
  44++2051              loadModule:
  45++2051                  _SendCommand CMD_LOAD_MODULE
  45++2051 3E 30       >    ld a, CMD_LOAD_MODULE
  45++2053 D3 BB       >  out (GeneralSound.CMD), a
  46++2055                  _WaitCommand
  46++2055             >.wait
  46++2055 DB BB       >    in a, (GeneralSound.CMD)
  46++2057 0F          >    rrca
  46++2058 38 FB       >    jr c, .wait
  47++205A                  _SendCommand CMD_OPEN_STREAM
  47++205A 3E D1       >    ld a, CMD_OPEN_STREAM
  47++205C D3 BB       >  out (GeneralSound.CMD), a
  48++205E                  _WaitCommand
  48++205E             >.wait
  48++205E DB BB       >    in a, (GeneralSound.CMD)
  48++2060 0F          >    rrca
  48++2061 38 FB       >    jr c, .wait
  49++2063 C9               ret
  50++2064
  51++2064              ;; Use it for streaming mod file
  52++2064              sendByte:
  53++2064 D3 B3            out (DATA), a
  54++2066                  _WaitData
  54++2066             >.wait
  54++2066 DB BB       >    in a, (GeneralSound.CMD)
  54++2068 07          >    rlca
  54++2069 38 FB       >    jr c, .wait
  55++206B C9               ret
  56++206C
  57++206C              ;; Call it when module was loaded
  58++206C              finishLoadingModule:
  59++206C                  _SendCommand CMD_CLOSE_STREAM
  59++206C 3E D2       >    ld a, CMD_CLOSE_STREAM
  59++206E D3 BB       >  out (GeneralSound.CMD), a
  60++2070                  _WaitCommand
  60++2070             >.wait
  60++2070 DB BB       >    in a, (GeneralSound.CMD)
  60++2072 0F          >    rrca
  60++2073 38 FB       >    jr c, .wait
  61++2075              rewind:
  62++2075 3E 01            ld a, 1
  62++2077 D3 B3          out (DATA), a
  63++2079                  _SendCommand CMD_PLAY_MODULE
  63++2079 3E 31       >    ld a, CMD_PLAY_MODULE
  63++207B D3 BB       >  out (GeneralSound.CMD), a
  64++207D                  _WaitCommand
  64++207D             >.wait
  64++207D DB BB       >    in a, (GeneralSound.CMD)
  64++207F 0F          >    rrca
  64++2080 38 FB       >    jr c, .wait
  65++2082 3E 01 32 A6      ld a, 1, (state),a
  65++2086 20
  66++2087 C9               ret
  67++2088
  68++2088              ;; Works like pause too
  69++2088              stopModule:
  70++2088 AF               xor a
  70++2089 32 A6 20       ld (state), a
  71++208C                  _SendCommand CMD_STOP_MODULE
  71++208C 3E 32       >    ld a, CMD_STOP_MODULE
  71++208E D3 BB       >  out (GeneralSound.CMD), a
  72++2090 C9               ret
  73++2091
  74++2091              continueModule:
  75++2091 3E 01            ld a, 1
  75++2093 32 A6 20       ld (state), a
  76++2096                  _SendCommand CMD_CONTINUE_MODULE
  76++2096 3E 33       >    ld a, CMD_CONTINUE_MODULE
  76++2098 D3 BB       >  out (GeneralSound.CMD), a
  77++209A C9               ret
  78++209B
  79++209B              ; Pauses resumes
  80++209B              toggleModule:
  81++209B CD 51 08         call Console.waitForKeyUp
  82++209E 3A A6 20         ld a, (state)
  82++20A1 A7             and a
  83++20A2 28 ED            jr z, continueModule
  84++20A4 18 E2            jr stopModule
  85++20A6
  86++20A6 00           state db 0
  87++20A7                  endmodule
# file closed: drivers/general-sound.asm
  59++20A7              	ENDIF
# file closed: drivers/index.asm
  25+ 20A7                  include "screen/rtc.asm"
# file opened: screen/rtc.asm
   1++20A7              printRTC
   2++20A7              	IFDEF RTC
   3++20A7 CD 07 20     	call Clock.readTime
   4++20AA
   5++20AA 3A 4C 21     	ld a, (oldminutes)
   6++20AD 57           	ld d,a
   7++20AE 3A 42 21     	ld a, (minutes)
   8++20B1 BA           	cp d					; Update only if minutes changed
   9++20B2 C8           	ret z
  10++20B3 32 4C 21     	ld (oldminutes), a
  11++20B6
  12++20B6 16 01        	ld d,1 ;координаты Y,X
  13++20B8 1E 49        	ld e,80 - 7
  14++20BA CD 3A 01     	call TextMode.gotoXY
  15++20BD 3E 5B        	ld a,'['
  16++20BF CD 37 01     	call TextMode.putC
  17++20C2 26 00        	ld h,0
  18++20C4 3A 41 21     	ld a,(hours) ;часы
  19++20C7 6F           	ld l,a
  20++20C8 CD EB 20     	call toDecimal
  21++20CB 21 47 21     	ld hl,decimalS+3
  22++20CE CD 27 01     	call TextMode.printZ
  23++20D1 3E 3A        	ld a,':'
  24++20D3 CD 37 01     	call TextMode.putC
  25++20D6 26 00        	ld h,0
  26++20D8 3A 42 21     	ld a,(minutes) ;минуты
  27++20DB 6F           	ld l,a
  28++20DC CD EB 20     	call toDecimal
  29++20DF 21 47 21     	ld hl,decimalS+3
  30++20E2 CD 27 01     	call TextMode.printZ
  31++20E5              	;ld a,':'
  32++20E5              	;call TextMode.putC
  33++20E5              	;ld h,0
  34++20E5              	;ld a,(seconds) ;секунды
  35++20E5              	;ld l,a
  36++20E5              	;call toDecimal
  37++20E5              	;ld hl,decimalS+3
  38++20E5              	;call TextMode.printZ
  39++20E5 3E 5D        	ld a,']'
  40++20E7 CD 37 01     	call TextMode.putC
  41++20EA C9           	ret
  42++20EB
  43++20EB              toDecimal		;конвертирует 2 байта в 5 десятичных цифр
  44++20EB              				;на входе в HL число
  45++20EB 11 10 27     	ld de,10000 ;десятки тысяч
  46++20EE 3E FF        	ld a,255
  47++20F0              toDecimal10k
  48++20F0 A7           	and a
  49++20F1 ED 52        	sbc hl,de
  50++20F3 3C           	inc a
  51++20F4 30 FA        	jr nc,toDecimal10k
  52++20F6 19           	add hl,de
  53++20F7 C6 30        	add a,48
  54++20F9 32 44 21     	ld (decimalS),a
  55++20FC 11 E8 03     	ld de,1000 ;тысячи
  56++20FF 3E FF        	ld a,255
  57++2101              toDecimal1k
  58++2101 A7           	and a
  59++2102 ED 52        	sbc hl,de
  60++2104 3C           	inc a
  61++2105 30 FA        	jr nc,toDecimal1k
  62++2107 19           	add hl,de
  63++2108 C6 30        	add a,48
  64++210A 32 45 21     	ld (decimalS+1),a
  65++210D 11 64 00     	ld de,100 ;сотни
  66++2110 3E FF        	ld a,255
  67++2112              toDecimal01k
  68++2112 A7           	and a
  69++2113 ED 52        	sbc hl,de
  70++2115 3C           	inc a
  71++2116 30 FA        	jr nc,toDecimal01k
  72++2118 19           	add hl,de
  73++2119 C6 30        	add a,48
  74++211B 32 46 21     	ld (decimalS+2),a
  75++211E 11 0A 00     	ld de,10 ;десятки
  76++2121 3E FF        	ld a,255
  77++2123              toDecimal001k
  78++2123 A7           	and a
  79++2124 ED 52        	sbc hl,de
  80++2126 3C           	inc a
  81++2127 30 FA        	jr nc,toDecimal001k
  82++2129 19           	add hl,de
  83++212A C6 30        	add a,48
  84++212C 32 47 21     	ld (decimalS+3),a
  85++212F 11 01 00     	ld de,1 ;единицы
  86++2132 3E FF        	ld a,255
  87++2134              toDecimal0001k
  88++2134 A7           	and a
  89++2135 ED 52        	sbc hl,de
  90++2137 3C           	inc a
  91++2138 30 FA        	jr nc,toDecimal0001k
  92++213A 19           	add hl,de
  93++213B C6 30        	add a,48
  94++213D 32 48 21     	ld (decimalS+4),a
  95++2140 C9           	ret
  96++2141              hours
  97++2141 00           	db 0
  98++2142              minutes
  99++2142 00           	db 0
 100++2143              seconds
 101++2143 00           	db 0
 102++2144 00 00 00...  decimalS	ds 7 ;десятичные цифры
 103++214B              	ENDIF
 104++214B C9           	ret
 105++214C              oldminutes		; не убирать под условие
 106++214C FF           	db 255
 107++214D
 108++214D
 109++214D
 110++214D
# file closed: screen/rtc.asm
  26+ 214D
  27+ 214D                  IFDEF NEDOOS
  28+ 214D                      include "screen/nedoscreen.asm"
# file opened: screen/nedoscreen.asm
   1++214D
   2++214D              	module ScreenViewer
   3++214D              display:
   4++214D CD 51 08         call Console.waitForKeyUp
   5++2150 1E 83        	ld e,0x83
   6++2152 0E F9        	ld c,nos.CMD_SETGFX
   7++2154 CD 05 00     	call nos.BDOS
   8++2157 3A 35 00     	ld a,(nos.user_scr0_high)
   9++215A EF           	rst 0x28
  10++215B 21 A3 4C 11      ld hl, outputBuffer, de, #c000, bc, 6912
  10++215F 00 C0 01 00
  10++2163 1B
  10++2164 ED B0          ldir
  11++2166 AF               xor a
  11++2167 D3 FE          out (#fe), a
  12++2169              .wait
  13++2169 CD 38 08         call Console.getC
  14++216C 1E 86        	ld e,0x86
  15++216E 0E F9        	ld c,nos.CMD_SETGFX
  16++2170 CD 05 00     	call nos.BDOS
  17++2173 3A 05 01     	ld a,(TextMode.pgC)
  18++2176 EF           	rst 0x28
  19++2177 CD 30 01         call TextMode.cls
  20++217A C3 C2 08         jp History.back
  21++217D                  endmodule
# file closed: screen/nedoscreen.asm
  29+ 217D                      include "player/vortexnedoos.asm"
# file opened: player/vortexnedoos.asm
   1++217D                  MODULE VortexProcessor
   2++217D              play:
   3++217D 3E FF            ld a, 255
   4++217F 32 4C 21         ld (oldminutes), a
   5++2182
   6++2182 CD 51 08         call Console.waitForKeyUp
   7++2185
   8++2185 21 BB 21         ld hl, message
   8++2188 CD 0A 08       call DialogBox.msgNoWait
   9++218B
  10++218B 21 A3 4C         ld hl, outputBuffer
  10++218E CD 41 40       call VTPL.INIT
  11++2191
  12++2191
  13++2191 3E 00 32 3E      ld a, 0, (Render.play_next), a
  13++2195 07
  14++2196                  ifdef GS
  15++2196 CD 88 20         call GeneralSound.stopModule
  16++2199                  endif
  17++2199 3A 03 01     	ld a,(TextMode.pg4)
  18++219C 21 64 48     	ld hl,VTPL.PLAY
  19++219F 0E D5        	ld c,nos.CMD_SETMUSIC
  20++21A1 08           	ex af,af'
  21++21A2 CD 05 00     	call nos.BDOS
  22++21A5 CD 38 08         call Console.getC
  23++21A8 3A 03 01     	ld a,(TextMode.pg4)
  24++21AB 21 F6 4B     	ld hl,fakemod.fakeret
  25++21AE 0E D5        	ld c,nos.CMD_SETMUSIC
  26++21B0 08           	ex af,af'
  27++21B1 CD 05 00     	call nos.BDOS
  28++21B4 CD 2F 40         call VTPL.MUTE
  29++21B7 CD 51 08         call Console.waitForKeyUp
  30++21BA C9               ret
  31++21BB
  32++21BB 20 20 20 20  message db "    Press key to stop...", 0
  32++21BF 50 72 65 73
  32++21C3 73 20 6B 65
  32++21C7 79 20 74 6F
  32++21CB 20 73 74 6F
  32++21CF 70 2E 2E 2E
  32++21D3 00
  33++21D4                  ENDMODULE
  34++21D4              	org 0x4000
  35++4000
  36++4000                  include "player.asm"
# file opened: player/player.asm
   1++4000              ;Universal PT2'n'PT3 Turbo Sound player for ZX Spectrum
   2++4000              ;(c)2004-2007 S.V.Bulba <vorobey@mail.khstu.ru>
   3++4000              ;Specially for AlCo
   4++4000              ;http://bulba.untergrund.net/ (http://bulba.at.kz/)
   5++4000              	MODULE VTPL
   6++4000              ;Release number
   7++4000              Release EQU "0"
   8++4000              ;Conditional assembly
   9++4000              ;1) Current position counters at (Vars1+0) and (Vars2+0)
  10++4000              CurPosCounter=0
  11++4000              ;2) Allow channels allocation bits at (START+10)
  12++4000              ACBBAC=0
  13++4000              ;3) Allow loop checking and disabling
  14++4000              LoopChecker=1
  15++4000              ;4) Insert official identificator
  16++4000              Id=0
  17++4000              ;5) Set IY for correct return to ZX Basic
  18++4000              Basic=1
  19++4000
  20++4000              ;Features
  21++4000              ;--------
  22++4000              ;-Can be compiled at any address (i.e. no need rounding ORG
  23++4000              ; address).
  24++4000              ;-Variables (VARS) can be located at any address (not only after
  25++4000              ; code block).
  26++4000              ;-INIT subprogram checks PT3-module version and rightly
  27++4000              ; generates both note and volume tables outside of code block
  28++4000              ; (in VARS).
  29++4000              ;-Two portamento (spc. command 3xxx) algorithms (depending of
  30++4000              ; PT3 module version).
  31++4000              ;-New 1.XX and 2.XX special command behaviour (only for PT v3.7
  32++4000              ; and higher).
  33++4000              ;-Any Tempo value are accepted (including Tempo=1 and Tempo=2).
  34++4000              ;-TS modes: 2xPT3, 2xPT2 and PT v3.7 TS standard.
  35++4000              ;-Fully compatible with Ay_Emul PT3 and PT2 players codes.
  36++4000              ;-See also notes at the end of this source code.
  37++4000
  38++4000              ;Limitations
  39++4000              ;-----------
  40++4000              ;-Can run in RAM only (self-modified code is used).
  41++4000              ;-PT2 position list must be end by #FF marker only.
  42++4000
  43++4000              ;Warning!!! PLAY subprogram can crash if no module are loaded
  44++4000              ;into RAM or INIT subprogram was not called before.
  45++4000
  46++4000              ;Call MUTE or INIT one more time to mute sound after stopping
  47++4000              ;playing
  48++4000
  49++4000              ;Test codes (commented)
  50++4000              ;	LD A,32 ;SinglePT3(TS if TSPT3.7),ABC,Looped
  51++4000              ;	LD (START+10),A
  52++4000              ;	LD HL,#8000 ;Mod1
  53++4000              ;	LD DE,#A000 ;Mod2 (optional)
  54++4000              ;	CALL START+3
  55++4000              ;	EI
  56++4000              ;_LP	HALT
  57++4000              ;	CALL START+5
  58++4000              ;	XOR A
  59++4000              ;	IN A,(#FE)
  60++4000              ;	CPL
  61++4000              ;	AND 15
  62++4000              ;	JR Z,_LP
  63++4000              ;	JR START+8
  64++4000
  65++4000              TonA	EQU 0
  66++4000              TonB	EQU 2
  67++4000              TonC	EQU 4
  68++4000              Noise	EQU 6
  69++4000              Mixer	EQU 7
  70++4000              AmplA	EQU 8
  71++4000              AmplB	EQU 9
  72++4000              AmplC	EQU 10
  73++4000              Env	EQU 11
  74++4000              EnvTp	EQU 13
  75++4000
  76++4000              ;Entry and other points
  77++4000              ;START initialize playing of modules at MDLADDR (single module)
  78++4000              ;START+3 initialization with module address in HL and DE (TS)
  79++4000              ;START+5 play one quark
  80++4000              ;START+8 mute
  81++4000              ;START+10 setup and status flags
  82++4000
  83++4000              START:
  84++4000 21 A3 4C     	LD HL,outputBuffer ;DE - address of 2nd module for TS
  85++4003 18 3C        	JR INIT
  86++4005 C3 64 48     	JP PLAY
  87++4008 18 25        	JR MUTE
  88++400A 00           SETUP	DB 0 ;set bit0, if you want to play without looping
  89++400B              	     ;(optional);
  90++400B              	     ;set bit1 for PT2 and reset for PT3 before
  91++400B              	     ;calling INIT;
  92++400B              	     ;bits2-3: %00-ABC, %01-ACB, %10-BAC (optional);
  93++400B              	     ;bits4-5: %00-no TS, %01-2 modules TS, %10-
  94++400B              	     ;autodetect PT3 TS-format by AlCo (PT 3.7+);
  95++400B              	     ;Remark: old PT3 TS-format by AlCo (PT 3.6) is not
  96++400B              	     ;documented and must be converted to new standard.
  97++400B              	     ;bit6 is set each time, when loop point of 2nd TS
  98++400B              	     ;module is passed (optional).
  99++400B              	     ;bit7 is set each time, when loop point of 1st TS
 100++400B              	     ;or of single module is passed (optional).
 101++400B
 102++400B              ;Identifier
 103++400B              	IF Id
 104++400B ~            	DB "=UniPT2/PT3/TS-Player r.",Release,"="
 105++400B              	ENDIF
 106++400B
 107++400B              	IF LoopChecker
 108++400B 21 0A 40     CHECKLP	LD HL,SETUP
 109++400E FD CB 9E 46  	BIT 0,(IY-100+VRS.ModNum)
 110++4012 28 04        	JR Z,CHL1
 111++4014 CB F6        	SET 6,(HL)
 112++4016 18 02        	JR CHL2
 113++4018 CB FE        CHL1	SET 7,(HL)
 114++401A CB 46        CHL2	BIT 0,(HL)
 115++401C C8           	RET Z
 116++401D E1           	POP HL
 117++401E FD 34 09     	INC (IY-100+VRS.DelyCnt)
 118++4021 FD 34 BA     	INC (IY-100+VRS.ChanA+CHP.NtSkCn)
 119++4024 AF           	XOR A
 120++4025 FD 77 1D     	LD (IY-100+VRS.AYREGS+AmplA),A
 121++4028 FD 77 1E     	LD (IY-100+VRS.AYREGS+AmplB),A
 122++402B FD 77 1F     	LD (IY-100+VRS.AYREGS+AmplC),A
 123++402E C9           	RET
 124++402F              	ENDIF
 125++402F
 126++402F AF           MUTE: XOR A
 127++4030 67           	LD H,A
 128++4031 6F           	LD L,A
 129++4032 32 B9 49     	LD (VARS1+VRS.AYREGS+AmplA),A
 130++4035 22 BA 49     	LD (VARS1+VRS.AYREGS+AmplB),HL
 131++4038 32 40 4A     	LD (VARS2+VRS.AYREGS+AmplA),A
 132++403B 22 41 4A     	LD (VARS2+VRS.AYREGS+AmplB),HL
 133++403E C3 7C 48     	JP ROUT
 134++4041
 135++4041              INIT:
 136++4041              ;HL - AddressOfModule
 137++4041              ;DE - AddresOf2ndModule
 138++4041 D5           	PUSH DE
 139++4042 E5           	PUSH HL
 140++4043 21 37 49     	LD HL,VARS
 141++4046 36 00        	LD (HL),0
 142++4048 11 38 49     	LD DE,VARS+1
 143++404B 01 0E 01     	LD BC,VAR0END-VARS-1
 144++404E ED B0        	LDIR
 145++4050 23           	INC HL
 146++4051 22 9A 49     	LD (VARS1+VRS.AdInPtA),HL ;ptr to zero
 147++4054 22 21 4A     	LD (VARS2+VRS.AdInPtA),HL
 148++4057
 149++4057 E1           	POP HL
 150++4058 FD 21 9C 49  	LD IY,VARS1+100
 151++405C 3A 0A 40     	LD A,(START+10)
 152++405F E6 02        	AND 2
 153++4061 C2 EA 40     	JP NZ,I_PT2
 154++4064
 155++4064 CD 37 42     	CALL INITPT3
 156++4067 21 18 1F     	LD HL,(e_-SamCnv-2)*256+#18
 157++406A 22 0A 46     	LD (SamCnv),HL
 158++406D 3E BA        	LD A,#BA
 159++406F 32 D5 45     	LD (OrnCP),A
 160++4072 32 01 46     	LD (SamCP),A
 161++4075 3E 7B        	LD A,#7B
 162++4077 32 D8 45     	LD (OrnLD),A
 163++407A 32 04 46     	LD (SamLD),A
 164++407D 3E 87        	LD A,#87
 165++407F 32 FB 45     	LD (SamClc2),A
 166++4082 E1           	POP HL
 167++4083              	;Use version and ton table of 1st module
 168++4083 DD 7E A9     	LD A,(IX+13-100) ;EXTRACT VERSION NUMBER
 169++4086 D6 30        	SUB #30
 170++4088 38 04        	JR C,L20
 171++408A FE 0A        	CP 10
 172++408C 38 02        	JR C,L21
 173++408E 3E 06        L20	LD A,6
 174++4090 32 A8 44     L21	LD (Version),A
 175++4093 F5           	PUSH AF ;VolTable version
 176++4094 FE 04        	CP 4
 177++4096 DD 7E FF     	LD A,(IX+99-100) ;TONE TABLE NUMBER
 178++4099 17           	RLA
 179++409A E6 07        	AND 7
 180++409C F5           	PUSH AF ;NoteTable number
 181++409D
 182++409D FD 21 23 4A  	LD IY,VARS2+100
 183++40A1 3A 0A 40     	LD A,(START+10)
 184++40A4 E6 30        	AND 48
 185++40A6 28 37        	JR Z,NOTS
 186++40A8 FE 10        	CP 16
 187++40AA 28 27        	JR Z,TwoPT3s
 188++40AC 3A A8 44     	LD A,(Version)
 189++40AF FE 07        	CP 7
 190++40B1 38 2C        	JR C,NOTS
 191++40B3 DD 7E FE     	LD A,(IX+98-100) ;ALCO TS MARKER
 192++40B6 FE 20        	CP #20
 193++40B8 28 25        	JR Z,NOTS
 194++40BA 21 38 49     	LD HL,VARS1
 195++40BD 11 BF 49     	LD DE,VARS2
 196++40C0 01 87 00     	LD BC,VRS
 197++40C3 ED B0        	LDIR
 198++40C5 FD CB 9E CE  	SET 1,(IY-100+VRS.ModNum)
 199++40C9 4F           	LD C,A
 200++40CA 87           	ADD A,A
 201++40CB 81           	ADD A,C
 202++40CC D6 02        	SUB 2
 203++40CE 32 6F 47     	LD (TSSub),A
 204++40D1 18 03        	JR AlCoTS_
 205++40D3 CD 37 42     TwoPT3s	CALL INITPT3
 206++40D6 3E 01        AlCoTS_	LD A,1
 207++40D8 32 37 49     	LD (is_ts),A
 208++40DB FD CB 9E C6  	SET 0,(IY-100+VRS.ModNum)
 209++40DF
 210++40DF 01 F4 43     NOTS	LD BC,PT3PD
 211++40E2 21 00 00     	LD HL,0
 212++40E5 11 FF 48     	LD DE,PT3EMPTYORN
 213++40E8 18 48        	JR INITCOMMON
 214++40EA
 215++40EA CD 6F 42     I_PT2	CALL INITPT2
 216++40ED 21 CB 51     	LD HL,#51CB
 217++40F0 22 0A 46     	LD (SamCnv),HL
 218++40F3 3E BB        	LD A,#BB
 219++40F5 32 D5 45     	LD (OrnCP),A
 220++40F8 32 01 46     	LD (SamCP),A
 221++40FB 3E 7A        	LD A,#7A
 222++40FD 32 D8 45     	LD (OrnLD),A
 223++4100 32 04 46     	LD (SamLD),A
 224++4103 3E 80        	LD A,#80
 225++4105 32 FB 45     	LD (SamClc2),A
 226++4108 E1           	POP HL
 227++4109 3E 05        	LD A,5
 228++410B 32 A8 44     	LD (Version),A
 229++410E F5           	PUSH AF
 230++410F 3E 02        	LD A,2
 231++4111 F5           	PUSH AF
 232++4112
 233++4112 3A 0A 40     	LD A,(START+10)
 234++4115 E6 30        	AND 48
 235++4117 28 10        	JR Z,NOTS2
 236++4119
 237++4119 FD 21 23 4A  	LD IY,VARS2+100
 238++411D 3E 01        	LD A,1
 239++411F 32 37 49     	LD (is_ts),A
 240++4122 FD CB 9E C6  	SET 0,(IY-100+VRS.ModNum)
 241++4126 CD 6F 42     	CALL INITPT2
 242++4129
 243++4129 01 2E 43     NOTS2	LD BC,PT2PD
 244++412C 21 87 86     	LD HL,#8687
 245++412F 11 55 4A     	LD DE,PT2EMPTYORN
 246++4132
 247++4132              INITCOMMON
 248++4132
 249++4132              	IF Basic
 250++4132 FD 21 3A 5C  	LD IY,#5C3A
 251++4136              	ENDIF
 252++4136
 253++4136 ED 43 DF 42  	LD (PTDEC),BC
 254++413A 22 71 47     	LD (PsCalc),HL
 255++413D D5           	PUSH DE
 256++413E
 257++413E              ;note table data depacker
 258++413E              ;(c) Ivan Roshin
 259++413E 11 02 49     	LD DE,T_PACK
 260++4141 01 A7 4A     	LD BC,T1_+(2*49)-1
 261++4144 1A           TP_0	LD A,(DE)
 262++4145 13           	INC DE
 263++4146 FE 1E        	CP 15*2
 264++4148 30 06        	JR NC,TP_1
 265++414A 67           	LD H,A
 266++414B 1A           	LD A,(DE)
 267++414C 6F           	LD L,A
 268++414D 13           	INC DE
 269++414E 18 07        	JR TP_2
 270++4150 D5           TP_1	PUSH DE
 271++4151 16 00        	LD D,0
 272++4153 5F           	LD E,A
 273++4154 19           	ADD HL,DE
 274++4155 19           	ADD HL,DE
 275++4156 D1           	POP DE
 276++4157 7C           TP_2	LD A,H
 277++4158 02           	LD (BC),A
 278++4159 0B           	DEC BC
 279++415A 7D           	LD A,L
 280++415B 02           	LD (BC),A
 281++415C 0B           	DEC BC
player.asm(282): warning: value 0x1F0 is truncated to 8bit value: 0xF0
 282++415D D6 F0        	SUB #F8*2
 283++415F 20 E3        	JR NZ,TP_0
 284++4161
 285++4161 3C           	INC A
 286++4162 32 A5 49     	LD (VARS1+VRS.DelyCnt),A
 287++4165 32 2C 4A     	LD (VARS2+VRS.DelyCnt),A
 288++4168 21 01 F0     	LD HL,#F001 ;H - CHP.Volume, L - CHP.NtSkCn
 289++416B 22 56 49     	LD (VARS1+VRS.ChanA+CHP.NtSkCn),HL
 290++416E 22 73 49     	LD (VARS1+VRS.ChanB+CHP.NtSkCn),HL
 291++4171 22 90 49     	LD (VARS1+VRS.ChanC+CHP.NtSkCn),HL
 292++4174 22 DD 49     	LD (VARS2+VRS.ChanA+CHP.NtSkCn),HL
 293++4177 22 FA 49     	LD (VARS2+VRS.ChanB+CHP.NtSkCn),HL
 294++417A 22 17 4A     	LD (VARS2+VRS.ChanC+CHP.NtSkCn),HL
 295++417D E1           	POP HL
 296++417E 22 48 49     	LD (VARS1+VRS.ChanA+CHP.OrnPtr),HL
 297++4181 22 65 49     	LD (VARS1+VRS.ChanB+CHP.OrnPtr),HL
 298++4184 22 82 49     	LD (VARS1+VRS.ChanC+CHP.OrnPtr),HL
 299++4187 22 CF 49     	LD (VARS2+VRS.ChanA+CHP.OrnPtr),HL
 300++418A 22 EC 49     	LD (VARS2+VRS.ChanB+CHP.OrnPtr),HL
 301++418D 22 09 4A     	LD (VARS2+VRS.ChanC+CHP.OrnPtr),HL
 302++4190
 303++4190 F1           	POP AF
 304++4191
 305++4191              ;NoteTableCreator (c) Ivan Roshin
 306++4191              ;A - NoteTableNumber*2+VersionForNoteTable
 307++4191              ;(xx1b - 3.xx..3.4r, xx0b - 3.4x..3.6x..VTII1.0)
 308++4191
 309++4191 21 AF 48     	LD HL,NT_DATA
 310++4194 16 00        	LD D,0
 311++4196 87           	ADD A,A
 312++4197 5F           	LD E,A
 313++4198 19           	ADD HL,DE
 314++4199 5E           	LD E,(HL)
 315++419A 23           	INC HL
 316++419B CB 3B        	SRL E
 317++419D 9F           	SBC A,A
 318++419E E6 A7        	AND #A7 ;#00 (NOP) or #A7 (AND A)
 319++41A0 32 C8 41     	LD (L3),A
 320++41A3 EB           	EX DE,HL
 321++41A4 01 46 4A     	LD BC,T1_
 322++41A7 09           	ADD HL,BC
 323++41A8
 324++41A8 1A           	LD A,(DE)
player.asm(325): warning: value 0x48BF is truncated to 8bit value: 0xBF
 325++41A9 C6 BF        	ADD A,T_
 326++41AB 4F           	LD C,A
 327++41AC CE 48        	ADC A,T_/256
 328++41AE 91           	SUB C
 329++41AF 47           	LD B,A
 330++41B0 C5           	PUSH BC
 331++41B1 11 36 4B     	LD DE,NT_
 332++41B4 D5           	PUSH DE
 333++41B5
 334++41B5 06 0C        	LD B,12
 335++41B7 C5           L1	PUSH BC
 336++41B8 4E           	LD C,(HL)
 337++41B9 23           	INC HL
 338++41BA E5           	PUSH HL
 339++41BB 46           	LD B,(HL)
 340++41BC
 341++41BC D5           	PUSH DE
 342++41BD EB           	EX DE,HL
 343++41BE 11 17 00     	LD DE,23
 344++41C1 DD 26 08     	LD IXH,8
 345++41C4
 346++41C4 CB 38        L2	SRL B
 347++41C6 CB 19        	RR C
 348++41C8 19           L3	DB #19	;AND A or NOP
 349++41C9 79           	LD A,C
 350++41CA 8A           	ADC A,D	;=ADC 0
 351++41CB 77           	LD (HL),A
 352++41CC 23           	INC HL
 353++41CD 78           	LD A,B
 354++41CE 8A           	ADC A,D
 355++41CF 77           	LD (HL),A
 356++41D0 19           	ADD HL,DE
 357++41D1 DD 25        	DEC IXH
 358++41D3 20 EF        	JR NZ,L2
 359++41D5
 360++41D5 D1           	POP DE
 361++41D6 13           	INC DE
 362++41D7 13           	INC DE
 363++41D8 E1           	POP HL
 364++41D9 23           	INC HL
 365++41DA C1           	POP BC
 366++41DB 10 DA        	DJNZ L1
 367++41DD
 368++41DD E1           	POP HL
 369++41DE D1           	POP DE
 370++41DF
 371++41DF 7B           	LD A,E
player.asm(372): warning: value 0x48CB is truncated to 8bit value: 0xCB
 372++41E0 FE CB        	CP TCOLD_1
 373++41E2 20 05        	JR NZ,CORR_1
 374++41E4 3E FD        	LD A,#FD
 375++41E6 32 64 4B     	LD (NT_+#2E),A
 376++41E9
 377++41E9 1A           CORR_1	LD A,(DE)
 378++41EA A7           	AND A
 379++41EB 28 11        	JR Z,TC_EXIT
 380++41ED 1F           	RRA
 381++41EE F5           	PUSH AF
 382++41EF 87           	ADD A,A
 383++41F0 4F           	LD C,A
 384++41F1 09           	ADD HL,BC
 385++41F2 F1           	POP AF
 386++41F3 30 02        	JR NC,CORR_2
 387++41F5 35           	DEC (HL)
 388++41F6 35           	DEC (HL)
 389++41F7 34           CORR_2	INC (HL)
 390++41F8 A7           	AND A
 391++41F9 ED 42        	SBC HL,BC
 392++41FB 13           	INC DE
 393++41FC 18 EB        	JR CORR_1
 394++41FE
 395++41FE              TC_EXIT
 396++41FE
 397++41FE F1           	POP AF
 398++41FF
 399++41FF              ;VolTableCreator (c) Ivan Roshin
 400++41FF              ;A - VersionForVolumeTable (0..4 - 3.xx..3.4x;
 401++41FF              			   ;5.. - 2.x,3.5x..3.6x..VTII1.0)
 402++41FF
 403++41FF FE 05        	CP 5
 404++4201 21 11 00     	LD HL,#11
 405++4204 54           	LD D,H
 406++4205 5C           	LD E,H
 407++4206 3E 17        	LD A,#17
 408++4208 30 03        	JR NC,M1
 409++420A 2D           	DEC L
 410++420B 5D           	LD E,L
 411++420C AF           	XOR A
 412++420D 32 1E 42     M1      LD (M2),A
 413++4210
 414++4210 DD 21 46 4A  	LD IX,VT_+16
 415++4214
 416++4214 0E 0F        	LD C,#F
 417++4216 E5           INITV2  PUSH HL
 418++4217
 419++4217 19           	ADD HL,DE
 420++4218 EB           	EX DE,HL
 421++4219 ED 62        	SBC HL,HL
 422++421B
 423++421B 06 10        	LD B,#10
 424++421D 7D           INITV1  LD A,L
 425++421E 7D           M2      DB #7D
 426++421F 7C           	LD A,H
 427++4220 CE 00        	ADC A,0
 428++4222 DD 77 00     	LD (IX),A
 429++4225 DD 23        	INC IX
 430++4227 19           	ADD HL,DE
 431++4228 10 F3        	DJNZ INITV1
 432++422A
 433++422A E1           	POP HL
 434++422B 7B           	LD A,E
 435++422C FE 77        	CP #77
 436++422E 20 01        	JR NZ,M3
 437++4230 1C           	INC E
 438++4231 0D           M3      DEC C
 439++4232 20 E2        	JR NZ,INITV2
 440++4234
 441++4234 C3 7C 48     	JP ROUT
 442++4237
 443++4237 CD AA 42     INITPT3	CALL SETMDAD
 444++423A E5           	PUSH HL
 445++423B 11 64 00     	LD DE,100
 446++423E 19           	ADD HL,DE
 447++423F 7E           	LD A,(HL)
 448++4240 FD 77 08     	LD (IY-100+VRS.Delay),A
 449++4243 E5           	PUSH HL
 450++4244 DD E1        	POP IX
 451++4246 19           	ADD HL,DE
 452++4247 CD B8 42     	CALL SETCPPT
 453++424A DD 5E 02     	LD E,(IX+102-100)
 454++424D 23           	INC HL
 455++424E
 456++424E              	IF CurPosCounter
 457++424E ~            	LD (IY-100+VRS.PosSub),L
 458++424E              	ENDIF
 459++424E
 460++424E 19           	ADD HL,DE
 461++424F CD BF 42     	CALL SETLPPT
 462++4252 D1           	POP DE
 463++4253 DD 6E 03     	LD L,(IX+103-100)
 464++4256 DD 66 04     	LD H,(IX+104-100)
 465++4259 19           	ADD HL,DE
 466++425A CD A3 42     	CALL SETPTPT
 467++425D 21 A9 00     	LD HL,169
 468++4260 19           	ADD HL,DE
 469++4261 CD B1 42     	CALL SETORPT
 470++4264 21 69 00     	LD HL,105
 471++4267 19           	ADD HL,DE
 472++4268
 473++4268 FD 75 FA     SETSMPT LD (IY-100+VRS.SamPtrs),L
 474++426B FD 74 FB     	LD (IY-100+VRS.SamPtrs+1),H
 475++426E C9           	RET
 476++426F
 477++426F 7E           INITPT2	LD A,(HL)
 478++4270 FD 77 08     	LD (IY-100+VRS.Delay),A
 479++4273 E5           	PUSH HL
 480++4274 E5           	PUSH HL
 481++4275 E5           	PUSH HL
 482++4276 23           	INC HL
 483++4277 23           	INC HL
 484++4278 7E           	LD A,(HL)
 485++4279 23           	INC HL
 486++427A CD 68 42     	CALL SETSMPT
 487++427D 5E           	LD E,(HL)
 488++427E 23           	INC HL
 489++427F 56           	LD D,(HL)
 490++4280 E1           	POP HL
 491++4281 A7           	AND A
 492++4282 ED 52        	SBC HL,DE
 493++4284 CD AA 42     	CALL SETMDAD
 494++4287 E1           	POP HL
 495++4288 11 43 00     	LD DE,67
 496++428B 19           	ADD HL,DE
 497++428C CD B1 42     	CALL SETORPT
 498++428F 1E 20        	LD E,32
 499++4291 19           	ADD HL,DE
 500++4292 4E           	LD C,(HL)
 501++4293 23           	INC HL
 502++4294 46           	LD B,(HL)
 503++4295 1E 1E        	LD E,30
 504++4297 19           	ADD HL,DE
 505++4298 CD B8 42     	CALL SETCPPT
 506++429B 5F           	LD E,A
 507++429C 23           	INC HL
 508++429D
 509++429D              	IF CurPosCounter
 510++429D ~            	LD (IY-100+VRS.PosSub),L
 511++429D              	ENDIF
 512++429D
 513++429D 19           	ADD HL,DE
 514++429E CD BF 42     	CALL SETLPPT
 515++42A1 E1           	POP HL
 516++42A2 09           	ADD HL,BC
 517++42A3
 518++42A3 FD 75 FC     SETPTPT	LD (IY-100+VRS.PatsPtr),L
 519++42A6 FD 74 FD     	LD (IY-100+VRS.PatsPtr+1),H
 520++42A9 C9           	RET
 521++42AA
 522++42AA FD 75 F6     SETMDAD	LD (IY-100+VRS.MODADDR),L
 523++42AD FD 74 F7     	LD (IY-100+VRS.MODADDR+1),H
 524++42B0 C9           	RET
 525++42B1
 526++42B1 FD 75 F8     SETORPT	LD (IY-100+VRS.OrnPtrs),L
 527++42B4 FD 74 F9     	LD (IY-100+VRS.OrnPtrs+1),H
 528++42B7 C9           	RET
 529++42B8
 530++42B8 FD 75 04     SETCPPT	LD (IY-100+VRS.CrPsPtr),L
 531++42BB FD 74 05     	LD (IY-100+VRS.CrPsPtr+1),H
 532++42BE C9           	RET
 533++42BF
 534++42BF FD 75 06     SETLPPT	LD (IY-100+VRS.LPosPtr),L
 535++42C2 FD 74 07     	LD (IY-100+VRS.LPosPtr+1),H
 536++42C5 C9           	RET
 537++42C6
 538++42C6 FD 75 13     SETENBS	LD (IY-100+VRS.EnvBase),L
 539++42C9 FD 74 14     	LD (IY-100+VRS.EnvBase+1),H
 540++42CC C9           	RET
 541++42CD
 542++42CD FD 75 0C     SETESLD	LD (IY-100+VRS.CurESld),L
 543++42D0 FD 74 0D     	LD (IY-100+VRS.CurESld+1),H
 544++42D3 C9           	RET
 545++42D4
 546++42D4 FD E5        GETIX	PUSH IY
 547++42D6 DD E1        	POP IX
 548++42D8 DD 19        	ADD IX,DE
 549++42DA C9           	RET
 550++42DB
 551++42DB CD D4 42     PTDECOD CALL GETIX
 552++42DE              PTDEC	EQU $+1
 553++42DE C3 C3 C3     	JP #C3C3
 554++42E1
 555++42E1              ;PT2 pattern decoder
 556++42E1 CD 77 45     PD2_SAM	CALL SETSAM
 557++42E4 18 4A        	JR PD2_LOOP
 558++42E6
 559++42E6 DD 77 08     PD2_EOff LD (IX-12+CHP.Env_En),A
 560++42E9 18 45        	JR PD2_LOOP
 561++42EB
 562++42EB DD 36 08 10  PD2_ENV	LD (IX-12+CHP.Env_En),16
 563++42EF FD 77 22     	LD (IY-100+VRS.AYREGS+EnvTp),A
 564++42F2 0A           	LD A,(BC)
 565++42F3 03           	INC BC
 566++42F4 6F           	LD L,A
 567++42F5 0A           	LD A,(BC)
 568++42F6 03           	INC BC
 569++42F7 67           	LD H,A
 570++42F8 CD C6 42     	CALL SETENBS
 571++42FB 18 33        	JR PD2_LOOP
 572++42FD
 573++42FD CD 58 45     PD2_ORN	CALL SETORN
 574++4300 18 2E        	JR PD2_LOOP
 575++4302
 576++4302 3C           PD2_SKIP INC A
 577++4303 DD 77 05     	LD (IX-12+CHP.NNtSkp),A
 578++4306 18 28        	JR PD2_LOOP
 579++4308
 580++4308 0F           PD2_VOL	RRCA
 581++4309 0F           	RRCA
 582++430A 0F           	RRCA
 583++430B 0F           	RRCA
 584++430C DD 77 10     	LD (IX-12+CHP.Volume),A
 585++430F 18 1F        	JR PD2_LOOP
 586++4311
 587++4311 CD 28 45     PD2_DEL	CALL C_DELAY
 588++4314 18 1A        	JR PD2_LOOP
 589++4316
 590++4316 DD CB 09 D6  PD2_GLIS SET 2,(IX-12+CHP.Flags)
 591++431A 3C           	INC A
 592++431B DD 77 0A     	LD (IX-12+CHP.TnSlDl),A
 593++431E DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 594++4321 0A           	LD A,(BC)
 595++4322 03           	INC BC
 596++4323 DD 77 0B             LD (IX-12+CHP.TSlStp),A
 597++4326 87           	ADD A,A
 598++4327 9F           	SBC A,A
 599++4328 DD 77 0C             LD (IX-12+CHP.TSlStp+1),A
 600++432B 37           	SCF
 601++432C 18 01        	JR PD2_LP2
 602++432E
 603++432E A7           PT2PD	AND A
 604++432F
 605++432F 08           PD2_LP2	EX AF,AF'
 606++4330
 607++4330 0A           PD2_LOOP LD A,(BC)
 608++4331 03           	INC BC
 609++4332 C6 20        	ADD A,#20
 610++4334 28 3F        	JR Z,PD2_REL
 611++4336 38 A9        	JR C,PD2_SAM
 612++4338 C6 60        	ADD A,96
 613++433A 38 3E        	JR C,PD2_NOTE
 614++433C 3C           	INC A
 615++433D 28 A7        	JR Z,PD2_EOff
 616++433F C6 0F        	ADD A,15
 617++4341 CA 57 44     	JP Z,PD_FIN
 618++4344 38 A5        	JR C,PD2_ENV
 619++4346 C6 10        	ADD A,#10
 620++4348 38 B3        	JR C,PD2_ORN
 621++434A C6 40        	ADD A,#40
 622++434C 38 B4        	JR C,PD2_SKIP
 623++434E C6 10        	ADD A,#10
 624++4350 38 B6        	JR C,PD2_VOL
 625++4352 3C           	INC A
 626++4353 28 BC        	JR Z,PD2_DEL
 627++4355 3C           	INC A
 628++4356 28 BE        	JR Z,PD2_GLIS
 629++4358 3C           	INC A
 630++4359 28 0A        	JR Z,PD2_PORT
 631++435B 3C           	INC A
 632++435C 28 12        	JR Z,PD2_STOP
 633++435E 0A           	LD A,(BC)
 634++435F 03           	INC BC
 635++4360 DD 77 F7     	LD (IX-12+CHP.CrNsSl),A
 636++4363 18 CB        	JR PD2_LOOP
 637++4365
 638++4365 DD CB 09 96  PD2_PORT RES 2,(IX-12+CHP.Flags)
 639++4369 0A           	LD A,(BC)
 640++436A 03           	INC BC
 641++436B 03           	INC BC ;ignoring precalc delta to right sound
 642++436C 03           	INC BC
 643++436D 37           	SCF
 644++436E 18 BF        	JR PD2_LP2
 645++4370
 646++4370 DD 77 F9     PD2_STOP LD (IX-12+CHP.TSlCnt),A
 647++4373 18 BB        	JR PD2_LOOP
 648++4375
 649++4375 DD 77 09     PD2_REL	LD (IX-12+CHP.Flags),A
 650++4378 18 2C        	JR PD2_EXIT
 651++437A
 652++437A 6F           PD2_NOTE LD L,A
 653++437B DD 7E 06     	LD A,(IX-12+CHP.Note)
 654++437E 32 91 44     	LD (PrNote+1),A
 655++4381 DD 75 06     	LD (IX-12+CHP.Note),L
 656++4384 AF           	XOR A
 657++4385 DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 658++4388 DD CB 09 C6  	SET 0,(IX-12+CHP.Flags)
 659++438C 08           	EX AF,AF'
 660++438D 30 16        	JR NC,NOGLIS2
 661++438F DD CB 09 56  	BIT 2,(IX-12+CHP.Flags)
 662++4393 20 0C        	JR NZ,NOPORT2
 663++4395 32 B7 44     	LD (LoStep),A
 664++4398 87           	ADD A,A
 665++4399 9F           	SBC A,A
 666++439A 08           	EX AF,AF'
 667++439B 67           	LD H,A
 668++439C 6F           	LD L,A
 669++439D 3C           	INC A
 670++439E CD 72 44     	CALL SETPORT
 671++43A1 DD 36 F9 01  NOPORT2	LD (IX-12+CHP.TSlCnt),1
 672++43A5 AF           NOGLIS2	XOR A
 673++43A6
 674++43A6
 675++43A6 DD 77 F5     PD2_EXIT LD (IX-12+CHP.PsInSm),A
 676++43A9 DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 677++43AC DD 77 FA     	LD (IX-12+CHP.CrTnSl),A
 678++43AF DD 77 FB     	LD (IX-12+CHP.CrTnSl+1),A
 679++43B2 C3 57 44     	JP PD_FIN
 680++43B5
 681++43B5              ;PT3 pattern decoder
 682++43B5 DD 36 08 00  PD_OrSm	LD (IX-12+CHP.Env_En),0
 683++43B9 CD 58 45     	CALL SETORN
 684++43BC 0A           PD_SAM_	LD A,(BC)
 685++43BD 03           	INC BC
 686++43BE 0F           	RRCA
 687++43BF
 688++43BF CD 77 45     PD_SAM	CALL SETSAM
 689++43C2 18 3F        	JR PD_LOOP
 690++43C4
 691++43C4 0F           PD_VOL	RRCA
 692++43C5 0F           	RRCA
 693++43C6 0F           	RRCA
 694++43C7 0F           	RRCA
 695++43C8 DD 77 10     	LD (IX-12+CHP.Volume),A
 696++43CB 18 39        	JR PD_LP2
 697++43CD
 698++43CD DD 77 08     PD_EOff	LD (IX-12+CHP.Env_En),A
 699++43D0 DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 700++43D3 18 31        	JR PD_LP2
 701++43D5
 702++43D5 3D           PD_SorE	DEC A
 703++43D6 20 07        	JR NZ,PD_ENV
 704++43D8 0A           	LD A,(BC)
 705++43D9 03           	INC BC
 706++43DA DD 77 05     	LD (IX-12+CHP.NNtSkp),A
 707++43DD 18 27        	JR PD_LP2
 708++43DF
 709++43DF CD 3D 45     PD_ENV	CALL SETENV
 710++43E2 18 22        	JR PD_LP2
 711++43E4
 712++43E4 CD 58 45     PD_ORN	CALL SETORN
 713++43E7 18 1A        	JR PD_LOOP
 714++43E9
 715++43E9 DD 77 08     PD_ESAM	LD (IX-12+CHP.Env_En),A
 716++43EC DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 717++43EF C4 3D 45     	CALL NZ,SETENV
 718++43F2 18 C8        	JR PD_SAM_
 719++43F4
 720++43F4 DD 7E 06     PT3PD	LD A,(IX-12+CHP.Note)
 721++43F7 32 91 44     	LD (PrNote+1),A
 722++43FA DD 6E FA     	LD L,(IX-12+CHP.CrTnSl)
 723++43FD DD 66 FB     	LD H,(IX-12+CHP.CrTnSl+1)
 724++4400 22 AE 44     	LD (PrSlide+1),HL
 725++4403
 726++4403 11 10 20     PD_LOOP	LD DE,#2010
 727++4406 0A           PD_LP2	LD A,(BC)
 728++4407 03           	INC BC
 729++4408 83           	ADD A,E
 730++4409 38 AA        	JR C,PD_OrSm
 731++440B 82           	ADD A,D
 732++440C 28 49        	JR Z,PD_FIN
 733++440E 38 AF        	JR C,PD_SAM
 734++4410 83           	ADD A,E
 735++4411 28 25        	JR Z,PD_REL
 736++4413 38 AF        	JR C,PD_VOL
 737++4415 83           	ADD A,E
 738++4416 28 B5        	JR Z,PD_EOff
 739++4418 38 BB        	JR C,PD_SorE
 740++441A C6 60        	ADD A,96
 741++441C 38 20        	JR C,PD_NOTE
 742++441E 83           	ADD A,E
 743++441F 38 C3        	JR C,PD_ORN
 744++4421 82           	ADD A,D
 745++4422 38 0F        	JR C,PD_NOIS
 746++4424 83           	ADD A,E
 747++4425 38 C2        	JR C,PD_ESAM
 748++4427 87           	ADD A,A
 749++4428 5F           	LD E,A
player.asm(750): warning: value 0x124B3 is truncated to 16bit value: 0x24B3
 750++4429 21 B3 24     	LD HL,SPCCOMS+#FF20-#2000
 751++442C 19           	ADD HL,DE
 752++442D 5E           	LD E,(HL)
 753++442E 23           	INC HL
 754++442F 56           	LD D,(HL)
 755++4430 D5           	PUSH DE
 756++4431 18 D0        	JR PD_LOOP
 757++4433
 758++4433 FD 77 10     PD_NOIS	LD (IY-100+VRS.Ns_Base),A
 759++4436 18 CE        	JR PD_LP2
 760++4438
 761++4438 DD CB 09 86  PD_REL	RES 0,(IX-12+CHP.Flags)
 762++443C 18 08        	JR PD_RES
 763++443E
 764++443E DD 77 06     PD_NOTE	LD (IX-12+CHP.Note),A
 765++4441 DD CB 09 C6  	SET 0,(IX-12+CHP.Flags)
 766++4445 AF           	XOR A
 767++4446
 768++4446 ED 73 55 44  PD_RES	LD (PDSP_+1),SP
 769++444A DD F9        	LD SP,IX
 770++444C 67           	LD H,A
 771++444D 6F           	LD L,A
 772++444E E5           	PUSH HL
 773++444F E5           	PUSH HL
 774++4450 E5           	PUSH HL
 775++4451 E5           	PUSH HL
 776++4452 E5           	PUSH HL
 777++4453 E5           	PUSH HL
 778++4454 31 31 31     PDSP_	LD SP,#3131
 779++4457
 780++4457 DD 7E 05     PD_FIN	LD A,(IX-12+CHP.NNtSkp)
 781++445A DD 77 0F     	LD (IX-12+CHP.NtSkCn),A
 782++445D C9           	RET
 783++445E
 784++445E 0A           C_PORTM LD A,(BC)
 785++445F 03           	INC BC
 786++4460              ;SKIP PRECALCULATED TONE DELTA (BECAUSE
 787++4460              ;CANNOT BE RIGHT AFTER PT3 COMPILATION)
 788++4460 03           	INC BC
 789++4461 03           	INC BC
 790++4462 08           	EX AF,AF'
 791++4463 0A           	LD A,(BC) ;SIGNED TONE STEP
 792++4464 03           	INC BC
 793++4465 32 B7 44     	LD (LoStep),A
 794++4468 0A           	LD A,(BC)
 795++4469 03           	INC BC
 796++446A A7           	AND A
 797++446B 08           	EX AF,AF'
 798++446C DD 6E FA     	LD L,(IX-12+CHP.CrTnSl)
 799++446F DD 66 FB     	LD H,(IX-12+CHP.CrTnSl+1)
 800++4472
 801++4472              ;Set portamento variables
 802++4472              ;A - Delay; A' - Hi(Step); ZF' - (A'=0); HL - CrTnSl
 803++4472
 804++4472 DD CB 09 96  SETPORT	RES 2,(IX-12+CHP.Flags)
 805++4476 DD 77 0A     	LD (IX-12+CHP.TnSlDl),A
 806++4479 DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 807++447C E5           	PUSH HL
 808++447D 11 36 4B     	LD DE,NT_
 809++4480 DD 7E 06     	LD A,(IX-12+CHP.Note)
 810++4483 DD 77 07     	LD (IX-12+CHP.SlToNt),A
 811++4486 87           	ADD A,A
 812++4487 6F           	LD L,A
 813++4488 26 00        	LD H,0
 814++448A 19           	ADD HL,DE
 815++448B 7E           	LD A,(HL)
 816++448C 23           	INC HL
 817++448D 66           	LD H,(HL)
 818++448E 6F           	LD L,A
 819++448F E5           	PUSH HL
 820++4490 3E 3E        PrNote	LD A,#3E
 821++4492 DD 77 06     	LD (IX-12+CHP.Note),A
 822++4495 87           	ADD A,A
 823++4496 6F           	LD L,A
 824++4497 26 00        	LD H,0
 825++4499 19           	ADD HL,DE
 826++449A 5E           	LD E,(HL)
 827++449B 23           	INC HL
 828++449C 56           	LD D,(HL)
 829++449D E1           	POP HL
 830++449E ED 52        	SBC HL,DE
 831++44A0 DD 75 0D     	LD (IX-12+CHP.TnDelt),L
 832++44A3 DD 74 0E     	LD (IX-12+CHP.TnDelt+1),H
 833++44A6 D1           	POP DE
 834++44A7              Version EQU $+1
 835++44A7 3E 3E        	LD A,#3E
 836++44A9 FE 06        	CP 6
 837++44AB 38 09        	JR C,OLDPRTM ;Old 3xxx for PT v3.5-
 838++44AD 11 11 11     PrSlide	LD DE,#1111
 839++44B0 DD 73 FA     	LD (IX-12+CHP.CrTnSl),E
 840++44B3 DD 72 FB     	LD (IX-12+CHP.CrTnSl+1),D
 841++44B6              LoStep	EQU $+1
 842++44B6 3E 3E        OLDPRTM	LD A,#3E
 843++44B8 08           	EX AF,AF'
 844++44B9 28 01        	JR Z,NOSIG
 845++44BB EB           	EX DE,HL
 846++44BC ED 52        NOSIG	SBC HL,DE
 847++44BE F2 C6 44     	JP P,SET_STP
 848++44C1 2F           	CPL
 849++44C2 08           	EX AF,AF'
 850++44C3 ED 44        	NEG
 851++44C5 08           	EX AF,AF'
 852++44C6 DD 77 0C     SET_STP	LD (IX-12+CHP.TSlStp+1),A
 853++44C9 08           	EX AF,AF'
 854++44CA DD 77 0B     	LD (IX-12+CHP.TSlStp),A
 855++44CD DD 36 FE 00  	LD (IX-12+CHP.COnOff),0
 856++44D1 C9           	RET
 857++44D2
 858++44D2 DD CB 09 D6  C_GLISS	SET 2,(IX-12+CHP.Flags)
 859++44D6 0A           	LD A,(BC)
 860++44D7 03           	INC BC
 861++44D8 DD 77 0A     	LD (IX-12+CHP.TnSlDl),A
 862++44DB A7           	AND A
 863++44DC 20 07        	JR NZ,GL36
 864++44DE 3A A8 44     	LD A,(Version) ;AlCo PT3.7+
 865++44E1 FE 07        	CP 7
 866++44E3 9F           	SBC A,A
 867++44E4 3C           	INC A
 868++44E5 DD 77 F9     GL36	LD (IX-12+CHP.TSlCnt),A
 869++44E8 0A           	LD A,(BC)
 870++44E9 03           	INC BC
 871++44EA 08           	EX AF,AF'
 872++44EB 0A           	LD A,(BC)
 873++44EC 03           	INC BC
 874++44ED 18 D7        	JR SET_STP
 875++44EF
 876++44EF 0A           C_SMPOS	LD A,(BC)
 877++44F0 03           	INC BC
 878++44F1 DD 77 F5     	LD (IX-12+CHP.PsInSm),A
 879++44F4 C9           	RET
 880++44F5
 881++44F5 0A           C_ORPOS	LD A,(BC)
 882++44F6 03           	INC BC
 883++44F7 DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 884++44FA C9           	RET
 885++44FB
 886++44FB 0A           C_VIBRT	LD A,(BC)
 887++44FC 03           	INC BC
 888++44FD DD 77 FF     	LD (IX-12+CHP.OnOffD),A
 889++4500 DD 77 FE     	LD (IX-12+CHP.COnOff),A
 890++4503 0A           	LD A,(BC)
 891++4504 03           	INC BC
 892++4505 DD 77 00     	LD (IX-12+CHP.OffOnD),A
 893++4508 AF           	XOR A
 894++4509 DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 895++450C DD 77 FA     	LD (IX-12+CHP.CrTnSl),A
 896++450F DD 77 FB     	LD (IX-12+CHP.CrTnSl+1),A
 897++4512 C9           	RET
 898++4513
 899++4513 0A           C_ENGLS	LD A,(BC)
 900++4514 03           	INC BC
 901++4515 FD 77 0E     	LD (IY-100+VRS.Env_Del),A
 902++4518 FD 77 0F     	LD (IY-100+VRS.CurEDel),A
 903++451B 0A           	LD A,(BC)
 904++451C 03           	INC BC
 905++451D 6F           	LD L,A
 906++451E 0A           	LD A,(BC)
 907++451F 03           	INC BC
 908++4520 67           	LD H,A
 909++4521 FD 75 0A     	LD (IY-100+VRS.ESldAdd),L
 910++4524 FD 74 0B     	LD (IY-100+VRS.ESldAdd+1),H
 911++4527 C9           	RET
 912++4528
 913++4528 0A           C_DELAY	LD A,(BC)
 914++4529 03           	INC BC
 915++452A FD 77 08     	LD (IY-100+VRS.Delay),A
 916++452D 21 C1 49     	LD HL,VARS2+VRS.ModNum ;if AlCo_TS
 917++4530 CB 4E        	BIT 1,(HL)
 918++4532 C8           	RET Z
 919++4533 32 A4 49     	LD (VARS1+VRS.Delay),A
 920++4536 32 A5 49     	LD (VARS1+VRS.DelyCnt),A
 921++4539 32 2B 4A     	LD (VARS2+VRS.Delay),A
 922++453C C9           	RET
 923++453D
 924++453D DD 73 08     SETENV	LD (IX-12+CHP.Env_En),E
 925++4540 FD 77 22     	LD (IY-100+VRS.AYREGS+EnvTp),A
 926++4543 0A           	LD A,(BC)
 927++4544 03           	INC BC
 928++4545 67           	LD H,A
 929++4546 0A           	LD A,(BC)
 930++4547 03           	INC BC
 931++4548 6F           	LD L,A
 932++4549 CD C6 42     	CALL SETENBS
 933++454C AF           	XOR A
 934++454D DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 935++4550 FD 77 0F     	LD (IY-100+VRS.CurEDel),A
 936++4553 67           	LD H,A
 937++4554 6F           	LD L,A
 938++4555 C3 CD 42     	JP SETESLD
 939++4558
 940++4558 87           SETORN	ADD A,A
 941++4559 5F           	LD E,A
 942++455A 16 00        	LD D,0
 943++455C DD 72 F4     	LD (IX-12+CHP.PsInOr),D
 944++455F FD 6E F8     	LD L,(IY-100+VRS.OrnPtrs)
 945++4562 FD 66 F9     	LD H,(IY-100+VRS.OrnPtrs+1)
 946++4565 19           	ADD HL,DE
 947++4566 5E           	LD E,(HL)
 948++4567 23           	INC HL
 949++4568 56           	LD D,(HL)
 950++4569 FD 6E F6     	LD L,(IY-100+VRS.MODADDR)
 951++456C FD 66 F7     	LD H,(IY-100+VRS.MODADDR+1)
 952++456F 19           	ADD HL,DE
 953++4570 DD 75 01     	LD (IX-12+CHP.OrnPtr),L
 954++4573 DD 74 02     	LD (IX-12+CHP.OrnPtr+1),H
 955++4576 C9           C_NOP	RET
 956++4577
 957++4577 87           SETSAM	ADD A,A
 958++4578 5F           	LD E,A
 959++4579 16 00        	LD D,0
 960++457B FD 6E FA     	LD L,(IY-100+VRS.SamPtrs);
 961++457E FD 66 FB     	LD H,(IY-100+VRS.SamPtrs+1);
 962++4581 19           	ADD HL,DE
 963++4582 5E           	LD E,(HL)
 964++4583 23           	INC HL
 965++4584 56           	LD D,(HL)
 966++4585 FD 6E F6     	LD L,(IY-100+VRS.MODADDR)
 967++4588 FD 66 F7     	LD H,(IY-100+VRS.MODADDR+1)
 968++458B 19           	ADD HL,DE
 969++458C DD 75 03     	LD (IX-12+CHP.SamPtr),L
 970++458F DD 74 04     	LD (IX-12+CHP.SamPtr+1),H
 971++4592 C9           	RET
 972++4593
 973++4593              ;ALL 16 ADDRESSES TO PROTECT FROM BROKEN PT3 MODULES
 974++4593 76 45        SPCCOMS DW C_NOP
 975++4595 D2 44        	DW C_GLISS
 976++4597 5E 44        	DW C_PORTM
 977++4599 EF 44        	DW C_SMPOS
 978++459B F5 44        	DW C_ORPOS
 979++459D FB 44        	DW C_VIBRT
 980++459F 76 45        	DW C_NOP
 981++45A1 76 45        	DW C_NOP
 982++45A3 13 45        	DW C_ENGLS
 983++45A5 28 45        	DW C_DELAY
 984++45A7 76 45        	DW C_NOP
 985++45A9 76 45        	DW C_NOP
 986++45AB 76 45        	DW C_NOP
 987++45AD 76 45        	DW C_NOP
 988++45AF 76 45        	DW C_NOP
 989++45B1 76 45        	DW C_NOP
 990++45B3
 991++45B3 CD D4 42     CHREGS	CALL GETIX
 992++45B6 AF           	XOR A
 993++45B7 32 F3 47     	LD (Ampl),A
 994++45BA DD CB 15 46  	BIT 0,(IX+CHP.Flags)
 995++45BE E5           	PUSH HL
 996++45BF CA 06 47     	JP Z,CH_EXIT
 997++45C2 ED 73 50 46  	LD (CSP_+1),SP
 998++45C6 DD 6E 0D     	LD L,(IX+CHP.OrnPtr)
 999++45C9 DD 66 0E     	LD H,(IX+CHP.OrnPtr+1)
1000++45CC F9           	LD SP,HL
1001++45CD D1           	POP DE
1002++45CE 67           	LD H,A
1003++45CF DD 7E 00     	LD A,(IX+CHP.PsInOr)
1004++45D2 6F           	LD L,A
1005++45D3 39           	ADD HL,SP
1006++45D4 3C           	INC A
1007++45D5              		;PT2	PT3
1008++45D5 3C           OrnCP	INC A	;CP E	CP D
1009++45D6 38 01        	JR C,CH_ORPS
1010++45D8 01           OrnLD	DB 1	;LD A,D	LD A,E
1011++45D9 DD 77 00     CH_ORPS	LD (IX+CHP.PsInOr),A
1012++45DC DD 7E 12     	LD A,(IX+CHP.Note)
1013++45DF 86           	ADD A,(HL)
1014++45E0 F2 E4 45     	JP P,CH_NTP
1015++45E3 AF           	XOR A
1016++45E4 FE 60        CH_NTP	CP 96
1017++45E6 38 02        	JR C,CH_NOK
1018++45E8 3E 5F        	LD A,95
1019++45EA 87           CH_NOK	ADD A,A
1020++45EB 08           	EX AF,AF'
1021++45EC DD 6E 0F     	LD L,(IX+CHP.SamPtr)
1022++45EF DD 66 10     	LD H,(IX+CHP.SamPtr+1)
1023++45F2 F9           	LD SP,HL
1024++45F3 D1           	POP DE
1025++45F4 26 00        	LD H,0
1026++45F6 DD 7E 01     	LD A,(IX+CHP.PsInSm)
1027++45F9 47           	LD B,A
1028++45FA 87           	ADD A,A
1029++45FB 87           SamClc2	ADD A,A ;or ADD A,B for PT2
1030++45FC 6F           	LD L,A
1031++45FD 39           	ADD HL,SP
1032++45FE F9           	LD SP,HL
1033++45FF 78           	LD A,B
1034++4600 3C           	INC A
1035++4601              		;PT2	PT3
1036++4601 3C           SamCP	INC A	;CP E	CP D
1037++4602 38 01        	JR C,CH_SMPS
1038++4604 01           SamLD	DB 1	;LD A,D	LD A,E
1039++4605 DD 77 01     CH_SMPS	LD (IX+CHP.PsInSm),A
1040++4608 C1           	POP BC
1041++4609 E1           	POP HL
1042++460A
1043++460A              ;Convert PT2 sample to PT3
1044++460A              		;PT2		PT3
1045++460A E1           SamCnv	POP HL  ;BIT 2,C	JR e_
1046++460B E1           	POP HL
1047++460C 60           	LD H,B
1048++460D 20 06        	JR NZ,$+8
1049++460F EB           	EX DE,HL
1050++4610 A7           	AND A
1051++4611 ED 62        	SBC HL,HL
1052++4613 ED 52        	SBC HL,DE
1053++4615 51           	LD D,C
1054++4616 CB 19        	RR C
1055++4618 9F           	SBC A,A
1056++4619 2F           	CPL
1057++461A E6 3E        	AND #3E
1058++461C CB 19        	RR C
1059++461E CB 18        	RR B
1060++4620 A1           	AND C
1061++4621 4F           	LD C,A
1062++4622 78           	LD A,B
1063++4623 1F           	RRA
1064++4624 1F           	RRA
1065++4625 CB 1A        	RR D
1066++4627 1F           	RRA
1067++4628 E6 9F        	AND #9F
1068++462A 47           	LD B,A
1069++462B
1070++462B DD 5E 08     e_	LD E,(IX+CHP.TnAcc)
1071++462E DD 56 09     	LD D,(IX+CHP.TnAcc+1)
1072++4631 19           	ADD HL,DE
1073++4632 CB 70        	BIT 6,B
1074++4634 28 06        	JR Z,CH_NOAC
1075++4636 DD 75 08     	LD (IX+CHP.TnAcc),L
1076++4639 DD 74 09     	LD (IX+CHP.TnAcc+1),H
1077++463C EB           CH_NOAC EX DE,HL
1078++463D 08           	EX AF,AF'
player.asm(1079): warning: value 0x4B36 is truncated to 8bit value: 0x36
1079++463E C6 36        	ADD A,NT_
1080++4640 6F           	LD L,A
1081++4641 CE 4B        	ADC A,NT_/256
1082++4643 95           	SUB L
1083++4644 67           	LD H,A
1084++4645 F9           	LD SP,HL
1085++4646 E1           	POP HL
1086++4647 19           	ADD HL,DE
1087++4648 DD 5E 06     	LD E,(IX+CHP.CrTnSl)
1088++464B DD 56 07     	LD D,(IX+CHP.CrTnSl+1)
1089++464E 19           	ADD HL,DE
1090++464F 31 31 31     CSP_	LD SP,#3131
1091++4652 E3           	EX (SP),HL
1092++4653 AF           	XOR A
1093++4654 DD B6 05     	OR (IX+CHP.TSlCnt)
1094++4657 28 3E        	JR Z,CH_AMP
1095++4659 DD 35 05     	DEC (IX+CHP.TSlCnt)
1096++465C 20 39        	JR NZ,CH_AMP
1097++465E DD 7E 16     	LD A,(IX+CHP.TnSlDl)
1098++4661 DD 77 05     	LD (IX+CHP.TSlCnt),A
1099++4664 DD 6E 17     	LD L,(IX+CHP.TSlStp)
1100++4667 DD 66 18     	LD H,(IX+CHP.TSlStp+1)
1101++466A 7C           	LD A,H
1102++466B 19           	ADD HL,DE
1103++466C DD 75 06     	LD (IX+CHP.CrTnSl),L
1104++466F DD 74 07     	LD (IX+CHP.CrTnSl+1),H
1105++4672 DD CB 15 56  	BIT 2,(IX+CHP.Flags)
1106++4676 20 1F        	JR NZ,CH_AMP
1107++4678 DD 5E 19     	LD E,(IX+CHP.TnDelt)
1108++467B DD 56 1A     	LD D,(IX+CHP.TnDelt+1)
1109++467E A7           	AND A
1110++467F 28 01        	JR Z,CH_STPP
1111++4681 EB           	EX DE,HL
1112++4682 ED 52        CH_STPP SBC HL,DE
1113++4684 FA 97 46     	JP M,CH_AMP
1114++4687 DD 7E 13     	LD A,(IX+CHP.SlToNt)
1115++468A DD 77 12     	LD (IX+CHP.Note),A
1116++468D AF           	XOR A
1117++468E DD 77 05     	LD (IX+CHP.TSlCnt),A
1118++4691 DD 77 06     	LD (IX+CHP.CrTnSl),A
1119++4694 DD 77 07     	LD (IX+CHP.CrTnSl+1),A
1120++4697 DD 7E 02     CH_AMP	LD A,(IX+CHP.CrAmSl)
1121++469A CB 79        	BIT 7,C
1122++469C 28 13        	JR Z,CH_NOAM
1123++469E CB 71        	BIT 6,C
1124++46A0 28 07        	JR Z,CH_AMIN
1125++46A2 FE 0F        	CP 15
1126++46A4 28 0B        	JR Z,CH_NOAM
1127++46A6 3C           	INC A
1128++46A7 18 05        	JR CH_SVAM
1129++46A9 FE F1        CH_AMIN	CP -15
1130++46AB 28 04        	JR Z,CH_NOAM
1131++46AD 3D           	DEC A
1132++46AE DD 77 02     CH_SVAM	LD (IX+CHP.CrAmSl),A
1133++46B1 6F           CH_NOAM	LD L,A
1134++46B2 78           	LD A,B
1135++46B3 E6 0F        	AND 15
1136++46B5 85           	ADD A,L
1137++46B6 F2 BA 46     	JP P,CH_APOS
1138++46B9 AF           	XOR A
1139++46BA FE 10        CH_APOS	CP 16
1140++46BC 38 02        	JR C,CH_VOL
1141++46BE 3E 0F        	LD A,15
1142++46C0 DD B6 1C     CH_VOL	OR (IX+CHP.Volume)
player.asm(1143): warning: value 0x4A36 is truncated to 8bit value: 0x36
1143++46C3 C6 36        	ADD A,VT_
1144++46C5 6F           	LD L,A
1145++46C6 CE 4A        	ADC A,VT_/256
1146++46C8 95           	SUB L
1147++46C9 67           	LD H,A
1148++46CA 7E           	LD A,(HL)
1149++46CB CB 41        CH_ENV	BIT 0,C
1150++46CD 20 03        	JR NZ,CH_NOEN
1151++46CF DD B6 14     	OR (IX+CHP.Env_En)
1152++46D2 32 F3 47     CH_NOEN	LD (Ampl),A
1153++46D5 CB 78        	BIT 7,B
1154++46D7 79           	LD A,C
1155++46D8 28 1A        	JR Z,NO_ENSL
1156++46DA 17           	RLA
1157++46DB 17           	RLA
1158++46DC CB 2F        	SRA A
1159++46DE CB 2F        	SRA A
1160++46E0 CB 2F        	SRA A
1161++46E2 DD 86 04     	ADD A,(IX+CHP.CrEnSl) ;SEE COMMENT BELOW
1162++46E5 CB 68        	BIT 5,B
1163++46E7 28 03        	JR Z,NO_ENAC
1164++46E9 DD 77 04     	LD (IX+CHP.CrEnSl),A
1165++46EC FD 86 12     NO_ENAC	ADD A,(IY-100+VRS.AddToEn) ;BUG IN PT3 - NEED WORD HERE
1166++46EF FD 77 12     	LD (IY-100+VRS.AddToEn),A
1167++46F2 18 0E        	JR CH_MIX
1168++46F4 1F           NO_ENSL RRA
1169++46F5 DD 86 03     	ADD A,(IX+CHP.CrNsSl)
1170++46F8 FD 77 11     	LD (IY-100+VRS.AddToNs),A
1171++46FB CB 68        	BIT 5,B
1172++46FD 28 03        	JR Z,CH_MIX
1173++46FF DD 77 03     	LD (IX+CHP.CrNsSl),A
1174++4702 78           CH_MIX	LD A,B
1175++4703 1F           	RRA
1176++4704 E6 48        	AND #48
1177++4706 FD B6 1C     CH_EXIT	OR (IY-100+VRS.AYREGS+Mixer)
1178++4709 0F           	RRCA
1179++470A FD 77 1C     	LD (IY-100+VRS.AYREGS+Mixer),A
1180++470D E1           	POP HL
1181++470E AF           	XOR A
1182++470F DD B6 0A     	OR (IX+CHP.COnOff)
1183++4712 C8           	RET Z
1184++4713 DD 35 0A     	DEC (IX+CHP.COnOff)
1185++4716 C0           	RET NZ
1186++4717 DD AE 15     	XOR (IX+CHP.Flags)
1187++471A DD 77 15     	LD (IX+CHP.Flags),A
1188++471D 1F           	RRA
1189++471E DD 7E 0B     	LD A,(IX+CHP.OnOffD)
1190++4721 38 03        	JR C,CH_ONDL
1191++4723 DD 7E 0C     	LD A,(IX+CHP.OffOnD)
1192++4726 DD 77 0A     CH_ONDL	LD (IX+CHP.COnOff),A
1193++4729 C9           	RET
1194++472A
1195++472A AF           PLAY_	XOR A
1196++472B FD 77 12     	LD (IY-100+VRS.AddToEn),A
1197++472E FD 77 1C     	LD (IY-100+VRS.AYREGS+Mixer),A
1198++4731 3D           	DEC A
1199++4732 FD 77 22     	LD (IY-100+VRS.AYREGS+EnvTp),A
1200++4735 FD 35 09     	DEC (IY-100+VRS.DelyCnt)
1201++4738 C2 E0 47     	JP NZ,PL2
1202++473B FD 35 BA     	DEC (IY-100+VRS.ChanA+CHP.NtSkCn)
1203++473E 20 6C        	JR NZ,PL1B
1204++4740 FD 4E FE     	LD C,(IY-100+VRS.AdInPtA)
1205++4743 FD 46 FF     	LD B,(IY-100+VRS.AdInPtA+1)
1206++4746 0A           	LD A,(BC)
1207++4747 A7           	AND A
1208++4748 20 56        	JR NZ,PL1A
1209++474A 57           	LD D,A
1210++474B FD 77 10     	LD (IY-100+VRS.Ns_Base),A
1211++474E FD 6E 04     	LD L,(IY-100+VRS.CrPsPtr)
1212++4751 FD 66 05     	LD H,(IY-100+VRS.CrPsPtr+1)
1213++4754 23           	INC HL
1214++4755 7E           	LD A,(HL)
1215++4756 3C           	INC A
1216++4757 20 0B        	JR NZ,PLNLP
1217++4759
1218++4759              	IF LoopChecker
1219++4759 CD 0B 40     	CALL CHECKLP
1220++475C              	ENDIF
1221++475C
1222++475C FD 6E 06     	LD L,(IY-100+VRS.LPosPtr)
1223++475F FD 66 07     	LD H,(IY-100+VRS.LPosPtr+1)
1224++4762 7E           	LD A,(HL)
1225++4763 3C           	INC A
1226++4764 CD B8 42     PLNLP	CALL SETCPPT
1227++4767 3D           	DEC A
1228++4768 FD CB 9E 4E  	BIT 1,(IY-100+VRS.ModNum)
1229++476C 28 03        	JR Z,NoAlCo
1230++476E              TSSub	EQU $+1
1231++476E D6 D6        	SUB #D6
1232++4770 2F           	CPL
1233++4771              NoAlCo
1234++4771              		;PT2		PT3
1235++4771 3D           PsCalc	DEC A	;ADD A,A	NOP
1236++4772 3D           	DEC A	;ADD A,(HL)	NOP
1237++4773 87           	ADD A,A
1238++4774 5F           	LD E,A
1239++4775 CB 12        	RL D
1240++4777
1241++4777              	IF CurPosCounter
1242++4777 ~            	LD A,L
1243++4777 ~            	SUB (IY-100+VRS.PosSub)
1244++4777 ~            	LD (IY-100+VRS.CurPos),A
1245++4777              	ENDIF
1246++4777
1247++4777 FD 6E FC     	LD L,(IY-100+VRS.PatsPtr)
1248++477A FD 66 FD     	LD H,(IY-100+VRS.PatsPtr+1)
1249++477D 19           	ADD HL,DE
1250++477E FD 5E F6     	LD E,(IY-100+VRS.MODADDR)
1251++4781 FD 56 F7     	LD D,(IY-100+VRS.MODADDR+1)
1252++4784 ED 73 9E 47  	LD (PSP_+1),SP
1253++4788 F9           	LD SP,HL
1254++4789 E1           	POP HL
1255++478A 19           	ADD HL,DE
1256++478B 44           	LD B,H
1257++478C 4D           	LD C,L
1258++478D E1           	POP HL
1259++478E 19           	ADD HL,DE
1260++478F FD 75 00     	LD (IY-100+VRS.AdInPtB),L
1261++4792 FD 74 01     	LD (IY-100+VRS.AdInPtB+1),H
1262++4795 E1           	POP HL
1263++4796 19           	ADD HL,DE
1264++4797 FD 75 02     	LD (IY-100+VRS.AdInPtC),L
1265++479A FD 74 03     	LD (IY-100+VRS.AdInPtC+1),H
1266++479D 31 31 31     PSP_	LD SP,#3131
1267++47A0 11 AB FF     PL1A	LD DE,VRS.ChanA+12-100
1268++47A3 CD DB 42     	CALL PTDECOD
1269++47A6 FD 71 FE     	LD (IY-100+VRS.AdInPtA),C
1270++47A9 FD 70 FF     	LD (IY-100+VRS.AdInPtA+1),B
1271++47AC
1272++47AC FD 35 D7     PL1B	DEC (IY-100+VRS.ChanB+CHP.NtSkCn)
1273++47AF 20 12        	JR NZ,PL1C
1274++47B1 11 C8 FF     	LD DE,VRS.ChanB+12-100
1275++47B4 FD 4E 00     	LD C,(IY-100+VRS.AdInPtB)
1276++47B7 FD 46 01     	LD B,(IY-100+VRS.AdInPtB+1)
1277++47BA CD DB 42     	CALL PTDECOD
1278++47BD FD 71 00     	LD (IY-100+VRS.AdInPtB),C
1279++47C0 FD 70 01     	LD (IY-100+VRS.AdInPtB+1),B
1280++47C3
1281++47C3 FD 35 F4     PL1C	DEC (IY-100+VRS.ChanC+CHP.NtSkCn)
1282++47C6 20 12        	JR NZ,PL1D
1283++47C8 11 E5 FF     	LD DE,VRS.ChanC+12-100
1284++47CB FD 4E 02     	LD C,(IY-100+VRS.AdInPtC)
1285++47CE FD 46 03     	LD B,(IY-100+VRS.AdInPtC+1)
1286++47D1 CD DB 42     	CALL PTDECOD
1287++47D4 FD 71 02     	LD (IY-100+VRS.AdInPtC),C
1288++47D7 FD 70 03     	LD (IY-100+VRS.AdInPtC+1),B
1289++47DA
1290++47DA FD 7E 08     PL1D	LD A,(IY-100+VRS.Delay)
1291++47DD FD 77 09     	LD (IY-100+VRS.DelyCnt),A
1292++47E0
1293++47E0 11 9F FF     PL2	LD DE,VRS.ChanA-100
1294++47E3 FD 6E 15     	LD L,(IY-100+VRS.AYREGS+TonA)
1295++47E6 FD 66 16     	LD H,(IY-100+VRS.AYREGS+TonA+1)
1296++47E9 CD B3 45     	CALL CHREGS
1297++47EC FD 75 15     	LD (IY-100+VRS.AYREGS+TonA),L
1298++47EF FD 74 16     	LD (IY-100+VRS.AYREGS+TonA+1),H
1299++47F2              Ampl	EQU $+1
1300++47F2 3E 3E        	LD A,#3E
1301++47F4 FD 77 1D     	LD (IY-100+VRS.AYREGS+AmplA),A
1302++47F7 11 BC FF     	LD DE,VRS.ChanB-100
1303++47FA FD 6E 17     	LD L,(IY-100+VRS.AYREGS+TonB)
1304++47FD FD 66 18     	LD H,(IY-100+VRS.AYREGS+TonB+1)
1305++4800 CD B3 45     	CALL CHREGS
1306++4803 FD 75 17     	LD (IY-100+VRS.AYREGS+TonB),L
1307++4806 FD 74 18     	LD (IY-100+VRS.AYREGS+TonB+1),H
1308++4809 3A F3 47     	LD A,(Ampl)
1309++480C FD 77 1E     	LD (IY-100+VRS.AYREGS+AmplB),A
1310++480F 11 D9 FF     	LD DE,VRS.ChanC-100
1311++4812 FD 6E 19     	LD L,(IY-100+VRS.AYREGS+TonC)
1312++4815 FD 66 1A     	LD H,(IY-100+VRS.AYREGS+TonC+1)
1313++4818 CD B3 45     	CALL CHREGS
1314++481B FD 75 19     	LD (IY-100+VRS.AYREGS+TonC),L
1315++481E FD 74 1A     	LD (IY-100+VRS.AYREGS+TonC+1),H
1316++4821 3A F3 47     	LD A,(Ampl)
1317++4824 FD 77 1F     	LD (IY-100+VRS.AYREGS+AmplC),A
1318++4827
1319++4827 FD 7E 10     	LD A,(IY-100+VRS.Ns_Base)
1320++482A FD 86 11     	ADD (IY-100+VRS.AddToNs)
1321++482D FD 77 1B     	LD (IY-100+VRS.AYREGS+Noise),A
1322++4830
1323++4830 FD 7E 12     	LD A,(IY-100+VRS.AddToEn)
1324++4833 5F           	LD E,A
1325++4834 87           	ADD A,A
1326++4835 9F           	SBC A,A
1327++4836 57           	LD D,A
1328++4837 FD 6E 13     	LD L,(IY-100+VRS.EnvBase)
1329++483A FD 66 14     	LD H,(IY-100+VRS.EnvBase+1)
1330++483D 19           	ADD HL,DE
1331++483E FD 5E 0C     	LD E,(IY-100+VRS.CurESld)
1332++4841 FD 56 0D     	LD D,(IY-100+VRS.CurESld+1)
1333++4844 19           	ADD HL,DE
1334++4845 FD 75 20     	LD (IY-100+VRS.AYREGS+Env),L
1335++4848 FD 74 21     	LD (IY-100+VRS.AYREGS+Env+1),H
1336++484B
1337++484B AF           	XOR A
1338++484C FD B6 0F     	OR (IY-100+VRS.CurEDel)
1339++484F C8           	RET Z
1340++4850 FD 35 0F     	DEC (IY-100+VRS.CurEDel)
1341++4853 C0           	RET NZ
1342++4854 FD 7E 0E     	LD A,(IY-100+VRS.Env_Del)
1343++4857 FD 77 0F     	LD (IY-100+VRS.CurEDel),A
1344++485A FD 6E 0A     	LD L,(IY-100+VRS.ESldAdd)
1345++485D FD 66 0B     	LD H,(IY-100+VRS.ESldAdd+1)
1346++4860 19           	ADD HL,DE
1347++4861 C3 CD 42     	JP SETESLD
1348++4864
1349++4864 FD 21 9C 49  PLAY    LD IY,VARS1+100
1350++4868 CD 2A 47     	CALL PLAY_
1351++486B 3A 37 49     	LD A,(is_ts)
1352++486E A7           	AND A
1353++486F 28 07        	JR Z,PL_nts
1354++4871 FD 21 23 4A  	LD IY,VARS2+100
1355++4875 CD 2A 47     	CALL PLAY_
1356++4878              PL_nts
1357++4878              	IF Basic
1358++4878 FD 21 3A 5C  	LD IY,#5C3A
1359++487C              	ENDIF
1360++487C
1361++487C 01 FD FF     ROUT	LD BC,#FFFD
1362++487F 3A 37 49     	LD A,(is_ts)
1363++4882 A7           	AND A
1364++4883 28 02        	JR Z,r_nts ;keep old standard
1365++4885 ED 41        	OUT (C),B
1366++4887 08           r_nts	EX AF,AF'
1367++4888
1368++4888              	IF ACBBAC
1369++4888 ~            	LD IX,VARS1+VRS.AYREGS
1370++4888              	ELSE
1371++4888 21 B1 49     	LD HL,VARS1+VRS.AYREGS
1372++488B              	ENDIF
1373++488B
1374++488B CD 97 48     	CALL ROUT_
1375++488E 08           	EX AF,AF'
1376++488F C8           	RET Z
1377++4890 42           	LD B,D
1378++4891 2F           	CPL
1379++4892 ED 79        	OUT (C),A
1380++4894
1381++4894              	IF ACBBAC
1382++4894 ~            	LD IX,VARS2+VRS.AYREGS
1383++4894              	ELSE
1384++4894 21 38 4A     	LD HL,VARS2+VRS.AYREGS
1385++4897              	ENDIF
1386++4897
1387++4897              ROUT_
1388++4897              	IF ACBBAC
1389++4897 ~            	LD A,(SETUP)
1390++4897 ~            	AND 12
1391++4897 ~            	JR Z,ABC
1392++4897 ~            	ADD A,CHTABLE
1393++4897 ~            	LD E,A
1394++4897 ~            	ADC A,CHTABLE/256
1395++4897 ~            	SUB E
1396++4897 ~            	LD D,A
1397++4897 ~            	LD B,0
1398++4897 ~            	PUSH IX
1399++4897 ~            	POP HL
1400++4897 ~            	LD A,(DE)
1401++4897 ~            	INC DE
1402++4897 ~            	LD C,A
1403++4897 ~            	ADD HL,BC
1404++4897 ~            	LD A,(IX+TonB)
1405++4897 ~            	LD C,(HL)
1406++4897 ~            	LD (IX+TonB),C
1407++4897 ~            	LD (HL),A
1408++4897 ~            	INC HL
1409++4897 ~            	LD A,(IX+TonB+1)
1410++4897 ~            	LD C,(HL)
1411++4897 ~            	LD (IX+TonB+1),C
1412++4897 ~            	LD (HL),A
1413++4897 ~            	LD A,(DE)
1414++4897 ~            	INC DE
1415++4897 ~            	LD C,A
1416++4897 ~            	ADD HL,BC
1417++4897 ~            	LD A,(IX+AmplB)
1418++4897 ~            	LD C,(HL)
1419++4897 ~            	LD (IX+AmplB),C
1420++4897 ~            	LD (HL),A
1421++4897 ~            	LD A,(DE)
1422++4897 ~            	INC DE
1423++4897 ~            	LD (RxCA1),A
1424++4897 ~            	XOR 8
1425++4897 ~            	LD (RxCA2),A
1426++4897 ~            	LD A,(DE)
1427++4897 ~            	AND (IX+Mixer)
1428++4897 ~            	LD E,A
1429++4897 ~            	LD A,(IX+Mixer)
1430++4897 ~            RxCA1	DB #E6
1431++4897 ~            	AND %010010
1432++4897 ~            	OR E
1433++4897 ~            	LD E,A
1434++4897 ~            	LD A,(IX+Mixer)
1435++4897 ~            	AND %010010
1436++4897 ~            RxCA2	OR E
1437++4897 ~            	OR E
1438++4897 ~            	LD (IX+Mixer),A
1439++4897 ~            ABC
1440++4897              	ENDIF
1441++4897
1442++4897 AF           	XOR A
1443++4898 11 BF FF     	LD DE,#FFBF
1444++489B
1445++489B              	IF ACBBAC
1446++489B ~            	LD BC,#FFFD
1447++489B ~            	PUSH IX
1448++489B ~            	POP HL
1449++489B              	ENDIF
1450++489B
1451++489B ED 79        LOUT	OUT (C),A
1452++489D 43           	LD B,E
1453++489E ED A3        	OUTI
1454++48A0 42           	LD B,D
1455++48A1 3C           	INC A
1456++48A2 FE 0D        	CP 13
1457++48A4 20 F5        	JR NZ,LOUT
1458++48A6 ED 79        	OUT (C),A
1459++48A8 7E           	LD A,(HL)
1460++48A9 A7           	AND A
1461++48AA F8           	RET M
1462++48AB 43           	LD B,E
1463++48AC ED 79        	OUT (C),A
1464++48AE C9           	RET
1465++48AF
1466++48AF              	IF ACBBAC
1467++48AF ~            CHTABLE	EQU $-4
1468++48AF ~            	DB 4,5,15,%001001,0,7,7,%100100
1469++48AF              	ENDIF
1470++48AF
1471++48AF 64           NT_DATA	DB (T_NEW_0-T1_)*2
1472++48B0 2A           	DB TCNEW_0-T_
1473++48B1 65           	DB (T_OLD_0-T1_)*2+1
1474++48B2 00           	DB TCOLD_0-T_
1475++48B3 01           	DB (T_NEW_1-T1_)*2+1
1476++48B4 0C           	DB TCNEW_1-T_
1477++48B5 01           	DB (T_OLD_1-T1_)*2+1
1478++48B6 0C           	DB TCOLD_1-T_
1479++48B7 94           	DB (T_NEW_2-T1_)*2
1480++48B8 35           	DB TCNEW_2-T_
1481++48B9 30           	DB (T_OLD_2-T1_)*2
1482++48BA 0E           	DB TCOLD_2-T_
1483++48BB 60           	DB (T_NEW_3-T1_)*2
1484++48BC 20           	DB TCNEW_3-T_
1485++48BD 60           	DB (T_OLD_3-T1_)*2
1486++48BE 21           	DB TCOLD_3-T_
1487++48BF
1488++48BF              T_
1489++48BF
1490++48BF 01 05 09 0B  TCOLD_0	DB #00+1,#04+1,#08+1,#0A+1,#0C+1,#0E+1,#12+1,#14+1
1490++48C3 0D 0F 13 15
1491++48C7 19 25 3D 00  	DB #18+1,#24+1,#3C+1,0
1492++48CB 5D 00        TCOLD_1	DB #5C+1,0
1493++48CD 31 37 4D 53  TCOLD_2	DB #30+1,#36+1,#4C+1,#52+1,#5E+1,#70+1,#82,#8C,#9C
1493++48D1 5F 71 82 8C
1493++48D5 9C
1494++48D6 9E A0 A6 A8  	DB #9E,#A0,#A6,#A8,#AA,#AC,#AE,#AE,0
1494++48DA AA AC AE AE
1494++48DE 00
1495++48DF 57           TCNEW_3	DB #56+1
1496++48E0 1F 23 25 29  TCOLD_3	DB #1E+1,#22+1,#24+1,#28+1,#2C+1,#2E+1,#32+1,#BE+1,0
1496++48E4 2D 2F 33 BF
1496++48E8 00
1497++48E9 1D 21 23 27  TCNEW_0	DB #1C+1,#20+1,#22+1,#26+1,#2A+1,#2C+1,#30+1,#54+1
1497++48ED 2B 2D 31 55
1498++48F1 BD BF 00     	DB #BC+1,#BE+1,0
1499++48F4              TCNEW_1 EQU TCOLD_1
1500++48F4 1B 21 25 29  TCNEW_2	DB #1A+1,#20+1,#24+1,#28+1,#2A+1,#3A+1,#4C+1,#5E+1
1500++48F8 2B 3B 4D 5F
1501++48FC BB BD BF 00  	DB #BA+1,#BC+1,#BE+1,0
1502++4900
1503++4900              PT3EMPTYORN EQU $-1
1504++4900 01 00        	DB 1,0
1505++4902
1506++4902              ;first 12 values of tone tables (packed)
1507++4902
player.asm(1508): warning: value 0xDD8 is truncated to 8bit value: 0xD8
1508++4902 0D D8        T_PACK	DB #06EC*2/256,#06EC*2
1509++4904 69           	DB #0755-#06EC
1510++4905 70           	DB #07C5-#0755
1511++4906 76           	DB #083B-#07C5
1512++4907 7D           	DB #08B8-#083B
1513++4908 85           	DB #093D-#08B8
1514++4909 8D           	DB #09CA-#093D
1515++490A 95           	DB #0A5F-#09CA
1516++490B 9D           	DB #0AFC-#0A5F
1517++490C A8           	DB #0BA4-#0AFC
1518++490D B1           	DB #0C55-#0BA4
1519++490E BB           	DB #0D10-#0C55
player.asm(1520): warning: value 0xCDA is truncated to 8bit value: 0xDA
1520++490F 0C DA        	DB #066D*2/256,#066D*2
1521++4911 62           	DB #06CF-#066D
1522++4912 68           	DB #0737-#06CF
1523++4913 6D           	DB #07A4-#0737
1524++4914 75           	DB #0819-#07A4
1525++4915 7B           	DB #0894-#0819
1526++4916 83           	DB #0917-#0894
1527++4917 8A           	DB #09A1-#0917
1528++4918 92           	DB #0A33-#09A1
1529++4919 9C           	DB #0ACF-#0A33
1530++491A A4           	DB #0B73-#0ACF
1531++491B AF           	DB #0C22-#0B73
1532++491C B8           	DB #0CDA-#0C22
player.asm(1533): warning: value 0xE08 is truncated to 8bit value: 0x08
1533++491D 0E 08        	DB #0704*2/256,#0704*2
1534++491F 6A           	DB #076E-#0704
1535++4920 72           	DB #07E0-#076E
1536++4921 78           	DB #0858-#07E0
1537++4922 7E           	DB #08D6-#0858
1538++4923 86           	DB #095C-#08D6
1539++4924 90           	DB #09EC-#095C
1540++4925 96           	DB #0A82-#09EC
1541++4926 A0           	DB #0B22-#0A82
1542++4927 AA           	DB #0BCC-#0B22
1543++4928 B4           	DB #0C80-#0BCC
1544++4929 BE           	DB #0D3E-#0C80
player.asm(1545): warning: value 0xFC0 is truncated to 8bit value: 0xC0
1545++492A 0F C0        	DB #07E0*2/256,#07E0*2
1546++492C 78           	DB #0858-#07E0
1547++492D 88           	DB #08E0-#0858
1548++492E 80           	DB #0960-#08E0
1549++492F 90           	DB #09F0-#0960
1550++4930 98           	DB #0A88-#09F0
1551++4931 A0           	DB #0B28-#0A88
1552++4932 B0           	DB #0BD8-#0B28
1553++4933 A8           	DB #0C80-#0BD8
1554++4934 E0           	DB #0D60-#0C80
1555++4935 B0           	DB #0E10-#0D60
1556++4936 E8           	DB #0EF8-#0E10
1557++4937
1558++4937              ;vars from here can be stripped
1559++4937              ;you can move VARS to any other address
1560++4937
1561++4937              VARS
1562++4937
1563++4937 00           is_ts	DB 0
1564++4938
1565++4938              ;ChannelsVars
1566++4938              	STRUCT	CHP
1567++4938 ~            ;reset group
1568++4938 ~            PsInOr	DB 0
1569++4938 ~            PsInSm	DB 0
1570++4938 ~            CrAmSl	DB 0
1571++4938 ~            CrNsSl	DB 0
1572++4938 ~            CrEnSl	DB 0
1573++4938 ~            TSlCnt	DB 0
1574++4938 ~            CrTnSl	DW 0
1575++4938 ~            TnAcc	DW 0
1576++4938 ~            COnOff	DB 0
1577++4938 ~            ;reset group
1578++4938 ~
1579++4938 ~            OnOffD	DB 0
1580++4938 ~
1581++4938 ~            ;IX for PTDECOD here (+12)
1582++4938 ~            OffOnD	DB 0
1583++4938 ~            OrnPtr	DW 0
1584++4938 ~            SamPtr	DW 0
1585++4938 ~            NNtSkp	DB 0
1586++4938 ~            Note	DB 0
1587++4938 ~            SlToNt	DB 0
1588++4938 ~            Env_En	DB 0
1589++4938 ~            Flags	DB 0
1590++4938 ~             ;Enabled - 0, SimpleGliss - 2
1591++4938 ~            TnSlDl	DB 0
1592++4938 ~            TSlStp	DW 0
1593++4938 ~            TnDelt	DW 0
1594++4938 ~            NtSkCn	DB 0
1595++4938 ~            Volume	DB 0
1596++4938              	ENDS
1597++4938
1598++4938              	STRUCT	VRS
1599++4938 ~
1600++4938 ~            ;IF not works in STRUCT in SjASM :(
1601++4938 ~            ;	IF CurPosCounter
1602++4938 ~            CurPos	DB 0
1603++4938 ~            PosSub	DB 0
1604++4938 ~            ;	ENDIF
1605++4938 ~
1606++4938 ~            ModNum	DB 0 ;bit0: ChipNum
1607++4938 ~            	     ;bit1: 1-reversed patterns order (AlCo TS)
1608++4938 ~
1609++4938 ~            ChanA	DS CHP
1610++4938 ~            ChanB	DS CHP
1611++4938 ~            ChanC	DS CHP
1612++4938 ~
1613++4938 ~            ;GlobalVars
1614++4938 ~            MODADDR	DW 0
1615++4938 ~            OrnPtrs	DW 0
1616++4938 ~            SamPtrs	DW 0
1617++4938 ~            PatsPtr	DW 0
1618++4938 ~            AdInPtA	DW 0
1619++4938 ~            AdInPtB	DW 0
1620++4938 ~            AdInPtC	DW 0
1621++4938 ~            CrPsPtr	DW 0
1622++4938 ~            LPosPtr	DW 0
1623++4938 ~            Delay	DB 0
1624++4938 ~            DelyCnt	DB 0
1625++4938 ~            ESldAdd	DW 0
1626++4938 ~            CurESld	DW 0
1627++4938 ~            Env_Del	DB 0
1628++4938 ~            CurEDel	DB 0
1629++4938 ~            Ns_Base	DB 0
1630++4938 ~            AddToNs	DB 0
1631++4938 ~            AddToEn	DB 0
1632++4938 ~            EnvBase	DW 0
1633++4938 ~            AYREGS	DS 14
1634++4938              	ENDS
1635++4938
1636++4938 00 00 00...  VARS1	DS VRS
1637++49BF 00 00 00...  VARS2	DS VRS
1638++4A46
1639++4A46              VT_	EQU $-16
1640++4A46 00 00 00...  	DS 256-16 ;CreatedVolumeTableAddress
1641++4B36
1642++4B36              T1_	EQU VT_+16 ;Tone tables data depacked here
1643++4B36
1644++4B36              T_OLD_1	EQU T1_
1645++4B36              T_OLD_2	EQU T_OLD_1+24
1646++4B36              T_OLD_3	EQU T_OLD_2+24
1647++4B36              T_OLD_0	EQU T_OLD_3+2
1648++4B36              T_NEW_0	EQU T_OLD_0
1649++4B36              T_NEW_1	EQU T_OLD_1
1650++4B36              T_NEW_2	EQU T_NEW_0+24
1651++4B36              T_NEW_3	EQU T_OLD_3
1652++4B36
1653++4B36              PT2EMPTYORN EQU VT_+31 ;1,0,0 sequence
1654++4B36
1655++4B36 00 00 00...  NT_	DS 192 ;CreatedNoteTableAddress
1656++4BF6
1657++4BF6              VAR0END	EQU VT_+16 ;INIT zeroes from VARS to VAR0END-1
1658++4BF6
1659++4BF6              VARSEND EQU $
1660++4BF6
1661++4BF6              MDLADDR EQU outputBuffer
1662++4BF6
1663++4BF6              ;Release 0 steps:
1664++4BF6              ;04/21/2007
1665++4BF6              ;Works start (PTxPlay adaptation); first beta.
1666++4BF6              ;04/22/2007
1667++4BF6              ;Job finished; beta-testing.
1668++4BF6              ;04/23/2007
1669++4BF6              ;PT v3.7 TS mode corrected (after AlCo remarks).
1670++4BF6              ;04/29/2007
1671++4BF6              ;Added 1.XX and 2.XX special commands interpretation for PT3
1672++4BF6              ;modules of v3.7+.
1673++4BF6
1674++4BF6              ;Size (minimal build for ZX Spectrum):
1675++4BF6              ;Code block #908 bytes
1676++4BF6              ;Variables #2BF bytes (can be stripped)
1677++4BF6              ;Total size #908+#2BF=#BC7 (3015) bytes
1678++4BF6              	ENDMODULE
# file closed: player/player.asm
  37++4BF6              	MODULE fakemod
  38++4BF6              fakeret
  39++4BF6 C9           	ret
  40++4BF7                  ENDMODULE
  41++4BF7
# file closed: player/vortexnedoos.asm
  30+ 4BF7                      include "player/mod-processor.asm"
# file opened: player/mod-processor.asm
   1++4BF7                  MODULE ModProcessor
   2++4BF7                  ifdef GS
   3++4BF7
   4++4BF7                  macro _WaitCommand2
   5++4BF7 ~            .wait
   6++4BF7 ~                in a, (CMD)
   7++4BF7 ~                rrca
   8++4BF7 ~                jr c, .wait
   9++4BF7                  endm
  10++4BF7
  11++4BF7                  macro _SendCommand2 nn
  12++4BF7 ~                ld a, nn
  12++4BF7 ~              out (CMD), a
  13++4BF7                  endm
  14++4BF7
  15++4BF7              play:
  16++4BF7 3E FF            ld a, 255
  17++4BF9 32 4C 21         ld (oldminutes), a
  18++4BFC
  19++4BFC CD 51 08         call Console.waitForKeyUp
  20++4BFF
  21++4BFF 21 E8 1B         ld hl, Gopher.requestbuffer
  21++4C02 CD 0A 08       call DialogBox.msgNoWait
  22++4C05
  23++4C05                  ;ld a, 1, (Render.play_next), a
  24++4C05 AF           	xor a
  25++4C06 32 A2 4C     	ld (last_song_position),a
  26++4C09
  27++4C09 26 00 3E 20      ld h, #00, a, 32
  28++4C0D CD 42 01         call TextMode.fillLine
  29++4C10 11 01 00         ld de, #0001
  29++4C13 CD 3A 01       call TextMode.gotoXY
  30++4C16 21 5A 4C         ld hl, message
  30++4C19 CD 27 01       call TextMode.printZ
  31++4C1C 3E 00            ld a, #00
  32++4C1E CD 6A 01         call TextMode.highlightLine
  33++4C21
  34++4C21              .loop
  35++4C21 76               halt
  36++4C22 AF               xor a
  37++4C23 CD 44 08         call Console.peekC
  38++4C26 FE 08            cp Console.BACKSPACE
  39++4C28 CA 54 4C         jp z, .stopKey
  40++4C2B FE 20        	cp SPACE
  41++4C2D CA 48 4C         jp z, .playNext
  42++4C30
  43++4C30 CD A7 20         call printRTC
  44++4C33
  45++4C33                 ;╨┐╤А╨╛╨▓╨╡╤А╨║╨░ ╤З╤В╨╛ MOD ╨╜╨░╤З╨░╨╗ ╨╕╨│╤А╨░╤В╤М ╤Б╨╜╨░╤З╨░╨╗╨░
  46++4C33                  _SendCommand2 CMD_GET_SONG_POSITION
  46++4C33 3E 60       >    ld a, CMD_GET_SONG_POSITION
  46++4C35 D3 BB       >  out (CMD), a
  47++4C37                  _WaitCommand2
  47++4C37             >.wait
  47++4C37 DB BB       >    in a, (CMD)
  47++4C39 0F          >    rrca
  47++4C3A 38 FB       >    jr c, .wait
  48++4C3C 3A A2 4C     	ld a,(last_song_position) ;╨┐╤А╨╡╨┤╤Л╨┤╤Г╤Й╨░╤П ╨┐╨╛╨╖╨╕╤Ж╨╕╤П
  49++4C3F 4F           	ld c,a
  50++4C40 DB B3        	in a,(DATA) ;╤В╨╡╨║╤Г╤Й╨░╤П ╨┐╨╛╨╖╨╕╤Ж╨╕╤П
  51++4C42 32 A2 4C     	ld (last_song_position),a
  52++4C45 B9           	cp c
  53++4C46 30 D9        	jr nc, .loop ;╨╡╤Б╨╗╨╕ ╨╜╨╡ ╨╝╨╡╨╜╤М╤И╨╡, ╨┐╤А╨╛╨┤╨╛╨╗╨╢╨░╨╡╨╝ ╨╕╨│╤А╨░╤В╤М
  54++4C48              .playNext
  55++4C48 3E 01 32 3E      ld a, 1, (Render.play_next), a ;╤Д╨╗╨░╨│ ╤З╤В╨╛ ╨╜╨░╨┤╨╛ ╨▒╤Г╨┤╨╡╤В ╨╕╨│╤А╨░╤В╤М ╤Б╨╗╨╡╨┤╤Г╤О╤Й╨╕╨╣ ╤Д╨░╨╣╨╗
  55++4C4C 07
  56++4C4D              .stop
  57++4C4D CD 88 20         call GeneralSound.stopModule
  58++4C50
  59++4C50 CD 51 08         call Console.waitForKeyUp
  60++4C53 C9               ret
  61++4C54              .stopKey
  62++4C54 AF               xor a
  62++4C55 32 3E 07       ld (Render.play_next), a ;╤Д╨╗╨░╨│ ╤З╤В╨╛ ╨╜╨╡ ╨╜╨░╨┤╨╛ ╨╕╨│╤А╨░╤В╤М ╤Б╨╗╨╡╨┤╤Г╤О╤Й╨╕╨╣ ╤Д╨░╨╣╨╗
  63++4C58 18 F3            jr .stop
  64++4C5A
  65++4C5A              message
  66++4C5A                  IFDEF SCREEN64
  67++4C5A                  ENDIF
  68++4C5A                  IFDEF SCREEN80
  69++4C5A 20 20 20 20      db "       "
  69++4C5E 20 20 20
  70++4C61                  ENDIF
  71++4C61                  IFDEF SCREEN85
  72++4C61 ~                db "         "
  73++4C61                  ENDIF
  74++4C61
  75++4C61 50 6C 61 79      db "Playing MODs [SPACE] for next song [BACKSPACE] for stop playing.", 0
  75++4C65 69 6E 67 20
  75++4C69 4D 4F 44 73
  75++4C6D 20 5B 53 50
  75++4C71 41 43 45 5D
  75++4C75 20 66 6F 72
  75++4C79 20 6E 65 78
  75++4C7D 74 20 73 6F
  75++4C81 6E 67 20 5B
  75++4C85 42 41 43 4B
  75++4C89 53 50 41 43
  75++4C8D 45 5D 20 66
  75++4C91 6F 72 20 73
  75++4C95 74 6F 70 20
  75++4C99 70 6C 61 79
  75++4C9D 69 6E 67 2E
  75++4CA1 00
  76++4CA2
  77++4CA2              CMD_GET_SONG_POSITION     = #60
  78++4CA2 00           last_song_position db 0
  79++4CA3
  80++4CA3              ;; Control ports
  81++4CA3              CMD  = 187
  82++4CA3              DATA = 179
  83++4CA3                  endif
  84++4CA3                  ENDMODULE
  85++4CA3
# file closed: player/mod-processor.asm
  31+ 4CA3              start:
  32+ 4CA3              outputBuffer:
  33+ 4CA3 31 00 40             ld sp, 0x4000
  34+ 4CA6 0E EA                ld c,nos.CMD_SETSYSDRV
  35+ 4CA8 08                	ex af,af'
  36+ 4CA9 CD 05 00     	    call nos.BDOS
  37+ 4CAC              	ELSE
  38+ 4CAC ~                    include "player/vortex-processor.asm"
  39+ 4CAC ~                    include "player/mod-processor.asm"
  40+ 4CAC ~                    include "screen/screen.asm"
  41+ 4CAC ~            start:
  42+ 4CAC ~            outputBuffer:
  43+ 4CAC ~                    di
  44+ 4CAC ~                    xor a
  44+ 4CAC ~              ld (#5c6a), a  ; Thank you, Mario Prato, for feedback
  45+ 4CAC ~                    ld (#5c00),a
  46+ 4CAC ~                    ld sp, asmOrg
  47+ 4CAC ~                    call Memory.init
  48+ 4CAC ~                    xor a
  48+ 4CAC ~              out (#fe),a
  49+ 4CAC ~                    ei
  50+ 4CAC ~
  51+ 4CAC ~                    ld a, 7
  51+ 4CAC ~              call Memory.setPage
  52+ 4CAC ~                    ;; Logo
  53+ 4CAC ~                    ld hl, logo, b, Dos.FMODE_READ
  53+ 4CAC ~              call Dos.fopen
  54+ 4CAC ~                    push af
  55+ 4CAC ~                    ld hl, #c000, bc, 6912
  55+ 4CAC ~              call Dos.fread
  56+ 4CAC ~                    pop af
  57+ 4CAC ~                    call Dos.fclose
  58+ 4CAC ~
  59+ 4CAC ~                    ld b, 50
  60+ 4CAC ~            1       halt
  61+ 4CAC ~                    djnz 1b
  62+ 4CAC                  ENDIF
  63+ 4CAC
  64+ 4CAC CD 07 01         call TextMode.init
  65+ 4CAF 21 BB 4C     	ld hl, initing
  65+ 4CB2 CD 27 01       call TextMode.printZ
  66+ 4CB5
  67+ 4CB5                  IFNDEF NOINIT
  68+ 4CB5 CD F1 1D       	    call Wifi.init
  69+ 4CB8                  ENDIF
  70+ 4CB8
  71+ 4CB8 C3 2F 09         jp History.home
  72+ 4CBB
  73+ 4CBB 49 6E 69 74  initing db "Initing Wifi...", "\r\n", 0
  73+ 4CBF 69 6E 67 20
  73+ 4CC3 57 69 66 69
  73+ 4CC7 2E 2E 2E 0D
  73+ 4CCB 0A 00
  74+ 4CCD 62 72 6F 77  logo    db "browser/logo.scr", 0
  74+ 4CD1 73 65 72 2F
  74+ 4CD5 6C 6F 67 6F
  74+ 4CD9 2E 73 63 72
  74+ 4CDD 00
  75+ 4CDE 62 72 6F 77  creds   db "browser/auth.pwd", 0
  75+ 4CE2 73 65 72 2F
  75+ 4CE6 61 75 74 68
  75+ 4CEA 2E 70 77 64
  75+ 4CEE 00
  76+ 4CEF              outputBuffer2:
  77+ 4CEF 41 54 45 30      db  "ATE0", 0
  77+ 4CF3 00
  78+ 4CF4                  display "ENDS: ", $
  79+ 4CF4                  display "Buff size", #ffff - $
  80+ 4CF4
  81+ 4CF4              	IFDEF TRDOS
  82+ 4CF4 ~            		SAVETRD "TRD/MRF.TRD",|BINNAME,asmOrg, $ - asmOrg
  83+ 4CF4              	        ELSE
  84+ 4CF4              			    savebin "mrf.com", asmOrg, $ - asmOrg
  85+ 4CF4                 	ENDIF
  86+ 4CF4
# file closed: main-all.asm
  17  4CF4                  ENDIF
# file closed: main.asm
