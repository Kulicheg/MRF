# file opened: main.asm
   1  0000                  DEFINE TCP_BUF_SIZE 1024
   2  0000              ; Generate version string
   3  0000                  LUA ALLPASS
   4  0000 ~                v = tostring(sj.get_define("V"))
   5  0000 ~                maj = string.sub(v, 1,1)
   6  0000 ~                min = string.sub(v, 2,2)
   7  0000 ~                sj.insert_define("VERSION_STRING", "\"" .. maj .. "." .. min .. "\"")
   8  0000 ~
   9  0000 ~                b = tostring(sj.get_define("BLD"))
  10  0000 ~                sj.insert_define("BUILD_STRING", "\"" .. b .. "\"")
  11  0000                  ENDLUA
  12  0000
  13  0000                  IFDEF MSX
  14  0000 ~                    include "main-msx.asm"
  15  0000                  ELSE
  16  0000                      include "main-all.asm"
# file opened: main-all.asm
   1+ 0000                  device	zxspectrum128
   2+ 0000                  IFDEF NEDOOS
   3+ 0000 ~            	DEFINE CRLF "\r\n"
   4+ 0000 ~                    MODULE nos
   5+ 0000 ~                        include "../_sdk/sysdefs.asm"
   6+ 0000 ~                    ENDMODULE
   7+ 0000 ~                    org nos.PROGSTART
   8+ 0000                      ELSE
   9+ 0000              	DEFINE CRLF "\r"
  10+ 0000                      org 24576
  11+ 6000                  ENDIF
  12+ 6000              asmOrg:
  13+ 6000                  align 256
  14+ 6000 C3 44 99         jp start
  15+ 6003                  include "vdp/index.asm"
# file opened: vdp/index.asm
   1++6003                  IFDEF TIMEX
   2++6003 ~                include "timex.asm"
   3++6003                  ENDIF
   4++6003
   5++6003                  IFDEF TIMEX80
   6++6003 ~                include "timex80.asm"
   7++6003                  ENDIF
   8++6003
   9++6003                  IFDEF ZXSCR
  10++6003                  include "zx.asm"
# file opened: vdp/zx.asm
   1++6003              COLOR=1
   2++6003              ;; Usual speccy screen driver
   3++6003                  module TextMode
   4++6003              init:
   5++6003 21 D5 61 06      ld hl, font_file, b, Dos.FMODE_READ
   5++6007 01
   6++6008 CD 88 6C         call Dos.fopen
   7++600B F5               push af
   8++600C 01 00 08 21      ld bc, 2048, hl, font64
   8++6010 00 40
   9++6012 CD CE 6E         call Dos.fread
  10++6015 F1               pop af
  11++6016 CD D3 6D         call Dos.fclose
  12++6019 AF           	xor a
  12++601A D3 FE          out (#fe), a
  13++601C C9           	ret
  14++601D              cls:
  15++601D 11 00 00         ld de, 0
  15++6020 CD 3A 60       call gotoXY
  16++6023 3E 07            ld a, 7
  16++6025 CD 20 8C       call Memory.setPage
  17++6028 AF               xor a
  17++6029 D3 FE          out (#fe), a
  18++602B 21 00 C0 11      ld hl, #c000, de, #c001, bc, 6911, (hl), a
  18++602F 01 C0 01 FF
  18++6033 1A 77
  18++6035 ED B0          ldir
  19++6037 C3 20 8C         jp Memory.setPage
  20++603A
  21++603A
  22++603A              ; Set console coordinates
  23++603A              ; d = row(0..23), e = column (0..63)
  24++603A              gotoXY:
  25++603A              	;rr e;;;
  26++603A CB 3B        	srl e
  27++603C 3E 00        	ld a, 0
  28++603E 32 62 63     	ld (half_tile_screen), a
  29++6041 ED 53 60 63      ld (col_screen), de
  30++6045 C9               ret
  31++6046
  32++6046              disable:
  33++6046                  ; Nothing to disable
  34++6046 C9               ret
  35++6047
  36++6047              ; H - line
  37++6047              ; A - char
  38++6047              fillLine:
  39++6047 F5               push af
  40++6048 54 1E 00         ld d, h, e, 0
  40++604B CD 3A 60       call gotoXY
  41++604E F1               pop af
  42++604F 21 69 63 11      ld hl, fill_buff, de, fill_buff + 1, bc, 63, (hl), a
  42++6053 6A 63 01 3F
  42++6057 00 77
  42++6059 ED B0          ldir
  43++605B 21 69 63         ld hl, fill_buff
  43++605E C3 BC 60       jp printZ
  44++6061
  45++6061              usualLine:
  46++6061 47               ld b, a
  47++6062 0E 00            ld c, 0
  48++6064 CD 79 61         call bc_to_attr
  49++6067 3E 07            ld a, 7
  49++6069 CD 20 8C       call Memory.setPage
  50++606C 36 07            ld (hl), #7
  51++606E 54 5D            ld de, hl
  52++6070 13               inc de
  53++6071 01 1F 00         ld bc, 31
  54++6074 ED B0            ldir
  55++6076 AF               xor a
  55++6077 CD 20 8C       call Memory.setPage
  56++607A C9               ret
  57++607B
  58++607B              highlightLine:
  59++607B 47               ld b, a
  60++607C 0E 00            ld c, 0
  61++607E CD 79 61         call bc_to_attr
  62++6081 3E 07            ld a, 7
  62++6083 CD 20 8C       call Memory.setPage
  63++6086 36 0C            ld (hl), #C
  64++6088 54 5D            ld de, hl
  65++608A 13               inc de
  66++608B 01 1F 00         ld bc, 31
  67++608E ED B0            ldir
  68++6090 AF               xor a
  68++6091 CD 20 8C       call Memory.setPage
  69++6094 C9               ret
  70++6095
  71++6095              mvCR
  72++6095 ED 5B 60 63  	ld de, (col_screen)
  73++6099 14           	inc d
  74++609A 1E 00        	ld e, 0
  75++609C 3E 00        	ld a, 0
  76++609E 32 62 63     	ld (half_tile_screen), a
  77++60A1 C3 3A 60     	jp gotoXY
  78++60A4
  79++60A4              ; Print just one symbol
  80++60A4              ; A - symbol
  81++60A4              putC
  82++60A4 FE 0D            cp 13
  82++60A6 CA 95 60       jp z, mvCR
  83++60A9 21 68 63     	ld hl, single_symbol
  84++60AC 77           	ld (hl), a
  85++60AD 3E 07        	ld a, 7
  85++60AF CD 20 8C       call Memory.setPage
  86++60B2 21 67 63         ld hl, single_symbol_print
  87++60B5 CD C7 60         call printL
  88++60B8 AF               xor a
  88++60B9 C3 20 8C       jp Memory.setPage
  89++60BC
  90++60BC              ; Put string
  91++60BC              ; hl - string pointer that's begins from symbol count
  92++60BC              printZ
  93++60BC 7E               ld a, (hl)
  93++60BD A7             and a
  93++60BE C8             ret z
  94++60BF E5               push hl
  95++60C0 CD A4 60         call putC
  96++60C3 E1               pop hl
  97++60C4 23               inc hl
  98++60C5 18 F5            jr printZ
  99++60C7
 100++60C7              printL
 101++60C7 7E                   ld	a, (hl)
 102++60C8 A7           		and	a
 103++60C9 C8           		ret	z
 104++60CA
 105++60CA E5           		push	hl
 106++60CB CD 75 61     		call	calc_addr_attr
 107++60CE 3A 63 63     		ld	a,(attr_screen)
 108++60D1 77           		ld	(hl),a
 109++60D2 E1           		pop	hl
 110++60D3
 111++60D3 CD 64 61     		call	calc_addr_scr
 112++60D6
 113++60D6 3A 62 63     		ld	a,(half_tile_screen)
 114++60D9 CB 47        		bit	0,a
 115++60DB 7E           		ld	a,(hl)
 116++60DC C2 10 61     		jp	nz,print64_4
 117++60DF              print64_3
 118++60DF F5                   push    af
 119++60E0 E5           		push	hl
 120++60E1 CD 75 61     		call	calc_addr_attr
 121++60E4 3A 63 63     		ld	a,(attr_screen)
 122++60E7 77           		ld	(hl),a
 123++60E8 E1           		pop	hl
 124++60E9
 125++60E9 23                   inc     hl
 126++60EA E5                   push    hl
 127++60EB
 128++60EB 7E                   ld      a,(hl)
 129++60EC 6F           		ld	l,a
 130++60ED 26 00        		ld	h,0
 131++60EF 29           		add	hl,hl
 132++60F0 29           		add	hl,hl
 133++60F1 29           		add	hl,hl
 134++60F2 01 00 40             ld      bc,font64
 135++60F5 09                   add     hl,bc
 136++60F6
 137++60F6 D5                   push    de
 138++60F7
 139++60F7 06 06                ld      b,6
 140++60F9 AF           		xor	a
 141++60FA 12           		ld	(de),a
 142++60FB              print64_1
 143++60FB 14           	inc     d
 144++60FC 7E           	ld      a,(hl)
 145++60FD E6 F0        	and	#f0
 146++60FF 12           	ld      (de),a
 147++6100 23           	inc     hl
 148++6101 10 F8        	djnz    print64_1
 149++6103
 150++6103 14           	inc	d
 151++6104 AF           	xor	a
 152++6105 12           	ld	(de),a
 153++6106
 154++6106 3E 01        	ld	a,1
 155++6108 32 62 63     	ld	(half_tile_screen),a
 156++610B
 157++610B D1           	pop     de
 158++610C E1           	pop     hl
 159++610D F1           	pop     af
 160++610E
 161++610E 3D           	dec     a
 162++610F C8           	ret     z
 163++6110
 164++6110              print64_4
 165++6110 F5           	push    af
 166++6111
 167++6111 23           	inc     hl
 168++6112 E5           	push    hl
 169++6113
 170++6113 7E           	ld      a,(hl)
 171++6114 6F           	ld	l,a
 172++6115 26 00        	ld	h,0
 173++6117 29           	add	hl,hl
 174++6118 29           	add	hl,hl
 175++6119 29           	add	hl,hl
 176++611A 01 00 40     	ld      bc,font64
 177++611D 09           	add     hl,bc
 178++611E
 179++611E D5           	push    de
 180++611F
 181++611F 06 06        	ld      b,6
 182++6121 AF           	xor	a
 183++6122 12           	ld	(de),a
 184++6123              print64_2
 185++6123 14           	inc     d
 186++6124 7E           	ld      a,(hl)
 187++6125 E6 0F        	and     #0f
 188++6127 4F           	ld      c,a
 189++6128 1A           	ld      a,(de)
 190++6129 B1           	or      c
 191++612A 12           	ld      (de),a
 192++612B 23           	inc     hl
 193++612C 10 F5        	djnz    print64_2
 194++612E
 195++612E 14           	inc	d
 196++612F AF           	xor	a
 197++6130 12           	ld	(de),a
 198++6131
 199++6131 32 62 63     	ld	(half_tile_screen),a
 200++6134
 201++6134 D1           	pop     de
 202++6135
 203++6135 CD 3F 61     	call	move_cr64
 204++6138
 205++6138 E1           	pop     hl
 206++6139 F1           	pop     af
 207++613A 3D           	dec     a
 208++613B
 209++613B C2 DF 60     	jp      nz,print64_3
 210++613E
 211++613E C9           	ret
 212++613F
 213++613F              ; move cursor
 214++613F              move_cr64
 215++613F 13           	inc	de
 216++6140
 217++6140 21 60 63     	ld	hl,col_screen
 218++6143 34           	inc	(hl)
 219++6144 7E           	ld	a,(hl)
 220++6145
 221++6145 FE 20        	cp	32
 222++6147 D8           	ret	c
 223++6148
 224++6148 AF           	xor	a
 225++6149 32 62 63     	ld	(half_tile_screen),a
 226++614C 77           	ld	(hl),a
 227++614D 4F           	ld	c,a
 228++614E
 229++614E 23           	inc	hl
 230++614F 34           	inc	(hl)
 231++6150 7E           	ld	a,(hl)
 232++6151 47           	ld	b,a
 233++6152
 234++6152 FE 18        	cp	24
 235++6154 DA 60 61     	jp	c,move_cr64_01
 236++6157
 237++6157 3E 17        	ld	a,23
 238++6159 77           	ld	(hl),a
 239++615A 47           	ld	b,a
 240++615B
 241++615B C5           	push	bc
 242++615C CD 89 61     	call	scroll_up8
 243++615F C1           	pop	bc
 244++6160
 245++6160              move_cr64_01
 246++6160 CD 64 61     	call	calc_addr_scr
 247++6163 C9           	ret
 248++6164
 249++6164              calc_addr_scr
 250++6164 78           	ld      a,b
 251++6165 57           	ld      d,a
 252++6166 0F           	rrca
 253++6167 0F           	rrca
 254++6168 0F           	rrca
 255++6169 A7 E6 E0     	and     a,224
 256++616C 81           	add     a,c
 257++616D 5F           	ld      e,a
 258++616E 7A           	ld      a,d
 259++616F E6 18        	and     24
 260++6171 F6 C0        	or      #c0
 261++6173 57           	ld      d,a
 262++6174 C9           	ret
 263++6175
 264++6175              calc_addr_attr
 265++6175 ED 4B 60 63  	ld	bc,(col_screen)
 266++6179              bc_to_attr:
 267++6179 78           	ld	a,b
 268++617A 0F           	rrca
 269++617B 0F           	rrca
 270++617C 0F           	rrca
 271++617D 6F           	ld	l,a
 272++617E E6 1F        	and	31
 273++6180 F6 D8        	or	#d8
 274++6182 67           	ld	h,a
 275++6183 7D           	ld	a,l
 276++6184 E6 FC        	and	252
 277++6186 B1           	or	c
 278++6187 6F           	ld	l,a
 279++6188 C9           	ret
 280++6189
 281++6189              scroll_up8
 282++6189 21 E0 61     	ld	hl,table_addr_scr
 283++618C 06 B8        	ld	b,184
 284++618E
 285++618E              scroll_up8_01
 286++618E C5           	push	bc
 287++618F
 288++618F 5E           	ld	e,(hl)
 289++6190 23           	inc	hl
 290++6191 56           	ld	d,(hl)
 291++6192 23           	inc	hl
 292++6193
 293++6193 E5           	push	hl
 294++6194
 295++6194 01 0E 00     	ld	bc,14
 296++6197 09           	add	hl,bc
 297++6198 4E           	ld	c,(hl)
 298++6199 23           	inc	hl
 299++619A 46           	ld	b,(hl)
 300++619B
 301++619B 60           	ld	h,b
 302++619C 69           	ld	l,c
 303++619D
 304++619D 01 20 00     	ld	bc,32
 305++61A0 ED B0        	ldir
 306++61A2
 307++61A2 E1           	pop	hl
 308++61A3 C1           	pop	bc
 309++61A4 10 E8        	djnz	scroll_up8_01
 310++61A6
 311++61A6 06 08        	ld	b,8
 312++61A8
 313++61A8              scroll_up8_02
 314++61A8 C5           	push	bc
 315++61A9
 316++61A9 5E           	ld	e,(hl)
 317++61AA 23           	inc	hl
 318++61AB 56           	ld	d,(hl)
 319++61AC 23           	inc	hl
 320++61AD
 321++61AD E5           	push	hl
 322++61AE
 323++61AE 62           	ld	h,d
 324++61AF 6B           	ld	l,e
 325++61B0 13           	inc	de
 326++61B1 36 00        	ld	(hl),0
 327++61B3 01 1F 00     	ld	bc,31
 328++61B6 ED B0        	ldir
 329++61B8
 330++61B8 E1           	pop	hl
 331++61B9 C1           	pop	bc
 332++61BA 10 EC        	djnz	scroll_up8_02
 333++61BC 11 00 D8 21  	ld	de,#D800, hl,#D820, bc,736
 333++61C0 20 D8 01 E0
 333++61C4 02
 334++61C5 ED B0        	ldir
 335++61C7 1A           	ld	a,(de)
 336++61C8 21 E0 DA 11  	ld	hl,#dae0, de,#dae1, (hl),a, bc,31
 336++61CC E1 DA 77 01
 336++61D0 1F 00
 337++61D2 ED B0        	ldir
 338++61D4
 339++61D4 C9           	ret
 340++61D5
 341++61D5              font64 equ #4000 ; Using ZX-Spectrum screen as font buffer
 342++61D5 66 6F 6E 74  font_file db "font64.bin", 0
 342++61D9 36 34 2E 62
 342++61DD 69 6E 00
 343++61E0
 344++61E0
 345++61E0              table_addr_scr
 346++61E0 00 40 00 41  	defw	#4000,#4100,#4200,#4300,#4400,#4500,#4600,#4700
 346++61E4 00 42 00 43
 346++61E8 00 44 00 45
 346++61EC 00 46 00 47
 347++61F0 20 40 20 41  	defw	#4020,#4120,#4220,#4320,#4420,#4520,#4620,#4720
 347++61F4 20 42 20 43
 347++61F8 20 44 20 45
 347++61FC 20 46 20 47
 348++6200 40 40 40 41  	defw	#4040,#4140,#4240,#4340,#4440,#4540,#4640,#4740
 348++6204 40 42 40 43
 348++6208 40 44 40 45
 348++620C 40 46 40 47
 349++6210 60 40 60 41  	defw	#4060,#4160,#4260,#4360,#4460,#4560,#4660,#4760
 349++6214 60 42 60 43
 349++6218 60 44 60 45
 349++621C 60 46 60 47
 350++6220 80 40 80 41  	defw	#4080,#4180,#4280,#4380,#4480,#4580,#4680,#4780
 350++6224 80 42 80 43
 350++6228 80 44 80 45
 350++622C 80 46 80 47
 351++6230 A0 40 A0 41  	defw	#40a0,#41a0,#42a0,#43a0,#44a0,#45a0,#46a0,#47a0
 351++6234 A0 42 A0 43
 351++6238 A0 44 A0 45
 351++623C A0 46 A0 47
 352++6240 C0 40 C0 41  	defw	#40c0,#41c0,#42c0,#43c0,#44c0,#45c0,#46c0,#47c0
 352++6244 C0 42 C0 43
 352++6248 C0 44 C0 45
 352++624C C0 46 C0 47
 353++6250 E0 40 E0 41  	defw	#40e0,#41e0,#42e0,#43e0,#44e0,#45e0,#46e0,#47e0
 353++6254 E0 42 E0 43
 353++6258 E0 44 E0 45
 353++625C E0 46 E0 47
 354++6260
 355++6260 00 48 00 49  	defw	#4800,#4900,#4a00,#4b00,#4c00,#4d00,#4e00,#4f00
 355++6264 00 4A 00 4B
 355++6268 00 4C 00 4D
 355++626C 00 4E 00 4F
 356++6270 20 48 20 49  	defw	#4820,#4920,#4a20,#4b20,#4c20,#4d20,#4e20,#4f20
 356++6274 20 4A 20 4B
 356++6278 20 4C 20 4D
 356++627C 20 4E 20 4F
 357++6280 40 48 40 49  	defw	#4840,#4940,#4a40,#4b40,#4c40,#4d40,#4e40,#4f40
 357++6284 40 4A 40 4B
 357++6288 40 4C 40 4D
 357++628C 40 4E 40 4F
 358++6290 60 48 60 49  	defw	#4860,#4960,#4a60,#4b60,#4c60,#4d60,#4e60,#4f60
 358++6294 60 4A 60 4B
 358++6298 60 4C 60 4D
 358++629C 60 4E 60 4F
 359++62A0 80 48 80 49  	defw	#4880,#4980,#4a80,#4b80,#4c80,#4d80,#4e80,#4f80
 359++62A4 80 4A 80 4B
 359++62A8 80 4C 80 4D
 359++62AC 80 4E 80 4F
 360++62B0 A0 48 A0 49  	defw	#48a0,#49a0,#4aa0,#4ba0,#4ca0,#4da0,#4ea0,#4fa0
 360++62B4 A0 4A A0 4B
 360++62B8 A0 4C A0 4D
 360++62BC A0 4E A0 4F
 361++62C0 C0 48 C0 49  	defw	#48c0,#49c0,#4ac0,#4bc0,#4cc0,#4dc0,#4ec0,#4fc0
 361++62C4 C0 4A C0 4B
 361++62C8 C0 4C C0 4D
 361++62CC C0 4E C0 4F
 362++62D0 E0 48 E0 49  	defw	#48e0,#49e0,#4ae0,#4be0,#4ce0,#4de0,#4ee0,#4fe0
 362++62D4 E0 4A E0 4B
 362++62D8 E0 4C E0 4D
 362++62DC E0 4E E0 4F
 363++62E0
 364++62E0 00 50 00 51  	defw	#5000,#5100,#5200,#5300,#5400,#5500,#5600,#5700
 364++62E4 00 52 00 53
 364++62E8 00 54 00 55
 364++62EC 00 56 00 57
 365++62F0 20 50 20 51  	defw	#5020,#5120,#5220,#5320,#5420,#5520,#5620,#5720
 365++62F4 20 52 20 53
 365++62F8 20 54 20 55
 365++62FC 20 56 20 57
 366++6300 40 50 40 51  	defw	#5040,#5140,#5240,#5340,#5440,#5540,#5640,#5740
 366++6304 40 52 40 53
 366++6308 40 54 40 55
 366++630C 40 56 40 57
 367++6310 60 50 60 51  	defw	#5060,#5160,#5260,#5360,#5460,#5560,#5660,#5760
 367++6314 60 52 60 53
 367++6318 60 54 60 55
 367++631C 60 56 60 57
 368++6320 80 50 80 51  	defw	#5080,#5180,#5280,#5380,#5480,#5580,#5680,#5780
 368++6324 80 52 80 53
 368++6328 80 54 80 55
 368++632C 80 56 80 57
 369++6330 A0 50 A0 51  	defw	#50a0,#51a0,#52a0,#53a0,#54a0,#55a0,#56a0,#57a0
 369++6334 A0 52 A0 53
 369++6338 A0 54 A0 55
 369++633C A0 56 A0 57
 370++6340 C0 50 C0 51  	defw	#50c0,#51c0,#52c0,#53c0,#54c0,#55c0,#56c0,#57c0
 370++6344 C0 52 C0 53
 370++6348 C0 54 C0 55
 370++634C C0 56 C0 57
 371++6350 E0 50 E0 51  	defw	#50e0,#51e0,#52e0,#53e0,#54e0,#55e0,#56e0,#57e0
 371++6354 E0 52 E0 53
 371++6358 E0 54 E0 55
 371++635C E0 56 E0 57
 372++6360
 373++6360
 374++6360 00           col_screen			db	0
 375++6361 00           row_screen			db	0
 376++6362 00           half_tile_screen	db	0
 377++6363 07           attr_screen			db	07
 378++6364
 379++6364 00 00        col_screen_temp			dw	0
 380++6366 00           half_tile_screen_temp	db	0
 381++6367
 382++6367 01           single_symbol_print db 1
 383++6368 00           single_symbol 		db 0
 384++6369
 385++6369 00 00 00...  fill_buff ds 65
 386++63AA
 387++63AA                  endmodule
# file closed: vdp/zx.asm
  11++63AA                  ENDIF
  12++63AA
  13++63AA              	IFDEF NEDOOS
  14++63AA ~                include "nedotext.asm"
  15++63AA                  ENDIF
# file closed: vdp/index.asm
  16+ 63AA                  include "utils/index.asm"
# file opened: utils/index.asm
   1++63AA                  include "atoi.asm"
# file opened: utils/atoi.asm
   1++63AA              ; DE - buffer
   2++63AA              ; HL - output
   3++63AA              atohl:
   4++63AA 21 00 00         ld hl, 0
   5++63AD              .loop
   6++63AD 1A               ld a, (de)
   7++63AE 13               inc de
   8++63AF                  ; Sepparators
   9++63AF C5 E5            push bc, hl
  10++63B1 01 05 00             ld bc, sepparators_len
  11++63B4 21 CC 63             ld hl, sepparators
  12++63B7 ED B1                cpir
  13++63B9 E1 C1            pop hl, bc
  14++63BB C8               ret z
  15++63BC
  16++63BC D6 30            sub '0'
  17++63BE
  18++63BE C5               push bc
  19++63BF 4D                   ld c, l
  20++63C0 44                   ld b, h
  21++63C1
  22++63C1 29                   add hl, hl
  23++63C2 29                   add hl, hl
  24++63C3 09                   add hl, bc
  25++63C4 29                   add hl, hl
  26++63C5 4F                   ld c, a
  27++63C6 06 00                ld b, 0
  28++63C8 09                   add hl, bc
  29++63C9 C1               pop bc
  30++63CA 18 E1            jr .loop
  31++63CC
# file closed: utils/atoi.asm
   2++63CC                  include "constants.asm"
# file opened: utils/constants.asm
   1++63CC              TAB = 9
   2++63CC              CR = 13
   3++63CC              LF = 10
   4++63CC              NULL = 0
   5++63CC              SPACE = ' '
   6++63CC              ESC = 27
   7++63CC              BACKSPACE = 8
   8++63CC
   9++63CC                  IFDEF TIMEX80
  10++63CC ~            MIME_DOWNLOAD 	= #19
  11++63CC ~            MIME_LINK 		= #1A
  12++63CC ~            MIME_TEXT 		= #10
  13++63CC ~            MIME_IMAGE 		= #01
  14++63CC ~            MIME_MUSIC 		= #0e
  15++63CC ~            MIME_INPUT 		= #b3
  16++63CC ~            MIME_MOD 		= #0d
  17++63CC ~
  18++63CC ~            BORDER_TOP = #b2
  19++63CC ~            BORDER_BOTTOM = #b1
  20++63CC                  ELSE
  21++63CC              	IFDEF MSX
  22++63CC ~            MIME_DOWNLOAD 	= 1
  23++63CC ~            MIME_LINK		= 2
  24++63CC ~            MIME_TEXT 		= 3
  25++63CC ~            MIME_IMAGE 		= 4
  26++63CC ~            MIME_MUSIC 		= 5
  27++63CC ~            MIME_INPUT 		= 6
  28++63CC ~            MIME_MOD      	= 7
  29++63CC ~            BORDER_TOP    = 7
  30++63CC ~            BORDER_BOTTOM = 8
  31++63CC              	ELSE
  32++63CC              MIME_DOWNLOAD = 1
  33++63CC              MIME_LINK     = 2
  34++63CC              MIME_TEXT     = 3
  35++63CC              MIME_IMAGE    = 6
  36++63CC              MIME_MUSIC    = 5
  37++63CC              MIME_INPUT    = 4
  38++63CC              MIME_MOD      = 7
  39++63CC
  40++63CC              BORDER_TOP    = 9
  41++63CC              BORDER_BOTTOM = 8
  42++63CC              	ENDIF
  43++63CC
  44++63CC
  45++63CC
  46++63CC
  47++63CC              	ENDIF
  48++63CC
  49++63CC 0D 0A 09 00  sepparators db CR, LF, TAB, NULL, SPACE
  49++63D0 20
  50++63D1              sepparators_len = $ - sepparators
# file closed: utils/constants.asm
   3++63D1                  include "strutils.asm"
# file opened: utils/strutils.asm
   1++63D1              ; de - pointer
   2++63D1              ; hl - count
   3++63D1              strlen:
   4++63D1 21 00 00         ld hl, 0
   5++63D4              .loop
   6++63D4 1A               ld a, (de)
   7++63D5 A7               and a
   7++63D6 28 04          jr z, .exit
   8++63D8 23               inc hl
   9++63D9 13               inc de
  10++63DA 18 F8            jr .loop
  11++63DC              .exit
  12++63DC C9               ret
  13++63DD
  14++63DD                  module CompareBuff
  15++63DD
  16++63DD              ; Pushes A to buffer
  17++63DD              push
  18++63DD F5               push af
  19++63DE 06 20            ld b, 32
  19++63E0 21 29 64       ld hl, buffer + 1
  19++63E3 11 28 64       ld de, buffer
  20++63E6              .loop
  21++63E6 7E               ld a, (hl)
  21++63E7 12             ld (de), a
  21++63E8 23             inc hl
  21++63E9 13             inc de
  21++63EA 10 FA          djnz .loop
  22++63EC F1               pop af
  23++63ED 21 47 64         ld hl, buffer + 31
  23++63F0 77             ld (hl), a
  24++63F1 C9               ret
  25++63F2
  26++63F2              ; HL - Compare string(null terminated)
  27++63F2              ; A - 0 NOT Found
  28++63F2              ;     1 Found
  29++63F2              search:
  30++63F2 06 00            ld b, 0
  30++63F4 E5             push hl
  31++63F5              .loop:
  32++63F5 7E               ld a, (hl)
  32++63F6 23             inc hl
  32++63F7 04             inc b
  32++63F8 A7             and a
  32++63F9 C2 F5 63       jp nz, .loop
  33++63FC 05               dec b
  33++63FD E1             pop hl
  33++63FE C5             push bc
  33++63FF E5             push hl
  34++6400 E1               pop hl
  35++6401 11 48 64         ld de, buffer + 32
  36++6404              .sourceLoop
  37++6404 1B               dec de
  37++6405 10 FD          djnz .sourceLoop
  38++6407 C1               pop bc
  39++6408              .compare
  40++6408 C5               push bc
  40++6409 F5             push af
  41++640A 1A               ld a, (de)
  41++640B 47             ld b, a
  42++640C F1               pop af
  42++640D 7E             ld a, (hl)
  42++640E B8             cp b
  42++640F C1             pop bc
  42++6410 3E 00          ld a, 0
  42++6412 C0             ret nz
  43++6413 13               inc de
  43++6414 23             inc hl
  44++6415 10 F1            djnz .compare
  45++6417 3E 01            ld a, 1
  46++6419 C9               ret
  47++641A
  48++641A              clear:
  49++641A AF               xor a
  49++641B 21 28 64       ld hl, buffer
  49++641E 11 29 64       ld de, buffer + 1
  49++6421 01 20 00       ld bc, 32
  49++6424 77             ld (hl), a
  49++6425 ED B0          ldir
  50++6427 C9               ret
  51++6428
  52++6428 00 00 00...  buffer ds 32
  53++6448
  54++6448                  endmodule
# file closed: utils/strutils.asm
   4++6448                  IFDEF MSX
   5++6448 ~            	    include "bios.asm"
   6++6448                  ENDIF
   7++6448                  include "screen.asm"
# file opened: utils/screen.asm
   1++6448              LINE_LIMIT = 63
   2++6448
   3++6448                  IFDEF NEDOOS
   4++6448 ~            LINE_LIMIT = 79
   5++6448                  ENDIF
   6++6448
   7++6448                  IFDEF TIMEX80
   8++6448 ~            LINE_LIMIT = 84
   9++6448                  ENDIF
  10++6448
  11++6448                  IFDEF MSX
  12++6448 ~            LINE_LIMIT = 79
  13++6448                  ENDIF
  14++6448              ; HL - string pointer
  15++6448              print70Text:
  16++6448 06 3F            ld b, LINE_LIMIT
  17++644A              .loop
  18++644A 7E               ld a, (hl)
  19++644B A7               and a
  19++644C C8             ret z
  20++644D FE 0D            cp 13
  20++644F C8             ret z
  21++6450 FE 0A            cp 10
  21++6452 C8             ret z
  22++6453 C5               push bc
  23++6454 E5               push hl
  24++6455 CD A4 60         call TextMode.putC
  25++6458 E1               pop hl
  26++6459 23               inc hl
  27++645A C1               pop bc
  28++645B 05               dec b
  29++645C 78               ld a, b
  29++645D A7             and a
  29++645E C8             ret z
  30++645F C3 4A 64         jp .loop
  31++6462
  32++6462              ; HL - string pointer
  33++6462              print70Goph:
  34++6462 06 3F            ld b, LINE_LIMIT
  35++6464              .loop
  36++6464 7E               ld a, (hl)
  36++6465 FE 09          cp 09
  36++6467 C8             ret z
  37++6468 A7               and a
  37++6469 C8             ret z
  38++646A C5               push bc
  39++646B E5               push hl
  40++646C CD A4 60         call TextMode.putC
  41++646F E1               pop hl
  42++6470 23               inc hl
  43++6471 C1               pop bc
  44++6472 05               dec b
  45++6473 78               ld a, b
  45++6474 A7             and a
  45++6475 C8             ret z
  46++6476 C3 64 64         jp .loop
# file closed: utils/screen.asm
# file closed: utils/index.asm
  17+ 6479                  include "gopher/render/index.asm"
# file opened: gopher/render/index.asm
   1++6479                  MODULE Render
   2++6479              PER_PAGE = 22
   3++6479              CURSOR_OFFSET = 2
   4++6479                  include "row.asm"
# file opened: gopher/render/row.asm
   1++6479              ; A - row number
   2++6479              ; HL - pointer to row
   3++6479              renderRow:
   4++6479 C6 02            add CURSOR_OFFSET
   5++647B 57               ld d,a
   6++647C 1E 00            ld e,0
   7++647E CD 3A 60         call TextMode.gotoXY
   8++6481 7E               ld a,(hl)
   9++6482 E5               push hl
  10++6483 CD 8E 64         call getIcon
  11++6486 CD A4 60         call TextMode.putC
  12++6489 E1               pop hl
  13++648A 23               inc hl
  14++648B C3 62 64         jp print70Goph
  15++648E
  16++648E              ; A - gopher id char
  17++648E              getIcon:
  18++648E FE 69            cp 'i'
  18++6490 CA AA 64       jp z, .info
  19++6493 FE 39            cp '9'
  19++6495 CA AD 64       jp z, .down
  20++6498 FE 31            cp '1'
  20++649A CA 19 65       jp z, .page
  21++649D FE 30            cp '0'
  21++649F CA 1C 65       jp z, .text
  22++64A2 FE 37            cp '7'
  22++64A4 CA 1F 65       jp z, .input
  23++64A7 3E 20            ld a, ' '
  24++64A9 C9               ret
  25++64AA              .info
  26++64AA 3E 20            ld a, SPACE
  26++64AC C9             ret
  27++64AD              .down
  28++64AD 54 5D            ld de, hl
  29++64AF 01 FF 00 3E      ld bc, #ff, a, TAB
  29++64B3 09
  29++64B4 ED B1          cpir
  30++64B6 78               ld a, b
  30++64B7 B1             or c
  30++64B8 28 5C          jr z, .downExit
  31++64BA D5               push de
  32++64BB              .nameLoop
  33++64BB 7E               ld a, (hl)
  33++64BC A7             and a
  33++64BD 28 10          jr z, .check
  34++64BF FE 09            cp TAB
  34++64C1 28 0C          jr z, .check
  35++64C3 FE 0D            cp CR
  35++64C5 28 08          jr z, .check
  36++64C7 E5               push hl
  37++64C8 CD DD 63         call CompareBuff.push
  38++64CB E1               pop hl
  39++64CC 23               inc hl
  40++64CD 18 EC            jr .nameLoop
  41++64CF              .check
  42++64CF 3A 5B 65     	ld a,(saveMode+1);фикс обход открытия файлов, чтобы их скачать по кнопке Caps
  43++64D2 B7           	or a
  44++64D3 20 40        	jr nz,.checkExit
  45++64D5 21 2E 65     	ld hl, scrExt1
  45++64D8 CD F2 63       call CompareBuff.search
  45++64DB A7             and a
  45++64DC 20 44          jr nz, .image
  46++64DE 21 33 65         ld hl, scrExt2
  46++64E1 CD F2 63       call CompareBuff.search
  46++64E4 A7             and a
  46++64E5 20 3B          jr nz, .image
  47++64E7 3E 03            ld a, 3
  47++64E9 32 33 8D       ld (VTPL.SETUP), a ; 0 bit - looping, 1 bit - pt2 file
  48++64EC 21 42 65         ld hl, pt2Ext1
  48++64EF CD F2 63       call CompareBuff.search
  48++64F2 A7             and a
  48++64F3 20 31          jr nz, .music
  49++64F5 21 47 65         ld hl, pt2Ext2
  49++64F8 CD F2 63       call CompareBuff.search
  49++64FB A7             and a
  49++64FC 20 28          jr nz, .music
  50++64FE 3E 01            ld a, 1
  50++6500 32 33 8D       ld (VTPL.SETUP), a
  51++6503 21 38 65         ld hl, pt3Ext1
  51++6506 CD F2 63       call CompareBuff.search
  51++6509 A7             and a
  51++650A 20 1A          jr nz, .music
  52++650C 21 3D 65         ld hl, pt3Ext2
  52++650F CD F2 63       call CompareBuff.search
  52++6512 A7             and a
  52++6513 20 11          jr nz, .music
  53++6515
  54++6515                  ; General Sound support
  55++6515                  ifdef GS
  56++6515 ~                ld hl, modExt1
  56++6515 ~              call CompareBuff.search
  56++6515 ~              and a
  56++6515 ~              jr nz, .mod
  57++6515 ~                ld hl, modExt2
  57++6515 ~              call CompareBuff.search
  57++6515 ~              and a
  57++6515 ~              jr nz, .mod
  58++6515                  endif
  59++6515
  60++6515              .checkExit
  61++6515 E1               pop hl
  62++6516              .downExit
  63++6516 3E 01            ld a, MIME_DOWNLOAD
  63++6518 C9             ret
  64++6519              .page
  65++6519 3E 02            ld a, MIME_LINK
  65++651B C9             ret
  66++651C              .text
  67++651C 3E 03            ld a, MIME_TEXT
  67++651E C9             ret
  68++651F              .input
  69++651F 3E 04            ld a, MIME_INPUT
  69++6521 C9             ret
  70++6522              .image
  71++6522 E1               pop hl
  71++6523 3E 06          ld a, MIME_IMAGE
  71++6525 C9             ret
  72++6526              .music
  73++6526 E1               pop hl
  73++6527 3E 05          ld a, MIME_MUSIC
  73++6529 C9             ret
  74++652A              .mod
  75++652A E1               pop hl
  75++652B 3E 07          ld a, MIME_MOD
  75++652D C9             ret
  76++652E
  77++652E 2E 73 63 72  scrExt1 db ".scr", 0
  77++6532 00
  78++6533 2E 53 43 52  scrExt2 db ".SCR", 0
  78++6537 00
  79++6538
  80++6538 2E 70 74 33  pt3Ext1 db ".pt3", 0
  80++653C 00
  81++653D 2E 50 54 33  pt3Ext2 db ".PT3", 0
  81++6541 00
  82++6542 2E 70 74 32  pt2Ext1 db ".pt2", 0
  82++6546 00
  83++6547 2E 50 54 32  pt2Ext2 db ".PT2", 0
  83++654B 00
  84++654C 2E 6D 6F 64  modExt1 db ".mod", 0
  84++6550 00
  85++6551 2E 4D 4F 44  modExt2 db ".MOD", 0
  85++6555 00
  86++6556
  87++6556              toggleSaveMode
  88++6556 F5           			push af
  89++6557 CD 14 6A     			call Console.waitForKeyUp
  90++655A 3E 00        saveMode	ld a,0 ; Флаг Open/Save files
  91++655C EE 01        			xor 1
  92++655E 32 5B 65     			ld (saveMode+1),a
  93++6561 F1           			pop af
  94++6562 C9           			ret
# file closed: gopher/render/row.asm
   5++6563                  include "buffer.asm"
# file opened: gopher/render/buffer.asm
   1++6563              ; BC - line count
   2++6563              findLine
   3++6563 21 44 99         ld hl, outputBuffer
   4++6566              findLine2
   5++6566 78               ld a,b
   6++6567 B1               or c
   7++6568 CA 95 65         jp z, .checkEmpty
   8++656B              .loop
   9++656B 7E               ld a, (hl)
  10++656C A7               and a
  11++656D CA 98 65         jp z, .nope
  12++6570 23               inc hl
  13++6571 FE 0D            cp 13
  14++6573 CA 8B 65         jp z, .checkLF  ;13
  15++6576 FE 0A            cp 10
  15++6578 CA 7E 65       jp z, .nextCheck     ;10
  16++657B C3 6B 65         jp .loop
  17++657E              .nextCheck
  18++657E A7               and a
  19++657F CA 98 65         jp z, .nope
  20++6582 0B               dec bc
  21++6583 57               ld d,a
  22++6584 78               ld a,b
  23++6585 B1               or c
  24++6586 7A               ld a,d
  25++6587 C2 6B 65         jp nz, .loop
  26++658A C9               ret
  27++658B              .checkLF
  28++658B 7E               ld a, (hl)
  29++658C FE 0A            cp 10
  30++658E C2 7E 65         jp nz, .nextCheck    ;10
  31++6591 23               inc hl
  32++6592 C3 7E 65         jp  .nextCheck
  33++6595              .checkEmpty
  34++6595 7E               ld a, (hl)
  34++6596 A7             and a
  34++6597 C0             ret nz
  35++6598              .nope
  36++6598 21 00 00         ld hl, 0
  36++659B C9             ret
  37++659C
# file closed: gopher/render/buffer.asm
   6++659C                  include "ui.asm"
# file opened: gopher/render/ui.asm
   1++659C                  IFDEF ZXSCR
   2++659C                      DEFINE LEFT_TAB "[D]omain:                                  "
   3++659C                      DEFINE SCREEN_WIDTH 64
   4++659C                      DEFINE SCREEN64
   5++659C                  ENDIF
   6++659C
   7++659C                  IFDEF TIMEX     ;UNKNOWM fallback to 64
   8++659C ~                    DEFINE LEFT_TAB "[D]omain:                                  "
   9++659C ~                    DEFINE SCREEN_WIDTH 64
  10++659C ~                    DEFINE SCREEN64
  11++659C                  ENDIF
  12++659C
  13++659C                  IFDEF TIMEX80
  14++659C ~                    DEFINE LEFT_TAB "[D]omain:                                                      "
  15++659C ~                    DEFINE SCREEN_WIDTH 85
  16++659C ~                    DEFINE SCREEN85
  17++659C                  ENDIF
  18++659C
  19++659C                  IFDEF NEDOOS
  20++659C ~                    DEFINE LEFT_TAB "[D]omain:                                                  "
  21++659C ~                    DEFINE SCREEN_WIDTH 80
  22++659C ~                    DEFINE SCREEN80
  23++659C                  ENDIF
  24++659C
  25++659C                  IFDEF MSX
  26++659C ~                    DEFINE LEFT_TAB "[D]omain:                                              "
  27++659C ~                    DEFINE SCREEN_WIDTH 80
  28++659C ~                    DEFINE SCREEN80
  29++659C                  ENDIF
  30++659C              prepareScreen:
  31++659C CD 1D 60         call TextMode.cls
  32++659F 21 6F 66         ld hl, header
  32++65A2 CD BC 60       call TextMode.printZ
  33++65A5 11 0A 00         ld de, #000A
  33++65A8 CD 3A 60       call TextMode.gotoXY
  34++65AB 21 02 84         ld hl, hostName
  34++65AE CD BC 60       call TextMode.printZ
  35++65B1 AF               xor a
  35++65B2 CD 7B 60       call TextMode.highlightLine
  36++65B5 C9               ret
  37++65B6
  38++65B6              inputHost:
  39++65B6 CD 14 6A         	call Console.waitForKeyUp
  40++65B9              .loop
  41++65B9 11 0A 00         ld de, #000A
  41++65BC CD 3A 60       call TextMode.gotoXY
  41++65BF 21 02 84       ld hl, hostName
  41++65C2 CD BC 60       call TextMode.printZ
  42++65C5 3E 04            ld a, MIME_INPUT
  42++65C7 CD A4 60       call TextMode.putC
  43++65CA 3E 20            ld a, ' '
  43++65CC CD A4 60       call TextMode.putC
  44++65CF              .wait
  45++65CF CD 2D 6A         call Console.getC
  46++65D2 5F               ld e, a
  47++65D3 FE 0C            cp Console.BACKSPACE
  47++65D5 28 17          jr z, .removeChar
  48++65D7 FE 0D            cp CR
  48++65D9 CA FC 65       jp z, inputNavigate
  49++65DC FE 20            cp 32
  49++65DE 38 EF          jr c, .wait
  50++65E0              .putC
  51++65E0 AF               xor a
  51++65E1 21 02 84 01    ld hl, hostName, bc, 48
  51++65E5 30 00
  51++65E7 ED B1          cpir
  52++65E9 77               ld (hl), a
  52++65EA 2B             dec hl
  52++65EB 73             ld (hl), e
  53++65EC 18 CB            jr .loop
  54++65EE              .removeChar
  55++65EE AF               xor a
  56++65EF 21 02 84 01      ld hl, hostName, bc, 48
  56++65F3 30 00
  56++65F5 ED B1          cpir
  57++65F7 2B               dec hl
  57++65F8 2B             dec hl
  57++65F9 77             ld (hl), a
  58++65FA 18 BD            jr .loop
  59++65FC
  60++65FC              inputNavigate:
  61++65FC 21 02 84 11      ld hl, hostName, de, domain
  61++6600 2F 66
  62++6602 7E               ld a,(hl)
  63++6603 A7               and a
  64++6604 CA 81 73         jp z, History.load
  65++6607              .loop
  66++6607 7E               ld a, (hl)
  66++6608 A7             and a
  66++6609 28 05          jr z, .complete
  67++660B 12               ld (de), a
  67++660C 23 13          inc hl, de
  68++660E 18 F7            jr .loop
  69++6610              .complete
  70++6610 3E 09            ld a, TAB
  70++6612 12             ld (de), a
  70++6613 13             inc de
  71++6614 3E 37            ld a, '7'
  71++6616 12             ld (de), a
  71++6617 13             inc de
  72++6618 3E 30            ld a, '0'
  72++661A 12             ld (de), a
  72++661B 13             inc de
  73++661C 3E 0D            ld a, CR
  73++661E 12             ld (de), a
  73++661F 13             inc de
  74++6620 3E 0A            ld a, LF
  74++6622 12             ld (de), a
  74++6623 13             inc de
  75++6624 21 2A 66         ld hl, navRow
  75++6627 C3 DA 73       jp History.navigate
  76++662A
  77++662A 31 20 09 2F  navRow db "1 ", TAB, "/", TAB
  77++662E 09
  78++662F 6E 69 68 69  domain db "nihirash.net"
  78++6633 72 61 73 68
  78++6637 2E 6E 65 74
  79++663B 00 00 00...      ds 64 - ($ - domain)
  80++666F
  81++666F 5B 44 5D 6F  header db "[D]omain:                                  ", "MRF "
  81++6673 6D 61 69 6E
  81++6677 3A 20 20 20
  81++667B 20 20 20 20
  81++667F 20 20 20 20
  81++6683 20 20 20 20
  81++6687 20 20 20 20
  81++668B 20 20 20 20
  81++668F 20 20 20 20
  81++6693 20 20 20 20
  81++6697 20 20 20 4D
  81++669B 52 46 20
  82++669E 31 2E 37            db "1.7"
  83++66A1 2E                  db "."
  84++66A2 31 38               db "18"
  85++66A4              	IFDEF MSX
  86++66A4 ~                   db "    [MSX UNAPI]",13, 0
  87++66A4              	ENDIF
  88++66A4
  89++66A4                  IFDEF MB03
  90++66A4 ~                   db " [MB03+]",13, 0
  91++66A4                     ENDIF
  92++66A4
  93++66A4                  IFDEF UNO
  94++66A4 ~                   db " [UNO UART]",13, 0
  95++66A4                  ENDIF
  96++66A4
  97++66A4                  IFDEF AY
  98++66A4 ~                   db " [AYWIFI]",13, 0
  99++66A4              	ENDIF
 100++66A4
 101++66A4                  IFDEF ZW
 102++66A4 20 20 5B 5A         db "  [ZXWiFi]",13, 0
 102++66A8 58 57 69 46
 102++66AC 69 5D 0D 00
 103++66B0                  ENDIF
 104++66B0
 105++66B0                   IFDEF UARTATM
 106++66B0 ~                   db " [ATM UART]",13, 0
 107++66B0                  ENDIF
 108++66B0
 109++66B0                  IFDEF UARTEVO
 110++66B0 ~                    db " [EVO UART]",13, 0
 111++66B0                  ENDIF
 112++66B0
 113++66B0                  IFDEF UNOUART
 114++66B0 ~                    db " [UNO UART]",13, 0
 115++66B0                  ENDIF
 116++66B0
 117++66B0                  IFDEF NEDONET
 118++66B0 ~            	    db "  [nedoNET]",13, 0
 119++66B0              	ENDIF
 120++66B0
# file closed: gopher/render/ui.asm
   7++66B0                  include "gopher-page.asm"
# file opened: gopher/render/gopher-page.asm
   1++66B0              renderGopherScreen:
   2++66B0 3E FF            ld a, 255
   3++66B2 32 D0 8C         ld (oldminutes), a
   4++66B5 CD 9C 65         call Render.prepareScreen
   5++66B8
   6++66B8 2A F0 76         ld hl, (page_offset)        ; HL - offset to 0 Row on screen
   7++66BB 44 4D            ld bc,hl                    ; BC - offset to C Row on screen
   8++66BD CD 63 65         call Render.findLine        ;BC - Search this line  HL - Return pointer to page with offset
   9++66C0 7C               ld a, h
  10++66C1 B5               or l
  11++66C2 28 21            jr z, .exit2
  12++66C4 7B               ld a, e
  13++66C5 AF               xor a
  14++66C6 E5               push hl
  15++66C7 CD 79 64         call renderRow
  16++66CA E1               pop hl
  17++66CB
  18++66CB 06 15            ld b, PER_PAGE-1
  19++66CD
  20++66CD              .loop
  21++66CD C5               push bc
  22++66CE 3E 16            ld a, PER_PAGE
  23++66D0 90               sub b
  24++66D1 5F               ld e,a
  25++66D2
  26++66D2 01 01 00         ld bc, 1
  27++66D5
  28++66D5 CD 66 65         call Render.findLine2   ;BC - Search this line  HL - Return pointer to page with offset
  29++66D8
  30++66D8 7C               ld a, h
  31++66D9 B5               or l
  32++66DA 28 06            jr z, .exit
  33++66DC 7B               ld a, e
  34++66DD E5               push hl
  35++66DE CD 79 64         call renderRow
  36++66E1 E1               pop hl
  37++66E2              .exit
  38++66E2 C1               pop bc
  39++66E3 10 E8            djnz .loop
  40++66E5              .exit2
  41++66E5 CD E5 67         call showCursor
  42++66E8 C9               ret
  43++66E9
  44++66E9              checkBorder:
  45++66E9 3A EE 76         ld a, (cursor_position)
  45++66EC FE FF          cp #ff
  45++66EE CA 09 68       jp z, pageUp
  46++66F1 3A EE 76         ld a, (cursor_position)
  46++66F4 FE 16          cp PER_PAGE
  46++66F6 CA 3C 68       jp z, pageDn
  47++66F9 CD E5 67         call showCursor
  48++66FC C3 FF 66         jp workLoop
  49++66FF
  50++66FF              workLoop:
  51++66FF 3A 25 69         ld a, (play_next)
  51++6702 A7             and a
  51++6703 C2 9A 67       jp nz, navigate
  52++6706
  53++6706                  dup 4
  54++6706 76          >    halt
  54++6707 76          >    halt
  54++6708 76          >    halt
  54++6709 76          >    halt
  55++670A                  edup
  56++670A              .nothing
  57++670A
  58++670A 76               halt
  59++670B CD 2B 8C         call printRTC
  60++670E
  61++670E CD 3E 6A         call Console.peekC
  62++6711 A7               and a
  62++6712 CA 0A 67       jp z, .nothing
  63++6715
  64++6715 FE 31            cp '1'
  64++6717 CA 6A 73       jp z, History.back
  65++671A FE 32            cp '2'
  65++671C CA 9A 67       jp z, navigate
  66++671F FE 33            cp '3'
  66++6721 CA F5 67       jp z, cursorDown
  67++6724 FE 34            cp '4'
  67++6726 CA FF 67       jp z, cursorUp
  68++6729 FE 35            cp '5'
  68++672B CA 09 68       jp z, pageUp
  69++672E FE 38            cp '8'
  69++6730 CA 3C 68       jp z, pageDn
  70++6733 FE 36            cp '6'
  70++6735 CA F5 67       jp z, cursorDown
  71++6738 FE 37            cp '7'
  71++673A CA FF 67       jp z, cursorUp
  72++673D
  73++673D FE 0A            cp Console.KEY_DN
  73++673F CA F5 67       jp z, cursorDown
  74++6742 FE 61            cp 'a'
  74++6744 CA F5 67       jp z, cursorDown
  75++6747 FE 0B            cp Console.KEY_UP
  75++6749 CA FF 67       jp z, cursorUp
  76++674C FE 71            cp 'q'
  76++674E CA FF 67       jp z, cursorUp
  77++6751 FE 08            cp Console.KEY_LT
  77++6753 CA 09 68       jp z, pageUp
  78++6756 FE 6F            cp 'o'
  78++6758 CA 09 68       jp z, pageUp
  79++675B FE 09            cp Console.KEY_RT
  79++675D CA 3C 68       jp z, pageDn
  80++6760 FE 70            cp 'p'
  80++6762 CA 3C 68       jp z, pageDn
  81++6765
  82++6765 FE 68            cp 'h'
  82++6767 CA D7 73       jp z, History.home
  83++676A FE 48            cp 'H'
  83++676C CA D7 73       jp z, History.home
  84++676F
  85++676F FE 62            cp 'b'
  85++6771 CA 6A 73       jp z, History.back
  86++6774 FE 42            cp 'B'
  86++6776 CA 6A 73       jp z, History.back
  87++6779 FE 0C            cp Console.BACKSPACE
  87++677B CA 6A 73       jp z, History.back
  88++677E
  89++677E FE 64            cp 'd'
  89++6780 CA B6 65       jp z, inputHost
  90++6783 FE 44            cp 'D'
  90++6785 CA B6 65       jp z, inputHost
  91++6788
  92++6788 FE 0D            cp CR
  92++678A CA 9A 67       jp z, navigate
  93++678D
  94++678D FE 53            cp 'S'
  94++678F CC 56 65       call z, toggleSaveMode
  95++6792 FE 73        	cp 's'
  95++6794 CC 56 65       call z, toggleSaveMode
  96++6797
  97++6797
  98++6797                  IFDEF MSX
  99++6797 ~                	cp ESC
  99++6797 ~              jp z, exit
 100++6797                  ENDIF
 101++6797
 102++6797                  IFDEF GS
 103++6797 ~                cp 'M'
 103++6797 ~              call z, GeneralSound.toggleModule
 104++6797 ~                cp 'm'
 104++6797 ~              call z, GeneralSound.toggleModule
 105++6797                  ENDIF
 106++6797
 107++6797                  IFDEF TIMEX80
 108++6797 ~                cp 'T'
 108++6797 ~              call z, TextMode.toggleColor
 109++6797 ~                cp 't'
 109++6797 ~              call z, TextMode.toggleColor
 110++6797                  ENDIF
 111++6797
 112++6797 C3 FF 66         jp workLoop
 113++679A
 114++679A              navigate:
 115++679A CD 14 6A         call Console.waitForKeyUp
 116++679D AF               xor a
 116++679E 32 25 69       ld (play_next), a
 117++67A1 CD ED 67         call hideCursor
 118++67A4 ED 4B F0 76      ld bc, (page_offset)
 119++67A8 2A EE 76         ld hl, (cursor_position)
 120++67AB 09               add hl,bc
 121++67AC 44               ld b, h ;HHHHH
 122++67AD 4D               ld c, l ;LLLLL
 123++67AE D5               push de
 124++67AF CD 63 65         call Render.findLine
 125++67B2 D1               pop de
 126++67B3 7E               ld a, (hl)
 127++67B4 FE 31            cp '1'
 127++67B6 CA CE 67       jp z, .load
 128++67B9 FE 30            cp '0'
 128++67BB CA CE 67       jp z, .load
 129++67BE FE 39            cp '9'
 129++67C0 CA CE 67       jp z, .load
 130++67C3 FE 37            cp '7'
 130++67C5 CA D6 67       jp z, .input
 131++67C8 CD E5 67         call showCursor
 132++67CB C3 FF 66         jp workLoop
 133++67CE              .load
 134++67CE E5               push hl
 135++67CF CD 8E 64         call getIcon
 136++67D2 E1               pop hl
 137++67D3 C3 DA 73         jp History.navigate
 138++67D6              .input
 139++67D6 E5               push hl
 140++67D7 CD 26 69         call DialogBox.inputBox
 141++67DA E1               pop hl
 142++67DB 3A 8B 69         ld a, (DialogBox.inputBuffer)
 142++67DE A7             and a
 142++67DF CA 81 73       jp z, History.load
 143++67E2 C3 CE 67         jp .load
 144++67E5
 145++67E5              showCursor:
 146++67E5 3A EE 76         ld a, (cursor_position)
 146++67E8 C6 02          add CURSOR_OFFSET
 147++67EA C3 7B 60         jp TextMode.highlightLine
 148++67ED
 149++67ED              hideCursor:
 150++67ED 3A EE 76         ld a, (cursor_position)
 150++67F0 C6 02          add CURSOR_OFFSET
 151++67F2 C3 61 60         jp TextMode.usualLine
 152++67F5
 153++67F5              cursorDown:
 154++67F5 CD ED 67         call hideCursor
 155++67F8 21 EE 76         ld hl, cursor_position
 156++67FB 34               inc (hl)
 157++67FC C3 E9 66         jp checkBorder
 158++67FF
 159++67FF              cursorUp:
 160++67FF CD ED 67         call hideCursor
 161++6802 21 EE 76         ld hl, cursor_position
 162++6805 35               dec (hl)
 163++6806 C3 E9 66         jp checkBorder
 164++6809
 165++6809              pageUp:
 166++6809 3A F0 76         ld a, (page_offset)
 166++680C FE 00          cp 0
 166++680E C2 1C 68       jp nz, .pageUp2
 167++6811 3A F1 76         ld a, (page_offset + 1)
 167++6814 FE 00          cp 0
 167++6816 C2 1C 68       jp nz, .pageUp2
 168++6819 C3 32 68         jp .skip
 169++681C              .pageUp2:
 170++681C 3E 15            ld a, PER_PAGE - 1
 170++681E 32 EE 76       ld (cursor_position), a
 171++6821 2A F0 76         ld hl, (page_offset)
 172++6824 11 16 00         ld de,PER_PAGE
 173++6827 ED 52            sbc hl,de
 174++6829 22 F0 76         ld (page_offset), hl
 175++682C              .exit
 176++682C CD B0 66         call renderGopherScreen
 177++682F C3 FF 66         jp workLoop
 178++6832              .skip
 179++6832 AF               xor a
 179++6833 32 EE 76       ld (cursor_position), a
 179++6836 CD B0 66       call renderGopherScreen
 179++6839 C3 FF 66       jp workLoop
 180++683C
 181++683C              pageDn:
 182++683C AF                xor a
 182++683D 32 EE 76       ld (cursor_position), a
 183++6840 2A F0 76         ld hl,(page_offset)
 184++6843 11 16 00         ld de,PER_PAGE
 185++6846 19               add hl,de
 186++6847 22 F0 76         ld (page_offset), hl
 187++684A C3 2C 68         jp pageUp.exit
 188++684D
# file closed: gopher/render/gopher-page.asm
   8++684D                  include "plaintext.asm"
# file opened: gopher/render/plaintext.asm
   1++684D              renderPlainTextScreen:
   2++684D 3E FF            ld a, 255
   3++684F 32 D0 8C         ld (oldminutes), a
   4++6852 CD 9C 65         call prepareScreen
   5++6855
   6++6855 2A F0 76         ld hl, (page_offset)        ; HL - offset to 0 Row on screen
   7++6858 44 4D            ld bc,hl                    ; BC - offset to C Row on screen
   8++685A CD 63 65         call Render.findLine        ;BC - Search this line  HL - Return pointer to page with offset
   9++685D 7C               ld a, h
  10++685E B5               or l
  11++685F 28 30            jr z, .exit2
  12++6861 AF               xor a
  13++6862 C6 02            add CURSOR_OFFSET
  13++6864 57 1E 01       ld d, a, e, 1
  13++6867 CD 3A 60       call TextMode.gotoXY
  14++686A CD 48 64         call print70Text
  15++686D 06 15            ld b, PER_PAGE -1
  16++686F              .loop
  17++686F C5               push bc
  18++6870 3E 16            ld a, PER_PAGE
  19++6872 90               sub b
  20++6873 5F               ld e,a
  21++6874 01 01 00         ld bc, 1
  22++6877 CD 66 65         call Render.findLine2   ;BC - Search this line  HL - Return pointer to page with offset
  23++687A 7C               ld a, h
  24++687B B5               or l
  25++687C 28 10            jr z, .exit
  26++687E 7B               ld a, e
  27++687F C6 02            add CURSOR_OFFSET
  27++6881 57 1E 01       ld d, a, e, 1
  27++6884 CD 3A 60       call TextMode.gotoXY
  28++6887 CD 48 64         call print70Text
  29++688A C1               pop bc
  30++688B 10 E2            djnz .loop
  31++688D C9               ret
  32++688E              .exit
  33++688E C1               pop bc
  34++688F 10 DE            djnz .loop
  35++6891              .exit2
  36++6891 CD E5 67         call showCursor
  37++6894 C9               ret
  38++6895              plainTextLoop:
  39++6895 CD 2B 8C         call printRTC
  40++6898 CD 2D 6A         call Console.getC
  41++689B
  42++689B FE 31            cp '1'
  42++689D CA 6A 73       jp z, History.back
  43++68A0 FE 32            cp '2'
  43++68A2 CA 9A 67       jp z, navigate
  44++68A5 FE 35            cp '5'
  44++68A7 CA 03 69       jp z, textUp
  45++68AA FE 38            cp '8'
  45++68AC CA F3 68       jp z, textDown
  46++68AF FE 08            cp Console.KEY_LT
  46++68B1 CA 03 69       jp z, textUp
  47++68B4 FE 09            cp Console.KEY_RT
  47++68B6 CA F3 68       jp z, textDown
  48++68B9
  49++68B9 FE 0A            cp Console.KEY_DN
  49++68BB CA F3 68       jp z, textDown
  50++68BE FE 61            cp 'a'
  50++68C0 CA F3 68       jp z, textDown
  51++68C3
  52++68C3 FE 0B            cp Console.KEY_UP
  52++68C5 CA 03 69       jp z, textUp
  53++68C8 FE 71            cp 'q'
  53++68CA CA 03 69       jp z, textUp
  54++68CD
  55++68CD FE 68            cp 'h'
  55++68CF CA D7 73       jp z, History.home
  56++68D2 FE 48            cp 'H'
  56++68D4 CA D7 73       jp z, History.home
  57++68D7
  58++68D7 FE 62            cp 'b'
  58++68D9 CA 6A 73       jp z, History.back
  59++68DC FE 42            cp 'B'
  59++68DE CA 6A 73       jp z, History.back
  60++68E1
  61++68E1 FE 64            cp 'd'
  61++68E3 CA B6 65       jp z, inputHost
  62++68E6 FE 44            cp 'D'
  62++68E8 CA B6 65       jp z, inputHost
  63++68EB
  64++68EB FE 0C            cp Console.BACKSPACE
  64++68ED CA 6A 73       jp z, History.back
  65++68F0
  66++68F0                  IFDEF MSX
  67++68F0 ~                	cp ESC
  67++68F0 ~              jp z, exit
  68++68F0                  ENDIF
  69++68F0
  70++68F0                  IFDEF GS
  71++68F0 ~                cp 'M'
  71++68F0 ~              call z, GeneralSound.toggleModule
  72++68F0 ~                cp 'm'
  72++68F0 ~              call z, GeneralSound.toggleModule
  73++68F0                  ENDIF
  74++68F0
  75++68F0                  IFDEF TIMEX80
  76++68F0 ~                cp 'T'
  76++68F0 ~              call z, TextMode.toggleColor
  77++68F0 ~                cp 't'
  77++68F0 ~              call z, TextMode.toggleColor
  78++68F0                  ENDIF
  79++68F0
  80++68F0 C3 95 68         jp plainTextLoop
  81++68F3
  82++68F3
  83++68F3              textDown:
  84++68F3 2A F0 76         ld hl,(page_offset)
  85++68F6 11 16 00         ld de,PER_PAGE
  86++68F9 19               add hl,de
  87++68FA 22 F0 76         ld (page_offset), hl
  88++68FD CD 4D 68         call renderPlainTextScreen
  89++6900 C3 95 68         jp plainTextLoop
  90++6903
  91++6903              textUp:
  92++6903 3A F0 76         ld a, (page_offset)
  92++6906 FE 00          cp 0
  92++6908 20 0A          jr nz, .textUp2
  93++690A 3A F1 76         ld a, (page_offset + 1)
  93++690D FE 00          cp 0
  93++690F 20 03          jr nz, .textUp2
  94++6911 C3 95 68         jp plainTextLoop
  95++6914
  96++6914              .textUp2:
  97++6914 2A F0 76         ld hl,(page_offset)
  98++6917 11 16 00         ld de,PER_PAGE
  99++691A ED 52            sbc hl,de
 100++691C 22 F0 76         ld (page_offset), hl
 101++691F CD 4D 68         call renderPlainTextScreen
 102++6922 C3 95 68         jp plainTextLoop
 103++6925
# file closed: gopher/render/plaintext.asm
   9++6925
  10++6925 00           play_next       db  0
  11++6926              position        EQU historyBlock.position
  12++6926              cursor_position EQU position + 2
  13++6926              page_offset     EQU position + 4
  14++6926
  15++6926                  ENDMODULE
  16++6926
  17++6926                  include "dialogbox.asm"
# file opened: gopher/render/dialogbox.asm
   1++6926                  module DialogBox
   2++6926
   3++6926              inputBox:
   4++6926 AF               xor a
   4++6927 32 8B 69       ld (inputBuffer), a
   5++692A              .noclear
   6++692A CD EC 69         call drawBox
   7++692D              .loop
   8++692D 11 05 0B         ld de, #0B05
   8++6930 CD 3A 60       call TextMode.gotoXY
   9++6933 21 8B 69         ld hl, inputBuffer
   9++6936 CD BC 60       call TextMode.printZ
  10++6939 3E 04            ld a, MIME_INPUT
  10++693B CD A4 60       call TextMode.putC
  10++693E 3E 20          ld a, ' '
  10++6940 CD A4 60       call TextMode.putC
  11++6943              .checkkey
  12++6943 CD 3E 6A         call Console.peekC
  13++6946 FE 00            cp 00
  13++6948 CA 43 69        jp z, .checkkey
  14++694B FE 0D            cp CR
  14++694D C8             ret z
  15++694E
  16++694E                  IFNDEF MSX
  17++694E                  dup 11
  18++694E 76          >    halt
  18++694F 76          >    halt
  18++6950 76          >    halt
  18++6951 76          >    halt
  18++6952 76          >    halt
  18++6953 76          >    halt
  18++6954 76          >    halt
  18++6955 76          >    halt
  18++6956 76          >    halt
  18++6957 76          >    halt
  18++6958 76          >    halt
  19++6959                  edup
  20++6959                  ENDIF
  21++6959
  22++6959 FE 0C            cp Console.BACKSPACE
  22++695B 28 13          jr z, .removeChar
  23++695D FE 20            cp SPACE
  23++695F 38 E2          jr c, .checkkey
  24++6961              .putC
  25++6961 5F               ld e, a
  26++6962 AF               xor a
  26++6963 21 8B 69 01    ld hl, inputBuffer, bc, #ff
  26++6967 FF 00
  26++6969 ED B1          cpir
  27++696B 77               ld (hl), a
  27++696C 2B             dec hl
  27++696D 73             ld (hl), e
  28++696E 18 BD            jr .loop
  29++6970              .removeChar
  30++6970 AF               xor a
  31++6971 21 8B 69 01      ld hl, inputBuffer, bc, #ff
  31++6975 FF 00
  31++6977 ED B1          cpir
  32++6979 E5               push hl
  33++697A 11 8C 69             ld de, inputBuffer + 1
  34++697D B7                   or a
  34++697E ED 52          sbc hl, de
  35++6980 7C                   ld a, h
  35++6981 B5             or l
  36++6982 E1               pop hl
  37++6983 28 A8            jr z, .loop
  38++6985 AF               xor a
  39++6986 2B               dec hl
  39++6987 2B             dec hl
  39++6988 77             ld (hl), a
  40++6989 18 A2            jr .loop
  41++698B
  42++698B
  43++698B              namedownload
  44++698B                  IFDEF NEDOOS
  45++698B ~            		db "..",92,"downloads",92
  46++698B                  ENDIF
  47++698B
  48++698B 00 00 00...  inputBuffer ds 80
  49++69DB
  50++69DB              msgBox:
  51++69DB CD E4 69         call msgNoWait
  52++69DE 06 96            ld b, 150
  53++69E0              .loop
  54++69E0 76               halt
  55++69E1 10 FD            djnz .loop
  56++69E3 C9               ret
  57++69E4
  58++69E4              msgNoWait:
  59++69E4 E5               push hl
  60++69E5 CD EC 69         call drawBox
  61++69E8 E1               pop hl
  62++69E9 C3 BC 60         jp TextMode.printZ
  63++69EC
  64++69EC              drawBox:
  65++69EC 26 0A 3E 09      ld h, #0a, a, BORDER_TOP
  66++69F0 CD 47 60         call TextMode.fillLine
  67++69F3 26 0B 3E 20      ld h, #0b, a, ' '
  68++69F7 CD 47 60         call TextMode.fillLine
  69++69FA 26 0C 3E 08      ld h, #0c, a, BORDER_BOTTOM
  70++69FE CD 47 60         call TextMode.fillLine
  71++6A01 3E 0A            ld a, #0a
  72++6A03 CD 7B 60         call TextMode.highlightLine
  73++6A06 3E 0C            ld a, #0c
  74++6A08 CD 7B 60         call TextMode.highlightLine
  75++6A0B 11 03 0B         ld de,#0B03
  76++6A0E CD 3A 60         call TextMode.gotoXY
  77++6A11 C9               ret
  78++6A12                  endmodule
  79++6A12
# file closed: gopher/render/dialogbox.asm
# file closed: gopher/render/index.asm
  18+ 6A12                  include "dos/index.asm"
# file opened: dos/index.asm
   1++6A12              	IFDEF NEDOOS
   2++6A12 ~            	    include "nedoconsole.asm"
   3++6A12 ~            		include "nedoos.asm"
   4++6A12              	ENDIF
   5++6A12
   6++6A12              	IFDEF TRDOS
   7++6A12                  	include "console.asm"
# file opened: dos/console.asm
   1++6A12                  module Console
   2++6A12              KEY_UP = 11
   3++6A12              KEY_DN = 10
   4++6A12              KEY_LT = 8
   5++6A12              KEY_RT = 9
   6++6A12              BACKSPACE = 12
   7++6A12              BASIC_KEY = #5C08
   8++6A12 00           keyCode db 0
   9++6A13 00           tableShift db 0
  10++6A14
  11++6A14              waitForKeyUp:
  12++6A14 76           	halt
  13++6A15 AF              xor a
  13++6A16 DB FE          in a, (#fe)
  13++6A18 2F             cpl
  13++6A19 E6 1F          and 31
  13++6A1B 20 F7          jr nz, waitForKeyUp
  14++6A1D 32 08 5C        ld (BASIC_KEY), a
  15++6A20 C9              ret
  16++6A21
  17++6A21              keyWait:
  18++6A21                  dup 11
  19++6A21 76          >    halt
  19++6A22 76          >    halt
  19++6A23 76          >    halt
  19++6A24 76          >    halt
  19++6A25 76          >    halt
  19++6A26 76          >    halt
  19++6A27 76          >    halt
  19++6A28 76          >    halt
  19++6A29 76          >    halt
  19++6A2A 76          >    halt
  19++6A2B 76          >    halt
  20++6A2C                  edup
  21++6A2C C9              ret
  22++6A2D
  23++6A2D              getC:
  24++6A2D              getCint:       ; for nedoOS
  25++6A2D AF              xor a
  26++6A2E 32 08 5C        ld (BASIC_KEY),a
  27++6A31              getC2:
  28++6A31 3A 08 5C        ld a,(BASIC_KEY)
  29++6A34 A7              and a
  29++6A35 28 FA          jr z, getC2
  30++6A37 47              ld b,a
  31++6A38 AF              xor a
  31++6A39 32 08 5C       ld (BASIC_KEY), a
  32++6A3C 78              ld a, b
  33++6A3D C9              ret
  34++6A3E              ;0xE - to Russian
  35++6A3E              ;0xF - to Englich
  36++6A3E              peekC:
  37++6A3E AF               xor a
  37++6A3F 32 08 5C       ld (BASIC_KEY),a
  38++6A42 CD 62 6A         call inkey
  39++6A45 FE 0E            cp 0xE
  40++6A47 CA 50 6A         jp z, toRus
  41++6A4A FE 0F            cp 0xF
  42++6A4C CA 5A 6A         jp z, toEng
  43++6A4F C9               ret
  44++6A50              toRus
  45++6A50 3E A0           ld a, russiantable - englishTable
  46++6A52 32 13 6A        ld (tableShift), a
  47++6A55 AF              xor a
  48++6A56 CD 21 6A        call keyWait
  49++6A59 C9              ret
  50++6A5A              toEng
  51++6A5A AF              xor a
  52++6A5B 32 13 6A        ld (tableShift), a
  53++6A5E CD 21 6A        call keyWait
  54++6A61 C9              ret
  55++6A62
  56++6A62              inkey:
  57++6A62 11 00 00        ld de,0
  58++6A65 01 FE FE        ld bc,$fefe
  59++6A68 ED 78           in a,(c)
  60++6A6A F6 E1           or $e1
  61++6A6C FE FF           cp $ff
  62++6A6E 20 57           jr nz, .keyhitA
  63++6A70
  64++6A70 1E 05           ld e,5
  65++6A72 06 FD           ld b,$fd
  66++6A74 ED 78           in a,(c)
  67++6A76 F6 E0           or $e0
  68++6A78 FE FF           cp $ff
  69++6A7A 20 4B           jr nz, .keyhitA
  70++6A7C
  71++6A7C 1E 0A           ld e,10
  72++6A7E 06 FB           ld b,$fb
  73++6A80 ED 78           in a,(c)
  74++6A82 F6 E0           or $e0
  75++6A84 FE FF           cp $ff
  76++6A86 20 3F           jr nz, .keyhitA
  77++6A88
  78++6A88 1E 0F           ld e,15
  79++6A8A 06 F7           ld b,$f7
  80++6A8C ED 78           in a,(c)
  81++6A8E F6 E0           or $e0
  82++6A90 FE FF           cp $ff
  83++6A92 20 33           jr nz, .keyhitA
  84++6A94
  85++6A94 1E 14           ld e,20
  86++6A96 06 EF           ld b,$ef
  87++6A98 ED 78           in a,(c)
  88++6A9A F6 E0           or $e0
  89++6A9C FE FF           cp $ff
  90++6A9E 20 27           jr nz, .keyhitA
  91++6AA0
  92++6AA0 1E 19           ld e,25
  93++6AA2 06 DF           ld b,$df
  94++6AA4 ED 78           in a,(c)
  95++6AA6 F6 E0           or $e0
  96++6AA8 FE FF           cp $ff
  97++6AAA 20 1B           jr nz, .keyhitA
  98++6AAC
  99++6AAC 1E 1E           ld e,30
 100++6AAE 06 BF           ld b,$bf
 101++6AB0 ED 78           in a,(c)
 102++6AB2 F6 E0           or $e0
 103++6AB4 FE FF           cp $ff
 104++6AB6 20 0F           jr nz, .keyhitA
 105++6AB8
 106++6AB8 1E 23           ld e,35
 107++6ABA 06 7F           ld b,$7f
 108++6ABC ED 78           in a,(c)
 109++6ABE F6 E2           or $e2
 110++6AC0 FE FF           cp $ff
 111++6AC2 4F              ld c,a
 112++6AC3 20 19           jr nz, .keyhitB
 113++6AC5
 114++6AC5              .nokey
 115++6AC5 AF              xor a
 116++6AC6 C9              ret
 117++6AC7
 118++6AC7              .keyhitA
 119++6AC7
 120++6AC7 4F              ld c,a
 121++6AC8
 122++6AC8 78              ld a,b
 123++6AC9 2F              cpl
 124++6ACA F6 81           or $81
 125++6ACC DB FE           in a,($fe)
 126++6ACE F6 E0           or $e0
 127++6AD0 FE FF           cp $ff
 128++6AD2 20 F1           jr nz, .nokey
 129++6AD4
 130++6AD4 3E 7F           ld a,$7f
 131++6AD6 DB FE           in a,($fe)
 132++6AD8 F6 E2           or $e2
 133++6ADA FE FF           cp $ff
 134++6ADC 20 E7           jr nz, .nokey
 135++6ADE
 136++6ADE              .keyhitB
 137++6ADE
 138++6ADE 06 00           ld b,0
 139++6AE0 21 2C 6A        ld hl,.rowtbl-$e0
 140++6AE3 09              add hl,bc
 141++6AE4 7E              ld a,(hl)
 142++6AE5 FE 05           cp 5
 143++6AE7 30 DC           jr nc, .nokey
 144++6AE9 83              add a,e
 145++6AEA 5F              ld e,a
 146++6AEB
 147++6AEB 21 2C 6B        ld  hl, englishTable
 148++6AEE 19              add hl, de
 149++6AEF 3A 13 6A        ld  a, (tableShift)
 150++6AF2 5F              ld e, a
 151++6AF3 19              add hl, de
 152++6AF4 3E FE           ld a,$fe
 153++6AF6 DB FE           in a,($fe)
 154++6AF8 E6 01           and $01
 155++6AFA 20 03           jr nz, .nocaps
 156++6AFC 1E 28           ld e,40
 157++6AFE 19              add hl,de
 158++6AFF
 159++6AFF              .nocaps
 160++6AFF
 161++6AFF 3E 7F           ld a,$7f
 162++6B01 DB FE           in a,($fe)
 163++6B03 E6 02           and $02
 164++6B05 20 03           jr nz, .nosym
 165++6B07 1E 50           ld e,80
 166++6B09 19              add hl,de
 167++6B0A
 168++6B0A              .nosym
 169++6B0A
 170++6B0A 7E              ld a,(hl)
 171++6B0B C9              ret
 172++6B0C
 173++6B0C              .rowtbl
 174++6B0C FF FF FF FF     defb 255,255,255,255,255,255,255
 174++6B10 FF FF FF
 175++6B13 FF FF FF FF     defb 255,255,255,255,255,255,255,255
 175++6B17 FF FF FF FF
 176++6B1B 04 FF FF FF     defb 4,255,255,255,255,255,255
 176++6B1F FF FF FF
 177++6B22 FF 03 FF FF     defb 255,3,255,255,255,2,255,1
 177++6B26 FF 02 FF 01
 178++6B2A 00 FF           defb 0,255
 179++6B2C
 180++6B2C              englishTable
 181++6B2C 00 7A 78 63     db 0,'z','x','c','v'      ; CAPS SHIFT, Z, X, C, V
 181++6B30 76
 182++6B31 61 73 64 66     db 'a','s','d','f','g'      ; A, S, D, F, G
 182++6B35 67
 183++6B36 71 77 65 72     db 'q','w','e','r','t'      ; Q, W, E, R, T
 183++6B3A 74
 184++6B3B 31 32 33 34     db '1','2','3','4','5'      ; 1, 2, 3, 4, 5
 184++6B3F 35
 185++6B40 30 39 38 37     db '0','9','8','7','6'      ; 0, 9, 8, 7, 6
 185++6B44 36
 186++6B45 70 6F 69 75     db 'p','o','i','u','y'      ; P, O, I, U, Y
 186++6B49 79
 187++6B4A 0D 6C 6B 6A     db 13,'l','k','j','h'       ; ENTER, L, K, J, H
 187++6B4E 68
 188++6B4F 20 00 6D 6E     db ' ',0,'m','n','b'      ; SPACE, SYM SHIFT, M, N, B
 188++6B53 62
 189++6B54
 190++6B54                 ; the following are CAPS SHIFTed
 191++6B54
 192++6B54 00 5A 58 43     db 0,'Z','X','C','V'      ; CAPS SHIFT, Z, X, C, V
 192++6B58 56
 193++6B59 41 53 44 46     db 'A','S','D','F','G'      ; A, S, D, F, G
 193++6B5D 47
 194++6B5E 51 57 45 52     db 'Q','W','E','R','T'      ; Q, W, E, R, T
 194++6B62 54
 195++6B63 0E 06 80 81     db 14,6,128,129,8           ; 1, 2, 3, 4, 5
 195++6B67 08
 196++6B68 0C 00 09 0B     db 12,0,9,11,10             ; 0, 9, 8, 7, 6
 196++6B6C 0A
 197++6B6D 50 4F 49 55     db 'P','O','I','U','Y'      ; P, O, I, U, Y
 197++6B71 59
 198++6B72 0D 4C 4B 4A     db 13,'L','K','J','H'       ; ENTER, L, K, J, H
 198++6B76 48
 199++6B77 20 00 4D 4E     db ' ',0,'M','N','B'      ; SPACE, SYM SHIFT, M, N, B
 199++6B7B 42
 200++6B7C
 201++6B7C                 ; the following are SYM SHIFTed
 202++6B7C
 203++6B7C 00 3A 60 3F     db 0,':',96,'?','/'       ; CAPS SHIFT, Z, X, C, V
 203++6B80 2F
 204++6B81 7E 7C 5C 7B     db '~','|',92,'{','}'       ; A, S, D, F, G
 204++6B85 7D
 205++6B86 83 84 85 3C     db 131,132,133,'<','>'      ; Q, W, E, R, T
 205++6B8A 3E
 206++6B8B 21 40 23 24     db '!','@','#','$','%'      ; 1, 2, 3, 4, 5
 206++6B8F 25
 207++6B90 5F 29 28 27     db '_',')','(',39,'&'       ; 0, 9, 8, 7, 6
 207++6B94 26
 208++6B95 22 3B 82 5D     db 34,';',130,']','['       ; P, O, I, U, Y
 208++6B99 5B
 209++6B9A 0D 3D 2B 2D     db 13,'=','+','-','^'       ; ENTER, L, K, J, H
 209++6B9E 5E
 210++6B9F 20 00 2E 2C     db ' ',0,'.',',','*'      ; SPACE, SYM SHIFT, M, N, B
 210++6BA3 2A
 211++6BA4
 212++6BA4                 ; the following are CAPS SHIFTed and SYM SHIFTed ("CTRL" key)
 213++6BA4
 214++6BA4 00 1A 18 03     db 0,26,24,3,22           ; CAPS SHIFT, Z, X, C, V
 214++6BA8 16
 215++6BA9 01 13 04 06     db 1,19,4,6,7               ; A, S, D, F, G
 215++6BAD 07
 216++6BAE 11 17 05 12     db 17,23,5,18,20            ; Q, W, E, R, T
 216++6BB2 14
 217++6BB3 1B 1C 1D 1E     db 27,28,29,30,31           ; 1, 2, 3, 4, 5
 217++6BB7 1F
 218++6BB8 7F 00 86 60     db 127,0,134,'`',135      ; 0, 9, 8, 7, 6
 218++6BBC 87
 219++6BBD 10 0F 09 15     db 16,15,9,21,25            ; P, O, I, U, Y
 219++6BC1 19
 220++6BC2 0D 0C 0B 0A     db 13,12,11,10,8            ; ENTER, L, K, J, H
 220++6BC6 08
 221++6BC7 20 00 0D 0E     db ' ',0,13,14,2          ; SPACE, SYM SHIFT, M, N, B
 221++6BCB 02
 222++6BCC
 223++6BCC              russiantable
 224++6BCC 00 EF E7 E1     db 0,'п','з','б','¬'      ; CAPS SHIFT, Z, X, C, V
 224++6BD0 AC
 225++6BD1 E4 EB A2 A0     db 'д','л','ў',' ','Ї'      ; A, S, D, F, G
 225++6BD5 AF
 226++6BD6 A9 E6 E3 AA     db '©','ж','г','Є','Ґ'      ; Q, W, E, R, T
 226++6BDA A5
 227++6BDB 31 32 33 34     db '1','2','3','4','5'      ; 1, 2, 3, 4, 5
 227++6BDF 35
 228++6BE0 30 39 38 37     db '0','9','8','7','6'      ; 0, 9, 8, 7, 6
 228++6BE4 36
 229++6BE5 A7 E9 E8 A3     db '§','й','и','Ј','­'      ; P, O, I, U, Y
 229++6BE9 AD
 230++6BEA 0D A4 AB AE     db 13,'¤','«','®','а'       ; ENTER, L, K, J, H
 230++6BEE E0
 231++6BEF 20 00 EC E2     db ' ',0,'м','в','Ё'      ; SPACE, SYM SHIFT, M, N, B
 231++6BF3 A8
 232++6BF4
 233++6BF4                 ; the following are CAPS SHIFTed
 234++6BF4
 235++6BF4 00 9F 97 91     db 0,'џ','—','‘','Њ'      ; CAPS SHIFT, Z, X, C, V
 235++6BF8 8C
 236++6BF9 94 9B 82 80     db '”','›','‚','Ђ','Џ'      ; A, S, D, F, G
 236++6BFD 8F
 237++6BFE 89 96 93 8A     db '‰','–','“','Љ','…'      ; Q, W, E, R, T
 237++6C02 85
 238++6C03 0F 06 80 81     db 15,6,128,129,8            ; 1, 2, 3, 4, 5
 238++6C07 08
 239++6C08 0C 00 09 0B     db 12,0,9,11,10             ; 0, 9, 8, 7, 6
 239++6C0C 0A
 240++6C0D 87 99 98 83     db '‡','™','','ѓ','Ќ'      ; P, O, I, U, Y
 240++6C11 8D
 241++6C12 0D 84 8B 8E     db 13,'„','‹','Ћ','ђ'       ; ENTER, L, K, J, H
 241++6C16 90
 242++6C17 20 00 9C 92     db ' ',0,'њ','’','€'      ; SPACE, SYM SHIFT, M, N, B
 242++6C1B 88
 243++6C1C
 244++6C1C                 ; the following are SYM SHIFTed
 245++6C1C
 246++6C1C 00 3A EE 3F     db 0,':','о','?','/'       ; CAPS SHIFT, Z, X, C, V
 246++6C20 2F
 247++6C21 A1 ED 5C E5     db 'Ў','н',92,'е','¦'       ; A, S, D, F, G
 247++6C25 A6
 248++6C26 83 84 85 3C     db 131,132,133,'<','>'      ; Q, W, E, R, T
 248++6C2A 3E
 249++6C2B 21 40 23 24     db '!','@','#','$','%'      ; 1, 2, 3, 4, 5
 249++6C2F 25
 250++6C30 5F 29 28 27     db '_',')','(',39,'&'       ; 0, 9, 8, 7, 6
 250++6C34 26
 251++6C35 22 3B 82 5D     db 34,';',130,']','['       ; P, O, I, U, Y
 251++6C39 5B
 252++6C3A 0D 3D 2B 2D     db 13,'=','+','-','^'       ; ENTER, L, K, J, H
 252++6C3E 5E
 253++6C3F 20 00 2E 2C     db ' ',0,'.',',','*'      ; SPACE, SYM SHIFT, M, N, B
 253++6C43 2A
 254++6C44
 255++6C44                 ; the following are CAPS SHIFTed and SYM SHIFTed ("CTRL" key)
 256++6C44
 257++6C44 00 1A 9E 03     db 0,26,'ћ',3,22           ; CAPS SHIFT, Z, X, C, V
 257++6C48 16
 258++6C49 81 9D 04 95     db 'Ѓ','ќ',4,'•','†'               ; A, S, D, F, G
 258++6C4D 86
 259++6C4E 11 17 05 12     db 17,23,5,18,20            ; Q, W, E, R, T
 259++6C52 14
 260++6C53 1B 1C 1D 1E     db 27,28,29,30,31           ; 1, 2, 3, 4, 5
 260++6C57 1F
 261++6C58 7F 00 86 60     db 127,0,134,'`',135      ; 0, 9, 8, 7, 6
 261++6C5C 87
 262++6C5D 10 0F 09 15     db 16,15,9,21,25            ; P, O, I, U, Y
 262++6C61 19
 263++6C62 0D 0C 0B 0A     db 13,12,11,10,8            ; ENTER, L, K, J, H
 263++6C66 08
 264++6C67 20 00 0D 0E     db ' ',0,13,14,2          ; SPACE, SYM SHIFT, M, N, B
 264++6C6B 02
 265++6C6C
 266++6C6C                  endmodule
# file closed: dos/console.asm
   8++6C6C              		include "trdos.asm"
# file opened: dos/trdos.asm
   1++6C6C              ;trdos driver (izzx)
   2++6C6C                  MODULE Dos
   3++6C6C              ; API methods
   4++6C6C              ESX_GETSETDRV = #89
   5++6C6C              ESX_FOPEN = #9A
   6++6C6C              ESX_FCLOSE = #9B
   7++6C6C              ESX_FSYNC = #9C
   8++6C6C              ESX_FREAD = #9D
   9++6C6C              ESX_FWRITE = #9E
  10++6C6C
  11++6C6C              ; File modes
  12++6C6C              FMODE_READ = #01
  13++6C6C              FMODE_WRITE = #06
  14++6C6C              FMODE_CREATE = #0E
  15++6C6C
  16++6C6C                  ; MACRO esxCall func
  17++6C6C                  ; rst #8 : db func
  18++6C6C                  ; ENDM
  19++6C6C
  20++6C6C              ;id = 0 С„Р°Р№Р» РЅРµ РѕС‚РєСЂС‹С‚
  21++6C6C              ;id = 1 С„Р°Р№Р» РґР»СЏ С‡С‚РµРЅРёСЏ
  22++6C6C              ;id = 2 С„Р°Р№Р» РґР»СЏ Р·Р°РїРёСЃРё
  23++6C6C              ;id = 3 С„Р°Р№Р» РґР»СЏ Р·Р°РїРёСЃРё С‚РёРї TRD
  24++6C6C              ;id = 4 С„Р°Р№Р» РґР»СЏ Р·Р°РїРёСЃРё С‚РёРї SCL
  25++6C6C
  26++6C6C              ; HL - filename in ASCIIZ
  27++6C6C              loadBuffer:
  28++6C6C 06 01            ld b, Dos.FMODE_READ
  28++6C6E CD 88 6C       call Dos.fopen
  29++6C71 F5               push af
  30++6C72 21 44 99 01          ld hl, outputBuffer, bc, #ffff - outputBuffer
  30++6C76 BB 66
  30++6C78 CD CE 6E       call Dos.fread
  31++6C7B 21 44 99             ld hl, outputBuffer
  31++6C7E 09             add hl, bc
  31++6C7F AF             xor a
  31++6C80 77             ld (hl), a
  31++6C81 23             inc hl
  31++6C82 77             ld (hl), a
  32++6C83 F1               pop af
  33++6C84 CD D3 6D         call Dos.fclose
  34++6C87 C9               ret
  35++6C88
  36++6C88
  37++6C88              ; Returns:
  38++6C88              ;  A - current drive
  39++6C88              ; getDefaultDrive: ;РЅРёРіРґРµ РЅРµ РёСЃРїРѕР»СЊР·СѓРµС‚СЃСЏ
  40++6C88                  ; ld a, 0 : esxCall ESX_GETSETDRV
  41++6C88                  ; ret
  42++6C88
  43++6C88
  44++6C88
  45++6C88              ; Opens file on default drive
  46++6C88              ; B - File mode
  47++6C88              ; HL - File name
  48++6C88              ; Returns:
  49++6C88              ;  A - file stream id
  50++6C88              fopen:
  51++6C88                  ; push bc : push hl
  52++6C88                  ; call getDefaultDrive
  53++6C88                  ; pop ix : pop bc
  54++6C88                  ; esxCall ESX_FOPEN
  55++6C88                  ; ret
  56++6C88 78           	ld a,b
  57++6C89 FE 01        	cp FMODE_READ ;РµСЃР»Рё СЂРµР¶РёРј РѕС‚РєСЂС‹С‚РёРµ С„Р°Р№Р»Р°
  58++6C8B 28 06        	jr z,fopen_r
  59++6C8D FE 0E        	cp FMODE_CREATE
  60++6C8F 28 39        	jr z,fopen_c ;РµСЃР»Рё СЂРµР¶РёРј СЃРѕР·РґР°РЅРёРµ С„Р°Р№Р»Р°
  61++6C91 18 34        	jr fopen_err ;РёРЅР°С‡Рµ РІС‹С…РѕРґ
  62++6C93
  63++6C93              fopen_r	;РѕС‚РєСЂС‹С‚РёРµ СЃСѓС‰РµСЃС‚РІСѓСЋС‰РµРіРѕ С„Р°Р№Р»Р° РЅР° С‡С‚РµРЅРёРµ (id=1)
  64++6C93              	; ld a,(#5D19) ;РЅРѕРјРµСЂ РґРёСЃРєРѕРІРѕРґР° РїРѕ СѓРјРѕР»С‡Р°РЅРёСЋ
  65++6C93              	; ld 	(prev_drive),a ;Р·Р°РїРѕРјРЅРёРј
  66++6C93 CD 58 72     			call format_name ;
  67++6C96 0E 13        			ld      c,#13 ;move file info to syst var
  68++6C98 CD CF 6D                 call    call3d13
  69++6C9B 0E 0A                    ld      c,#0a ;find file
  70++6C9D CD CF 6D                 call    call3d13
  71++6CA0 79                       ld      a,c
  72++6CA1 FE FF        			cp 		#ff
  73++6CA3 28 22        			jr 		z,fopen_err ;РµСЃР»Рё РЅРµ РЅР°С€Р»Рё С„Р°Р№Р»Р°
  74++6CA5 0E 08                    ld      c,#08 ;read file title
  75++6CA7 CD CF 6D                 call    call3d13
  76++6CAA                          ;ld      hl,loadadr ;РєСѓРґР°
  77++6CAA ED 5B EB 5C              ld      de,(#5ceb) ;РЅР°С‡Р°Р»Рѕ С„Р°Р№Р»Р° СЃРµРєС‚РѕСЂ РґРѕСЂРѕР¶РєР°
  78++6CAE ED 53 16 73              ld      (f_r_cur_trk),de
  79++6CB2
  80++6CB2 3A EA 5C                 ld      a,(#5cea)
  81++6CB5 32 18 73                 ld      (f_r_len_sec),a ;РґР»РёРЅР° РІ СЃРµРєС‚РѕСЂР°С…
  82++6CB8                          ;or      a
  83++6CB8                          ;ret     z    ;РІС‹С…РѕРґ РµСЃР»Рё РїСѓСЃС‚РѕР№
  84++6CB8
  85++6CB8 ED 5B E8 5C  			ld de,(#5CE8) ; РґР»РёРЅР° С„Р°Р№Р»Р° РёР»Рё РїСЂРѕРіСЂР°РјРјРЅРѕР№ С‡Р°СЃС‚Рё РґР»СЏ BASIC
  86++6CBC ED 53 19 73  			ld      (f_r_len),de
  87++6CC0
  88++6CC0                          ; ld      de,(fcurtrk) ;С‚РµРєСѓС‰РёРµ СЃРµРєС‚РѕСЂ РґРѕСЂРѕР¶РєР°
  89++6CC0                          ; ld      (#5cf4),de ;РІРѕСЃСЃС‚Р°РЅРѕРІРёРј
  90++6CC0 AF           			xor a
  91++6CC1 3E 01        			ld 		a,1
  92++6CC3 32 1B 73     			ld (f_r_flag),a ;С„Р»Р°Рі С‡С‚Рѕ С„Р°Р№Р» РґР»СЏ С‡С‚РµРЅРёСЏ РѕС‚РєСЂС‹С‚
  93++6CC6              			;id РєР°РЅР°Р»Р° Р±СѓРґРµС‚ 1
  94++6CC6 C9           	ret
  95++6CC7
  96++6CC7              fopen_err
  97++6CC7 AF           	xor a ;РµСЃР»Рё РЅРёРєР°РєРѕР№ С„Р°Р№Р» РЅРµ РѕС‚РєСЂС‹Р»Рё, С‚Рѕ id = 0
  98++6CC8 37           	scf ;С„Р»Р°Рі РѕС€РёР±РєРё
  99++6CC9 C9           	ret
 100++6CCA
 101++6CCA
 102++6CCA              fopen_c	;СЃРѕР·РґР°РЅРёРµ РЅРѕРІРѕРіРѕ С„Р°Р№Р»Р° (id=2-4)
 103++6CCA              	; ld a,(#5D19) ;РЅРѕРјРµСЂ РґРёСЃРєРѕРІРѕРґР° РїРѕ СѓРјРѕР»С‡Р°РЅРёСЋ
 104++6CCA              	; ld 	(prev_drive),a ;Р·Р°РїРѕРјРЅРёРј
 105++6CCA CD 58 72     	call format_name ;
 106++6CCD              	;РІС‹СЏСЃРЅРёРј, РЅРµ РѕР±СЂР°Р· Р»Рё СЌС‚Рѕ РґР»СЏ СЂР°Р·РІРѕСЂР°С‡РёРІР°РЅРёСЏ
 107++6CCD 21 F2 72         ld hl, trdExt1
 107++6CD0 CD F2 63       call CompareBuff.search
 107++6CD3 A7             and a
 107++6CD4 20 7B          jr nz, fopen_c_trd
 108++6CD6 21 F7 72         ld hl, trdExt2
 108++6CD9 CD F2 63       call CompareBuff.search
 108++6CDC A7             and a
 108++6CDD 20 72          jr nz, fopen_c_trd
 109++6CDF 21 FC 72     	ld hl, sclExt1
 109++6CE2 CD F2 63       call CompareBuff.search
 109++6CE5 A7             and a
 109++6CE6 C2 73 6D       jp nz, fopen_c_scl
 110++6CE9 21 01 73         ld hl, sclExt2
 110++6CEC CD F2 63       call CompareBuff.search
 110++6CEF A7             and a
 110++6CF0 C2 73 6D       jp nz, fopen_c_scl
 111++6CF3
 112++6CF3
 113++6CF3              	;СЃРѕР·РґР°РЅРёРµ РїСЂРѕРёР·РІРѕР»СЊРЅРѕРіРѕ С„Р°Р№Р»Р° (id=2)
 114++6CF3 CD 9B 6D     	call select_drive
 115++6CF6 FE 79        	cp "y"
 116++6CF8 20 CD        	jr nz,fopen_err
 117++6CFA
 118++6CFA CD 43 6D     	call cat_buf_cls
 119++6CFD
 120++6CFD 21 00 48     	ld hl,cat_buf ;СЃС‡РёС‚Р°РµРј РєР°С‚Р°Р»РѕРі РґРёСЃРєР°
 121++6D00 11 00 00     	ld de,0
 122++6D03 01 05 09         ld      bc,#0905 ;
 123++6D06 CD CF 6D         call    call3d13
 124++6D09
 125++6D09 3A E4 50     	ld a,(cat_buf+8*256+#e4) ; РѕР±С‰РµРµ РєРѕР»РёС‡РµСЃС‚РІРѕ С„Р°Р№Р»РѕРІ
 126++6D0C FE 80        	cp 128
 127++6D0E DA 19 6D     	jp c,fopen_c2 ;РµСЃР»Рё СѓР¶Рµ РјР°РєСЃРёРјСѓРј
 128++6D11 21 57 73         ld hl, file_err
 129++6D14 CD DB 69         call DialogBox.msgBox ;РїСЂРµРґСѓСЂРµР¶РґРµРЅРёРµ
 130++6D17 18 AE        	jr fopen_err
 131++6D19
 132++6D19              fopen_c2
 133++6D19 2A E5 50     	ld hl,(cat_buf+8*256+#e5) ; РєРѕР»РёС‡РµСЃС‚РІРѕ СЃРІРѕР±РѕРґРЅС‹С… СЃРµРєС‚РѕСЂРѕРІ РЅР° РґРёСЃРєРµ
 134++6D1C 7C           	ld a,h
 135++6D1D B5           	or l
 136++6D1E 20 08        	jr nz,fopen_c3 ;РµСЃР»Рё РµС‰С‘ РµСЃС‚СЊ РјРµСЃС‚Рѕ
 137++6D20 21 57 73         ld hl, file_err
 138++6D23 CD DB 69         call DialogBox.msgBox ;РїСЂРµРґСѓСЂРµР¶РґРµРЅРёРµ
 139++6D26 18 9F        	jr fopen_err
 140++6D28
 141++6D28              fopen_c3
 142++6D28 ED 5B E1 50  	ld de,(cat_buf+8*256+#e1) ;РїРµСЂРІС‹Рµ СЃРІРѕР±РѕРґРЅС‹Рµ СЃРµРєС‚РѕСЂ-РґРѕСЂРѕР¶РєР°
 143++6D2C ED 53 F4 5C      ld   (#5cf4),de ;РѕС‚СЃСЋРґР° Р±СѓРґРµРј РїРёСЃР°С‚СЊ С„Р°Р№Р»
 144++6D30
 145++6D30 AF           	xor a
 146++6D31 32 2B 73     	ld (sec_shift),a ;РїРµСЂРµРјРµРЅРЅР°СЏ
 147++6D34 21 00 00     	ld hl,0
 148++6D37 22 20 73     	ld (f_w_len+0),hl
 149++6D3A 22 22 73     	ld (f_w_len+2),hl
 150++6D3D 3E 02        	ld a,2 ;id РєР°РЅР°Р»Р°
 151++6D3F 32 1F 73     	ld (f_w_flag),a ;С„Р»Р°Рі С‡С‚Рѕ С„Р°Р№Р» РґР»СЏ Р·Р°РїРёСЃРё РѕС‚РєСЂС‹С‚
 152++6D42 C9           	ret
 153++6D43
 154++6D43
 155++6D43              cat_buf_cls ;РѕС‡РёСЃС‚РєР° Р±СѓС„РµСЂР° РєР°С‚Р°Р»РѕРіР°
 156++6D43 21 00 48     	ld hl,cat_buf ;РѕС‡РёСЃС‚РёС‚СЊ РјРµСЃС‚Рѕ РґР»СЏ РєР°С‚Р°Р»РѕРіР° РґРёСЃРєРµС‚С‹
 157++6D46 11 01 48     	ld de,cat_buf+1
 158++6D49 36 00        	ld (hl),0
 159++6D4B 01 FF 08     	ld bc,9*256-1
 160++6D4E ED B0        	ldir
 161++6D50 C9           	ret
 162++6D51
 163++6D51
 164++6D51
 165++6D51              fopen_c_trd	;РѕС‚РєСЂС‹С‚РёРµ С„Р°Р№Р»Р° РґР»СЏ СЂР°Р·РІРѕСЂР°С‡РёРІР°РЅРёСЏ РѕР±СЂР°Р·Р° trd (id=3)
 166++6D51 CD 9B 6D     	call select_drive
 167++6D54 FE 79        	cp "y"
 168++6D56 C2 C7 6C     	jp nz,fopen_err
 169++6D59
 170++6D59 11 00 00     	ld      de,0 ;РЅР°С‡Р°Р»Рѕ СЃРµРєС‚РѕСЂ РґРѕСЂРѕР¶РєР°
 171++6D5C ED 53 F4 5C      ld      (#5cf4),de
 172++6D60
 173++6D60 AF           	xor a
 174++6D61 32 2B 73     	ld (sec_shift),a ;РїРµСЂРµРјРµРЅРЅР°СЏ
 175++6D64 21 00 00     	ld hl,0
 176++6D67 22 20 73     	ld (f_w_len+0),hl
 177++6D6A 22 22 73     	ld (f_w_len+2),hl
 178++6D6D 3E 03        	ld a,3 ;id РєР°РЅР°Р»Р°
 179++6D6F 32 1F 73     	ld (f_w_flag),a ;С„Р»Р°Рі С‡С‚Рѕ trd РґР»СЏ Р·Р°РїРёСЃРё РѕС‚РєСЂС‹С‚
 180++6D72 C9           	ret
 181++6D73
 182++6D73
 183++6D73
 184++6D73              fopen_c_scl	;РѕС‚РєСЂС‹С‚РёРµ С„Р°Р№Р»Р° РґР»СЏ СЂР°Р·РІРѕСЂР°С‡РёРІР°РЅРёСЏ РѕР±СЂР°Р·Р° scl (id=4)
 185++6D73 CD 9B 6D     	call select_drive
 186++6D76 FE 79        	cp "y"
 187++6D78 C2 C7 6C     	jp nz,fopen_err
 188++6D7B
 189++6D7B 11 00 00     	ld      de,0 ;РЅР°С‡Р°Р»Рѕ СЃРµРєС‚РѕСЂ РґРѕСЂРѕР¶РєР°
 190++6D7E ED 53 F4 5C      ld      (#5cf4),de
 191++6D82
 192++6D82 CD 43 6D     	call cat_buf_cls ;РїРѕС‡РёСЃС‚РёС‚СЊ РјРµСЃС‚Рѕ
 193++6D85
 194++6D85 CD CD 70     	call scl_parse ;Р·Р°РїСѓСЃРє С†РёРєР»Р° СЃР±РѕСЂРєРё РѕР±СЂР°Р·Р°
 195++6D88
 196++6D88 AF           	xor a
 197++6D89 32 2B 73     	ld (sec_shift),a ;РїРµСЂРµРјРµРЅРЅР°СЏ
 198++6D8C              	;ld (scl_que),a
 199++6D8C 21 00 00     	ld hl,0
 200++6D8F 22 20 73     	ld (f_w_len+0),hl
 201++6D92 22 22 73     	ld (f_w_len+2),hl
 202++6D95 3E 04        	ld a,4 ;id РєР°РЅР°Р»Р°
 203++6D97 32 1F 73     	ld (f_w_flag),a ;С„Р»Р°Рі С‡С‚Рѕ scl РґР»СЏ Р·Р°РїРёСЃРё РѕС‚РєСЂС‹С‚
 204++6D9A C9           	ret
 205++6D9B
 206++6D9B
 207++6D9B
 208++6D9B
 209++6D9B
 210++6D9B              select_drive	;Р·Р°РїСЂРѕСЃ РЅРѕРјРµСЂР° РґРёСЃРєРѕРІРѕРґР°
 211++6D9B 3A 19 5D     	ld a,(#5D19) ;РЅРѕРјРµСЂ РґРёСЃРєРѕРІРѕРґР° РїРѕ СѓРјРѕР»С‡Р°РЅРёСЋ
 212++6D9E C6 41        	add a,"A"
 213++6DA0 32 C4 72     	ld (write_ima_d),a ;РїРѕРґСЃС‚Р°РІРёРј Р±СѓРєРІСѓ РІ Р·Р°РїСЂРѕСЃРµ
 214++6DA3 21 B8 72         ld hl, write_ima
 215++6DA6 CD E4 69         call DialogBox.msgNoWait ;РїСЂРµРґСѓСЂРµР¶РґРµРЅРёРµ
 216++6DA9              WAITKEY_trd
 217++6DA9              	;halt
 218++6DA9 CD 2D 6A     	call Console.getC
 219++6DAC FE FF        	cp 255
 220++6DAE 28 F9        	JR Z,WAITKEY_trd	;Р¶РґС‘Рј Р»СЋР±СѓСЋ РєР»Р°РІРёС€Сѓ
 221++6DB0 FE 79        	cp "y"
 222++6DB2 C8           	ret z
 223++6DB3 FE 6E        	cp "n"
 224++6DB5 C8           	ret z
 225++6DB6 FE 61        	cp "a"
 226++6DB8 38 EF        	jr c,WAITKEY_trd
 227++6DBA FE 65        	cp "e"
 228++6DBC 30 EB        	jr nc,WAITKEY_trd
 229++6DBE D6 61        	sub "a"
 230++6DC0 32 19 5D         ld      (#5d19) ,a
 231++6DC3 0E 01            ld      c,1
 232++6DC5 CD CF 6D         call    call3d13
 233++6DC8 0E 18            ld      c,#18
 234++6DCA CD CF 6D         call    call3d13
 235++6DCD 18 CC        	jr select_drive
 236++6DCF
 237++6DCF
 238++6DCF              ; restore_drive ;РІРѕСЃСЃС‚Р°РЅРѕРІРёС‚СЊ РґРёСЃРєРѕРІРѕРґ РїРѕ СѓРјРѕР»С‡Р°РЅРёСЋ
 239++6DCF              	; ld 	a,(prev_drive)
 240++6DCF                  ; ld      (#5d19) ,a
 241++6DCF                  ; ld      c,1
 242++6DCF                  ; call    call3d13
 243++6DCF                  ; ld      c,#18
 244++6DCF                  ; call    call3d13
 245++6DCF              	; ret
 246++6DCF
 247++6DCF
 248++6DCF              call3d13 ;С„РёРєСЃ РґР»СЏ GMX
 249++6DCF              	ifndef ZSGMX
 250++6DCF C3 13 3D         jp    #3d13
 251++6DD2              	endif
 252++6DD2
 253++6DD2              	ifdef ZSGMX
 254++6DD2 ~                call    #3d13
 255++6DD2 ~            	exx
 256++6DD2 ~            	call TextMode.gmxscron
 257++6DD2 ~            	exx
 258++6DD2              	endif
 259++6DD2 C9           	ret
 260++6DD3
 261++6DD3
 262++6DD3
 263++6DD3              ; A - file stream id
 264++6DD3              fclose:
 265++6DD3                  ;esxCall ESX_FCLOSE
 266++6DD3              	; push af
 267++6DD3              ; WAITKEY2	XOR A:IN A,(#FE):CPL:AND #1F:JR Z,WAITKEY2
 268++6DD3              	; pop af
 269++6DD3 FE 02        	cp 2 ;РµСЃР»Рё РѕР±С‹С‡РЅС‹Р№ С„Р°Р№Р»
 270++6DD5 C2 BA 6E     	jp nz,fclose_scl
 271++6DD8
 272++6DD8              	;РґРѕРїРёСЃР°С‚СЊ РѕСЃС‚Р°С‚РѕРє С„Р°Р№Р»Р°
 273++6DD8 3A 24 73     	ld a,(write_end_flag) ;РЅСѓР¶РЅРѕ Р·Р°РїРёСЃС‹РІР°С‚СЊ РѕСЃС‚Р°С‚РѕРє?
 274++6DDB B7           	or a
 275++6DDC 20 0D        	jr nz,fclose_f ;РЅРµ РЅСѓР¶РЅРѕ
 276++6DDE
 277++6DDE 21 00 51     	ld hl,sec_buf
 278++6DE1 01 06 01     	ld bc,#0106
 279++6DE4 ED 5B F4 5C  	ld de,(#5cf4)
 280++6DE8 CD CF 6D     	call call3d13
 281++6DEB
 282++6DEB              fclose_f ;РїРѕРїСЂР°РІРёС‚СЊ РєР°С‚Р°Р»РѕРі
 283++6DEB 3A 22 73     	ld a,(f_w_len+2) ;СЃР°РјС‹Р№ СЃС‚Р°СЂС€РёР№ Р±Р°Р№С‚ РґР»РёРЅС‹ С„Р°Р№Р»Р°
 284++6DEE 2A 20 73     	ld hl,(f_w_len+0)
 285++6DF1 B4           	or h
 286++6DF2 B5           	or l
 287++6DF3 CA C6 6E     	jp z,fclose_ex ;РІС‹С…РѕРґ РµСЃР»Рё РґР»РёРЅР° 0
 288++6DF6
 289++6DF6              	;РїСЂРѕРІРµСЂРєРё РЅР° Р·Р°РїРѕР»РЅРµРЅРёРµ
 290++6DF6 3A E4 50     	ld a,(cat_buf+8*256+#e4) ; РѕР±С‰РµРµ РєРѕР»РёС‡РµСЃС‚РІРѕ С„Р°Р№Р»РѕРІ
 291++6DF9 FE 80        	cp 128
 292++6DFB D2 C6 6E     	jp nc,fclose_ex ;РµСЃР»Рё СѓР¶Рµ РјР°РєСЃРёРјСѓРј
 293++6DFE 2A E5 50     	ld hl,(cat_buf+8*256+#e5) ; РєРѕР»РёС‡РµСЃС‚РІРѕ СЃРІРѕР±РѕРґРЅС‹С… СЃРµРєС‚РѕСЂРѕРІ РЅР° РґРёСЃРєРµ
 294++6E01 7C           	ld a,h
 295++6E02 B5           	or l
 296++6E03 CA C6 6E     	jp z,fclose_ex ;РµСЃР»Рё РјРµСЃС‚Р° РЅРµС‚
 297++6E06
 298++6E06 3A 22 73     	ld a,(f_w_len+2) ;СЃР°РјС‹Р№ СЃС‚Р°СЂС€РёР№ Р±Р°Р№С‚ РґР»РёРЅС‹ С„Р°Р№Р»Р°
 299++6E09 B7           	or a
 300++6E0A 20 28        	jr nz,fclose_f_multi ;РµСЃР»Рё С„Р°Р№Р» Р±РѕР»СЊС€Рµ 255 СЃРµРєС‚РѕСЂРѕРІ (65280)
 301++6E0C 3A 21 73     	ld a,(f_w_len+1)
 302++6E0F FE FF        	cp 255
 303++6E11 20 05        	jr nz,fclose_f1
 304++6E13 3A 20 73     	ld a,(f_w_len+0)
 305++6E16 20 1C        	jr nz,fclose_f_multi ;РµСЃР»Рё С„Р°Р№Р» Р±РѕР»СЊС€Рµ 255 СЃРµРєС‚РѕСЂРѕРІ (65280)
 306++6E18              fclose_f1
 307++6E18              	;С„Р°Р№Р» РЅРµ РїСЂРµРІС‹С€Р°РµС‚ РјР°РєСЃРёРјР°Р»СЊРЅС‹Р№ СЂР°Р·РјРµСЂ РґР»СЏ trdos
 308++6E18 ED 5B 20 73  	ld de,(f_w_len+0)
 309++6E1C 21 11 73     	ld hl,f_name+11 ;РґР»РёРЅР° С„Р°Р№Р»Р°
 310++6E1F 73           	ld (hl),e
 311++6E20 23           	inc hl
 312++6E21 72           	ld (hl),d
 313++6E22 23           	inc hl
 314++6E23 3A 21 73     	ld a,(f_w_len+1) ;РґР»РёРЅР° СЃРµРєС‚РѕСЂРѕРІ
 315++6E26 77           	ld (hl),a
 316++6E27 3A 20 73     	ld a,(f_w_len+0) ;РґР»РёРЅР° РјР»Р°РґС€РёР№
 317++6E2A B7           	or a
 318++6E2B 28 01        	jr z,fclose_f2
 319++6E2D 34           	inc (hl) ;РєРѕСЂСЂРµРєС†РёСЏ СЃРµРєС‚РѕСЂРѕРІ
 320++6E2E              fclose_f2
 321++6E2E CD 54 6E     	call fclose_f_one ;Р·Р°РїРёСЃР°С‚СЊ РёРЅС„РѕСЂРјР°С†РёСЋ
 322++6E31 C3 C6 6E     	jp fclose_ex ;РіРѕС‚РѕРІРѕ
 323++6E34
 324++6E34              fclose_f_multi ;С„Р°Р№Р» Р±РѕР»СЊС€РѕР№, Р±СѓРґРµС‚ РЅРµСЃРєРѕР»СЊРєРѕ Р·Р°РїРёСЃРµР№ РІ РєР°С‚Р°Р»РѕРіРµ
 325++6E34 21 11 73     	ld hl,f_name+11 ;РґР»РёРЅР° С„Р°Р№Р»Р°
 326++6E37 36 00        	ld (hl),0
 327++6E39 23           	inc hl
 328++6E3A 36 FF        	ld (hl),#ff ;65280
 329++6E3C 23           	inc hl
 330++6E3D              	;РґР»РёРЅР° СЃРµРєС‚РѕСЂРѕРІ
 331++6E3D 36 FF        	ld (hl),#ff
 332++6E3F CD 54 6E     	call fclose_f_one ;Р·Р°РїРёСЃР°С‚СЊ РёРЅС„РѕСЂРјР°С†РёСЋ
 333++6E42
 334++6E42              	;РІС‹С‡РµСЃС‚СЊ РґР»РёРЅСѓ Р·Р°РїРёСЃР°РЅРЅРѕРіРѕ
 335++6E42 2A 21 73     	ld hl,(f_w_len+1) ;СЃС‚Р°СЂС€РёР№ Рё СЃСЂРµРґРЅРёР№ Р±Р°Р№С‚
 336++6E45 01 FF 00     	ld bc,255
 337++6E48 A7           	and a
 338++6E49 ED 42        	sbc hl,bc ;РІС‹С‡РµСЃС‚СЊ 255 СЃРµРєС‚РѕСЂРѕРІ
 339++6E4B 22 21 73     	ld (f_w_len+1),hl
 340++6E4E
 341++6E4E 21 0E 73     	ld hl,f_name+8 ;СЂР°СЃС€РёСЂРµРЅРёРµ
 342++6E51 34           	inc (hl) ;РёР·РјРµРЅРёС‚СЊ РЅР° СЃР»РµРґСѓСЋС‰РµРµ РїРѕ Р°Р»С„Р°РІРёС‚Сѓ
 343++6E52
 344++6E52 18 97        	jr fclose_f ;СЃРЅР°С‡Р°Р»Р°
 345++6E54
 346++6E54
 347++6E54              fclose_f_one ;Р·Р°РїРёСЃСЊ РѕР± РѕРґРЅРѕРј С„Р°Р№Р»Рµ
 348++6E54 3A E4 50     			ld a,(cat_buf+8*256+#e4) ; РѕР±С‰РµРµ РєРѕР»РёС‡РµСЃС‚РІРѕ С„Р°Р№Р»РѕРІ
 349++6E57 6F           			ld l,a ;СѓР·РЅР°С‚СЊ РІ РєР°РєРѕРј СЃРµРєС‚РѕСЂРµ Р±СѓРґРµС‚ Р·Р°РїРёСЃСЊ Рѕ С„Р°Р№Р»Рµ
 350++6E58 26 00        			ld h,0
 351++6E5A 29           			add hl,hl ;*2
 352++6E5B 29           			add hl,hl ;*4
 353++6E5C 29           			add hl,hl ;*8
 354++6E5D 29           			add hl,hl ;*16
 355++6E5E 7C           			ld a,h ;Р·Р°РїРѕРјРЅРёС‚СЊ РЅРѕРјРµСЂ СЃРµС‚РѕСЂР° РІ РєР°С‚Р°Р»РѕРіРµ
 356++6E5F 32 69 73     			ld (sec_cat),a
 357++6E62 01 00 48     			ld bc,cat_buf
 358++6E65 09           			add hl,bc ;Р·РґРµСЃСЊ Р±СѓРґРµС‚ Р·Р°РїРёСЃСЊ Рѕ РЅРѕРІРѕРј С„Р°Р№Р»Рµ
 359++6E66 EB           			ex de,hl
 360++6E67
 361++6E67 21 06 73     			ld hl,f_name ;Р·Р°РїРёСЃСЊ Рѕ С„Р°Р№Р»Рµ
 362++6E6A 01 10 00     			ld bc,16
 363++6E6D ED B0        			ldir ;СЃРєРѕРїРёСЂРѕРІР°С‚СЊ
 364++6E6F EB           			ex de,hl
 365++6E70 2B           			dec hl
 366++6E71 ED 5B E1 50  			ld de,(cat_buf+8*256+#e1) ;РїРµСЂРІС‹Рµ СЃРІРѕР±РѕРґРЅС‹Рµ СЃРµРєС‚РѕСЂ-РґРѕСЂРѕР¶РєР° РЅР°Р·РЅР°С‡РµРЅРёСЏ
 367++6E75 72           			ld (hl),d ;РґРѕСЂРѕР¶РєР°
 368++6E76 2B           			dec hl
 369++6E77 73           			ld (hl),e ;СЃРµРєС‚РѕСЂ
 370++6E78
 371++6E78 2E 00        			ld l,0 ;Р·Р°РїРёСЃР°С‚СЊ СЃРµРєС‚РѕСЂ С†РµР»РёРєРѕРј РїРѕ СЂРѕРІРЅРѕРјСѓ Р°РґСЂРµСЃСѓ
 372++6E7A 16 00        			ld d,0
 373++6E7C 3A 69 73     			ld a,(sec_cat)
 374++6E7F 5F           			ld e,a ;РЅРѕРјРµСЂ СЃРµРєС‚РѕСЂР°
 375++6E80 01 06 01     			ld bc,#0106 ;1 СЃРµРєС‚РѕСЂ Р·Р°РїРёСЃР°С‚СЊ
 376++6E83 CD CF 6D     			call call3d13
 377++6E86
 378++6E86              			;СЃР»СѓР¶РµР±РЅС‹Р№ СЃРµРєС‚РѕСЂ
 379++6E86 ED 5B E1 50  			ld de,(cat_buf+8*256+#e1) ;РїРµСЂРІС‹Рµ СЃРІРѕР±РѕРґРЅС‹Рµ СЃРµРєС‚РѕСЂ-РґРѕСЂРѕР¶РєР°
 380++6E8A 3A 13 73     			ld a,(f_name+13) ;СЂР°Р·РјРµСЂ С„Р°Р№Р»Р° РІ СЃРµРєС‚РѕСЂР°С…
 381++6E8D 47           			ld b,a
 382++6E8E CD AC 72     			call calc_next_pos2
 383++6E91 ED 53 E1 50  			ld (cat_buf+8*256+#e1),de
 384++6E95
 385++6E95 2A E5 50     			ld hl,(cat_buf+8*256+#e5) ; РєРѕР»РёС‡РµСЃС‚РІРѕ СЃРІРѕР±РѕРґРЅС‹С… СЃРµРєС‚РѕСЂРѕРІ РЅР° РґРёСЃРєРµ
 386++6E98 3A 13 73     			ld a,(f_name+13) ;СЂР°Р·РјРµСЂ С„Р°Р№Р»Р° РІ СЃРµРєС‚РѕСЂР°С…
 387++6E9B 4F           			ld c,a
 388++6E9C 06 00        			ld b,0
 389++6E9E A7           			and a
 390++6E9F ED 42        			sbc hl,bc
 391++6EA1 30 03        			jr nc,fclose_f_one2
 392++6EA3 21 00 00     			ld hl,0 ;РµСЃР»Рё Р±С‹Р»Рѕ РѕС‚СЂРёС†Р°С‚РµР»СЊРЅРѕРµ
 393++6EA6              fclose_f_one2
 394++6EA6 22 E5 50     			ld (cat_buf+8*256+#e5),hl
 395++6EA9
 396++6EA9 21 E4 50     			ld hl,cat_buf+8*256+#e4 ; РѕР±С‰РµРµ РєРѕР»РёС‡РµСЃС‚РІРѕ С„Р°Р№Р»РѕРІ
 397++6EAC 34           			inc (hl)
 398++6EAD
 399++6EAD 21 00 50     			ld hl,cat_buf+8*256
 400++6EB0 11 08 00     			ld de,#0008
 401++6EB3 01 06 01     			ld bc,#0106 ;1 СЃРµРєС‚РѕСЂ Р·Р°РїРёСЃР°С‚СЊ
 402++6EB6 CD CF 6D     			call call3d13
 403++6EB9 C9           			ret
 404++6EBA
 405++6EBA
 406++6EBA              fclose_scl
 407++6EBA FE 04        	cp 4 ;РµСЃР»Рё scl
 408++6EBC 20 08        	jr nz,fclose_ex
 409++6EBE 21 00 51     	ld hl,sec_buf ;
 410++6EC1 06 01        	ld b,1
 411++6EC3 CD AC 70     	call scl_write_buf ;РґРѕРїРёС€РµРј РѕСЃС‚Р°С‚РѕРє scl, РµСЃР»Рё РµСЃС‚СЊ
 412++6EC6
 413++6EC6              fclose_ex
 414++6EC6 AF           	xor a ;РєР°Рє Р±С‹ Р·Р°РєСЂС‹РІР°РµРј РІСЃРµ С„Р°Р№Р»С‹
 415++6EC7 32 1B 73     	ld (f_r_flag),a
 416++6ECA 32 1F 73     	ld (f_w_flag),a
 417++6ECD              	;call restore_drive ;РІРµСЂРЅСѓС‚СЊ РґРёСЃРє, РєР°РєРѕР№ Р±С‹Р»
 418++6ECD C9               ret
 419++6ECE
 420++6ECE
 421++6ECE
 422++6ECE
 423++6ECE              ; A - file stream id
 424++6ECE              ; BC - length
 425++6ECE              ; HL - buffer
 426++6ECE              ; Returns
 427++6ECE              ;  BC - length(how much was actually read)
 428++6ECE              fread: ;(id=1)
 429++6ECE                  ; push hl : pop ix
 430++6ECE                  ; esxCall ESX_FREAD
 431++6ECE              	; push af
 432++6ECE              	; ld a,4
 433++6ECE              	; out (254),a
 434++6ECE              ; WAITKEY	XOR A:IN A,(#FE):CPL:AND #1F:JR Z,WAITKEY
 435++6ECE              	; xor a
 436++6ECE              	; out (254),a
 437++6ECE              	; pop af
 438++6ECE
 439++6ECE FE 01        	cp 1 ;id = 1?
 440++6ED0 20 06        	jr nz,fread_no_chek ;РІС‹С…РѕРґ РµСЃР»Рё РЅРѕРјРµСЂ РїРѕС‚РѕРєР° РЅРµ = 1
 441++6ED2 3A 1B 73     	ld a,(f_r_flag)
 442++6ED5 B7           	or a
 443++6ED6 20 06        	jr nz,fread_chek ;С„Р°Р№Р» СѓР¶Рµ РѕС‚РєСЂС‹С‚?
 444++6ED8              fread_no_chek ;РІС‹С…РѕРґ СЃ РѕС€РёР±РєРѕР№
 445++6ED8 AF           	xor a
 446++6ED9 37           	scf ;С„Р»Р°Рі РѕС€РёР±РєРё
 447++6EDA 01 00 00     	ld bc,0 ;РЅРёС‡РµРіРѕ РјС‹ РЅРµ СЃС‡РёС‚Р°Р»Рё
 448++6EDD C9           	ret
 449++6EDE
 450++6EDE              fread_chek
 451++6EDE ED 4B 17 73  	ld bc,(f_r_len_sec-1) ;Р·Р°РіСЂСѓР¶Р°РµРј С„Р°Р№Р» С†РµР»РёРєРѕРј, РЅРµ СЃРјРѕС‚СЂСЏ РЅР° С‚Рѕ, СЃРєРѕР»СЊРєРѕ Р±Р°Р№С‚ Р±С‹Р»Рѕ Р·Р°РїСЂРѕС€РµРЅРѕ
 452++6EE2 0E 05            ld      c,5 ;read С‡РёС‚Р°РµРј С†РµР»С‹РјРё СЃРµРєС‚РѕСЂР°РјРё
 453++6EE4 ED 5B 16 73  	ld de,(f_r_cur_trk)
 454++6EE8 CD CF 6D         call    call3d13
 455++6EEB ED 4B 19 73  	ld bc,(f_r_len) ;РІРѕР·РІСЂР°С‚РёРј СЃРєРѕР»СЊРєРѕ СЃС‡РёС‚Р°Р»Рё Р±Р°Р№С‚ (РґР»РёРЅСѓ С„Р°Р№Р»Р°)
 456++6EEF AF           	xor a ;С„Р»Р°РіРё СЃР±СЂРѕСЃРёРј
 457++6EF0 C9               ret
 458++6EF1
 459++6EF1              ; A - file stream id
 460++6EF1              ; BC - length
 461++6EF1              ; HL - buffer
 462++6EF1              ; Returns:
 463++6EF1              ;   BC - actually written bytes
 464++6EF1              fwrite: ;
 465++6EF1                  ; push hl : pop ix
 466++6EF1                  ; esxCall ESX_FWRITE
 467++6EF1
 468++6EF1              	; push af
 469++6EF1              	; ld a,2
 470++6EF1              	; out (254),a
 471++6EF1              ; WAITKEY1	XOR A:IN A,(#FE):CPL:AND #1F:JR Z,WAITKEY1
 472++6EF1              	; xor a
 473++6EF1              	; out (254),a
 474++6EF1              	; pop af
 475++6EF1
 476++6EF1 FE 02        	cp 2 ;id = 2?
 477++6EF3 28 0F        	jr z,fwrite_chek ;РїСЂРѕРІРµСЂРєР° id РїРѕС‚РѕРєР°
 478++6EF5 FE 03        	cp 3 ;id = 3?
 479++6EF7 28 0B        	jr z,fwrite_chek_trd ;РїСЂРѕРІРµСЂРєР° id РїРѕС‚РѕРєР°
 480++6EF9 FE 04        	cp 4 ;id = 4?
 481++6EFB CA E7 6F     	jp z,fwrite_chek_scl ;РїСЂРѕРІРµСЂРєР° id РїРѕС‚РѕРєР°
 482++6EFE
 483++6EFE
 484++6EFE              fwrite_no_chek ;РІС‹С…РѕРґ СЃ РѕС€РёР±РєРѕР№
 485++6EFE AF           	xor a
 486++6EFF 37           	scf ;С„Р»Р°Рі РѕС€РёР±РєРё
 487++6F00 01 00 00     	ld bc,0 ;РЅРёС‡РµРіРѕ РјС‹ РЅРµ Р·Р°РїРёСЃР°Р»Рё
 488++6F03 C9           	ret
 489++6F04
 490++6F04              fwrite_chek ;Р·Р°РїРёСЃСЊ РїСЂРѕРёР·РІРѕР»СЊРЅРѕРіРѕ С‚РёРїР° С„Р°Р№Р»Р° (id=2)
 491++6F04
 492++6F04              	;РЅРµ РѕС‚Р»РёС‡Р°РµС‚СЃСЏ РѕС‚ Р·Р°РїРёСЃРё trd, РїРёС€РµС‚СЃСЏ РІС…РѕРґСЏС‰РёР№ РїРѕС‚РѕРє РЅР° РґРёСЃРє, РѕС‚Р»РёС‡РёСЏ РїСЂРё РѕС‚РєСЂС‹С‚РёРё Рё Р·Р°РєСЂС‹С‚РёРё С„Р°Р№Р»Р°
 493++6F04
 494++6F04
 495++6F04
 496++6F04
 497++6F04
 498++6F04              fwrite_chek_trd ;Р·Р°РїРёСЃСЊ trd С„Р°Р№Р»Р° (СЂР°Р·РІРѕСЂР°С‡РёРІР°РЅРёРµ РѕР±СЂР°Р·Р°, id=3)
 499++6F04              	; ld a,2
 500++6F04              	; out (254),a
 501++6F04              ; WAITKEY_t	XOR A:IN A,(#FE):CPL:AND #1F:JR Z,WAITKEY_t
 502++6F04              	; xor a
 503++6F04              	; out (254),a
 504++6F04 3A 1F 73     	ld a,(f_w_flag)
 505++6F07 B7           	or a
 506++6F08 28 F4        	jr z,fwrite_no_chek ;С„Р°Р№Р» СѓР¶Рµ РѕС‚РєСЂС‹С‚?
 507++6F0A ED 43 25 73  	ld (temp_bc),bc ;РґР»РёРЅР°
 508++6F0E 22 27 73     	ld (temp_hl),hl ;Р°РґСЂРµСЃ РґР°РЅРЅС‹С…
 509++6F11 78           	ld a,b
 510++6F12 B1           	or c
 511++6F13 28 E9        	jr z,fwrite_no_chek ; РµСЃР»Рё РґР»РёРЅР° 0, С‚Рѕ РІС‹С…РѕРґ
 512++6F15
 513++6F15              	;Р·Р°С‰РёС‚Р° РѕС‚ РїРµСЂРµРїРѕР»РЅРµРЅРёСЏ РґРёСЃРєР°
 514++6F15 ED 5B F4 5C  	ld de,(#5cf4)
 515++6F19 7A           	ld a,d
 516++6F1A FE A0        	cp #a0 ;РїРѕСЃР»РµРґРЅСЏСЏ РґРѕСЂРѕР¶РєР° 160
 517++6F1C 30 E0        	jr nc,fwrite_no_chek
 518++6F1E
 519++6F1E AF           	xor a
 520++6F1F 32 2D 73     	ld (sec_part),a ;РѕР±РЅСѓР»РёС‚СЊ РїРµСЂРµРјРµРЅРЅС‹Рµ
 521++6F22 32 2C 73     	ld (sec_shift2),a
 522++6F25 32 2D 73     	ld (sec_shift2+1),a
 523++6F28 32 2E 73     	ld (sec_shift_flag),a
 524++6F2B 32 24 73     	ld (write_end_flag),a ;
 525++6F2E
 526++6F2E
 527++6F2E 3A 2B 73     	ld a,(sec_shift)
 528++6F31 B7           	or a
 529++6F32 28 43        	jr z,fwrite_trd3 ;РµСЃР»Рё СЃРјРµС‰РµРЅРёСЏ РЅРµС‚, С‚Рѕ РїРµСЂРІСѓСЋ С‡Р°СЃС‚СЊ РїСЂРѕРїСѓСЃС‚РёРј
 530++6F34
 531++6F34
 532++6F34 4F           	ld c,a
 533++6F35 06 00        	ld b,0
 534++6F37 2A 25 73     	ld hl,(temp_bc) ;РїСЂРѕРІРµСЂРєР° Р·Р°РїРѕР»РЅРёС‚СЃСЏ Р»Рё С†РµР»С‹Р№ СЃРµРєС‚РѕСЂ
 535++6F3A 09           	add hl,bc
 536++6F3B
 537++6F3B 3E 01        	ld a,1
 538++6F3D 32 24 73     	ld (write_end_flag),a ;С„Р»Р°Рі С‡С‚Рѕ РЅРµ РЅСѓР¶РЅРѕ РґРѕРїРёСЃС‹РІР°С‚СЊ РѕСЃС‚Р°С‚РѕРє
 539++6F40
 540++6F40 7C           	ld a,h
 541++6F41 B7           	or a
 542++6F42 20 05        	jr nz,fwrite_trd4
 543++6F44 3E 01        	ld a,1
 544++6F46 32 2E 73     	ld (sec_shift_flag),a ;С„Р»Р°Рі С‡С‚Рѕ РЅРµ Р·Р°РїРѕР»РЅРµРЅ СЃРµРєС‚РѕСЂ
 545++6F49
 546++6F49              fwrite_trd4
 547++6F49 21 00 51     	ld hl,sec_buf ;Р±СѓС„РµСЂ РїРѕСЃР»РµРґРЅРµРіРѕ СЃРµРєС‚РѕСЂР°
 548++6F4C 09           	add hl,bc ;РЅР° СЌС‚РѕР№ С‚РѕС‡РєРµ РѕСЃС‚Р°РЅРѕРІРёР»РёСЃСЊ
 549++6F4D EB           	ex de,hl
 550++6F4E 2A 27 73     	ld hl,(temp_hl) ;РїСЂРёСЃРѕРµРґРёРЅРёРј РЅР°С‡Р°Р»Рѕ РґР°РЅРЅС‹С… РІ РєРѕРЅРµС† РїСЂРµРґС‹РґСѓС‰РёС…
 551++6F51              	; ld a,c
 552++6F51              	; or a
 553++6F51              	; jr nz,fwrite_trd2
 554++6F51              	; inc b ;РєРѕСЂСЂРµРєС†РёСЏ
 555++6F51              ; fwrite_trd2
 556++6F51              	; ld c,a
 557++6F51 AF           	xor a
 558++6F52 91           	sub c
 559++6F53 4F           	ld c,a ;СЃРєРѕР»СЊРєРѕ РѕСЃС‚Р°Р»РѕСЃСЊ РїРµСЂРµРЅРµСЃС‚Рё РґРѕ Р·Р°РїРѕР»РЅРµРЅРёСЏ СЃРµРєС‚РѕСЂР°
 560++6F54 ED 43 2C 73  	ld (sec_shift2),bc ;СЃРѕС…СЂР°РЅРёРј СЃРєРѕР»СЊРєРѕ РґРѕР±Р°РІРёР»Рё Р±Р°Р№С‚
 561++6F58 ED B0        	ldir
 562++6F5A
 563++6F5A 3A 2E 73     	ld a,(sec_shift_flag)
 564++6F5D B7           	or a
 565++6F5E 20 17        	jr nz,fwrite_trd3 ;РµСЃР»Рё СЃРµРєС‚РѕСЂ РµС‰С‘ РЅРµ Р·Р°РїРѕР»РЅРµРЅ РїРёСЃР°С‚СЊ РЅРµ Р±СѓРґРµРј
 566++6F60
 567++6F60 21 00 51     	ld hl,sec_buf
 568++6F63 ED 5B F4 5C  	ld de,(#5cf4)
 569++6F67              	;ld (f_w_cur_trk),de	;Р·Р°РїРѕРјРЅРёРј РїРѕР·РёС†РёСЋ
 570++6F67 01 06 01         ld      bc,#0106 ;РїРёС€РµРј 1 СЃРµРєС‚РѕСЂ РёР· Р±СѓС„РµСЂР°
 571++6F6A CD CF 6D         call    call3d13
 572++6F6D 79           	ld a,c
 573++6F6E FE FF        	cp 255
 574++6F70 CA FE 6E     	jp z,fwrite_no_chek ;РІС‹С…РѕРґ РµСЃР»Рё РѕС€РёР±РєР°
 575++6F73
 576++6F73 AF           	xor a
 577++6F74 32 24 73     	ld (write_end_flag),a ;С„Р»Р°Рі С‡С‚Рѕ РЅСѓР¶РЅРѕ РґРѕРїРёСЃС‹РІР°С‚СЊ РѕСЃС‚Р°С‚РѕРє
 578++6F77              	; ld de,(f_w_cur_trk) ;РµСЃР»Рё СЃРµРєС‚РѕСЂ РµС‰С‘ РЅРµ Р·Р°РїРѕР»РЅРµРЅ, РѕСЃС‚Р°РЅРµРјСЃСЏ РЅР° СЃС‚Р°СЂРѕР№ РїРѕР·РёС†РёРё
 579++6F77              	; ld (#5cf4),de
 580++6F77              	; ld b,1 ;РЅР° СЃРµРєС‚РѕСЂ РІРїРµСЂС‘Рґ
 581++6F77              	; ld de,(f_w_cur_trk)
 582++6F77              	; call calc_next_pos
 583++6F77              	; ld (f_w_cur_trk),de
 584++6F77
 585++6F77              fwrite_trd3
 586++6F77 2A 27 73     	ld hl,(temp_hl) ;Р·Р°РїРёС€РµРј РѕСЃС‚Р°С‚РѕРє РґР°РЅРЅС‹С…
 587++6F7A              	;ld a,(sec_shift)
 588++6F7A              	;ld c,a
 589++6F7A              	;ld b,0
 590++6F7A ED 4B 2C 73  	ld bc,(sec_shift2)
 591++6F7E 09           	add hl,bc ;СЃ СЌС‚РѕР№ С‚РѕС‡РєРё РїРёС€РµРј
 592++6F7F 22 29 73     	ld (temp_hl2),hl ;СЃРѕС…СЂР°РЅРёРј РЅР°С‡Р°Р»Рѕ Р·Р°РїРёСЃРё РІС‚РѕСЂРѕРіРѕ СЃРµРєС‚РѕСЂР°
 593++6F82
 594++6F82 2A 25 73     	ld hl,(temp_bc) ;РІС‹С‡РёСЃР»РµРЅРёРµ РЅР° С‡С‘Рј РѕСЃС‚Р°РЅРѕРІРёРјСЃСЏ РІ СЌС‚РѕС‚ СЂР°Р·
 595++6F85 A7           	and a
 596++6F86 ED 42        	sbc hl,bc ;РІС‹С‡С‚РµРј С‚Рѕ, С‡С‚Рѕ РґРѕР±Р°РІРёР»Рё Рє РїРµСЂРІРѕРјСѓ СЃРµРєС‚РѕСЂСѓ
 597++6F88 4D           	ld c,l
 598++6F89 44           	ld b,h
 599++6F8A 30 02        	jr nc,fwrite_trd5
 600++6F8C 06 00        	ld b,0 ;РєРѕСЂСЂРµРєС†РёСЏ РµСЃР»Рё РІС‹С€РµР» РјРёРЅСѓСЃ
 601++6F8E              fwrite_trd5
 602++6F8E 2A 27 73     	ld hl,(temp_hl)
 603++6F91 09           	add hl,bc
 604++6F92
 605++6F92 11 44 99     	ld de,outputBuffer
 606++6F95 A7           	and a
 607++6F96 ED 52        	sbc hl,de
 608++6F98
 609++6F98 7D           	ld a,l
 610++6F99 32 2B 73     	ld (sec_shift),a ;СЃРјРµС‰РµРЅРёРµ РЅР° СЃР»РµРґСѓСЋС‰РёР№ СЂР°Р·
 611++6F9C              	;ld hl,(temp_hl)
 612++6F9C
 613++6F9C
 614++6F9C              	; or a
 615++6F9C              	; jr z,fwrite_trd1
 616++6F9C              	; inc b  ;РєРѕСЂСЂРµРєС†РёСЏ РєРѕР»РёС‡РµСЃС‚РІР° СЃРµРєС‚РѕСЂРѕРІ
 617++6F9C
 618++6F9C 78           	ld a,b ;РЅСѓР¶РЅР° РїСЂРѕРІРµСЂРєР° РЅР° РєРѕР»РёС‡РµСЃС‚РІРѕ СЃРµРєС‚РѕСЂРѕРІ!!!
 619++6F9D 32 2D 73     	ld (sec_part),a ;Р·Р°РїРѕРјРЅРёРј СЃРєРѕР»СЊРєРѕ СЃРµРєС‚РѕСЂРѕРІ РІРѕ РІС‚РѕСЂРѕР№ С‡Р°СЃС‚Рё
 620++6FA0
 621++6FA0              	;ld a,b
 622++6FA0 B7           	or a
 623++6FA1 28 16        	jr z,fwrite_trd1 ;РµСЃР»Рё СЂР°Р·РјРµСЂ РґР°РЅРЅС‹С… РјРµРЅСЊС€Рµ СЃРµРєС‚РѕСЂР°, С‚Рѕ РїСЂРѕРїСѓСЃС‚РёРј Р·Р°РїРёСЃСЊ
 624++6FA3
 625++6FA3 2A 29 73     	ld hl,(temp_hl2)
 626++6FA6              	;push bc
 627++6FA6 ED 5B F4 5C  	ld de,(#5cf4)
 628++6FAA 0E 06            ld      c,6 ;РїРёС€РµРј С†РµР»С‹РјРё СЃРµРєС‚РѕСЂР°РјРё
 629++6FAC CD CF 6D         call    call3d13
 630++6FAF 79           	ld a,c
 631++6FB0              	;pop bc
 632++6FB0 FE FF        	cp 255
 633++6FB2 CA FE 6E     	jp z,fwrite_no_chek ;РІС‹С…РѕРґ РµСЃР»Рё РѕС€РёР±РєР°
 634++6FB5              	; ld de,(f_w_cur_trk)
 635++6FB5              	; call calc_next_pos
 636++6FB5              	; ld (f_w_cur_trk),de
 637++6FB5
 638++6FB5 AF           	xor a
 639++6FB6 32 24 73     	ld (write_end_flag),a ;С„Р»Р°Рі С‡С‚Рѕ РЅСѓР¶РЅРѕ РґРѕРїРёСЃС‹РІР°С‚СЊ РѕСЃС‚Р°С‚РѕРє
 640++6FB9
 641++6FB9              fwrite_trd1
 642++6FB9 3A 24 73     	ld a,(write_end_flag) ;РЅСѓР¶РЅРѕ Р·Р°РїРёСЃС‹РІР°С‚СЊ РѕСЃС‚Р°С‚РѕРє?
 643++6FBC B7           	or a
 644++6FBD 20 12        	jr nz,fwrite_trd_ex ;РЅРµ РЅСѓР¶РЅРѕ
 645++6FBF
 646++6FBF 2A 29 73     	ld hl,(temp_hl2) ;СЃРѕС…СЂР°РЅРёРј РЅРµР·Р°РїРёСЃР°РЅРЅС‹Р№ РѕСЃС‚Р°С‚РѕРє
 647++6FC2 3A 2D 73     	ld a,(sec_part)
 648++6FC5 47           	ld b,a
 649++6FC6 0E 00        	ld c,0
 650++6FC8 09           	add hl,bc
 651++6FC9 11 00 51     	ld de,sec_buf
 652++6FCC 01 00 01     	ld bc,256
 653++6FCF ED B0        	ldir
 654++6FD1              ;fwrite_trd2
 655++6FD1
 656++6FD1
 657++6FD1              fwrite_trd_ex
 658++6FD1 ED 4B 25 73  	ld bc,(temp_bc) ;РІРѕР·РІСЂР°С‚РёРј, С‡С‚Рѕ СЃРєРѕР»СЊРєРѕ Р·Р°РїСЂР°С€РёРІР°Р»Рё, СЃС‚РѕР»СЊРєРѕ Рё Р·Р°РїРёСЃР°Р»Рё Р±Р°Р№С‚
 659++6FD5              	;РїРѕСЃС‡РёС‚Р°РµРј РѕР±С‰СѓСЋ РґР»РёРЅСѓ Р·Р°РїРёСЃР°РЅРЅРѕРіРѕ
 660++6FD5 2A 20 73     	ld hl,(f_w_len)
 661++6FD8 09           	add hl,bc
 662++6FD9 22 20 73     	ld (f_w_len),hl
 663++6FDC 30 07        	jr nc,fwrite_trd_ex1
 664++6FDE 2A 22 73     	ld hl,(f_w_len+2)
 665++6FE1 23           	inc hl
 666++6FE2 22 22 73     	ld (f_w_len+2),hl
 667++6FE5
 668++6FE5              fwrite_trd_ex1
 669++6FE5 AF           	xor a ;С„Р»Р°РіРё СЃР±СЂРѕСЃРёРј
 670++6FE6 C9               ret
 671++6FE7
 672++6FE7
 673++6FE7
 674++6FE7
 675++6FE7
 676++6FE7              ;------------------scl----------------------
 677++6FE7              fwrite_chek_scl ;Р·Р°РїРёСЃСЊ scl С„Р°Р№Р»Р° (СЂР°Р·РІРѕСЂР°С‡РёРІР°РЅРёРµ РѕР±СЂР°Р·Р°, id=4)
 678++6FE7              	; ld a,2
 679++6FE7              	; out (254),a
 680++6FE7              ; WAITKEY_t	XOR A:IN A,(#FE):CPL:AND #1F:JR Z,WAITKEY_t
 681++6FE7              	; xor a
 682++6FE7              	; out (254),a
 683++6FE7 3A 1F 73     	ld a,(f_w_flag)
 684++6FEA B7           	or a
 685++6FEB CA FE 6E     	jp z,fwrite_no_chek ;С„Р°Р№Р» СѓР¶Рµ РѕС‚РєСЂС‹С‚?
 686++6FEE ED 43 25 73  	ld (temp_bc),bc ;РґР»РёРЅР°
 687++6FF2 22 27 73     	ld (temp_hl),hl ;Р°РґСЂРµСЃ РґР°РЅРЅС‹С…
 688++6FF5 78           	ld a,b
 689++6FF6 B1           	or c
 690++6FF7 CA FE 6E     	jp z,fwrite_no_chek ; РµСЃР»Рё РґР»РёРЅР° 0, С‚Рѕ РІС‹С…РѕРґ
 691++6FFA
 692++6FFA              	; ld a,b
 693++6FFA              	; or a
 694++6FFA              	; jr nz,testt1
 695++6FFA              	; nop
 696++6FFA
 697++6FFA              ; testt1
 698++6FFA
 699++6FFA AF           	xor a
 700++6FFB 32 2D 73     	ld (sec_part),a ;РѕР±РЅСѓР»РёС‚СЊ РїРµСЂРµРјРµРЅРЅС‹Рµ
 701++6FFE 32 2C 73     	ld (sec_shift2),a
 702++7001 32 2D 73     	ld (sec_shift2+1),a
 703++7004 32 2E 73     	ld (sec_shift_flag),a
 704++7007 32 24 73     	ld (write_end_flag),a ;
 705++700A
 706++700A
 707++700A 3A 2B 73     	ld a,(sec_shift)
 708++700D B7           	or a
 709++700E 28 38        	jr z,fwrite_scl3 ;РµСЃР»Рё СЃРјРµС‰РµРЅРёСЏ РЅРµС‚, С‚Рѕ РїРµСЂРІСѓСЋ С‡Р°СЃС‚СЊ РїСЂРѕРїСѓСЃС‚РёРј
 710++7010
 711++7010
 712++7010 4F           	ld c,a
 713++7011 06 00        	ld b,0
 714++7013 2A 25 73     	ld hl,(temp_bc) ;РїСЂРѕРІРµСЂРєР° Р·Р°РїРѕР»РЅРёС‚СЃСЏ Р»Рё С†РµР»С‹Р№ СЃРµРєС‚РѕСЂ
 715++7016 09           	add hl,bc
 716++7017
 717++7017 3E 01        	ld a,1
 718++7019 32 24 73     	ld (write_end_flag),a ;С„Р»Р°Рі С‡С‚Рѕ РЅРµ РЅСѓР¶РЅРѕ РґРѕРїРёСЃС‹РІР°С‚СЊ РѕСЃС‚Р°С‚РѕРє
 719++701C
 720++701C 7C           	ld a,h
 721++701D B7           	or a
 722++701E 20 05        	jr nz,fwrite_scl4
 723++7020 3E 01        	ld a,1
 724++7022 32 2E 73     	ld (sec_shift_flag),a ;С„Р»Р°Рі С‡С‚Рѕ РЅРµ Р·Р°РїРѕР»РЅРµРЅ СЃРµРєС‚РѕСЂ
 725++7025
 726++7025              fwrite_scl4
 727++7025 21 00 51     	ld hl,sec_buf ;Р±СѓС„РµСЂ РїРѕСЃР»РµРґРЅРµРіРѕ СЃРµРєС‚РѕСЂР°
 728++7028 09           	add hl,bc ;РЅР° СЌС‚РѕР№ С‚РѕС‡РєРµ РѕСЃС‚Р°РЅРѕРІРёР»РёСЃСЊ
 729++7029 EB           	ex de,hl
 730++702A 2A 27 73     	ld hl,(temp_hl) ;РїСЂРёСЃРѕРµРґРёРЅРёРј РЅР°С‡Р°Р»Рѕ РґР°РЅРЅС‹С… РІ РєРѕРЅРµС† РїСЂРµРґС‹РґСѓС‰РёС…
 731++702D              	; ld a,c
 732++702D              	; or a
 733++702D              	; jr nz,fwrite_scl2
 734++702D              	; inc b ;РєРѕСЂСЂРµРєС†РёСЏ
 735++702D              ; fwrite_scl2
 736++702D              	; ld c,a
 737++702D AF           	xor a
 738++702E 91           	sub c
 739++702F 4F           	ld c,a ;СЃРєРѕР»СЊРєРѕ РѕСЃС‚Р°Р»РѕСЃСЊ РїРµСЂРµРЅРµСЃС‚Рё РґРѕ Р·Р°РїРѕР»РЅРµРЅРёСЏ СЃРµРєС‚РѕСЂР°
 740++7030 ED 43 2C 73  	ld (sec_shift2),bc ;СЃРѕС…СЂР°РЅРёРј СЃРєРѕР»СЊРєРѕ РґРѕР±Р°РІРёР»Рё Р±Р°Р№С‚
 741++7034 ED B0        	ldir
 742++7036
 743++7036 3A 2E 73     	ld a,(sec_shift_flag)
 744++7039 B7           	or a
 745++703A 20 0C        	jr nz,fwrite_scl3 ;РµСЃР»Рё СЃРµРєС‚РѕСЂ РµС‰С‘ РЅРµ Р·Р°РїРѕР»РЅРµРЅ РїРёСЃР°С‚СЊ РЅРµ Р±СѓРґРµРј
 746++703C
 747++703C 21 00 51     	ld hl,sec_buf
 748++703F              	;ld de,(#5cf4)
 749++703F              	;ld (f_w_cur_trk),de	;Р·Р°РїРѕРјРЅРёРј РїРѕР·РёС†РёСЋ
 750++703F 06 01            ld      b,#01 ;РїРёС€РµРј 1 СЃРµРєС‚РѕСЂ РёР· Р±СѓС„РµСЂР°
 751++7041 CD AC 70         call    scl_write_buf
 752++7044              	; ld a,c
 753++7044              	; cp 255
 754++7044              	; jp z,fwrite_no_chek ;РІС‹С…РѕРґ РµСЃР»Рё РѕС€РёР±РєР°
 755++7044
 756++7044 AF           	xor a
 757++7045 32 24 73     	ld (write_end_flag),a ;С„Р»Р°Рі С‡С‚Рѕ РЅСѓР¶РЅРѕ РґРѕРїРёСЃС‹РІР°С‚СЊ РѕСЃС‚Р°С‚РѕРє
 758++7048              	; ld de,(f_w_cur_trk) ;РµСЃР»Рё СЃРµРєС‚РѕСЂ РµС‰С‘ РЅРµ Р·Р°РїРѕР»РЅРµРЅ, РѕСЃС‚Р°РЅРµРјСЃСЏ РЅР° СЃС‚Р°СЂРѕР№ РїРѕР·РёС†РёРё
 759++7048              	; ld (#5cf4),de
 760++7048              	; ld b,1 ;РЅР° СЃРµРєС‚РѕСЂ РІРїРµСЂС‘Рґ
 761++7048              	; ld de,(f_w_cur_trk)
 762++7048              	; call calc_next_pos
 763++7048              	; ld (f_w_cur_trk),de
 764++7048
 765++7048              fwrite_scl3
 766++7048 2A 27 73     	ld hl,(temp_hl) ;Р·Р°РїРёС€РµРј РѕСЃС‚Р°С‚РѕРє РґР°РЅРЅС‹С…
 767++704B              	;ld a,(sec_shift)
 768++704B              	;ld c,a
 769++704B              	;ld b,0
 770++704B ED 4B 2C 73  	ld bc,(sec_shift2)
 771++704F 09           	add hl,bc ;СЃ СЌС‚РѕР№ С‚РѕС‡РєРё РїРёС€РµРј
 772++7050 22 29 73     	ld (temp_hl2),hl ;СЃРѕС…СЂР°РЅРёРј РЅР°С‡Р°Р»Рѕ Р·Р°РїРёСЃРё РІС‚РѕСЂРѕРіРѕ СЃРµРєС‚РѕСЂР°
 773++7053
 774++7053 2A 25 73     	ld hl,(temp_bc) ;РІС‹С‡РёСЃР»РµРЅРёРµ РЅР° С‡С‘Рј РѕСЃС‚Р°РЅРѕРІРёРјСЃСЏ РІ СЌС‚РѕС‚ СЂР°Р·
 775++7056 A7           	and a
 776++7057 ED 42        	sbc hl,bc ;РІС‹С‡С‚РµРј С‚Рѕ, С‡С‚Рѕ РґРѕР±Р°РІРёР»Рё Рє РїРµСЂРІРѕРјСѓ СЃРµРєС‚РѕСЂСѓ
 777++7059 4D           	ld c,l
 778++705A 44           	ld b,h
 779++705B 30 02        	jr nc,fwrite_scl5
 780++705D 06 00        	ld b,0 ;РєРѕСЂСЂРµРєС†РёСЏ РµСЃР»Рё РІС‹С€РµР» РјРёРЅСѓСЃ
 781++705F              fwrite_scl5
 782++705F 2A 27 73     	ld hl,(temp_hl)
 783++7062 09           	add hl,bc
 784++7063
 785++7063 11 44 99     	ld de,outputBuffer
 786++7066 A7           	and a
 787++7067 ED 52        	sbc hl,de
 788++7069
 789++7069 7D           	ld a,l
 790++706A 32 2B 73     	ld (sec_shift),a ;СЃРјРµС‰РµРЅРёРµ РЅР° СЃР»РµРґСѓСЋС‰РёР№ СЂР°Р·
 791++706D              	;ld hl,(temp_hl)
 792++706D
 793++706D
 794++706D              	; or a
 795++706D              	; jr z,fwrite_scl1
 796++706D              	; inc b  ;РєРѕСЂСЂРµРєС†РёСЏ РєРѕР»РёС‡РµСЃС‚РІР° СЃРµРєС‚РѕСЂРѕРІ
 797++706D
 798++706D 78           	ld a,b ;РЅСѓР¶РЅР° РїСЂРѕРІРµСЂРєР° РЅР° РєРѕР»РёС‡РµСЃС‚РІРѕ СЃРµРєС‚РѕСЂРѕРІ!!!
 799++706E 32 2D 73     	ld (sec_part),a ;Р·Р°РїРѕРјРЅРёРј СЃРєРѕР»СЊРєРѕ СЃРµРєС‚РѕСЂРѕРІ РІРѕ РІС‚РѕСЂРѕР№ С‡Р°СЃС‚Рё
 800++7071
 801++7071              	;ld a,b
 802++7071 B7           	or a
 803++7072 28 0A        	jr z,fwrite_scl1 ;РµСЃР»Рё СЂР°Р·РјРµСЂ РґР°РЅРЅС‹С… РјРµРЅСЊС€Рµ СЃРµРєС‚РѕСЂР°, С‚Рѕ РїСЂРѕРїСѓСЃС‚РёРј Р·Р°РїРёСЃСЊ
 804++7074
 805++7074 2A 29 73     	ld hl,(temp_hl2)
 806++7077              	;push bc
 807++7077              	;ld de,(#5cf4)
 808++7077                  ;ld      c,6 ;РїРёС€РµРј С†РµР»С‹РјРё СЃРµРєС‚РѕСЂР°РјРё
 809++7077 CD AC 70         call    scl_write_buf
 810++707A              	;ld a,c
 811++707A              	;pop bc
 812++707A              	; cp 255
 813++707A              	; jp z,fwrite_no_chek ;РІС‹С…РѕРґ РµСЃР»Рё РѕС€РёР±РєР°
 814++707A              	; ld de,(f_w_cur_trk)
 815++707A              	; call calc_next_pos
 816++707A              	; ld (f_w_cur_trk),de
 817++707A
 818++707A AF           	xor a
 819++707B 32 24 73     	ld (write_end_flag),a ;С„Р»Р°Рі С‡С‚Рѕ РЅСѓР¶РЅРѕ РґРѕРїРёСЃС‹РІР°С‚СЊ РѕСЃС‚Р°С‚РѕРє
 820++707E
 821++707E              fwrite_scl1
 822++707E 3A 24 73     	ld a,(write_end_flag) ;РЅСѓР¶РЅРѕ Р·Р°РїРёСЃС‹РІР°С‚СЊ РѕСЃС‚Р°С‚РѕРє?
 823++7081 B7           	or a
 824++7082 20 12        	jr nz,fwrite_scl_ex ;РЅРµ РЅСѓР¶РЅРѕ
 825++7084
 826++7084 2A 29 73     	ld hl,(temp_hl2) ;СЃРѕС…СЂР°РЅРёРј РЅРµР·Р°РїРёСЃР°РЅРЅС‹Р№ РѕСЃС‚Р°С‚РѕРє
 827++7087 3A 2D 73     	ld a,(sec_part)
 828++708A 47           	ld b,a
 829++708B 0E 00        	ld c,0
 830++708D 09           	add hl,bc
 831++708E 11 00 51     	ld de,sec_buf
 832++7091 01 00 01     	ld bc,256
 833++7094 ED B0        	ldir
 834++7096              ;fwrite_scl2
 835++7096
 836++7096
 837++7096              fwrite_scl_ex
 838++7096 ED 4B 25 73  	ld bc,(temp_bc) ;РІРѕР·РІСЂР°С‚РёРј, С‡С‚Рѕ СЃРєРѕР»СЊРєРѕ Р·Р°РїСЂР°С€РёРІР°Р»Рё, СЃС‚РѕР»СЊРєРѕ Рё Р·Р°РїРёСЃР°Р»Рё Р±Р°Р№С‚
 839++709A              	;РїРѕСЃС‡РёС‚Р°РµРј РѕР±С‰СѓСЋ РґР»РёРЅСѓ Р·Р°РїРёСЃР°РЅРЅРѕРіРѕ
 840++709A 2A 20 73     	ld hl,(f_w_len)
 841++709D 09           	add hl,bc
 842++709E 22 20 73     	ld (f_w_len),hl
 843++70A1 30 07        	jr nc,fwrite_scl_ex1
 844++70A3 2A 22 73     	ld hl,(f_w_len+2)
 845++70A6 23           	inc hl
 846++70A7 22 22 73     	ld (f_w_len+2),hl
 847++70AA
 848++70AA              fwrite_scl_ex1
 849++70AA AF           	xor a ;С„Р»Р°РіРё СЃР±СЂРѕСЃРёРј
 850++70AB C9               ret
 851++70AC
 852++70AC
 853++70AC
 854++70AC
 855++70AC
 856++70AC
 857++70AC              scl_write_buf ;Р·Р°РїРѕР»РЅРµРЅРёРµ РїСЂРѕРјРµР¶СѓС‚РѕС‡РЅРѕРіРѕ Р±СѓС„РµСЂР°
 858++70AC C5           	push bc ;СЃРєРѕР»СЊРєРѕ РїР°РєРµС‚РѕРІ СѓРєР°Р·Р°РЅРѕ РІ b
 859++70AD 11 00 53     	ld de,scl_buf ;РїРµСЂРµРЅРµСЃС‘Рј СЃРµРєС‚РѕСЂ РІРѕ РІСЂРµРјРµРЅРЅС‹Р№ Р±СѓС„РµСЂ
 860++70B0 01 00 01     	ld bc,256
 861++70B3 ED B0        	ldir
 862++70B5 22 4F 73     	ld (scl_temp_hl2),hl ;СЃРѕС…СЂР°РЅРёРј Р°РґСЂРµСЃ РґР°РЅРЅС‹С…
 863++70B8 3A 37 73     	ld a,(scl_que) ;РїСЂРѕРІРµСЂРёРј С„Р»Р°Рі С‡С‚Рѕ РЅСѓР¶РЅС‹ РґР°РЅРЅС‹Рµ
 864++70BB B7           	or a
 865++70BC 28 08        	jr z,scl_write_buf_ret ;РЅРµ Р±СѓРґРµРј РІС‹Р·С‹РІР°С‚СЊ РїР°СЂСЃРµСЂ РµСЃР»Рё РЅРµ РЅСѓР¶РЅС‹
 866++70BE 21 C6 70     	ld hl,scl_write_buf_ret ;Р°РґСЂРµСЃ РІРѕР·РІСЂР°С‚Р°
 867++70C1 E5           	push hl
 868++70C2 2A 49 73     	ld hl,(scl_parse_ret_adr) ;Р°РґСЂРµСЃ РґР»СЏ РїСЂРѕРґРѕР»Р¶РµРЅРёСЏ РѕСЃРЅРѕРІРЅРѕРіРѕ С†РёРєР»Р° СЃР±РѕСЂРєРё
 869++70C5 E9           	jp (hl) ;РѕС‚РґР°РґРёРј РїР°РєРµС‚ 256 Р±Р°Р№С‚ РїР°СЂСЃРµСЂСѓ
 870++70C6              scl_write_buf_ret
 871++70C6 2A 4F 73     	ld hl,(scl_temp_hl2)
 872++70C9 C1           	pop bc
 873++70CA 10 E0        	djnz scl_write_buf
 874++70CC
 875++70CC C9           	ret
 876++70CD
 877++70CD
 878++70CD
 879++70CD              scl_parse ;СЂР°Р·Р±РѕСЂ РѕР±СЂР°Р·Р° scl РІ trd, РѕСЃРЅРѕРІРЅРѕР№ С†РёРєР»
 880++70CD              	;РїРѕР»СѓС‡РёС‚СЊ РїРµСЂРІС‹Р№ СЃРµРєС‚РѕСЂ
 881++70CD              ;Р·Р°РїСЂРѕСЃ РїРѕСЂС†РёРё РґР°РЅРЅС‹С… РїРѕ 256 Р±Р°Р№С‚
 882++70CD 22 4D 73     	ld (scl_temp_hl),hl
 883++70D0 ED 53 51 73  	ld (scl_temp_de),de
 884++70D4 ED 43 53 73  	ld (scl_temp_bc),bc
 885++70D8 3E 01        	ld a,1
 886++70DA 32 37 73     	ld (scl_que),a ;РІРєР»СЋС‡РёРј С„Р»Р°Рі С‡С‚Рѕ РЅСѓР¶РЅС‹ РґР°РЅРЅС‹Рµ
 887++70DD 21 E4 70     	ld hl,scl_parse_ret ;СЃРѕС…СЂР°РЅРёРј Р°РґСЂРµСЃ РІРѕР·РІСЂР°С‚Р°
 888++70E0 22 49 73     	ld (scl_parse_ret_adr),hl
 889++70E3 C9           	ret ;РІРµСЂРЅС‘РјСЃСЏ РґР»СЏ РѕР¶РёРґР°РЅРёСЏ РґР°РЅРЅС‹С…
 890++70E4              scl_parse_ret
 891++70E4 AF           	xor a
 892++70E5 32 37 73     	ld (scl_que),a
 893++70E8 2A 4D 73     	ld hl,(scl_temp_hl)
 894++70EB ED 5B 51 73  	ld de,(scl_temp_de)
 895++70EF ED 4B 53 73  	ld bc,(scl_temp_bc)
 896++70F3
 897++70F3 11 00 53     	ld de,scl_buf ;РїСЂРѕРІРµСЂРєР° РјРµС‚РєРё РѕР±СЂР°Р·Р°
 898++70F6 21 2F 73     	ld hl,scl_sign
 899++70F9 06 08        	ld b,8
 900++70FB              scl_parse_chk
 901++70FB 1A           	ld a,(de)
 902++70FC BE           	cp (hl)
 903++70FD 20 06        	jr nz,scl_parse_chk_no
 904++70FF 23           	inc hl
 905++7100 13           	inc de
 906++7101 10 F8        	djnz scl_parse_chk
 907++7103 18 10        	jr scl_parse_chk_ok
 908++7105              scl_parse_chk_no ;РµСЃР»Рё РЅРµ СЃРѕРІРїР°Р»Рѕ, Р·РЅР°С‡РёС‚ РїР»РѕС…РѕР№ РѕР±СЂР°Р·
 909++7105 21 38 73         ld hl, scl_err
 910++7108 CD DB 69         call DialogBox.msgBox ;РїСЂРµРґСѓСЂРµР¶РґРµРЅРёРµ
 911++710B AF           	xor a
 912++710C 32 37 73     	ld (scl_que),a ;РІС‹РєР»СЋС‡РёРј С„Р»Р°Рі С‡С‚Рѕ РЅСѓР¶РЅС‹ РґР°РЅРЅС‹Рµ
 913++710F 3E 04        	ld a,4 ;Р·Р°РєСЂРѕРµРј С„Р°Р№Р»
 914++7111 CD D3 6D     	call fclose
 915++7114 C9           	ret
 916++7115              scl_parse_chk_ok ;СЃРёРіРЅР°С‚СѓСЂР° РїСЂР°РІРёР»СЊРЅР°СЏ
 917++7115
 918++7115              ;С„РѕСЂРјРёСЂРѕРІР°РЅРёРµ РєР°С‚Р°Р»РѕРіР°
 919++7115 3A 08 53     	ld a,(scl_buf+8)
 920++7118 32 4C 73     	ld (scl_files),a ;РІСЃРµРіРѕ С„Р°Р№Р»РѕРІ
 921++711B 32 4B 73     	ld (scl_cat_cycl),a ;С†РёРєР»
 922++711E 21 09 53     	ld hl,scl_buf+9 ;Р°РґСЂРµСЃ РїРµСЂРІРѕРіРѕ Р·Р°РіРѕР»РѕРІРєР°
 923++7121 11 00 48     	ld de,cat_buf ;Р°РґСЂРµСЃ С„РѕСЂРјРёСЂСѓРµРјРѕРіРѕ РєР°С‚Р°Р»РѕРіР° trd
 924++7124              scl_parse_cat2
 925++7124 06 0E        	ld b,14 ;14 Р±Р°Р№С‚ РѕРґРЅР° Р·Р°РїРёСЃСЊ
 926++7126              scl_parse_cat
 927++7126 7E           	ld a,(hl)
 928++7127 12           	ld (de),a
 929++7128 13           	inc de
 930++7129 2C           	inc l ;Р°РґСЂРµСЃ СѓРІРµР»РёС‡РёРІР°РµРј С‚РѕР»СЊРєРѕ РІ РїСЂРµРґРµР»Р°С… РјР»Р°РґС€РµРіРѕ СЂРµРіРёСЃС‚СЂР°
 931++712A 20 26        	jr nz,scl_parse_cat1
 932++712C              	;С‚СѓС‚ РїРѕСЂР° Р·Р°РїСЂРѕСЃРёС‚СЊ СЃР»РµРґСѓСЋС‰РёР№ СЃРµРєС‚РѕСЂ
 933++712C              ;Р·Р°РїСЂРѕСЃ РїРѕСЂС†РёРё РґР°РЅРЅС‹С… РїРѕ 256 Р±Р°Р№С‚
 934++712C 22 4D 73     	ld (scl_temp_hl),hl
 935++712F ED 53 51 73  	ld (scl_temp_de),de
 936++7133 ED 43 53 73  	ld (scl_temp_bc),bc
 937++7137 3E 01        	ld a,1
 938++7139 32 37 73     	ld (scl_que),a ;РІРєР»СЋС‡РёРј С„Р»Р°Рі С‡С‚Рѕ РЅСѓР¶РЅС‹ РґР°РЅРЅС‹Рµ
 939++713C 21 43 71     	ld hl,scl_parse_ret1 ;СЃРѕС…СЂР°РЅРёРј Р°РґСЂРµСЃ РІРѕР·РІСЂР°С‚Р°
 940++713F 22 49 73     	ld (scl_parse_ret_adr),hl
 941++7142 C9           	ret ;РІРµСЂРЅС‘РјСЃСЏ РґР»СЏ РѕР¶РёРґР°РЅРёСЏ РґР°РЅРЅС‹С…
 942++7143              scl_parse_ret1
 943++7143 AF           	xor a
 944++7144 32 37 73     	ld (scl_que),a
 945++7147 2A 4D 73     	ld hl,(scl_temp_hl)
 946++714A ED 5B 51 73  	ld de,(scl_temp_de)
 947++714E ED 4B 53 73  	ld bc,(scl_temp_bc)
 948++7152
 949++7152              scl_parse_cat1
 950++7152 10 D2        	djnz scl_parse_cat
 951++7154 13           	inc de
 952++7155 13           	inc de
 953++7156 3A 4B 73     	ld a,(scl_cat_cycl)
 954++7159 3D           	dec a
 955++715A 32 4B 73     	ld (scl_cat_cycl),a
 956++715D 20 C5        	jr nz,scl_parse_cat2
 957++715F
 958++715F 22 4D 73     	ld (scl_temp_hl),hl ;Р·Р°РїРѕРјРЅРёС‚СЊ РіРґРµ РѕСЃС‚Р°РЅРѕРІРёР»РёСЃСЊ
 959++7162
 960++7162              ;РїРѕРґСЃС‡С‘С‚ СЃРµРєС‚РѕСЂРѕРІ Рё РґРѕСЂРѕР¶РµРє
 961++7162 DD E5        	push ix
 962++7164 3A 4C 73     	ld a,(scl_files)
 963++7167 11 00 01     	ld de,#0100 ;РґР°РЅРЅС‹Рµ СЃ РїРµСЂРІРѕР№ РґРѕСЂРѕР¶РєРё
 964++716A DD 21 00 48  	ld ix,cat_buf
 965++716E DD 73 0E     	ld (ix+14),e
 966++7171 DD 72 0F     	ld (ix+15),d
 967++7174 21 00 00     	ld hl,0 ;РѕР±С‰РµРµ РєРѕР»РёС‡РµСЃС‚РІРѕ СЃРµРєС‚РѕСЂРѕРІ
 968++7177              scl_cacl
 969++7177 32 4B 73     	ld (scl_cat_cycl),a ;С†РёРєР»
 970++717A DD 7E 0D     	ld a,(ix+13) ;РґР»РёРЅР° С„Р°Р№Р»Р° РІ СЃРµРєС‚РѕСЂР°С…
 971++717D 4F           	ld c,a
 972++717E 06 00        	ld b,0
 973++7180 09           	add hl,bc ;СЃРµРєС‚РѕСЂРѕРІ
 974++7181
 975++7181 01 10 00     	ld bc,16
 976++7184 DD 09        	add ix,bc
 977++7186 47           	ld b,a
 978++7187 CD AC 72     	call calc_next_pos
 979++718A 3A 4B 73     	ld a,(scl_cat_cycl)
 980++718D FE 01        	cp 1
 981++718F 28 06        	jr z,scl_cacl2 ;РІ РїРѕСЃР»РµРґРЅРёР№ СЂР°Р· РїСЂРѕРїСѓСЃРёРј
 982++7191 DD 73 0E     	ld (ix+14),e
 983++7194 DD 72 0F     	ld (ix+15),d
 984++7197              scl_cacl2
 985++7197 3D           	dec a
 986++7198 20 DD        	jr nz,scl_cacl
 987++719A              	;С‚РµРїРµСЂСЊ СѓР·РЅР°РµРј РїРµСЂРІС‹Р№ СЃРІРѕР±РѕРґРЅС‹Р№ СЃРµРєС‚РѕСЂ
 988++719A DD 7E 0D     	ld a,(ix+13) ;РґР»РёРЅР° С„Р°Р№Р»Р° РІ СЃРµРєС‚РѕСЂР°С…
 989++719D 4F           	ld c,a
 990++719E 06 00        	ld b,0
 991++71A0 09           	add hl,bc
 992++71A1              	; ld b,a
 993++71A1              	; call calc_next_pos
 994++71A1 ED 53 E1 50  	ld (cat_buf+8*256+#e1),de ;РџРµСЂРІС‹Р№ СЃРІРѕР±РѕРґРЅС‹Р№ СЃРµРєС‚РѕСЂ Рё РґРѕСЂРѕР¶РєР° РЅР° РґРёСЃРєРµС‚Рµ
 995++71A5 11 F0 09     	ld de,16*159
 996++71A8 EB           	ex de,hl
 997++71A9 A7           	and a
 998++71AA ED 52        	sbc hl,de
 999++71AC 22 E5 50     	ld (cat_buf+8*256+#e5),hl ;Р§РёСЃР»Рѕ СЃРІРѕР±РѕРґРЅС‹С… СЃРµРєС‚РѕСЂРѕРІ РЅР° РґРёСЃРєРµ
1000++71AF DD E1        	pop ix
1001++71B1
1002++71B1
1003++71B1
1004++71B1              ;Р·Р°РїРёСЃСЊ СЃРѕРґРµСЂР¶РёРјРѕРіРѕ С„Р°Р№Р»РѕРІ
1005++71B1 3A 4C 73     	ld a,(scl_files) ;РІСЃРµРіРѕ С„Р°Р№Р»РѕРІ
1006++71B4 32 4B 73     	ld (scl_cat_cycl),a ;С†РёРєР»
1007++71B7 21 0D 48     	ld hl,cat_buf+13 ;Р°РґСЂРµСЃ СЂР°Р·РјРµСЂ СЃРµРєС‚РѕСЂРѕРІ С„Р°Р№Р»Р°
1008++71BA 22 55 73     	ld (cat_cur_adr),hl
1009++71BD
1010++71BD 21 00 01     	ld hl,#0100 ;РЅР°С‡РёРЅР°СЏ СЃ РїРµСЂРІРѕР№ РґРѕСЂРѕР¶РєРё
1011++71C0 22 F4 5C     	ld (#5cf4),hl
1012++71C3              scl_parse_file2
1013++71C3 2A 4D 73     	ld hl,(scl_temp_hl) ;Р°РґСЂРµСЃ РґР°РЅРЅС‹С…
1014++71C6 ED 5B 55 73  	ld de,(cat_cur_adr) ;Р°РґСЂРµСЃ СЃРµРєС‚РѕСЂ РґРѕСЂРѕР¶РєР° С„Р°Р№Р»Р°
1015++71CA              	;dec de
1016++71CA 1A           	ld a,(de) ;РєРѕР»РёС‡РµСЃС‚РІРѕ СЃРµРєС‚РѕСЂРѕРІ, С†РёРєР»
1017++71CB 4F           	ld c,a
1018++71CC              scl_parse_file3
1019++71CC 11 00 55     	ld de,scl_buf2 ;Р°РґСЂРµСЃ РµС‰С‘ РѕРґРЅРѕРіРѕ Р±СѓС„РµСЂР°
1020++71CF 06 00        	ld b,0 ;256 Р±Р°Р№С‚ РѕРґРёРЅ СЃРµРєС‚РѕСЂ, С†РёРєР»
1021++71D1              scl_parse_file
1022++71D1 7E           	ld a,(hl)
1023++71D2 12           	ld (de),a
1024++71D3 13           	inc de
1025++71D4 2C           	inc l ;Р°РґСЂРµСЃ СѓРІРµР»РёС‡РёРІР°РµРј С‚РѕР»СЊРєРѕ РІ РїСЂРµРґРµР»Р°С… РјР»Р°РґС€РµРіРѕ СЂРµРіРёСЃС‚СЂР°
1026++71D5 20 26        	jr nz,scl_parse_file1
1027++71D7              	;С‚СѓС‚ РїРѕСЂР° Р·Р°РїСЂРѕСЃРёС‚СЊ СЃР»РµРґСѓСЋС‰РёР№ СЃРµРєС‚РѕСЂ
1028++71D7              ;Р·Р°РїСЂРѕСЃ РїРѕСЂС†РёРё РґР°РЅРЅС‹С… РїРѕ 256 Р±Р°Р№С‚
1029++71D7 22 4D 73     	ld (scl_temp_hl),hl
1030++71DA ED 53 51 73  	ld (scl_temp_de),de
1031++71DE ED 43 53 73  	ld (scl_temp_bc),bc
1032++71E2 3E 01        	ld a,1
1033++71E4 32 37 73     	ld (scl_que),a ;РІРєР»СЋС‡РёРј С„Р»Р°Рі С‡С‚Рѕ РЅСѓР¶РЅС‹ РґР°РЅРЅС‹Рµ
1034++71E7 21 EE 71     	ld hl,scl_parse_ret2 ;СЃРѕС…СЂР°РЅРёРј Р°РґСЂРµСЃ РІРѕР·РІСЂР°С‚Р°
1035++71EA 22 49 73     	ld (scl_parse_ret_adr),hl
1036++71ED C9           	ret ;РІРµСЂРЅС‘РјСЃСЏ РґР»СЏ РѕР¶РёРґР°РЅРёСЏ РґР°РЅРЅС‹С…
1037++71EE              scl_parse_ret2
1038++71EE AF           	xor a
1039++71EF 32 37 73     	ld (scl_que),a
1040++71F2 2A 4D 73     	ld hl,(scl_temp_hl)
1041++71F5 ED 5B 51 73  	ld de,(scl_temp_de)
1042++71F9 ED 4B 53 73  	ld bc,(scl_temp_bc)
1043++71FD
1044++71FD              scl_parse_file1
1045++71FD 10 D2        	djnz scl_parse_file
1046++71FF 22 4D 73     	ld (scl_temp_hl),hl
1047++7202 ED 43 53 73  	ld (scl_temp_bc),bc
1048++7206
1049++7206 21 00 55     	ld hl,scl_buf2 ;;Р·Р°РїРёС€РµРј РѕРґРёРЅ СЃРµРєС‚РѕСЂ
1050++7209 ED 5B F4 5C  	ld  de,(#5cf4)
1051++720D 01 06 01         ld      bc,#0106 ;
1052++7210 CD CF 6D         call    call3d13
1053++7213              	; ld a,c
1054++7213              	; cp 255
1055++7213              	; jp z,fwrite_no_chek ;РІС‹С…РѕРґ РµСЃР»Рё РѕС€РёР±РєР°
1056++7213 2A 4D 73     	ld hl,(scl_temp_hl)
1057++7216 ED 4B 53 73  	ld bc,(scl_temp_bc)
1058++721A
1059++721A 0D           	dec c
1060++721B 20 AF        	jr nz,scl_parse_file3
1061++721D
1062++721D 2A 55 73     	ld hl,(cat_cur_adr) ;Р°РґСЂРµСЃ СЃРµРєС‚РѕСЂ РґРѕСЂРѕР¶РєР° С„Р°Р№Р»Р°
1063++7220              	; ld e,(hl)
1064++7220              	; inc hl
1065++7220              	; ld d,(hl)
1066++7220 01 10 00     	ld bc,16
1067++7223 09           	add hl,bc ;РЅР° СЃР»РµРґСѓСЋС‰РёР№ С„Р°Р№Р»
1068++7224 22 55 73     	ld (cat_cur_adr),hl
1069++7227
1070++7227
1071++7227 3A 4B 73     	ld a,(scl_cat_cycl)
1072++722A 3D           	dec a
1073++722B 32 4B 73     	ld (scl_cat_cycl),a
1074++722E 20 93        	jr nz,scl_parse_file2	;РЅР° СЃР»РµРґСѓСЋС‰РёР№ С„Р°Р№Р»
1075++7230
1076++7230
1077++7230
1078++7230              ;С„РѕСЂРјРёСЂРѕРІР°РЅРёРµ СЃРёСЃС‚РµРјРЅРѕРіРѕ СЃРµРєС‚РѕСЂР° в„–9 (8)
1079++7230              	;
1080++7230              	;ld (cat_buf+8*256+#e1),a ;// #E1 РџРµСЂРІС‹Р№ СЃРІРѕР±РѕРґРЅС‹Р№ СЃРµРєС‚РѕСЂ РЅР° РґРёСЃРєРµС‚Рµ
1081++7230              	;
1082++7230              	;ld (cat_buf+8*256+#e2),a ;// #E2 РџРµСЂРІС‹Р№ СЃРІРѕР±РѕРґРЅС‹Р№ С‚СЂРµРє
1083++7230 3E 16        	ld a,#16
1084++7232 32 E3 50     	ld (cat_buf+8*256+#e3),a ;// #E3 16 80 РґРѕСЂРѕР¶РµРє, 2 СЃС‚РѕСЂРѕРЅС‹
1085++7235 3A 4C 73     	ld a,(scl_files)
1086++7238 32 E4 50     	ld (cat_buf+8*256+#e4),a ;// #E4 РћР±С‰РµРµ РєРѕР»РёС‡РµСЃС‚РІРѕ С„Р°Р№Р»РѕРІ Р·Р°РїРёСЃР°РЅРЅС‹С… РЅР° РґРёСЃРє
1087++723B              	;
1088++723B              	;ld (cat_buf+8*256+#e5),a ;// #Р•5,Р•6 Р§РёСЃР»Рѕ СЃРІРѕР±РѕРґРЅС‹С… СЃРµРєС‚РѕСЂРѕРІ РЅР° РґРёСЃРєРµ
1089++723B              	;ld (cat_buf+8*256+#e6),a
1090++723B 3E 10        	ld a,#10
1091++723D 32 E7 50     	ld (cat_buf+8*256+#e7),a ;// #E7 РљРѕРґ  #10,РѕРїСЂРµРґРµР»СЏСЋС‰РёР№ РїСЂРёРЅР°РґР»РµР¶РЅРѕСЃС‚СЊ Рє TR-DOS
1092++7240
1093++7240 21 06 73     	ld hl,f_name ;Р·Р°РїРёС€РµРј РёРјСЏ РґРёСЃРєР°, РІР·СЏРІ РґР»СЏ СЌС‚РѕРіРѕ РёРјСЏ С„Р°Р№Р»Р°
1094++7243 11 F5 50     	ld de,cat_buf+8*256+#f5 ;// #F5-#FC РРјСЏ РґРёСЃРєР° РІ ASCII С„РѕСЂРјР°С‚Рµ
1095++7246 01 08 00     	ld bc,8
1096++7249 ED B0        	ldir
1097++724B
1098++724B 21 00 48     	ld hl,cat_buf ;Р·Р°РїРёС€РµРј РєР°С‚Р°Р»РѕРі РЅР° РґРёСЃРє
1099++724E 11 00 00     	ld de,0
1100++7251 01 06 09         ld      bc,#0906 ;
1101++7254 CD CF 6D         call    call3d13
1102++7257              	; ld a,c
1103++7257              	; cp 255
1104++7257              	; jp z,fwrite_no_chek ;РІС‹С…РѕРґ РµСЃР»Рё РѕС€РёР±РєР°
1105++7257 C9           	ret
1106++7258
1107++7258
1108++7258              ;-----------scl end --------------------
1109++7258
1110++7258
1111++7258
1112++7258
1113++7258
1114++7258
1115++7258
1116++7258
1117++7258
1118++7258
1119++7258              ; A - file stream id
1120++7258              ; fsync:
1121++7258              ;     esxCall ESX_FSYNC
1122++7258                  ; ret
1123++7258
1124++7258
1125++7258              ; HL - name (name.ext)
1126++7258              ; Returns:
1127++7258              ; HL - name (name    e)
1128++7258              format_name ;РїРѕРґРіРѕРЅСЏРµС‚ РёРјСЏ С„Р°Р№Р»Р° РїРѕРґ СЃС‚Р°РЅРґР°СЂС‚ trdos (8+1)
1129++7258
1130++7258              	;СЃРЅР°С‡Р°Р»Р° РїРѕРїСЂРѕР±СѓРµРј СѓР±СЂР°С‚СЊ РёР· РїСѓС‚Рё РїРѕРґРїР°РїРєСѓ, РµСЃР»Рё РѕРЅР° РµСЃС‚СЊ
1131++7258 22 27 73     	ld (temp_hl),hl ;СЃРѕС…СЂР°РЅРёРј Р°РґСЂРµСЃ РёСЃС…РѕРґРЅРѕРіРѕ РёРјРµРЅРё
1132++725B 06 00        	ld b,#00 ;РЅРµ Р±РѕР»СЊС€Рµ 255 СЃРёРјРІРѕР»РѕРІ
1133++725D              format_name5
1134++725D 7E           	ld a,(hl)
1135++725E FE 2F        	cp "/" ;РµСЃР»Рё РµСЃС‚СЊ РїРѕРґРїР°РїРєР°
1136++7260 28 0D        	jr z,format_name_path_yep
1137++7262 7E           	ld a,(hl)
1138++7263 FE 2E        	cp "." ;РµСЃР»Рё РµС‰С‘ РЅРµ РґРѕС€Р»Рё РґРѕ СЂР°СЃС€РёСЂРµРЅРёСЏ
1139++7265 20 05        	jr nz,format_name6
1140++7267 2A 27 73     	ld hl,(temp_hl) ;РµСЃР»Рё РґРѕС€Р»Рё РґРѕ СЂР°СЃС€РёСЂРµРЅРёСЏ, С‚Рѕ РїСѓС‚РµР№ РЅРµС‚, РІРµСЂРЅС‘РјСЃСЏ РЅР° РЅР°С‡Р°Р»Рѕ РёРјРµРЅРё
1141++726A 18 04        	jr format_name_7 ;РЅР° РІС‹С…РѕРґ
1142++726C              format_name6
1143++726C 23           	inc hl
1144++726D 10 EE        	djnz format_name5
1145++726F
1146++726F              format_name_path_yep ;РЅР°С€Р»Рё
1147++726F 23           	inc hl ;РїСЂРѕРїСѓСЃС‚РёРј Р·РЅР°Рє "/"
1148++7270
1149++7270              format_name_7
1150++7270
1151++7270
1152++7270 E5           	push hl ;РѕС‡РёСЃС‚РёРј РјРµСЃС‚Рѕ РґР»СЏ РЅРѕРІРѕРіРѕ РёРјРµРЅРё
1153++7271 21 06 73     	ld hl,f_name
1154++7274 11 07 73     	ld de,f_name+1
1155++7277 36 20        	ld (hl)," "
1156++7279 01 08 00     	ld bc,8
1157++727C ED B0        	ldir
1158++727E E1           	pop hl
1159++727F
1160++727F 01 FF 09     	ld bc,#09ff ;РґР»РёРЅР° РёРјРµРЅРё 9 СЃРёРјРІРѕР»РѕРІ
1161++7282 11 06 73     	ld de,f_name ;РєСѓРґР°
1162++7285              format_name2
1163++7285 7E           	ld a,(hl)
1164++7286 FE 2E        	cp "."
1165++7288 20 08        	jr nz,format_name1
1166++728A 23           	inc hl
1167++728B 7E           	ld a,(hl)
1168++728C 32 0E 73     	ld (f_name+8),a ; Рё РІ РєРѕРЅС†Рµ РїРµСЂРІСѓСЋ Р±СѓРєРІСѓ СЂР°СЃС€РёСЂРµРЅРёСЏ
1169++728F EB           	ex de,hl ;СЃРѕС…СЂР°РЅРёРј Р°РґСЂРµСЃ РёСЃС…РѕРґРЅРѕРіРѕ СЂР°СЃС€РёСЂРµРЅРёСЏ
1170++7290 18 16        	jr format_name_e
1171++7292              format_name1
1172++7292 ED A0        	ldi
1173++7294 10 EF        	djnz format_name2
1174++7296
1175++7296              	;РµСЃР»Рё РёРјСЏ РґР»РёРЅРЅРѕРµ, РїСЂРѕРїСѓСЃС‚РёРј Р»РёС€РЅРµРµ РґРѕ СЂР°СЃС€РёСЂРµРЅРёСЏ
1176++7296 06 00        	ld b,#00 ;РЅРµ Р±РѕР»СЊС€Рµ 255 СЃРёРјРІРѕР»РѕРІ
1177++7298              format_name3
1178++7298 7E           	ld a,(hl)
1179++7299 FE 2E        	cp "."
1180++729B 20 08        	jr nz,format_name4
1181++729D 23           	inc hl
1182++729E 7E           	ld a,(hl)
1183++729F 32 0E 73     	ld (f_name+8),a ; Рё РІ РєРѕРЅС†Рµ РїРµСЂРІСѓСЋ Р±СѓРєРІСѓ СЂР°СЃС€РёСЂРµРЅРёСЏ
1184++72A2 EB           	ex de,hl ;СЃРѕС…СЂР°РЅРёРј Р°РґСЂРµСЃ РёСЃС…РѕРґРЅРѕРіРѕ СЂР°СЃС€РёСЂРµРЅРёСЏ
1185++72A3 18 03        	jr format_name_e
1186++72A5              format_name4
1187++72A5 23           	inc hl
1188++72A6 10 F0        	djnz format_name3
1189++72A8
1190++72A8              format_name_e ;РІС‹С…РѕРґ
1191++72A8 21 06 73     	ld hl,f_name ;РІРµСЂРЅС‘Рј СЂРµР·СѓР»СЊС‚Р°С‚
1192++72AB C9           	ret
1193++72AC
1194++72AC              ; DE - trk/sec
1195++72AC              ; B - sectors step
1196++72AC              ; Returns:
1197++72AC              ; DE - trk/sec
1198++72AC              calc_next_pos		;РІРїРµСЂС‘Рґ РЅР° N СЃРµРєС‚РѕСЂРѕРІ
1199++72AC              			;ld b,4
1200++72AC              			;ld  de,(#5ceb)
1201++72AC              calc_next_pos2
1202++72AC 1C           			inc e
1203++72AD 7B           			ld a,e
1204++72AE FE 10        			cp 16
1205++72B0 38 03        			jr c,calc_next_pos1
1206++72B2 14           			inc d
1207++72B3 1E 00        			ld e,0
1208++72B5              calc_next_pos1
1209++72B5              			;ld (#5ceb),de
1210++72B5 10 F5        			djnz calc_next_pos2
1211++72B7 C9           			ret
1212++72B8
1213++72B8
1214++72B8              ;testt db "123.trd"
1215++72B8 53 65 6C 65  write_ima db "Select disk "
1215++72BC 63 74 20 64
1215++72C0 69 73 6B 20
1216++72C4 41 3A 20 28  write_ima_d db "A: (A-D). "
1216++72C8 41 2D 44 29
1216++72CC 2E 20
1217++72CE 41 6C 6C 20  		db "All data may be lost! Press Y or N.",0
1217++72D2 64 61 74 61
1217++72D6 20 6D 61 79
1217++72DA 20 62 65 20
1217++72DE 6C 6F 73 74
1217++72E2 21 20 50 72
1217++72E6 65 73 73 20
1217++72EA 59 20 6F 72
1217++72EE 20 4E 2E 00
1218++72F2              ;prev_drive db 0 ;РїСЂРµРґС‹РґСѓС‰РёР№ РЅРѕРјРµСЂ РґРёСЃРєРѕРІРѕРґР°
1219++72F2
1220++72F2 2E 74 72 64  trdExt1 db ".trd", 0
1220++72F6 00
1221++72F7 2E 54 52 44  trdExt2 db ".TRD", 0
1221++72FB 00
1222++72FC
1223++72FC 2E 73 63 6C  sclExt1 db ".scl", 0
1223++7300 00
1224++7301 2E 53 43 4C  sclExt2 db ".SCL", 0
1224++7305 00
1225++7306
1226++7306 00 00 00...  f_name ds 16 ;РёРјСЏ С„Р°Р№Р»Р°
1227++7316 00 00        f_r_cur_trk dw 	 0 ;С‚РµРєСѓС‰РёРµ СЃРµРєС‚РѕСЂ-РґРѕСЂРѕР¶РєР° С„Р°Р№Р»Р° РЅР° С‡С‚РµРЅРёРµ
1228++7318 00           f_r_len_sec db 0 ;РґР»РёРЅР° С„Р°Р№Р»Р° РЅР° С‡С‚РµРЅРёРµ РІ СЃРµРєС‚РѕСЂР°С…
1229++7319 00 00        f_r_len dw 0;РґР»РёРЅР° С„Р°Р№Р»Р° РІ Р±Р°Р№С‚Р°С…
1230++731B 00           f_r_flag db 0 ;С„Р»Р°Рі С‡С‚Рѕ РѕС‚РєСЂС‹С‚ С„Р°Р№Р» РЅР° С‡С‚РµРЅРёРµ
1231++731C
1232++731C 00 00        f_w_cur_trk dw 	 0 ;С‚РµРєСѓС‰РёРµ СЃРµРєС‚РѕСЂ-РґРѕСЂРѕР¶РєР° С„Р°Р№Р»Р° РЅР° Р·Р°РїРёСЃСЊ
1233++731E 00           f_w_len_sec db 0 ;РґР»РёРЅР° С„Р°Р№Р»Р° РЅР° Р·Р°РїРёСЃСЊ РІ СЃРµРєС‚РѕСЂР°С…
1234++731F 00           f_w_flag db 0 ;С„Р»Р°Рі С‡С‚Рѕ РѕС‚РєСЂС‹С‚ С„Р°Р№Р» РЅР° Р·Р°РїРёСЃСЊ
1235++7320 00 00 00 00  f_w_len ds 4 ;РґР»РёРЅР° Р·Р°РїРёСЃР°РЅРЅС‹С… РґР°РЅРЅС‹С…
1236++7324 00           write_end_flag db 0 ;С„Р»Р°Рі С‡С‚Рѕ РЅСѓР¶РЅРѕ Р·Р°РїРёСЃР°С‚СЊ РѕСЃС‚Р°С‚РѕРє
1237++7325
1238++7325 00 00        temp_bc dw 0 ;С…СЂР°РЅРµРЅРёРµ СЂРµРіРёСЃС‚СЂР°
1239++7327 00 00        temp_hl dw 0 ;С…СЂР°РЅРµРЅРёРµ СЂРµРіРёСЃС‚СЂР°
1240++7329 00 00        temp_hl2 dw 0 ;С…СЂР°РЅРµРЅРёРµ СЂРµРіРёСЃС‚СЂР°
1241++732B
1242++732B 00           sec_shift db 0 ;СѓРєР°Р·Р°С‚РµР»СЊ РЅР° РєР°РєРѕРј Р±Р°Р№С‚Рµ РѕСЃС‚Р°РЅРѕРІР»РµРЅР° Р·Р°РїРёСЃСЊ
1243++732C 00           sec_shift2 db 0 ;СѓРєР°Р·Р°С‚РµР»СЊ РЅР° РєР°РєРѕРј Р±Р°Р№С‚Рµ РѕСЃС‚Р°РЅРѕРІР»РµРЅР° Р·Р°РїРёСЃСЊ (РѕСЃС‚Р°С‚РѕРє)
1244++732D 00           sec_part db 0 ;СЃРєРѕР»СЊРєРѕ СЃРµРєС‚РѕСЂРѕРІ РІРѕ РІС‚РѕСЂРѕР№ РїРѕСЂС†РёРё РґР»СЏ Р·Р°РїРёСЃРё
1245++732E 00           sec_shift_flag db 0 ;С„Р»Р°Рі С‡С‚Рѕ Р±СѓС„РµСЂ СЃРµРєС‚РѕСЂР° РЅРµ Р·Р°РїРѕР»РЅРµРЅ
1246++732F
1247++732F              ;СЃРµРєС†РёСЏ scl
1248++732F 53 49 4E 43  scl_sign db "SINCLAIR" ;РјРµС‚РєР°
1248++7333 4C 41 49 52
1249++7337 00           scl_que db 0 ;С„Р»Р°Рі Р·Р°РїСЂРѕСЃР° РїРѕСЂС†РёРё РґР°РЅРЅС‹С…
1250++7338 53 43 4C 20  scl_err db "SCL image error!",0
1250++733C 69 6D 61 67
1250++7340 65 20 65 72
1250++7344 72 6F 72 21
1250++7348 00
1251++7349 00 00        scl_parse_ret_adr dw 0; Р°РґСЂРµСЃ РІРѕР·РІСЂР°С‚Р° РІ С†РёРєР»
1252++734B 00           scl_cat_cycl db 0 ;РїРµСЂРµРјРµРЅРЅР°СЏ С†РёРєР»Р°
1253++734C 00           scl_files db 0 ;РІСЃРµРіРѕ С„Р°Р№Р»РѕРІ
1254++734D 00 00        scl_temp_hl dw 0;;С…СЂР°РЅРµРЅРёРµ СЂРµРіРёСЃС‚СЂР°
1255++734F 00 00        scl_temp_hl2 dw 0;
1256++7351 00 00        scl_temp_de dw 0;
1257++7353 00 00        scl_temp_bc dw 0;
1258++7355 00 00        cat_cur_adr dw 0;
1259++7357              ;scl end
1260++7357
1261++7357              ;СЃРµРєС†РёСЏ СЃРѕС…СЂР°РЅРµРЅРёСЏ Р»СЋР±РѕРіРѕ С„Р°Р№Р»Р°
1262++7357 4E 6F 74 20  file_err db "Not enough space!",0
1262++735B 65 6E 6F 75
1262++735F 67 68 20 73
1262++7363 70 61 63 65
1262++7367 21 00
1263++7369 00           sec_cat db 0 ;СЃРµРєС‚РѕСЂ РєР°С‚Р°Р»РѕРіР°
1264++736A
1265++736A              	;РїРѕ Р°РґСЂРµСЃСѓ #4000 С€СЂРёС„С‚
1266++736A              cat_buf equ #4800 ;Р±СѓС„РµСЂ РґР»СЏ РєР°С‚Р°С‚РѕРіР° РґРёСЃРєР° 9*256
1267++736A              sec_buf equ cat_buf + 9*256 ;Р±СѓС„РµСЂ СЃРµРєС‚РѕСЂР° РґР»СЏ Р·Р°РїРёСЃРё 256
1268++736A              scl_buf equ sec_buf + 512 ;РїСЂРѕРјРµР¶СѓС‚РѕС‡РЅС‹Р№ Р±СѓС„РµСЂ 256
1269++736A              scl_buf2 equ scl_buf + 512 ;РїСЂРѕРјРµР¶СѓС‚РѕС‡РЅС‹Р№ Р±СѓС„РµСЂ 256
1270++736A
1271++736A                  ENDMODULE
# file closed: dos/trdos.asm
   9++736A              	ENDIF
  10++736A
  11++736A              	IFDEF ESXDOS
  12++736A ~               		include "console.asm"
  13++736A ~               		include "esxdos.asm"
  14++736A              	ENDIF
  15++736A
  16++736A              	IFDEF P3DOS
  17++736A ~               		include "console.asm"
  18++736A ~               		include "p3dos.asm"
  19++736A              	ENDIF
  20++736A
# file closed: dos/index.asm
  19+ 736A                  include "gopher/engine/history/index.asm"
# file opened: gopher/engine/history/index.asm
   1++736A                  include "controler.asm"
# file opened: gopher/engine/history/controler.asm
   1++736A                  module History
   2++736A              back:
   3++736A 3A A5 74         ld a, (depth)
   3++736D FE 01          cp 1
   3++736F CA 81 73       jp z, load
   4++7372 21 F4 76 11      ld hl, historyBlock + HistoryRecord, de, historyBlock, bc, (total - 1) * HistoryRecord
   4++7376 A6 74 01 38
   4++737A 09
   4++737B ED B0          ldir ; Move history up
   5++737D 21 A5 74         ld hl, depth
   5++7380 35             dec (hl)
   6++7381              ; Loads current resource
   7++7381              load:
   8++7381 21 9E 73         ld hl, .msg
   8++7384 CD E4 69       call DialogBox.msgNoWait
   9++7387 AF               xor a
   9++7388 21 44 99 11    ld hl, outputBuffer, de, outputBuffer + 1
   9++738C 45 99
  10++738E              	IFDEF MSX
  11++738E ~                	ld bc, (ramtop)
  12++738E ~                	dec bc
  13++738E              	ELSE
  14++738E 01 BA 66         	ld bc, #ffff - outputBuffer - 1
  15++7391              	ENDIF
  16++7391
  17++7391 77               ld (hl), a
  18++7392 ED B0            ldir
  19++7394
  20++7394 3A A6 74         ld a, (historyBlock.isFile)
  20++7397 A7             and a
  20++7398 C2 8F 84       jp nz, Fetcher.fetchFromFS
  21++739B C3 42 84         jp Fetcher.fetchFromNet
  22++739E
  23++739E 20 20 20 20  .msg db "    Loading resource! Please wait! It will be here soon!", 0
  23++73A2 4C 6F 61 64
  23++73A6 69 6E 67 20
  23++73AA 72 65 73 6F
  23++73AE 75 72 63 65
  23++73B2 21 20 50 6C
  23++73B6 65 61 73 65
  23++73BA 20 77 61 69
  23++73BE 74 21 20 49
  23++73C2 74 20 77 69
  23++73C6 6C 6C 20 62
  23++73CA 65 20 68 65
  23++73CE 72 65 20 73
  23++73D2 6F 6F 6E 21
  23++73D6 00
  24++73D7
  25++73D7              home:
  26++73D7 21 83 74         ld hl, homePage
  27++73DA              ; HL - gopher row
  28++73DA              navigate:
  29++73DA 54 5D            ld de, hl
  30++73DC CD BB 82         call UrlEncoder.isValidGopherRow
  31++73DF 30 A0            jr nc, load ; Not valid - reload last
  32++73E1 62 6B            ld hl, de
  33++73E3 E5               push hl
  34++73E4
  35++73E4 E5               push hl
  36++73E5 21 2B 80 11      ld hl, HistoryEnd - HistoryRecord, de, HistoryEnd, bc,  HistoryRecord * total
  36++73E9 79 82 01 86
  36++73ED 0B
  36++73EE ED B8          lddr
  37++73F0
  38++73F0 ED 5B EC 76      ld de, (Render.position), (historyBlock.position + HistoryRecord), de
  38++73F4 ED 53 3A 79
  39++73F8                  ; Clean up struct
  40++73F8 AF               xor a
  40++73F9 21 A6 74 11    ld hl, historyBlock, de, historyBlock + 1, bc, historyBlockSize - 1, (hl), a
  40++73FD A7 74 01 4D
  40++7401 02 77
  40++7403 ED B0          ldir
  41++7405 E1               pop hl
  42++7406
  43++7406                  ; Fill record
  44++7406 54 5D            ld de, hl
  45++7408 CD 7A 82         call UrlEncoder.isFile
  46++740B EB               ex hl, de
  47++740C 11 A6 74         ld de, historyBlock
  48++740F 12               ld (de), a
  48++7410 13             inc de
  49++7411 7E               ld a, (hl)
  49++7412 E5 D5          push hl, de
  49++7414 CD 8E 64       call Render.getIcon
  49++7417 D1 E1          pop de, hl
  50++7419 12               ld (de), a
  50++741A 13             inc de
  51++741B 3E 09            ld a, 9
  52++741D
  53++741D                  IFDEF MSX
  54++741D ~                	ld bc, #ff
  55++741D                  ELSE
  56++741D 01 FF 00         	ld bc, #ff
  57++7420                  ENDIF
  58++7420
  59++7420 ED B1            cpir
  60++7422              .locatorCopy
  61++7422 7E               ld a, (hl)
  61++7423 FE 09          cp 9
  61++7425 28 05          jr z, 1f
  62++7427 12               ld (de), a
  62++7428 23 13          inc hl, de
  63++742A 18 F6            jr .locatorCopy
  64++742C              1
  65++742C 23               inc hl
  65++742D AF             xor a
  65++742E 12             ld (de), a
  66++742F 11 A7 75         ld de, historyBlock.host
  67++7432              .hostCopy
  68++7432 7E               ld a, (hl)
  68++7433 FE 09          cp 9
  68++7435 28 05          jr z, 1f
  69++7437 12               ld (de), a
  69++7438 23 13          inc hl, de
  70++743A 18 F6            jr .hostCopy
  71++743C              1
  72++743C 23               inc hl
  72++743D AF             xor a
  72++743E 12             ld (de), a
  73++743F 11 E7 75         ld de, historyBlock.port
  74++7442              .portCopy
  75++7442 7E               ld a, (hl)
  76++7443 FE 09            cp 9
  76++7445 28 11          jr z, 1f
  77++7447 FE 0D            cp 13
  77++7449 28 0D          jr z, 1f
  78++744B FE 0A            cp 10
  78++744D 28 09          jr z, 1f
  79++744F FE 00            cp 0
  79++7451 28 05          jr z, 1f
  80++7453 12               ld (de), a
  80++7454 23 13          inc hl, de
  81++7456 18 EA            jr .portCopy
  82++7458 AF           1   xor a
  82++7459 12             ld (de), a
  83++745A 21 8B 69 11      ld hl, DialogBox.inputBuffer, de, historyBlock.search, bc, #ff
  83++745E ED 75 01 FF
  83++7462 00
  83++7463 ED B0          ldir
  84++7465 11 00 00 ED      ld de, 0, (historyBlock.position), de
  84++7469 53 EC 76
  85++746C E1               pop hl
  86++746D 3A A5 74         ld a, (depth)
  86++7470 FE 05          cp total
  86++7472 30 04          jr nc, 1f
  87++7474 3C               inc a
  87++7475 32 A5 74       ld (depth), a
  88++7478              1
  89++7478 3A A7 74         ld a,(historyBlock.mediaType)
  89++747B FE 01          cp MIME_DOWNLOAD
  89++747D CA 2A 85       jp z, Gopher.download
  90++7480
  91++7480                  ifdef GS
  92++7480 ~                cp MIME_MOD
  92++7480 ~              jp z, Gopher.loadMod
  93++7480                  endif
  94++7480
  95++7480 C3 81 73         jp load
  96++7483
  97++7483              homePage:
  98++7483              	IFDEF MSX
  99++7483 ~                	db "1Home", TAB, "index.gph"
 100++7483 ~                	db TAB, "file", TAB, "70", CR, LF, 0
 101++7483                  ELSE
 102++7483 31 48 6F 6D      	db "1Home", TAB, "browser/index.gph"
 102++7487 65 09 62 72
 102++748B 6F 77 73 65
 102++748F 72 2F 69 6E
 102++7493 64 65 78 2E
 102++7497 67 70 68
 103++749A 09 66 69 6C      	db TAB, "file", TAB, "70", CR, LF, 0
 103++749E 65 09 37 30
 103++74A2 0D 0A 00
 104++74A5                  ENDIF
 105++74A5                  endmodule
# file closed: gopher/engine/history/controler.asm
   2++74A5                  include "model.asm"
# file opened: gopher/engine/history/model.asm
   1++74A5              total   equ 5
   2++74A5 00           depth   db 0
   3++74A6
   4++74A6              historyBlock:
   5++74A6 00           .isFile    db  0
   6++74A7 00           .mediaType db  0
   7++74A8 00 00 00...  .locator   ds  #ff
   8++75A7 00 00 00...  .host      ds  64
   9++75E7 00 00 00...  .port      ds  6
  10++75ED 00 00 00...  .search    ds  #ff
  11++76EC 00 00        .position  dw  #0000    ;position
  12++76EE
  13++76EE 00 00 00 00      db 0,0,0,0,0,0  ;cursor_position page_offset
  13++76F2 00 00
  14++76F4
  15++76F4              historyBlockSize = $ - historyBlock
  16++76F4
  17++76F4              HistoryRecord EQU $ - historyBlock
  18++76F4                  dup total
  19++76F4 00 00 00... >    ds HistoryRecord
  19++7942 00 00 00... >    ds HistoryRecord
  19++7B90 00 00 00... >    ds HistoryRecord
  19++7DDE 00 00 00... >    ds HistoryRecord
  19++802C 00 00 00... >    ds HistoryRecord
  20++827A                  edup
  21++827A              HistoryEnd equ $ - 1
  22++827A
# file closed: gopher/engine/history/model.asm
# file closed: gopher/engine/history/index.asm
  20+ 827A                  include "gopher/engine/urlencoder.asm"
# file opened: gopher/engine/urlencoder.asm
   1++827A                  MODULE UrlEncoder
   2++827A              ; HL - pointer to line in gopher page
   3++827A              ; C - flag set when it's file
   4++827A              isFile:
   5++827A              .findServerLoop
   6++827A 7E               ld a, (hl)
   6++827B A7             and a
   6++827C 28 3B          jr z, .notFile
   6++827E 23             inc hl
   7++827F FE 0D            cp 13
   7++8281 28 36          jr z, .notFile
   8++8283 FE 09            cp 9
   8++8285 28 02          jr z, .skipPath
   9++8287 18 F1            jr .findServerLoop
  10++8289              .skipPath
  11++8289 7E               ld a, (hl)
  11++828A A7             and a
  11++828B 28 2C          jr z, .notFile
  11++828D 23             inc hl
  12++828E FE 0D            cp 13
  12++8290 28 27          jr z, .notFile
  13++8292 FE 09            cp 9
  13++8294 28 02          jr z, .compareServer
  14++8296 18 F1            jr .skipPath
  15++8298              .compareServer
  16++8298 7E               ld a, (hl)
  16++8299 FE 66          cp "f"
  16++829B 20 1C          jr nz, .notFile
  16++829D 23             inc hl
  17++829E 7E               ld a, (hl)
  17++829F FE 69          cp "i"
  17++82A1 20 16          jr nz, .notFile
  17++82A3 23             inc hl
  18++82A4 7E               ld a, (hl)
  18++82A5 FE 6C          cp "l"
  18++82A7 20 10          jr nz, .notFile
  18++82A9 23             inc hl
  19++82AA 7E               ld a, (hl)
  19++82AB FE 65          cp "e"
  19++82AD 20 0A          jr nz, .notFile
  19++82AF 23             inc hl
  20++82B0 7E               ld a, (hl)
  20++82B1 FE 09          cp 9
  20++82B3 20 04          jr nz, .notFile
  20++82B5 23             inc hl
  21++82B6 3E 01            ld a, 1
  22++82B8 C9               ret
  23++82B9              .notFile
  24++82B9 AF               xor a
  25++82BA C9               ret
  26++82BB
  27++82BB              ; Is enough fields to encode
  28++82BB              ; HL - pointer to line in gopher page
  29++82BB              ; C - flag set when there is enough fields
  30++82BB              isValidGopherRow:
  31++82BB 7E               ld a, (hl)
  31++82BC A7             and a
  31++82BD 28 FA          jr z, isFile.notFile
  31++82BF 23             inc hl
  32++82C0 FE 0D            cp 13
  32++82C2 28 F5          jr z, isFile.notFile
  33++82C4 FE 09            cp 9
  33++82C6 28 02          jr z, .skipPath
  34++82C8 18 F1            jr isValidGopherRow
  35++82CA              .skipPath
  36++82CA 7E               ld a, (hl)
  36++82CB A7             and a
  36++82CC 28 EB          jr z, isFile.notFile
  36++82CE 23             inc hl
  37++82CF FE 0D            cp 13
  37++82D1 28 E6          jr z, isFile.notFile
  38++82D3 FE 09            cp 9
  38++82D5 28 02          jr z, .skipHost
  39++82D7 18 F1            jr .skipPath
  40++82D9              .skipHost
  41++82D9 7E               ld a, (hl)
  41++82DA A7             and a
  41++82DB 28 DC          jr z, isFile.notFile
  41++82DD 23             inc hl
  42++82DE FE 0D            cp 13
  42++82E0 28 D7          jr z, isFile.notFile
  43++82E2 FE 09            cp 9
  43++82E4 28 02           jr z, .isValid
  44++82E6 18 F1            jr .skipHost
  45++82E8              .isValid:
  46++82E8 37               scf
  47++82E9 C9               ret
  48++82EA
  49++82EA              extractPath:
  50++82EA 21 A8 74 11      ld hl, historyBlock.locator, de, nameBuffer, bc, #ff
  50++82EE 02 83 01 FF
  50++82F2 00
  50++82F3 ED B0          ldir
  51++82F5 C9               ret
  52++82F6
  53++82F6              extractHostName:
  54++82F6 21 A7 75 11      ld hl, historyBlock.host, de, hostName, bc, 64
  54++82FA 02 84 01 40
  54++82FE 00
  54++82FF ED B0          ldir
  55++8301 C9               ret
  56++8302
  57++8302                  ENDMODULE
  58++8302
  59++8302 00 00 00...  nameBuffer ds #ff, 0
  60++8401
  61++8401 00                    db 0
  62++8402 00 00 00...  hostName ds 64
# file closed: gopher/engine/urlencoder.asm
  21+ 8442                  include "gopher/engine/fetcher.asm"
# file opened: gopher/engine/fetcher.asm
   1++8442                  MODULE Fetcher
   2++8442
   3++8442              fetchFromNet:
   4++8442
   5++8442              	IFDEF MSX
   6++8442 ~                	call Gopher.makeRequest
   6++8442 ~              jr nz, .error
   7++8442                  ELSE
   8++8442 CD FF 84         	call Gopher.makeRequest
   8++8445 38 06          jr c, .error
   9++8447                  ENDIF
  10++8447
  11++8447 CD 17 85         call Gopher.loadBuffer
  12++844A C3 9B 84         jp MediaProcessor.processResource
  13++844D              .error
  14++844D 21 56 84         ld hl, .err
  14++8450 CD DB 69       call DialogBox.msgBox
  15++8453 C3 6A 73         jp History.back
  16++8456
  17++8456 44 6F 63 75  .err db "Document fetch error! Check your connection or hostname!", 0
  17++845A 6D 65 6E 74
  17++845E 20 66 65 74
  17++8462 63 68 20 65
  17++8466 72 72 6F 72
  17++846A 21 20 43 68
  17++846E 65 63 6B 20
  17++8472 79 6F 75 72
  17++8476 20 63 6F 6E
  17++847A 6E 65 63 74
  17++847E 69 6F 6E 20
  17++8482 6F 72 20 68
  17++8486 6F 73 74 6E
  17++848A 61 6D 65 21
  17++848E 00
  18++848F
  19++848F
  20++848F              fetchFromFS:
  21++848F CD EA 82         call UrlEncoder.extractPath
  22++8492              loadFile
  23++8492              	IFDEF MSX
  24++8492 ~                ld de, nameBuffer, a, FMODE_NO_WRITE
  25++8492 ~                call Dos.fopen
  26++8492 ~                ld a, b, (.fp), a
  27++8492 ~                ld de, outputBuffer, hl, (ramtop)
  28++8492 ~                call Dos.fread
  29++8492 ~                ld a, (.fp), b, a
  30++8492 ~                call Dos.fclose
  31++8492 ~                jp MediaProcessor.processResource
  32++8492 ~            .fp db 0
  33++8492              	ELSE
  34++8492 21 02 83         ld hl, nameBuffer
  35++8495 CD 6C 6C         call Dos.loadBuffer
  36++8498 C3 9B 84         jp MediaProcessor.processResource
  37++849B              	ENDIF
  38++849B                  ENDMODULE
# file closed: gopher/engine/fetcher.asm
  22+ 849B                  include "gopher/engine/media-processor.asm"
# file opened: gopher/engine/media-processor.asm
   1++849B                  MODULE MediaProcessor
   2++849B              processResource:
   3++849B CD F6 82         call UrlEncoder.extractHostName
   4++849E 3A A7 74         ld a, (historyBlock.mediaType)
   5++84A1 FE 05            cp MIME_MUSIC
   5++84A3 28 13          jr z, processPT
   6++84A5 FE 02            cp MIME_LINK
   6++84A7 28 15          jr z, processPage
   7++84A9 FE 04            cp MIME_INPUT
   7++84AB 28 11          jr z, processPage
   8++84AD FE 06            cp MIME_IMAGE
   8++84AF CA 1F 99       jp z, ScreenViewer.display
   9++84B2              	ifdef GS
  10++84B2 ~                cp MIME_MOD
  10++84B2 ~              jr z, processMOD
  11++84B2              	endif
  12++84B2              ; Fallback to plain text
  13++84B2              processText:
  14++84B2 CD 4D 68         call Render.renderPlainTextScreen
  15++84B5 C3 95 68         jp   Render.plainTextLoop
  16++84B8
  17++84B8              processPT:
  18++84B8 CD D1 8C         call VortexProcessor.play
  19++84BB C3 6A 73         jp History.back
  20++84BE
  21++84BE                  ifdef GS
  22++84BE ~            processMOD:
  23++84BE ~                call ModProcessor.play
  24++84BE ~                jp History.back
  25++84BE              	endif
  26++84BE
  27++84BE              processPage:
  28++84BE 3A 25 69         ld a, (Render.play_next)
  28++84C1 A7             and a
  28++84C2 20 06          jr nz, .playNext
  29++84C4 CD B0 66         call Render.renderGopherScreen
  30++84C7 C3 FF 66         jp   Render.workLoop
  31++84CA              .playNext
  32++84CA 21 EE 76         ld hl, Render.cursor_position
  33++84CD 34               inc (hl)
  34++84CE CD B0 66         call Render.renderGopherScreen
  35++84D1 C3 E9 66         jp Render.checkBorder
  36++84D4                  ENDMODULE
# file closed: gopher/engine/media-processor.asm
  23+ 84D4                  include "gopher/gopher.asm"
# file opened: gopher/gopher.asm
   1++84D4                  module Gopher
   2++84D4              ; HL - gopher row
   3++84D4              extractRequest:
   4++84D4 21 A8 74         ld hl, historyBlock.locator
   5++84D7 11 20 86         ld de, requestbuffer
   6++84DA              .loop
   7++84DA 7E               ld a, (hl)
   8++84DB 12               ld (de), a
   9++84DC 23               inc hl
  10++84DD 13               inc de
  11++84DE FE 00            cp 0
  12++84E0 28 02            jr z, .search
  13++84E2 18 F6            jr .loop
  14++84E4              .search
  15++84E4 1B               dec de
  16++84E5 3A A7 74         ld a, (historyBlock.mediaType)
  17++84E8 FE 04            cp MIME_INPUT
  18++84EA 20 10            jr nz, .exit
  19++84EC 21 ED 75         ld hl, historyBlock.search
  20++84EF 3E 09            ld a, TAB
  21++84F1 12               ld (de), a
  22++84F2 13               inc de
  23++84F3              .searchCopy
  24++84F3 7E               ld a, (hl)
  25++84F4 A7               and a
  25++84F5 28 05          jr z, .exit
  26++84F7 12               ld (de), a
  27++84F8 23               inc hl
  27++84F9 13             inc de
  28++84FA 18 F7            jr .searchCopy
  29++84FC              .exit
  30++84FC AF               xor a
  31++84FD 12               ld (de), a
  32++84FE C9               ret
  33++84FF
  34++84FF
  35++84FF              makeRequest:
  36++84FF CD D4 84         call extractRequest
  37++8502
  38++8502 21 A7 75         ld hl, historyBlock.host
  39++8505 11 E7 75         ld de, historyBlock.port
  40++8508 CD CD 89         call Wifi.openTCP
  41++850B D8               ret c
  42++850C
  43++850C 21 20 86         ld hl, requestbuffer
  44++850F CD BE 8A         call Wifi.tcpSendZ
  45++8512 AF               xor a
  45++8513 32 98 88       ld (Wifi.closed), a
  46++8516 C9               ret
  47++8517
  48++8517
  49++8517              loadBuffer:
  50++8517 21 44 99         ld hl, outputBuffer
  51++851A 22 96 88         ld (Wifi.buffer_pointer), hl
  52++851D              .loop
  53++851D CD 0E 8B         call Wifi.getPacket
  54++8520 3A 98 88         ld a, (Wifi.closed)
  54++8523 A7             and a
  54++8524 C0             ret nz
  55++8525 CD 2B 8A         call Wifi.continue
  56++8528 18 F3            jr .loop
  57++852A
  58++852A                  ifdef GS
  59++852A ~            loadMod:
  60++852A ~                xor a
  60++852A ~              call GeneralSound.init
  61++852A ~                ld hl, .progress
  61++852A ~              call DialogBox.msgNoWait
  62++852A ~                call makeRequest
  62++852A ~              jp c, Fetcher.fetchFromNet.error
  63++852A ~                call GeneralSound.loadModule
  64++852A ~            .loop
  65++852A ~                ld hl, outputBuffer, (Wifi.buffer_pointer), hl
  66++852A ~                call Wifi.getPacket
  67++852A ~                ld a, (Wifi.closed)
  67++852A ~              and a
  67++852A ~              jr nz, .exit
  68++852A ~                ld hl, outputBuffer, bc, (Wifi.bytes_avail)
  69++852A ~            .loadLoop
  70++852A ~                ld a, b
  70++852A ~              or c
  70++852A ~              and a
  70++852A ~              jr z, .nextFrame
  71++852A ~                ld a, (hl)
  71++852A ~              call GeneralSound.sendByte
  72++852A ~                dec bc
  73++852A ~                inc hl
  74++852A ~                jr .loadLoop
  75++852A ~            .nextFrame
  76++852A ~                call pulsing
  77++852A ~                ;call Wifi.continue
  78++852A ~                jr .loop
  79++852A ~            .exit
  80++852A ~                call GeneralSound.finishLoadingModule
  81++852A ~                ;jp History.back
  82++852A ~            	jp MediaProcessor.processResource
  83++852A ~            .progress db "MOD downloading directly to GS!", 0
  84++852A                  endif
  85++852A
  86++852A              download:
  87++852A 11 A8 74         ld de, historyBlock.locator
  88++852D 62 6B            ld hl, de
  89++852F              .findFileName
  90++852F 1A               ld a, (de)
  90++8530 13             inc de
  91++8531 FE 2F            cp '/'
  91++8533 20 02          jr nz, .skip
  92++8535 62 6B            ld hl, de
  93++8537              .skip
  94++8537 A7               and a
  94++8538 20 F5          jr nz, .findFileName
  95++853A              .copy
  96++853A                  ;; HL - filename pointer
  97++853A 11 8B 69         ld de, DialogBox.inputBuffer
  98++853D              .copyFileName
  99++853D 7E               ld a, (hl)
  99++853E A7             and a
  99++853F 28 05          jr z, .finishCopy
 100++8541
 101++8541 12               ld (de), a
 101++8542 23 13          inc hl, de
 102++8544 18 F7            jr .copyFileName
 103++8546              .finishCopy
 104++8546 12               ld (de), a
 105++8547 CD 2A 69         call DialogBox.inputBox.noclear
 106++854A 3A 8B 69         ld a, (DialogBox.namedownload)
 106++854D A7             and a
 106++854E CA 6A 73       jp z, History.back
 107++8551
 108++8551 CD FF 84         call makeRequest
 108++8554 DA 4D 84       jp c, Fetcher.fetchFromNet.error
 109++8557
 110++8557 06 0E 21 8B      ld b, Dos.FMODE_CREATE, hl, DialogBox.namedownload
 110++855B 69
 111++855C CD 88 6C         call Dos.fopen
 112++855F 32 FD 85         ld (.fp), a
 113++8562
 114++8562 21 D8 85         ld hl, .progress
 114++8565 CD E4 69       call DialogBox.msgNoWait
 115++8568              .loop
 116++8568 21 44 99 22      ld hl, outputBuffer, (Wifi.buffer_pointer), hl
 116++856C 96 88
 117++856E CD 0E 8B         call Wifi.getPacket
 118++8571 3A 98 88         ld a, (Wifi.closed)
 118++8574 A7             and a
 118++8575 20 12          jr nz, .exit
 119++8577
 120++8577 3A FD 85 21      ld a, (.fp), hl, outputBuffer, bc, (Wifi.bytes_avail)
 120++857B 44 99 ED 4B
 120++857F 94 88
 121++8581 CD F1 6E         call Dos.fwrite
 122++8584 CD 00 86         call pulsing
 123++8587 18 DF            jr .loop
 124++8589              .exit
 125++8589 3A FD 85         ld a, (.fp)
 126++858C CD D3 6D         call Dos.fclose
 127++858F C3 6A 73         jp History.back
 128++8592              .error
 129++8592 3A FD 85         ld a, (.fp)
 130++8595 CD D3 6D         call Dos.fclose
 131++8598 21 A1 85         ld hl, .err
 132++859B CD DB 69         call DialogBox.msgBox
 133++859E C3 6A 73         jp History.back
 134++85A1
 135++85A1 4F 70 65 72  .err db "Operation failed! Sorry! Check filename or disk space!",0
 135++85A5 61 74 69 6F
 135++85A9 6E 20 66 61
 135++85AD 69 6C 65 64
 135++85B1 21 20 53 6F
 135++85B5 72 72 79 21
 135++85B9 20 43 68 65
 135++85BD 63 6B 20 66
 135++85C1 69 6C 65 6E
 135++85C5 61 6D 65 20
 135++85C9 6F 72 20 64
 135++85CD 69 73 6B 20
 135++85D1 73 70 61 63
 135++85D5 65 21 00
 136++85D8 44 6F 77 6E  .progress db "Downloading in progress! Wait a bit!", 0
 136++85DC 6C 6F 61 64
 136++85E0 69 6E 67 20
 136++85E4 69 6E 20 70
 136++85E8 72 6F 67 72
 136++85EC 65 73 73 21
 136++85F0 20 57 61 69
 136++85F4 74 20 61 20
 136++85F8 62 69 74 21
 136++85FC 00
 137++85FD 00           .fp db 0
 138++85FE 00           socket db 0
 139++85FF 20           pulsator db " "
 140++8600              pulsing
 141++8600 11 01 0B         ld de, #0B01
 141++8603 CD 3A 60       call TextMode.gotoXY
 142++8606 3A FF 85         ld a, (pulsator)
 143++8609 FE 2A            cp '*'
 144++860B CA 17 86         jp z, printasterix
 145++860E CD A4 60         call TextMode.putC
 146++8611 3E 2A            ld a, '*'
 147++8613 32 FF 85         ld (pulsator),a
 148++8616 C9               ret
 149++8617              printasterix
 150++8617 CD A4 60         call TextMode.putC
 151++861A 3E 20            ld a, ' '
 152++861C 32 FF 85         ld (pulsator),a
 153++861F C9               ret
 154++8620
 155++8620 00 00 00...  requestbuffer ds #1ff
 156++881F                  endmodule
 157++881F
# file closed: gopher/gopher.asm
  24+ 881F                  include "drivers/index.asm"
# file opened: drivers/index.asm
   1++881F                  IFDEF UNO
   2++881F ~                	include "uart-uno.asm"
   3++881F                  ENDIF
   4++881F
   5++881F                  IFDEF UNOUART
   6++881F ~                	include "uart-uno.asm"
   7++881F                  ENDIF
   8++881F
   9++881F                  IFDEF MB03
  10++881F ~                	include "uart-mb03.asm"
  11++881F                  ENDIF
  12++881F
  13++881F                  IFDEF AY
  14++881F ~                	include "uart-ay.asm"
  15++881F                  ENDIF
  16++881F
  17++881F                  IFDEF ZW
  18++881F                  	include "uart-zxwifi.asm"
# file opened: drivers/uart-zxwifi.asm
   1++881F              ; This driver works with 16c550 uart that's support AFE
   2++881F                  module Uart
   3++881F              ; Make init shorter and readable:-)
   4++881F                  macro outp port, value
   5++881F ~            	ld b, port
   6++881F ~            	ld c, #EF
   7++881F ~                ld a, value
   8++881F ~                out (c), a
   9++881F                  endm
  10++881F
  11++881F              ; Internal port constants
  12++881F              RBR_THR = #F8
  13++881F              IER     = RBR_THR + 1
  14++881F              IIR_FCR = RBR_THR + 2
  15++881F              LCR     = RBR_THR + 3
  16++881F              MCR     = RBR_THR + 4
  17++881F              LSR     = RBR_THR + 5
  18++881F              MSR     = RBR_THR + 6
  19++881F              SR      = RBR_THR + 7
  20++881F
  21++881F
  22++881F              init:
  23++881F                  IFDEF GZ
  24++881F ~                outp MCR,     #0d  // Assert RTS
  25++881F ~                outp IIR_FCR, #87  // Enable fifo 8 level, and clear it
  26++881F ~                outp LCR,     #83  // 8n1, DLAB=1
  27++881F ~                outp RBR_THR, 12  //(divider 12)
  28++881F ~                outp IER,     #00  // (divider 0). Divider is 16 bit, so we get (#0002 divider)
  29++881F ~
  30++881F ~                outp LCR,     #03 // 8n1, DLAB=0
  31++881F ~                outp IER,     #00 // Disable int
  32++881F ~                outp MCR,     #2f // Enable AFE
  33++881F ~                ret
  34++881F                  ELSE
  35++881F                  outp MCR,     #0d  // Assert RTS
  35++881F 06 FC       >	ld b, MCR
  35++8821 0E EF       >	ld c, #EF
  35++8823 3E 0D       >    ld a, #0d
  35++8825 ED 79       >    out (c), a
  36++8827                  outp IIR_FCR, #87  // Enable fifo 8 level, and clear it
  36++8827 06 FA       >	ld b, IIR_FCR
  36++8829 0E EF       >	ld c, #EF
  36++882B 3E 87       >    ld a, #87
  36++882D ED 79       >    out (c), a
  37++882F                  outp LCR,     #83  // 8n1, DLAB=1
  37++882F 06 FB       >	ld b, LCR
  37++8831 0E EF       >	ld c, #EF
  37++8833 3E 83       >    ld a, #83
  37++8835 ED 79       >    out (c), a
  38++8837                  outp RBR_THR, 1  // 115200 (divider 1)
  38++8837 06 F8       >	ld b, RBR_THR
  38++8839 0E EF       >	ld c, #EF
  38++883B 3E 01       >    ld a, 1
  38++883D ED 79       >    out (c), a
  39++883F                  outp IER,     #00  // (divider 0). Divider is 16 bit, so we get (#0002 divider)
  39++883F 06 F9       >	ld b, IER
  39++8841 0E EF       >	ld c, #EF
  39++8843 3E 00       >    ld a, #00
  39++8845 ED 79       >    out (c), a
  40++8847
  41++8847                  outp LCR,     #03 // 8n1, DLAB=0
  41++8847 06 FB       >	ld b, LCR
  41++8849 0E EF       >	ld c, #EF
  41++884B 3E 03       >    ld a, #03
  41++884D ED 79       >    out (c), a
  42++884F                  outp IER,     #00 // Disable int
  42++884F 06 F9       >	ld b, IER
  42++8851 0E EF       >	ld c, #EF
  42++8853 3E 00       >    ld a, #00
  42++8855 ED 79       >    out (c), a
  43++8857                  outp MCR,     #2f // Enable AFE
  43++8857 06 FC       >	ld b, MCR
  43++8859 0E EF       >	ld c, #EF
  43++885B 3E 2F       >    ld a, #2f
  43++885D ED 79       >    out (c), a
  44++885F
  45++885F C9               ret
  46++8860                  ENDIF
  47++8860              retry_rec_count_max equ 50 ;Р¶РґР°С‚СЊ 1 Р±Р°Р№С‚ РјР°РєСЃРёРјСѓРј СЃС‚РѕР»СЊРєРѕ РїСЂРµСЂС‹РІР°РЅРёР№
  48++8860
  49++8860              ; Flag C <- Data available
  50++8860              ; isAvailable:
  51++8860                  ; ld a, LSR
  52++8860                  ; in a, (#EF)
  53++8860                  ; rrca
  54++8860                  ; ret
  55++8860
  56++8860              ; Non-blocking read
  57++8860              ; Flag C <- is byte was readen
  58++8860              ; A <- byte
  59++8860              ; read1:
  60++8860                  ; ld a, LSR
  61++8860                  ; in a, (#EF)
  62++8860                  ; rrca
  63++8860                  ; ret nc
  64++8860                  ; ld a, RBR_THR
  65++8860                  ; in a, (#EF)
  66++8860                  ; scf
  67++8860                  ; ret
  68++8860
  69++8860              ; Tries read byte with timeout
  70++8860              ; Flag C <- is byte read
  71++8860              ; A <- byte
  72++8860              read:
  73++8860 AF           	xor a ;4
  74++8861 32 78 5C     	ld (#5C78),a ;РѕР±РЅСѓР»РёС‚СЊ СЃС‡С‘С‚С‡РёРє РѕР¶РёРґР°РЅРёСЏ ;13
  75++8864              .wait
  76++8864 3E FD            ld a, LSR
  77++8866 DB EF            in a, (#EF)
  78++8868 0F               rrca
  79++8869 30 05        	jr nc, .readW
  80++886B 3E F8            ld a, RBR_THR
  81++886D DB EF            in a, (#EF)
  82++886F C9           	ret
  83++8870              .readW
  84++8870 3A 78 5C     	ld a,(#5C78)
  85++8873 FE 32        	cp retry_rec_count_max
  86++8875 38 ED        	jr c, .wait ;РµС‰С‘ РїРѕРїС‹С‚РєР°
  87++8877 AF           	xor a ;РІС‹РєР»СЋС‡РёРј С„Р»Р°Рі РїРµСЂРµРЅРѕСЃР° РµСЃР»Рё РІСЂРµРјСЏ РІС‹С€Р»Рѕ
  88++8878 C9           	ret
  89++8879
  90++8879
  91++8879
  92++8879
  93++8879              ; Blocking read
  94++8879              ; A <- Byte
  95++8879              ; readB:
  96++8879                  ; ld a, LSR
  97++8879                  ; in a, (#EF)
  98++8879                  ; rrca
  99++8879                  ; jr nc, readB
 100++8879              	; ld a, RBR_THR
 101++8879                  ; in a, (#EF)
 102++8879                  ; ret
 103++8879
 104++8879              ; A -> byte to send
 105++8879              write:
 106++8879 F5               push af
 107++887A              .wait
 108++887A 3E FD        	ld a, LSR
 109++887C DB EF            in a, (#EF)
 110++887E E6 20            and #20
 111++8880 28 F8            jr z, .wait
 112++8882 F1               pop af
 113++8883 06 F8        	ld b, RBR_THR
 114++8885 0E EF        	ld c, #EF
 115++8887 ED 79            out (c), a
 116++8889 C9               ret
 117++888A
 118++888A                  endmodule
# file closed: drivers/uart-zxwifi.asm
  19++888A                  ENDIF
  20++888A
  21++888A              	include "utils.asm"
# file opened: drivers/utils.asm
   1++888A              ;;; Macroses!!!!
   2++888A                  MACRO EspSend Text
   3++888A ~                ld hl, .txtB
   4++888A ~                ld e, (.txtE - .txtB)
   5++888A ~                call espSend
   6++888A ~                jr .txtE
   7++888A ~            .txtB
   8++888A ~                db Text
   9++888A ~            .txtE
  10++888A                  ENDM
  11++888A
  12++888A                  MACRO EspCmd Text
  13++888A ~                ld hl, .txtB
  14++888A ~                ld e, (.txtE - .txtB)
  15++888A ~                call espSend
  16++888A ~                jr .txtE
  17++888A ~            .txtB
  18++888A ~                db Text
  19++888A ~                db 13, 10
  20++888A ~            .txtE
  21++888A                  ENDM
  22++888A
  23++888A                  MACRO EspCmdOkErr text
  24++888A ~                EspCmd text
  25++888A ~                call checkOkErr
  26++888A                  ENDM
  27++888A
  28++888A              ; IN DE - string pointer
  29++888A              ; OUT HL - string len
  30++888A              strLen:
  31++888A 21 00 00         ld hl, 0
  32++888D              .loop
  33++888D 1A               ld a, (de)
  33++888E A7             and a
  33++888F C8             ret z
  34++8890 13 23            inc de, hl
  35++8892 18 F9            jr .loop
# file closed: drivers/utils.asm
  22++8894
  23++8894              	IFDEF UARTATM
  24++8894 ~            		include "uart-atm.asm"
  25++8894              	ENDIF
  26++8894
  27++8894              	IFDEF UARTEVO
  28++8894 ~            		include "uart-evo.asm"
  29++8894                  ENDIF
  30++8894
  31++8894              	IFDEF NEDONET
  32++8894 ~            		include "nedowifi.asm"
  33++8894              	ELSE
  34++8894              	IFNDEF MSX
  35++8894              		include "wifi.asm"
# file opened: drivers/wifi.asm
   1++8894                  MODULE Wifi
   2++8894 00 00        bytes_avail dw 0
   3++8896 00 00        buffer_pointer dw 0
   4++8898 01           closed db 1
   5++8899              ; Initialize Wifi chip to work
   6++8899              init:
   7++8899
   8++8899 21 8B 89         ld hl, .uartIniting
   8++889C CD BC 60       call TextMode.printZ
   9++889F CD 1F 88         call Uart.init
  10++88A2 21 9C 89         ld hl, .chipIniting
  10++88A5 CD BC 60       call TextMode.printZ
  11++88A8
  12++88A8                  EspCmdOkErr "ATE0"
  12++88A8             >    EspCmd "ATE0"
  12++88A8 21 B2 88    >    ld hl, .txtB
  12++88AB 1E 06       >    ld e, (.txtE - .txtB)
  12++88AD CD A1 8A    >    call espSend
  12++88B0 18 06       >    jr .txtE
  12++88B2             >.txtB
  12++88B2 41 54 45 30 >    db "ATE0"
  12++88B6 0D 0A       >    db 13, 10
  12++88B8             >.txtE
  12++88B8 CD 2C 8A    >    call checkOkErr
  13++88BB DA 6B 89         jp c, .initError
  14++88BE
  15++88BE              ; Reading auth.pwd and send it to ESP
  16++88BE 21 A4 99 06      ld hl, creds, b, Dos.FMODE_READ
  16++88C2 01
  16++88C3 CD 88 6C       call Dos.fopen
  17++88C6 F5               push af
  18++88C7 21 B5 99 01      ld hl,outputBuffer2, bc, 255
  18++88CB FF 00
  18++88CD CD CE 6E       call Dos.fread
  19++88D0 F1               pop af
  20++88D1 CD D3 6D         call Dos.fclose
  21++88D4
  22++88D4 21 B4 89         ld hl, .doneInit1
  22++88D7 CD BC 60       call TextMode.printZ
  23++88DA
  24++88DA 21 B5 99         ld hl,outputBuffer2
  25++88DD CD AB 8A         call espSendT
  26++88E0 3E 0D            ld a, 13
  26++88E2 CD 79 88       call Uart.write
  27++88E5 3E 0A            ld a, 10
  27++88E7 CD 79 88       call Uart.write
  28++88EA CD 2C 8A         call checkOkErr
  29++88ED DA 6B 89         jp c, .initError
  30++88F0              ;
  31++88F0                 	EspCmdOkErr "AT+CIPSERVER=0"
  31++88F0             >    EspCmd "AT+CIPSERVER=0"
  31++88F0 21 FA 88    >    ld hl, .txtB
  31++88F3 1E 10       >    ld e, (.txtE - .txtB)
  31++88F5 CD A1 8A    >    call espSend
  31++88F8 18 10       >    jr .txtE
  31++88FA             >.txtB
  31++88FA 41 54 2B 43 >    db "AT+CIPSERVER=0"
  31++88FE 49 50 53 45 >
  31++8902 52 56 45 52 >
  31++8906 3D 30       >
  31++8908 0D 0A       >    db 13, 10
  31++890A             >.txtE
  31++890A CD 2C 8A    >    call checkOkErr
  32++890D                  EspCmdOkErr "AT+CIPCLOSE" ; Close if there some connection was. Don't care about result
  32++890D             >    EspCmd "AT+CIPCLOSE"
  32++890D 21 17 89    >    ld hl, .txtB
  32++8910 1E 0D       >    ld e, (.txtE - .txtB)
  32++8912 CD A1 8A    >    call espSend
  32++8915 18 0D       >    jr .txtE
  32++8917             >.txtB
  32++8917 41 54 2B 43 >    db "AT+CIPCLOSE"
  32++891B 49 50 43 4C >
  32++891F 4F 53 45    >
  32++8922 0D 0A       >    db 13, 10
  32++8924             >.txtE
  32++8924 CD 2C 8A    >    call checkOkErr
  33++8927                  EspCmdOkErr "AT+CIPMUX=0" ; Single connection mode
  33++8927             >    EspCmd "AT+CIPMUX=0"
  33++8927 21 31 89    >    ld hl, .txtB
  33++892A 1E 0D       >    ld e, (.txtE - .txtB)
  33++892C CD A1 8A    >    call espSend
  33++892F 18 0D       >    jr .txtE
  33++8931             >.txtB
  33++8931 41 54 2B 43 >    db "AT+CIPMUX=0"
  33++8935 49 50 4D 55 >
  33++8939 58 3D 30    >
  33++893C 0D 0A       >    db 13, 10
  33++893E             >.txtE
  33++893E CD 2C 8A    >    call checkOkErr
  34++8941 DA 6B 89         jp c, .initError
  35++8944
  36++8944                  EspCmdOkErr "AT+CIPDINFO=0" ; Disable additional info
  36++8944             >    EspCmd "AT+CIPDINFO=0"
  36++8944 21 4E 89    >    ld hl, .txtB
  36++8947 1E 0F       >    ld e, (.txtE - .txtB)
  36++8949 CD A1 8A    >    call espSend
  36++894C 18 0F       >    jr .txtE
  36++894E             >.txtB
  36++894E 41 54 2B 43 >    db "AT+CIPDINFO=0"
  36++8952 49 50 44 49 >
  36++8956 4E 46 4F 3D >
  36++895A 30          >
  36++895B 0D 0A       >    db 13, 10
  36++895D             >.txtE
  36++895D CD 2C 8A    >    call checkOkErr
  37++8960 DA 6B 89         jp c, .initError
  38++8963
  39++8963 21 AD 89         ld hl, .doneInit
  39++8966 CD BC 60       call TextMode.printZ
  40++8969
  41++8969 B7               or a
  42++896A C9               ret
  43++896B              .initError
  44++896B 21 73 89         ld hl, .errMsg
  44++896E CD DB 69       call DialogBox.msgBox
  45++8971 37               scf
  46++8972 C9               ret
  47++8973 57 69 46 69  .errMsg      db "WiFi chip init failed!", "\r", 0
  47++8977 20 63 68 69
  47++897B 70 20 69 6E
  47++897F 69 74 20 66
  47++8983 61 69 6C 65
  47++8987 64 21 0D 00
  48++898B 55 61 72 74  .uartIniting db "Uart initing...", "\r", 0
  48++898F 20 69 6E 69
  48++8993 74 69 6E 67
  48++8997 2E 2E 2E 0D
  48++899B 00
  49++899C 43 68 69 70  .chipIniting db "Chip initing...", "\r", 0
  49++89A0 20 69 6E 69
  49++89A4 74 69 6E 67
  49++89A8 2E 2E 2E 0D
  49++89AC 00
  50++89AD 44 6F 6E 65  .doneInit    db "Done!","\r", 0
  50++89B1 21 0D 00
  51++89B4 53 65 6E 64  .doneInit1   db "Sending auth.pwd to ESP","\r", 0
  51++89B8 69 6E 67 20
  51++89BC 61 75 74 68
  51++89C0 2E 70 77 64
  51++89C4 20 74 6F 20
  51++89C8 45 53 50 0D
  51++89CC 00
  52++89CD                  IFNDEF PROXY
  53++89CD              ; HL - host pointer in gopher row
  54++89CD              ; DE - port pointer in gopher row
  55++89CD              openTCP:
  56++89CD D5               push de
  57++89CE E5               push hl
  58++89CF                  EspCmdOkErr "AT+CIPCLOSE" ; Don't care about result. Just close if it didn't happens before
  58++89CF             >    EspCmd "AT+CIPCLOSE"
  58++89CF 21 D9 89    >    ld hl, .txtB
  58++89D2 1E 0D       >    ld e, (.txtE - .txtB)
  58++89D4 CD A1 8A    >    call espSend
  58++89D7 18 0D       >    jr .txtE
  58++89D9             >.txtB
  58++89D9 41 54 2B 43 >    db "AT+CIPCLOSE"
  58++89DD 49 50 43 4C >
  58++89E1 4F 53 45    >
  58++89E4 0D 0A       >    db 13, 10
  58++89E6             >.txtE
  58++89E6 CD 2C 8A    >    call checkOkErr
  59++89E9                  EspSend 'AT+CIPSTART="TCP","'
  59++89E9 21 F3 89    >    ld hl, .txtB
  59++89EC 1E 13       >    ld e, (.txtE - .txtB)
  59++89EE CD A1 8A    >    call espSend
  59++89F1 18 13       >    jr .txtE
  59++89F3             >.txtB
  59++89F3 41 54 2B 43 >    db 'AT+CIPSTART="TCP","'
  59++89F7 49 50 53 54 >
  59++89FB 41 52 54 3D >
  59++89FF 22 54 43 50 >
  59++8A03 22 2C 22    >
  59++8A06             >.txtE
  60++8A06 E1               pop hl
  61++8A07 CD AB 8A         call espSendT
  62++8A0A                  EspSend '",'
  62++8A0A 21 14 8A    >    ld hl, .txtB
  62++8A0D 1E 02       >    ld e, (.txtE - .txtB)
  62++8A0F CD A1 8A    >    call espSend
  62++8A12 18 02       >    jr .txtE
  62++8A14             >.txtB
  62++8A14 22 2C       >    db '",'
  62++8A16             >.txtE
  63++8A16 E1               pop hl
  64++8A17 CD AB 8A         call espSendT
  65++8A1A 3E 0D            ld a, 13
  65++8A1C CD 79 88       call Uart.write
  66++8A1F 3E 0A            ld a, 10
  66++8A21 CD 79 88       call Uart.write
  67++8A24 AF               xor a
  67++8A25 32 98 88       ld (closed), a
  68++8A28 C3 2C 8A         jp checkOkErr
  69++8A2B
  70++8A2B              continue:
  71++8A2B C9               ret
  72++8A2C                  ENDIF
  73++8A2C
  74++8A2C
  75++8A2C
  76++8A2C              checkOkErr:
  77++8A2C CD 60 88         call Uart.read
  78++8A2F FE 4F            cp 'O'
  78++8A31 CA 41 8A       jp z, .okStart ; OK
  79++8A34 FE 45            cp 'E'
  79++8A36 CA 56 8A       jp z, .errStart ; ERROR
  80++8A39 FE 46            cp 'F'
  80++8A3B CA 7B 8A       jp z, .failStart ; FAIL
  81++8A3E C3 2C 8A         jp checkOkErr
  82++8A41              .okStart
  83++8A41 CD 60 88         call Uart.read
  83++8A44 FE 4B          cp 'K'
  83++8A46 C2 2C 8A       jp nz, checkOkErr
  84++8A49 CD 60 88         call Uart.read
  84++8A4C FE 0D          cp 13
  84++8A4E C2 2C 8A       jp nz, checkOkErr
  85++8A51 CD 98 8A         call .flushToLF
  86++8A54 B7               or a
  87++8A55 C9               ret
  88++8A56              .errStart
  89++8A56 CD 60 88         call Uart.read
  89++8A59 FE 52          cp 'R'
  89++8A5B C2 2C 8A       jp nz, checkOkErr
  90++8A5E CD 60 88         call Uart.read
  90++8A61 FE 52          cp 'R'
  90++8A63 C2 2C 8A       jp nz, checkOkErr
  91++8A66 CD 60 88         call Uart.read
  91++8A69 FE 4F          cp 'O'
  91++8A6B C2 2C 8A       jp nz, checkOkErr
  92++8A6E CD 60 88         call Uart.read
  92++8A71 FE 52          cp 'R'
  92++8A73 C2 2C 8A       jp nz, checkOkErr
  93++8A76 CD 98 8A         call .flushToLF
  94++8A79 37               scf
  95++8A7A C9               ret
  96++8A7B              .failStart
  97++8A7B CD 60 88         call Uart.read
  97++8A7E FE 41          cp 'A'
  97++8A80 C2 2C 8A       jp nz, checkOkErr
  98++8A83 CD 60 88         call Uart.read
  98++8A86 FE 49          cp 'I'
  98++8A88 C2 2C 8A       jp nz, checkOkErr
  99++8A8B CD 60 88         call Uart.read
  99++8A8E FE 4C          cp 'L'
  99++8A90 C2 2C 8A       jp nz, checkOkErr
 100++8A93 CD 98 8A         call .flushToLF
 101++8A96 37               scf
 102++8A97 C9               ret
 103++8A98              .flushToLF
 104++8A98 CD 60 88         call Uart.read
 105++8A9B FE 0A            cp 10
 105++8A9D C2 98 8A       jp nz, .flushToLF
 106++8AA0 C9               ret
 107++8AA1
 108++8AA1              ; Send buffer to UART
 109++8AA1              ; HL - buff
 110++8AA1              ; E - count
 111++8AA1              espSend:
 112++8AA1 7E               ld a, (hl)
 112++8AA2 CD 79 88       call Uart.write
 113++8AA5 23               inc hl
 114++8AA6 1D               dec e
 115++8AA7 C2 A1 8A         jp nz, espSend
 116++8AAA C9               ret
 117++8AAB
 118++8AAB              ; HL - string that ends with one of the terminator(CR/LF/TAB/NULL)
 119++8AAB              espSendT:
 120++8AAB 7E               ld a, (hl)
 121++8AAC
 122++8AAC A7               and a
 122++8AAD C8             ret z
 123++8AAE FE 09            cp 9
 123++8AB0 C8             ret z
 124++8AB1 FE 0D            cp 13
 124++8AB3 C8             ret z
 125++8AB4 FE 0A            cp 10
 125++8AB6 C8             ret z
 126++8AB7
 127++8AB7 CD 79 88         call Uart.write
 128++8ABA 23               inc hl
 129++8ABB C3 AB 8A         jp espSendT
 130++8ABE
 131++8ABE              ; HL - stringZ to send
 132++8ABE              ; Adds CR LF
 133++8ABE              tcpSendZ:
 134++8ABE E5               push hl
 135++8ABF                  EspSend "AT+CIPSEND="
 135++8ABF 21 C9 8A    >    ld hl, .txtB
 135++8AC2 1E 0B       >    ld e, (.txtE - .txtB)
 135++8AC4 CD A1 8A    >    call espSend
 135++8AC7 18 0B       >    jr .txtE
 135++8AC9             >.txtB
 135++8AC9 41 54 2B 43 >    db "AT+CIPSEND="
 135++8ACD 49 50 53 45 >
 135++8AD1 4E 44 3D    >
 135++8AD4             >.txtE
 136++8AD4 D1               pop de
 136++8AD5 D5             push de
 137++8AD6 CD 8A 88         call strLen
 138++8AD9 23               inc hl
 138++8ADA 23             inc hl ; +CRLF
 139++8ADB CD A3 8B         call hlToNumEsp
 140++8ADE 3E 0D            ld a, 13
 140++8AE0 CD 79 88       call Uart.write
 141++8AE3 3E 0A            ld a, 10
 141++8AE5 CD 79 88       call Uart.write
 142++8AE8 CD 2C 8A         call checkOkErr
 142++8AEB D8             ret c
 143++8AEC              .wait
 144++8AEC CD 60 88         call Uart.read
 144++8AEF FE 3E          cp '>'
 144++8AF1 C2 EC 8A       jp nz, .wait
 145++8AF4 E1               pop hl
 146++8AF5              .loop
 147++8AF5 7E               ld a, (hl)
 147++8AF6 A7             and a
 147++8AF7 CA 01 8B       jp z, .exit
 148++8AFA CD 79 88         call Uart.write
 149++8AFD 23               inc hl
 150++8AFE C3 F5 8A         jp .loop
 151++8B01              .exit
 152++8B01 3E 0D            ld a, 13
 152++8B03 CD 79 88       call Uart.write
 153++8B06 3E 0A            ld a, 10
 153++8B08 CD 79 88       call Uart.write
 154++8B0B C3 2C 8A         jp checkOkErr
 155++8B0E
 156++8B0E              getPacket:
 157++8B0E CD 60 88         call Uart.read
 158++8B11 FE 2B            cp '+'
 158++8B13 CA 44 8B       jp z, .ipdBegun    ; "+IPD," packet
 159++8B16 FE 4F            cp 'O'
 159++8B18 CA 1E 8B       jp z, .closedBegun ; It enough to check "OSED\n" :-)
 160++8B1B C3 0E 8B         jp getPacket
 161++8B1E              .closedBegun
 162++8B1E CD 60 88         call Uart.read
 162++8B21 FE 53          cp 'S'
 162++8B23 C2 1E 8B       jp nz, .closedBegun
 163++8B26 CD 60 88         call Uart.read
 163++8B29 FE 45          cp 'E'
 163++8B2B C2 1E 8B       jp nz, .closedBegun
 164++8B2E CD 60 88         call Uart.read
 164++8B31 FE 44          cp 'D'
 164++8B33 C2 1E 8B       jp nz, .closedBegun
 165++8B36 CD 60 88         call Uart.read
 165++8B39 FE 0D          cp 13
 165++8B3B C2 1E 8B       jp nz, .closedBegun
 166++8B3E 3E 01 32 98      ld a, 1, (closed), a
 166++8B42 88
 167++8B43 C9               ret
 168++8B44              .ipdBegun
 169++8B44 CD 60 88         call Uart.read
 169++8B47 FE 49          cp 'I'
 169++8B49 C2 44 8B       jp nz, .ipdBegun
 170++8B4C CD 60 88         call Uart.read
 170++8B4F FE 50          cp 'P'
 170++8B51 C2 44 8B       jp nz, .ipdBegun
 171++8B54 CD 60 88         call Uart.read
 171++8B57 FE 44          cp 'D'
 171++8B59 C2 44 8B       jp nz, .ipdBegun
 172++8B5C CD 60 88         call Uart.read  ;Comma
 173++8B5F CD 89 8B         call .count_ipd_lenght
 173++8B62 22 94 88       ld (bytes_avail), hl
 174++8B65 54 5D            ld de, hl
 175++8B67 2A 96 88         ld hl, (buffer_pointer)
 176++8B6A              .readp
 177++8B6A 7C               ld a, h
 177++8B6B FE FF          cp #ff
 177++8B6D D2 7F 8B       jp nc, .skipbuff
 178++8B70 CD 60 88         call Uart.read
 179++8B73 77               ld (hl), a
 180++8B74 1B               dec de
 181++8B75 23               inc hl
 182++8B76 7A               ld a, d
 182++8B77 B3             or e
 182++8B78 C2 6A 8B       jp nz, .readp
 183++8B7B 22 96 88         ld (buffer_pointer), hl
 184++8B7E C9               ret
 185++8B7F              .skipbuff
 186++8B7F CD 60 88         call Uart.read
 187++8B82 1B               dec de
 187++8B83 7A             ld a, d
 187++8B84 B3             or e
 187++8B85 C2 7F 8B       jp nz, .skipbuff
 188++8B88 C9               ret
 189++8B89              .count_ipd_lenght
 190++8B89 21 00 00     		ld hl,0			; count lenght
 191++8B8C E5           .cil1	push  hl
 192++8B8D CD 60 88             call Uart.read
 193++8B90 E1                   pop hl
 194++8B91 FE 3A        		cp ':'
 195++8B93 C8                   ret z
 196++8B94 D6 30        		sub 0x30
 197++8B96 4D                   ld c,l
 198++8B97 44                   ld b,h
 199++8B98 29                   add hl,hl
 200++8B99 29                   add hl,hl
 201++8B9A 09                   add hl,bc
 202++8B9B 29                   add hl,hl
 203++8B9C 4F                   ld c,a
 204++8B9D 06 00                ld b,0
 205++8B9F 09                   add hl,bc
 206++8BA0 C3 8C 8B     		jp .cil1
 207++8BA3
 208++8BA3              ; Based on: https://wikiti.brandonw.net/index.php?title=Z80_Routines:Other:DispHL
 209++8BA3              ; HL - number
 210++8BA3              ; It will be written to UART
 211++8BA3              hlToNumEsp:
 212++8BA3 01 F0 D8     	ld	bc,-10000
 213++8BA6 CD BC 8B     	call	.n1
 214++8BA9 01 18 FC     	ld	bc,-1000
 215++8BAC CD BC 8B     	call	.n1
 216++8BAF 01 9C FF     	ld	bc,-100
 217++8BB2 CD BC 8B     	call	.n1
 218++8BB5 0E F6        	ld	c,-10
 219++8BB7 CD BC 8B     	call	.n1
 220++8BBA 0E FF        	ld	c,-1
 221++8BBC 3E 2F        .n1	ld	a,'0'-1
 222++8BBE 3C           .n2	inc	a
 223++8BBF 09           	add	hl,bc
 224++8BC0 DA BE 8B     	jp	c, .n2
 225++8BC3 ED 42        	sbc	hl,bc
 226++8BC5 C5               push bc
 227++8BC6 CD 79 88     	call Uart.write
 228++8BC9 C1               pop bc
 229++8BCA C9               ret
 230++8BCB              flushToLF1
 231++8BCB CD 60 88         call Uart.read
 232++8BCE FE 0A            cp 10
 232++8BD0 C2 CB 8B       jp nz, flushToLF1
 233++8BD3 C9               ret
 234++8BD4                  ENDMODULE
# file closed: drivers/wifi.asm
  36++8BD4              	ENDIF
  37++8BD4              	ENDIF
  38++8BD4
  39++8BD4                  IFDEF NEDOOS
  40++8BD4 ~                	include "rtc-nos.asm"
  41++8BD4                  ENDIF
  42++8BD4
  43++8BD4
  44++8BD4                  IFDEF SMUCRTC
  45++8BD4                  	include "rtc-smuc.asm"
# file opened: drivers/rtc-smuc.asm
   1++8BD4              ;clock driver SMUC
   2++8BD4              	module Clock
   3++8BD4              ; РІС‹С….:	CY=1, РµСЃР»Рё РјРёРєСЂРѕСЃС…РµРјС‹ CMOS РЅРµС‚
   4++8BD4              	; C вЂ” СЃРµРєСѓРЅРґС‹/С‡РёСЃР»Рѕ;
   5++8BD4              	; B - РјРёРЅСѓС‚С‹/РјРµСЃСЏС†;
   6++8BD4              	; E - С‡Р°СЃС‹/РіРѕРґ;
   7++8BD4
   8++8BD4              readTime
   9++8BD4 01 BA DF     	ld bc,#DFBA
  10++8BD7 3E 04        	ld a,4 ;С‡Р°СЃС‹
  11++8BD9 CD 0F 8C     	call out3d2f
  12++8BDC 3E 0A        	ld a,10 ;РїР°СѓР·Р°
  13++8BDE              readTimeCL
  14++8BDE 3D           	dec a
  15++8BDF 20 FD        	jr nz,readTimeCL
  16++8BE1 CD 08 8C     	call in3d2f
  17++8BE4 FE FF        	cp 255 ;РїСЂРѕРІРµСЂРєР° РЅР°Р»РёС‡РёСЏ РјРёРєСЂРѕСЃС…РµРјС‹
  18++8BE6 37           	scf
  19++8BE7 C8           	ret z
  20++8BE8 5F           	ld e,a
  21++8BE9 3E 02        	ld a,2 ;РјРёРЅСѓС‚С‹
  22++8BEB CD 0F 8C     	call out3d2f
  23++8BEE 3E 0A        	ld a,10 ;РїР°СѓР·Р°
  24++8BF0              readTimeCL2
  25++8BF0 3D           	dec a
  26++8BF1 20 FD        	jr nz,readTimeCL2
  27++8BF3 CD 08 8C     	call in3d2f
  28++8BF6 47           	ld b,a
  29++8BF7 B7           	or a
  30++8BF8              ;СЃРѕС…СЂР°РЅРµРЅРёРµ С‚РµРєСѓС‰РµРіРѕ РІСЂРµРјРµРЅРё
  31++8BF8 30 01        	jr nc,read_time_ok
  32++8BFA              	; ld hl,mes_no_RTC
  33++8BFA              	; call print_mes
  34++8BFA              	; scf
  35++8BFA C9           	ret ;РІС‹С…РѕРґ
  36++8BFB              read_time_ok
  37++8BFB 7B           	ld a,e ;С‡Р°СЃС‹
  38++8BFC 32 C5 8C     	ld (hours),a
  39++8BFF 78           	ld a,b ;РјРёРЅСѓС‚С‹
  40++8C00 32 C6 8C     	ld (minutes),a
  41++8C03 79           	ld a,c ;СЃРµРєСѓРЅРґС‹
  42++8C04 32 C7 8C     	ld (seconds),a
  43++8C07 C9           	ret
  44++8C08
  45++8C08              in3d2f
  46++8C08 21 F3 3F     	ld hl,#3ff3
  47++8C0B E5           	push hl
  48++8C0C C3 2F 3D     	jp #3d2f
  49++8C0F
  50++8C0F              out3d2f
  51++8C0F 21 53 2A     	ld hl,#2A53
  52++8C12 E5           	push hl
  53++8C13 C3 2F 3D     	jp #3d2f
  54++8C16                  endmodule
  55++8C16
# file closed: drivers/rtc-smuc.asm
  46++8C16                  ENDIF
  47++8C16
  48++8C16              	IFDEF MSX
  49++8C16 ~                    include "drivers/unapi/unapi.asm"
  50++8C16 ~                	include "drivers/unapi/tcp.asm"
  51++8C16 ~            		include "rtc-msx.asm"
  52++8C16                  ELSE
  53++8C16              		include "proxy.asm"
# file opened: drivers/proxy.asm
   1++8C16                  IFDEF PROXY
   2++8C16 ~                MODULE Wifi
   3++8C16 ~            ; Same singature as wifi.openTCP
   4++8C16 ~            ; HL - host pointer in gopher row
   5++8C16 ~            ; DE - port pointer in gopher row
   6++8C16 ~            openTCP:
   7++8C16 ~                push de
   8++8C16 ~                push hl
   9++8C16 ~
  10++8C16 ~                xor a
  10++8C16 ~              ld hl, hostBuff, de, hostBuff + 1, bc, 102, (hl), a
  10++8C16 ~              ldir
  11++8C16 ~
  12++8C16 ~                EspCmdOkErr "AT+CIPCLOSE"
  13++8C16 ~                EspCmdOkErr 'AT+CIPSTART="TCP","138.68.76.243",6912' // Replace here for yourown proxy. If you wish
  14++8C16 ~                jr c, .error
  15++8C16 ~                pop hl
  15++8C16 ~              ld de, hostBuff
  16++8C16 ~            .copyHost
  17++8C16 ~                ld a, (hl)
  17++8C16 ~              and a
  17++8C16 ~              jr z, 1F
  17++8C16 ~              and a
  17++8C16 ~              jr z, 1F
  18++8C16 ~                ld (de), a
  18++8C16 ~              inc hl, de
  19++8C16 ~                jr .copyHost
  20++8C16 ~            1   xor a
  20++8C16 ~              ld (de), a
  21++8C16 ~                pop hl
  21++8C16 ~              ld de, portBuff
  22++8C16 ~            .copyPort
  23++8C16 ~                ld a, (hl)
  23++8C16 ~              and a
  23++8C16 ~              jr z, 1F
  23++8C16 ~              and a
  23++8C16 ~              jr z, 1F
  24++8C16 ~                ld (de), a
  24++8C16 ~              inc hl, de
  25++8C16 ~                jr .copyPort
  26++8C16 ~            1   ld hl, hostBuff
  26++8C16 ~              call tcpSendZ
  27++8C16 ~                ld hl, portBuff
  27++8C16 ~              call tcpSendZ
  28++8C16 ~                xor a
  28++8C16 ~              ld (closed), a
  29++8C16 ~                ret
  30++8C16 ~            .error
  31++8C16 ~                pop hl
  31++8C16 ~              pop de
  32++8C16 ~                ret
  33++8C16 ~
  34++8C16 ~            continue:
  35++8C16 ~                EspCmdOkErr "AT+CIPSEND=1"
  36++8C16 ~                ret c
  37++8C16 ~            .wait
  38++8C16 ~                call Uart.read
  38++8C16 ~              cp '>'
  38++8C16 ~              jr nz, .wait
  39++8C16 ~                ld a, 'c'
  39++8C16 ~              call Uart.write
  40++8C16 ~                jp checkOkErr
  41++8C16 ~
  42++8C16 ~            hostBuff ds 96
  43++8C16 ~            portBuff ds 7
  44++8C16 ~                ENDMODULE
  45++8C16                  ENDIF
# file closed: drivers/proxy.asm
  54++8C16              		include "memory.asm"
# file opened: drivers/memory.asm
   1++8C16                  module Memory
   2++8C16              BANKM = #5b5c
   3++8C16              MEM_PORT = #7ffd
   4++8C16
   5++8C16              init:
   6++8C16 F3               di
   7++8C17 FD CB 01 A6      res 4, (iy + 1)
   8++8C1B
   9++8C1B AF               xor a
   9++8C1C CD 20 8C       call setPage
  10++8C1F C9               ret
  11++8C20
  12++8C20              ; a - page
  13++8C20              setPage:
  14++8C20 F6 18            or #18
  14++8C22 32 5C 5B       ld (BANKM), a
  15++8C25 01 FD 7F         ld bc, MEM_PORT
  15++8C28 ED 79          out (c), a
  16++8C2A C9               ret
  17++8C2B
  18++8C2B                  endmodule
# file closed: drivers/memory.asm
  55++8C2B              	ENDIF
  56++8C2B
  57++8C2B              	IFDEF GS
  58++8C2B ~            		include "general-sound.asm"
  59++8C2B              	ENDIF
# file closed: drivers/index.asm
  25+ 8C2B                  include "screen/rtc.asm"
# file opened: screen/rtc.asm
   1++8C2B              printRTC
   2++8C2B              	IFDEF RTC
   3++8C2B CD D4 8B     	call Clock.readTime
   4++8C2E
   5++8C2E 3A D0 8C     	ld a, (oldminutes)
   6++8C31 57           	ld d,a
   7++8C32 3A C6 8C     	ld a, (minutes)
   8++8C35 BA           	cp d					; Update only if minutes changed
   9++8C36 C8           	ret z
  10++8C37 32 D0 8C     	ld (oldminutes), a
  11++8C3A
  12++8C3A 16 01        	ld d,1 ;РєРѕРѕСЂРґРёРЅР°С‚С‹ Y,X
  13++8C3C 1E 39        	ld e,64 - 7
  14++8C3E CD 3A 60     	call TextMode.gotoXY
  15++8C41 3E 5B        	ld a,'['
  16++8C43 CD A4 60     	call TextMode.putC
  17++8C46 26 00        	ld h,0
  18++8C48 3A C5 8C     	ld a,(hours) ;С‡Р°СЃС‹
  19++8C4B 6F           	ld l,a
  20++8C4C CD 6F 8C     	call toDecimal
  21++8C4F 21 CB 8C     	ld hl,decimalS+3
  22++8C52 CD BC 60     	call TextMode.printZ
  23++8C55 3E 3A        	ld a,':'
  24++8C57 CD A4 60     	call TextMode.putC
  25++8C5A 26 00        	ld h,0
  26++8C5C 3A C6 8C     	ld a,(minutes) ;РјРёРЅСѓС‚С‹
  27++8C5F 6F           	ld l,a
  28++8C60 CD 6F 8C     	call toDecimal
  29++8C63 21 CB 8C     	ld hl,decimalS+3
  30++8C66 CD BC 60     	call TextMode.printZ
  31++8C69              	;ld a,':'
  32++8C69              	;call TextMode.putC
  33++8C69              	;ld h,0
  34++8C69              	;ld a,(seconds) ;СЃРµРєСѓРЅРґС‹
  35++8C69              	;ld l,a
  36++8C69              	;call toDecimal
  37++8C69              	;ld hl,decimalS+3
  38++8C69              	;call TextMode.printZ
  39++8C69 3E 5D        	ld a,']'
  40++8C6B CD A4 60     	call TextMode.putC
  41++8C6E C9           	ret
  42++8C6F
  43++8C6F              toDecimal		;РєРѕРЅРІРµСЂС‚РёСЂСѓРµС‚ 2 Р±Р°Р№С‚Р° РІ 5 РґРµСЃСЏС‚РёС‡РЅС‹С… С†РёС„СЂ
  44++8C6F              				;РЅР° РІС…РѕРґРµ РІ HL С‡РёСЃР»Рѕ
  45++8C6F 11 10 27     	ld de,10000 ;РґРµСЃСЏС‚РєРё С‚С‹СЃСЏС‡
  46++8C72 3E FF        	ld a,255
  47++8C74              toDecimal10k
  48++8C74 A7           	and a
  49++8C75 ED 52        	sbc hl,de
  50++8C77 3C           	inc a
  51++8C78 30 FA        	jr nc,toDecimal10k
  52++8C7A 19           	add hl,de
  53++8C7B C6 30        	add a,48
  54++8C7D 32 C8 8C     	ld (decimalS),a
  55++8C80 11 E8 03     	ld de,1000 ;С‚С‹СЃСЏС‡Рё
  56++8C83 3E FF        	ld a,255
  57++8C85              toDecimal1k
  58++8C85 A7           	and a
  59++8C86 ED 52        	sbc hl,de
  60++8C88 3C           	inc a
  61++8C89 30 FA        	jr nc,toDecimal1k
  62++8C8B 19           	add hl,de
  63++8C8C C6 30        	add a,48
  64++8C8E 32 C9 8C     	ld (decimalS+1),a
  65++8C91 11 64 00     	ld de,100 ;СЃРѕС‚РЅРё
  66++8C94 3E FF        	ld a,255
  67++8C96              toDecimal01k
  68++8C96 A7           	and a
  69++8C97 ED 52        	sbc hl,de
  70++8C99 3C           	inc a
  71++8C9A 30 FA        	jr nc,toDecimal01k
  72++8C9C 19           	add hl,de
  73++8C9D C6 30        	add a,48
  74++8C9F 32 CA 8C     	ld (decimalS+2),a
  75++8CA2 11 0A 00     	ld de,10 ;РґРµСЃСЏС‚РєРё
  76++8CA5 3E FF        	ld a,255
  77++8CA7              toDecimal001k
  78++8CA7 A7           	and a
  79++8CA8 ED 52        	sbc hl,de
  80++8CAA 3C           	inc a
  81++8CAB 30 FA        	jr nc,toDecimal001k
  82++8CAD 19           	add hl,de
  83++8CAE C6 30        	add a,48
  84++8CB0 32 CB 8C     	ld (decimalS+3),a
  85++8CB3 11 01 00     	ld de,1 ;РµРґРёРЅРёС†С‹
  86++8CB6 3E FF        	ld a,255
  87++8CB8              toDecimal0001k
  88++8CB8 A7           	and a
  89++8CB9 ED 52        	sbc hl,de
  90++8CBB 3C           	inc a
  91++8CBC 30 FA        	jr nc,toDecimal0001k
  92++8CBE 19           	add hl,de
  93++8CBF C6 30        	add a,48
  94++8CC1 32 CC 8C     	ld (decimalS+4),a
  95++8CC4 C9           	ret
  96++8CC5              hours
  97++8CC5 00           	db 0
  98++8CC6              minutes
  99++8CC6 00           	db 0
 100++8CC7              seconds
 101++8CC7 00           	db 0
 102++8CC8 00 00 00...  decimalS	ds 7 ;РґРµСЃСЏС‚РёС‡РЅС‹Рµ С†РёС„СЂС‹
 103++8CCF              	ENDIF
 104++8CCF C9           	ret
 105++8CD0              oldminutes		; РЅРµ СѓР±РёСЂР°С‚СЊ РїРѕРґ СѓСЃР»РѕР°РёРµ
 106++8CD0 FF           	db 255
 107++8CD1
 108++8CD1
 109++8CD1
 110++8CD1
# file closed: screen/rtc.asm
  26+ 8CD1
  27+ 8CD1                  IFDEF NEDOOS
  28+ 8CD1 ~                    include "screen/nedoscreen.asm"
  29+ 8CD1 ~                    include "player/vortexnedoos.asm"
  30+ 8CD1 ~                    include "player/mod-processor.asm"
  31+ 8CD1 ~            start:
  32+ 8CD1 ~            outputBuffer:
  33+ 8CD1 ~                    ld sp, 0x4000
  34+ 8CD1 ~                    ld c,nos.CMD_SETSYSDRV
  35+ 8CD1 ~                 	ex af,af'
  36+ 8CD1 ~            	    call nos.BDOS
  37+ 8CD1              	ELSE
  38+ 8CD1                      include "player/vortex-processor.asm"
# file opened: player/vortex-processor.asm
   1++8CD1                  MODULE VortexProcessor
   2++8CD1              	IFDEF MSX
   3++8CD1 ~            play:
   4++8CD1 ~                call Console.peekC
   4++8CD1 ~              and a
   5++8CD1 ~                jr nz, play
   6++8CD1 ~
   7++8CD1 ~                ld hl, message
   7++8CD1 ~              call DialogBox.msgNoWait
   8++8CD1 ~
   9++8CD1 ~                ld hl, outputBuffer
   9++8CD1 ~              call VTPL.INIT
  10++8CD1 ~            .loop
  11++8CD1 ~                halt
  11++8CD1 ~              di
  11++8CD1 ~              call VTPL.PLAY
  11++8CD1 ~              ei
  12++8CD1 ~                call Console.peekC
  12++8CD1 ~              and a
  12++8CD1 ~              jp nz, .stop
  13++8CD1 ~                jr nc, .loop
  14++8CD1 ~            .stop
  15++8CD1 ~                call VTPL.MUTE
  16++8CD1 ~            .wlp
  17++8CD1 ~                call Console.peekC
  17++8CD1 ~              and a
  18++8CD1 ~                jr nz, .wlp
  19++8CD1 ~                ret
  20++8CD1 ~
  21++8CD1 ~            message db "Press key to stop...", 0
  22++8CD1 ~                ENDMODULE
  23++8CD1 ~                include "msxplayer.asm"
  24++8CD1              	ELSE
  25++8CD1              play:
  26++8CD1 3E FF            ld a, 255
  27++8CD3 32 D0 8C         ld (oldminutes), a
  28++8CD6
  29++8CD6 CD 14 6A         call Console.waitForKeyUp
  30++8CD9
  31++8CD9 21 14 8D         ld hl, message
  31++8CDC CD E4 69       call DialogBox.msgNoWait
  32++8CDF
  33++8CDF 21 44 99         ld hl, outputBuffer
  33++8CE2 CD 6A 8D       call VTPL.INIT
  34++8CE5
  35++8CE5
  36++8CE5 3E 01 32 25      ld a, 1, (Render.play_next), a
  36++8CE9 69
  37++8CEA
  38++8CEA                  IFDEF GS
  39++8CEA ~                call GeneralSound.stopModule
  40++8CEA                  ENDIF
  41++8CEA              .loop
  42++8CEA 76               halt
  42++8CEB F3             di
  42++8CEC CD 8D 95       call VTPL.PLAY
  42++8CEF FB             ei
  43++8CF0 AF               xor a
  43++8CF1 DB FE          in a, (#fe)
  43++8CF3 2F             cpl
  43++8CF4 E6 1F          and 31
  43++8CF6 C2 0E 8D       jp nz, .stopKey
  44++8CF9 CD 2B 8C         call printRTC
  45++8CFC 3A 33 8D         ld a, (VTPL.SETUP)
  45++8CFF 17             rla
  45++8D00 30 E8          jr nc, .loop
  46++8D02 3E 01 32 25      ld a, 1, (Render.play_next), a
  46++8D06 69
  47++8D07              .stop
  48++8D07 CD 58 8D         call VTPL.MUTE
  49++8D0A
  50++8D0A                  IFDEF AY
  51++8D0A ~                call restoreAyState
  52++8D0A                  ENDIF
  53++8D0A
  54++8D0A CD 14 6A         call Console.waitForKeyUp
  55++8D0D C9               ret
  56++8D0E              .stopKey
  57++8D0E AF               xor a
  57++8D0F 32 25 69       ld (Render.play_next), a
  58++8D12 18 F3            jr .stop
  59++8D14
  60++8D14                  IFDEF AY
  61++8D14 ~            restoreAyState:
  62++8D14 ~                ld a, #07
  63++8D14 ~                ld bc, #fffd
  64++8D14 ~                out (c), a
  65++8D14 ~                ld a, #fc
  66++8D14 ~                ld b, #bf
  67++8D14 ~                out (c), a ; Enable read mode
  68++8D14 ~
  69++8D14 ~                ld a, #0e
  70++8D14 ~                ld bc, #fffd
  71++8D14 ~                out (c), a
  72++8D14 ~                ret
  73++8D14              	ENDIF
  74++8D14 50 72 65 73  message db "Press key to stop...", 0
  74++8D18 73 20 6B 65
  74++8D1C 79 20 74 6F
  74++8D20 20 73 74 6F
  74++8D24 70 2E 2E 2E
  74++8D28 00
  75++8D29                  ENDMODULE
  76++8D29                  include "player.asm"
# file opened: player/player.asm
   1++8D29              ;Universal PT2'n'PT3 Turbo Sound player for ZX Spectrum
   2++8D29              ;(c)2004-2007 S.V.Bulba <vorobey@mail.khstu.ru>
   3++8D29              ;Specially for AlCo
   4++8D29              ;http://bulba.untergrund.net/ (http://bulba.at.kz/)
   5++8D29              	MODULE VTPL
   6++8D29              ;Release number
   7++8D29              Release EQU "0"
   8++8D29              ;Conditional assembly
   9++8D29              ;1) Current position counters at (Vars1+0) and (Vars2+0)
  10++8D29              CurPosCounter=0
  11++8D29              ;2) Allow channels allocation bits at (START+10)
  12++8D29              ACBBAC=0
  13++8D29              ;3) Allow loop checking and disabling
  14++8D29              LoopChecker=1
  15++8D29              ;4) Insert official identificator
  16++8D29              Id=0
  17++8D29              ;5) Set IY for correct return to ZX Basic
  18++8D29              Basic=1
  19++8D29
  20++8D29              ;Features
  21++8D29              ;--------
  22++8D29              ;-Can be compiled at any address (i.e. no need rounding ORG
  23++8D29              ; address).
  24++8D29              ;-Variables (VARS) can be located at any address (not only after
  25++8D29              ; code block).
  26++8D29              ;-INIT subprogram checks PT3-module version and rightly
  27++8D29              ; generates both note and volume tables outside of code block
  28++8D29              ; (in VARS).
  29++8D29              ;-Two portamento (spc. command 3xxx) algorithms (depending of
  30++8D29              ; PT3 module version).
  31++8D29              ;-New 1.XX and 2.XX special command behaviour (only for PT v3.7
  32++8D29              ; and higher).
  33++8D29              ;-Any Tempo value are accepted (including Tempo=1 and Tempo=2).
  34++8D29              ;-TS modes: 2xPT3, 2xPT2 and PT v3.7 TS standard.
  35++8D29              ;-Fully compatible with Ay_Emul PT3 and PT2 players codes.
  36++8D29              ;-See also notes at the end of this source code.
  37++8D29
  38++8D29              ;Limitations
  39++8D29              ;-----------
  40++8D29              ;-Can run in RAM only (self-modified code is used).
  41++8D29              ;-PT2 position list must be end by #FF marker only.
  42++8D29
  43++8D29              ;Warning!!! PLAY subprogram can crash if no module are loaded
  44++8D29              ;into RAM or INIT subprogram was not called before.
  45++8D29
  46++8D29              ;Call MUTE or INIT one more time to mute sound after stopping
  47++8D29              ;playing
  48++8D29
  49++8D29              ;Test codes (commented)
  50++8D29              ;	LD A,32 ;SinglePT3(TS if TSPT3.7),ABC,Looped
  51++8D29              ;	LD (START+10),A
  52++8D29              ;	LD HL,#8000 ;Mod1
  53++8D29              ;	LD DE,#A000 ;Mod2 (optional)
  54++8D29              ;	CALL START+3
  55++8D29              ;	EI
  56++8D29              ;_LP	HALT
  57++8D29              ;	CALL START+5
  58++8D29              ;	XOR A
  59++8D29              ;	IN A,(#FE)
  60++8D29              ;	CPL
  61++8D29              ;	AND 15
  62++8D29              ;	JR Z,_LP
  63++8D29              ;	JR START+8
  64++8D29
  65++8D29              TonA	EQU 0
  66++8D29              TonB	EQU 2
  67++8D29              TonC	EQU 4
  68++8D29              Noise	EQU 6
  69++8D29              Mixer	EQU 7
  70++8D29              AmplA	EQU 8
  71++8D29              AmplB	EQU 9
  72++8D29              AmplC	EQU 10
  73++8D29              Env	EQU 11
  74++8D29              EnvTp	EQU 13
  75++8D29
  76++8D29              ;Entry and other points
  77++8D29              ;START initialize playing of modules at MDLADDR (single module)
  78++8D29              ;START+3 initialization with module address in HL and DE (TS)
  79++8D29              ;START+5 play one quark
  80++8D29              ;START+8 mute
  81++8D29              ;START+10 setup and status flags
  82++8D29
  83++8D29              START:
  84++8D29 21 44 99     	LD HL,outputBuffer ;DE - address of 2nd module for TS
  85++8D2C 18 3C        	JR INIT
  86++8D2E C3 8D 95     	JP PLAY
  87++8D31 18 25        	JR MUTE
  88++8D33 00           SETUP	DB 0 ;set bit0, if you want to play without looping
  89++8D34              	     ;(optional);
  90++8D34              	     ;set bit1 for PT2 and reset for PT3 before
  91++8D34              	     ;calling INIT;
  92++8D34              	     ;bits2-3: %00-ABC, %01-ACB, %10-BAC (optional);
  93++8D34              	     ;bits4-5: %00-no TS, %01-2 modules TS, %10-
  94++8D34              	     ;autodetect PT3 TS-format by AlCo (PT 3.7+);
  95++8D34              	     ;Remark: old PT3 TS-format by AlCo (PT 3.6) is not
  96++8D34              	     ;documented and must be converted to new standard.
  97++8D34              	     ;bit6 is set each time, when loop point of 2nd TS
  98++8D34              	     ;module is passed (optional).
  99++8D34              	     ;bit7 is set each time, when loop point of 1st TS
 100++8D34              	     ;or of single module is passed (optional).
 101++8D34
 102++8D34              ;Identifier
 103++8D34              	IF Id
 104++8D34 ~            	DB "=UniPT2/PT3/TS-Player r.",Release,"="
 105++8D34              	ENDIF
 106++8D34
 107++8D34              	IF LoopChecker
 108++8D34 21 33 8D     CHECKLP	LD HL,SETUP
 109++8D37 FD CB 9E 46  	BIT 0,(IY-100+VRS.ModNum)
 110++8D3B 28 04        	JR Z,CHL1
 111++8D3D CB F6        	SET 6,(HL)
 112++8D3F 18 02        	JR CHL2
 113++8D41 CB FE        CHL1	SET 7,(HL)
 114++8D43 CB 46        CHL2	BIT 0,(HL)
 115++8D45 C8           	RET Z
 116++8D46 E1           	POP HL
 117++8D47 FD 34 09     	INC (IY-100+VRS.DelyCnt)
 118++8D4A FD 34 BA     	INC (IY-100+VRS.ChanA+CHP.NtSkCn)
 119++8D4D AF           	XOR A
 120++8D4E FD 77 1D     	LD (IY-100+VRS.AYREGS+AmplA),A
 121++8D51 FD 77 1E     	LD (IY-100+VRS.AYREGS+AmplB),A
 122++8D54 FD 77 1F     	LD (IY-100+VRS.AYREGS+AmplC),A
 123++8D57 C9           	RET
 124++8D58              	ENDIF
 125++8D58
 126++8D58 AF           MUTE: XOR A
 127++8D59 67           	LD H,A
 128++8D5A 6F           	LD L,A
 129++8D5B 32 E2 96     	LD (VARS1+VRS.AYREGS+AmplA),A
 130++8D5E 22 E3 96     	LD (VARS1+VRS.AYREGS+AmplB),HL
 131++8D61 32 69 97     	LD (VARS2+VRS.AYREGS+AmplA),A
 132++8D64 22 6A 97     	LD (VARS2+VRS.AYREGS+AmplB),HL
 133++8D67 C3 A5 95     	JP ROUT
 134++8D6A
 135++8D6A              INIT:
 136++8D6A              ;HL - AddressOfModule
 137++8D6A              ;DE - AddresOf2ndModule
 138++8D6A D5           	PUSH DE
 139++8D6B E5           	PUSH HL
 140++8D6C 21 60 96     	LD HL,VARS
 141++8D6F 36 00        	LD (HL),0
 142++8D71 11 61 96     	LD DE,VARS+1
 143++8D74 01 0E 01     	LD BC,VAR0END-VARS-1
 144++8D77 ED B0        	LDIR
 145++8D79 23           	INC HL
 146++8D7A 22 C3 96     	LD (VARS1+VRS.AdInPtA),HL ;ptr to zero
 147++8D7D 22 4A 97     	LD (VARS2+VRS.AdInPtA),HL
 148++8D80
 149++8D80 E1           	POP HL
 150++8D81 FD 21 C5 96  	LD IY,VARS1+100
 151++8D85 3A 33 8D     	LD A,(START+10)
 152++8D88 E6 02        	AND 2
 153++8D8A C2 13 8E     	JP NZ,I_PT2
 154++8D8D
 155++8D8D CD 60 8F     	CALL INITPT3
 156++8D90 21 18 1F     	LD HL,(e_-SamCnv-2)*256+#18
 157++8D93 22 33 93     	LD (SamCnv),HL
 158++8D96 3E BA        	LD A,#BA
 159++8D98 32 FE 92     	LD (OrnCP),A
 160++8D9B 32 2A 93     	LD (SamCP),A
 161++8D9E 3E 7B        	LD A,#7B
 162++8DA0 32 01 93     	LD (OrnLD),A
 163++8DA3 32 2D 93     	LD (SamLD),A
 164++8DA6 3E 87        	LD A,#87
 165++8DA8 32 24 93     	LD (SamClc2),A
 166++8DAB E1           	POP HL
 167++8DAC              	;Use version and ton table of 1st module
 168++8DAC DD 7E A9     	LD A,(IX+13-100) ;EXTRACT VERSION NUMBER
 169++8DAF D6 30        	SUB #30
 170++8DB1 38 04        	JR C,L20
 171++8DB3 FE 0A        	CP 10
 172++8DB5 38 02        	JR C,L21
 173++8DB7 3E 06        L20	LD A,6
 174++8DB9 32 D1 91     L21	LD (Version),A
 175++8DBC F5           	PUSH AF ;VolTable version
 176++8DBD FE 04        	CP 4
 177++8DBF DD 7E FF     	LD A,(IX+99-100) ;TONE TABLE NUMBER
 178++8DC2 17           	RLA
 179++8DC3 E6 07        	AND 7
 180++8DC5 F5           	PUSH AF ;NoteTable number
 181++8DC6
 182++8DC6 FD 21 4C 97  	LD IY,VARS2+100
 183++8DCA 3A 33 8D     	LD A,(START+10)
 184++8DCD E6 30        	AND 48
 185++8DCF 28 37        	JR Z,NOTS
 186++8DD1 FE 10        	CP 16
 187++8DD3 28 27        	JR Z,TwoPT3s
 188++8DD5 3A D1 91     	LD A,(Version)
 189++8DD8 FE 07        	CP 7
 190++8DDA 38 2C        	JR C,NOTS
 191++8DDC DD 7E FE     	LD A,(IX+98-100) ;ALCO TS MARKER
 192++8DDF FE 20        	CP #20
 193++8DE1 28 25        	JR Z,NOTS
 194++8DE3 21 61 96     	LD HL,VARS1
 195++8DE6 11 E8 96     	LD DE,VARS2
 196++8DE9 01 87 00     	LD BC,VRS
 197++8DEC ED B0        	LDIR
 198++8DEE FD CB 9E CE  	SET 1,(IY-100+VRS.ModNum)
 199++8DF2 4F           	LD C,A
 200++8DF3 87           	ADD A,A
 201++8DF4 81           	ADD A,C
 202++8DF5 D6 02        	SUB 2
 203++8DF7 32 98 94     	LD (TSSub),A
 204++8DFA 18 03        	JR AlCoTS_
 205++8DFC CD 60 8F     TwoPT3s	CALL INITPT3
 206++8DFF 3E 01        AlCoTS_	LD A,1
 207++8E01 32 60 96     	LD (is_ts),A
 208++8E04 FD CB 9E C6  	SET 0,(IY-100+VRS.ModNum)
 209++8E08
 210++8E08 01 1D 91     NOTS	LD BC,PT3PD
 211++8E0B 21 00 00     	LD HL,0
 212++8E0E 11 28 96     	LD DE,PT3EMPTYORN
 213++8E11 18 48        	JR INITCOMMON
 214++8E13
 215++8E13 CD 98 8F     I_PT2	CALL INITPT2
 216++8E16 21 CB 51     	LD HL,#51CB
 217++8E19 22 33 93     	LD (SamCnv),HL
 218++8E1C 3E BB        	LD A,#BB
 219++8E1E 32 FE 92     	LD (OrnCP),A
 220++8E21 32 2A 93     	LD (SamCP),A
 221++8E24 3E 7A        	LD A,#7A
 222++8E26 32 01 93     	LD (OrnLD),A
 223++8E29 32 2D 93     	LD (SamLD),A
 224++8E2C 3E 80        	LD A,#80
 225++8E2E 32 24 93     	LD (SamClc2),A
 226++8E31 E1           	POP HL
 227++8E32 3E 05        	LD A,5
 228++8E34 32 D1 91     	LD (Version),A
 229++8E37 F5           	PUSH AF
 230++8E38 3E 02        	LD A,2
 231++8E3A F5           	PUSH AF
 232++8E3B
 233++8E3B 3A 33 8D     	LD A,(START+10)
 234++8E3E E6 30        	AND 48
 235++8E40 28 10        	JR Z,NOTS2
 236++8E42
 237++8E42 FD 21 4C 97  	LD IY,VARS2+100
 238++8E46 3E 01        	LD A,1
 239++8E48 32 60 96     	LD (is_ts),A
 240++8E4B FD CB 9E C6  	SET 0,(IY-100+VRS.ModNum)
 241++8E4F CD 98 8F     	CALL INITPT2
 242++8E52
 243++8E52 01 57 90     NOTS2	LD BC,PT2PD
 244++8E55 21 87 86     	LD HL,#8687
 245++8E58 11 7E 97     	LD DE,PT2EMPTYORN
 246++8E5B
 247++8E5B              INITCOMMON
 248++8E5B
 249++8E5B              	IF Basic
 250++8E5B FD 21 3A 5C  	LD IY,#5C3A
 251++8E5F              	ENDIF
 252++8E5F
 253++8E5F ED 43 08 90  	LD (PTDEC),BC
 254++8E63 22 9A 94     	LD (PsCalc),HL
 255++8E66 D5           	PUSH DE
 256++8E67
 257++8E67              ;note table data depacker
 258++8E67              ;(c) Ivan Roshin
 259++8E67 11 2B 96     	LD DE,T_PACK
 260++8E6A 01 D0 97     	LD BC,T1_+(2*49)-1
 261++8E6D 1A           TP_0	LD A,(DE)
 262++8E6E 13           	INC DE
 263++8E6F FE 1E        	CP 15*2
 264++8E71 30 06        	JR NC,TP_1
 265++8E73 67           	LD H,A
 266++8E74 1A           	LD A,(DE)
 267++8E75 6F           	LD L,A
 268++8E76 13           	INC DE
 269++8E77 18 07        	JR TP_2
 270++8E79 D5           TP_1	PUSH DE
 271++8E7A 16 00        	LD D,0
 272++8E7C 5F           	LD E,A
 273++8E7D 19           	ADD HL,DE
 274++8E7E 19           	ADD HL,DE
 275++8E7F D1           	POP DE
 276++8E80 7C           TP_2	LD A,H
 277++8E81 02           	LD (BC),A
 278++8E82 0B           	DEC BC
 279++8E83 7D           	LD A,L
 280++8E84 02           	LD (BC),A
 281++8E85 0B           	DEC BC
player.asm(282): warning: value 0x1F0 is truncated to 8bit value: 0xF0
 282++8E86 D6 F0        	SUB #F8*2
 283++8E88 20 E3        	JR NZ,TP_0
 284++8E8A
 285++8E8A 3C           	INC A
 286++8E8B 32 CE 96     	LD (VARS1+VRS.DelyCnt),A
 287++8E8E 32 55 97     	LD (VARS2+VRS.DelyCnt),A
 288++8E91 21 01 F0     	LD HL,#F001 ;H - CHP.Volume, L - CHP.NtSkCn
 289++8E94 22 7F 96     	LD (VARS1+VRS.ChanA+CHP.NtSkCn),HL
 290++8E97 22 9C 96     	LD (VARS1+VRS.ChanB+CHP.NtSkCn),HL
 291++8E9A 22 B9 96     	LD (VARS1+VRS.ChanC+CHP.NtSkCn),HL
 292++8E9D 22 06 97     	LD (VARS2+VRS.ChanA+CHP.NtSkCn),HL
 293++8EA0 22 23 97     	LD (VARS2+VRS.ChanB+CHP.NtSkCn),HL
 294++8EA3 22 40 97     	LD (VARS2+VRS.ChanC+CHP.NtSkCn),HL
 295++8EA6 E1           	POP HL
 296++8EA7 22 71 96     	LD (VARS1+VRS.ChanA+CHP.OrnPtr),HL
 297++8EAA 22 8E 96     	LD (VARS1+VRS.ChanB+CHP.OrnPtr),HL
 298++8EAD 22 AB 96     	LD (VARS1+VRS.ChanC+CHP.OrnPtr),HL
 299++8EB0 22 F8 96     	LD (VARS2+VRS.ChanA+CHP.OrnPtr),HL
 300++8EB3 22 15 97     	LD (VARS2+VRS.ChanB+CHP.OrnPtr),HL
 301++8EB6 22 32 97     	LD (VARS2+VRS.ChanC+CHP.OrnPtr),HL
 302++8EB9
 303++8EB9 F1           	POP AF
 304++8EBA
 305++8EBA              ;NoteTableCreator (c) Ivan Roshin
 306++8EBA              ;A - NoteTableNumber*2+VersionForNoteTable
 307++8EBA              ;(xx1b - 3.xx..3.4r, xx0b - 3.4x..3.6x..VTII1.0)
 308++8EBA
 309++8EBA 21 D8 95     	LD HL,NT_DATA
 310++8EBD 16 00        	LD D,0
 311++8EBF 87           	ADD A,A
 312++8EC0 5F           	LD E,A
 313++8EC1 19           	ADD HL,DE
 314++8EC2 5E           	LD E,(HL)
 315++8EC3 23           	INC HL
 316++8EC4 CB 3B        	SRL E
 317++8EC6 9F           	SBC A,A
 318++8EC7 E6 A7        	AND #A7 ;#00 (NOP) or #A7 (AND A)
 319++8EC9 32 F1 8E     	LD (L3),A
 320++8ECC EB           	EX DE,HL
 321++8ECD 01 6F 97     	LD BC,T1_
 322++8ED0 09           	ADD HL,BC
 323++8ED1
 324++8ED1 1A           	LD A,(DE)
player.asm(325): warning: value 0x95E8 is truncated to 8bit value: 0xE8
 325++8ED2 C6 E8        	ADD A,T_
 326++8ED4 4F           	LD C,A
 327++8ED5 CE 95        	ADC A,T_/256
 328++8ED7 91           	SUB C
 329++8ED8 47           	LD B,A
 330++8ED9 C5           	PUSH BC
 331++8EDA 11 5F 98     	LD DE,NT_
 332++8EDD D5           	PUSH DE
 333++8EDE
 334++8EDE 06 0C        	LD B,12
 335++8EE0 C5           L1	PUSH BC
 336++8EE1 4E           	LD C,(HL)
 337++8EE2 23           	INC HL
 338++8EE3 E5           	PUSH HL
 339++8EE4 46           	LD B,(HL)
 340++8EE5
 341++8EE5 D5           	PUSH DE
 342++8EE6 EB           	EX DE,HL
 343++8EE7 11 17 00     	LD DE,23
 344++8EEA DD 26 08     	LD IXH,8
 345++8EED
 346++8EED CB 38        L2	SRL B
 347++8EEF CB 19        	RR C
 348++8EF1 19           L3	DB #19	;AND A or NOP
 349++8EF2 79           	LD A,C
 350++8EF3 8A           	ADC A,D	;=ADC 0
 351++8EF4 77           	LD (HL),A
 352++8EF5 23           	INC HL
 353++8EF6 78           	LD A,B
 354++8EF7 8A           	ADC A,D
 355++8EF8 77           	LD (HL),A
 356++8EF9 19           	ADD HL,DE
 357++8EFA DD 25        	DEC IXH
 358++8EFC 20 EF        	JR NZ,L2
 359++8EFE
 360++8EFE D1           	POP DE
 361++8EFF 13           	INC DE
 362++8F00 13           	INC DE
 363++8F01 E1           	POP HL
 364++8F02 23           	INC HL
 365++8F03 C1           	POP BC
 366++8F04 10 DA        	DJNZ L1
 367++8F06
 368++8F06 E1           	POP HL
 369++8F07 D1           	POP DE
 370++8F08
 371++8F08 7B           	LD A,E
player.asm(372): warning: value 0x95F4 is truncated to 8bit value: 0xF4
 372++8F09 FE F4        	CP TCOLD_1
 373++8F0B 20 05        	JR NZ,CORR_1
 374++8F0D 3E FD        	LD A,#FD
 375++8F0F 32 8D 98     	LD (NT_+#2E),A
 376++8F12
 377++8F12 1A           CORR_1	LD A,(DE)
 378++8F13 A7           	AND A
 379++8F14 28 11        	JR Z,TC_EXIT
 380++8F16 1F           	RRA
 381++8F17 F5           	PUSH AF
 382++8F18 87           	ADD A,A
 383++8F19 4F           	LD C,A
 384++8F1A 09           	ADD HL,BC
 385++8F1B F1           	POP AF
 386++8F1C 30 02        	JR NC,CORR_2
 387++8F1E 35           	DEC (HL)
 388++8F1F 35           	DEC (HL)
 389++8F20 34           CORR_2	INC (HL)
 390++8F21 A7           	AND A
 391++8F22 ED 42        	SBC HL,BC
 392++8F24 13           	INC DE
 393++8F25 18 EB        	JR CORR_1
 394++8F27
 395++8F27              TC_EXIT
 396++8F27
 397++8F27 F1           	POP AF
 398++8F28
 399++8F28              ;VolTableCreator (c) Ivan Roshin
 400++8F28              ;A - VersionForVolumeTable (0..4 - 3.xx..3.4x;
 401++8F28              			   ;5.. - 2.x,3.5x..3.6x..VTII1.0)
 402++8F28
 403++8F28 FE 05        	CP 5
 404++8F2A 21 11 00     	LD HL,#11
 405++8F2D 54           	LD D,H
 406++8F2E 5C           	LD E,H
 407++8F2F 3E 17        	LD A,#17
 408++8F31 30 03        	JR NC,M1
 409++8F33 2D           	DEC L
 410++8F34 5D           	LD E,L
 411++8F35 AF           	XOR A
 412++8F36 32 47 8F     M1      LD (M2),A
 413++8F39
 414++8F39 DD 21 6F 97  	LD IX,VT_+16
 415++8F3D
 416++8F3D 0E 0F        	LD C,#F
 417++8F3F E5           INITV2  PUSH HL
 418++8F40
 419++8F40 19           	ADD HL,DE
 420++8F41 EB           	EX DE,HL
 421++8F42 ED 62        	SBC HL,HL
 422++8F44
 423++8F44 06 10        	LD B,#10
 424++8F46 7D           INITV1  LD A,L
 425++8F47 7D           M2      DB #7D
 426++8F48 7C           	LD A,H
 427++8F49 CE 00        	ADC A,0
 428++8F4B DD 77 00     	LD (IX),A
 429++8F4E DD 23        	INC IX
 430++8F50 19           	ADD HL,DE
 431++8F51 10 F3        	DJNZ INITV1
 432++8F53
 433++8F53 E1           	POP HL
 434++8F54 7B           	LD A,E
 435++8F55 FE 77        	CP #77
 436++8F57 20 01        	JR NZ,M3
 437++8F59 1C           	INC E
 438++8F5A 0D           M3      DEC C
 439++8F5B 20 E2        	JR NZ,INITV2
 440++8F5D
 441++8F5D C3 A5 95     	JP ROUT
 442++8F60
 443++8F60 CD D3 8F     INITPT3	CALL SETMDAD
 444++8F63 E5           	PUSH HL
 445++8F64 11 64 00     	LD DE,100
 446++8F67 19           	ADD HL,DE
 447++8F68 7E           	LD A,(HL)
 448++8F69 FD 77 08     	LD (IY-100+VRS.Delay),A
 449++8F6C E5           	PUSH HL
 450++8F6D DD E1        	POP IX
 451++8F6F 19           	ADD HL,DE
 452++8F70 CD E1 8F     	CALL SETCPPT
 453++8F73 DD 5E 02     	LD E,(IX+102-100)
 454++8F76 23           	INC HL
 455++8F77
 456++8F77              	IF CurPosCounter
 457++8F77 ~            	LD (IY-100+VRS.PosSub),L
 458++8F77              	ENDIF
 459++8F77
 460++8F77 19           	ADD HL,DE
 461++8F78 CD E8 8F     	CALL SETLPPT
 462++8F7B D1           	POP DE
 463++8F7C DD 6E 03     	LD L,(IX+103-100)
 464++8F7F DD 66 04     	LD H,(IX+104-100)
 465++8F82 19           	ADD HL,DE
 466++8F83 CD CC 8F     	CALL SETPTPT
 467++8F86 21 A9 00     	LD HL,169
 468++8F89 19           	ADD HL,DE
 469++8F8A CD DA 8F     	CALL SETORPT
 470++8F8D 21 69 00     	LD HL,105
 471++8F90 19           	ADD HL,DE
 472++8F91
 473++8F91 FD 75 FA     SETSMPT LD (IY-100+VRS.SamPtrs),L
 474++8F94 FD 74 FB     	LD (IY-100+VRS.SamPtrs+1),H
 475++8F97 C9           	RET
 476++8F98
 477++8F98 7E           INITPT2	LD A,(HL)
 478++8F99 FD 77 08     	LD (IY-100+VRS.Delay),A
 479++8F9C E5           	PUSH HL
 480++8F9D E5           	PUSH HL
 481++8F9E E5           	PUSH HL
 482++8F9F 23           	INC HL
 483++8FA0 23           	INC HL
 484++8FA1 7E           	LD A,(HL)
 485++8FA2 23           	INC HL
 486++8FA3 CD 91 8F     	CALL SETSMPT
 487++8FA6 5E           	LD E,(HL)
 488++8FA7 23           	INC HL
 489++8FA8 56           	LD D,(HL)
 490++8FA9 E1           	POP HL
 491++8FAA A7           	AND A
 492++8FAB ED 52        	SBC HL,DE
 493++8FAD CD D3 8F     	CALL SETMDAD
 494++8FB0 E1           	POP HL
 495++8FB1 11 43 00     	LD DE,67
 496++8FB4 19           	ADD HL,DE
 497++8FB5 CD DA 8F     	CALL SETORPT
 498++8FB8 1E 20        	LD E,32
 499++8FBA 19           	ADD HL,DE
 500++8FBB 4E           	LD C,(HL)
 501++8FBC 23           	INC HL
 502++8FBD 46           	LD B,(HL)
 503++8FBE 1E 1E        	LD E,30
 504++8FC0 19           	ADD HL,DE
 505++8FC1 CD E1 8F     	CALL SETCPPT
 506++8FC4 5F           	LD E,A
 507++8FC5 23           	INC HL
 508++8FC6
 509++8FC6              	IF CurPosCounter
 510++8FC6 ~            	LD (IY-100+VRS.PosSub),L
 511++8FC6              	ENDIF
 512++8FC6
 513++8FC6 19           	ADD HL,DE
 514++8FC7 CD E8 8F     	CALL SETLPPT
 515++8FCA E1           	POP HL
 516++8FCB 09           	ADD HL,BC
 517++8FCC
 518++8FCC FD 75 FC     SETPTPT	LD (IY-100+VRS.PatsPtr),L
 519++8FCF FD 74 FD     	LD (IY-100+VRS.PatsPtr+1),H
 520++8FD2 C9           	RET
 521++8FD3
 522++8FD3 FD 75 F6     SETMDAD	LD (IY-100+VRS.MODADDR),L
 523++8FD6 FD 74 F7     	LD (IY-100+VRS.MODADDR+1),H
 524++8FD9 C9           	RET
 525++8FDA
 526++8FDA FD 75 F8     SETORPT	LD (IY-100+VRS.OrnPtrs),L
 527++8FDD FD 74 F9     	LD (IY-100+VRS.OrnPtrs+1),H
 528++8FE0 C9           	RET
 529++8FE1
 530++8FE1 FD 75 04     SETCPPT	LD (IY-100+VRS.CrPsPtr),L
 531++8FE4 FD 74 05     	LD (IY-100+VRS.CrPsPtr+1),H
 532++8FE7 C9           	RET
 533++8FE8
 534++8FE8 FD 75 06     SETLPPT	LD (IY-100+VRS.LPosPtr),L
 535++8FEB FD 74 07     	LD (IY-100+VRS.LPosPtr+1),H
 536++8FEE C9           	RET
 537++8FEF
 538++8FEF FD 75 13     SETENBS	LD (IY-100+VRS.EnvBase),L
 539++8FF2 FD 74 14     	LD (IY-100+VRS.EnvBase+1),H
 540++8FF5 C9           	RET
 541++8FF6
 542++8FF6 FD 75 0C     SETESLD	LD (IY-100+VRS.CurESld),L
 543++8FF9 FD 74 0D     	LD (IY-100+VRS.CurESld+1),H
 544++8FFC C9           	RET
 545++8FFD
 546++8FFD FD E5        GETIX	PUSH IY
 547++8FFF DD E1        	POP IX
 548++9001 DD 19        	ADD IX,DE
 549++9003 C9           	RET
 550++9004
 551++9004 CD FD 8F     PTDECOD CALL GETIX
 552++9007              PTDEC	EQU $+1
 553++9007 C3 C3 C3     	JP #C3C3
 554++900A
 555++900A              ;PT2 pattern decoder
 556++900A CD A0 92     PD2_SAM	CALL SETSAM
 557++900D 18 4A        	JR PD2_LOOP
 558++900F
 559++900F DD 77 08     PD2_EOff LD (IX-12+CHP.Env_En),A
 560++9012 18 45        	JR PD2_LOOP
 561++9014
 562++9014 DD 36 08 10  PD2_ENV	LD (IX-12+CHP.Env_En),16
 563++9018 FD 77 22     	LD (IY-100+VRS.AYREGS+EnvTp),A
 564++901B 0A           	LD A,(BC)
 565++901C 03           	INC BC
 566++901D 6F           	LD L,A
 567++901E 0A           	LD A,(BC)
 568++901F 03           	INC BC
 569++9020 67           	LD H,A
 570++9021 CD EF 8F     	CALL SETENBS
 571++9024 18 33        	JR PD2_LOOP
 572++9026
 573++9026 CD 81 92     PD2_ORN	CALL SETORN
 574++9029 18 2E        	JR PD2_LOOP
 575++902B
 576++902B 3C           PD2_SKIP INC A
 577++902C DD 77 05     	LD (IX-12+CHP.NNtSkp),A
 578++902F 18 28        	JR PD2_LOOP
 579++9031
 580++9031 0F           PD2_VOL	RRCA
 581++9032 0F           	RRCA
 582++9033 0F           	RRCA
 583++9034 0F           	RRCA
 584++9035 DD 77 10     	LD (IX-12+CHP.Volume),A
 585++9038 18 1F        	JR PD2_LOOP
 586++903A
 587++903A CD 51 92     PD2_DEL	CALL C_DELAY
 588++903D 18 1A        	JR PD2_LOOP
 589++903F
 590++903F DD CB 09 D6  PD2_GLIS SET 2,(IX-12+CHP.Flags)
 591++9043 3C           	INC A
 592++9044 DD 77 0A     	LD (IX-12+CHP.TnSlDl),A
 593++9047 DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 594++904A 0A           	LD A,(BC)
 595++904B 03           	INC BC
 596++904C DD 77 0B             LD (IX-12+CHP.TSlStp),A
 597++904F 87           	ADD A,A
 598++9050 9F           	SBC A,A
 599++9051 DD 77 0C             LD (IX-12+CHP.TSlStp+1),A
 600++9054 37           	SCF
 601++9055 18 01        	JR PD2_LP2
 602++9057
 603++9057 A7           PT2PD	AND A
 604++9058
 605++9058 08           PD2_LP2	EX AF,AF'
 606++9059
 607++9059 0A           PD2_LOOP LD A,(BC)
 608++905A 03           	INC BC
 609++905B C6 20        	ADD A,#20
 610++905D 28 3F        	JR Z,PD2_REL
 611++905F 38 A9        	JR C,PD2_SAM
 612++9061 C6 60        	ADD A,96
 613++9063 38 3E        	JR C,PD2_NOTE
 614++9065 3C           	INC A
 615++9066 28 A7        	JR Z,PD2_EOff
 616++9068 C6 0F        	ADD A,15
 617++906A CA 80 91     	JP Z,PD_FIN
 618++906D 38 A5        	JR C,PD2_ENV
 619++906F C6 10        	ADD A,#10
 620++9071 38 B3        	JR C,PD2_ORN
 621++9073 C6 40        	ADD A,#40
 622++9075 38 B4        	JR C,PD2_SKIP
 623++9077 C6 10        	ADD A,#10
 624++9079 38 B6        	JR C,PD2_VOL
 625++907B 3C           	INC A
 626++907C 28 BC        	JR Z,PD2_DEL
 627++907E 3C           	INC A
 628++907F 28 BE        	JR Z,PD2_GLIS
 629++9081 3C           	INC A
 630++9082 28 0A        	JR Z,PD2_PORT
 631++9084 3C           	INC A
 632++9085 28 12        	JR Z,PD2_STOP
 633++9087 0A           	LD A,(BC)
 634++9088 03           	INC BC
 635++9089 DD 77 F7     	LD (IX-12+CHP.CrNsSl),A
 636++908C 18 CB        	JR PD2_LOOP
 637++908E
 638++908E DD CB 09 96  PD2_PORT RES 2,(IX-12+CHP.Flags)
 639++9092 0A           	LD A,(BC)
 640++9093 03           	INC BC
 641++9094 03           	INC BC ;ignoring precalc delta to right sound
 642++9095 03           	INC BC
 643++9096 37           	SCF
 644++9097 18 BF        	JR PD2_LP2
 645++9099
 646++9099 DD 77 F9     PD2_STOP LD (IX-12+CHP.TSlCnt),A
 647++909C 18 BB        	JR PD2_LOOP
 648++909E
 649++909E DD 77 09     PD2_REL	LD (IX-12+CHP.Flags),A
 650++90A1 18 2C        	JR PD2_EXIT
 651++90A3
 652++90A3 6F           PD2_NOTE LD L,A
 653++90A4 DD 7E 06     	LD A,(IX-12+CHP.Note)
 654++90A7 32 BA 91     	LD (PrNote+1),A
 655++90AA DD 75 06     	LD (IX-12+CHP.Note),L
 656++90AD AF           	XOR A
 657++90AE DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 658++90B1 DD CB 09 C6  	SET 0,(IX-12+CHP.Flags)
 659++90B5 08           	EX AF,AF'
 660++90B6 30 16        	JR NC,NOGLIS2
 661++90B8 DD CB 09 56  	BIT 2,(IX-12+CHP.Flags)
 662++90BC 20 0C        	JR NZ,NOPORT2
 663++90BE 32 E0 91     	LD (LoStep),A
 664++90C1 87           	ADD A,A
 665++90C2 9F           	SBC A,A
 666++90C3 08           	EX AF,AF'
 667++90C4 67           	LD H,A
 668++90C5 6F           	LD L,A
 669++90C6 3C           	INC A
 670++90C7 CD 9B 91     	CALL SETPORT
 671++90CA DD 36 F9 01  NOPORT2	LD (IX-12+CHP.TSlCnt),1
 672++90CE AF           NOGLIS2	XOR A
 673++90CF
 674++90CF
 675++90CF DD 77 F5     PD2_EXIT LD (IX-12+CHP.PsInSm),A
 676++90D2 DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 677++90D5 DD 77 FA     	LD (IX-12+CHP.CrTnSl),A
 678++90D8 DD 77 FB     	LD (IX-12+CHP.CrTnSl+1),A
 679++90DB C3 80 91     	JP PD_FIN
 680++90DE
 681++90DE              ;PT3 pattern decoder
 682++90DE DD 36 08 00  PD_OrSm	LD (IX-12+CHP.Env_En),0
 683++90E2 CD 81 92     	CALL SETORN
 684++90E5 0A           PD_SAM_	LD A,(BC)
 685++90E6 03           	INC BC
 686++90E7 0F           	RRCA
 687++90E8
 688++90E8 CD A0 92     PD_SAM	CALL SETSAM
 689++90EB 18 3F        	JR PD_LOOP
 690++90ED
 691++90ED 0F           PD_VOL	RRCA
 692++90EE 0F           	RRCA
 693++90EF 0F           	RRCA
 694++90F0 0F           	RRCA
 695++90F1 DD 77 10     	LD (IX-12+CHP.Volume),A
 696++90F4 18 39        	JR PD_LP2
 697++90F6
 698++90F6 DD 77 08     PD_EOff	LD (IX-12+CHP.Env_En),A
 699++90F9 DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 700++90FC 18 31        	JR PD_LP2
 701++90FE
 702++90FE 3D           PD_SorE	DEC A
 703++90FF 20 07        	JR NZ,PD_ENV
 704++9101 0A           	LD A,(BC)
 705++9102 03           	INC BC
 706++9103 DD 77 05     	LD (IX-12+CHP.NNtSkp),A
 707++9106 18 27        	JR PD_LP2
 708++9108
 709++9108 CD 66 92     PD_ENV	CALL SETENV
 710++910B 18 22        	JR PD_LP2
 711++910D
 712++910D CD 81 92     PD_ORN	CALL SETORN
 713++9110 18 1A        	JR PD_LOOP
 714++9112
 715++9112 DD 77 08     PD_ESAM	LD (IX-12+CHP.Env_En),A
 716++9115 DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 717++9118 C4 66 92     	CALL NZ,SETENV
 718++911B 18 C8        	JR PD_SAM_
 719++911D
 720++911D DD 7E 06     PT3PD	LD A,(IX-12+CHP.Note)
 721++9120 32 BA 91     	LD (PrNote+1),A
 722++9123 DD 6E FA     	LD L,(IX-12+CHP.CrTnSl)
 723++9126 DD 66 FB     	LD H,(IX-12+CHP.CrTnSl+1)
 724++9129 22 D7 91     	LD (PrSlide+1),HL
 725++912C
 726++912C 11 10 20     PD_LOOP	LD DE,#2010
 727++912F 0A           PD_LP2	LD A,(BC)
 728++9130 03           	INC BC
 729++9131 83           	ADD A,E
 730++9132 38 AA        	JR C,PD_OrSm
 731++9134 82           	ADD A,D
 732++9135 28 49        	JR Z,PD_FIN
 733++9137 38 AF        	JR C,PD_SAM
 734++9139 83           	ADD A,E
 735++913A 28 25        	JR Z,PD_REL
 736++913C 38 AF        	JR C,PD_VOL
 737++913E 83           	ADD A,E
 738++913F 28 B5        	JR Z,PD_EOff
 739++9141 38 BB        	JR C,PD_SorE
 740++9143 C6 60        	ADD A,96
 741++9145 38 20        	JR C,PD_NOTE
 742++9147 83           	ADD A,E
 743++9148 38 C3        	JR C,PD_ORN
 744++914A 82           	ADD A,D
 745++914B 38 0F        	JR C,PD_NOIS
 746++914D 83           	ADD A,E
 747++914E 38 C2        	JR C,PD_ESAM
 748++9150 87           	ADD A,A
 749++9151 5F           	LD E,A
player.asm(750): warning: value 0x171DC is truncated to 16bit value: 0x71DC
 750++9152 21 DC 71     	LD HL,SPCCOMS+#FF20-#2000
 751++9155 19           	ADD HL,DE
 752++9156 5E           	LD E,(HL)
 753++9157 23           	INC HL
 754++9158 56           	LD D,(HL)
 755++9159 D5           	PUSH DE
 756++915A 18 D0        	JR PD_LOOP
 757++915C
 758++915C FD 77 10     PD_NOIS	LD (IY-100+VRS.Ns_Base),A
 759++915F 18 CE        	JR PD_LP2
 760++9161
 761++9161 DD CB 09 86  PD_REL	RES 0,(IX-12+CHP.Flags)
 762++9165 18 08        	JR PD_RES
 763++9167
 764++9167 DD 77 06     PD_NOTE	LD (IX-12+CHP.Note),A
 765++916A DD CB 09 C6  	SET 0,(IX-12+CHP.Flags)
 766++916E AF           	XOR A
 767++916F
 768++916F ED 73 7E 91  PD_RES	LD (PDSP_+1),SP
 769++9173 DD F9        	LD SP,IX
 770++9175 67           	LD H,A
 771++9176 6F           	LD L,A
 772++9177 E5           	PUSH HL
 773++9178 E5           	PUSH HL
 774++9179 E5           	PUSH HL
 775++917A E5           	PUSH HL
 776++917B E5           	PUSH HL
 777++917C E5           	PUSH HL
 778++917D 31 31 31     PDSP_	LD SP,#3131
 779++9180
 780++9180 DD 7E 05     PD_FIN	LD A,(IX-12+CHP.NNtSkp)
 781++9183 DD 77 0F     	LD (IX-12+CHP.NtSkCn),A
 782++9186 C9           	RET
 783++9187
 784++9187 0A           C_PORTM LD A,(BC)
 785++9188 03           	INC BC
 786++9189              ;SKIP PRECALCULATED TONE DELTA (BECAUSE
 787++9189              ;CANNOT BE RIGHT AFTER PT3 COMPILATION)
 788++9189 03           	INC BC
 789++918A 03           	INC BC
 790++918B 08           	EX AF,AF'
 791++918C 0A           	LD A,(BC) ;SIGNED TONE STEP
 792++918D 03           	INC BC
 793++918E 32 E0 91     	LD (LoStep),A
 794++9191 0A           	LD A,(BC)
 795++9192 03           	INC BC
 796++9193 A7           	AND A
 797++9194 08           	EX AF,AF'
 798++9195 DD 6E FA     	LD L,(IX-12+CHP.CrTnSl)
 799++9198 DD 66 FB     	LD H,(IX-12+CHP.CrTnSl+1)
 800++919B
 801++919B              ;Set portamento variables
 802++919B              ;A - Delay; A' - Hi(Step); ZF' - (A'=0); HL - CrTnSl
 803++919B
 804++919B DD CB 09 96  SETPORT	RES 2,(IX-12+CHP.Flags)
 805++919F DD 77 0A     	LD (IX-12+CHP.TnSlDl),A
 806++91A2 DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 807++91A5 E5           	PUSH HL
 808++91A6 11 5F 98     	LD DE,NT_
 809++91A9 DD 7E 06     	LD A,(IX-12+CHP.Note)
 810++91AC DD 77 07     	LD (IX-12+CHP.SlToNt),A
 811++91AF 87           	ADD A,A
 812++91B0 6F           	LD L,A
 813++91B1 26 00        	LD H,0
 814++91B3 19           	ADD HL,DE
 815++91B4 7E           	LD A,(HL)
 816++91B5 23           	INC HL
 817++91B6 66           	LD H,(HL)
 818++91B7 6F           	LD L,A
 819++91B8 E5           	PUSH HL
 820++91B9 3E 3E        PrNote	LD A,#3E
 821++91BB DD 77 06     	LD (IX-12+CHP.Note),A
 822++91BE 87           	ADD A,A
 823++91BF 6F           	LD L,A
 824++91C0 26 00        	LD H,0
 825++91C2 19           	ADD HL,DE
 826++91C3 5E           	LD E,(HL)
 827++91C4 23           	INC HL
 828++91C5 56           	LD D,(HL)
 829++91C6 E1           	POP HL
 830++91C7 ED 52        	SBC HL,DE
 831++91C9 DD 75 0D     	LD (IX-12+CHP.TnDelt),L
 832++91CC DD 74 0E     	LD (IX-12+CHP.TnDelt+1),H
 833++91CF D1           	POP DE
 834++91D0              Version EQU $+1
 835++91D0 3E 3E        	LD A,#3E
 836++91D2 FE 06        	CP 6
 837++91D4 38 09        	JR C,OLDPRTM ;Old 3xxx for PT v3.5-
 838++91D6 11 11 11     PrSlide	LD DE,#1111
 839++91D9 DD 73 FA     	LD (IX-12+CHP.CrTnSl),E
 840++91DC DD 72 FB     	LD (IX-12+CHP.CrTnSl+1),D
 841++91DF              LoStep	EQU $+1
 842++91DF 3E 3E        OLDPRTM	LD A,#3E
 843++91E1 08           	EX AF,AF'
 844++91E2 28 01        	JR Z,NOSIG
 845++91E4 EB           	EX DE,HL
 846++91E5 ED 52        NOSIG	SBC HL,DE
 847++91E7 F2 EF 91     	JP P,SET_STP
 848++91EA 2F           	CPL
 849++91EB 08           	EX AF,AF'
 850++91EC ED 44        	NEG
 851++91EE 08           	EX AF,AF'
 852++91EF DD 77 0C     SET_STP	LD (IX-12+CHP.TSlStp+1),A
 853++91F2 08           	EX AF,AF'
 854++91F3 DD 77 0B     	LD (IX-12+CHP.TSlStp),A
 855++91F6 DD 36 FE 00  	LD (IX-12+CHP.COnOff),0
 856++91FA C9           	RET
 857++91FB
 858++91FB DD CB 09 D6  C_GLISS	SET 2,(IX-12+CHP.Flags)
 859++91FF 0A           	LD A,(BC)
 860++9200 03           	INC BC
 861++9201 DD 77 0A     	LD (IX-12+CHP.TnSlDl),A
 862++9204 A7           	AND A
 863++9205 20 07        	JR NZ,GL36
 864++9207 3A D1 91     	LD A,(Version) ;AlCo PT3.7+
 865++920A FE 07        	CP 7
 866++920C 9F           	SBC A,A
 867++920D 3C           	INC A
 868++920E DD 77 F9     GL36	LD (IX-12+CHP.TSlCnt),A
 869++9211 0A           	LD A,(BC)
 870++9212 03           	INC BC
 871++9213 08           	EX AF,AF'
 872++9214 0A           	LD A,(BC)
 873++9215 03           	INC BC
 874++9216 18 D7        	JR SET_STP
 875++9218
 876++9218 0A           C_SMPOS	LD A,(BC)
 877++9219 03           	INC BC
 878++921A DD 77 F5     	LD (IX-12+CHP.PsInSm),A
 879++921D C9           	RET
 880++921E
 881++921E 0A           C_ORPOS	LD A,(BC)
 882++921F 03           	INC BC
 883++9220 DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 884++9223 C9           	RET
 885++9224
 886++9224 0A           C_VIBRT	LD A,(BC)
 887++9225 03           	INC BC
 888++9226 DD 77 FF     	LD (IX-12+CHP.OnOffD),A
 889++9229 DD 77 FE     	LD (IX-12+CHP.COnOff),A
 890++922C 0A           	LD A,(BC)
 891++922D 03           	INC BC
 892++922E DD 77 00     	LD (IX-12+CHP.OffOnD),A
 893++9231 AF           	XOR A
 894++9232 DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 895++9235 DD 77 FA     	LD (IX-12+CHP.CrTnSl),A
 896++9238 DD 77 FB     	LD (IX-12+CHP.CrTnSl+1),A
 897++923B C9           	RET
 898++923C
 899++923C 0A           C_ENGLS	LD A,(BC)
 900++923D 03           	INC BC
 901++923E FD 77 0E     	LD (IY-100+VRS.Env_Del),A
 902++9241 FD 77 0F     	LD (IY-100+VRS.CurEDel),A
 903++9244 0A           	LD A,(BC)
 904++9245 03           	INC BC
 905++9246 6F           	LD L,A
 906++9247 0A           	LD A,(BC)
 907++9248 03           	INC BC
 908++9249 67           	LD H,A
 909++924A FD 75 0A     	LD (IY-100+VRS.ESldAdd),L
 910++924D FD 74 0B     	LD (IY-100+VRS.ESldAdd+1),H
 911++9250 C9           	RET
 912++9251
 913++9251 0A           C_DELAY	LD A,(BC)
 914++9252 03           	INC BC
 915++9253 FD 77 08     	LD (IY-100+VRS.Delay),A
 916++9256 21 EA 96     	LD HL,VARS2+VRS.ModNum ;if AlCo_TS
 917++9259 CB 4E        	BIT 1,(HL)
 918++925B C8           	RET Z
 919++925C 32 CD 96     	LD (VARS1+VRS.Delay),A
 920++925F 32 CE 96     	LD (VARS1+VRS.DelyCnt),A
 921++9262 32 54 97     	LD (VARS2+VRS.Delay),A
 922++9265 C9           	RET
 923++9266
 924++9266 DD 73 08     SETENV	LD (IX-12+CHP.Env_En),E
 925++9269 FD 77 22     	LD (IY-100+VRS.AYREGS+EnvTp),A
 926++926C 0A           	LD A,(BC)
 927++926D 03           	INC BC
 928++926E 67           	LD H,A
 929++926F 0A           	LD A,(BC)
 930++9270 03           	INC BC
 931++9271 6F           	LD L,A
 932++9272 CD EF 8F     	CALL SETENBS
 933++9275 AF           	XOR A
 934++9276 DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 935++9279 FD 77 0F     	LD (IY-100+VRS.CurEDel),A
 936++927C 67           	LD H,A
 937++927D 6F           	LD L,A
 938++927E C3 F6 8F     	JP SETESLD
 939++9281
 940++9281 87           SETORN	ADD A,A
 941++9282 5F           	LD E,A
 942++9283 16 00        	LD D,0
 943++9285 DD 72 F4     	LD (IX-12+CHP.PsInOr),D
 944++9288 FD 6E F8     	LD L,(IY-100+VRS.OrnPtrs)
 945++928B FD 66 F9     	LD H,(IY-100+VRS.OrnPtrs+1)
 946++928E 19           	ADD HL,DE
 947++928F 5E           	LD E,(HL)
 948++9290 23           	INC HL
 949++9291 56           	LD D,(HL)
 950++9292 FD 6E F6     	LD L,(IY-100+VRS.MODADDR)
 951++9295 FD 66 F7     	LD H,(IY-100+VRS.MODADDR+1)
 952++9298 19           	ADD HL,DE
 953++9299 DD 75 01     	LD (IX-12+CHP.OrnPtr),L
 954++929C DD 74 02     	LD (IX-12+CHP.OrnPtr+1),H
 955++929F C9           C_NOP	RET
 956++92A0
 957++92A0 87           SETSAM	ADD A,A
 958++92A1 5F           	LD E,A
 959++92A2 16 00        	LD D,0
 960++92A4 FD 6E FA     	LD L,(IY-100+VRS.SamPtrs);
 961++92A7 FD 66 FB     	LD H,(IY-100+VRS.SamPtrs+1);
 962++92AA 19           	ADD HL,DE
 963++92AB 5E           	LD E,(HL)
 964++92AC 23           	INC HL
 965++92AD 56           	LD D,(HL)
 966++92AE FD 6E F6     	LD L,(IY-100+VRS.MODADDR)
 967++92B1 FD 66 F7     	LD H,(IY-100+VRS.MODADDR+1)
 968++92B4 19           	ADD HL,DE
 969++92B5 DD 75 03     	LD (IX-12+CHP.SamPtr),L
 970++92B8 DD 74 04     	LD (IX-12+CHP.SamPtr+1),H
 971++92BB C9           	RET
 972++92BC
 973++92BC              ;ALL 16 ADDRESSES TO PROTECT FROM BROKEN PT3 MODULES
 974++92BC 9F 92        SPCCOMS DW C_NOP
 975++92BE FB 91        	DW C_GLISS
 976++92C0 87 91        	DW C_PORTM
 977++92C2 18 92        	DW C_SMPOS
 978++92C4 1E 92        	DW C_ORPOS
 979++92C6 24 92        	DW C_VIBRT
 980++92C8 9F 92        	DW C_NOP
 981++92CA 9F 92        	DW C_NOP
 982++92CC 3C 92        	DW C_ENGLS
 983++92CE 51 92        	DW C_DELAY
 984++92D0 9F 92        	DW C_NOP
 985++92D2 9F 92        	DW C_NOP
 986++92D4 9F 92        	DW C_NOP
 987++92D6 9F 92        	DW C_NOP
 988++92D8 9F 92        	DW C_NOP
 989++92DA 9F 92        	DW C_NOP
 990++92DC
 991++92DC CD FD 8F     CHREGS	CALL GETIX
 992++92DF AF           	XOR A
 993++92E0 32 1C 95     	LD (Ampl),A
 994++92E3 DD CB 15 46  	BIT 0,(IX+CHP.Flags)
 995++92E7 E5           	PUSH HL
 996++92E8 CA 2F 94     	JP Z,CH_EXIT
 997++92EB ED 73 79 93  	LD (CSP_+1),SP
 998++92EF DD 6E 0D     	LD L,(IX+CHP.OrnPtr)
 999++92F2 DD 66 0E     	LD H,(IX+CHP.OrnPtr+1)
1000++92F5 F9           	LD SP,HL
1001++92F6 D1           	POP DE
1002++92F7 67           	LD H,A
1003++92F8 DD 7E 00     	LD A,(IX+CHP.PsInOr)
1004++92FB 6F           	LD L,A
1005++92FC 39           	ADD HL,SP
1006++92FD 3C           	INC A
1007++92FE              		;PT2	PT3
1008++92FE 3C           OrnCP	INC A	;CP E	CP D
1009++92FF 38 01        	JR C,CH_ORPS
1010++9301 01           OrnLD	DB 1	;LD A,D	LD A,E
1011++9302 DD 77 00     CH_ORPS	LD (IX+CHP.PsInOr),A
1012++9305 DD 7E 12     	LD A,(IX+CHP.Note)
1013++9308 86           	ADD A,(HL)
1014++9309 F2 0D 93     	JP P,CH_NTP
1015++930C AF           	XOR A
1016++930D FE 60        CH_NTP	CP 96
1017++930F 38 02        	JR C,CH_NOK
1018++9311 3E 5F        	LD A,95
1019++9313 87           CH_NOK	ADD A,A
1020++9314 08           	EX AF,AF'
1021++9315 DD 6E 0F     	LD L,(IX+CHP.SamPtr)
1022++9318 DD 66 10     	LD H,(IX+CHP.SamPtr+1)
1023++931B F9           	LD SP,HL
1024++931C D1           	POP DE
1025++931D 26 00        	LD H,0
1026++931F DD 7E 01     	LD A,(IX+CHP.PsInSm)
1027++9322 47           	LD B,A
1028++9323 87           	ADD A,A
1029++9324 87           SamClc2	ADD A,A ;or ADD A,B for PT2
1030++9325 6F           	LD L,A
1031++9326 39           	ADD HL,SP
1032++9327 F9           	LD SP,HL
1033++9328 78           	LD A,B
1034++9329 3C           	INC A
1035++932A              		;PT2	PT3
1036++932A 3C           SamCP	INC A	;CP E	CP D
1037++932B 38 01        	JR C,CH_SMPS
1038++932D 01           SamLD	DB 1	;LD A,D	LD A,E
1039++932E DD 77 01     CH_SMPS	LD (IX+CHP.PsInSm),A
1040++9331 C1           	POP BC
1041++9332 E1           	POP HL
1042++9333
1043++9333              ;Convert PT2 sample to PT3
1044++9333              		;PT2		PT3
1045++9333 E1           SamCnv	POP HL  ;BIT 2,C	JR e_
1046++9334 E1           	POP HL
1047++9335 60           	LD H,B
1048++9336 20 06        	JR NZ,$+8
1049++9338 EB           	EX DE,HL
1050++9339 A7           	AND A
1051++933A ED 62        	SBC HL,HL
1052++933C ED 52        	SBC HL,DE
1053++933E 51           	LD D,C
1054++933F CB 19        	RR C
1055++9341 9F           	SBC A,A
1056++9342 2F           	CPL
1057++9343 E6 3E        	AND #3E
1058++9345 CB 19        	RR C
1059++9347 CB 18        	RR B
1060++9349 A1           	AND C
1061++934A 4F           	LD C,A
1062++934B 78           	LD A,B
1063++934C 1F           	RRA
1064++934D 1F           	RRA
1065++934E CB 1A        	RR D
1066++9350 1F           	RRA
1067++9351 E6 9F        	AND #9F
1068++9353 47           	LD B,A
1069++9354
1070++9354 DD 5E 08     e_	LD E,(IX+CHP.TnAcc)
1071++9357 DD 56 09     	LD D,(IX+CHP.TnAcc+1)
1072++935A 19           	ADD HL,DE
1073++935B CB 70        	BIT 6,B
1074++935D 28 06        	JR Z,CH_NOAC
1075++935F DD 75 08     	LD (IX+CHP.TnAcc),L
1076++9362 DD 74 09     	LD (IX+CHP.TnAcc+1),H
1077++9365 EB           CH_NOAC EX DE,HL
1078++9366 08           	EX AF,AF'
player.asm(1079): warning: value 0x985F is truncated to 8bit value: 0x5F
1079++9367 C6 5F        	ADD A,NT_
1080++9369 6F           	LD L,A
1081++936A CE 98        	ADC A,NT_/256
1082++936C 95           	SUB L
1083++936D 67           	LD H,A
1084++936E F9           	LD SP,HL
1085++936F E1           	POP HL
1086++9370 19           	ADD HL,DE
1087++9371 DD 5E 06     	LD E,(IX+CHP.CrTnSl)
1088++9374 DD 56 07     	LD D,(IX+CHP.CrTnSl+1)
1089++9377 19           	ADD HL,DE
1090++9378 31 31 31     CSP_	LD SP,#3131
1091++937B E3           	EX (SP),HL
1092++937C AF           	XOR A
1093++937D DD B6 05     	OR (IX+CHP.TSlCnt)
1094++9380 28 3E        	JR Z,CH_AMP
1095++9382 DD 35 05     	DEC (IX+CHP.TSlCnt)
1096++9385 20 39        	JR NZ,CH_AMP
1097++9387 DD 7E 16     	LD A,(IX+CHP.TnSlDl)
1098++938A DD 77 05     	LD (IX+CHP.TSlCnt),A
1099++938D DD 6E 17     	LD L,(IX+CHP.TSlStp)
1100++9390 DD 66 18     	LD H,(IX+CHP.TSlStp+1)
1101++9393 7C           	LD A,H
1102++9394 19           	ADD HL,DE
1103++9395 DD 75 06     	LD (IX+CHP.CrTnSl),L
1104++9398 DD 74 07     	LD (IX+CHP.CrTnSl+1),H
1105++939B DD CB 15 56  	BIT 2,(IX+CHP.Flags)
1106++939F 20 1F        	JR NZ,CH_AMP
1107++93A1 DD 5E 19     	LD E,(IX+CHP.TnDelt)
1108++93A4 DD 56 1A     	LD D,(IX+CHP.TnDelt+1)
1109++93A7 A7           	AND A
1110++93A8 28 01        	JR Z,CH_STPP
1111++93AA EB           	EX DE,HL
1112++93AB ED 52        CH_STPP SBC HL,DE
1113++93AD FA C0 93     	JP M,CH_AMP
1114++93B0 DD 7E 13     	LD A,(IX+CHP.SlToNt)
1115++93B3 DD 77 12     	LD (IX+CHP.Note),A
1116++93B6 AF           	XOR A
1117++93B7 DD 77 05     	LD (IX+CHP.TSlCnt),A
1118++93BA DD 77 06     	LD (IX+CHP.CrTnSl),A
1119++93BD DD 77 07     	LD (IX+CHP.CrTnSl+1),A
1120++93C0 DD 7E 02     CH_AMP	LD A,(IX+CHP.CrAmSl)
1121++93C3 CB 79        	BIT 7,C
1122++93C5 28 13        	JR Z,CH_NOAM
1123++93C7 CB 71        	BIT 6,C
1124++93C9 28 07        	JR Z,CH_AMIN
1125++93CB FE 0F        	CP 15
1126++93CD 28 0B        	JR Z,CH_NOAM
1127++93CF 3C           	INC A
1128++93D0 18 05        	JR CH_SVAM
1129++93D2 FE F1        CH_AMIN	CP -15
1130++93D4 28 04        	JR Z,CH_NOAM
1131++93D6 3D           	DEC A
1132++93D7 DD 77 02     CH_SVAM	LD (IX+CHP.CrAmSl),A
1133++93DA 6F           CH_NOAM	LD L,A
1134++93DB 78           	LD A,B
1135++93DC E6 0F        	AND 15
1136++93DE 85           	ADD A,L
1137++93DF F2 E3 93     	JP P,CH_APOS
1138++93E2 AF           	XOR A
1139++93E3 FE 10        CH_APOS	CP 16
1140++93E5 38 02        	JR C,CH_VOL
1141++93E7 3E 0F        	LD A,15
1142++93E9 DD B6 1C     CH_VOL	OR (IX+CHP.Volume)
player.asm(1143): warning: value 0x975F is truncated to 8bit value: 0x5F
1143++93EC C6 5F        	ADD A,VT_
1144++93EE 6F           	LD L,A
1145++93EF CE 97        	ADC A,VT_/256
1146++93F1 95           	SUB L
1147++93F2 67           	LD H,A
1148++93F3 7E           	LD A,(HL)
1149++93F4 CB 41        CH_ENV	BIT 0,C
1150++93F6 20 03        	JR NZ,CH_NOEN
1151++93F8 DD B6 14     	OR (IX+CHP.Env_En)
1152++93FB 32 1C 95     CH_NOEN	LD (Ampl),A
1153++93FE CB 78        	BIT 7,B
1154++9400 79           	LD A,C
1155++9401 28 1A        	JR Z,NO_ENSL
1156++9403 17           	RLA
1157++9404 17           	RLA
1158++9405 CB 2F        	SRA A
1159++9407 CB 2F        	SRA A
1160++9409 CB 2F        	SRA A
1161++940B DD 86 04     	ADD A,(IX+CHP.CrEnSl) ;SEE COMMENT BELOW
1162++940E CB 68        	BIT 5,B
1163++9410 28 03        	JR Z,NO_ENAC
1164++9412 DD 77 04     	LD (IX+CHP.CrEnSl),A
1165++9415 FD 86 12     NO_ENAC	ADD A,(IY-100+VRS.AddToEn) ;BUG IN PT3 - NEED WORD HERE
1166++9418 FD 77 12     	LD (IY-100+VRS.AddToEn),A
1167++941B 18 0E        	JR CH_MIX
1168++941D 1F           NO_ENSL RRA
1169++941E DD 86 03     	ADD A,(IX+CHP.CrNsSl)
1170++9421 FD 77 11     	LD (IY-100+VRS.AddToNs),A
1171++9424 CB 68        	BIT 5,B
1172++9426 28 03        	JR Z,CH_MIX
1173++9428 DD 77 03     	LD (IX+CHP.CrNsSl),A
1174++942B 78           CH_MIX	LD A,B
1175++942C 1F           	RRA
1176++942D E6 48        	AND #48
1177++942F FD B6 1C     CH_EXIT	OR (IY-100+VRS.AYREGS+Mixer)
1178++9432 0F           	RRCA
1179++9433 FD 77 1C     	LD (IY-100+VRS.AYREGS+Mixer),A
1180++9436 E1           	POP HL
1181++9437 AF           	XOR A
1182++9438 DD B6 0A     	OR (IX+CHP.COnOff)
1183++943B C8           	RET Z
1184++943C DD 35 0A     	DEC (IX+CHP.COnOff)
1185++943F C0           	RET NZ
1186++9440 DD AE 15     	XOR (IX+CHP.Flags)
1187++9443 DD 77 15     	LD (IX+CHP.Flags),A
1188++9446 1F           	RRA
1189++9447 DD 7E 0B     	LD A,(IX+CHP.OnOffD)
1190++944A 38 03        	JR C,CH_ONDL
1191++944C DD 7E 0C     	LD A,(IX+CHP.OffOnD)
1192++944F DD 77 0A     CH_ONDL	LD (IX+CHP.COnOff),A
1193++9452 C9           	RET
1194++9453
1195++9453 AF           PLAY_	XOR A
1196++9454 FD 77 12     	LD (IY-100+VRS.AddToEn),A
1197++9457 FD 77 1C     	LD (IY-100+VRS.AYREGS+Mixer),A
1198++945A 3D           	DEC A
1199++945B FD 77 22     	LD (IY-100+VRS.AYREGS+EnvTp),A
1200++945E FD 35 09     	DEC (IY-100+VRS.DelyCnt)
1201++9461 C2 09 95     	JP NZ,PL2
1202++9464 FD 35 BA     	DEC (IY-100+VRS.ChanA+CHP.NtSkCn)
1203++9467 20 6C        	JR NZ,PL1B
1204++9469 FD 4E FE     	LD C,(IY-100+VRS.AdInPtA)
1205++946C FD 46 FF     	LD B,(IY-100+VRS.AdInPtA+1)
1206++946F 0A           	LD A,(BC)
1207++9470 A7           	AND A
1208++9471 20 56        	JR NZ,PL1A
1209++9473 57           	LD D,A
1210++9474 FD 77 10     	LD (IY-100+VRS.Ns_Base),A
1211++9477 FD 6E 04     	LD L,(IY-100+VRS.CrPsPtr)
1212++947A FD 66 05     	LD H,(IY-100+VRS.CrPsPtr+1)
1213++947D 23           	INC HL
1214++947E 7E           	LD A,(HL)
1215++947F 3C           	INC A
1216++9480 20 0B        	JR NZ,PLNLP
1217++9482
1218++9482              	IF LoopChecker
1219++9482 CD 34 8D     	CALL CHECKLP
1220++9485              	ENDIF
1221++9485
1222++9485 FD 6E 06     	LD L,(IY-100+VRS.LPosPtr)
1223++9488 FD 66 07     	LD H,(IY-100+VRS.LPosPtr+1)
1224++948B 7E           	LD A,(HL)
1225++948C 3C           	INC A
1226++948D CD E1 8F     PLNLP	CALL SETCPPT
1227++9490 3D           	DEC A
1228++9491 FD CB 9E 4E  	BIT 1,(IY-100+VRS.ModNum)
1229++9495 28 03        	JR Z,NoAlCo
1230++9497              TSSub	EQU $+1
1231++9497 D6 D6        	SUB #D6
1232++9499 2F           	CPL
1233++949A              NoAlCo
1234++949A              		;PT2		PT3
1235++949A 3D           PsCalc	DEC A	;ADD A,A	NOP
1236++949B 3D           	DEC A	;ADD A,(HL)	NOP
1237++949C 87           	ADD A,A
1238++949D 5F           	LD E,A
1239++949E CB 12        	RL D
1240++94A0
1241++94A0              	IF CurPosCounter
1242++94A0 ~            	LD A,L
1243++94A0 ~            	SUB (IY-100+VRS.PosSub)
1244++94A0 ~            	LD (IY-100+VRS.CurPos),A
1245++94A0              	ENDIF
1246++94A0
1247++94A0 FD 6E FC     	LD L,(IY-100+VRS.PatsPtr)
1248++94A3 FD 66 FD     	LD H,(IY-100+VRS.PatsPtr+1)
1249++94A6 19           	ADD HL,DE
1250++94A7 FD 5E F6     	LD E,(IY-100+VRS.MODADDR)
1251++94AA FD 56 F7     	LD D,(IY-100+VRS.MODADDR+1)
1252++94AD ED 73 C7 94  	LD (PSP_+1),SP
1253++94B1 F9           	LD SP,HL
1254++94B2 E1           	POP HL
1255++94B3 19           	ADD HL,DE
1256++94B4 44           	LD B,H
1257++94B5 4D           	LD C,L
1258++94B6 E1           	POP HL
1259++94B7 19           	ADD HL,DE
1260++94B8 FD 75 00     	LD (IY-100+VRS.AdInPtB),L
1261++94BB FD 74 01     	LD (IY-100+VRS.AdInPtB+1),H
1262++94BE E1           	POP HL
1263++94BF 19           	ADD HL,DE
1264++94C0 FD 75 02     	LD (IY-100+VRS.AdInPtC),L
1265++94C3 FD 74 03     	LD (IY-100+VRS.AdInPtC+1),H
1266++94C6 31 31 31     PSP_	LD SP,#3131
1267++94C9 11 AB FF     PL1A	LD DE,VRS.ChanA+12-100
1268++94CC CD 04 90     	CALL PTDECOD
1269++94CF FD 71 FE     	LD (IY-100+VRS.AdInPtA),C
1270++94D2 FD 70 FF     	LD (IY-100+VRS.AdInPtA+1),B
1271++94D5
1272++94D5 FD 35 D7     PL1B	DEC (IY-100+VRS.ChanB+CHP.NtSkCn)
1273++94D8 20 12        	JR NZ,PL1C
1274++94DA 11 C8 FF     	LD DE,VRS.ChanB+12-100
1275++94DD FD 4E 00     	LD C,(IY-100+VRS.AdInPtB)
1276++94E0 FD 46 01     	LD B,(IY-100+VRS.AdInPtB+1)
1277++94E3 CD 04 90     	CALL PTDECOD
1278++94E6 FD 71 00     	LD (IY-100+VRS.AdInPtB),C
1279++94E9 FD 70 01     	LD (IY-100+VRS.AdInPtB+1),B
1280++94EC
1281++94EC FD 35 F4     PL1C	DEC (IY-100+VRS.ChanC+CHP.NtSkCn)
1282++94EF 20 12        	JR NZ,PL1D
1283++94F1 11 E5 FF     	LD DE,VRS.ChanC+12-100
1284++94F4 FD 4E 02     	LD C,(IY-100+VRS.AdInPtC)
1285++94F7 FD 46 03     	LD B,(IY-100+VRS.AdInPtC+1)
1286++94FA CD 04 90     	CALL PTDECOD
1287++94FD FD 71 02     	LD (IY-100+VRS.AdInPtC),C
1288++9500 FD 70 03     	LD (IY-100+VRS.AdInPtC+1),B
1289++9503
1290++9503 FD 7E 08     PL1D	LD A,(IY-100+VRS.Delay)
1291++9506 FD 77 09     	LD (IY-100+VRS.DelyCnt),A
1292++9509
1293++9509 11 9F FF     PL2	LD DE,VRS.ChanA-100
1294++950C FD 6E 15     	LD L,(IY-100+VRS.AYREGS+TonA)
1295++950F FD 66 16     	LD H,(IY-100+VRS.AYREGS+TonA+1)
1296++9512 CD DC 92     	CALL CHREGS
1297++9515 FD 75 15     	LD (IY-100+VRS.AYREGS+TonA),L
1298++9518 FD 74 16     	LD (IY-100+VRS.AYREGS+TonA+1),H
1299++951B              Ampl	EQU $+1
1300++951B 3E 3E        	LD A,#3E
1301++951D FD 77 1D     	LD (IY-100+VRS.AYREGS+AmplA),A
1302++9520 11 BC FF     	LD DE,VRS.ChanB-100
1303++9523 FD 6E 17     	LD L,(IY-100+VRS.AYREGS+TonB)
1304++9526 FD 66 18     	LD H,(IY-100+VRS.AYREGS+TonB+1)
1305++9529 CD DC 92     	CALL CHREGS
1306++952C FD 75 17     	LD (IY-100+VRS.AYREGS+TonB),L
1307++952F FD 74 18     	LD (IY-100+VRS.AYREGS+TonB+1),H
1308++9532 3A 1C 95     	LD A,(Ampl)
1309++9535 FD 77 1E     	LD (IY-100+VRS.AYREGS+AmplB),A
1310++9538 11 D9 FF     	LD DE,VRS.ChanC-100
1311++953B FD 6E 19     	LD L,(IY-100+VRS.AYREGS+TonC)
1312++953E FD 66 1A     	LD H,(IY-100+VRS.AYREGS+TonC+1)
1313++9541 CD DC 92     	CALL CHREGS
1314++9544 FD 75 19     	LD (IY-100+VRS.AYREGS+TonC),L
1315++9547 FD 74 1A     	LD (IY-100+VRS.AYREGS+TonC+1),H
1316++954A 3A 1C 95     	LD A,(Ampl)
1317++954D FD 77 1F     	LD (IY-100+VRS.AYREGS+AmplC),A
1318++9550
1319++9550 FD 7E 10     	LD A,(IY-100+VRS.Ns_Base)
1320++9553 FD 86 11     	ADD (IY-100+VRS.AddToNs)
1321++9556 FD 77 1B     	LD (IY-100+VRS.AYREGS+Noise),A
1322++9559
1323++9559 FD 7E 12     	LD A,(IY-100+VRS.AddToEn)
1324++955C 5F           	LD E,A
1325++955D 87           	ADD A,A
1326++955E 9F           	SBC A,A
1327++955F 57           	LD D,A
1328++9560 FD 6E 13     	LD L,(IY-100+VRS.EnvBase)
1329++9563 FD 66 14     	LD H,(IY-100+VRS.EnvBase+1)
1330++9566 19           	ADD HL,DE
1331++9567 FD 5E 0C     	LD E,(IY-100+VRS.CurESld)
1332++956A FD 56 0D     	LD D,(IY-100+VRS.CurESld+1)
1333++956D 19           	ADD HL,DE
1334++956E FD 75 20     	LD (IY-100+VRS.AYREGS+Env),L
1335++9571 FD 74 21     	LD (IY-100+VRS.AYREGS+Env+1),H
1336++9574
1337++9574 AF           	XOR A
1338++9575 FD B6 0F     	OR (IY-100+VRS.CurEDel)
1339++9578 C8           	RET Z
1340++9579 FD 35 0F     	DEC (IY-100+VRS.CurEDel)
1341++957C C0           	RET NZ
1342++957D FD 7E 0E     	LD A,(IY-100+VRS.Env_Del)
1343++9580 FD 77 0F     	LD (IY-100+VRS.CurEDel),A
1344++9583 FD 6E 0A     	LD L,(IY-100+VRS.ESldAdd)
1345++9586 FD 66 0B     	LD H,(IY-100+VRS.ESldAdd+1)
1346++9589 19           	ADD HL,DE
1347++958A C3 F6 8F     	JP SETESLD
1348++958D
1349++958D FD 21 C5 96  PLAY    LD IY,VARS1+100
1350++9591 CD 53 94     	CALL PLAY_
1351++9594 3A 60 96     	LD A,(is_ts)
1352++9597 A7           	AND A
1353++9598 28 07        	JR Z,PL_nts
1354++959A FD 21 4C 97  	LD IY,VARS2+100
1355++959E CD 53 94     	CALL PLAY_
1356++95A1              PL_nts
1357++95A1              	IF Basic
1358++95A1 FD 21 3A 5C  	LD IY,#5C3A
1359++95A5              	ENDIF
1360++95A5
1361++95A5 01 FD FF     ROUT	LD BC,#FFFD
1362++95A8 3A 60 96     	LD A,(is_ts)
1363++95AB A7           	AND A
1364++95AC 28 02        	JR Z,r_nts ;keep old standard
1365++95AE ED 41        	OUT (C),B
1366++95B0 08           r_nts	EX AF,AF'
1367++95B1
1368++95B1              	IF ACBBAC
1369++95B1 ~            	LD IX,VARS1+VRS.AYREGS
1370++95B1              	ELSE
1371++95B1 21 DA 96     	LD HL,VARS1+VRS.AYREGS
1372++95B4              	ENDIF
1373++95B4
1374++95B4 CD C0 95     	CALL ROUT_
1375++95B7 08           	EX AF,AF'
1376++95B8 C8           	RET Z
1377++95B9 42           	LD B,D
1378++95BA 2F           	CPL
1379++95BB ED 79        	OUT (C),A
1380++95BD
1381++95BD              	IF ACBBAC
1382++95BD ~            	LD IX,VARS2+VRS.AYREGS
1383++95BD              	ELSE
1384++95BD 21 61 97     	LD HL,VARS2+VRS.AYREGS
1385++95C0              	ENDIF
1386++95C0
1387++95C0              ROUT_
1388++95C0              	IF ACBBAC
1389++95C0 ~            	LD A,(SETUP)
1390++95C0 ~            	AND 12
1391++95C0 ~            	JR Z,ABC
1392++95C0 ~            	ADD A,CHTABLE
1393++95C0 ~            	LD E,A
1394++95C0 ~            	ADC A,CHTABLE/256
1395++95C0 ~            	SUB E
1396++95C0 ~            	LD D,A
1397++95C0 ~            	LD B,0
1398++95C0 ~            	PUSH IX
1399++95C0 ~            	POP HL
1400++95C0 ~            	LD A,(DE)
1401++95C0 ~            	INC DE
1402++95C0 ~            	LD C,A
1403++95C0 ~            	ADD HL,BC
1404++95C0 ~            	LD A,(IX+TonB)
1405++95C0 ~            	LD C,(HL)
1406++95C0 ~            	LD (IX+TonB),C
1407++95C0 ~            	LD (HL),A
1408++95C0 ~            	INC HL
1409++95C0 ~            	LD A,(IX+TonB+1)
1410++95C0 ~            	LD C,(HL)
1411++95C0 ~            	LD (IX+TonB+1),C
1412++95C0 ~            	LD (HL),A
1413++95C0 ~            	LD A,(DE)
1414++95C0 ~            	INC DE
1415++95C0 ~            	LD C,A
1416++95C0 ~            	ADD HL,BC
1417++95C0 ~            	LD A,(IX+AmplB)
1418++95C0 ~            	LD C,(HL)
1419++95C0 ~            	LD (IX+AmplB),C
1420++95C0 ~            	LD (HL),A
1421++95C0 ~            	LD A,(DE)
1422++95C0 ~            	INC DE
1423++95C0 ~            	LD (RxCA1),A
1424++95C0 ~            	XOR 8
1425++95C0 ~            	LD (RxCA2),A
1426++95C0 ~            	LD A,(DE)
1427++95C0 ~            	AND (IX+Mixer)
1428++95C0 ~            	LD E,A
1429++95C0 ~            	LD A,(IX+Mixer)
1430++95C0 ~            RxCA1	DB #E6
1431++95C0 ~            	AND %010010
1432++95C0 ~            	OR E
1433++95C0 ~            	LD E,A
1434++95C0 ~            	LD A,(IX+Mixer)
1435++95C0 ~            	AND %010010
1436++95C0 ~            RxCA2	OR E
1437++95C0 ~            	OR E
1438++95C0 ~            	LD (IX+Mixer),A
1439++95C0 ~            ABC
1440++95C0              	ENDIF
1441++95C0
1442++95C0 AF           	XOR A
1443++95C1 11 BF FF     	LD DE,#FFBF
1444++95C4
1445++95C4              	IF ACBBAC
1446++95C4 ~            	LD BC,#FFFD
1447++95C4 ~            	PUSH IX
1448++95C4 ~            	POP HL
1449++95C4              	ENDIF
1450++95C4
1451++95C4 ED 79        LOUT	OUT (C),A
1452++95C6 43           	LD B,E
1453++95C7 ED A3        	OUTI
1454++95C9 42           	LD B,D
1455++95CA 3C           	INC A
1456++95CB FE 0D        	CP 13
1457++95CD 20 F5        	JR NZ,LOUT
1458++95CF ED 79        	OUT (C),A
1459++95D1 7E           	LD A,(HL)
1460++95D2 A7           	AND A
1461++95D3 F8           	RET M
1462++95D4 43           	LD B,E
1463++95D5 ED 79        	OUT (C),A
1464++95D7 C9           	RET
1465++95D8
1466++95D8              	IF ACBBAC
1467++95D8 ~            CHTABLE	EQU $-4
1468++95D8 ~            	DB 4,5,15,%001001,0,7,7,%100100
1469++95D8              	ENDIF
1470++95D8
1471++95D8 64           NT_DATA	DB (T_NEW_0-T1_)*2
1472++95D9 2A           	DB TCNEW_0-T_
1473++95DA 65           	DB (T_OLD_0-T1_)*2+1
1474++95DB 00           	DB TCOLD_0-T_
1475++95DC 01           	DB (T_NEW_1-T1_)*2+1
1476++95DD 0C           	DB TCNEW_1-T_
1477++95DE 01           	DB (T_OLD_1-T1_)*2+1
1478++95DF 0C           	DB TCOLD_1-T_
1479++95E0 94           	DB (T_NEW_2-T1_)*2
1480++95E1 35           	DB TCNEW_2-T_
1481++95E2 30           	DB (T_OLD_2-T1_)*2
1482++95E3 0E           	DB TCOLD_2-T_
1483++95E4 60           	DB (T_NEW_3-T1_)*2
1484++95E5 20           	DB TCNEW_3-T_
1485++95E6 60           	DB (T_OLD_3-T1_)*2
1486++95E7 21           	DB TCOLD_3-T_
1487++95E8
1488++95E8              T_
1489++95E8
1490++95E8 01 05 09 0B  TCOLD_0	DB #00+1,#04+1,#08+1,#0A+1,#0C+1,#0E+1,#12+1,#14+1
1490++95EC 0D 0F 13 15
1491++95F0 19 25 3D 00  	DB #18+1,#24+1,#3C+1,0
1492++95F4 5D 00        TCOLD_1	DB #5C+1,0
1493++95F6 31 37 4D 53  TCOLD_2	DB #30+1,#36+1,#4C+1,#52+1,#5E+1,#70+1,#82,#8C,#9C
1493++95FA 5F 71 82 8C
1493++95FE 9C
1494++95FF 9E A0 A6 A8  	DB #9E,#A0,#A6,#A8,#AA,#AC,#AE,#AE,0
1494++9603 AA AC AE AE
1494++9607 00
1495++9608 57           TCNEW_3	DB #56+1
1496++9609 1F 23 25 29  TCOLD_3	DB #1E+1,#22+1,#24+1,#28+1,#2C+1,#2E+1,#32+1,#BE+1,0
1496++960D 2D 2F 33 BF
1496++9611 00
1497++9612 1D 21 23 27  TCNEW_0	DB #1C+1,#20+1,#22+1,#26+1,#2A+1,#2C+1,#30+1,#54+1
1497++9616 2B 2D 31 55
1498++961A BD BF 00     	DB #BC+1,#BE+1,0
1499++961D              TCNEW_1 EQU TCOLD_1
1500++961D 1B 21 25 29  TCNEW_2	DB #1A+1,#20+1,#24+1,#28+1,#2A+1,#3A+1,#4C+1,#5E+1
1500++9621 2B 3B 4D 5F
1501++9625 BB BD BF 00  	DB #BA+1,#BC+1,#BE+1,0
1502++9629
1503++9629              PT3EMPTYORN EQU $-1
1504++9629 01 00        	DB 1,0
1505++962B
1506++962B              ;first 12 values of tone tables (packed)
1507++962B
player.asm(1508): warning: value 0xDD8 is truncated to 8bit value: 0xD8
1508++962B 0D D8        T_PACK	DB #06EC*2/256,#06EC*2
1509++962D 69           	DB #0755-#06EC
1510++962E 70           	DB #07C5-#0755
1511++962F 76           	DB #083B-#07C5
1512++9630 7D           	DB #08B8-#083B
1513++9631 85           	DB #093D-#08B8
1514++9632 8D           	DB #09CA-#093D
1515++9633 95           	DB #0A5F-#09CA
1516++9634 9D           	DB #0AFC-#0A5F
1517++9635 A8           	DB #0BA4-#0AFC
1518++9636 B1           	DB #0C55-#0BA4
1519++9637 BB           	DB #0D10-#0C55
player.asm(1520): warning: value 0xCDA is truncated to 8bit value: 0xDA
1520++9638 0C DA        	DB #066D*2/256,#066D*2
1521++963A 62           	DB #06CF-#066D
1522++963B 68           	DB #0737-#06CF
1523++963C 6D           	DB #07A4-#0737
1524++963D 75           	DB #0819-#07A4
1525++963E 7B           	DB #0894-#0819
1526++963F 83           	DB #0917-#0894
1527++9640 8A           	DB #09A1-#0917
1528++9641 92           	DB #0A33-#09A1
1529++9642 9C           	DB #0ACF-#0A33
1530++9643 A4           	DB #0B73-#0ACF
1531++9644 AF           	DB #0C22-#0B73
1532++9645 B8           	DB #0CDA-#0C22
player.asm(1533): warning: value 0xE08 is truncated to 8bit value: 0x08
1533++9646 0E 08        	DB #0704*2/256,#0704*2
1534++9648 6A           	DB #076E-#0704
1535++9649 72           	DB #07E0-#076E
1536++964A 78           	DB #0858-#07E0
1537++964B 7E           	DB #08D6-#0858
1538++964C 86           	DB #095C-#08D6
1539++964D 90           	DB #09EC-#095C
1540++964E 96           	DB #0A82-#09EC
1541++964F A0           	DB #0B22-#0A82
1542++9650 AA           	DB #0BCC-#0B22
1543++9651 B4           	DB #0C80-#0BCC
1544++9652 BE           	DB #0D3E-#0C80
player.asm(1545): warning: value 0xFC0 is truncated to 8bit value: 0xC0
1545++9653 0F C0        	DB #07E0*2/256,#07E0*2
1546++9655 78           	DB #0858-#07E0
1547++9656 88           	DB #08E0-#0858
1548++9657 80           	DB #0960-#08E0
1549++9658 90           	DB #09F0-#0960
1550++9659 98           	DB #0A88-#09F0
1551++965A A0           	DB #0B28-#0A88
1552++965B B0           	DB #0BD8-#0B28
1553++965C A8           	DB #0C80-#0BD8
1554++965D E0           	DB #0D60-#0C80
1555++965E B0           	DB #0E10-#0D60
1556++965F E8           	DB #0EF8-#0E10
1557++9660
1558++9660              ;vars from here can be stripped
1559++9660              ;you can move VARS to any other address
1560++9660
1561++9660              VARS
1562++9660
1563++9660 00           is_ts	DB 0
1564++9661
1565++9661              ;ChannelsVars
1566++9661              	STRUCT	CHP
1567++9661 ~            ;reset group
1568++9661 ~            PsInOr	DB 0
1569++9661 ~            PsInSm	DB 0
1570++9661 ~            CrAmSl	DB 0
1571++9661 ~            CrNsSl	DB 0
1572++9661 ~            CrEnSl	DB 0
1573++9661 ~            TSlCnt	DB 0
1574++9661 ~            CrTnSl	DW 0
1575++9661 ~            TnAcc	DW 0
1576++9661 ~            COnOff	DB 0
1577++9661 ~            ;reset group
1578++9661 ~
1579++9661 ~            OnOffD	DB 0
1580++9661 ~
1581++9661 ~            ;IX for PTDECOD here (+12)
1582++9661 ~            OffOnD	DB 0
1583++9661 ~            OrnPtr	DW 0
1584++9661 ~            SamPtr	DW 0
1585++9661 ~            NNtSkp	DB 0
1586++9661 ~            Note	DB 0
1587++9661 ~            SlToNt	DB 0
1588++9661 ~            Env_En	DB 0
1589++9661 ~            Flags	DB 0
1590++9661 ~             ;Enabled - 0, SimpleGliss - 2
1591++9661 ~            TnSlDl	DB 0
1592++9661 ~            TSlStp	DW 0
1593++9661 ~            TnDelt	DW 0
1594++9661 ~            NtSkCn	DB 0
1595++9661 ~            Volume	DB 0
1596++9661              	ENDS
1597++9661
1598++9661              	STRUCT	VRS
1599++9661 ~
1600++9661 ~            ;IF not works in STRUCT in SjASM :(
1601++9661 ~            ;	IF CurPosCounter
1602++9661 ~            CurPos	DB 0
1603++9661 ~            PosSub	DB 0
1604++9661 ~            ;	ENDIF
1605++9661 ~
1606++9661 ~            ModNum	DB 0 ;bit0: ChipNum
1607++9661 ~            	     ;bit1: 1-reversed patterns order (AlCo TS)
1608++9661 ~
1609++9661 ~            ChanA	DS CHP
1610++9661 ~            ChanB	DS CHP
1611++9661 ~            ChanC	DS CHP
1612++9661 ~
1613++9661 ~            ;GlobalVars
1614++9661 ~            MODADDR	DW 0
1615++9661 ~            OrnPtrs	DW 0
1616++9661 ~            SamPtrs	DW 0
1617++9661 ~            PatsPtr	DW 0
1618++9661 ~            AdInPtA	DW 0
1619++9661 ~            AdInPtB	DW 0
1620++9661 ~            AdInPtC	DW 0
1621++9661 ~            CrPsPtr	DW 0
1622++9661 ~            LPosPtr	DW 0
1623++9661 ~            Delay	DB 0
1624++9661 ~            DelyCnt	DB 0
1625++9661 ~            ESldAdd	DW 0
1626++9661 ~            CurESld	DW 0
1627++9661 ~            Env_Del	DB 0
1628++9661 ~            CurEDel	DB 0
1629++9661 ~            Ns_Base	DB 0
1630++9661 ~            AddToNs	DB 0
1631++9661 ~            AddToEn	DB 0
1632++9661 ~            EnvBase	DW 0
1633++9661 ~            AYREGS	DS 14
1634++9661              	ENDS
1635++9661
1636++9661 00 00 00...  VARS1	DS VRS
1637++96E8 00 00 00...  VARS2	DS VRS
1638++976F
1639++976F              VT_	EQU $-16
1640++976F 00 00 00...  	DS 256-16 ;CreatedVolumeTableAddress
1641++985F
1642++985F              T1_	EQU VT_+16 ;Tone tables data depacked here
1643++985F
1644++985F              T_OLD_1	EQU T1_
1645++985F              T_OLD_2	EQU T_OLD_1+24
1646++985F              T_OLD_3	EQU T_OLD_2+24
1647++985F              T_OLD_0	EQU T_OLD_3+2
1648++985F              T_NEW_0	EQU T_OLD_0
1649++985F              T_NEW_1	EQU T_OLD_1
1650++985F              T_NEW_2	EQU T_NEW_0+24
1651++985F              T_NEW_3	EQU T_OLD_3
1652++985F
1653++985F              PT2EMPTYORN EQU VT_+31 ;1,0,0 sequence
1654++985F
1655++985F 00 00 00...  NT_	DS 192 ;CreatedNoteTableAddress
1656++991F
1657++991F              VAR0END	EQU VT_+16 ;INIT zeroes from VARS to VAR0END-1
1658++991F
1659++991F              VARSEND EQU $
1660++991F
1661++991F              MDLADDR EQU outputBuffer
1662++991F
1663++991F              ;Release 0 steps:
1664++991F              ;04/21/2007
1665++991F              ;Works start (PTxPlay adaptation); first beta.
1666++991F              ;04/22/2007
1667++991F              ;Job finished; beta-testing.
1668++991F              ;04/23/2007
1669++991F              ;PT v3.7 TS mode corrected (after AlCo remarks).
1670++991F              ;04/29/2007
1671++991F              ;Added 1.XX and 2.XX special commands interpretation for PT3
1672++991F              ;modules of v3.7+.
1673++991F
1674++991F              ;Size (minimal build for ZX Spectrum):
1675++991F              ;Code block #908 bytes
1676++991F              ;Variables #2BF bytes (can be stripped)
1677++991F              ;Total size #908+#2BF=#BC7 (3015) bytes
1678++991F              	ENDMODULE
# file closed: player/player.asm
  77++991F                  ENDIF
# file closed: player/vortex-processor.asm
  39+ 991F                      include "player/mod-processor.asm"
# file opened: player/mod-processor.asm
   1++991F                  MODULE ModProcessor
   2++991F                  ifdef GS
   3++991F ~
   4++991F ~                macro GS_WaitCommand2
   5++991F ~            .wait
   6++991F ~                in a, (CMD)
   7++991F ~                rrca
   8++991F ~                jr c, .wait
   9++991F ~                endm
  10++991F ~
  11++991F ~                macro GS_SendCommand2 nn
  12++991F ~                ld a, nn
  12++991F ~              out (CMD), a
  13++991F ~                endm
  14++991F ~
  15++991F ~            play:
  16++991F ~                ld a, 255
  17++991F ~                ld (oldminutes), a
  18++991F ~
  19++991F ~                call Console.waitForKeyUp
  20++991F ~
  21++991F ~                ld hl, Gopher.requestbuffer
  21++991F ~              call DialogBox.msgNoWait
  22++991F ~
  23++991F ~                ;ld a, 1, (Render.play_next), a
  24++991F ~            	xor a
  25++991F ~            	ld (last_song_position),a
  26++991F ~
  27++991F ~                ld h, #00, a, 32
  28++991F ~                call TextMode.fillLine
  29++991F ~                ld de, #0001
  29++991F ~              call TextMode.gotoXY
  30++991F ~                ld hl, message
  30++991F ~              call TextMode.printZ
  31++991F ~                ld a, #00
  32++991F ~                call TextMode.highlightLine
  33++991F ~
  34++991F ~            .loop
  35++991F ~                halt
  36++991F ~                xor a
  37++991F ~                call Console.peekC
  38++991F ~                cp Console.BACKSPACE
  39++991F ~                jp z, .stopKey
  40++991F ~            	cp SPACE
  41++991F ~                jp z, .playNext
  42++991F ~
  43++991F ~                call printRTC
  44++991F ~
  45++991F ~               ;РїСЂРѕРІРµСЂРєР° С‡С‚Рѕ MOD РЅР°С‡Р°Р» РёРіСЂР°С‚СЊ СЃРЅР°С‡Р°Р»Р°
  46++991F ~                GS_SendCommand2 CMD_GET_SONG_POSITION
  47++991F ~                GS_WaitCommand2
  48++991F ~            	ld a,(last_song_position) ;РїСЂРµРґС‹РґСѓС‰Р°СЏ РїРѕР·РёС†РёСЏ
  49++991F ~            	ld c,a
  50++991F ~            	in a,(DATA) ;С‚РµРєСѓС‰Р°СЏ РїРѕР·РёС†РёСЏ
  51++991F ~            	ld (last_song_position),a
  52++991F ~            	cp c
  53++991F ~            	jr nc, .loop ;РµСЃР»Рё РЅРµ РјРµРЅСЊС€Рµ, РїСЂРѕРґРѕР»Р¶Р°РµРј РёРіСЂР°С‚СЊ
  54++991F ~            .playNext
  55++991F ~                ld a, 1, (Render.play_next), a ;С„Р»Р°Рі С‡С‚Рѕ РЅР°РґРѕ Р±СѓРґРµС‚ РёРіСЂР°С‚СЊ СЃР»РµРґСѓСЋС‰РёР№ С„Р°Р№Р»
  56++991F ~            .stop
  57++991F ~                call GeneralSound.stopModule
  58++991F ~
  59++991F ~                call Console.waitForKeyUp
  60++991F ~                ret
  61++991F ~            .stopKey
  62++991F ~                xor a
  62++991F ~              ld (Render.play_next), a ;С„Р»Р°Рі С‡С‚Рѕ РЅРµ РЅР°РґРѕ РёРіСЂР°С‚СЊ СЃР»РµРґСѓСЋС‰РёР№ С„Р°Р№Р»
  63++991F ~                jr .stop
  64++991F ~
  65++991F ~            message
  66++991F ~                IFDEF SCREEN64
  67++991F ~                ENDIF
  68++991F ~                IFDEF SCREEN80
  69++991F ~                db "       "
  70++991F ~                ENDIF
  71++991F ~                IFDEF SCREEN85
  72++991F ~                db "         "
  73++991F ~                ENDIF
  74++991F ~
  75++991F ~                db "Playing MODs [SPACE] for next song [BACKSPACE] for stop playing.", 0
  76++991F ~
  77++991F ~            CMD_GET_SONG_POSITION     = #60
  78++991F ~            last_song_position db 0
  79++991F ~
  80++991F ~            ;; Control ports
  81++991F ~            CMD  = 187
  82++991F ~            DATA = 179
  83++991F                  endif
  84++991F                  ENDMODULE
  85++991F
# file closed: player/mod-processor.asm
  40+ 991F                      include "screen/screen.asm"
# file opened: screen/screen.asm
   1++991F                  module ScreenViewer
   2++991F              display:
   3++991F CD 14 6A         call Console.waitForKeyUp
   4++9922 3E 07            ld a, 7
   4++9924 CD 20 8C       call Memory.setPage
   5++9927 21 44 99 11      ld hl, outputBuffer, de, #c000, bc, 6912
   5++992B 00 C0 01 00
   5++992F 1B
   5++9930 ED B0          ldir
   6++9932 CD 46 60         call TextMode.disable
   7++9935              .wait
   8++9935 76           	halt
   9++9936 AF               xor a
   9++9937 DB FE          in a, (#fe)
   9++9939 2F             cpl
   9++993A E6 1F          and 31
   9++993C 28 F7          jr z, .wait
  10++993E CD 1D 60         call TextMode.cls
  11++9941 C3 6A 73         jp History.back
  12++9944
  13++9944                  endmodule
# file closed: screen/screen.asm
  41+ 9944              start:
  42+ 9944              outputBuffer:
  43+ 9944 F3                   di
  44+ 9945 AF                   xor a
  44+ 9946 32 6A 5C       ld (#5c6a), a  ; Thank you, Mario Prato, for feedback
  45+ 9949 32 00 5C             ld (#5c00),a
  46+ 994C 31 00 60             ld sp, asmOrg
  47+ 994F CD 16 8C             call Memory.init
  48+ 9952 AF                   xor a
  48+ 9953 D3 FE          out (#fe),a
  49+ 9955 FB                   ei
  50+ 9956
  51+ 9956 3E 07                ld a, 7
  51+ 9958 CD 20 8C       call Memory.setPage
  52+ 995B                      ;; Logo
  53+ 995B 21 93 99 06          ld hl, logo, b, Dos.FMODE_READ
  53+ 995F 01
  53+ 9960 CD 88 6C       call Dos.fopen
  54+ 9963 F5                   push af
  55+ 9964 21 00 C0 01          ld hl, #c000, bc, 6912
  55+ 9968 00 1B
  55+ 996A CD CE 6E       call Dos.fread
  56+ 996D F1                   pop af
  57+ 996E CD D3 6D             call Dos.fclose
  58+ 9971
  59+ 9971 06 32                ld b, 50
  60+ 9973 76           1       halt
  61+ 9974 10 FD                djnz 1b
  62+ 9976                  ENDIF
  63+ 9976
  64+ 9976 CD 03 60         call TextMode.init
  65+ 9979 21 82 99     	ld hl, initing
  65+ 997C CD BC 60       call TextMode.printZ
  66+ 997F
  67+ 997F                  IFNDEF NOINIT
  68+ 997F ~              	    call Wifi.init
  69+ 997F                  ENDIF
  70+ 997F
  71+ 997F C3 D7 73         jp History.home
  72+ 9982
  73+ 9982 49 6E 69 74  initing db "Initing Wifi...", "\r", 0
  73+ 9986 69 6E 67 20
  73+ 998A 57 69 66 69
  73+ 998E 2E 2E 2E 0D
  73+ 9992 00
  74+ 9993 62 72 6F 77  logo    db "browser/logo.scr", 0
  74+ 9997 73 65 72 2F
  74+ 999B 6C 6F 67 6F
  74+ 999F 2E 73 63 72
  74+ 99A3 00
  75+ 99A4 62 72 6F 77  creds   db "browser/auth.pwd", 0
  75+ 99A8 73 65 72 2F
  75+ 99AC 61 75 74 68
  75+ 99B0 2E 70 77 64
  75+ 99B4 00
  76+ 99B5              outputBuffer2:
  77+ 99B5 41 54 45 30      db  "ATE0", 0
  77+ 99B9 00
  78+ 99BA
  79+ 99BA                  display "ENDS: ", $
  80+ 99BA                  display "Buff size", #ffff - $
  81+ 99BA                  IFDEF NEDOOS
  82+ 99BA ~                    savebin "moon.com", asmOrg, $ - asmOrg
  83+ 99BA                  ELSE
  84+ 99BA              		IFDEF TRDOS
  85+ 99BA              			SAVETRD "MOONR.TRD",|"moon.C",asmOrg, $ - asmOrg
  86+ 99BA              		ELSE
  87+ 99BA ~            			savebin "moon.bin", asmOrg, $ - asmOrg
  88+ 99BA              	    	ENDIF
  89+ 99BA                  ENDIF
  90+ 99BA
# file closed: main-all.asm
  17  99BA                  ENDIF
# file closed: main.asm
