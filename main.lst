# file opened: main.asm
   1  0000                  DEFINE TCP_BUFFER_SIZE 2048
   2  0000              ; Generate version string
   3  0000                  LUA ALLPASS
   4  0000 ~                v = tostring(sj.get_define("V"))
   5  0000 ~                maj = string.sub(v, 1,1)
   6  0000 ~                min = string.sub(v, 2,2)
   7  0000 ~                sj.insert_define("VERSION_STRING", "\"" .. maj .. "." .. min .. "\"")
   8  0000 ~
   9  0000 ~                b = tostring(sj.get_define("BLD"))
  10  0000 ~                sj.insert_define("BUILD_STRING", "\"" .. b .. "\"")
  11  0000                  ENDLUA
  12  0000
  13  0000                  IFDEF MSX
  14  0000 ~                    include "main-msx.asm"
  15  0000                  ELSE
  16  0000                      include "main-all.asm"
# file opened: main-all.asm
   1+ 0000                  device	zxspectrum128
   2+ 0000                  IFDEF NEDOOS
   3+ 0000 ~            	DEFINE CRLF "\r\n"
   4+ 0000 ~                    MODULE nos
   5+ 0000 ~                        include "../_sdk/sysdefs.asm"
   6+ 0000 ~                    ENDMODULE
   7+ 0000 ~                    org nos.PROGSTART
   8+ 0000                      ELSE
   9+ 0000              	DEFINE CRLF "\r"
  10+ 0000                      org 24576
  11+ 6000                  ENDIF
  12+ 6000              asmOrg:
  13+ 6000                  align 256
  14+ 6000 C3 86 A0         jp start
  15+ 6003                  include "vdp/index.asm"
# file opened: vdp/index.asm
   1++6003                  IFDEF TIMEX
   2++6003 ~                include "timex.asm"
   3++6003                  ENDIF
   4++6003
   5++6003                  IFDEF TIMEX80
   6++6003 ~                include "timex80.asm"
   7++6003                  ENDIF
   8++6003
   9++6003                  IFDEF ZXSCR
  10++6003                  include "zx.asm"
# file opened: vdp/zx.asm
   1++6003              COLOR=1
   2++6003              ;; Usual speccy screen driver
   3++6003                  module TextMode
   4++6003              init:
   5++6003 21 D5 61 06      ld hl, font_file, b, Dos.FMODE_READ
   5++6007 01
   6++6008 CD F2 6C         call Dos.fopen
   7++600B F5               push af
   8++600C 01 00 08 21      ld bc, 2048, hl, font64
   8++6010 00 40
   9++6012 CD 49 6F         call Dos.fread
  10++6015 F1               pop af
  11++6016 CD 3D 6E         call Dos.fclose
  12++6019 AF           	xor a
  12++601A D3 FE          out (#fe), a
  13++601C C9           	ret
  14++601D              cls:
  15++601D 11 00 00         ld de, 0
  15++6020 CD 3A 60       call gotoXY
  16++6023 3E 07            ld a, 7
  16++6025 CD E3 92       call Memory.setPage
  17++6028 AF               xor a
  17++6029 D3 FE          out (#fe), a
  18++602B 21 00 C0 11      ld hl, #c000, de, #c001, bc, 6911, (hl), a
  18++602F 01 C0 01 FF
  18++6033 1A 77
  18++6035 ED B0          ldir
  19++6037 C3 E3 92         jp Memory.setPage
  20++603A
  21++603A
  22++603A              ; Set console coordinates
  23++603A              ; d = row(0..23), e = column (0..63)
  24++603A              gotoXY:
  25++603A              	;rr e;;;
  26++603A CB 3B        	srl e
  27++603C 3E 00        	ld a, 0
  28++603E 32 62 63     	ld (half_tile_screen), a
  29++6041 ED 53 60 63      ld (col_screen), de
  30++6045 C9               ret
  31++6046
  32++6046              disable:
  33++6046                  ; Nothing to disable
  34++6046 C9               ret
  35++6047
  36++6047              ; H - line
  37++6047              ; A - char
  38++6047              fillLine:
  39++6047 F5               push af
  40++6048 54 1E 00         ld d, h, e, 0
  40++604B CD 3A 60       call gotoXY
  41++604E F1               pop af
  42++604F 21 69 63 11      ld hl, fill_buff, de, fill_buff + 1, bc, 63, (hl), a
  42++6053 6A 63 01 3F
  42++6057 00 77
  42++6059 ED B0          ldir
  43++605B 21 69 63         ld hl, fill_buff
  43++605E C3 BC 60       jp printZ
  44++6061
  45++6061              usualLine:
  46++6061 47               ld b, a
  47++6062 0E 00            ld c, 0
  48++6064 CD 79 61         call bc_to_attr
  49++6067 3E 07            ld a, 7
  49++6069 CD E3 92       call Memory.setPage
  50++606C 36 07            ld (hl), #7
  51++606E 54 5D            ld de, hl
  52++6070 13               inc de
  53++6071 01 1F 00         ld bc, 31
  54++6074 ED B0            ldir
  55++6076 AF               xor a
  55++6077 CD E3 92       call Memory.setPage
  56++607A C9               ret
  57++607B
  58++607B              highlightLine:
  59++607B 47               ld b, a
  60++607C 0E 00            ld c, 0
  61++607E CD 79 61         call bc_to_attr
  62++6081 3E 07            ld a, 7
  62++6083 CD E3 92       call Memory.setPage
  63++6086 36 0C            ld (hl), #C
  64++6088 54 5D            ld de, hl
  65++608A 13               inc de
  66++608B 01 1F 00         ld bc, 31
  67++608E ED B0            ldir
  68++6090 AF               xor a
  68++6091 CD E3 92       call Memory.setPage
  69++6094 C9               ret
  70++6095
  71++6095              mvCR
  72++6095 ED 5B 60 63  	ld de, (col_screen)
  73++6099 14           	inc d
  74++609A 1E 00        	ld e, 0
  75++609C 3E 00        	ld a, 0
  76++609E 32 62 63     	ld (half_tile_screen), a
  77++60A1 C3 3A 60     	jp gotoXY
  78++60A4
  79++60A4              ; Print just one symbol
  80++60A4              ; A - symbol
  81++60A4              putC
  82++60A4 FE 0D            cp 13
  82++60A6 CA 95 60       jp z, mvCR
  83++60A9 21 68 63     	ld hl, single_symbol
  84++60AC 77           	ld (hl), a
  85++60AD 3E 07        	ld a, 7
  85++60AF CD E3 92       call Memory.setPage
  86++60B2 21 67 63         ld hl, single_symbol_print
  87++60B5 CD C7 60         call printL
  88++60B8 AF               xor a
  88++60B9 C3 E3 92       jp Memory.setPage
  89++60BC
  90++60BC              ; Put string
  91++60BC              ; hl - string pointer that's begins from symbol count
  92++60BC              printZ
  93++60BC 7E               ld a, (hl)
  93++60BD A7             and a
  93++60BE C8             ret z
  94++60BF E5               push hl
  95++60C0 CD A4 60         call putC
  96++60C3 E1               pop hl
  97++60C4 23               inc hl
  98++60C5 18 F5            jr printZ
  99++60C7
 100++60C7              printL
 101++60C7 7E                   ld	a, (hl)
 102++60C8 A7           		and	a
 103++60C9 C8           		ret	z
 104++60CA
 105++60CA E5           		push	hl
 106++60CB CD 75 61     		call	calc_addr_attr
 107++60CE 3A 63 63     		ld	a,(attr_screen)
 108++60D1 77           		ld	(hl),a
 109++60D2 E1           		pop	hl
 110++60D3
 111++60D3 CD 64 61     		call	calc_addr_scr
 112++60D6
 113++60D6 3A 62 63     		ld	a,(half_tile_screen)
 114++60D9 CB 47        		bit	0,a
 115++60DB 7E           		ld	a,(hl)
 116++60DC C2 10 61     		jp	nz,print64_4
 117++60DF              print64_3
 118++60DF F5                   push    af
 119++60E0 E5           		push	hl
 120++60E1 CD 75 61     		call	calc_addr_attr
 121++60E4 3A 63 63     		ld	a,(attr_screen)
 122++60E7 77           		ld	(hl),a
 123++60E8 E1           		pop	hl
 124++60E9
 125++60E9 23                   inc     hl
 126++60EA E5                   push    hl
 127++60EB
 128++60EB 7E                   ld      a,(hl)
 129++60EC 6F           		ld	l,a
 130++60ED 26 00        		ld	h,0
 131++60EF 29           		add	hl,hl
 132++60F0 29           		add	hl,hl
 133++60F1 29           		add	hl,hl
 134++60F2 01 00 40             ld      bc,font64
 135++60F5 09                   add     hl,bc
 136++60F6
 137++60F6 D5                   push    de
 138++60F7
 139++60F7 06 06                ld      b,6
 140++60F9 AF           		xor	a
 141++60FA 12           		ld	(de),a
 142++60FB              print64_1
 143++60FB 14           	inc     d
 144++60FC 7E           	ld      a,(hl)
 145++60FD E6 F0        	and	#f0
 146++60FF 12           	ld      (de),a
 147++6100 23           	inc     hl
 148++6101 10 F8        	djnz    print64_1
 149++6103
 150++6103 14           	inc	d
 151++6104 AF           	xor	a
 152++6105 12           	ld	(de),a
 153++6106
 154++6106 3E 01        	ld	a,1
 155++6108 32 62 63     	ld	(half_tile_screen),a
 156++610B
 157++610B D1           	pop     de
 158++610C E1           	pop     hl
 159++610D F1           	pop     af
 160++610E
 161++610E 3D           	dec     a
 162++610F C8           	ret     z
 163++6110
 164++6110              print64_4
 165++6110 F5           	push    af
 166++6111
 167++6111 23           	inc     hl
 168++6112 E5           	push    hl
 169++6113
 170++6113 7E           	ld      a,(hl)
 171++6114 6F           	ld	l,a
 172++6115 26 00        	ld	h,0
 173++6117 29           	add	hl,hl
 174++6118 29           	add	hl,hl
 175++6119 29           	add	hl,hl
 176++611A 01 00 40     	ld      bc,font64
 177++611D 09           	add     hl,bc
 178++611E
 179++611E D5           	push    de
 180++611F
 181++611F 06 06        	ld      b,6
 182++6121 AF           	xor	a
 183++6122 12           	ld	(de),a
 184++6123              print64_2
 185++6123 14           	inc     d
 186++6124 7E           	ld      a,(hl)
 187++6125 E6 0F        	and     #0f
 188++6127 4F           	ld      c,a
 189++6128 1A           	ld      a,(de)
 190++6129 B1           	or      c
 191++612A 12           	ld      (de),a
 192++612B 23           	inc     hl
 193++612C 10 F5        	djnz    print64_2
 194++612E
 195++612E 14           	inc	d
 196++612F AF           	xor	a
 197++6130 12           	ld	(de),a
 198++6131
 199++6131 32 62 63     	ld	(half_tile_screen),a
 200++6134
 201++6134 D1           	pop     de
 202++6135
 203++6135 CD 3F 61     	call	move_cr64
 204++6138
 205++6138 E1           	pop     hl
 206++6139 F1           	pop     af
 207++613A 3D           	dec     a
 208++613B
 209++613B C2 DF 60     	jp      nz,print64_3
 210++613E
 211++613E C9           	ret
 212++613F
 213++613F              ; move cursor
 214++613F              move_cr64
 215++613F 13           	inc	de
 216++6140
 217++6140 21 60 63     	ld	hl,col_screen
 218++6143 34           	inc	(hl)
 219++6144 7E           	ld	a,(hl)
 220++6145
 221++6145 FE 20        	cp	32
 222++6147 D8           	ret	c
 223++6148
 224++6148 AF           	xor	a
 225++6149 32 62 63     	ld	(half_tile_screen),a
 226++614C 77           	ld	(hl),a
 227++614D 4F           	ld	c,a
 228++614E
 229++614E 23           	inc	hl
 230++614F 34           	inc	(hl)
 231++6150 7E           	ld	a,(hl)
 232++6151 47           	ld	b,a
 233++6152
 234++6152 FE 18        	cp	24
 235++6154 DA 60 61     	jp	c,move_cr64_01
 236++6157
 237++6157 3E 17        	ld	a,23
 238++6159 77           	ld	(hl),a
 239++615A 47           	ld	b,a
 240++615B
 241++615B C5           	push	bc
 242++615C CD 89 61     	call	scroll_up8
 243++615F C1           	pop	bc
 244++6160
 245++6160              move_cr64_01
 246++6160 CD 64 61     	call	calc_addr_scr
 247++6163 C9           	ret
 248++6164
 249++6164              calc_addr_scr
 250++6164 78           	ld      a,b
 251++6165 57           	ld      d,a
 252++6166 0F           	rrca
 253++6167 0F           	rrca
 254++6168 0F           	rrca
 255++6169 A7 E6 E0     	and     a,224
 256++616C 81           	add     a,c
 257++616D 5F           	ld      e,a
 258++616E 7A           	ld      a,d
 259++616F E6 18        	and     24
 260++6171 F6 C0        	or      #c0
 261++6173 57           	ld      d,a
 262++6174 C9           	ret
 263++6175
 264++6175              calc_addr_attr
 265++6175 ED 4B 60 63  	ld	bc,(col_screen)
 266++6179              bc_to_attr:
 267++6179 78           	ld	a,b
 268++617A 0F           	rrca
 269++617B 0F           	rrca
 270++617C 0F           	rrca
 271++617D 6F           	ld	l,a
 272++617E E6 1F        	and	31
 273++6180 F6 D8        	or	#d8
 274++6182 67           	ld	h,a
 275++6183 7D           	ld	a,l
 276++6184 E6 FC        	and	252
 277++6186 B1           	or	c
 278++6187 6F           	ld	l,a
 279++6188 C9           	ret
 280++6189
 281++6189              scroll_up8
 282++6189 21 E0 61     	ld	hl,table_addr_scr
 283++618C 06 B8        	ld	b,184
 284++618E
 285++618E              scroll_up8_01
 286++618E C5           	push	bc
 287++618F
 288++618F 5E           	ld	e,(hl)
 289++6190 23           	inc	hl
 290++6191 56           	ld	d,(hl)
 291++6192 23           	inc	hl
 292++6193
 293++6193 E5           	push	hl
 294++6194
 295++6194 01 0E 00     	ld	bc,14
 296++6197 09           	add	hl,bc
 297++6198 4E           	ld	c,(hl)
 298++6199 23           	inc	hl
 299++619A 46           	ld	b,(hl)
 300++619B
 301++619B 60           	ld	h,b
 302++619C 69           	ld	l,c
 303++619D
 304++619D 01 20 00     	ld	bc,32
 305++61A0 ED B0        	ldir
 306++61A2
 307++61A2 E1           	pop	hl
 308++61A3 C1           	pop	bc
 309++61A4 10 E8        	djnz	scroll_up8_01
 310++61A6
 311++61A6 06 08        	ld	b,8
 312++61A8
 313++61A8              scroll_up8_02
 314++61A8 C5           	push	bc
 315++61A9
 316++61A9 5E           	ld	e,(hl)
 317++61AA 23           	inc	hl
 318++61AB 56           	ld	d,(hl)
 319++61AC 23           	inc	hl
 320++61AD
 321++61AD E5           	push	hl
 322++61AE
 323++61AE 62           	ld	h,d
 324++61AF 6B           	ld	l,e
 325++61B0 13           	inc	de
 326++61B1 36 00        	ld	(hl),0
 327++61B3 01 1F 00     	ld	bc,31
 328++61B6 ED B0        	ldir
 329++61B8
 330++61B8 E1           	pop	hl
 331++61B9 C1           	pop	bc
 332++61BA 10 EC        	djnz	scroll_up8_02
 333++61BC 11 00 D8 21  	ld	de,#D800, hl,#D820, bc,736
 333++61C0 20 D8 01 E0
 333++61C4 02
 334++61C5 ED B0        	ldir
 335++61C7 1A           	ld	a,(de)
 336++61C8 21 E0 DA 11  	ld	hl,#dae0, de,#dae1, (hl),a, bc,31
 336++61CC E1 DA 77 01
 336++61D0 1F 00
 337++61D2 ED B0        	ldir
 338++61D4
 339++61D4 C9           	ret
 340++61D5
 341++61D5              font64 equ #4000 ; Using ZX-Spectrum screen as font buffer
 342++61D5 66 6F 6E 74  font_file db "font64.bin", 0
 342++61D9 36 34 2E 62
 342++61DD 69 6E 00
 343++61E0
 344++61E0
 345++61E0              table_addr_scr
 346++61E0 00 40 00 41  	defw	#4000,#4100,#4200,#4300,#4400,#4500,#4600,#4700
 346++61E4 00 42 00 43
 346++61E8 00 44 00 45
 346++61EC 00 46 00 47
 347++61F0 20 40 20 41  	defw	#4020,#4120,#4220,#4320,#4420,#4520,#4620,#4720
 347++61F4 20 42 20 43
 347++61F8 20 44 20 45
 347++61FC 20 46 20 47
 348++6200 40 40 40 41  	defw	#4040,#4140,#4240,#4340,#4440,#4540,#4640,#4740
 348++6204 40 42 40 43
 348++6208 40 44 40 45
 348++620C 40 46 40 47
 349++6210 60 40 60 41  	defw	#4060,#4160,#4260,#4360,#4460,#4560,#4660,#4760
 349++6214 60 42 60 43
 349++6218 60 44 60 45
 349++621C 60 46 60 47
 350++6220 80 40 80 41  	defw	#4080,#4180,#4280,#4380,#4480,#4580,#4680,#4780
 350++6224 80 42 80 43
 350++6228 80 44 80 45
 350++622C 80 46 80 47
 351++6230 A0 40 A0 41  	defw	#40a0,#41a0,#42a0,#43a0,#44a0,#45a0,#46a0,#47a0
 351++6234 A0 42 A0 43
 351++6238 A0 44 A0 45
 351++623C A0 46 A0 47
 352++6240 C0 40 C0 41  	defw	#40c0,#41c0,#42c0,#43c0,#44c0,#45c0,#46c0,#47c0
 352++6244 C0 42 C0 43
 352++6248 C0 44 C0 45
 352++624C C0 46 C0 47
 353++6250 E0 40 E0 41  	defw	#40e0,#41e0,#42e0,#43e0,#44e0,#45e0,#46e0,#47e0
 353++6254 E0 42 E0 43
 353++6258 E0 44 E0 45
 353++625C E0 46 E0 47
 354++6260
 355++6260 00 48 00 49  	defw	#4800,#4900,#4a00,#4b00,#4c00,#4d00,#4e00,#4f00
 355++6264 00 4A 00 4B
 355++6268 00 4C 00 4D
 355++626C 00 4E 00 4F
 356++6270 20 48 20 49  	defw	#4820,#4920,#4a20,#4b20,#4c20,#4d20,#4e20,#4f20
 356++6274 20 4A 20 4B
 356++6278 20 4C 20 4D
 356++627C 20 4E 20 4F
 357++6280 40 48 40 49  	defw	#4840,#4940,#4a40,#4b40,#4c40,#4d40,#4e40,#4f40
 357++6284 40 4A 40 4B
 357++6288 40 4C 40 4D
 357++628C 40 4E 40 4F
 358++6290 60 48 60 49  	defw	#4860,#4960,#4a60,#4b60,#4c60,#4d60,#4e60,#4f60
 358++6294 60 4A 60 4B
 358++6298 60 4C 60 4D
 358++629C 60 4E 60 4F
 359++62A0 80 48 80 49  	defw	#4880,#4980,#4a80,#4b80,#4c80,#4d80,#4e80,#4f80
 359++62A4 80 4A 80 4B
 359++62A8 80 4C 80 4D
 359++62AC 80 4E 80 4F
 360++62B0 A0 48 A0 49  	defw	#48a0,#49a0,#4aa0,#4ba0,#4ca0,#4da0,#4ea0,#4fa0
 360++62B4 A0 4A A0 4B
 360++62B8 A0 4C A0 4D
 360++62BC A0 4E A0 4F
 361++62C0 C0 48 C0 49  	defw	#48c0,#49c0,#4ac0,#4bc0,#4cc0,#4dc0,#4ec0,#4fc0
 361++62C4 C0 4A C0 4B
 361++62C8 C0 4C C0 4D
 361++62CC C0 4E C0 4F
 362++62D0 E0 48 E0 49  	defw	#48e0,#49e0,#4ae0,#4be0,#4ce0,#4de0,#4ee0,#4fe0
 362++62D4 E0 4A E0 4B
 362++62D8 E0 4C E0 4D
 362++62DC E0 4E E0 4F
 363++62E0
 364++62E0 00 50 00 51  	defw	#5000,#5100,#5200,#5300,#5400,#5500,#5600,#5700
 364++62E4 00 52 00 53
 364++62E8 00 54 00 55
 364++62EC 00 56 00 57
 365++62F0 20 50 20 51  	defw	#5020,#5120,#5220,#5320,#5420,#5520,#5620,#5720
 365++62F4 20 52 20 53
 365++62F8 20 54 20 55
 365++62FC 20 56 20 57
 366++6300 40 50 40 51  	defw	#5040,#5140,#5240,#5340,#5440,#5540,#5640,#5740
 366++6304 40 52 40 53
 366++6308 40 54 40 55
 366++630C 40 56 40 57
 367++6310 60 50 60 51  	defw	#5060,#5160,#5260,#5360,#5460,#5560,#5660,#5760
 367++6314 60 52 60 53
 367++6318 60 54 60 55
 367++631C 60 56 60 57
 368++6320 80 50 80 51  	defw	#5080,#5180,#5280,#5380,#5480,#5580,#5680,#5780
 368++6324 80 52 80 53
 368++6328 80 54 80 55
 368++632C 80 56 80 57
 369++6330 A0 50 A0 51  	defw	#50a0,#51a0,#52a0,#53a0,#54a0,#55a0,#56a0,#57a0
 369++6334 A0 52 A0 53
 369++6338 A0 54 A0 55
 369++633C A0 56 A0 57
 370++6340 C0 50 C0 51  	defw	#50c0,#51c0,#52c0,#53c0,#54c0,#55c0,#56c0,#57c0
 370++6344 C0 52 C0 53
 370++6348 C0 54 C0 55
 370++634C C0 56 C0 57
 371++6350 E0 50 E0 51  	defw	#50e0,#51e0,#52e0,#53e0,#54e0,#55e0,#56e0,#57e0
 371++6354 E0 52 E0 53
 371++6358 E0 54 E0 55
 371++635C E0 56 E0 57
 372++6360
 373++6360
 374++6360 00           col_screen			db	0
 375++6361 00           row_screen			db	0
 376++6362 00           half_tile_screen	db	0
 377++6363 07           attr_screen			db	07
 378++6364
 379++6364 00 00        col_screen_temp			dw	0
 380++6366 00           half_tile_screen_temp	db	0
 381++6367
 382++6367 01           single_symbol_print db 1
 383++6368 00           single_symbol 		db 0
 384++6369
 385++6369 00 00 00...  fill_buff ds 65
 386++63AA
 387++63AA                  endmodule
# file closed: vdp/zx.asm
  11++63AA                  ENDIF
  12++63AA
  13++63AA              	IFDEF NEDOOS
  14++63AA ~                include "nedotext.asm"
  15++63AA                  ENDIF
# file closed: vdp/index.asm
  16+ 63AA                  include "utils/index.asm"
# file opened: utils/index.asm
   1++63AA                  include "atoi.asm"
# file opened: utils/atoi.asm
   1++63AA              ; DE - buffer
   2++63AA              ; HL - output
   3++63AA              atohl:
   4++63AA 21 00 00         ld hl, 0
   5++63AD              .loop
   6++63AD 1A               ld a, (de)
   7++63AE 13               inc de
   8++63AF                  ; Sepparators
   9++63AF C5 E5            push bc, hl
  10++63B1 01 05 00             ld bc, sepparators_len
  11++63B4 21 CC 63             ld hl, sepparators
  12++63B7 ED B1                cpir
  13++63B9 E1 C1            pop hl, bc
  14++63BB C8               ret z
  15++63BC
  16++63BC D6 30            sub '0'
  17++63BE
  18++63BE C5               push bc
  19++63BF 4D                   ld c, l
  20++63C0 44                   ld b, h
  21++63C1
  22++63C1 29                   add hl, hl
  23++63C2 29                   add hl, hl
  24++63C3 09                   add hl, bc
  25++63C4 29                   add hl, hl
  26++63C5 4F                   ld c, a
  27++63C6 06 00                ld b, 0
  28++63C8 09                   add hl, bc
  29++63C9 C1               pop bc
  30++63CA 18 E1            jr .loop
  31++63CC
# file closed: utils/atoi.asm
   2++63CC                  include "constants.asm"
# file opened: utils/constants.asm
   1++63CC              TAB = 9
   2++63CC              CR = 13
   3++63CC              LF = 10
   4++63CC              NULL = 0
   5++63CC              SPACE = ' '
   6++63CC              ESC = 27
   7++63CC              BACKSPACE = 8
   8++63CC
   9++63CC                  IFDEF TIMEX80
  10++63CC ~            MIME_DOWNLOAD 	= #19
  11++63CC ~            MIME_LINK 		= #1A
  12++63CC ~            MIME_TEXT 		= #10
  13++63CC ~            MIME_IMAGE 		= #01
  14++63CC ~            MIME_MUSIC 		= #0e
  15++63CC ~            MIME_INPUT 		= #b3
  16++63CC ~            MIME_MOD 		= #0d
  17++63CC ~            MIME_SOUND      = 's' ;sound
  18++63CC ~
  19++63CC ~            BORDER_TOP = #b2
  20++63CC ~            BORDER_BOTTOM = #b1
  21++63CC                  ELSE
  22++63CC              	IFDEF MSX
  23++63CC ~            MIME_DOWNLOAD 	= 1
  24++63CC ~            MIME_LINK		= 2
  25++63CC ~            MIME_TEXT 		= 3
  26++63CC ~            MIME_IMAGE 		= 4
  27++63CC ~            MIME_MUSIC 		= 5
  28++63CC ~            MIME_INPUT 		= 6
  29++63CC ~            MIME_MOD      	= 7
  30++63CC ~            MIME_SOUND      = 's' ;sound
  31++63CC ~
  32++63CC ~            BORDER_TOP    = 7
  33++63CC ~            BORDER_BOTTOM = 8
  34++63CC              	ELSE
  35++63CC              MIME_DOWNLOAD = 1
  36++63CC              MIME_LINK     = 2
  37++63CC              MIME_TEXT     = 3
  38++63CC              MIME_IMAGE    = 6
  39++63CC              MIME_MUSIC    = 5
  40++63CC              MIME_INPUT    = 4
  41++63CC              MIME_MOD      = 7
  42++63CC              MIME_SOUND    = 's' ;sound
  43++63CC
  44++63CC              BORDER_TOP    = 9
  45++63CC              BORDER_BOTTOM = 8
  46++63CC              	ENDIF
  47++63CC
  48++63CC
  49++63CC
  50++63CC
  51++63CC              	ENDIF
  52++63CC
  53++63CC 0D 0A 09 00  sepparators db CR, LF, TAB, NULL, SPACE
  53++63D0 20
  54++63D1              sepparators_len = $ - sepparators
# file closed: utils/constants.asm
   3++63D1                  include "strutils.asm"
# file opened: utils/strutils.asm
   1++63D1              ; de - pointer
   2++63D1              ; hl - count
   3++63D1              strlen:
   4++63D1 21 00 00         ld hl, 0
   5++63D4              .loop
   6++63D4 1A               ld a, (de)
   7++63D5 A7               and a
   7++63D6 28 04          jr z, .exit
   8++63D8 23               inc hl
   9++63D9 13               inc de
  10++63DA 18 F8            jr .loop
  11++63DC              .exit
  12++63DC C9               ret
  13++63DD
  14++63DD                  module CompareBuff
  15++63DD
  16++63DD              ; Pushes A to buffer
  17++63DD              push
  18++63DD F5               push af
  19++63DE 06 20            ld b, 32
  19++63E0 21 29 64       ld hl, buffer + 1
  19++63E3 11 28 64       ld de, buffer
  20++63E6              .loop
  21++63E6 7E               ld a, (hl)
  21++63E7 12             ld (de), a
  21++63E8 23             inc hl
  21++63E9 13             inc de
  21++63EA 10 FA          djnz .loop
  22++63EC F1               pop af
  23++63ED 21 47 64         ld hl, buffer + 31
  23++63F0 77             ld (hl), a
  24++63F1 C9               ret
  25++63F2
  26++63F2              ; HL - Compare string(null terminated)
  27++63F2              ; A - 0 NOT Found
  28++63F2              ;     1 Found
  29++63F2              search:
  30++63F2 06 00            ld b, 0
  30++63F4 E5             push hl
  31++63F5              .loop:
  32++63F5 7E               ld a, (hl)
  32++63F6 23             inc hl
  32++63F7 04             inc b
  32++63F8 A7             and a
  32++63F9 C2 F5 63       jp nz, .loop
  33++63FC 05               dec b
  33++63FD E1             pop hl
  33++63FE C5             push bc
  33++63FF E5             push hl
  34++6400 E1               pop hl
  35++6401 11 48 64         ld de, buffer + 32
  36++6404              .sourceLoop
  37++6404 1B               dec de
  37++6405 10 FD          djnz .sourceLoop
  38++6407 C1               pop bc
  39++6408              .compare
  40++6408 C5               push bc
  40++6409 F5             push af
  41++640A 1A               ld a, (de)
  41++640B 47             ld b, a
  42++640C F1               pop af
  42++640D 7E             ld a, (hl)
  42++640E B8             cp b
  42++640F C1             pop bc
  42++6410 3E 00          ld a, 0
  42++6412 C0             ret nz
  43++6413 13               inc de
  43++6414 23             inc hl
  44++6415 10 F1            djnz .compare
  45++6417 3E 01            ld a, 1
  46++6419 C9               ret
  47++641A
  48++641A              clear:
  49++641A AF               xor a
  49++641B 21 28 64       ld hl, buffer
  49++641E 11 29 64       ld de, buffer + 1
  49++6421 01 20 00       ld bc, 32
  49++6424 77             ld (hl), a
  49++6425 ED B0          ldir
  50++6427 C9               ret
  51++6428
  52++6428 00 00 00...  buffer ds 32
  53++6448
  54++6448                  endmodule
# file closed: utils/strutils.asm
   4++6448                  IFDEF MSX
   5++6448 ~            	    include "bios.asm"
   6++6448                  ENDIF
   7++6448                  include "screen.asm"
# file opened: utils/screen.asm
   1++6448              LINE_LIMIT = 63
   2++6448
   3++6448                  IFDEF NEDOOS
   4++6448 ~            LINE_LIMIT = 79
   5++6448                  ENDIF
   6++6448
   7++6448                  IFDEF TIMEX80
   8++6448 ~            LINE_LIMIT = 84
   9++6448                  ENDIF
  10++6448
  11++6448                  IFDEF MSX
  12++6448 ~            LINE_LIMIT = 79
  13++6448                  ENDIF
  14++6448              ; HL - string pointer
  15++6448              print70Text:
  16++6448 06 3F            ld b, LINE_LIMIT
  17++644A              .loop
  18++644A 7E               ld a, (hl)
  19++644B A7               and a
  19++644C C8             ret z
  20++644D FE 0D            cp 13
  20++644F C8             ret z
  21++6450 FE 0A            cp 10
  21++6452 C8             ret z
  22++6453 C5               push bc
  23++6454 E5               push hl
  24++6455 CD A4 60         call TextMode.putC
  25++6458 E1               pop hl
  26++6459 23               inc hl
  27++645A C1               pop bc
  28++645B 05               dec b
  29++645C 78               ld a, b
  29++645D A7             and a
  29++645E C8             ret z
  30++645F C3 4A 64         jp .loop
  31++6462
  32++6462              ; HL - string pointer
  33++6462              print70Goph:
  34++6462 06 3F            ld b, LINE_LIMIT
  35++6464              .loop
  36++6464 7E               ld a, (hl)
  36++6465 FE 09          cp 09
  36++6467 C8             ret z
  37++6468 A7               and a
  37++6469 C8             ret z
  38++646A C5               push bc
  39++646B E5               push hl
  40++646C CD A4 60         call TextMode.putC
  41++646F E1               pop hl
  42++6470 23               inc hl
  43++6471 C1               pop bc
  44++6472 05               dec b
  45++6473 78               ld a, b
  45++6474 A7             and a
  45++6475 C8             ret z
  46++6476 C3 64 64         jp .loop
# file closed: utils/screen.asm
# file closed: utils/index.asm
  17+ 6479                  include "gopher/render/index.asm"
# file opened: gopher/render/index.asm
   1++6479                  MODULE Render
   2++6479              PER_PAGE = 22
   3++6479              CURSOR_OFFSET = 2
   4++6479                  include "row.asm"
# file opened: gopher/render/row.asm
   1++6479              ; A - row number
   2++6479              ; HL - pointer to row
   3++6479              renderRow:
   4++6479 C6 02            add CURSOR_OFFSET
   5++647B 57               ld d,a
   6++647C 1E 00            ld e,0
   7++647E CD 3A 60         call TextMode.gotoXY
   8++6481 7E               ld a,(hl)
   9++6482 E5               push hl
  10++6483 CD 8E 64         call getIcon
  11++6486 CD A4 60         call TextMode.putC
  12++6489 E1               pop hl
  13++648A 23               inc hl
  14++648B C3 62 64         jp print70Goph
  15++648E
  16++648E              ; A - gopher id char
  17++648E              getIcon:
  18++648E FE 69            cp 'i'
  18++6490 CA AF 64       jp z, .info
  19++6493 FE 39            cp '9'
  19++6495 CA B2 64       jp z, .down
  20++6498 FE 31            cp '1'
  20++649A CA 30 65       jp z, .page
  21++649D FE 30            cp '0'
  21++649F CA 33 65       jp z, .text
  22++64A2 FE 37            cp '7'
  22++64A4 CA 36 65       jp z, .input
  23++64A7 FE 73            cp 's'
  23++64A9 CA B2 64       jp z, .down
  24++64AC 3E 20            ld a, ' '
  25++64AE C9               ret
  26++64AF              .info
  27++64AF 3E 20            ld a, SPACE
  27++64B1 C9             ret
  28++64B2              .down
  29++64B2 54 5D            ld de, hl
  30++64B4 01 FF 00 3E      ld bc, #ff, a, TAB
  30++64B8 09
  30++64B9 ED B1          cpir
  31++64BB 78               ld a, b
  31++64BC B1             or c
  31++64BD 28 6E          jr z, .downExit
  32++64BF D5               push de
  33++64C0              .nameLoop
  34++64C0 7E               ld a, (hl)
  34++64C1 A7             and a
  34++64C2 28 10          jr z, .check
  35++64C4 FE 09            cp TAB
  35++64C6 28 0C          jr z, .check
  36++64C8 FE 0D            cp CR
  36++64CA 28 08          jr z, .check
  37++64CC E5               push hl
  38++64CD CD DD 63         call CompareBuff.push
  39++64D0 E1               pop hl
  40++64D1 23               inc hl
  41++64D2 18 EC            jr .nameLoop
  42++64D4              .check
  43++64D4 3A 75 65     	ld a,(saveMode+1);
  44++64D7 B7           	or a
  45++64D8 20 52        	jr nz,.checkExit
  46++64DA 21 45 65     	ld hl, scrExt1
  46++64DD CD F2 63       call CompareBuff.search
  46++64E0 A7             and a
  46++64E1 20 56          jr nz, .image
  47++64E3 21 4A 65         ld hl, scrExt2
  47++64E6 CD F2 63       call CompareBuff.search
  47++64E9 A7             and a
  47++64EA 20 4D          jr nz, .image
  48++64EC 3E 03            ld a, 3
  48++64EE 32 9A 94       ld (VTPL.SETUP), a ; 0 bit - looping, 1 bit - pt2 file
  49++64F1 21 59 65         ld hl, pt2Ext1
  49++64F4 CD F2 63       call CompareBuff.search
  49++64F7 A7             and a
  49++64F8 20 43          jr nz, .music
  50++64FA 21 5E 65         ld hl, pt2Ext2
  50++64FD CD F2 63       call CompareBuff.search
  50++6500 A7             and a
  50++6501 20 3A          jr nz, .music
  51++6503 3E 01            ld a, 1
  51++6505 32 9A 94       ld (VTPL.SETUP), a
  52++6508 21 4F 65         ld hl, pt3Ext1
  52++650B CD F2 63       call CompareBuff.search
  52++650E A7             and a
  52++650F 20 2C          jr nz, .music
  53++6511 21 54 65         ld hl, pt3Ext2
  53++6514 CD F2 63       call CompareBuff.search
  53++6517 A7             and a
  53++6518 20 23          jr nz, .music
  54++651A
  55++651A                  ; General Sound support
  56++651A                  ifdef GS
  57++651A 21 63 65         ld hl, modExt1
  57++651D CD F2 63       call CompareBuff.search
  57++6520 A7             and a
  57++6521 20 1E          jr nz, .mod
  58++6523 21 68 65         ld hl, modExt2
  58++6526 CD F2 63       call CompareBuff.search
  58++6529 A7             and a
  58++652A 20 15          jr nz, .mod
  59++652C                  endif
  60++652C
  61++652C              .checkExit
  62++652C E1               pop hl
  63++652D              .downExit
  64++652D 3E 01            ld a, MIME_DOWNLOAD
  64++652F C9             ret
  65++6530              .page
  66++6530 3E 02            ld a, MIME_LINK
  66++6532 C9             ret
  67++6533              .text
  68++6533 3E 03            ld a, MIME_TEXT
  68++6535 C9             ret
  69++6536              .input
  70++6536 3E 04            ld a, MIME_INPUT
  70++6538 C9             ret
  71++6539              .image
  72++6539 E1               pop hl
  72++653A 3E 06          ld a, MIME_IMAGE
  72++653C C9             ret
  73++653D              .music
  74++653D E1               pop hl
  74++653E 3E 05          ld a, MIME_MUSIC
  74++6540 C9             ret
  75++6541              .mod
  76++6541 E1               pop hl
  76++6542 3E 07          ld a, MIME_MOD
  76++6544 C9             ret
  77++6545
  78++6545 2E 73 63 72  scrExt1 db ".scr", 0
  78++6549 00
  79++654A 2E 53 43 52  scrExt2 db ".SCR", 0
  79++654E 00
  80++654F
  81++654F 2E 70 74 33  pt3Ext1 db ".pt3", 0
  81++6553 00
  82++6554 2E 50 54 33  pt3Ext2 db ".PT3", 0
  82++6558 00
  83++6559 2E 70 74 32  pt2Ext1 db ".pt2", 0
  83++655D 00
  84++655E 2E 50 54 32  pt2Ext2 db ".PT2", 0
  84++6562 00
  85++6563 2E 6D 6F 64  modExt1 db ".mod", 0
  85++6567 00
  86++6568 2E 4D 4F 44  modExt2 db ".MOD", 0
  86++656C 00
  87++656D
  88++656D              toggleSaveMode
  89++656D C5           			push bc
  90++656E E5                       push hl
  91++656F D5                       push de
  92++6570 F5                       push af
  93++6571 CD 7E 6A     			call Console.waitForKeyUp
  94++6574 3E 00        saveMode	ld a,0 ;Open/Save files
  95++6576 EE 01        			xor 1
  96++6578 32 75 65     			ld (saveMode+1),a
  97++657B              printsavemode
  98++657B 11 00 01                 ld de, #0100
  99++657E CD 3A 60                 call TextMode.gotoXY
 100++6581 21 A2 65                 ld hl, playmodetext
 101++6584 3A 75 65                 ld a,(saveMode+1)
 102++6587 B7                       or a
 103++6588 CA 8E 65                 jp z, playmodeselect
 104++658B 21 96 65                 ld hl, savemodetext
 105++658E              playmodeselect
 106++658E CD BC 60                 call TextMode.printZ
 107++6591 F1           			pop af
 108++6592 D1                       pop de
 109++6593 E1                       pop hl
 110++6594 C1                       pop bc
 111++6595 C9           			ret
 112++6596
 113++6596              savemodetext
 114++6596 5B 53 61 76      db "[Save mode]",0
 114++659A 65 20 6D 6F
 114++659E 64 65 5D 00
 115++65A2              playmodetext
 116++65A2 5B 50 6C 61      db "[Play mode]",0
 116++65A6 79 20 6D 6F
 116++65AA 64 65 5D 00
# file closed: gopher/render/row.asm
   5++65AE                  include "buffer.asm"
# file opened: gopher/render/buffer.asm
   1++65AE              ; BC - line count
   2++65AE              findLine
   3++65AE 21 86 A0         ld hl, outputBuffer
   4++65B1              findLine2
   5++65B1 78               ld a,b
   6++65B2 B1               or c
   7++65B3 CA E0 65         jp z, .checkEmpty
   8++65B6              .loop
   9++65B6 7E               ld a, (hl)
  10++65B7 A7               and a
  11++65B8 CA E3 65         jp z, .nope
  12++65BB 23               inc hl
  13++65BC FE 0D            cp 13
  14++65BE CA D6 65         jp z, .checkLF  ;13
  15++65C1 FE 0A            cp 10
  15++65C3 CA C9 65       jp z, .nextCheck     ;10
  16++65C6 C3 B6 65         jp .loop
  17++65C9              .nextCheck
  18++65C9 A7               and a
  19++65CA CA E3 65         jp z, .nope
  20++65CD 0B               dec bc
  21++65CE 57               ld d,a
  22++65CF 78               ld a,b
  23++65D0 B1               or c
  24++65D1 7A               ld a,d
  25++65D2 C2 B6 65         jp nz, .loop
  26++65D5 C9               ret
  27++65D6              .checkLF
  28++65D6 7E               ld a, (hl)
  29++65D7 FE 0A            cp 10
  30++65D9 C2 C9 65         jp nz, .nextCheck    ;10
  31++65DC 23               inc hl
  32++65DD C3 C9 65         jp  .nextCheck
  33++65E0              .checkEmpty
  34++65E0 7E               ld a, (hl)
  34++65E1 A7             and a
  34++65E2 C0             ret nz
  35++65E3              .nope
  36++65E3 21 00 00         ld hl, 0
  36++65E6 C9             ret
  37++65E7
# file closed: gopher/render/buffer.asm
   6++65E7                  include "ui.asm"
# file opened: gopher/render/ui.asm
   1++65E7                  IFDEF ZXSCR
   2++65E7                      DEFINE LEFT_TAB "[D]omain:                                  "
   3++65E7                      DEFINE SCREEN_WIDTH 64
   4++65E7                      DEFINE SCREEN64
   5++65E7                  ENDIF
   6++65E7
   7++65E7                  IFDEF TIMEX     ;UNKNOWN fallback to 64
   8++65E7 ~                    DEFINE LEFT_TAB "[D]omain:                                  "
   9++65E7 ~                    DEFINE SCREEN_WIDTH 64
  10++65E7 ~                    DEFINE SCREEN64
  11++65E7                  ENDIF
  12++65E7
  13++65E7                  IFDEF TIMEX80
  14++65E7 ~                    DEFINE LEFT_TAB "[D]omain:                                                      "
  15++65E7 ~                    DEFINE SCREEN_WIDTH 85
  16++65E7 ~                    DEFINE SCREEN85
  17++65E7                  ENDIF
  18++65E7
  19++65E7                  IFDEF NEDOOS
  20++65E7 ~                    DEFINE LEFT_TAB "[D]omain:                                                  "
  21++65E7 ~                    DEFINE SCREEN_WIDTH 80
  22++65E7 ~                    DEFINE SCREEN80
  23++65E7                  ENDIF
  24++65E7
  25++65E7                  IFDEF MSX
  26++65E7 ~                    DEFINE LEFT_TAB "[D]omain:                                              "
  27++65E7 ~                    DEFINE SCREEN_WIDTH 80
  28++65E7 ~                    DEFINE SCREEN80
  29++65E7                  ENDIF
  30++65E7              prepareScreen:
  31++65E7 CD 1D 60         call TextMode.cls
  32++65EA 21 C1 66         ld hl, header
  32++65ED CD BC 60       call TextMode.printZ
  33++65F0 11 0A 00         ld de, #000A
  33++65F3 CD 3A 60       call TextMode.gotoXY
  34++65F6 21 93 89         ld hl, hostName
  34++65F9 CD BC 60       call TextMode.printZ
  35++65FC AF               xor a
  35++65FD CD 7B 60       call TextMode.highlightLine
  36++6600
  37++6600 C5               push bc
  38++6601 E5               push hl
  39++6602 D5               push de ; Dont remove, pops in printsavemode
  40++6603 F5               push af
  41++6604 CD 7B 65         call printsavemode
  42++6607 C9               ret
  43++6608
  44++6608              inputHost:
  45++6608 CD 7E 6A         	call Console.waitForKeyUp
  46++660B              .loop
  47++660B 11 0A 00         ld de, #000A
  47++660E CD 3A 60       call TextMode.gotoXY
  47++6611 21 93 89       ld hl, hostName
  47++6614 CD BC 60       call TextMode.printZ
  48++6617 3E 04            ld a, MIME_INPUT
  48++6619 CD A4 60       call TextMode.putC
  49++661C 3E 20            ld a, ' '
  49++661E CD A4 60       call TextMode.putC
  50++6621              .wait
  51++6621 CD 97 6A         call Console.getC
  52++6624 5F               ld e, a
  53++6625 FE 0C            cp Console.BACKSPACE
  53++6627 28 17          jr z, .removeChar
  54++6629 FE 0D            cp CR
  54++662B CA 4E 66       jp z, inputNavigate
  55++662E FE 20            cp 32
  55++6630 38 EF          jr c, .wait
  56++6632              .putC
  57++6632 AF               xor a
  57++6633 21 93 89 01    ld hl, hostName, bc, 48
  57++6637 30 00
  57++6639 ED B1          cpir
  58++663B 77               ld (hl), a
  58++663C 2B             dec hl
  58++663D 73             ld (hl), e
  59++663E 18 CB            jr .loop
  60++6640              .removeChar
  61++6640 AF               xor a
  62++6641 21 93 89 01      ld hl, hostName, bc, 48
  62++6645 30 00
  62++6647 ED B1          cpir
  63++6649 2B               dec hl
  63++664A 2B             dec hl
  63++664B 77             ld (hl), a
  64++664C 18 BD            jr .loop
  65++664E
  66++664E              inputNavigate:
  67++664E 21 93 89 11      ld hl, hostName, de, domain
  67++6652 81 66
  68++6654 7E               ld a,(hl)
  69++6655 A7               and a
  70++6656 CA 0C 74         jp z, History.load
  71++6659              .loop
  72++6659 7E               ld a, (hl)
  72++665A A7             and a
  72++665B 28 05          jr z, .complete
  73++665D 12               ld (de), a
  73++665E 23 13          inc hl, de
  74++6660 18 F7            jr .loop
  75++6662              .complete
  76++6662 3E 09            ld a, TAB
  76++6664 12             ld (de), a
  76++6665 13             inc de
  77++6666 3E 37            ld a, '7'
  77++6668 12             ld (de), a
  77++6669 13             inc de
  78++666A 3E 30            ld a, '0'
  78++666C 12             ld (de), a
  78++666D 13             inc de
  79++666E 3E 0D            ld a, CR
  79++6670 12             ld (de), a
  79++6671 13             inc de
  80++6672 3E 0A            ld a, LF
  80++6674 12             ld (de), a
  80++6675 13             inc de
  81++6676 21 7C 66         ld hl, navRow
  81++6679 C3 65 74       jp History.navigate
  82++667C
  83++667C 31 20 09 2F  navRow db "1 ", TAB, "/", TAB
  83++6680 09
  84++6681 6E 69 68 69  domain db "nihirash.net"
  84++6685 72 61 73 68
  84++6689 2E 6E 65 74
  85++668D 00 00 00...      ds 64 - ($ - domain)
  86++66C1
  87++66C1 5B 44 5D 6F  header db "[D]omain:                                  ", "MRF "
  87++66C5 6D 61 69 6E
  87++66C9 3A 20 20 20
  87++66CD 20 20 20 20
  87++66D1 20 20 20 20
  87++66D5 20 20 20 20
  87++66D9 20 20 20 20
  87++66DD 20 20 20 20
  87++66E1 20 20 20 20
  87++66E5 20 20 20 20
  87++66E9 20 20 20 4D
  87++66ED 52 46 20
  88++66F0 31 2E 37            db "1.7"
  89++66F3 2E                  db "."
  90++66F4 32 38               db "28"
  91++66F6              	IFDEF MSX
  92++66F6 ~                   db "    [MSX UNAPI]"
  93++66F6              	ENDIF
  94++66F6
  95++66F6                  IFDEF MB03
  96++66F6 ~                   db " [MB03+]"
  97++66F6                     ENDIF
  98++66F6
  99++66F6                  IFDEF UNO
 100++66F6 ~                   db " [UNO UART]"
 101++66F6                  ENDIF
 102++66F6
 103++66F6                  IFDEF AY
 104++66F6 20 5B 41 59         db " [AYWiFi]"
 104++66FA 57 69 46 69
 104++66FE 5D
 105++66FF              	ENDIF
 106++66FF
 107++66FF                  IFDEF ZW
 108++66FF ~                   db "  [ZXWiFi]"
 109++66FF                  ENDIF
 110++66FF
 111++66FF                   IFDEF UARTATM
 112++66FF ~                   db " [ATM UART]"
 113++66FF                  ENDIF
 114++66FF
 115++66FF                  IFDEF UARTEVO
 116++66FF ~                    db " [EVO UART]"
 117++66FF                  ENDIF
 118++66FF
 119++66FF                  IFDEF UNOUART
 120++66FF ~                    db " [UNO UART]"
 121++66FF                  ENDIF
 122++66FF
 123++66FF                  IFDEF NEDONET
 124++66FF ~            	    db "  [nedoNET]"
 125++66FF              	ENDIF
 126++66FF
 127++66FF                  IFDEF AY56
 128++66FF ~            	    db " [AYWiFi56]"
 129++66FF              	ENDIF
 130++66FF 0D 00                db 13, 0
# file closed: gopher/render/ui.asm
   7++6701                  include "gopher-page.asm"
# file opened: gopher/render/gopher-page.asm
   1++6701              renderGopherScreen:
   2++6701 3E FF            ld a, 255
   3++6703 32 52 93         ld (oldminutes), a
   4++6706 CD E7 65         call Render.prepareScreen
   5++6709
   6++6709 2A 80 78         ld hl, (page_offset)        ; HL - offset to 0 Row on screen
   7++670C 44 4D            ld bc,hl                    ; BC - offset to C Row on screen
   8++670E CD AE 65         call Render.findLine        ;BC - Search this line  HL - Return pointer to page with offset
   9++6711 7C               ld a, h
  10++6712 B5               or l
  11++6713 28 21            jr z, .exit2
  12++6715 7B               ld a, e
  13++6716 AF               xor a
  14++6717 E5               push hl
  15++6718 CD 79 64         call renderRow
  16++671B E1               pop hl
  17++671C
  18++671C 06 15            ld b, PER_PAGE-1
  19++671E
  20++671E              .loop
  21++671E C5               push bc
  22++671F 3E 16            ld a, PER_PAGE
  23++6721 90               sub b
  24++6722 5F               ld e,a
  25++6723
  26++6723 01 01 00         ld bc, 1
  27++6726
  28++6726 CD B1 65         call Render.findLine2   ;BC - Search this line  HL - Return pointer to page with offset
  29++6729
  30++6729 7C               ld a, h
  31++672A B5               or l
  32++672B 28 06            jr z, .exit
  33++672D 7B               ld a, e
  34++672E E5               push hl
  35++672F CD 79 64         call renderRow
  36++6732 E1               pop hl
  37++6733              .exit
  38++6733 C1               pop bc
  39++6734 10 E8            djnz .loop
  40++6736              .exit2
  41++6736 CD 45 68         call showCursor
  42++6739 C9               ret
  43++673A
  44++673A              checkBorder:
  45++673A 3A 7E 78         ld a, (cursor_position)
  45++673D FE FF          cp #ff
  45++673F CA 69 68       jp z, pageUp
  46++6742 3A 7E 78         ld a, (cursor_position)
  46++6745 FE 16          cp PER_PAGE
  46++6747 CA 9C 68       jp z, pageDn
  47++674A CD 45 68         call showCursor
  48++674D C3 50 67         jp workLoop
  49++6750
  50++6750              workLoop:
  51++6750 3A 8F 69         ld a, (play_next)
  51++6753 A7             and a
  51++6754 C2 F5 67       jp nz, navigate
  52++6757
  53++6757                  dup 4
  54++6757 76          >    halt
  54++6758 76          >    halt
  54++6759 76          >    halt
  54++675A 76          >    halt
  55++675B                  edup
  56++675B              .nothing
  57++675B
  58++675B 76               halt
  59++675C CD 51 93         call printRTC
  60++675F
  61++675F CD A8 6A         call Console.peekC
  62++6762 A7               and a
  62++6763 CA 5B 67       jp z, .nothing
  63++6766
  64++6766 FE 31            cp '1'
  64++6768 CA F5 73       jp z, History.back
  65++676B FE 32            cp '2'
  65++676D CA F5 67       jp z, navigate
  66++6770 FE 33            cp '3'
  66++6772 CA 55 68       jp z, cursorDown
  67++6775 FE 34            cp '4'
  67++6777 CA 5F 68       jp z, cursorUp
  68++677A FE 35            cp '5'
  68++677C CA 69 68       jp z, pageUp
  69++677F FE 38            cp '8'
  69++6781 CA 9C 68       jp z, pageDn
  70++6784 FE 36            cp '6'
  70++6786 CA 55 68       jp z, cursorDown
  71++6789 FE 37            cp '7'
  71++678B CA 5F 68       jp z, cursorUp
  72++678E
  73++678E FE 0A            cp Console.KEY_DN
  73++6790 CA 55 68       jp z, cursorDown
  74++6793 FE 61            cp 'a'
  74++6795 CA 55 68       jp z, cursorDown
  75++6798 FE 0B            cp Console.KEY_UP
  75++679A CA 5F 68       jp z, cursorUp
  76++679D FE 71            cp 'q'
  76++679F CA 5F 68       jp z, cursorUp
  77++67A2 FE 08            cp Console.KEY_LT
  77++67A4 CA 69 68       jp z, pageUp
  78++67A7 FE 6F            cp 'o'
  78++67A9 CA 69 68       jp z, pageUp
  79++67AC FE 09            cp Console.KEY_RT
  79++67AE CA 9C 68       jp z, pageDn
  80++67B1 FE 70            cp 'p'
  80++67B3 CA 9C 68       jp z, pageDn
  81++67B6
  82++67B6 FE 68            cp 'h'
  82++67B8 CA 62 74       jp z, History.home
  83++67BB FE 48            cp 'H'
  83++67BD CA 62 74       jp z, History.home
  84++67C0
  85++67C0 FE 62            cp 'b'
  85++67C2 CA F5 73       jp z, History.back
  86++67C5 FE 42            cp 'B'
  86++67C7 CA F5 73       jp z, History.back
  87++67CA FE 0C            cp Console.BACKSPACE
  87++67CC CA F5 73       jp z, History.back
  88++67CF
  89++67CF FE 64            cp 'd'
  89++67D1 CA 08 66       jp z, inputHost
  90++67D4 FE 44            cp 'D'
  90++67D6 CA 08 66       jp z, inputHost
  91++67D9
  92++67D9 FE 0D            cp CR
  92++67DB CA F5 67       jp z, navigate
  93++67DE
  94++67DE FE 53            cp 'S'
  94++67E0 CC 6D 65       call z, toggleSaveMode
  95++67E3 FE 73        	cp 's'
  95++67E5 CC 6D 65       call z, toggleSaveMode
  96++67E8
  97++67E8
  98++67E8                  IFDEF MSX
  99++67E8 ~                	cp ESC
  99++67E8 ~              jp z, exit
 100++67E8                  ENDIF
 101++67E8
 102++67E8                  IFDEF GS
 103++67E8 FE 4D            cp 'M'
 103++67EA CC 45 93       call z, GeneralSound.toggleModule
 104++67ED FE 6D            cp 'm'
 104++67EF CC 45 93       call z, GeneralSound.toggleModule
 105++67F2                  ENDIF
 106++67F2
 107++67F2                  IFDEF TIMEX80
 108++67F2 ~                cp 'T'
 108++67F2 ~              call z, TextMode.toggleColor
 109++67F2 ~                cp 't'
 109++67F2 ~              call z, TextMode.toggleColor
 110++67F2                  ENDIF
 111++67F2
 112++67F2 C3 50 67         jp workLoop
 113++67F5
 114++67F5              navigate:
 115++67F5 CD 7E 6A         call Console.waitForKeyUp
 116++67F8 AF               xor a
 116++67F9 32 8F 69       ld (play_next), a
 117++67FC CD 4D 68         call hideCursor
 118++67FF ED 4B 80 78      ld bc, (page_offset)
 119++6803 2A 7E 78         ld hl, (cursor_position)
 120++6806 09               add hl,bc
 121++6807 44               ld b, h ;HHHHH
 122++6808 4D               ld c, l ;LLLLL
 123++6809 D5               push de
 124++680A CD AE 65         call Render.findLine
 125++680D D1               pop de
 126++680E 7E               ld a, (hl)
 127++680F FE 31            cp '1'
 127++6811 CA 2E 68       jp z, .load
 128++6814 FE 30            cp '0'
 128++6816 CA 2E 68       jp z, .load
 129++6819 FE 39            cp '9'
 129++681B CA 2E 68       jp z, .load
 130++681E FE 37            cp '7'
 130++6820 CA 36 68       jp z, .input
 131++6823 FE 73            cp MIME_SOUND
 131++6825 CA 2E 68       jp z, .load
 132++6828 CD 45 68         call showCursor
 133++682B C3 50 67         jp workLoop
 134++682E              .load
 135++682E E5               push hl
 136++682F CD 8E 64         call getIcon
 137++6832 E1               pop hl
 138++6833 C3 65 74         jp History.navigate
 139++6836              .input
 140++6836 E5               push hl
 141++6837 CD 90 69         call DialogBox.inputBox
 142++683A E1               pop hl
 143++683B 3A F5 69         ld a, (DialogBox.inputBuffer)
 143++683E A7             and a
 143++683F CA 0C 74       jp z, History.load
 144++6842 C3 2E 68         jp .load
 145++6845
 146++6845              showCursor:
 147++6845 3A 7E 78         ld a, (cursor_position)
 147++6848 C6 02          add CURSOR_OFFSET
 148++684A C3 7B 60         jp TextMode.highlightLine
 149++684D
 150++684D              hideCursor:
 151++684D 3A 7E 78         ld a, (cursor_position)
 151++6850 C6 02          add CURSOR_OFFSET
 152++6852 C3 61 60         jp TextMode.usualLine
 153++6855
 154++6855              cursorDown:
 155++6855 CD 4D 68         call hideCursor
 156++6858 21 7E 78         ld hl, cursor_position
 157++685B 34               inc (hl)
 158++685C C3 3A 67         jp checkBorder
 159++685F
 160++685F              cursorUp:
 161++685F CD 4D 68         call hideCursor
 162++6862 21 7E 78         ld hl, cursor_position
 163++6865 35               dec (hl)
 164++6866 C3 3A 67         jp checkBorder
 165++6869
 166++6869              pageUp:
 167++6869 3A 80 78         ld a, (page_offset)
 167++686C FE 00          cp 0
 167++686E C2 7C 68       jp nz, .pageUp2
 168++6871 3A 81 78         ld a, (page_offset + 1)
 168++6874 FE 00          cp 0
 168++6876 C2 7C 68       jp nz, .pageUp2
 169++6879 C3 92 68         jp .skip
 170++687C              .pageUp2:
 171++687C 3E 15            ld a, PER_PAGE - 1
 171++687E 32 7E 78       ld (cursor_position), a
 172++6881 2A 80 78         ld hl, (page_offset)
 173++6884 11 16 00         ld de,PER_PAGE
 174++6887 ED 52            sbc hl,de
 175++6889 22 80 78         ld (page_offset), hl
 176++688C              .exit
 177++688C CD 01 67         call renderGopherScreen
 178++688F C3 50 67         jp workLoop
 179++6892              .skip
 180++6892 AF               xor a
 180++6893 32 7E 78       ld (cursor_position), a
 180++6896 CD 01 67       call renderGopherScreen
 180++6899 C3 50 67       jp workLoop
 181++689C
 182++689C              pageDn:
 183++689C AF                xor a
 183++689D 32 7E 78       ld (cursor_position), a
 184++68A0 2A 80 78         ld hl,(page_offset)
 185++68A3 11 16 00         ld de,PER_PAGE
 186++68A6 19               add hl,de
 187++68A7 22 80 78         ld (page_offset), hl
 188++68AA C3 8C 68         jp pageUp.exit
 189++68AD
# file closed: gopher/render/gopher-page.asm
   8++68AD                  include "plaintext.asm"
# file opened: gopher/render/plaintext.asm
   1++68AD              renderPlainTextScreen:
   2++68AD 3E FF            ld a, 255
   3++68AF 32 52 93         ld (oldminutes), a
   4++68B2 CD E7 65         call prepareScreen
   5++68B5
   6++68B5 2A 80 78         ld hl, (page_offset)        ; HL - offset to 0 Row on screen
   7++68B8 44 4D            ld bc,hl                    ; BC - offset to C Row on screen
   8++68BA CD AE 65         call Render.findLine        ;BC - Search this line  HL - Return pointer to page with offset
   9++68BD 7C               ld a, h
  10++68BE B5               or l
  11++68BF 28 30            jr z, .exit2
  12++68C1 AF               xor a
  13++68C2 C6 02            add CURSOR_OFFSET
  13++68C4 57 1E 01       ld d, a, e, 1
  13++68C7 CD 3A 60       call TextMode.gotoXY
  14++68CA CD 48 64         call print70Text
  15++68CD 06 15            ld b, PER_PAGE -1
  16++68CF              .loop
  17++68CF C5               push bc
  18++68D0 3E 16            ld a, PER_PAGE
  19++68D2 90               sub b
  20++68D3 5F               ld e,a
  21++68D4 01 01 00         ld bc, 1
  22++68D7 CD B1 65         call Render.findLine2   ;BC - Search this line  HL - Return pointer to page with offset
  23++68DA 7C               ld a, h
  24++68DB B5               or l
  25++68DC 28 10            jr z, .exit
  26++68DE 7B               ld a, e
  27++68DF C6 02            add CURSOR_OFFSET
  27++68E1 57 1E 01       ld d, a, e, 1
  27++68E4 CD 3A 60       call TextMode.gotoXY
  28++68E7 CD 48 64         call print70Text
  29++68EA C1               pop bc
  30++68EB 10 E2            djnz .loop
  31++68ED C9               ret
  32++68EE              .exit
  33++68EE C1               pop bc
  34++68EF 10 DE            djnz .loop
  35++68F1              .exit2
  36++68F1 CD 45 68         call showCursor
  37++68F4 C9               ret
  38++68F5              plainTextLoop:
  39++68F5 CD 51 93         call printRTC
  40++68F8 CD 97 6A         call Console.getC
  41++68FB
  42++68FB FE 31            cp '1'
  42++68FD CA F5 73       jp z, History.back
  43++6900 FE 32            cp '2'
  43++6902 CA F5 67       jp z, navigate
  44++6905 FE 35            cp '5'
  44++6907 CA 6D 69       jp z, textUp
  45++690A FE 38            cp '8'
  45++690C CA 5D 69       jp z, textDown
  46++690F FE 08            cp Console.KEY_LT
  46++6911 CA 6D 69       jp z, textUp
  47++6914 FE 09            cp Console.KEY_RT
  47++6916 CA 5D 69       jp z, textDown
  48++6919
  49++6919 FE 0A            cp Console.KEY_DN
  49++691B CA 5D 69       jp z, textDown
  50++691E FE 61            cp 'a'
  50++6920 CA 5D 69       jp z, textDown
  51++6923
  52++6923 FE 0B            cp Console.KEY_UP
  52++6925 CA 6D 69       jp z, textUp
  53++6928 FE 71            cp 'q'
  53++692A CA 6D 69       jp z, textUp
  54++692D
  55++692D FE 68            cp 'h'
  55++692F CA 62 74       jp z, History.home
  56++6932 FE 48            cp 'H'
  56++6934 CA 62 74       jp z, History.home
  57++6937
  58++6937 FE 62            cp 'b'
  58++6939 CA F5 73       jp z, History.back
  59++693C FE 42            cp 'B'
  59++693E CA F5 73       jp z, History.back
  60++6941
  61++6941 FE 64            cp 'd'
  61++6943 CA 08 66       jp z, inputHost
  62++6946 FE 44            cp 'D'
  62++6948 CA 08 66       jp z, inputHost
  63++694B
  64++694B FE 0C            cp Console.BACKSPACE
  64++694D CA F5 73       jp z, History.back
  65++6950
  66++6950                  IFDEF MSX
  67++6950 ~                	cp ESC
  67++6950 ~              jp z, exit
  68++6950                  ENDIF
  69++6950
  70++6950                  IFDEF GS
  71++6950 FE 4D            cp 'M'
  71++6952 CC 45 93       call z, GeneralSound.toggleModule
  72++6955 FE 6D            cp 'm'
  72++6957 CC 45 93       call z, GeneralSound.toggleModule
  73++695A                  ENDIF
  74++695A
  75++695A                  IFDEF TIMEX80
  76++695A ~                cp 'T'
  76++695A ~              call z, TextMode.toggleColor
  77++695A ~                cp 't'
  77++695A ~              call z, TextMode.toggleColor
  78++695A                  ENDIF
  79++695A
  80++695A C3 F5 68         jp plainTextLoop
  81++695D
  82++695D
  83++695D              textDown:
  84++695D 2A 80 78         ld hl,(page_offset)
  85++6960 11 16 00         ld de,PER_PAGE
  86++6963 19               add hl,de
  87++6964 22 80 78         ld (page_offset), hl
  88++6967 CD AD 68         call renderPlainTextScreen
  89++696A C3 F5 68         jp plainTextLoop
  90++696D
  91++696D              textUp:
  92++696D 3A 80 78         ld a, (page_offset)
  92++6970 FE 00          cp 0
  92++6972 20 0A          jr nz, .textUp2
  93++6974 3A 81 78         ld a, (page_offset + 1)
  93++6977 FE 00          cp 0
  93++6979 20 03          jr nz, .textUp2
  94++697B C3 F5 68         jp plainTextLoop
  95++697E
  96++697E              .textUp2:
  97++697E 2A 80 78         ld hl,(page_offset)
  98++6981 11 16 00         ld de,PER_PAGE
  99++6984 ED 52            sbc hl,de
 100++6986 22 80 78         ld (page_offset), hl
 101++6989 CD AD 68         call renderPlainTextScreen
 102++698C C3 F5 68         jp plainTextLoop
 103++698F
# file closed: gopher/render/plaintext.asm
   9++698F
  10++698F 00           play_next       db  0
  11++6990              position        EQU historyBlock.position
  12++6990              cursor_position EQU position + 2
  13++6990              page_offset     EQU position + 4
  14++6990
  15++6990                  ENDMODULE
  16++6990
  17++6990                  include "dialogbox.asm"
# file opened: gopher/render/dialogbox.asm
   1++6990                  module DialogBox
   2++6990
   3++6990              inputBox:
   4++6990 AF               xor a
   4++6991 32 F5 69       ld (inputBuffer), a
   5++6994              .noclear
   6++6994 CD 56 6A         call drawBox
   7++6997              .loop
   8++6997 11 05 0B         ld de, #0B05
   8++699A CD 3A 60       call TextMode.gotoXY
   9++699D 21 F5 69         ld hl, inputBuffer
   9++69A0 CD BC 60       call TextMode.printZ
  10++69A3 3E 04            ld a, MIME_INPUT
  10++69A5 CD A4 60       call TextMode.putC
  10++69A8 3E 20          ld a, ' '
  10++69AA CD A4 60       call TextMode.putC
  11++69AD              .checkkey
  12++69AD CD A8 6A         call Console.peekC
  13++69B0 FE 00            cp 00
  13++69B2 CA AD 69        jp z, .checkkey
  14++69B5 FE 0D            cp CR
  14++69B7 C8             ret z
  15++69B8
  16++69B8                  IFNDEF MSX
  17++69B8                  dup 11
  18++69B8 76          >    halt
  18++69B9 76          >    halt
  18++69BA 76          >    halt
  18++69BB 76          >    halt
  18++69BC 76          >    halt
  18++69BD 76          >    halt
  18++69BE 76          >    halt
  18++69BF 76          >    halt
  18++69C0 76          >    halt
  18++69C1 76          >    halt
  18++69C2 76          >    halt
  19++69C3                  edup
  20++69C3                  ENDIF
  21++69C3
  22++69C3 FE 0C            cp Console.BACKSPACE
  22++69C5 28 13          jr z, .removeChar
  23++69C7 FE 20            cp SPACE
  23++69C9 38 E2          jr c, .checkkey
  24++69CB              .putC
  25++69CB 5F               ld e, a
  26++69CC AF               xor a
  26++69CD 21 F5 69 01    ld hl, inputBuffer, bc, #ff
  26++69D1 FF 00
  26++69D3 ED B1          cpir
  27++69D5 77               ld (hl), a
  27++69D6 2B             dec hl
  27++69D7 73             ld (hl), e
  28++69D8 18 BD            jr .loop
  29++69DA              .removeChar
  30++69DA AF               xor a
  31++69DB 21 F5 69 01      ld hl, inputBuffer, bc, #ff
  31++69DF FF 00
  31++69E1 ED B1          cpir
  32++69E3 E5               push hl
  33++69E4 11 F6 69             ld de, inputBuffer + 1
  34++69E7 B7                   or a
  34++69E8 ED 52          sbc hl, de
  35++69EA 7C                   ld a, h
  35++69EB B5             or l
  36++69EC E1               pop hl
  37++69ED 28 A8            jr z, .loop
  38++69EF AF               xor a
  39++69F0 2B               dec hl
  39++69F1 2B             dec hl
  39++69F2 77             ld (hl), a
  40++69F3 18 A2            jr .loop
  41++69F5
  42++69F5
  43++69F5              namedownload
  44++69F5                  IFDEF NEDOOS
  45++69F5 ~            		db "..",92,"downloads",92
  46++69F5                  ENDIF
  47++69F5
  48++69F5 00 00 00...  inputBuffer ds 80
  49++6A45
  50++6A45              msgBox:
  51++6A45 CD 4E 6A         call msgNoWait
  52++6A48 06 96            ld b, 150
  53++6A4A              .loop
  54++6A4A 76               halt
  55++6A4B 10 FD            djnz .loop
  56++6A4D C9               ret
  57++6A4E
  58++6A4E              msgNoWait:
  59++6A4E E5               push hl
  60++6A4F CD 56 6A         call drawBox
  61++6A52 E1               pop hl
  62++6A53 C3 BC 60         jp TextMode.printZ
  63++6A56
  64++6A56              drawBox:
  65++6A56 26 0A 3E 09      ld h, #0a, a, BORDER_TOP
  66++6A5A CD 47 60         call TextMode.fillLine
  67++6A5D 26 0B 3E 20      ld h, #0b, a, ' '
  68++6A61 CD 47 60         call TextMode.fillLine
  69++6A64 26 0C 3E 08      ld h, #0c, a, BORDER_BOTTOM
  70++6A68 CD 47 60         call TextMode.fillLine
  71++6A6B 3E 0A            ld a, #0a
  72++6A6D CD 7B 60         call TextMode.highlightLine
  73++6A70 3E 0C            ld a, #0c
  74++6A72 CD 7B 60         call TextMode.highlightLine
  75++6A75 11 03 0B         ld de,#0B03
  76++6A78 CD 3A 60         call TextMode.gotoXY
  77++6A7B C9               ret
  78++6A7C                  endmodule
  79++6A7C
# file closed: gopher/render/dialogbox.asm
# file closed: gopher/render/index.asm
  18+ 6A7C                  include "dos/index.asm"
# file opened: dos/index.asm
   1++6A7C              	IFDEF NEDOOS
   2++6A7C ~            	    include "nedoconsole.asm"
   3++6A7C ~            		include "nedoos.asm"
   4++6A7C              	ENDIF
   5++6A7C
   6++6A7C              	IFDEF TRDOS
   7++6A7C                  	include "console.asm"
# file opened: dos/console.asm
   1++6A7C                  module Console
   2++6A7C              KEY_UP = 11
   3++6A7C              KEY_DN = 10
   4++6A7C              KEY_LT = 8
   5++6A7C              KEY_RT = 9
   6++6A7C              BACKSPACE = 12
   7++6A7C              BASIC_KEY = #5C08
   8++6A7C 00           keyCode db 0
   9++6A7D 00           tableShift db 0
  10++6A7E
  11++6A7E              waitForKeyUp:
  12++6A7E 76           	halt
  13++6A7F AF              xor a
  13++6A80 DB FE          in a, (#fe)
  13++6A82 2F             cpl
  13++6A83 E6 1F          and 31
  13++6A85 20 F7          jr nz, waitForKeyUp
  14++6A87 32 08 5C        ld (BASIC_KEY), a
  15++6A8A C9              ret
  16++6A8B
  17++6A8B              keyWait:
  18++6A8B                  dup 11
  19++6A8B 76          >    halt
  19++6A8C 76          >    halt
  19++6A8D 76          >    halt
  19++6A8E 76          >    halt
  19++6A8F 76          >    halt
  19++6A90 76          >    halt
  19++6A91 76          >    halt
  19++6A92 76          >    halt
  19++6A93 76          >    halt
  19++6A94 76          >    halt
  19++6A95 76          >    halt
  20++6A96                  edup
  21++6A96 C9              ret
  22++6A97
  23++6A97              getC:
  24++6A97              getCint:       ; for nedoOS
  25++6A97 AF              xor a
  26++6A98 32 08 5C        ld (BASIC_KEY),a
  27++6A9B              getC2:
  28++6A9B 3A 08 5C        ld a,(BASIC_KEY)
  29++6A9E A7              and a
  29++6A9F 28 FA          jr z, getC2
  30++6AA1 47              ld b,a
  31++6AA2 AF              xor a
  31++6AA3 32 08 5C       ld (BASIC_KEY), a
  32++6AA6 78              ld a, b
  33++6AA7 C9              ret
  34++6AA8              ;0xE - to Russian
  35++6AA8              ;0xF - to Englich
  36++6AA8              peekC:
  37++6AA8 AF               xor a
  37++6AA9 32 08 5C       ld (BASIC_KEY),a
  38++6AAC CD CC 6A         call inkey
  39++6AAF FE 0E            cp 0xE
  40++6AB1 CA BA 6A         jp z, toRus
  41++6AB4 FE 0F            cp 0xF
  42++6AB6 CA C4 6A         jp z, toEng
  43++6AB9 C9               ret
  44++6ABA              toRus
  45++6ABA 3E A0           ld a, russiantable - englishTable
  46++6ABC 32 7D 6A        ld (tableShift), a
  47++6ABF AF              xor a
  48++6AC0 CD 8B 6A        call keyWait
  49++6AC3 C9              ret
  50++6AC4              toEng
  51++6AC4 AF              xor a
  52++6AC5 32 7D 6A        ld (tableShift), a
  53++6AC8 CD 8B 6A        call keyWait
  54++6ACB C9              ret
  55++6ACC
  56++6ACC              inkey:
  57++6ACC 11 00 00        ld de,0
  58++6ACF 01 FE FE        ld bc,$fefe
  59++6AD2 ED 78           in a,(c)
  60++6AD4 F6 E1           or $e1
  61++6AD6 FE FF           cp $ff
  62++6AD8 20 57           jr nz, .keyhitA
  63++6ADA
  64++6ADA 1E 05           ld e,5
  65++6ADC 06 FD           ld b,$fd
  66++6ADE ED 78           in a,(c)
  67++6AE0 F6 E0           or $e0
  68++6AE2 FE FF           cp $ff
  69++6AE4 20 4B           jr nz, .keyhitA
  70++6AE6
  71++6AE6 1E 0A           ld e,10
  72++6AE8 06 FB           ld b,$fb
  73++6AEA ED 78           in a,(c)
  74++6AEC F6 E0           or $e0
  75++6AEE FE FF           cp $ff
  76++6AF0 20 3F           jr nz, .keyhitA
  77++6AF2
  78++6AF2 1E 0F           ld e,15
  79++6AF4 06 F7           ld b,$f7
  80++6AF6 ED 78           in a,(c)
  81++6AF8 F6 E0           or $e0
  82++6AFA FE FF           cp $ff
  83++6AFC 20 33           jr nz, .keyhitA
  84++6AFE
  85++6AFE 1E 14           ld e,20
  86++6B00 06 EF           ld b,$ef
  87++6B02 ED 78           in a,(c)
  88++6B04 F6 E0           or $e0
  89++6B06 FE FF           cp $ff
  90++6B08 20 27           jr nz, .keyhitA
  91++6B0A
  92++6B0A 1E 19           ld e,25
  93++6B0C 06 DF           ld b,$df
  94++6B0E ED 78           in a,(c)
  95++6B10 F6 E0           or $e0
  96++6B12 FE FF           cp $ff
  97++6B14 20 1B           jr nz, .keyhitA
  98++6B16
  99++6B16 1E 1E           ld e,30
 100++6B18 06 BF           ld b,$bf
 101++6B1A ED 78           in a,(c)
 102++6B1C F6 E0           or $e0
 103++6B1E FE FF           cp $ff
 104++6B20 20 0F           jr nz, .keyhitA
 105++6B22
 106++6B22 1E 23           ld e,35
 107++6B24 06 7F           ld b,$7f
 108++6B26 ED 78           in a,(c)
 109++6B28 F6 E2           or $e2
 110++6B2A FE FF           cp $ff
 111++6B2C 4F              ld c,a
 112++6B2D 20 19           jr nz, .keyhitB
 113++6B2F
 114++6B2F              .nokey
 115++6B2F AF              xor a
 116++6B30 C9              ret
 117++6B31
 118++6B31              .keyhitA
 119++6B31
 120++6B31 4F              ld c,a
 121++6B32
 122++6B32 78              ld a,b
 123++6B33 2F              cpl
 124++6B34 F6 81           or $81
 125++6B36 DB FE           in a,($fe)
 126++6B38 F6 E0           or $e0
 127++6B3A FE FF           cp $ff
 128++6B3C 20 F1           jr nz, .nokey
 129++6B3E
 130++6B3E 3E 7F           ld a,$7f
 131++6B40 DB FE           in a,($fe)
 132++6B42 F6 E2           or $e2
 133++6B44 FE FF           cp $ff
 134++6B46 20 E7           jr nz, .nokey
 135++6B48
 136++6B48              .keyhitB
 137++6B48
 138++6B48 06 00           ld b,0
 139++6B4A 21 96 6A        ld hl,.rowtbl-$e0
 140++6B4D 09              add hl,bc
 141++6B4E 7E              ld a,(hl)
 142++6B4F FE 05           cp 5
 143++6B51 30 DC           jr nc, .nokey
 144++6B53 83              add a,e
 145++6B54 5F              ld e,a
 146++6B55
 147++6B55 21 96 6B        ld  hl, englishTable
 148++6B58 19              add hl, de
 149++6B59 3A 7D 6A        ld  a, (tableShift)
 150++6B5C 5F              ld e, a
 151++6B5D 19              add hl, de
 152++6B5E 3E FE           ld a,$fe
 153++6B60 DB FE           in a,($fe)
 154++6B62 E6 01           and $01
 155++6B64 20 03           jr nz, .nocaps
 156++6B66 1E 28           ld e,40
 157++6B68 19              add hl,de
 158++6B69
 159++6B69              .nocaps
 160++6B69
 161++6B69 3E 7F           ld a,$7f
 162++6B6B DB FE           in a,($fe)
 163++6B6D E6 02           and $02
 164++6B6F 20 03           jr nz, .nosym
 165++6B71 1E 50           ld e,80
 166++6B73 19              add hl,de
 167++6B74
 168++6B74              .nosym
 169++6B74
 170++6B74 7E              ld a,(hl)
 171++6B75 C9              ret
 172++6B76
 173++6B76              .rowtbl
 174++6B76 FF FF FF FF     defb 255,255,255,255,255,255,255
 174++6B7A FF FF FF
 175++6B7D FF FF FF FF     defb 255,255,255,255,255,255,255,255
 175++6B81 FF FF FF FF
 176++6B85 04 FF FF FF     defb 4,255,255,255,255,255,255
 176++6B89 FF FF FF
 177++6B8C FF 03 FF FF     defb 255,3,255,255,255,2,255,1
 177++6B90 FF 02 FF 01
 178++6B94 00 FF           defb 0,255
 179++6B96
 180++6B96              englishTable
 181++6B96 00 7A 78 63     db 0,'z','x','c','v'      ; CAPS SHIFT, Z, X, C, V
 181++6B9A 76
 182++6B9B 61 73 64 66     db 'a','s','d','f','g'      ; A, S, D, F, G
 182++6B9F 67
 183++6BA0 71 77 65 72     db 'q','w','e','r','t'      ; Q, W, E, R, T
 183++6BA4 74
 184++6BA5 31 32 33 34     db '1','2','3','4','5'      ; 1, 2, 3, 4, 5
 184++6BA9 35
 185++6BAA 30 39 38 37     db '0','9','8','7','6'      ; 0, 9, 8, 7, 6
 185++6BAE 36
 186++6BAF 70 6F 69 75     db 'p','o','i','u','y'      ; P, O, I, U, Y
 186++6BB3 79
 187++6BB4 0D 6C 6B 6A     db 13,'l','k','j','h'       ; ENTER, L, K, J, H
 187++6BB8 68
 188++6BB9 20 00 6D 6E     db ' ',0,'m','n','b'      ; SPACE, SYM SHIFT, M, N, B
 188++6BBD 62
 189++6BBE
 190++6BBE                 ; the following are CAPS SHIFTed
 191++6BBE
 192++6BBE 00 5A 58 43     db 0,'Z','X','C','V'      ; CAPS SHIFT, Z, X, C, V
 192++6BC2 56
 193++6BC3 41 53 44 46     db 'A','S','D','F','G'      ; A, S, D, F, G
 193++6BC7 47
 194++6BC8 51 57 45 52     db 'Q','W','E','R','T'      ; Q, W, E, R, T
 194++6BCC 54
 195++6BCD 0E 06 80 81     db 14,6,128,129,8           ; 1, 2, 3, 4, 5
 195++6BD1 08
 196++6BD2 0C 00 09 0B     db 12,0,9,11,10             ; 0, 9, 8, 7, 6
 196++6BD6 0A
 197++6BD7 50 4F 49 55     db 'P','O','I','U','Y'      ; P, O, I, U, Y
 197++6BDB 59
 198++6BDC 0D 4C 4B 4A     db 13,'L','K','J','H'       ; ENTER, L, K, J, H
 198++6BE0 48
 199++6BE1 20 00 4D 4E     db ' ',0,'M','N','B'      ; SPACE, SYM SHIFT, M, N, B
 199++6BE5 42
 200++6BE6
 201++6BE6                 ; the following are SYM SHIFTed
 202++6BE6
 203++6BE6 00 3A 60 3F     db 0,':',96,'?','/'       ; CAPS SHIFT, Z, X, C, V
 203++6BEA 2F
 204++6BEB 7E 7C 5C 7B     db '~','|',92,'{','}'       ; A, S, D, F, G
 204++6BEF 7D
 205++6BF0 83 84 85 3C     db 131,132,133,'<','>'      ; Q, W, E, R, T
 205++6BF4 3E
 206++6BF5 21 40 23 24     db '!','@','#','$','%'      ; 1, 2, 3, 4, 5
 206++6BF9 25
 207++6BFA 5F 29 28 27     db '_',')','(',39,'&'       ; 0, 9, 8, 7, 6
 207++6BFE 26
 208++6BFF 22 3B 82 5D     db 34,';',130,']','['       ; P, O, I, U, Y
 208++6C03 5B
 209++6C04 0D 3D 2B 2D     db 13,'=','+','-','^'       ; ENTER, L, K, J, H
 209++6C08 5E
 210++6C09 20 00 2E 2C     db ' ',0,'.',',','*'      ; SPACE, SYM SHIFT, M, N, B
 210++6C0D 2A
 211++6C0E
 212++6C0E                 ; the following are CAPS SHIFTed and SYM SHIFTed ("CTRL" key)
 213++6C0E
 214++6C0E 00 1A 18 03     db 0,26,24,3,22           ; CAPS SHIFT, Z, X, C, V
 214++6C12 16
 215++6C13 01 13 04 06     db 1,19,4,6,7               ; A, S, D, F, G
 215++6C17 07
 216++6C18 11 17 05 12     db 17,23,5,18,20            ; Q, W, E, R, T
 216++6C1C 14
 217++6C1D 1B 1C 1D 1E     db 27,28,29,30,31           ; 1, 2, 3, 4, 5
 217++6C21 1F
 218++6C22 7F 00 86 60     db 127,0,134,'`',135      ; 0, 9, 8, 7, 6
 218++6C26 87
 219++6C27 10 0F 09 15     db 16,15,9,21,25            ; P, O, I, U, Y
 219++6C2B 19
 220++6C2C 0D 0C 0B 0A     db 13,12,11,10,8            ; ENTER, L, K, J, H
 220++6C30 08
 221++6C31 20 00 0D 0E     db ' ',0,13,14,2          ; SPACE, SYM SHIFT, M, N, B
 221++6C35 02
 222++6C36
 223++6C36              russiantable
 224++6C36 00 EF E7 E1     db 0,'','','',''      ; CAPS SHIFT, Z, X, C, V
 224++6C3A AC
 225++6C3B E4 EB A2 A0     db '','','','',''      ; A, S, D, F, G
 225++6C3F AF
 226++6C40 A9 E6 E3 AA     db '','','','',''      ; Q, W, E, R, T
 226++6C44 A5
 227++6C45 31 32 33 34     db '1','2','3','4','5'      ; 1, 2, 3, 4, 5
 227++6C49 35
 228++6C4A 30 39 38 37     db '0','9','8','7','6'      ; 0, 9, 8, 7, 6
 228++6C4E 36
 229++6C4F A7 E9 E8 A3     db '','','','',''      ; P, O, I, U, Y
 229++6C53 AD
 230++6C54 0D A4 AB AE     db 13,'','','',''       ; ENTER, L, K, J, H
 230++6C58 E0
 231++6C59 20 00 EC E2     db ' ',0,'','',''      ; SPACE, SYM SHIFT, M, N, B
 231++6C5D A8
 232++6C5E
 233++6C5E                 ; the following are CAPS SHIFTed
 234++6C5E
 235++6C5E 00 9F 97 91     db 0,'','','',''      ; CAPS SHIFT, Z, X, C, V
 235++6C62 8C
 236++6C63 94 9B 82 80     db '','','','',''      ; A, S, D, F, G
 236++6C67 8F
 237++6C68 89 96 93 8A     db '','','','',''      ; Q, W, E, R, T
 237++6C6C 85
 238++6C6D 0F 06 80 81     db 15,6,128,129,8            ; 1, 2, 3, 4, 5
 238++6C71 08
 239++6C72 0C 00 09 0B     db 12,0,9,11,10             ; 0, 9, 8, 7, 6
 239++6C76 0A
 240++6C77 87 99 98 83     db '','','','',''      ; P, O, I, U, Y
 240++6C7B 8D
 241++6C7C 0D 84 8B 8E     db 13,'','','',''       ; ENTER, L, K, J, H
 241++6C80 90
 242++6C81 20 00 9C 92     db ' ',0,'','',''      ; SPACE, SYM SHIFT, M, N, B
 242++6C85 88
 243++6C86
 244++6C86                 ; the following are SYM SHIFTed
 245++6C86
 246++6C86 00 3A EE 3F     db 0,':','','?','/'       ; CAPS SHIFT, Z, X, C, V
 246++6C8A 2F
 247++6C8B A1 ED 5C E5     db '','',92,'',''       ; A, S, D, F, G
 247++6C8F A6
 248++6C90 83 84 85 3C     db 131,132,133,'<','>'      ; Q, W, E, R, T
 248++6C94 3E
 249++6C95 21 40 23 24     db '!','@','#','$','%'      ; 1, 2, 3, 4, 5
 249++6C99 25
 250++6C9A 5F 29 28 27     db '_',')','(',39,'&'       ; 0, 9, 8, 7, 6
 250++6C9E 26
 251++6C9F 22 3B 82 5D     db 34,';',130,']','['       ; P, O, I, U, Y
 251++6CA3 5B
 252++6CA4 0D 3D 2B 2D     db 13,'=','+','-','^'       ; ENTER, L, K, J, H
 252++6CA8 5E
 253++6CA9 20 00 2E 2C     db ' ',0,'.',',','*'      ; SPACE, SYM SHIFT, M, N, B
 253++6CAD 2A
 254++6CAE
 255++6CAE                 ; the following are CAPS SHIFTed and SYM SHIFTed ("CTRL" key)
 256++6CAE
 257++6CAE 00 1A 9E 03     db 0,26,'',3,22           ; CAPS SHIFT, Z, X, C, V
 257++6CB2 16
 258++6CB3 81 9D 04 95     db '','',4,'',''               ; A, S, D, F, G
 258++6CB7 86
 259++6CB8 11 17 05 12     db 17,23,5,18,20            ; Q, W, E, R, T
 259++6CBC 14
 260++6CBD 1B 1C 1D 1E     db 27,28,29,30,31           ; 1, 2, 3, 4, 5
 260++6CC1 1F
 261++6CC2 7F 00 86 60     db 127,0,134,'`',135      ; 0, 9, 8, 7, 6
 261++6CC6 87
 262++6CC7 10 0F 09 15     db 16,15,9,21,25            ; P, O, I, U, Y
 262++6CCB 19
 263++6CCC 0D 0C 0B 0A     db 13,12,11,10,8            ; ENTER, L, K, J, H
 263++6CD0 08
 264++6CD1 20 00 0D 0E     db ' ',0,13,14,2          ; SPACE, SYM SHIFT, M, N, B
 264++6CD5 02
 265++6CD6
 266++6CD6                  endmodule
# file closed: dos/console.asm
   8++6CD6              		include "trdos.asm"
# file opened: dos/trdos.asm
   1++6CD6              ;trdos driver (izzx)
   2++6CD6                  MODULE Dos
   3++6CD6              ; API methods
   4++6CD6              ESX_GETSETDRV = #89
   5++6CD6              ESX_FOPEN = #9A
   6++6CD6              ESX_FCLOSE = #9B
   7++6CD6              ESX_FSYNC = #9C
   8++6CD6              ESX_FREAD = #9D
   9++6CD6              ESX_FWRITE = #9E
  10++6CD6
  11++6CD6              ; File modes
  12++6CD6              FMODE_READ = #01
  13++6CD6              FMODE_WRITE = #06
  14++6CD6              FMODE_CREATE = #0E
  15++6CD6
  16++6CD6                  ; MACRO esxCall func
  17++6CD6                  ; rst #8 : db func
  18++6CD6                  ; ENDM
  19++6CD6
  20++6CD6              ;id = 0   
  21++6CD6              ;id = 1   
  22++6CD6              ;id = 2   
  23++6CD6              ;id = 3     TRD
  24++6CD6              ;id = 4     SCL
  25++6CD6
  26++6CD6              ; HL - filename in ASCIIZ
  27++6CD6              loadBuffer:
  28++6CD6 06 01            ld b, Dos.FMODE_READ
  28++6CD8 CD F2 6C       call Dos.fopen
  29++6CDB F5               push af
  30++6CDC 21 86 A0 01          ld hl, outputBuffer, bc, #ffff - outputBuffer
  30++6CE0 79 5F
  30++6CE2 CD 49 6F       call Dos.fread
  31++6CE5 21 86 A0             ld hl, outputBuffer
  31++6CE8 09             add hl, bc
  31++6CE9 AF             xor a
  31++6CEA 77             ld (hl), a
  31++6CEB 23             inc hl
  31++6CEC 77             ld (hl), a
  32++6CED F1               pop af
  33++6CEE CD 3D 6E         call Dos.fclose
  34++6CF1 C9               ret
  35++6CF2
  36++6CF2
  37++6CF2              ; Returns:
  38++6CF2              ;  A - current drive
  39++6CF2              ; getDefaultDrive: ;  
  40++6CF2                  ; ld a, 0 : esxCall ESX_GETSETDRV
  41++6CF2                  ; ret
  42++6CF2
  43++6CF2
  44++6CF2
  45++6CF2              ; Opens file on default drive
  46++6CF2              ; B - File mode
  47++6CF2              ; HL - File name
  48++6CF2              ; Returns:
  49++6CF2              ;  A - file stream id
  50++6CF2              fopen:
  51++6CF2                  ; push bc : push hl
  52++6CF2                  ; call getDefaultDrive
  53++6CF2                  ; pop ix : pop bc
  54++6CF2                  ; esxCall ESX_FOPEN
  55++6CF2                  ; ret
  56++6CF2 78           	ld a,b
  57++6CF3 FE 01        	cp FMODE_READ ;   
  58++6CF5 28 06        	jr z,fopen_r
  59++6CF7 FE 0E        	cp FMODE_CREATE
  60++6CF9 28 39        	jr z,fopen_c ;   
  61++6CFB 18 34        	jr fopen_err ; 
  62++6CFD
  63++6CFD              fopen_r	;     (id=1)
  64++6CFD              	; ld a,(#5D19) ;   
  65++6CFD              	; ld 	(prev_drive),a ;
  66++6CFD CD D3 72     			call format_name ;
  67++6D00 0E 13        			ld      c,#13 ;move file info to syst var
  68++6D02 CD 39 6E                 call    call3d13
  69++6D05 0E 0A                    ld      c,#0a ;find file
  70++6D07 CD 39 6E                 call    call3d13
  71++6D0A 79                       ld      a,c
  72++6D0B FE FF        			cp 		#ff
  73++6D0D 28 22        			jr 		z,fopen_err ;   
  74++6D0F 0E 08                    ld      c,#08 ;read file title
  75++6D11 CD 39 6E                 call    call3d13
  76++6D14                          ;ld      hl,loadadr ;
  77++6D14 ED 5B EB 5C              ld      de,(#5ceb) ;   
  78++6D18 ED 53 A0 73              ld      (f_r_cur_trk),de
  79++6D1C
  80++6D1C 3A EA 5C                 ld      a,(#5cea)
  81++6D1F 32 A2 73                 ld      (f_r_len_sec),a ;  
  82++6D22                          ;or      a
  83++6D22                          ;ret     z    ;  
  84++6D22
  85++6D22 ED 5B E8 5C  			ld de,(#5CE8) ;       BASIC
  86++6D26 ED 53 A3 73  			ld      (f_r_len),de
  87++6D2A
  88++6D2A                          ; ld      de,(fcurtrk) ;  
  89++6D2A                          ; ld      (#5cf4),de ;
  90++6D2A AF           			xor a
  91++6D2B 3E 01        			ld 		a,1
  92++6D2D 32 A5 73     			ld (f_r_flag),a ;     
  93++6D30              			;id   1
  94++6D30 C9           	ret
  95++6D31
  96++6D31              fopen_err
  97++6D31 AF           	xor a ;    ,  id = 0
  98++6D32 37           	scf ; 
  99++6D33 C9           	ret
 100++6D34
 101++6D34
 102++6D34              fopen_c	;   (id=2-4)
 103++6D34              	; ld a,(#5D19) ;   
 104++6D34              	; ld 	(prev_drive),a ;
 105++6D34 CD D3 72     	call format_name ;
 106++6D37              	;,      
 107++6D37 21 7C 73         ld hl, trdExt1
 107++6D3A CD F2 63       call CompareBuff.search
 107++6D3D A7             and a
 107++6D3E 20 7B          jr nz, fopen_c_trd
 108++6D40 21 81 73         ld hl, trdExt2
 108++6D43 CD F2 63       call CompareBuff.search
 108++6D46 A7             and a
 108++6D47 20 72          jr nz, fopen_c_trd
 109++6D49 21 86 73     	ld hl, sclExt1
 109++6D4C CD F2 63       call CompareBuff.search
 109++6D4F A7             and a
 109++6D50 C2 DD 6D       jp nz, fopen_c_scl
 110++6D53 21 8B 73         ld hl, sclExt2
 110++6D56 CD F2 63       call CompareBuff.search
 110++6D59 A7             and a
 110++6D5A C2 DD 6D       jp nz, fopen_c_scl
 111++6D5D
 112++6D5D
 113++6D5D              	;   (id=2)
 114++6D5D CD 05 6E     	call select_drive
 115++6D60 FE 79        	cp "y"
 116++6D62 20 CD        	jr nz,fopen_err
 117++6D64
 118++6D64 CD AD 6D     	call cat_buf_cls
 119++6D67
 120++6D67 21 00 48     	ld hl,cat_buf ;  
 121++6D6A 11 00 00     	ld de,0
 122++6D6D 01 05 09         ld      bc,#0905 ;
 123++6D70 CD 39 6E         call    call3d13
 124++6D73
 125++6D73 3A E4 50     	ld a,(cat_buf+8*256+#e4) ;   
 126++6D76 FE 80        	cp 128
 127++6D78 DA 83 6D     	jp c,fopen_c2 ;  
 128++6D7B 21 E1 73         ld hl, file_err
 129++6D7E CD 45 6A         call DialogBox.msgBox ;
 130++6D81 18 AE        	jr fopen_err
 131++6D83
 132++6D83              fopen_c2
 133++6D83 2A E5 50     	ld hl,(cat_buf+8*256+#e5) ;     
 134++6D86 7C           	ld a,h
 135++6D87 B5           	or l
 136++6D88 20 08        	jr nz,fopen_c3 ;   
 137++6D8A 21 E1 73         ld hl, file_err
 138++6D8D CD 45 6A         call DialogBox.msgBox ;
 139++6D90 18 9F        	jr fopen_err
 140++6D92
 141++6D92              fopen_c3
 142++6D92 ED 5B E1 50  	ld de,(cat_buf+8*256+#e1) ;  -
 143++6D96 ED 53 F4 5C      ld   (#5cf4),de ;   
 144++6D9A
 145++6D9A AF           	xor a
 146++6D9B 32 B5 73     	ld (sec_shift),a ;
 147++6D9E 21 00 00     	ld hl,0
 148++6DA1 22 AA 73     	ld (f_w_len+0),hl
 149++6DA4 22 AC 73     	ld (f_w_len+2),hl
 150++6DA7 3E 02        	ld a,2 ;id 
 151++6DA9 32 A9 73     	ld (f_w_flag),a ;     
 152++6DAC C9           	ret
 153++6DAD
 154++6DAD
 155++6DAD              cat_buf_cls ;  
 156++6DAD 21 00 48     	ld hl,cat_buf ;    
 157++6DB0 11 01 48     	ld de,cat_buf+1
 158++6DB3 36 00        	ld (hl),0
 159++6DB5 01 FF 08     	ld bc,9*256-1
 160++6DB8 ED B0        	ldir
 161++6DBA C9           	ret
 162++6DBB
 163++6DBB
 164++6DBB
 165++6DBB              fopen_c_trd	;     trd (id=3)
 166++6DBB CD 05 6E     	call select_drive
 167++6DBE FE 79        	cp "y"
 168++6DC0 C2 31 6D     	jp nz,fopen_err
 169++6DC3
 170++6DC3 11 00 00     	ld      de,0 ;  
 171++6DC6 ED 53 F4 5C      ld      (#5cf4),de
 172++6DCA
 173++6DCA AF           	xor a
 174++6DCB 32 B5 73     	ld (sec_shift),a ;
 175++6DCE 21 00 00     	ld hl,0
 176++6DD1 22 AA 73     	ld (f_w_len+0),hl
 177++6DD4 22 AC 73     	ld (f_w_len+2),hl
 178++6DD7 3E 03        	ld a,3 ;id 
 179++6DD9 32 A9 73     	ld (f_w_flag),a ;  trd   
 180++6DDC C9           	ret
 181++6DDD
 182++6DDD
 183++6DDD
 184++6DDD              fopen_c_scl	;     scl (id=4)
 185++6DDD CD 05 6E     	call select_drive
 186++6DE0 FE 79        	cp "y"
 187++6DE2 C2 31 6D     	jp nz,fopen_err
 188++6DE5
 189++6DE5 11 00 00     	ld      de,0 ;  
 190++6DE8 ED 53 F4 5C      ld      (#5cf4),de
 191++6DEC
 192++6DEC CD AD 6D     	call cat_buf_cls ; 
 193++6DEF
 194++6DEF CD 48 71     	call scl_parse ;   
 195++6DF2
 196++6DF2 AF           	xor a
 197++6DF3 32 B5 73     	ld (sec_shift),a ;
 198++6DF6              	;ld (scl_que),a
 199++6DF6 21 00 00     	ld hl,0
 200++6DF9 22 AA 73     	ld (f_w_len+0),hl
 201++6DFC 22 AC 73     	ld (f_w_len+2),hl
 202++6DFF 3E 04        	ld a,4 ;id 
 203++6E01 32 A9 73     	ld (f_w_flag),a ;  scl   
 204++6E04 C9           	ret
 205++6E05
 206++6E05
 207++6E05
 208++6E05
 209++6E05
 210++6E05              select_drive	;  
 211++6E05 3A 19 5D     	ld a,(#5D19) ;   
 212++6E08 C6 41        	add a,"A"
 213++6E0A 32 4E 73     	ld (write_ima_d),a ;   
 214++6E0D 21 42 73         ld hl, write_ima
 215++6E10 CD 4E 6A         call DialogBox.msgNoWait ;
 216++6E13              WAITKEY_trd
 217++6E13              	;halt
 218++6E13 CD 97 6A     	call Console.getC
 219++6E16 FE FF        	cp 255
 220++6E18 28 F9        	JR Z,WAITKEY_trd	;  
 221++6E1A FE 79        	cp "y"
 222++6E1C C8           	ret z
 223++6E1D FE 6E        	cp "n"
 224++6E1F C8           	ret z
 225++6E20 FE 61        	cp "a"
 226++6E22 38 EF        	jr c,WAITKEY_trd
 227++6E24 FE 65        	cp "e"
 228++6E26 30 EB        	jr nc,WAITKEY_trd
 229++6E28 D6 61        	sub "a"
 230++6E2A 32 19 5D         ld      (#5d19) ,a
 231++6E2D 0E 01            ld      c,1
 232++6E2F CD 39 6E         call    call3d13
 233++6E32 0E 18            ld      c,#18
 234++6E34 CD 39 6E         call    call3d13
 235++6E37 18 CC        	jr select_drive
 236++6E39
 237++6E39
 238++6E39              ; restore_drive ;   
 239++6E39              	; ld 	a,(prev_drive)
 240++6E39                  ; ld      (#5d19) ,a
 241++6E39                  ; ld      c,1
 242++6E39                  ; call    call3d13
 243++6E39                  ; ld      c,#18
 244++6E39                  ; call    call3d13
 245++6E39              	; ret
 246++6E39
 247++6E39
 248++6E39              call3d13 ;  GMX
 249++6E39              	ifndef ZSGMX
 250++6E39 C3 13 3D         jp    #3d13
 251++6E3C              	endif
 252++6E3C
 253++6E3C              	ifdef ZSGMX
 254++6E3C ~                call    #3d13
 255++6E3C ~            	exx
 256++6E3C ~            	call TextMode.gmxscron
 257++6E3C ~            	exx
 258++6E3C              	endif
 259++6E3C C9           	ret
 260++6E3D
 261++6E3D
 262++6E3D
 263++6E3D              ; A - file stream id
 264++6E3D              fclose:
 265++6E3D                  ;esxCall ESX_FCLOSE
 266++6E3D              	; push af
 267++6E3D              ; WAITKEY2	XOR A:IN A,(#FE):CPL:AND #1F:JR Z,WAITKEY2
 268++6E3D              	; pop af
 269++6E3D FE 02        	cp 2 ;  
 270++6E3F C2 35 6F     	jp nz,fclose_scl
 271++6E42
 272++6E42              	;  
 273++6E42 3A AE 73     	ld a,(write_end_flag) ;  ?
 274++6E45 B7           	or a
 275++6E46 20 12        	jr nz,fclose_f ; 
 276++6E48
 277++6E48 21 00 51     	ld hl,sec_buf
 278++6E4B 01 06 01     	ld bc,#0106
 279++6E4E ED 5B F4 5C  	ld de,(#5cf4)
 280++6E52 CD 39 6E     	call call3d13
 281++6E55
 282++6E55 3E 30        	ld a,"0" ;  
 283++6E57 32 F4 73     	ld (file_num),a
 284++6E5A
 285++6E5A              fclose_f ; 
 286++6E5A 3A AC 73     	ld a,(f_w_len+2) ;    
 287++6E5D 2A AA 73     	ld hl,(f_w_len+0)
 288++6E60 B4           	or h
 289++6E61 B5           	or l
 290++6E62 CA 41 6F     	jp z,fclose_ex ;   0
 291++6E65
 292++6E65              	;  
 293++6E65 3A E4 50     	ld a,(cat_buf+8*256+#e4) ;   
 294++6E68 FE 80        	cp 128
 295++6E6A D2 41 6F     	jp nc,fclose_ex ;  
 296++6E6D 2A E5 50     	ld hl,(cat_buf+8*256+#e5) ;     
 297++6E70 7C           	ld a,h
 298++6E71 B5           	or l
 299++6E72 CA 41 6F     	jp z,fclose_ex ;  
 300++6E75
 301++6E75 3A AC 73     	ld a,(f_w_len+2) ;    
 302++6E78 B7           	or a
 303++6E79 20 28        	jr nz,fclose_f_multi ;   255  (65280)
 304++6E7B 3A AB 73     	ld a,(f_w_len+1)
 305++6E7E FE FF        	cp 255
 306++6E80 20 05        	jr nz,fclose_f1
 307++6E82 3A AA 73     	ld a,(f_w_len+0)
 308++6E85 20 1C        	jr nz,fclose_f_multi ;   255  (65280)
 309++6E87              fclose_f1
 310++6E87              	;      trdos
 311++6E87 ED 5B AA 73  	ld de,(f_w_len+0)
 312++6E8B 21 9B 73     	ld hl,f_name+11 ; 
 313++6E8E 73           	ld (hl),e
 314++6E8F 23           	inc hl
 315++6E90 72           	ld (hl),d
 316++6E91 23           	inc hl
 317++6E92 3A AB 73     	ld a,(f_w_len+1) ; 
 318++6E95 77           	ld (hl),a
 319++6E96 3A AA 73     	ld a,(f_w_len+0) ; 
 320++6E99 B7           	or a
 321++6E9A 28 01        	jr z,fclose_f2
 322++6E9C 34           	inc (hl) ; 
 323++6E9D              fclose_f2
 324++6E9D CD CF 6E     	call fclose_f_one ; 
 325++6EA0 C3 41 6F     	jp fclose_ex ;
 326++6EA3
 327++6EA3              fclose_f_multi ; ,     
 328++6EA3 3A F4 73     	ld a,(file_num)
 329++6EA6 32 97 73     	ld (f_name+7),a ;   
 330++6EA9
 331++6EA9 21 9B 73     	ld hl,f_name+11 ; 
 332++6EAC 36 00        	ld (hl),0
 333++6EAE 23           	inc hl
 334++6EAF 36 FF        	ld (hl),#ff ;65280
 335++6EB1 23           	inc hl
 336++6EB2              	; 
 337++6EB2 36 FF        	ld (hl),#ff
 338++6EB4 CD CF 6E     	call fclose_f_one ; 
 339++6EB7
 340++6EB7              	;  
 341++6EB7 2A AB 73     	ld hl,(f_w_len+1) ;   
 342++6EBA 01 FF 00     	ld bc,255
 343++6EBD A7           	and a
 344++6EBE ED 42        	sbc hl,bc ; 255 
 345++6EC0 22 AB 73     	ld (f_w_len+1),hl
 346++6EC3
 347++6EC3 3A F4 73     	ld a,(file_num)
 348++6EC6 3C           	inc a
 349++6EC7 32 F4 73     	ld (file_num),a
 350++6ECA 32 97 73     	ld (f_name+7),a ;   
 351++6ECD
 352++6ECD 18 8B        	jr fclose_f ;
 353++6ECF
 354++6ECF
 355++6ECF              fclose_f_one ;   
 356++6ECF 3A E4 50     			ld a,(cat_buf+8*256+#e4) ;   
 357++6ED2 6F           			ld l,a ;       
 358++6ED3 26 00        			ld h,0
 359++6ED5 29           			add hl,hl ;*2
 360++6ED6 29           			add hl,hl ;*4
 361++6ED7 29           			add hl,hl ;*8
 362++6ED8 29           			add hl,hl ;*16
 363++6ED9 7C           			ld a,h ;    
 364++6EDA 32 F3 73     			ld (sec_cat),a
 365++6EDD 01 00 48     			ld bc,cat_buf
 366++6EE0 09           			add hl,bc ;     
 367++6EE1 EB           			ex de,hl
 368++6EE2
 369++6EE2 21 90 73     			ld hl,f_name ;  
 370++6EE5 01 10 00     			ld bc,16
 371++6EE8 ED B0        			ldir ;
 372++6EEA EB           			ex de,hl
 373++6EEB 2B           			dec hl
 374++6EEC ED 5B E1 50  			ld de,(cat_buf+8*256+#e1) ;  - 
 375++6EF0 72           			ld (hl),d ;
 376++6EF1 2B           			dec hl
 377++6EF2 73           			ld (hl),e ;
 378++6EF3
 379++6EF3 2E 00        			ld l,0 ;     
 380++6EF5 16 00        			ld d,0
 381++6EF7 3A F3 73     			ld a,(sec_cat)
 382++6EFA 5F           			ld e,a ; 
 383++6EFB 01 06 01     			ld bc,#0106 ;1  
 384++6EFE CD 39 6E     			call call3d13
 385++6F01
 386++6F01              			; 
 387++6F01 ED 5B E1 50  			ld de,(cat_buf+8*256+#e1) ;  -
 388++6F05 3A 9D 73     			ld a,(f_name+13) ;   
 389++6F08 47           			ld b,a
 390++6F09 CD 36 73     			call calc_next_pos2
 391++6F0C ED 53 E1 50  			ld (cat_buf+8*256+#e1),de
 392++6F10
 393++6F10 2A E5 50     			ld hl,(cat_buf+8*256+#e5) ;     
 394++6F13 3A 9D 73     			ld a,(f_name+13) ;   
 395++6F16 4F           			ld c,a
 396++6F17 06 00        			ld b,0
 397++6F19 A7           			and a
 398++6F1A ED 42        			sbc hl,bc
 399++6F1C 30 03        			jr nc,fclose_f_one2
 400++6F1E 21 00 00     			ld hl,0 ;  
 401++6F21              fclose_f_one2
 402++6F21 22 E5 50     			ld (cat_buf+8*256+#e5),hl
 403++6F24
 404++6F24 21 E4 50     			ld hl,cat_buf+8*256+#e4 ;   
 405++6F27 34           			inc (hl)
 406++6F28
 407++6F28 21 00 50     			ld hl,cat_buf+8*256
 408++6F2B 11 08 00     			ld de,#0008
 409++6F2E 01 06 01     			ld bc,#0106 ;1  
 410++6F31 CD 39 6E     			call call3d13
 411++6F34 C9           			ret
 412++6F35
 413++6F35
 414++6F35              fclose_scl
 415++6F35 FE 04        	cp 4 ; scl
 416++6F37 20 08        	jr nz,fclose_ex
 417++6F39 21 00 51     	ld hl,sec_buf ;
 418++6F3C 06 01        	ld b,1
 419++6F3E CD 27 71     	call scl_write_buf ;  scl,  
 420++6F41
 421++6F41              fclose_ex
 422++6F41 AF           	xor a ;    
 423++6F42 32 A5 73     	ld (f_r_flag),a
 424++6F45 32 A9 73     	ld (f_w_flag),a
 425++6F48              	;call restore_drive ; ,  
 426++6F48 C9               ret
 427++6F49
 428++6F49
 429++6F49
 430++6F49
 431++6F49              ; A - file stream id
 432++6F49              ; BC - length
 433++6F49              ; HL - buffer
 434++6F49              ; Returns
 435++6F49              ;  BC - length(how much was actually read)
 436++6F49              fread: ;(id=1)
 437++6F49                  ; push hl : pop ix
 438++6F49                  ; esxCall ESX_FREAD
 439++6F49              	; push af
 440++6F49              	; ld a,4
 441++6F49              	; out (254),a
 442++6F49              ; WAITKEY	XOR A:IN A,(#FE):CPL:AND #1F:JR Z,WAITKEY
 443++6F49              	; xor a
 444++6F49              	; out (254),a
 445++6F49              	; pop af
 446++6F49
 447++6F49 FE 01        	cp 1 ;id = 1?
 448++6F4B 20 06        	jr nz,fread_no_chek ;     = 1
 449++6F4D 3A A5 73     	ld a,(f_r_flag)
 450++6F50 B7           	or a
 451++6F51 20 06        	jr nz,fread_chek ;  ?
 452++6F53              fread_no_chek ;  
 453++6F53 AF           	xor a
 454++6F54 37           	scf ; 
 455++6F55 01 00 00     	ld bc,0 ;   
 456++6F58 C9           	ret
 457++6F59
 458++6F59              fread_chek
 459++6F59 ED 4B A1 73  	ld bc,(f_r_len_sec-1) ;  ,    ,    
 460++6F5D 0E 05            ld      c,5 ;read   
 461++6F5F ED 5B A0 73  	ld de,(f_r_cur_trk)
 462++6F63 CD 39 6E         call    call3d13
 463++6F66 ED 4B A3 73  	ld bc,(f_r_len) ;    ( )
 464++6F6A AF           	xor a ; 
 465++6F6B C9               ret
 466++6F6C
 467++6F6C              ; A - file stream id
 468++6F6C              ; BC - length
 469++6F6C              ; HL - buffer
 470++6F6C              ; Returns:
 471++6F6C              ;   BC - actually written bytes
 472++6F6C              fwrite: ;
 473++6F6C                  ; push hl : pop ix
 474++6F6C                  ; esxCall ESX_FWRITE
 475++6F6C
 476++6F6C              	; push af
 477++6F6C              	; ld a,2
 478++6F6C              	; out (254),a
 479++6F6C              ; WAITKEY1	XOR A:IN A,(#FE):CPL:AND #1F:JR Z,WAITKEY1
 480++6F6C              	; xor a
 481++6F6C              	; out (254),a
 482++6F6C              	; pop af
 483++6F6C
 484++6F6C FE 02        	cp 2 ;id = 2?
 485++6F6E 28 0F        	jr z,fwrite_chek ; id 
 486++6F70 FE 03        	cp 3 ;id = 3?
 487++6F72 28 0B        	jr z,fwrite_chek_trd ; id 
 488++6F74 FE 04        	cp 4 ;id = 4?
 489++6F76 CA 62 70     	jp z,fwrite_chek_scl ; id 
 490++6F79
 491++6F79
 492++6F79              fwrite_no_chek ;  
 493++6F79 AF           	xor a
 494++6F7A 37           	scf ; 
 495++6F7B 01 00 00     	ld bc,0 ;   
 496++6F7E C9           	ret
 497++6F7F
 498++6F7F              fwrite_chek ;    (id=2)
 499++6F7F
 500++6F7F              	;    trd,     ,      
 501++6F7F
 502++6F7F
 503++6F7F
 504++6F7F
 505++6F7F
 506++6F7F              fwrite_chek_trd ; trd  ( , id=3)
 507++6F7F              	; ld a,2
 508++6F7F              	; out (254),a
 509++6F7F              ; WAITKEY_t	XOR A:IN A,(#FE):CPL:AND #1F:JR Z,WAITKEY_t
 510++6F7F              	; xor a
 511++6F7F              	; out (254),a
 512++6F7F 3A A9 73     	ld a,(f_w_flag)
 513++6F82 B7           	or a
 514++6F83 28 F4        	jr z,fwrite_no_chek ;  ?
 515++6F85 ED 43 AF 73  	ld (temp_bc),bc ;
 516++6F89 22 B1 73     	ld (temp_hl),hl ; 
 517++6F8C 78           	ld a,b
 518++6F8D B1           	or c
 519++6F8E 28 E9        	jr z,fwrite_no_chek ;   0,  
 520++6F90
 521++6F90              	;   
 522++6F90 ED 5B F4 5C  	ld de,(#5cf4)
 523++6F94 7A           	ld a,d
 524++6F95 FE A0        	cp #a0 ;  160
 525++6F97 30 E0        	jr nc,fwrite_no_chek
 526++6F99
 527++6F99 AF           	xor a
 528++6F9A 32 B7 73     	ld (sec_part),a ; 
 529++6F9D 32 B6 73     	ld (sec_shift2),a
 530++6FA0 32 B7 73     	ld (sec_shift2+1),a
 531++6FA3 32 B8 73     	ld (sec_shift_flag),a
 532++6FA6 32 AE 73     	ld (write_end_flag),a ;
 533++6FA9
 534++6FA9
 535++6FA9 3A B5 73     	ld a,(sec_shift)
 536++6FAC B7           	or a
 537++6FAD 28 43        	jr z,fwrite_trd3 ;  ,    
 538++6FAF
 539++6FAF
 540++6FAF 4F           	ld c,a
 541++6FB0 06 00        	ld b,0
 542++6FB2 2A AF 73     	ld hl,(temp_bc) ;    
 543++6FB5 09           	add hl,bc
 544++6FB6
 545++6FB6 3E 01        	ld a,1
 546++6FB8 32 AE 73     	ld (write_end_flag),a ;     
 547++6FBB
 548++6FBB 7C           	ld a,h
 549++6FBC B7           	or a
 550++6FBD 20 05        	jr nz,fwrite_trd4
 551++6FBF 3E 01        	ld a,1
 552++6FC1 32 B8 73     	ld (sec_shift_flag),a ;    
 553++6FC4
 554++6FC4              fwrite_trd4
 555++6FC4 21 00 51     	ld hl,sec_buf ;  
 556++6FC7 09           	add hl,bc ;   
 557++6FC8 EB           	ex de,hl
 558++6FC9 2A B1 73     	ld hl,(temp_hl) ;     
 559++6FCC              	; ld a,c
 560++6FCC              	; or a
 561++6FCC              	; jr nz,fwrite_trd2
 562++6FCC              	; inc b ;
 563++6FCC              ; fwrite_trd2
 564++6FCC              	; ld c,a
 565++6FCC AF           	xor a
 566++6FCD 91           	sub c
 567++6FCE 4F           	ld c,a ;     
 568++6FCF ED 43 B6 73  	ld (sec_shift2),bc ;   
 569++6FD3 ED B0        	ldir
 570++6FD5
 571++6FD5 3A B8 73     	ld a,(sec_shift_flag)
 572++6FD8 B7           	or a
 573++6FD9 20 17        	jr nz,fwrite_trd3 ;       
 574++6FDB
 575++6FDB 21 00 51     	ld hl,sec_buf
 576++6FDE ED 5B F4 5C  	ld de,(#5cf4)
 577++6FE2              	;ld (f_w_cur_trk),de	; 
 578++6FE2 01 06 01         ld      bc,#0106 ; 1   
 579++6FE5 CD 39 6E         call    call3d13
 580++6FE8 79           	ld a,c
 581++6FE9 FE FF        	cp 255
 582++6FEB CA 79 6F     	jp z,fwrite_no_chek ;  
 583++6FEE
 584++6FEE AF           	xor a
 585++6FEF 32 AE 73     	ld (write_end_flag),a ;    
 586++6FF2              	; ld de,(f_w_cur_trk) ;    ,    
 587++6FF2              	; ld (#5cf4),de
 588++6FF2              	; ld b,1 ;  
 589++6FF2              	; ld de,(f_w_cur_trk)
 590++6FF2              	; call calc_next_pos
 591++6FF2              	; ld (f_w_cur_trk),de
 592++6FF2
 593++6FF2              fwrite_trd3
 594++6FF2 2A B1 73     	ld hl,(temp_hl) ;  
 595++6FF5              	;ld a,(sec_shift)
 596++6FF5              	;ld c,a
 597++6FF5              	;ld b,0
 598++6FF5 ED 4B B6 73  	ld bc,(sec_shift2)
 599++6FF9 09           	add hl,bc ;   
 600++6FFA 22 B3 73     	ld (temp_hl2),hl ;    
 601++6FFD
 602++6FFD 2A AF 73     	ld hl,(temp_bc) ;      
 603++7000 A7           	and a
 604++7001 ED 42        	sbc hl,bc ; ,     
 605++7003 4D           	ld c,l
 606++7004 44           	ld b,h
 607++7005 30 02        	jr nc,fwrite_trd5
 608++7007 06 00        	ld b,0 ;   
 609++7009              fwrite_trd5
 610++7009 2A B1 73     	ld hl,(temp_hl)
 611++700C 09           	add hl,bc
 612++700D
 613++700D 11 86 A0     	ld de,outputBuffer
 614++7010 A7           	and a
 615++7011 ED 52        	sbc hl,de
 616++7013
 617++7013 7D           	ld a,l
 618++7014 32 B5 73     	ld (sec_shift),a ;   
 619++7017              	;ld hl,(temp_hl)
 620++7017
 621++7017
 622++7017              	; or a
 623++7017              	; jr z,fwrite_trd1
 624++7017              	; inc b  ;  
 625++7017
 626++7017 78           	ld a,b ;    !!!
 627++7018 32 B7 73     	ld (sec_part),a ;     
 628++701B
 629++701B              	;ld a,b
 630++701B B7           	or a
 631++701C 28 16        	jr z,fwrite_trd1 ;    ,   
 632++701E
 633++701E 2A B3 73     	ld hl,(temp_hl2)
 634++7021              	;push bc
 635++7021 ED 5B F4 5C  	ld de,(#5cf4)
 636++7025 0E 06            ld      c,6 ;  
 637++7027 CD 39 6E         call    call3d13
 638++702A 79           	ld a,c
 639++702B              	;pop bc
 640++702B FE FF        	cp 255
 641++702D CA 79 6F     	jp z,fwrite_no_chek ;  
 642++7030              	; ld de,(f_w_cur_trk)
 643++7030              	; call calc_next_pos
 644++7030              	; ld (f_w_cur_trk),de
 645++7030
 646++7030 AF           	xor a
 647++7031 32 AE 73     	ld (write_end_flag),a ;    
 648++7034
 649++7034              fwrite_trd1
 650++7034 3A AE 73     	ld a,(write_end_flag) ;  ?
 651++7037 B7           	or a
 652++7038 20 12        	jr nz,fwrite_trd_ex ; 
 653++703A
 654++703A 2A B3 73     	ld hl,(temp_hl2) ;  
 655++703D 3A B7 73     	ld a,(sec_part)
 656++7040 47           	ld b,a
 657++7041 0E 00        	ld c,0
 658++7043 09           	add hl,bc
 659++7044 11 00 51     	ld de,sec_buf
 660++7047 01 00 01     	ld bc,256
 661++704A ED B0        	ldir
 662++704C              ;fwrite_trd2
 663++704C
 664++704C
 665++704C              fwrite_trd_ex
 666++704C ED 4B AF 73  	ld bc,(temp_bc) ;,   ,    
 667++7050              	;   
 668++7050 2A AA 73     	ld hl,(f_w_len)
 669++7053 09           	add hl,bc
 670++7054 22 AA 73     	ld (f_w_len),hl
 671++7057 30 07        	jr nc,fwrite_trd_ex1
 672++7059 2A AC 73     	ld hl,(f_w_len+2)
 673++705C 23           	inc hl
 674++705D 22 AC 73     	ld (f_w_len+2),hl
 675++7060
 676++7060              fwrite_trd_ex1
 677++7060 AF           	xor a ; 
 678++7061 C9               ret
 679++7062
 680++7062
 681++7062
 682++7062
 683++7062
 684++7062              ;------------------scl----------------------
 685++7062              fwrite_chek_scl ; scl  ( , id=4)
 686++7062              	; ld a,2
 687++7062              	; out (254),a
 688++7062              ; WAITKEY_t	XOR A:IN A,(#FE):CPL:AND #1F:JR Z,WAITKEY_t
 689++7062              	; xor a
 690++7062              	; out (254),a
 691++7062 3A A9 73     	ld a,(f_w_flag)
 692++7065 B7           	or a
 693++7066 CA 79 6F     	jp z,fwrite_no_chek ;  ?
 694++7069 ED 43 AF 73  	ld (temp_bc),bc ;
 695++706D 22 B1 73     	ld (temp_hl),hl ; 
 696++7070 78           	ld a,b
 697++7071 B1           	or c
 698++7072 CA 79 6F     	jp z,fwrite_no_chek ;   0,  
 699++7075
 700++7075              	; ld a,b
 701++7075              	; or a
 702++7075              	; jr nz,testt1
 703++7075              	; nop
 704++7075
 705++7075              ; testt1
 706++7075
 707++7075 AF           	xor a
 708++7076 32 B7 73     	ld (sec_part),a ; 
 709++7079 32 B6 73     	ld (sec_shift2),a
 710++707C 32 B7 73     	ld (sec_shift2+1),a
 711++707F 32 B8 73     	ld (sec_shift_flag),a
 712++7082 32 AE 73     	ld (write_end_flag),a ;
 713++7085
 714++7085
 715++7085 3A B5 73     	ld a,(sec_shift)
 716++7088 B7           	or a
 717++7089 28 38        	jr z,fwrite_scl3 ;  ,    
 718++708B
 719++708B
 720++708B 4F           	ld c,a
 721++708C 06 00        	ld b,0
 722++708E 2A AF 73     	ld hl,(temp_bc) ;    
 723++7091 09           	add hl,bc
 724++7092
 725++7092 3E 01        	ld a,1
 726++7094 32 AE 73     	ld (write_end_flag),a ;     
 727++7097
 728++7097 7C           	ld a,h
 729++7098 B7           	or a
 730++7099 20 05        	jr nz,fwrite_scl4
 731++709B 3E 01        	ld a,1
 732++709D 32 B8 73     	ld (sec_shift_flag),a ;    
 733++70A0
 734++70A0              fwrite_scl4
 735++70A0 21 00 51     	ld hl,sec_buf ;  
 736++70A3 09           	add hl,bc ;   
 737++70A4 EB           	ex de,hl
 738++70A5 2A B1 73     	ld hl,(temp_hl) ;     
 739++70A8              	; ld a,c
 740++70A8              	; or a
 741++70A8              	; jr nz,fwrite_scl2
 742++70A8              	; inc b ;
 743++70A8              ; fwrite_scl2
 744++70A8              	; ld c,a
 745++70A8 AF           	xor a
 746++70A9 91           	sub c
 747++70AA 4F           	ld c,a ;     
 748++70AB ED 43 B6 73  	ld (sec_shift2),bc ;   
 749++70AF ED B0        	ldir
 750++70B1
 751++70B1 3A B8 73     	ld a,(sec_shift_flag)
 752++70B4 B7           	or a
 753++70B5 20 0C        	jr nz,fwrite_scl3 ;       
 754++70B7
 755++70B7 21 00 51     	ld hl,sec_buf
 756++70BA              	;ld de,(#5cf4)
 757++70BA              	;ld (f_w_cur_trk),de	; 
 758++70BA 06 01            ld      b,#01 ; 1   
 759++70BC CD 27 71         call    scl_write_buf
 760++70BF              	; ld a,c
 761++70BF              	; cp 255
 762++70BF              	; jp z,fwrite_no_chek ;  
 763++70BF
 764++70BF AF           	xor a
 765++70C0 32 AE 73     	ld (write_end_flag),a ;    
 766++70C3              	; ld de,(f_w_cur_trk) ;    ,    
 767++70C3              	; ld (#5cf4),de
 768++70C3              	; ld b,1 ;  
 769++70C3              	; ld de,(f_w_cur_trk)
 770++70C3              	; call calc_next_pos
 771++70C3              	; ld (f_w_cur_trk),de
 772++70C3
 773++70C3              fwrite_scl3
 774++70C3 2A B1 73     	ld hl,(temp_hl) ;  
 775++70C6              	;ld a,(sec_shift)
 776++70C6              	;ld c,a
 777++70C6              	;ld b,0
 778++70C6 ED 4B B6 73  	ld bc,(sec_shift2)
 779++70CA 09           	add hl,bc ;   
 780++70CB 22 B3 73     	ld (temp_hl2),hl ;    
 781++70CE
 782++70CE 2A AF 73     	ld hl,(temp_bc) ;      
 783++70D1 A7           	and a
 784++70D2 ED 42        	sbc hl,bc ; ,     
 785++70D4 4D           	ld c,l
 786++70D5 44           	ld b,h
 787++70D6 30 02        	jr nc,fwrite_scl5
 788++70D8 06 00        	ld b,0 ;   
 789++70DA              fwrite_scl5
 790++70DA 2A B1 73     	ld hl,(temp_hl)
 791++70DD 09           	add hl,bc
 792++70DE
 793++70DE 11 86 A0     	ld de,outputBuffer
 794++70E1 A7           	and a
 795++70E2 ED 52        	sbc hl,de
 796++70E4
 797++70E4 7D           	ld a,l
 798++70E5 32 B5 73     	ld (sec_shift),a ;   
 799++70E8              	;ld hl,(temp_hl)
 800++70E8
 801++70E8
 802++70E8              	; or a
 803++70E8              	; jr z,fwrite_scl1
 804++70E8              	; inc b  ;  
 805++70E8
 806++70E8 78           	ld a,b ;    !!!
 807++70E9 32 B7 73     	ld (sec_part),a ;     
 808++70EC
 809++70EC              	;ld a,b
 810++70EC B7           	or a
 811++70ED 28 0A        	jr z,fwrite_scl1 ;    ,   
 812++70EF
 813++70EF 2A B3 73     	ld hl,(temp_hl2)
 814++70F2              	;push bc
 815++70F2              	;ld de,(#5cf4)
 816++70F2                  ;ld      c,6 ;  
 817++70F2 CD 27 71         call    scl_write_buf
 818++70F5              	;ld a,c
 819++70F5              	;pop bc
 820++70F5              	; cp 255
 821++70F5              	; jp z,fwrite_no_chek ;  
 822++70F5              	; ld de,(f_w_cur_trk)
 823++70F5              	; call calc_next_pos
 824++70F5              	; ld (f_w_cur_trk),de
 825++70F5
 826++70F5 AF           	xor a
 827++70F6 32 AE 73     	ld (write_end_flag),a ;    
 828++70F9
 829++70F9              fwrite_scl1
 830++70F9 3A AE 73     	ld a,(write_end_flag) ;  ?
 831++70FC B7           	or a
 832++70FD 20 12        	jr nz,fwrite_scl_ex ; 
 833++70FF
 834++70FF 2A B3 73     	ld hl,(temp_hl2) ;  
 835++7102 3A B7 73     	ld a,(sec_part)
 836++7105 47           	ld b,a
 837++7106 0E 00        	ld c,0
 838++7108 09           	add hl,bc
 839++7109 11 00 51     	ld de,sec_buf
 840++710C 01 00 01     	ld bc,256
 841++710F ED B0        	ldir
 842++7111              ;fwrite_scl2
 843++7111
 844++7111
 845++7111              fwrite_scl_ex
 846++7111 ED 4B AF 73  	ld bc,(temp_bc) ;,   ,    
 847++7115              	;   
 848++7115 2A AA 73     	ld hl,(f_w_len)
 849++7118 09           	add hl,bc
 850++7119 22 AA 73     	ld (f_w_len),hl
 851++711C 30 07        	jr nc,fwrite_scl_ex1
 852++711E 2A AC 73     	ld hl,(f_w_len+2)
 853++7121 23           	inc hl
 854++7122 22 AC 73     	ld (f_w_len+2),hl
 855++7125
 856++7125              fwrite_scl_ex1
 857++7125 AF           	xor a ; 
 858++7126 C9               ret
 859++7127
 860++7127
 861++7127
 862++7127
 863++7127
 864++7127
 865++7127              scl_write_buf ;  
 866++7127 C5           	push bc ;    b
 867++7128 11 00 53     	ld de,scl_buf ;    
 868++712B 01 00 01     	ld bc,256
 869++712E ED B0        	ldir
 870++7130 22 D9 73     	ld (scl_temp_hl2),hl ;  
 871++7133 3A C1 73     	ld a,(scl_que) ;    
 872++7136 B7           	or a
 873++7137 28 08        	jr z,scl_write_buf_ret ;      
 874++7139 21 41 71     	ld hl,scl_write_buf_ret ; 
 875++713C E5           	push hl
 876++713D 2A D3 73     	ld hl,(scl_parse_ret_adr) ;     
 877++7140 E9           	jp (hl) ;  256  
 878++7141              scl_write_buf_ret
 879++7141 2A D9 73     	ld hl,(scl_temp_hl2)
 880++7144 C1           	pop bc
 881++7145 10 E0        	djnz scl_write_buf
 882++7147
 883++7147 C9           	ret
 884++7148
 885++7148
 886++7148
 887++7148              scl_parse ;  scl  trd,  
 888++7148              	;  
 889++7148              ;    256 
 890++7148 22 D7 73     	ld (scl_temp_hl),hl
 891++714B ED 53 DB 73  	ld (scl_temp_de),de
 892++714F ED 43 DD 73  	ld (scl_temp_bc),bc
 893++7153 3E 01        	ld a,1
 894++7155 32 C1 73     	ld (scl_que),a ;    
 895++7158 21 5F 71     	ld hl,scl_parse_ret ;  
 896++715B 22 D3 73     	ld (scl_parse_ret_adr),hl
 897++715E C9           	ret ;   
 898++715F              scl_parse_ret
 899++715F AF           	xor a
 900++7160 32 C1 73     	ld (scl_que),a
 901++7163 2A D7 73     	ld hl,(scl_temp_hl)
 902++7166 ED 5B DB 73  	ld de,(scl_temp_de)
 903++716A ED 4B DD 73  	ld bc,(scl_temp_bc)
 904++716E
 905++716E 11 00 53     	ld de,scl_buf ;  
 906++7171 21 B9 73     	ld hl,scl_sign
 907++7174 06 08        	ld b,8
 908++7176              scl_parse_chk
 909++7176 1A           	ld a,(de)
 910++7177 BE           	cp (hl)
 911++7178 20 06        	jr nz,scl_parse_chk_no
 912++717A 23           	inc hl
 913++717B 13           	inc de
 914++717C 10 F8        	djnz scl_parse_chk
 915++717E 18 10        	jr scl_parse_chk_ok
 916++7180              scl_parse_chk_no ;  ,   
 917++7180 21 C2 73         ld hl, scl_err
 918++7183 CD 45 6A         call DialogBox.msgBox ;
 919++7186 AF           	xor a
 920++7187 32 C1 73     	ld (scl_que),a ;    
 921++718A 3E 04        	ld a,4 ; 
 922++718C CD 3D 6E     	call fclose
 923++718F C9           	ret
 924++7190              scl_parse_chk_ok ; 
 925++7190
 926++7190              ; 
 927++7190 3A 08 53     	ld a,(scl_buf+8)
 928++7193 32 D6 73     	ld (scl_files),a ; 
 929++7196 32 D5 73     	ld (scl_cat_cycl),a ;
 930++7199 21 09 53     	ld hl,scl_buf+9 ;  
 931++719C 11 00 48     	ld de,cat_buf ;   trd
 932++719F              scl_parse_cat2
 933++719F 06 0E        	ld b,14 ;14   
 934++71A1              scl_parse_cat
 935++71A1 7E           	ld a,(hl)
 936++71A2 12           	ld (de),a
 937++71A3 13           	inc de
 938++71A4 2C           	inc l ;      
 939++71A5 20 26        	jr nz,scl_parse_cat1
 940++71A7              	;    
 941++71A7              ;    256 
 942++71A7 22 D7 73     	ld (scl_temp_hl),hl
 943++71AA ED 53 DB 73  	ld (scl_temp_de),de
 944++71AE ED 43 DD 73  	ld (scl_temp_bc),bc
 945++71B2 3E 01        	ld a,1
 946++71B4 32 C1 73     	ld (scl_que),a ;    
 947++71B7 21 BE 71     	ld hl,scl_parse_ret1 ;  
 948++71BA 22 D3 73     	ld (scl_parse_ret_adr),hl
 949++71BD C9           	ret ;   
 950++71BE              scl_parse_ret1
 951++71BE AF           	xor a
 952++71BF 32 C1 73     	ld (scl_que),a
 953++71C2 2A D7 73     	ld hl,(scl_temp_hl)
 954++71C5 ED 5B DB 73  	ld de,(scl_temp_de)
 955++71C9 ED 4B DD 73  	ld bc,(scl_temp_bc)
 956++71CD
 957++71CD              scl_parse_cat1
 958++71CD 10 D2        	djnz scl_parse_cat
 959++71CF 13           	inc de
 960++71D0 13           	inc de
 961++71D1 3A D5 73     	ld a,(scl_cat_cycl)
 962++71D4 3D           	dec a
 963++71D5 32 D5 73     	ld (scl_cat_cycl),a
 964++71D8 20 C5        	jr nz,scl_parse_cat2
 965++71DA
 966++71DA 22 D7 73     	ld (scl_temp_hl),hl ;  
 967++71DD
 968++71DD              ;   
 969++71DD DD E5        	push ix
 970++71DF 3A D6 73     	ld a,(scl_files)
 971++71E2 11 00 01     	ld de,#0100 ;   
 972++71E5 DD 21 00 48  	ld ix,cat_buf
 973++71E9 DD 73 0E     	ld (ix+14),e
 974++71EC DD 72 0F     	ld (ix+15),d
 975++71EF 21 00 00     	ld hl,0 ;  
 976++71F2              scl_cacl
 977++71F2 32 D5 73     	ld (scl_cat_cycl),a ;
 978++71F5 DD 7E 0D     	ld a,(ix+13) ;   
 979++71F8 4F           	ld c,a
 980++71F9 06 00        	ld b,0
 981++71FB 09           	add hl,bc ;
 982++71FC
 983++71FC 01 10 00     	ld bc,16
 984++71FF DD 09        	add ix,bc
 985++7201 47           	ld b,a
 986++7202 CD 36 73     	call calc_next_pos
 987++7205 3A D5 73     	ld a,(scl_cat_cycl)
 988++7208 FE 01        	cp 1
 989++720A 28 06        	jr z,scl_cacl2 ;   
 990++720C DD 73 0E     	ld (ix+14),e
 991++720F DD 72 0F     	ld (ix+15),d
 992++7212              scl_cacl2
 993++7212 3D           	dec a
 994++7213 20 DD        	jr nz,scl_cacl
 995++7215              	;    
 996++7215 DD 7E 0D     	ld a,(ix+13) ;   
 997++7218 4F           	ld c,a
 998++7219 06 00        	ld b,0
 999++721B 09           	add hl,bc
1000++721C              	; ld b,a
1001++721C              	; call calc_next_pos
1002++721C ED 53 E1 50  	ld (cat_buf+8*256+#e1),de ;      
1003++7220 11 F0 09     	ld de,16*159
1004++7223 EB           	ex de,hl
1005++7224 A7           	and a
1006++7225 ED 52        	sbc hl,de
1007++7227 22 E5 50     	ld (cat_buf+8*256+#e5),hl ;    
1008++722A DD E1        	pop ix
1009++722C
1010++722C
1011++722C
1012++722C              ;  
1013++722C 3A D6 73     	ld a,(scl_files) ; 
1014++722F 32 D5 73     	ld (scl_cat_cycl),a ;
1015++7232 21 0D 48     	ld hl,cat_buf+13 ;   
1016++7235 22 DF 73     	ld (cat_cur_adr),hl
1017++7238
1018++7238 21 00 01     	ld hl,#0100 ;   
1019++723B 22 F4 5C     	ld (#5cf4),hl
1020++723E              scl_parse_file2
1021++723E 2A D7 73     	ld hl,(scl_temp_hl) ; 
1022++7241 ED 5B DF 73  	ld de,(cat_cur_adr) ;   
1023++7245              	;dec de
1024++7245 1A           	ld a,(de) ; , 
1025++7246 4F           	ld c,a
1026++7247              scl_parse_file3
1027++7247 11 00 55     	ld de,scl_buf2 ;   
1028++724A 06 00        	ld b,0 ;256   , 
1029++724C              scl_parse_file
1030++724C 7E           	ld a,(hl)
1031++724D 12           	ld (de),a
1032++724E 13           	inc de
1033++724F 2C           	inc l ;      
1034++7250 20 26        	jr nz,scl_parse_file1
1035++7252              	;    
1036++7252              ;    256 
1037++7252 22 D7 73     	ld (scl_temp_hl),hl
1038++7255 ED 53 DB 73  	ld (scl_temp_de),de
1039++7259 ED 43 DD 73  	ld (scl_temp_bc),bc
1040++725D 3E 01        	ld a,1
1041++725F 32 C1 73     	ld (scl_que),a ;    
1042++7262 21 69 72     	ld hl,scl_parse_ret2 ;  
1043++7265 22 D3 73     	ld (scl_parse_ret_adr),hl
1044++7268 C9           	ret ;   
1045++7269              scl_parse_ret2
1046++7269 AF           	xor a
1047++726A 32 C1 73     	ld (scl_que),a
1048++726D 2A D7 73     	ld hl,(scl_temp_hl)
1049++7270 ED 5B DB 73  	ld de,(scl_temp_de)
1050++7274 ED 4B DD 73  	ld bc,(scl_temp_bc)
1051++7278
1052++7278              scl_parse_file1
1053++7278 10 D2        	djnz scl_parse_file
1054++727A 22 D7 73     	ld (scl_temp_hl),hl
1055++727D ED 43 DD 73  	ld (scl_temp_bc),bc
1056++7281
1057++7281 21 00 55     	ld hl,scl_buf2 ;;  
1058++7284 ED 5B F4 5C  	ld  de,(#5cf4)
1059++7288 01 06 01         ld      bc,#0106 ;
1060++728B CD 39 6E         call    call3d13
1061++728E              	; ld a,c
1062++728E              	; cp 255
1063++728E              	; jp z,fwrite_no_chek ;  
1064++728E 2A D7 73     	ld hl,(scl_temp_hl)
1065++7291 ED 4B DD 73  	ld bc,(scl_temp_bc)
1066++7295
1067++7295 0D           	dec c
1068++7296 20 AF        	jr nz,scl_parse_file3
1069++7298
1070++7298 2A DF 73     	ld hl,(cat_cur_adr) ;   
1071++729B              	; ld e,(hl)
1072++729B              	; inc hl
1073++729B              	; ld d,(hl)
1074++729B 01 10 00     	ld bc,16
1075++729E 09           	add hl,bc ;  
1076++729F 22 DF 73     	ld (cat_cur_adr),hl
1077++72A2
1078++72A2
1079++72A2 3A D5 73     	ld a,(scl_cat_cycl)
1080++72A5 3D           	dec a
1081++72A6 32 D5 73     	ld (scl_cat_cycl),a
1082++72A9 20 93        	jr nz,scl_parse_file2	;  
1083++72AB
1084++72AB
1085++72AB
1086++72AB              ;   9 (8)
1087++72AB              	;
1088++72AB              	;ld (cat_buf+8*256+#e1),a ;// #E1     
1089++72AB              	;
1090++72AB              	;ld (cat_buf+8*256+#e2),a ;// #E2   
1091++72AB 3E 16        	ld a,#16
1092++72AD 32 E3 50     	ld (cat_buf+8*256+#e3),a ;// #E3 16 80 , 2 
1093++72B0 3A D6 73     	ld a,(scl_files)
1094++72B3 32 E4 50     	ld (cat_buf+8*256+#e4),a ;// #E4      
1095++72B6              	;
1096++72B6              	;ld (cat_buf+8*256+#e5),a ;// #5,6     
1097++72B6              	;ld (cat_buf+8*256+#e6),a
1098++72B6 3E 10        	ld a,#10
1099++72B8 32 E7 50     	ld (cat_buf+8*256+#e7),a ;// #E7   #10,   TR-DOS
1100++72BB
1101++72BB 21 90 73     	ld hl,f_name ;  ,     
1102++72BE 11 F5 50     	ld de,cat_buf+8*256+#f5 ;// #F5-#FC    ASCII 
1103++72C1 01 08 00     	ld bc,8
1104++72C4 ED B0        	ldir
1105++72C6
1106++72C6 21 00 48     	ld hl,cat_buf ;   
1107++72C9 11 00 00     	ld de,0
1108++72CC 01 06 09         ld      bc,#0906 ;
1109++72CF CD 39 6E         call    call3d13
1110++72D2              	; ld a,c
1111++72D2              	; cp 255
1112++72D2              	; jp z,fwrite_no_chek ;  
1113++72D2 C9           	ret
1114++72D3
1115++72D3
1116++72D3              ;-----------scl end --------------------
1117++72D3
1118++72D3
1119++72D3
1120++72D3
1121++72D3
1122++72D3
1123++72D3
1124++72D3
1125++72D3
1126++72D3
1127++72D3              ; A - file stream id
1128++72D3              ; fsync:
1129++72D3              ;     esxCall ESX_FSYNC
1130++72D3                  ; ret
1131++72D3
1132++72D3
1133++72D3              ; HL - name (name.ext)
1134++72D3              ; Returns:
1135++72D3              ; HL - name (name    e)
1136++72D3              format_name ;     trdos (8+1)
1137++72D3
1138++72D3              	;     ,   
1139++72D3 22 B1 73     	ld (temp_hl),hl ;   
1140++72D6 06 00        	ld b,#00 ;  255 
1141++72D8              format_name5
1142++72D8 7E           	ld a,(hl)
1143++72D9 FE 2F        	cp "/" ;  
1144++72DB 28 0D        	jr z,format_name_path_yep
1145++72DD 7E           	ld a,(hl)
1146++72DE FE 2E        	cp "." ;     
1147++72E0 20 05        	jr nz,format_name6
1148++72E2 2A B1 73     	ld hl,(temp_hl) ;   ,   ,    
1149++72E5 18 04        	jr format_name_7 ; 
1150++72E7              format_name6
1151++72E7 23           	inc hl
1152++72E8 10 EE        	djnz format_name5
1153++72EA
1154++72EA              format_name_path_yep ;
1155++72EA 23           	inc hl ;  "/"
1156++72EB
1157++72EB              format_name_7
1158++72EB
1159++72EB E5           	push hl ;    
1160++72EC 21 90 73     	ld hl,f_name
1161++72EF 11 91 73     	ld de,f_name+1
1162++72F2 36 20        	ld (hl)," "
1163++72F4 01 09 00     	ld bc,8+1
1164++72F7 ED B0        	ldir
1165++72F9 36 00        	ld (hl),0
1166++72FB 01 06 00     	ld bc,16-8-1-1
1167++72FE ED B0        	ldir
1168++7300 E1           	pop hl
1169++7301
1170++7301 01 FF 09     	ld bc,#09ff ;  9 
1171++7304 11 90 73     	ld de,f_name ;
1172++7307              format_name2
1173++7307 7E           	ld a,(hl)
1174++7308 FE 2E        	cp "."
1175++730A 20 0C        	jr nz,format_name1
1176++730C 11 98 73     	ld de,f_name+8
1177++730F 23           	inc hl
1178++7310 ED A0        	ldi ;     3 
1179++7312 ED A0        	ldi
1180++7314 ED A0        	ldi
1181++7316              	;ex de,hl ;   
1182++7316 18 1A        	jr format_name_e
1183++7318              format_name1
1184++7318 ED A0        	ldi
1185++731A 10 EB        	djnz format_name2
1186++731C
1187++731C              	;  ,    
1188++731C 06 00        	ld b,#00 ;  255 
1189++731E              format_name3
1190++731E 7E           	ld a,(hl)
1191++731F FE 2E        	cp "."
1192++7321 20 0C        	jr nz,format_name4
1193++7323 11 98 73     	ld de,f_name+8
1194++7326 23           	inc hl
1195++7327 ED A0        	ldi ;     3 
1196++7329 ED A0        	ldi
1197++732B ED A0        	ldi
1198++732D              	;ex de,hl ;   
1199++732D 18 03        	jr format_name_e
1200++732F              format_name4
1201++732F 23           	inc hl
1202++7330 10 EC        	djnz format_name3
1203++7332
1204++7332              format_name_e ;
1205++7332 21 90 73     	ld hl,f_name ; 
1206++7335 C9           	ret
1207++7336
1208++7336              ; DE - trk/sec
1209++7336              ; B - sectors step
1210++7336              ; Returns:
1211++7336              ; DE - trk/sec
1212++7336              calc_next_pos		;  N 
1213++7336              			;ld b,4
1214++7336              			;ld  de,(#5ceb)
1215++7336              calc_next_pos2
1216++7336 1C           			inc e
1217++7337 7B           			ld a,e
1218++7338 FE 10        			cp 16
1219++733A 38 03        			jr c,calc_next_pos1
1220++733C 14           			inc d
1221++733D 1E 00        			ld e,0
1222++733F              calc_next_pos1
1223++733F              			;ld (#5ceb),de
1224++733F 10 F5        			djnz calc_next_pos2
1225++7341 C9           			ret
1226++7342
1227++7342
1228++7342              ;testt db "123.trd"
1229++7342 53 65 6C 65  write_ima db "Select disk "
1229++7346 63 74 20 64
1229++734A 69 73 6B 20
1230++734E 41 3A 20 28  write_ima_d db "A: (A-D). "
1230++7352 41 2D 44 29
1230++7356 2E 20
1231++7358 41 6C 6C 20  		db "All data may be lost! Press Y or N.",0
1231++735C 64 61 74 61
1231++7360 20 6D 61 79
1231++7364 20 62 65 20
1231++7368 6C 6F 73 74
1231++736C 21 20 50 72
1231++7370 65 73 73 20
1231++7374 59 20 6F 72
1231++7378 20 4E 2E 00
1232++737C              ;prev_drive db 0 ;  
1233++737C
1234++737C 2E 74 72 64  trdExt1 db ".trd", 0
1234++7380 00
1235++7381 2E 54 52 44  trdExt2 db ".TRD", 0
1235++7385 00
1236++7386
1237++7386 2E 73 63 6C  sclExt1 db ".scl", 0
1237++738A 00
1238++738B 2E 53 43 4C  sclExt2 db ".SCL", 0
1238++738F 00
1239++7390
1240++7390 00 00 00...  f_name ds 16 ; 
1241++73A0 00 00        f_r_cur_trk dw 	 0 ; -   
1242++73A2 00           f_r_len_sec db 0 ;     
1243++73A3 00 00        f_r_len dw 0;   
1244++73A5 00           f_r_flag db 0 ;     
1245++73A6
1246++73A6 00 00        f_w_cur_trk dw 	 0 ; -   
1247++73A8 00           f_w_len_sec db 0 ;     
1248++73A9 00           f_w_flag db 0 ;     
1249++73AA 00 00 00 00  f_w_len ds 4 ;  
1250++73AE 00           write_end_flag db 0 ;    
1251++73AF
1252++73AF 00 00        temp_bc dw 0 ; 
1253++73B1 00 00        temp_hl dw 0 ; 
1254++73B3 00 00        temp_hl2 dw 0 ; 
1255++73B5
1256++73B5 00           sec_shift db 0 ;     
1257++73B6 00           sec_shift2 db 0 ;      ()
1258++73B7 00           sec_part db 0 ;      
1259++73B8 00           sec_shift_flag db 0 ;     
1260++73B9
1261++73B9              ; scl
1262++73B9 53 49 4E 43  scl_sign db "SINCLAIR" ;
1262++73BD 4C 41 49 52
1263++73C1 00           scl_que db 0 ;   
1264++73C2 53 43 4C 20  scl_err db "SCL image error!",0
1264++73C6 69 6D 61 67
1264++73CA 65 20 65 72
1264++73CE 72 6F 72 21
1264++73D2 00
1265++73D3 00 00        scl_parse_ret_adr dw 0;    
1266++73D5 00           scl_cat_cycl db 0 ; 
1267++73D6 00           scl_files db 0 ; 
1268++73D7 00 00        scl_temp_hl dw 0;; 
1269++73D9 00 00        scl_temp_hl2 dw 0;
1270++73DB 00 00        scl_temp_de dw 0;
1271++73DD 00 00        scl_temp_bc dw 0;
1272++73DF 00 00        cat_cur_adr dw 0;
1273++73E1              ;scl end
1274++73E1
1275++73E1              ;   
1276++73E1 4E 6F 74 20  file_err db "Not enough space!",0
1276++73E5 65 6E 6F 75
1276++73E9 67 68 20 73
1276++73ED 70 61 63 65
1276++73F1 21 00
1277++73F3 00           sec_cat db 0 ; 
1278++73F4 30           file_num db "0" ;    
1279++73F5
1280++73F5              	;  #4000 
1281++73F5              cat_buf equ #4800 ;    9*256
1282++73F5              sec_buf equ cat_buf + 9*256 ;    256
1283++73F5              scl_buf equ sec_buf + 512 ;  256
1284++73F5              scl_buf2 equ scl_buf + 512 ;  256
1285++73F5
1286++73F5                  ENDMODULE
# file closed: dos/trdos.asm
   9++73F5              	ENDIF
  10++73F5
  11++73F5              	IFDEF ESXDOS
  12++73F5 ~               		include "console.asm"
  13++73F5 ~               		include "esxdos.asm"
  14++73F5              	ENDIF
  15++73F5
  16++73F5              	IFDEF P3DOS
  17++73F5 ~               		include "console.asm"
  18++73F5 ~               		include "p3dos.asm"
  19++73F5              	ENDIF
  20++73F5
# file closed: dos/index.asm
  19+ 73F5                  include "gopher/engine/history/index.asm"
# file opened: gopher/engine/history/index.asm
   1++73F5                  include "controler.asm"
# file opened: gopher/engine/history/controler.asm
   1++73F5                  module History
   2++73F5              back:
   3++73F5 3A 35 75         ld a, (depth)
   3++73F8 FE 01          cp 1
   3++73FA CA 0C 74       jp z, load
   4++73FD 21 84 78 11      ld hl, historyBlock + HistoryRecord, de, historyBlock, bc, (total - 1) * HistoryRecord
   4++7401 36 75 01 38
   4++7405 0D
   4++7406 ED B0          ldir ; Move history up
   5++7408 21 35 75         ld hl, depth
   5++740B 35             dec (hl)
   6++740C              ; Loads current resource
   7++740C              load:
   8++740C 21 29 74         ld hl, .msg
   8++740F CD 4E 6A       call DialogBox.msgNoWait
   9++7412 AF               xor a
   9++7413 21 86 A0 11    ld hl, outputBuffer, de, outputBuffer + 1
   9++7417 87 A0
  10++7419              	IFDEF MSX
  11++7419 ~                	ld bc, (ramtop)
  12++7419 ~                	dec bc
  13++7419              	ELSE
  14++7419 01 78 5F         	ld bc, #ffff - outputBuffer - 1
  15++741C              	ENDIF
  16++741C
  17++741C 77               ld (hl), a
  18++741D ED B0            ldir
  19++741F
  20++741F 3A 36 75         ld a, (historyBlock.isFile)
  20++7422 A7             and a
  20++7423 C2 20 8A       jp nz, Fetcher.fetchFromFS
  21++7426 C3 D3 89         jp Fetcher.fetchFromNet
  22++7429
  23++7429 20 20 20 20  .msg db "    Loading resource! Please wait! It will be here soon!", 0
  23++742D 4C 6F 61 64
  23++7431 69 6E 67 20
  23++7435 72 65 73 6F
  23++7439 75 72 63 65
  23++743D 21 20 50 6C
  23++7441 65 61 73 65
  23++7445 20 77 61 69
  23++7449 74 21 20 49
  23++744D 74 20 77 69
  23++7451 6C 6C 20 62
  23++7455 65 20 68 65
  23++7459 72 65 20 73
  23++745D 6F 6F 6E 21
  23++7461 00
  24++7462
  25++7462              home:
  26++7462 21 13 75         ld hl, homePage
  27++7465              ; HL - gopher row
  28++7465              navigate:
  29++7465 54 5D            ld de, hl
  30++7467 CD 4B 89         call UrlEncoder.isValidGopherRow
  31++746A 30 A0            jr nc, load ; Not valid - reload last
  32++746C 62 6B            ld hl, de
  33++746E E5               push hl
  34++746F
  35++746F E5               push hl
  36++7470 21 BB 85 11      ld hl, HistoryEnd - HistoryRecord, de, HistoryEnd, bc,  HistoryRecord * total
  36++7474 09 89 01 86
  36++7478 10
  36++7479 ED B8          lddr
  37++747B
  38++747B ED 5B 7C 78      ld de, (Render.position), (historyBlock.position + HistoryRecord), de
  38++747F ED 53 CA 7B
  39++7483                  ; Clean up struct
  40++7483 AF               xor a
  40++7484 21 36 75 11    ld hl, historyBlock, de, historyBlock + 1, bc, historyBlockSize - 1, (hl), a
  40++7488 37 75 01 4D
  40++748C 03 77
  40++748E ED B0          ldir
  41++7490 E1               pop hl
  42++7491
  43++7491                  ; Fill record
  44++7491 54 5D            ld de, hl
  45++7493 CD 0A 89         call UrlEncoder.isFile
  46++7496 EB               ex hl, de
  47++7497 11 36 75         ld de, historyBlock
  48++749A 12               ld (de), a
  48++749B 13             inc de
  49++749C 7E               ld a, (hl)
  49++749D E5 D5          push hl, de
  49++749F CD 8E 64       call Render.getIcon
  49++74A2 D1 E1          pop de, hl
  50++74A4 12               ld (de), a
  50++74A5 13             inc de
  51++74A6 3E 09            ld a, 9
  52++74A8
  53++74A8 01 FF 01         ld bc, #1ff
  54++74AB
  55++74AB ED B1            cpir
  56++74AD              .locatorCopy
  57++74AD 7E               ld a, (hl)
  57++74AE FE 09          cp 9
  57++74B0 28 05          jr z, 1f
  58++74B2 12               ld (de), a
  58++74B3 23 13          inc hl, de
  59++74B5 18 F6            jr .locatorCopy
  60++74B7              1
  61++74B7 23               inc hl
  61++74B8 AF             xor a
  61++74B9 12             ld (de), a
  62++74BA 11 37 77         ld de, historyBlock.host
  63++74BD              .hostCopy
  64++74BD 7E               ld a, (hl)
  64++74BE FE 09          cp 9
  64++74C0 28 05          jr z, 1f
  65++74C2 12               ld (de), a
  65++74C3 23 13          inc hl, de
  66++74C5 18 F6            jr .hostCopy
  67++74C7              1
  68++74C7 23               inc hl
  68++74C8 AF             xor a
  68++74C9 12             ld (de), a
  69++74CA 11 77 77         ld de, historyBlock.port
  70++74CD              .portCopy
  71++74CD 7E               ld a, (hl)
  72++74CE FE 09            cp 9
  72++74D0 28 11          jr z, 1f
  73++74D2 FE 0D            cp 13
  73++74D4 28 0D          jr z, 1f
  74++74D6 FE 0A            cp 10
  74++74D8 28 09          jr z, 1f
  75++74DA FE 00            cp 0
  75++74DC 28 05          jr z, 1f
  76++74DE 12               ld (de), a
  76++74DF 23 13          inc hl, de
  77++74E1 18 EA            jr .portCopy
  78++74E3 AF           1   xor a
  78++74E4 12             ld (de), a
  79++74E5 21 F5 69 11      ld hl, DialogBox.inputBuffer, de, historyBlock.search, bc, #ff
  79++74E9 7D 77 01 FF
  79++74ED 00
  79++74EE ED B0          ldir
  80++74F0 11 00 00 ED      ld de, 0, (historyBlock.position), de
  80++74F4 53 7C 78
  81++74F7 E1               pop hl
  82++74F8 3A 35 75         ld a, (depth)
  82++74FB FE 05          cp total
  82++74FD 30 04          jr nc, 1f
  83++74FF 3C               inc a
  83++7500 32 35 75       ld (depth), a
  84++7503              1
  85++7503 3A 37 75         ld a,(historyBlock.mediaType)
  85++7506 FE 01          cp MIME_DOWNLOAD
  85++7508 CA 23 8B       jp z, Gopher.download
  86++750B
  87++750B                  ifdef GS
  88++750B FE 07            cp MIME_MOD
  88++750D CA C2 8A       jp z, Gopher.loadMod
  89++7510                  endif
  90++7510
  91++7510 C3 0C 74         jp load
  92++7513
  93++7513              homePage:
  94++7513              	IFDEF MSX
  95++7513 ~                	db "1Home", TAB, "index.gph"
  96++7513 ~                	db TAB, "file", TAB, "70", CR, LF, 0
  97++7513                  ELSE
  98++7513 31 48 6F 6D      	db "1Home", TAB, "browser/index.gph"
  98++7517 65 09 62 72
  98++751B 6F 77 73 65
  98++751F 72 2F 69 6E
  98++7523 64 65 78 2E
  98++7527 67 70 68
  99++752A 09 66 69 6C      	db TAB, "file", TAB, "70", CR, LF, 0
  99++752E 65 09 37 30
  99++7532 0D 0A 00
 100++7535                  ENDIF
 101++7535                  endmodule
# file closed: gopher/engine/history/controler.asm
   2++7535                  include "model.asm"
# file opened: gopher/engine/history/model.asm
   1++7535              total   equ 5
   2++7535 00           depth   db 0
   3++7536
   4++7536              historyBlock:
   5++7536 00           .isFile    db  0
   6++7537 00           .mediaType db  0
   7++7538 00 00 00...  .locator   ds  #1ff
   8++7737 00 00 00...  .host      ds  64
   9++7777 00 00 00...  .port      ds  6
  10++777D 00 00 00...  .search    ds  #ff
  11++787C 00 00        .position  dw  #0000    ;position
  12++787E
  13++787E 00 00 00 00      db 0,0,0,0,0,0  ;cursor_position page_offset
  13++7882 00 00
  14++7884
  15++7884              historyBlockSize = $ - historyBlock
  16++7884
  17++7884              HistoryRecord EQU $ - historyBlock
  18++7884                  dup total
  19++7884 00 00 00... >    ds HistoryRecord
  19++7BD2 00 00 00... >    ds HistoryRecord
  19++7F20 00 00 00... >    ds HistoryRecord
  19++826E 00 00 00... >    ds HistoryRecord
  19++85BC 00 00 00... >    ds HistoryRecord
  20++890A                  edup
  21++890A              HistoryEnd equ $ - 1
  22++890A
# file closed: gopher/engine/history/model.asm
# file closed: gopher/engine/history/index.asm
  20+ 890A                  include "gopher/engine/urlencoder.asm"
# file opened: gopher/engine/urlencoder.asm
   1++890A                  MODULE UrlEncoder
   2++890A              ; HL - pointer to line in gopher page
   3++890A              ; C - flag set when it's file
   4++890A              isFile:
   5++890A              .findServerLoop
   6++890A 7E               ld a, (hl)
   6++890B A7             and a
   6++890C 28 3B          jr z, .notFile
   6++890E 23             inc hl
   7++890F FE 0D            cp 13
   7++8911 28 36          jr z, .notFile
   8++8913 FE 09            cp 9
   8++8915 28 02          jr z, .skipPath
   9++8917 18 F1            jr .findServerLoop
  10++8919              .skipPath
  11++8919 7E               ld a, (hl)
  11++891A A7             and a
  11++891B 28 2C          jr z, .notFile
  11++891D 23             inc hl
  12++891E FE 0D            cp 13
  12++8920 28 27          jr z, .notFile
  13++8922 FE 09            cp 9
  13++8924 28 02          jr z, .compareServer
  14++8926 18 F1            jr .skipPath
  15++8928              .compareServer
  16++8928 7E               ld a, (hl)
  16++8929 FE 66          cp "f"
  16++892B 20 1C          jr nz, .notFile
  16++892D 23             inc hl
  17++892E 7E               ld a, (hl)
  17++892F FE 69          cp "i"
  17++8931 20 16          jr nz, .notFile
  17++8933 23             inc hl
  18++8934 7E               ld a, (hl)
  18++8935 FE 6C          cp "l"
  18++8937 20 10          jr nz, .notFile
  18++8939 23             inc hl
  19++893A 7E               ld a, (hl)
  19++893B FE 65          cp "e"
  19++893D 20 0A          jr nz, .notFile
  19++893F 23             inc hl
  20++8940 7E               ld a, (hl)
  20++8941 FE 09          cp 9
  20++8943 20 04          jr nz, .notFile
  20++8945 23             inc hl
  21++8946 3E 01            ld a, 1
  22++8948 C9               ret
  23++8949              .notFile
  24++8949 AF               xor a
  25++894A C9               ret
  26++894B
  27++894B              ; Is enough fields to encode
  28++894B              ; HL - pointer to line in gopher page
  29++894B              ; C - flag set when there is enough fields
  30++894B              isValidGopherRow:
  31++894B 7E               ld a, (hl)
  31++894C A7             and a
  31++894D 28 FA          jr z, isFile.notFile
  31++894F 23             inc hl
  32++8950 FE 0D            cp 13
  32++8952 28 F5          jr z, isFile.notFile
  33++8954 FE 09            cp 9
  33++8956 28 02          jr z, .skipPath
  34++8958 18 F1            jr isValidGopherRow
  35++895A              .skipPath
  36++895A 7E               ld a, (hl)
  36++895B A7             and a
  36++895C 28 EB          jr z, isFile.notFile
  36++895E 23             inc hl
  37++895F FE 0D            cp 13
  37++8961 28 E6          jr z, isFile.notFile
  38++8963 FE 09            cp 9
  38++8965 28 02          jr z, .skipHost
  39++8967 18 F1            jr .skipPath
  40++8969              .skipHost
  41++8969 7E               ld a, (hl)
  41++896A A7             and a
  41++896B 28 DC          jr z, isFile.notFile
  41++896D 23             inc hl
  42++896E FE 0D            cp 13
  42++8970 28 D7          jr z, isFile.notFile
  43++8972 FE 09            cp 9
  43++8974 28 02           jr z, .isValid
  44++8976 18 F1            jr .skipHost
  45++8978              .isValid:
  46++8978 37               scf
  47++8979 C9               ret
  48++897A
  49++897A              extractPath:
  50++897A 21 38 75 11      ld hl, historyBlock.locator, de, Gopher.requestbuffer, bc, #ff
  50++897E 19 8C 01 FF
  50++8982 00
  50++8983 ED B0          ldir
  51++8985 C9               ret
  52++8986
  53++8986              extractHostName:
  54++8986 21 37 77 11      ld hl, historyBlock.host, de, hostName, bc, 64
  54++898A 93 89 01 40
  54++898E 00
  54++898F ED B0          ldir
  55++8991 C9               ret
  56++8992
  57++8992                  ENDMODULE
  58++8992
  59++8992              ;nameBuffer ds #ff, 0
  60++8992
  61++8992 00                    db 0
  62++8993 00 00 00...  hostName ds 64
# file closed: gopher/engine/urlencoder.asm
  21+ 89D3                  include "gopher/engine/fetcher.asm"
# file opened: gopher/engine/fetcher.asm
   1++89D3                  MODULE Fetcher
   2++89D3
   3++89D3              fetchFromNet:
   4++89D3
   5++89D3              	IFDEF MSX
   6++89D3 ~                	call Gopher.makeRequest
   6++89D3 ~              jr nz, .error
   7++89D3                  ELSE
   8++89D3 CD 9A 8A         	call Gopher.makeRequest
   8++89D6 38 06          jr c, .error
   9++89D8                  ENDIF
  10++89D8
  11++89D8 CD B2 8A         call Gopher.loadBuffer
  12++89DB C3 2C 8A         jp MediaProcessor.processResource
  13++89DE              .error
  14++89DE 21 E7 89         ld hl, .err
  14++89E1 CD 45 6A       call DialogBox.msgBox
  15++89E4 C3 F5 73         jp History.back
  16++89E7
  17++89E7 44 6F 63 75  .err db "Document fetch error! Check your connection or hostname!", 0
  17++89EB 6D 65 6E 74
  17++89EF 20 66 65 74
  17++89F3 63 68 20 65
  17++89F7 72 72 6F 72
  17++89FB 21 20 43 68
  17++89FF 65 63 6B 20
  17++8A03 79 6F 75 72
  17++8A07 20 63 6F 6E
  17++8A0B 6E 65 63 74
  17++8A0F 69 6F 6E 20
  17++8A13 6F 72 20 68
  17++8A17 6F 73 74 6E
  17++8A1B 61 6D 65 21
  17++8A1F 00
  18++8A20
  19++8A20
  20++8A20              fetchFromFS:
  21++8A20 CD 7A 89         call UrlEncoder.extractPath
  22++8A23              loadFile
  23++8A23              	IFDEF MSX
  24++8A23 ~                ld de, Gopher.requestbuffer, a, FMODE_NO_WRITE
  25++8A23 ~                call Dos.fopen
  26++8A23 ~                ld a, b, (.fp), a
  27++8A23 ~                ld de, outputBuffer, hl, (ramtop)
  28++8A23 ~                call Dos.fread
  29++8A23 ~                ld a, (.fp), b, a
  30++8A23 ~                call Dos.fclose
  31++8A23 ~                jp MediaProcessor.processResource
  32++8A23 ~            .fp db 0
  33++8A23              	ELSE
  34++8A23 21 19 8C         ld hl, Gopher.requestbuffer
  35++8A26 CD D6 6C         call Dos.loadBuffer
  36++8A29 C3 2C 8A         jp MediaProcessor.processResource
  37++8A2C              	ENDIF
  38++8A2C                  ENDMODULE
# file closed: gopher/engine/fetcher.asm
  22+ 8A2C                  include "gopher/engine/media-processor.asm"
# file opened: gopher/engine/media-processor.asm
   1++8A2C                  MODULE MediaProcessor
   2++8A2C              processResource:
   3++8A2C CD 86 89         call UrlEncoder.extractHostName
   4++8A2F 3A 37 75         ld a, (historyBlock.mediaType)
   5++8A32 FE 05            cp MIME_MUSIC
   5++8A34 28 17          jr z, processPT
   6++8A36 FE 02            cp MIME_LINK
   6++8A38 28 1F          jr z, processPage
   7++8A3A FE 04            cp MIME_INPUT
   7++8A3C 28 1B          jr z, processPage
   8++8A3E FE 06            cp MIME_IMAGE
   8++8A40 CA F8 93       jp z, ScreenViewer.display
   9++8A43              	ifdef GS
  10++8A43 FE 07            cp MIME_MOD
  10++8A45 28 0C          jr z, processMOD
  11++8A47              	endif
  12++8A47              ; Fallback to plain text
  13++8A47              processText:
  14++8A47 CD AD 68         call Render.renderPlainTextScreen
  15++8A4A C3 F5 68         jp   Render.plainTextLoop
  16++8A4D
  17++8A4D              processPT:
  18++8A4D CD 1D 94         call VortexProcessor.play
  19++8A50 C3 F5 73         jp History.back
  20++8A53
  21++8A53                  ifdef GS
  22++8A53              processMOD:
  23++8A53 CD 53 93         call ModProcessor.play
  24++8A56 C3 F5 73         jp History.back
  25++8A59              	endif
  26++8A59
  27++8A59              processPage:
  28++8A59 3A 8F 69         ld a, (Render.play_next)
  28++8A5C A7             and a
  28++8A5D 20 06          jr nz, .playNext
  29++8A5F CD 01 67         call Render.renderGopherScreen
  30++8A62 C3 50 67         jp   Render.workLoop
  31++8A65              .playNext
  32++8A65 21 7E 78         ld hl, Render.cursor_position
  33++8A68 34               inc (hl)
  34++8A69 CD 01 67         call Render.renderGopherScreen
  35++8A6C C3 3A 67         jp Render.checkBorder
  36++8A6F                  ENDMODULE
# file closed: gopher/engine/media-processor.asm
  23+ 8A6F                  include "gopher/gopher.asm"
# file opened: gopher/gopher.asm
   1++8A6F                  module Gopher
   2++8A6F              ; HL - gopher row
   3++8A6F              extractRequest:
   4++8A6F 21 38 75         ld hl, historyBlock.locator
   5++8A72 11 19 8C         ld de, requestbuffer
   6++8A75              .loop
   7++8A75 7E               ld a, (hl)
   8++8A76 12               ld (de), a
   9++8A77 23               inc hl
  10++8A78 13               inc de
  11++8A79 FE 00            cp 0
  12++8A7B 28 02            jr z, .search
  13++8A7D 18 F6            jr .loop
  14++8A7F              .search
  15++8A7F 1B               dec de
  16++8A80 3A 37 75         ld a, (historyBlock.mediaType)
  17++8A83 FE 04            cp MIME_INPUT
  18++8A85 20 10            jr nz, .exit
  19++8A87 21 7D 77         ld hl, historyBlock.search
  20++8A8A 3E 09            ld a, TAB
  21++8A8C 12               ld (de), a
  22++8A8D 13               inc de
  23++8A8E              .searchCopy
  24++8A8E 7E               ld a, (hl)
  25++8A8F A7               and a
  25++8A90 28 05          jr z, .exit
  26++8A92 12               ld (de), a
  27++8A93 23               inc hl
  27++8A94 13             inc de
  28++8A95 18 F7            jr .searchCopy
  29++8A97              .exit
  30++8A97 AF               xor a
  31++8A98 12               ld (de), a
  32++8A99 C9               ret
  33++8A9A
  34++8A9A
  35++8A9A              makeRequest:
  36++8A9A CD 6F 8A         call extractRequest
  37++8A9D
  38++8A9D 21 37 77         ld hl, historyBlock.host
  39++8AA0 11 77 77         ld de, historyBlock.port
  40++8AA3 CD C5 90         call Wifi.openTCP
  41++8AA6 D8               ret c
  42++8AA7
  43++8AA7 21 19 8C         ld hl, requestbuffer
  44++8AAA CD B5 91         call Wifi.tcpSendZ
  45++8AAD AF               xor a
  45++8AAE 32 90 8F       ld (Wifi.closed), a
  46++8AB1 C9               ret
  47++8AB2
  48++8AB2
  49++8AB2              loadBuffer:
  50++8AB2 21 86 A0         ld hl, outputBuffer
  51++8AB5 22 8E 8F         ld (Wifi.buffer_pointer), hl
  52++8AB8              .loop
  53++8AB8 CD 05 92         call Wifi.getPacket
  54++8ABB 3A 90 8F         ld a, (Wifi.closed)
  55++8ABE A7               and a
  56++8ABF C0               ret nz
  57++8AC0                  ;call Wifi.continue
  58++8AC0 18 F6            jr .loop
  59++8AC2
  60++8AC2                  ifdef GS
  61++8AC2              loadMod:
  62++8AC2 AF               xor a
  62++8AC3 CD EE 92       call GeneralSound.init
  63++8AC6 21 03 8B         ld hl, .progress
  63++8AC9 CD 4E 6A       call DialogBox.msgNoWait
  64++8ACC CD 9A 8A         call makeRequest
  64++8ACF DA DE 89       jp c, Fetcher.fetchFromNet.error
  65++8AD2 CD FB 92         call GeneralSound.loadModule
  66++8AD5              .loop
  67++8AD5 21 86 A0 22      ld hl, outputBuffer, (Wifi.buffer_pointer), hl
  67++8AD9 8E 8F
  68++8ADB CD 05 92         call Wifi.getPacket
  69++8ADE 3A 90 8F         ld a, (Wifi.closed)
  69++8AE1 A7             and a
  69++8AE2 20 19          jr nz, .exit
  70++8AE4 21 86 A0 ED      ld hl, outputBuffer, bc, (Wifi.bytes_avail)
  70++8AE8 4B 8C 8F
  71++8AEB              .loadLoop
  72++8AEB 78               ld a, b
  72++8AEC B1             or c
  72++8AED A7             and a
  72++8AEE 28 08          jr z, .nextFrame
  73++8AF0 7E               ld a, (hl)
  73++8AF1 CD 0E 93       call GeneralSound.sendByte
  74++8AF4 0B               dec bc
  75++8AF5 23               inc hl
  76++8AF6 18 F3            jr .loadLoop
  77++8AF8              .nextFrame
  78++8AF8 CD F9 8B         call pulsing
  79++8AFB                  ;call Wifi.continue
  80++8AFB 18 D8            jr .loop
  81++8AFD              .exit
  82++8AFD CD 16 93         call GeneralSound.finishLoadingModule
  83++8B00                  ;jp History.back
  84++8B00 C3 2C 8A     	jp MediaProcessor.processResource
  85++8B03 4D 4F 44 20  .progress db "MOD downloading directly to GS!", 0
  85++8B07 64 6F 77 6E
  85++8B0B 6C 6F 61 64
  85++8B0F 69 6E 67 20
  85++8B13 64 69 72 65
  85++8B17 63 74 6C 79
  85++8B1B 20 74 6F 20
  85++8B1F 47 53 21 00
  86++8B23                  endif
  87++8B23
  88++8B23              download:
  89++8B23 11 38 75         ld de, historyBlock.locator
  90++8B26 62 6B            ld hl, de
  91++8B28              .findFileName
  92++8B28 1A               ld a, (de)
  92++8B29 13             inc de
  93++8B2A FE 2F            cp '/'
  93++8B2C 20 02          jr nz, .skip
  94++8B2E 62 6B            ld hl, de
  95++8B30              .skip
  96++8B30 A7               and a
  96++8B31 20 F5          jr nz, .findFileName
  97++8B33              .copy
  98++8B33                  ;; HL - filename pointer
  99++8B33 11 F5 69         ld de, DialogBox.inputBuffer
 100++8B36              .copyFileName
 101++8B36 7E               ld a, (hl)
 101++8B37 A7             and a
 101++8B38 28 05          jr z, .finishCopy
 102++8B3A
 103++8B3A 12               ld (de), a
 103++8B3B 23 13          inc hl, de
 104++8B3D 18 F7            jr .copyFileName
 105++8B3F              .finishCopy
 106++8B3F 12               ld (de), a
 107++8B40 CD 94 69         call DialogBox.inputBox.noclear
 108++8B43 3A F5 69         ld a, (DialogBox.namedownload)
 108++8B46 A7             and a
 108++8B47 CA F5 73       jp z, History.back
 109++8B4A
 110++8B4A CD 9A 8A         call makeRequest
 110++8B4D DA DE 89       jp c, Fetcher.fetchFromNet.error
 111++8B50
 112++8B50 06 0E 21 F5      ld b, Dos.FMODE_CREATE, hl, DialogBox.namedownload
 112++8B54 69
 113++8B55 CD F2 6C         call Dos.fopen
 114++8B58 32 F6 8B         ld (.fp), a
 115++8B5B
 116++8B5B 21 D1 8B         ld hl, .progress
 116++8B5E CD 4E 6A       call DialogBox.msgNoWait
 117++8B61              .loop
 118++8B61 21 86 A0 22      ld hl, outputBuffer, (Wifi.buffer_pointer), hl
 118++8B65 8E 8F
 119++8B67 CD 05 92         call Wifi.getPacket
 120++8B6A 3A 90 8F         ld a, (Wifi.closed)
 120++8B6D A7             and a
 120++8B6E 20 12          jr nz, .exit
 121++8B70
 122++8B70 3A F6 8B 21      ld a, (.fp), hl, outputBuffer, bc, (Wifi.bytes_avail)
 122++8B74 86 A0 ED 4B
 122++8B78 8C 8F
 123++8B7A CD 6C 6F         call Dos.fwrite
 124++8B7D CD F9 8B         call pulsing
 125++8B80 18 DF            jr .loop
 126++8B82              .exit
 127++8B82 3A F6 8B         ld a, (.fp)
 128++8B85 CD 3D 6E         call Dos.fclose
 129++8B88 C3 F5 73         jp History.back
 130++8B8B              .error
 131++8B8B 3A F6 8B         ld a, (.fp)
 132++8B8E CD 3D 6E         call Dos.fclose
 133++8B91 21 9A 8B         ld hl, .err
 134++8B94 CD 45 6A         call DialogBox.msgBox
 135++8B97 C3 F5 73         jp History.back
 136++8B9A
 137++8B9A 4F 70 65 72  .err db "Operation failed! Sorry! Check filename or disk space!",0
 137++8B9E 61 74 69 6F
 137++8BA2 6E 20 66 61
 137++8BA6 69 6C 65 64
 137++8BAA 21 20 53 6F
 137++8BAE 72 72 79 21
 137++8BB2 20 43 68 65
 137++8BB6 63 6B 20 66
 137++8BBA 69 6C 65 6E
 137++8BBE 61 6D 65 20
 137++8BC2 6F 72 20 64
 137++8BC6 69 73 6B 20
 137++8BCA 73 70 61 63
 137++8BCE 65 21 00
 138++8BD1 44 6F 77 6E  .progress db "Downloading in progress! Wait a bit!", 0
 138++8BD5 6C 6F 61 64
 138++8BD9 69 6E 67 20
 138++8BDD 69 6E 20 70
 138++8BE1 72 6F 67 72
 138++8BE5 65 73 73 21
 138++8BE9 20 57 61 69
 138++8BED 74 20 61 20
 138++8BF1 62 69 74 21
 138++8BF5 00
 139++8BF6 00           .fp db 0
 140++8BF7 00           socket db 0
 141++8BF8 20           pulsator db " "
 142++8BF9              pulsing
 143++8BF9 11 01 0B         ld de, #0B01
 143++8BFC CD 3A 60       call TextMode.gotoXY
 144++8BFF 3A F8 8B         ld a, (pulsator)
 145++8C02 FE 2A            cp '*'
 146++8C04 CA 10 8C         jp z, printasterix
 147++8C07 CD A4 60         call TextMode.putC
 148++8C0A 3E 2A            ld a, '*'
 149++8C0C 32 F8 8B         ld (pulsator),a
 150++8C0F C9               ret
 151++8C10              printasterix
 152++8C10 CD A4 60         call TextMode.putC
 153++8C13 3E 20            ld a, ' '
 154++8C15 32 F8 8B         ld (pulsator),a
 155++8C18 C9               ret
 156++8C19
 157++8C19 00 00 00...  requestbuffer ds #1ff
 158++8E18                  endmodule
 159++8E18
# file closed: gopher/gopher.asm
  24+ 8E18                  include "drivers/index.asm"
# file opened: drivers/index.asm
   1++8E18                  IFDEF UNO
   2++8E18 ~                	include "uart-uno.asm"
   3++8E18                  ENDIF
   4++8E18
   5++8E18                  IFDEF UNOUART
   6++8E18 ~                	include "uart-uno.asm"
   7++8E18                  ENDIF
   8++8E18
   9++8E18                  IFDEF MB03
  10++8E18 ~                	include "uart-mb03.asm"
  11++8E18                  ENDIF
  12++8E18
  13++8E18                  IFDEF AY
  14++8E18                  	include "uart-ay.asm"
# file opened: drivers/uart-ay.asm
   1++8E18              ; Copyright 2024 TIsland Crew
   2++8E18              ; SPDX-License-Identifier: Apache-2.0
   3++8E18
   4++8E18                  IFDEF AY56
   5++8E18 ~                    INCLUDE "uart-ay-57600.asm"
   6++8E18 ~                    MODULE      Uart
   7++8E18 ~            init:
   8++8E18 ~                    call UART5.RS232_INIT
   9++8E18 ~                    xor a
  10++8E18 ~                    jp UART5.RS232_CFGDTR
  11++8E18 ~
  12++8E18 ~            write       equ UART5.RS232_WR_BT
  13++8E18 ~            uartRead    equ UART5.RS232_RD_BT
  14++8E18 ~
  15++8E18 ~            read:
  16++8E18 ~                    push bc, de, hl
  17++8E18 ~                    call uartRead
  18++8E18 ~                    pop hl, de, bc
  19++8E18 ~                    ret c
  20++8E18 ~                    jr read
  21++8E18 ~
  22++8E18 ~                    ENDMODULE ; Uart
  23++8E18                  ELSE
  24++8E18                      INCLUDE "uart-ay-128k.asm"
# file opened: drivers/uart-ay-128k.asm
   1++8E18                  module Uart
   2++8E18                  assert $ > #8000 ;; Important keep it in FAST memory
   3++8E18              init:
   4++8E18 F3               di
   5++8E19 3E 07            ld a, #07
   6++8E1B 01 FD FF         ld bc, #fffd
   7++8E1E ED 79            out (c), a
   8++8E20 3E FC            ld a, #fc
   9++8E22 06 BF            ld b, #bf
  10++8E24 ED 79            out (c), a ; Enable read mode
  11++8E26
  12++8E26 3E 0E            ld a, #0e
  13++8E28 01 FD FF         ld bc, #fffd
  14++8E2B ED 79            out (c), a
  15++8E2D
  16++8E2D 06 BF            ld b, #bf
  17++8E2F ED 78            in a, (c)
  18++8E31 E6 FB            and #fb
  19++8E33 ED 79            out (c), a ; Make CTS low
  20++8E35
  21++8E35 FB               ei
  22++8E36 06 FF            ld b, #ff
  23++8E38              .flush
  24++8E38 76               halt
  25++8E39 10 FD            djnz .flush
  26++8E3B C9               ret
  27++8E3C
  28++8E3C
  29++8E3C              write:
  30++8E3C E5 D5 C5         push hl, de, bc
  31++8E3F F5               push af
  32++8E40 0E FD            ld c, #fd ; prepare port addresses
  33++8E42 16 FF            ld d, #ff
  34++8E44 1E BF            ld e, #bf
  35++8E46 42               ld b, d
  36++8E47
  37++8E47 3E 0E            ld a, #0e
  38++8E49 ED 79            out (c), a ; Select AY's PORT A
  39++8E4B
  40++8E4B 2A 7C 8F         ld hl, (_baud)
  41++8E4E 11 02 00         ld de, #0002
  42++8E51 B7               or a
  43++8E52 ED 52            sbc hl, de
  44++8E54 EB               ex hl, de
  45++8E55
  46++8E55 F1               pop af
  47++8E56 2F               cpl
  48++8E57 37               scf
  49++8E58 06 0B            ld b, #0b ; Numbers of bits - 1 start, 8 data, 2 stop
  50++8E5A
  51++8E5A F3               di ; Hard timing starts
  52++8E5B              transmitBit:
  53++8E5B C5               push bc
  54++8E5C F5               push af
  55++8E5D
  56++8E5D 3E FE            ld a, #fe
  57++8E5F 62               ld h, d
  58++8E60 6B               ld l, e
  59++8E61 01 FD BF         ld bc, #bffd
  60++8E64 D2 6D 8E         jp nc, transmitOne
  61++8E67              ; Transmit Zero:
  62++8E67 E6 F7            and #f7
  63++8E69 ED 79            out (c), a
  64++8E6B 18 06            jr transmitNext
  65++8E6D              transmitOne:
  66++8E6D F6 08            or 8
  67++8E6F ED 79            out (c), a
  68++8E71 18 00            jr transmitNext
  69++8E73
  70++8E73              transmitNext:
  71++8E73 2B               dec hl
  72++8E74 7C               ld a, h
  73++8E75 B5               or l
  74++8E76 20 FB            jr nz, transmitNext
  75++8E78
  76++8E78 00               nop
  77++8E79 00               nop
  78++8E7A 00               nop
  79++8E7B
  80++8E7B F1               pop af
  81++8E7C C1               pop bc
  82++8E7D B7               or a
  83++8E7E 1F               rra
  84++8E7F 10 DA            djnz transmitBit
  85++8E81 D9               exx
  86++8E82 FB               ei
  87++8E83 C1 D1 E1         pop bc, de, hl
  88++8E86 C9               ret
  89++8E87
  90++8E87              read:
  91++8E87 C5 D5 E5         push bc, de, hl
  92++8E8A CD 93 8E         call uartRead
  93++8E8D E1 D1 C1         pop hl, de, bc
  94++8E90 D8               ret c
  95++8E91 18 F4            jr read
  96++8E93
  97++8E93              uartRead:
  98++8E93 21 7E 8F         ld hl, _isSecondByteAvail
  99++8E96 7E               ld a, (hl)
 100++8E97 A7               and a
 101++8E98 28 06            jr z, startReadByte
 102++8E9A 36 00            ld (hl), 0
 103++8E9C 23               inc hl
 104++8E9D 7E               ld a, (hl)
 105++8E9E 37               scf
 106++8E9F C9               ret
 107++8EA0              startReadByte:
 108++8EA0 F3               di
 109++8EA1 AF               xor a
 110++8EA2 D9               exx
 111++8EA3 ED 5B 7C 8F      ld de, (_baud)
 112++8EA7 2A 7C 8F         ld hl, (_baud)
 113++8EAA CB 3C            srl h
 114++8EAC CB 1D            rr l  ; HL=_baud/2
 115++8EAE B7               or a
 116++8EAF 06 FA            ld b, #FA ; Wait look length
 117++8EB1 D9               exx
 118++8EB2 0E FD            ld c, #fd
 119++8EB4 16 FF            ld d, #ff
 120++8EB6 1E BF            ld e, #bf
 121++8EB8 42               ld b, d
 122++8EB9 3E 0E            ld a, #0e
 123++8EBB ED 79            out (c), a
 124++8EBD ED 78            in a, (c)
 125++8EBF F6 F0            or #f0      ; Input lines is 1
 126++8EC1 E6 FB            and #fb     ; CTS force to 0
 127++8EC3 43               ld b, e     ; B = #BF
 128++8EC4 ED 79            out (c), a  ; Make CTS high
 129++8EC6 67               ld h, a
 130++8EC7
 131++8EC7              waitStartBit:
 132++8EC7 42               ld b, d
 133++8EC8 ED 78            in a, (c)
 134++8ECA E6 80            and #80
 135++8ECC 28 09            jr z, startBitFound
 136++8ECE              readTimeOut:
 137++8ECE D9               exx
 138++8ECF 05               dec b
 139++8ED0 D9               exx
 140++8ED1 20 F4            jr nz, waitStartBit
 141++8ED3 AF               xor a
 142++8ED4 F5               push af
 143++8ED5 18 39            jr readFinish
 144++8ED7              startBitFound:
 145++8ED7 ED 78            in a, (c)
 146++8ED9 E6 80            and #80
 147++8EDB 20 F1            jr nz, readTimeOut
 148++8EDD
 149++8EDD ED 78            in a, (c)
 150++8EDF E6 80            and #80
 151++8EE1 20 EB            jr nz, readTimeOut
 152++8EE3                  ;; Start bit found!
 153++8EE3
 154++8EE3 D9               exx
 155++8EE4 01 FD FF         ld bc, #fffd
 156++8EE7 3E 80            ld a, #80
 157++8EE9 08               ex af, af
 158++8EEA              readTune:
 159++8EEA 19               add hl, de ; HL = 1.5 * _baud
 160++8EEB 00               nop
 161++8EEC 00               nop
 162++8EED 00               nop
 163++8EEE 00               nop ; Fine tuning delay
 164++8EEF
 165++8EEF              bdDelay:
 166++8EEF 2B               dec hl
 167++8EF0 7C               ld a, h
 168++8EF1 B5               or l
 169++8EF2 20 FB            jr nz, bdDelay
 170++8EF4
 171++8EF4 ED 78            in a, (c)
 172++8EF6 E6 80            and #80
 173++8EF8 CA 04 8F         jp z, zeroReceived
 174++8EFB              ; One received:
 175++8EFB 08               ex af, af
 176++8EFC 37               scf
 177++8EFD 1F               rra
 178++8EFE 38 0D            jr c, receivedByte
 179++8F00 08               ex af, af
 180++8F01 C3 EA 8E         jp readTune
 181++8F04              zeroReceived:
 182++8F04 08               ex af, af
 183++8F05 B7               or a
 184++8F06 1F               RRA
 185++8F07 38 04            jr c, receivedByte
 186++8F09 08               ex af, af
 187++8F0A C3 EA 8E         jp readTune
 188++8F0D              receivedByte:
 189++8F0D 37               scf
 190++8F0E F5               push af
 191++8F0F D9               exx
 192++8F10              readFinish:
 193++8F10 7C               ld a, h
 194++8F11 F6 04            or #04
 195++8F13 43               ld b, e
 196++8F14 ED 79            out (c), a
 197++8F16
 198++8F16 D9               exx
 199++8F17 62               ld h, d
 200++8F18 6B               ld l, e
 201++8F19
 202++8F19 01 07 00         ld bc, #0007
 203++8F1C B7               or a
 204++8F1D ED 42            sbc hl, bc
 205++8F1F
 206++8F1F              delayForStopBit:
 207++8F1F 2B               dec hl
 208++8F20 7C               ld a, h
 209++8F21 B5               or l
 210++8F22 20 FB            jr nz, delayForStopBit
 211++8F24
 212++8F24 01 FD FF         ld bc, #fffd
 213++8F27 19               add hl, de
 214++8F28 19               add hl, de
 215++8F29 19               add hl, de
 216++8F2A
 217++8F2A              waitStartBitSecondByte:
 218++8F2A ED 78            in a, (c)
 219++8F2C E6 80            and #80
 220++8F2E 28 08            jr z, secondStartBitFound
 221++8F30 2B               dec hl
 222++8F31 7C               ld a, h
 223++8F32 B5               or l
 224++8F33 20 F5            jr nz, waitStartBitSecondByte
 225++8F35                  ; No second byte
 226++8F35 F1               pop af
 227++8F36 FB               ei
 228++8F37 C9               ret
 229++8F38
 230++8F38              secondStartBitFound:
 231++8F38 ED 78            in a, (c)
 232++8F3A E6 80            and #80
 233++8F3C 20 EC            jr nz, waitStartBitSecondByte
 234++8F3E 62               ld h, d
 235++8F3F 6B               ld l, e
 236++8F40 01 02 00         ld bc, #0002
 237++8F43 CB 3C            srl h
 238++8F45 CB 1D            rr l
 239++8F47 B7               or a
 240++8F48 ED 42            sbc hl, bc
 241++8F4A 01 FD FF         ld bc, #fffd
 242++8F4D 3E 80            ld a, #80
 243++8F4F 08               ex af, af
 244++8F50              secondByteTune:
 245++8F50 00               nop
 246++8F51 00               nop
 247++8F52 00               nop
 248++8F53 00               nop
 249++8F54 19               add hl, de
 250++8F55
 251++8F55              secondDelay:
 252++8F55 2B               dec hl
 253++8F56 7C               ld a, h
 254++8F57 B5               or l
 255++8F58 20 FB            jr nz, secondDelay
 256++8F5A
 257++8F5A ED 78            in a, (c)
 258++8F5C E6 80            and #80
 259++8F5E 28 09            jr z, secondZeroReceived
 260++8F60              ; Second 1 received
 261++8F60 08               ex af, af
 262++8F61 37               scf
 263++8F62 1F               rra
 264++8F63 38 0D            jr c, secondByteFinished
 265++8F65 08               ex af, af
 266++8F66 C3 50 8F         jp secondByteTune
 267++8F69
 268++8F69              secondZeroReceived:
 269++8F69 08               ex af, af
 270++8F6A B7               or a
 271++8F6B 1F               rra
 272++8F6C 38 04            jr c, secondByteFinished
 273++8F6E 08               ex af, af
 274++8F6F C3 50 8F         jp secondByteTune
 275++8F72              secondByteFinished:
 276++8F72 21 7E 8F         ld hl, _isSecondByteAvail
 277++8F75 36 01            ld (hl), 1
 278++8F77 23               inc hl
 279++8F78 77               ld (hl), a
 280++8F79 F1               pop af
 281++8F7A FB               ei
 282++8F7B C9               ret
 283++8F7C
 284++8F7C
 285++8F7C 0B 00        _baud dw 11 ; 54 - 2400 --- 25 - 4800 --- 11 - 9600
 286++8F7E 00 00        _isSecondByteAvail dw #0
 287++8F80 00 00        _testByte dw #0
 288++8F82
 289++8F82                  endmodule
# file closed: drivers/uart-ay-128k.asm
  25++8F82                  ENDIF;UART_128K
  26++8F82
  27++8F82              ; EOF vim: et:ai:ts=4:sw=4:
# file closed: drivers/uart-ay.asm
  15++8F82                  ENDIF
  16++8F82
  17++8F82                  IFDEF AY56
  18++8F82 ~                	include "uart-ay.asm"
  19++8F82                  ENDIF
  20++8F82
  21++8F82                  IFDEF ZW
  22++8F82 ~                	include "uart-zxwifi.asm"
  23++8F82                  ENDIF
  24++8F82
  25++8F82              	include "utils.asm"
# file opened: drivers/utils.asm
   1++8F82              ;;; Macroses!!!!
   2++8F82                  MACRO EspSend Text
   3++8F82 ~                ld hl, .txtB
   4++8F82 ~                ld e, (.txtE - .txtB)
   5++8F82 ~                call espSend
   6++8F82 ~                jr .txtE
   7++8F82 ~            .txtB
   8++8F82 ~                db Text
   9++8F82 ~            .txtE
  10++8F82                  ENDM
  11++8F82
  12++8F82                  MACRO EspCmd Text
  13++8F82 ~                ld hl, .txtB
  14++8F82 ~                ld e, (.txtE - .txtB)
  15++8F82 ~                call espSend
  16++8F82 ~                jr .txtE
  17++8F82 ~            .txtB
  18++8F82 ~                db Text
  19++8F82 ~                db 13, 10
  20++8F82 ~            .txtE
  21++8F82                  ENDM
  22++8F82
  23++8F82                  MACRO EspCmdOkErr text
  24++8F82 ~                EspCmd text
  25++8F82 ~                call checkOkErr
  26++8F82                  ENDM
  27++8F82
  28++8F82              ; IN DE - string pointer
  29++8F82              ; OUT HL - string len
  30++8F82              strLen:
  31++8F82 21 00 00         ld hl, 0
  32++8F85              .loop
  33++8F85 1A               ld a, (de)
  33++8F86 A7             and a
  33++8F87 C8             ret z
  34++8F88 13 23            inc de, hl
  35++8F8A 18 F9            jr .loop
# file closed: drivers/utils.asm
  26++8F8C
  27++8F8C              	IFDEF UARTATM
  28++8F8C ~            		include "uart-atm.asm"
  29++8F8C              	ENDIF
  30++8F8C
  31++8F8C              	IFDEF UARTEVO
  32++8F8C ~            		include "uart-evo.asm"
  33++8F8C                  ENDIF
  34++8F8C
  35++8F8C              	IFDEF NEDONET
  36++8F8C ~            		include "nedowifi.asm"
  37++8F8C              	ELSE
  38++8F8C              	IFNDEF MSX
  39++8F8C              		include "wifi.asm"
# file opened: drivers/wifi.asm
   1++8F8C                  MODULE Wifi
   2++8F8C 00 00        bytes_avail dw 0
   3++8F8E 00 00        buffer_pointer dw 0
   4++8F90 01           closed db 1
   5++8F91              ; Initialize Wifi chip to work
   6++8F91              init:
   7++8F91
   8++8F91 21 83 90         ld hl, .uartIniting
   8++8F94 CD BC 60       call TextMode.printZ
   9++8F97 CD 18 8E         call Uart.init
  10++8F9A 21 94 90         ld hl, .chipIniting
  10++8F9D CD BC 60       call TextMode.printZ
  11++8FA0
  12++8FA0                  EspCmdOkErr "ATE0"
  12++8FA0             >    EspCmd "ATE0"
  12++8FA0 21 AA 8F    >    ld hl, .txtB
  12++8FA3 1E 06       >    ld e, (.txtE - .txtB)
  12++8FA5 CD 98 91    >    call espSend
  12++8FA8 18 06       >    jr .txtE
  12++8FAA             >.txtB
  12++8FAA 41 54 45 30 >    db "ATE0"
  12++8FAE 0D 0A       >    db 13, 10
  12++8FB0             >.txtE
  12++8FB0 CD 23 91    >    call checkOkErr
  13++8FB3 DA 63 90         jp c, .initError
  14++8FB6
  15++8FB6              ; Reading auth.pwd and send it to ESP
  16++8FB6 21 E9 A0 06      ld hl, creds, b, Dos.FMODE_READ
  16++8FBA 01
  16++8FBB CD F2 6C       call Dos.fopen
  17++8FBE F5               push af
  18++8FBF 21 FA A0 01      ld hl,outputBuffer2, bc, 255
  18++8FC3 FF 00
  18++8FC5 CD 49 6F       call Dos.fread
  19++8FC8 F1               pop af
  20++8FC9 CD 3D 6E         call Dos.fclose
  21++8FCC
  22++8FCC 21 AC 90         ld hl, .doneInit1
  22++8FCF CD BC 60       call TextMode.printZ
  23++8FD2
  24++8FD2 21 FA A0         ld hl,outputBuffer2
  25++8FD5 CD A2 91         call espSendT
  26++8FD8 3E 0D            ld a, 13
  26++8FDA CD 3C 8E       call Uart.write
  27++8FDD 3E 0A            ld a, 10
  27++8FDF CD 3C 8E       call Uart.write
  28++8FE2 CD 23 91         call checkOkErr
  29++8FE5 DA 63 90         jp c, .initError
  30++8FE8              ;
  31++8FE8                 	EspCmdOkErr "AT+CIPSERVER=0"
  31++8FE8             >    EspCmd "AT+CIPSERVER=0"
  31++8FE8 21 F2 8F    >    ld hl, .txtB
  31++8FEB 1E 10       >    ld e, (.txtE - .txtB)
  31++8FED CD 98 91    >    call espSend
  31++8FF0 18 10       >    jr .txtE
  31++8FF2             >.txtB
  31++8FF2 41 54 2B 43 >    db "AT+CIPSERVER=0"
  31++8FF6 49 50 53 45 >
  31++8FFA 52 56 45 52 >
  31++8FFE 3D 30       >
  31++9000 0D 0A       >    db 13, 10
  31++9002             >.txtE
  31++9002 CD 23 91    >    call checkOkErr
  32++9005                  EspCmdOkErr "AT+CIPCLOSE" ; Close if there some connection was. Don't care about result
  32++9005             >    EspCmd "AT+CIPCLOSE"
  32++9005 21 0F 90    >    ld hl, .txtB
  32++9008 1E 0D       >    ld e, (.txtE - .txtB)
  32++900A CD 98 91    >    call espSend
  32++900D 18 0D       >    jr .txtE
  32++900F             >.txtB
  32++900F 41 54 2B 43 >    db "AT+CIPCLOSE"
  32++9013 49 50 43 4C >
  32++9017 4F 53 45    >
  32++901A 0D 0A       >    db 13, 10
  32++901C             >.txtE
  32++901C CD 23 91    >    call checkOkErr
  33++901F                  EspCmdOkErr "AT+CIPMUX=0" ; Single connection mode
  33++901F             >    EspCmd "AT+CIPMUX=0"
  33++901F 21 29 90    >    ld hl, .txtB
  33++9022 1E 0D       >    ld e, (.txtE - .txtB)
  33++9024 CD 98 91    >    call espSend
  33++9027 18 0D       >    jr .txtE
  33++9029             >.txtB
  33++9029 41 54 2B 43 >    db "AT+CIPMUX=0"
  33++902D 49 50 4D 55 >
  33++9031 58 3D 30    >
  33++9034 0D 0A       >    db 13, 10
  33++9036             >.txtE
  33++9036 CD 23 91    >    call checkOkErr
  34++9039 DA 63 90         jp c, .initError
  35++903C
  36++903C                  EspCmdOkErr "AT+CIPDINFO=0" ; Disable additional info
  36++903C             >    EspCmd "AT+CIPDINFO=0"
  36++903C 21 46 90    >    ld hl, .txtB
  36++903F 1E 0F       >    ld e, (.txtE - .txtB)
  36++9041 CD 98 91    >    call espSend
  36++9044 18 0F       >    jr .txtE
  36++9046             >.txtB
  36++9046 41 54 2B 43 >    db "AT+CIPDINFO=0"
  36++904A 49 50 44 49 >
  36++904E 4E 46 4F 3D >
  36++9052 30          >
  36++9053 0D 0A       >    db 13, 10
  36++9055             >.txtE
  36++9055 CD 23 91    >    call checkOkErr
  37++9058 DA 63 90         jp c, .initError
  38++905B
  39++905B 21 A5 90         ld hl, .doneInit
  39++905E CD BC 60       call TextMode.printZ
  40++9061
  41++9061 B7               or a
  42++9062 C9               ret
  43++9063              .initError
  44++9063 21 6B 90         ld hl, .errMsg
  44++9066 CD 45 6A       call DialogBox.msgBox
  45++9069 37               scf
  46++906A C9               ret
  47++906B 57 69 46 69  .errMsg      db "WiFi chip init failed!", "\r", 0
  47++906F 20 63 68 69
  47++9073 70 20 69 6E
  47++9077 69 74 20 66
  47++907B 61 69 6C 65
  47++907F 64 21 0D 00
  48++9083 55 61 72 74  .uartIniting db "Uart initing...", "\r", 0
  48++9087 20 69 6E 69
  48++908B 74 69 6E 67
  48++908F 2E 2E 2E 0D
  48++9093 00
  49++9094 43 68 69 70  .chipIniting db "Chip initing...", "\r", 0
  49++9098 20 69 6E 69
  49++909C 74 69 6E 67
  49++90A0 2E 2E 2E 0D
  49++90A4 00
  50++90A5 44 6F 6E 65  .doneInit    db "Done!","\r", 0
  50++90A9 21 0D 00
  51++90AC 53 65 6E 64  .doneInit1   db "Sending auth.pwd to ESP","\r", 0
  51++90B0 69 6E 67 20
  51++90B4 61 75 74 68
  51++90B8 2E 70 77 64
  51++90BC 20 74 6F 20
  51++90C0 45 53 50 0D
  51++90C4 00
  52++90C5                  IFNDEF PROXY
  53++90C5              ; HL - host pointer in gopher row
  54++90C5              ; DE - port pointer in gopher row
  55++90C5              openTCP:
  56++90C5 D5               push de
  57++90C6 E5               push hl
  58++90C7                  EspCmdOkErr "AT+CIPCLOSE" ; Don't care about result. Just close if it didn't happens before
  58++90C7             >    EspCmd "AT+CIPCLOSE"
  58++90C7 21 D1 90    >    ld hl, .txtB
  58++90CA 1E 0D       >    ld e, (.txtE - .txtB)
  58++90CC CD 98 91    >    call espSend
  58++90CF 18 0D       >    jr .txtE
  58++90D1             >.txtB
  58++90D1 41 54 2B 43 >    db "AT+CIPCLOSE"
  58++90D5 49 50 43 4C >
  58++90D9 4F 53 45    >
  58++90DC 0D 0A       >    db 13, 10
  58++90DE             >.txtE
  58++90DE CD 23 91    >    call checkOkErr
  59++90E1                  EspSend 'AT+CIPSTART="TCP","'
  59++90E1 21 EB 90    >    ld hl, .txtB
  59++90E4 1E 13       >    ld e, (.txtE - .txtB)
  59++90E6 CD 98 91    >    call espSend
  59++90E9 18 13       >    jr .txtE
  59++90EB             >.txtB
  59++90EB 41 54 2B 43 >    db 'AT+CIPSTART="TCP","'
  59++90EF 49 50 53 54 >
  59++90F3 41 52 54 3D >
  59++90F7 22 54 43 50 >
  59++90FB 22 2C 22    >
  59++90FE             >.txtE
  60++90FE E1               pop hl
  61++90FF CD A2 91         call espSendT
  62++9102                  EspSend '",'
  62++9102 21 0C 91    >    ld hl, .txtB
  62++9105 1E 02       >    ld e, (.txtE - .txtB)
  62++9107 CD 98 91    >    call espSend
  62++910A 18 02       >    jr .txtE
  62++910C             >.txtB
  62++910C 22 2C       >    db '",'
  62++910E             >.txtE
  63++910E E1               pop hl
  64++910F CD A2 91         call espSendT
  65++9112 3E 0D            ld a, 13
  65++9114 CD 3C 8E       call Uart.write
  66++9117 3E 0A            ld a, 10
  66++9119 CD 3C 8E       call Uart.write
  67++911C AF               xor a
  67++911D 32 90 8F       ld (closed), a
  68++9120 C3 23 91         jp checkOkErr
  69++9123                  ENDIF
  70++9123
  71++9123
  72++9123
  73++9123              checkOkErr:
  74++9123 CD 87 8E         call Uart.read
  75++9126 FE 4F            cp 'O'
  75++9128 CA 38 91       jp z, .okStart ; OK
  76++912B FE 45            cp 'E'
  76++912D CA 4D 91       jp z, .errStart ; ERROR
  77++9130 FE 46            cp 'F'
  77++9132 CA 72 91       jp z, .failStart ; FAIL
  78++9135 C3 23 91         jp checkOkErr
  79++9138              .okStart
  80++9138 CD 87 8E         call Uart.read
  80++913B FE 4B          cp 'K'
  80++913D C2 23 91       jp nz, checkOkErr
  81++9140 CD 87 8E         call Uart.read
  81++9143 FE 0D          cp 13
  81++9145 C2 23 91       jp nz, checkOkErr
  82++9148 CD 8F 91         call .flushToLF
  83++914B B7               or a
  84++914C C9               ret
  85++914D              .errStart
  86++914D CD 87 8E         call Uart.read
  86++9150 FE 52          cp 'R'
  86++9152 C2 23 91       jp nz, checkOkErr
  87++9155 CD 87 8E         call Uart.read
  87++9158 FE 52          cp 'R'
  87++915A C2 23 91       jp nz, checkOkErr
  88++915D CD 87 8E         call Uart.read
  88++9160 FE 4F          cp 'O'
  88++9162 C2 23 91       jp nz, checkOkErr
  89++9165 CD 87 8E         call Uart.read
  89++9168 FE 52          cp 'R'
  89++916A C2 23 91       jp nz, checkOkErr
  90++916D CD 8F 91         call .flushToLF
  91++9170 37               scf
  92++9171 C9               ret
  93++9172              .failStart
  94++9172 CD 87 8E         call Uart.read
  94++9175 FE 41          cp 'A'
  94++9177 C2 23 91       jp nz, checkOkErr
  95++917A CD 87 8E         call Uart.read
  95++917D FE 49          cp 'I'
  95++917F C2 23 91       jp nz, checkOkErr
  96++9182 CD 87 8E         call Uart.read
  96++9185 FE 4C          cp 'L'
  96++9187 C2 23 91       jp nz, checkOkErr
  97++918A CD 8F 91         call .flushToLF
  98++918D 37               scf
  99++918E C9               ret
 100++918F              .flushToLF
 101++918F CD 87 8E         call Uart.read
 102++9192 FE 0A            cp 10
 102++9194 C2 8F 91       jp nz, .flushToLF
 103++9197 C9               ret
 104++9198
 105++9198              ; Send buffer to UART
 106++9198              ; HL - buff
 107++9198              ; E - count
 108++9198              espSend:
 109++9198 7E               ld a, (hl)
 109++9199 CD 3C 8E       call Uart.write
 110++919C 23               inc hl
 111++919D 1D               dec e
 112++919E C2 98 91         jp nz, espSend
 113++91A1 C9               ret
 114++91A2
 115++91A2              ; HL - string that ends with one of the terminator(CR/LF/TAB/NULL)
 116++91A2              espSendT:
 117++91A2 7E               ld a, (hl)
 118++91A3
 119++91A3 A7               and a
 119++91A4 C8             ret z
 120++91A5 FE 09            cp 9
 120++91A7 C8             ret z
 121++91A8 FE 0D            cp 13
 121++91AA C8             ret z
 122++91AB FE 0A            cp 10
 122++91AD C8             ret z
 123++91AE
 124++91AE CD 3C 8E         call Uart.write
 125++91B1 23               inc hl
 126++91B2 C3 A2 91         jp espSendT
 127++91B5
 128++91B5              ; HL - stringZ to send
 129++91B5              ; Adds CR LF
 130++91B5              tcpSendZ:
 131++91B5 E5               push hl
 132++91B6                  EspSend "AT+CIPSEND="
 132++91B6 21 C0 91    >    ld hl, .txtB
 132++91B9 1E 0B       >    ld e, (.txtE - .txtB)
 132++91BB CD 98 91    >    call espSend
 132++91BE 18 0B       >    jr .txtE
 132++91C0             >.txtB
 132++91C0 41 54 2B 43 >    db "AT+CIPSEND="
 132++91C4 49 50 53 45 >
 132++91C8 4E 44 3D    >
 132++91CB             >.txtE
 133++91CB D1               pop de
 133++91CC D5             push de
 134++91CD CD 82 8F         call strLen
 135++91D0 23               inc hl
 135++91D1 23             inc hl ; +CRLF
 136++91D2 CD A8 92         call hlToNumEsp
 137++91D5 3E 0D            ld a, 13
 137++91D7 CD 3C 8E       call Uart.write
 138++91DA 3E 0A            ld a, 10
 138++91DC CD 3C 8E       call Uart.write
 139++91DF CD 23 91         call checkOkErr
 139++91E2 D8             ret c
 140++91E3              .wait
 141++91E3 CD 87 8E         call Uart.read
 141++91E6 FE 3E          cp '>'
 141++91E8 C2 E3 91       jp nz, .wait
 142++91EB E1               pop hl
 143++91EC              .loop
 144++91EC 7E               ld a, (hl)
 144++91ED A7             and a
 144++91EE CA F8 91       jp z, .exit
 145++91F1 CD 3C 8E         call Uart.write
 146++91F4 23               inc hl
 147++91F5 C3 EC 91         jp .loop
 148++91F8              .exit
 149++91F8 3E 0D            ld a, 13
 149++91FA CD 3C 8E       call Uart.write
 150++91FD 3E 0A            ld a, 10
 150++91FF CD 3C 8E       call Uart.write
 151++9202 C3 23 91         jp checkOkErr
 152++9205
 153++9205              getPacket:
 154++9205 CD 87 8E         call Uart.read
 155++9208 FE 2B            cp '+'
 155++920A CA 27 92       jp z, .ipdBegun    ; "+IPD," packet
 156++920D FE 4F            cp 'O'
 156++920F CA 15 92       jp z, .closedBegun ; It enough to check "OSED\n" :-)
 157++9212 C3 05 92         jp getPacket
 158++9215              .closedBegun
 159++9215 CD 87 8E         call Uart.read; : cp 'S' : jp nz, .closedBegun
 160++9218 CD 87 8E         call Uart.read; : cp 'E' : jp nz, .closedBegun
 161++921B CD 87 8E         call Uart.read; : cp 'D' : jp nz, .closedBegun
 162++921E CD 87 8E         call Uart.read; : cp 13 : jp nz, .closedBegun
 163++9221 3E 01            ld a, 1
 164++9223 32 90 8F         ld (closed), a
 165++9226 C9               ret
 166++9227              .ipdBegun
 167++9227 CD 87 8E         call Uart.read; : cp 'I' : jp nz, .ipdBegun
 168++922A CD 87 8E         call Uart.read; : cp 'P' : jp nz, .ipdBegun
 169++922D CD 87 8E         call Uart.read; : cp 'D' : jp nz, .ipdBegun
 170++9230 CD 87 8E         call Uart.read  ;','
 171++9233 CD 90 92         call .count_ipd_lenght
 172++9236 22 8C 8F         ld (bytes_avail), hl
 173++9239                  ;ld de, hl
 174++9239 EB               ex de,hl
 175++923A 2A 8E 8F         ld hl, (buffer_pointer)
 176++923D              .readp
 177++923D 7C               ld a, h
 178++923E 3C               inc a
 179++923F CA 51 92         jp z, .skipbuff
 180++9242 CD 87 8E         call Uart.read
 181++9245 77               ld (hl), a
 182++9246 1B               dec de
 183++9247 23               inc hl
 184++9248 7A               ld a, d
 185++9249 B3               or e
 186++924A C2 3D 92         jp nz, .readp
 187++924D 22 8E 8F         ld (buffer_pointer), hl
 188++9250 C9               ret
 189++9251              .skipbuff
 190++9251 CD 87 8E         call Uart.read
 191++9254 1B               dec de
 192++9255 7A               ld a, d
 193++9256 B3               or e
 194++9257 C2 51 92         jp nz, .skipbuff
 195++925A
 196++925A CD D0 92             call flushToLF1
 197++925D
 198++925D 3E 01            ld a,1
 199++925F 32 90 8F     	ld (closed),a
 200++9262 AF           	xor a
 201++9263 32 8C 8F     	ld (bytes_avail),a
 202++9266 21 6D 92         ld hl, .errMem
 202++9269 CD 45 6A       call DialogBox.msgBox
 203++926C C9               ret
 204++926D              .errMem:
 205++926D 4F 75 74 20  	db "Out of memory. Page loading error.",0
 205++9271 6F 66 20 6D
 205++9275 65 6D 6F 72
 205++9279 79 2E 20 50
 205++927D 61 67 65 20
 205++9281 6C 6F 61 64
 205++9285 69 6E 67 20
 205++9289 65 72 72 6F
 205++928D 72 2E 00
 206++9290              .count_ipd_lenght
 207++9290 21 00 00     		ld hl,0			; count lenght
 208++9293 CD 87 8E     .cil1   call Uart.read
 209++9296 FE 3A             	cp ':'
 210++9298 C8                   ret z
 211++9299 D6 30        		sub 0x30
 212++929B 4D                   ld c,l
 213++929C 44                   ld b,h
 214++929D 29                   add hl,hl
 215++929E 29                   add hl,hl
 216++929F 09                   add hl,bc
 217++92A0 29                   add hl,hl
 218++92A1 4F                   ld c,a
 219++92A2 06 00                ld b,0
 220++92A4 09                   add hl,bc
 221++92A5 C3 93 92     		jp .cil1
 222++92A8
 223++92A8              ; Based on: https://wikiti.brandonw.net/index.php?title=Z80_Routines:Other:DispHL
 224++92A8              ; HL - number
 225++92A8              ; It will be written to UART
 226++92A8              hlToNumEsp:
 227++92A8 01 F0 D8     	ld	bc,-10000
 228++92AB CD C1 92     	call	.n1
 229++92AE 01 18 FC     	ld	bc,-1000
 230++92B1 CD C1 92     	call	.n1
 231++92B4 01 9C FF     	ld	bc,-100
 232++92B7 CD C1 92     	call	.n1
 233++92BA 0E F6        	ld	c,-10
 234++92BC CD C1 92     	call	.n1
 235++92BF 0E FF        	ld	c,-1
 236++92C1 3E 2F        .n1	ld	a,'0'-1
 237++92C3 3C           .n2	inc	a
 238++92C4 09           	add	hl,bc
 239++92C5 DA C3 92     	jp	c, .n2
 240++92C8 ED 42        	sbc	hl,bc
 241++92CA C5               push bc
 242++92CB CD 3C 8E     	call Uart.write
 243++92CE C1               pop bc
 244++92CF C9               ret
 245++92D0              flushToLF1
 246++92D0 CD 87 8E         call Uart.read
 247++92D3 FE 0A            cp 10
 247++92D5 C2 D0 92       jp nz, flushToLF1
 248++92D8 C9               ret
 249++92D9                  ENDMODULE
# file closed: drivers/wifi.asm
  40++92D9              	ENDIF
  41++92D9              	ENDIF
  42++92D9
  43++92D9                  IFDEF NEDOOS
  44++92D9 ~                	include "rtc-nos.asm"
  45++92D9                  ENDIF
  46++92D9
  47++92D9
  48++92D9                  IFDEF SMUCRTC
  49++92D9 ~                	include "rtc-smuc.asm"
  50++92D9                  ENDIF
  51++92D9
  52++92D9              	IFDEF MSX
  53++92D9 ~                    include "drivers/unapi/unapi.asm"
  54++92D9 ~                	include "drivers/unapi/tcp.asm"
  55++92D9 ~            		include "rtc-msx.asm"
  56++92D9                  ELSE
  57++92D9              		include "proxy.asm"
# file opened: drivers/proxy.asm
   1++92D9                  IFDEF PROXY
   2++92D9 ~                MODULE Wifi
   3++92D9 ~            ; Same singature as wifi.openTCP
   4++92D9 ~            ; HL - host pointer in gopher row
   5++92D9 ~            ; DE - port pointer in gopher row
   6++92D9 ~            openTCP:
   7++92D9 ~                push de
   8++92D9 ~                push hl
   9++92D9 ~
  10++92D9 ~                xor a
  10++92D9 ~              ld hl, hostBuff, de, hostBuff + 1, bc, 102, (hl), a
  10++92D9 ~              ldir
  11++92D9 ~
  12++92D9 ~                EspCmdOkErr "AT+CIPCLOSE"
  13++92D9 ~                EspCmdOkErr 'AT+CIPSTART="TCP","138.68.76.243",6912' // Replace here for yourown proxy. If you wish
  14++92D9 ~                jr c, .error
  15++92D9 ~                pop hl
  15++92D9 ~              ld de, hostBuff
  16++92D9 ~            .copyHost
  17++92D9 ~                ld a, (hl)
  17++92D9 ~              and a
  17++92D9 ~              jr z, 1F
  17++92D9 ~              and a
  17++92D9 ~              jr z, 1F
  18++92D9 ~                ld (de), a
  18++92D9 ~              inc hl, de
  19++92D9 ~                jr .copyHost
  20++92D9 ~            1   xor a
  20++92D9 ~              ld (de), a
  21++92D9 ~                pop hl
  21++92D9 ~              ld de, portBuff
  22++92D9 ~            .copyPort
  23++92D9 ~                ld a, (hl)
  23++92D9 ~              and a
  23++92D9 ~              jr z, 1F
  23++92D9 ~              and a
  23++92D9 ~              jr z, 1F
  24++92D9 ~                ld (de), a
  24++92D9 ~              inc hl, de
  25++92D9 ~                jr .copyPort
  26++92D9 ~            1   ld hl, hostBuff
  26++92D9 ~              call tcpSendZ
  27++92D9 ~                ld hl, portBuff
  27++92D9 ~              call tcpSendZ
  28++92D9 ~                xor a
  28++92D9 ~              ld (closed), a
  29++92D9 ~                ret
  30++92D9 ~            .error
  31++92D9 ~                pop hl
  31++92D9 ~              pop de
  32++92D9 ~                ret
  33++92D9 ~
  34++92D9 ~            continue:
  35++92D9 ~                EspCmdOkErr "AT+CIPSEND=1"
  36++92D9 ~                ret c
  37++92D9 ~            .wait
  38++92D9 ~                call Uart.read
  38++92D9 ~              cp '>'
  38++92D9 ~              jr nz, .wait
  39++92D9 ~                ld a, 'c'
  39++92D9 ~              call Uart.write
  40++92D9 ~                jp checkOkErr
  41++92D9 ~
  42++92D9 ~            hostBuff ds 96
  43++92D9 ~            portBuff ds 7
  44++92D9 ~                ENDMODULE
  45++92D9                  ENDIF
# file closed: drivers/proxy.asm
  58++92D9              		include "memory.asm"
# file opened: drivers/memory.asm
   1++92D9                  module Memory
   2++92D9              BANKM = #5b5c
   3++92D9              MEM_PORT = #7ffd
   4++92D9
   5++92D9              init:
   6++92D9 F3               di
   7++92DA FD CB 01 A6      res 4, (iy + 1)
   8++92DE
   9++92DE AF               xor a
   9++92DF CD E3 92       call setPage
  10++92E2 C9               ret
  11++92E3
  12++92E3              ; a - page
  13++92E3              setPage:
  14++92E3 F6 18            or #18
  14++92E5 32 5C 5B       ld (BANKM), a
  15++92E8 01 FD 7F         ld bc, MEM_PORT
  15++92EB ED 79          out (c), a
  16++92ED C9               ret
  17++92EE
  18++92EE                  endmodule
# file closed: drivers/memory.asm
  59++92EE              	ENDIF
  60++92EE
  61++92EE              	IFDEF GS
  62++92EE              		include "general-sound.asm"
# file opened: drivers/general-sound.asm
   1++92EE                  macro _WaitCommand
   2++92EE ~            .wait
   3++92EE ~                in a, (GeneralSound.CMD)
   4++92EE ~                rrca
   5++92EE ~                jr c, .wait
   6++92EE                  endm
   7++92EE
   8++92EE                  macro _WaitData
   9++92EE ~            .wait
  10++92EE ~                in a, (GeneralSound.CMD)
  11++92EE ~                rlca
  12++92EE ~                jr c, .wait
  13++92EE                  endm
  14++92EE
  15++92EE                  macro _SendCommand nn
  16++92EE ~                ld a, nn
  16++92EE ~              out (GeneralSound.CMD), a
  17++92EE                  endm
  18++92EE
  19++92EE                  module GeneralSound
  20++92EE              ;; Control ports
  21++92EE              CMD  = 187
  22++92EE              DATA = 179
  23++92EE
  24++92EE              ;; Commands
  25++92EE              CMD_WARM_RESET      = #F3
  26++92EE              CMD_COLD_RESET      = #F4
  27++92EE              CMD_LOAD_MODULE     = #30
  28++92EE              CMD_PLAY_MODULE     = #31
  29++92EE              CMD_STOP_MODULE     = #32
  30++92EE              CMD_CONTINUE_MODULE = #33
  31++92EE              CMD_OPEN_STREAM     = #D1
  32++92EE              CMD_CLOSE_STREAM    = #D2
  33++92EE
  34++92EE              ; A - 0 warm reset, other - cold
  35++92EE              init:
  36++92EE A7               and a
  36++92EF 20 05          jr nz, .cold
  37++92F1                  _SendCommand CMD_WARM_RESET
  37++92F1 3E F3       >    ld a, CMD_WARM_RESET
  37++92F3 D3 BB       >  out (GeneralSound.CMD), a
  38++92F5 C9               ret
  39++92F6              .cold
  40++92F6                  _SendCommand CMD_COLD_RESET
  40++92F6 3E F4       >    ld a, CMD_COLD_RESET
  40++92F8 D3 BB       >  out (GeneralSound.CMD), a
  41++92FA C9               ret
  42++92FB
  43++92FB              ;; Initializes loading module
  44++92FB              loadModule:
  45++92FB                  _SendCommand CMD_LOAD_MODULE
  45++92FB 3E 30       >    ld a, CMD_LOAD_MODULE
  45++92FD D3 BB       >  out (GeneralSound.CMD), a
  46++92FF                  _WaitCommand
  46++92FF             >.wait
  46++92FF DB BB       >    in a, (GeneralSound.CMD)
  46++9301 0F          >    rrca
  46++9302 38 FB       >    jr c, .wait
  47++9304                  _SendCommand CMD_OPEN_STREAM
  47++9304 3E D1       >    ld a, CMD_OPEN_STREAM
  47++9306 D3 BB       >  out (GeneralSound.CMD), a
  48++9308                  _WaitCommand
  48++9308             >.wait
  48++9308 DB BB       >    in a, (GeneralSound.CMD)
  48++930A 0F          >    rrca
  48++930B 38 FB       >    jr c, .wait
  49++930D C9               ret
  50++930E
  51++930E              ;; Use it for streaming mod file
  52++930E              sendByte:
  53++930E D3 B3            out (DATA), a
  54++9310                  _WaitData
  54++9310             >.wait
  54++9310 DB BB       >    in a, (GeneralSound.CMD)
  54++9312 07          >    rlca
  54++9313 38 FB       >    jr c, .wait
  55++9315 C9               ret
  56++9316
  57++9316              ;; Call it when module was loaded
  58++9316              finishLoadingModule:
  59++9316                  _SendCommand CMD_CLOSE_STREAM
  59++9316 3E D2       >    ld a, CMD_CLOSE_STREAM
  59++9318 D3 BB       >  out (GeneralSound.CMD), a
  60++931A                  _WaitCommand
  60++931A             >.wait
  60++931A DB BB       >    in a, (GeneralSound.CMD)
  60++931C 0F          >    rrca
  60++931D 38 FB       >    jr c, .wait
  61++931F              rewind:
  62++931F 3E 01            ld a, 1
  62++9321 D3 B3          out (DATA), a
  63++9323                  _SendCommand CMD_PLAY_MODULE
  63++9323 3E 31       >    ld a, CMD_PLAY_MODULE
  63++9325 D3 BB       >  out (GeneralSound.CMD), a
  64++9327                  _WaitCommand
  64++9327             >.wait
  64++9327 DB BB       >    in a, (GeneralSound.CMD)
  64++9329 0F          >    rrca
  64++932A 38 FB       >    jr c, .wait
  65++932C 3E 01 32 50      ld a, 1, (state),a
  65++9330 93
  66++9331 C9               ret
  67++9332
  68++9332              ;; Works like pause too
  69++9332              stopModule:
  70++9332 AF               xor a
  70++9333 32 50 93       ld (state), a
  71++9336                  _SendCommand CMD_STOP_MODULE
  71++9336 3E 32       >    ld a, CMD_STOP_MODULE
  71++9338 D3 BB       >  out (GeneralSound.CMD), a
  72++933A C9               ret
  73++933B
  74++933B              continueModule:
  75++933B 3E 01            ld a, 1
  75++933D 32 50 93       ld (state), a
  76++9340                  _SendCommand CMD_CONTINUE_MODULE
  76++9340 3E 33       >    ld a, CMD_CONTINUE_MODULE
  76++9342 D3 BB       >  out (GeneralSound.CMD), a
  77++9344 C9               ret
  78++9345
  79++9345              ; Pauses resumes
  80++9345              toggleModule:
  81++9345 CD 7E 6A         call Console.waitForKeyUp
  82++9348 3A 50 93         ld a, (state)
  82++934B A7             and a
  83++934C 28 ED            jr z, continueModule
  84++934E 18 E2            jr stopModule
  85++9350
  86++9350 00           state db 0
  87++9351                  endmodule
# file closed: drivers/general-sound.asm
  63++9351              	ENDIF
# file closed: drivers/index.asm
  25+ 9351                  include "screen/rtc.asm"
# file opened: screen/rtc.asm
   1++9351              printRTC
   2++9351              	IFDEF RTC
   3++9351 ~            	call Clock.readTime
   4++9351 ~
   5++9351 ~            	ld a, (oldminutes)
   6++9351 ~            	ld d,a
   7++9351 ~            	ld a, (minutes)
   8++9351 ~            	cp d					; Update only if minutes changed
   9++9351 ~            	ret z
  10++9351 ~            	ld (oldminutes), a
  11++9351 ~
  12++9351 ~            	ld d,1 ;??? Y,X
  13++9351 ~            	ld e,SCREEN_WIDTH - 7
  14++9351 ~            	call TextMode.gotoXY
  15++9351 ~            	ld a,'['
  16++9351 ~            	call TextMode.putC
  17++9351 ~            	ld h,0
  18++9351 ~            	ld a,(hours) ;
  19++9351 ~            	ld l,a
  20++9351 ~            	call toDecimal
  21++9351 ~            	ld hl,decimalS+3
  22++9351 ~            	call TextMode.printZ
  23++9351 ~            	ld a,':'
  24++9351 ~            	call TextMode.putC
  25++9351 ~            	ld h,0
  26++9351 ~            	ld a,(minutes) ;
  27++9351 ~            	ld l,a
  28++9351 ~            	call toDecimal
  29++9351 ~            	ld hl,decimalS+3
  30++9351 ~            	call TextMode.printZ
  31++9351 ~            	;ld a,':'
  32++9351 ~            	;call TextMode.putC
  33++9351 ~            	;ld h,0
  34++9351 ~            	;ld a,(seconds) ;
  35++9351 ~            	;ld l,a
  36++9351 ~            	;call toDecimal
  37++9351 ~            	;ld hl,decimalS+3
  38++9351 ~            	;call TextMode.printZ
  39++9351 ~            	ld a,']'
  40++9351 ~            	call TextMode.putC
  41++9351 ~            	ret
  42++9351 ~
  43++9351 ~            toDecimal		; 2   5  
  44++9351 ~            				;   HL 
  45++9351 ~            	ld de,10000 ; 
  46++9351 ~            	ld a,255
  47++9351 ~            toDecimal10k
  48++9351 ~            	and a
  49++9351 ~            	sbc hl,de
  50++9351 ~            	inc a
  51++9351 ~            	jr nc,toDecimal10k
  52++9351 ~            	add hl,de
  53++9351 ~            	add a,48
  54++9351 ~            	ld (decimalS),a
  55++9351 ~            	ld de,1000 ;
  56++9351 ~            	ld a,255
  57++9351 ~            toDecimal1k
  58++9351 ~            	and a
  59++9351 ~            	sbc hl,de
  60++9351 ~            	inc a
  61++9351 ~            	jr nc,toDecimal1k
  62++9351 ~            	add hl,de
  63++9351 ~            	add a,48
  64++9351 ~            	ld (decimalS+1),a
  65++9351 ~            	ld de,100 ;
  66++9351 ~            	ld a,255
  67++9351 ~            toDecimal01k
  68++9351 ~            	and a
  69++9351 ~            	sbc hl,de
  70++9351 ~            	inc a
  71++9351 ~            	jr nc,toDecimal01k
  72++9351 ~            	add hl,de
  73++9351 ~            	add a,48
  74++9351 ~            	ld (decimalS+2),a
  75++9351 ~            	ld de,10 ;
  76++9351 ~            	ld a,255
  77++9351 ~            toDecimal001k
  78++9351 ~            	and a
  79++9351 ~            	sbc hl,de
  80++9351 ~            	inc a
  81++9351 ~            	jr nc,toDecimal001k
  82++9351 ~            	add hl,de
  83++9351 ~            	add a,48
  84++9351 ~            	ld (decimalS+3),a
  85++9351 ~            	ld de,1 ;
  86++9351 ~            	ld a,255
  87++9351 ~            toDecimal0001k
  88++9351 ~            	and a
  89++9351 ~            	sbc hl,de
  90++9351 ~            	inc a
  91++9351 ~            	jr nc,toDecimal0001k
  92++9351 ~            	add hl,de
  93++9351 ~            	add a,48
  94++9351 ~            	ld (decimalS+4),a
  95++9351 ~            	ret
  96++9351 ~            hours
  97++9351 ~            	db 0
  98++9351 ~            minutes
  99++9351 ~            	db 0
 100++9351 ~            seconds
 101++9351 ~            	db 0
 102++9351 ~            decimalS	ds 7 ; 
 103++9351              	ENDIF
 104++9351 C9           	ret
 105++9352              oldminutes		;    
 106++9352 FF           	db 255
 107++9353
 108++9353
 109++9353
 110++9353
# file closed: screen/rtc.asm
  26+ 9353
  27+ 9353                  IFDEF NEDOOS
  28+ 9353 ~                ;Gap about 8kb, CMD_SETMUSIC 0x4000 mandatory
  29+ 9353 ~                ;Stack down from 0x4000
  30+ 9353 ~                    include "screen/nedoscreen.asm"
  31+ 9353 ~                    include "player/mod-processor.asm"
  32+ 9353 ~                    include "player/vortexnedoos.asm"
  33+ 9353 ~
  34+ 9353 ~            start:
  35+ 9353 ~            outputBuffer:
  36+ 9353 ~                    ld sp, 0x4000
  37+ 9353 ~                    ld c,nos.CMD_SETSYSDRV
  38+ 9353 ~                 	ex af,af'
  39+ 9353 ~            	    call nos.BDOS
  40+ 9353              	ELSE
  41+ 9353                      include "player/mod-processor.asm"
# file opened: player/mod-processor.asm
   1++9353                  MODULE ModProcessor
   2++9353                  ifdef GS
   3++9353
   4++9353                  macro _WaitCommand2
   5++9353 ~            .wait
   6++9353 ~                in a, (CMD)
   7++9353 ~                rrca
   8++9353 ~                jr c, .wait
   9++9353                  endm
  10++9353
  11++9353                  macro _SendCommand2 nn
  12++9353 ~                ld a, nn
  12++9353 ~              out (CMD), a
  13++9353                  endm
  14++9353
  15++9353              play:
  16++9353 3E FF            ld a, 255
  17++9355 32 52 93         ld (oldminutes), a
  18++9358
  19++9358 CD 7E 6A         call Console.waitForKeyUp
  20++935B
  21++935B 21 19 8C         ld hl, Gopher.requestbuffer
  21++935E CD 4E 6A       call DialogBox.msgNoWait
  22++9361
  23++9361                  ;ld a, 1, (Render.play_next), a
  24++9361 AF           	xor a
  25++9362 32 F7 93     	ld (last_song_position),a
  26++9365
  27++9365 26 00 3E 20      ld h, #00, a, 32
  28++9369 CD 47 60         call TextMode.fillLine
  29++936C 11 01 00         ld de, #0001
  29++936F CD 3A 60       call TextMode.gotoXY
  30++9372 21 B6 93         ld hl, message
  30++9375 CD BC 60       call TextMode.printZ
  31++9378 3E 00            ld a, #00
  32++937A CD 7B 60         call TextMode.highlightLine
  33++937D
  34++937D              .loop
  35++937D 76               halt
  36++937E AF               xor a
  37++937F CD A8 6A         call Console.peekC
  38++9382 FE 0C            cp Console.BACKSPACE
  39++9384 CA B0 93         jp z, .stopKey
  40++9387 FE 20        	cp SPACE
  41++9389 CA A4 93         jp z, .playNext
  42++938C
  43++938C CD 51 93         call printRTC
  44++938F
  45++938F                 ;  MOD   
  46++938F                  _SendCommand2 CMD_GET_SONG_POSITION
  46++938F 3E 60       >    ld a, CMD_GET_SONG_POSITION
  46++9391 D3 BB       >  out (CMD), a
  47++9393                  _WaitCommand2
  47++9393             >.wait
  47++9393 DB BB       >    in a, (CMD)
  47++9395 0F          >    rrca
  47++9396 38 FB       >    jr c, .wait
  48++9398 3A F7 93     	ld a,(last_song_position) ; 
  49++939B 4F           	ld c,a
  50++939C DB B3        	in a,(DATA) ; 
  51++939E 32 F7 93     	ld (last_song_position),a
  52++93A1 B9           	cp c
  53++93A2 30 D9        	jr nc, .loop ;  ,  
  54++93A4              .playNext
  55++93A4 3E 01 32 8F      ld a, 1, (Render.play_next), a ;      
  55++93A8 69
  56++93A9              .stop
  57++93A9 CD 32 93         call GeneralSound.stopModule
  58++93AC
  59++93AC CD 7E 6A         call Console.waitForKeyUp
  60++93AF C9               ret
  61++93B0              .stopKey
  62++93B0 AF               xor a
  62++93B1 32 8F 69       ld (Render.play_next), a ;      
  63++93B4 18 F3            jr .stop
  64++93B6
  65++93B6              message
  66++93B6                  IFDEF SCREEN64
  67++93B6                  ENDIF
  68++93B6                  IFDEF SCREEN80
  69++93B6 ~                db "       "
  70++93B6                  ENDIF
  71++93B6                  IFDEF SCREEN85
  72++93B6 ~                db "         "
  73++93B6                  ENDIF
  74++93B6
  75++93B6 50 6C 61 79      db "Playing MODs [SPACE] for next song [BACKSPACE] for stop playing.", 0
  75++93BA 69 6E 67 20
  75++93BE 4D 4F 44 73
  75++93C2 20 5B 53 50
  75++93C6 41 43 45 5D
  75++93CA 20 66 6F 72
  75++93CE 20 6E 65 78
  75++93D2 74 20 73 6F
  75++93D6 6E 67 20 5B
  75++93DA 42 41 43 4B
  75++93DE 53 50 41 43
  75++93E2 45 5D 20 66
  75++93E6 6F 72 20 73
  75++93EA 74 6F 70 20
  75++93EE 70 6C 61 79
  75++93F2 69 6E 67 2E
  75++93F6 00
  76++93F7
  77++93F7              CMD_GET_SONG_POSITION     = #60
  78++93F7 00           last_song_position db 0
  79++93F8
  80++93F8              ;; Control ports
  81++93F8              CMD  = 187
  82++93F8              DATA = 179
  83++93F8                  endif
  84++93F8                  ENDMODULE
  85++93F8
# file closed: player/mod-processor.asm
  42+ 93F8                      include "screen/screen.asm"
# file opened: screen/screen.asm
   1++93F8                  module ScreenViewer
   2++93F8              display:
   3++93F8 CD 7E 6A         call Console.waitForKeyUp
   4++93FB 3E 07            ld a, 7
   4++93FD CD E3 92       call Memory.setPage
   5++9400 21 86 A0 11      ld hl, outputBuffer, de, #c000, bc, 6912
   5++9404 00 C0 01 00
   5++9408 1B
   5++9409 ED B0          ldir
   6++940B CD 46 60         call TextMode.disable
   7++940E              .wait
   8++940E 76           	halt
   9++940F AF               xor a
   9++9410 DB FE          in a, (#fe)
   9++9412 2F             cpl
   9++9413 E6 1F          and 31
   9++9415 28 F7          jr z, .wait
  10++9417 CD 1D 60         call TextMode.cls
  11++941A C3 F5 73         jp History.back
  12++941D
  13++941D                  endmodule
# file closed: screen/screen.asm
  43+ 941D                      include "player/vortex-processor.asm"
# file opened: player/vortex-processor.asm
   1++941D                  MODULE VortexProcessor
   2++941D              	IFDEF MSX
   3++941D ~            play:
   4++941D ~                call Console.peekC
   4++941D ~              and a
   5++941D ~                jr nz, play
   6++941D ~
   7++941D ~                ld hl, message
   7++941D ~              call DialogBox.msgNoWait
   8++941D ~
   9++941D ~                ld hl, outputBuffer
   9++941D ~              call VTPL.INIT
  10++941D ~            .loop
  11++941D ~                halt
  11++941D ~              di
  11++941D ~              call VTPL.PLAY
  11++941D ~              ei
  12++941D ~                call Console.peekC
  12++941D ~              and a
  12++941D ~              jp nz, .stop
  13++941D ~                jr nc, .loop
  14++941D ~            .stop
  15++941D ~                call VTPL.MUTE
  16++941D ~            .wlp
  17++941D ~                call Console.peekC
  17++941D ~              and a
  18++941D ~                jr nz, .wlp
  19++941D ~                ret
  20++941D ~
  21++941D ~            message db "Press key to stop...", 0
  22++941D ~                ENDMODULE
  23++941D ~                include "msxplayer.asm"
  24++941D              	ELSE
  25++941D              play:
  26++941D 3E FF            ld a, 255
  27++941F 32 52 93         ld (oldminutes), a
  28++9422
  29++9422 CD 7E 6A         call Console.waitForKeyUp
  30++9425
  31++9425 21 7B 94         ld hl, message
  31++9428 CD 4E 6A       call DialogBox.msgNoWait
  32++942B
  33++942B 21 86 A0         ld hl, outputBuffer
  33++942E CD D1 94       call VTPL.INIT
  34++9431
  35++9431
  36++9431 3E 01 32 8F      ld a, 1, (Render.play_next), a
  36++9435 69
  37++9436
  38++9436                  IFDEF GS
  39++9436 CD 32 93         call GeneralSound.stopModule
  40++9439                  ENDIF
  41++9439              .loop
  42++9439 76               halt
  42++943A F3             di
  42++943B CD F4 9C       call VTPL.PLAY
  42++943E FB             ei
  43++943F AF               xor a
  43++9440 DB FE          in a, (#fe)
  43++9442 2F             cpl
  43++9443 E6 1F          and 31
  43++9445 C2 60 94       jp nz, .stopKey
  44++9448 CD 51 93         call printRTC
  45++944B 3A 9A 94         ld a, (VTPL.SETUP)
  45++944E 17             rla
  45++944F 30 E8          jr nc, .loop
  46++9451 3E 01 32 8F      ld a, 1, (Render.play_next), a
  46++9455 69
  47++9456              .stop
  48++9456 CD BF 94         call VTPL.MUTE
  49++9459
  50++9459                  IFDEF AY
  51++9459 CD 66 94         call restoreAyState
  52++945C                  ENDIF
  53++945C
  54++945C CD 7E 6A         call Console.waitForKeyUp
  55++945F C9               ret
  56++9460              .stopKey
  57++9460 AF               xor a
  57++9461 32 8F 69       ld (Render.play_next), a
  58++9464 18 F0            jr .stop
  59++9466
  60++9466                  IFDEF AY
  61++9466              restoreAyState:
  62++9466 3E 07            ld a, #07
  63++9468 01 FD FF         ld bc, #fffd
  64++946B ED 79            out (c), a
  65++946D 3E FC            ld a, #fc
  66++946F 06 BF            ld b, #bf
  67++9471 ED 79            out (c), a ; Enable read mode
  68++9473
  69++9473 3E 0E            ld a, #0e
  70++9475 01 FD FF         ld bc, #fffd
  71++9478 ED 79            out (c), a
  72++947A C9               ret
  73++947B              	ENDIF
  74++947B 50 72 65 73  message db "Press key to stop...", 0
  74++947F 73 20 6B 65
  74++9483 79 20 74 6F
  74++9487 20 73 74 6F
  74++948B 70 2E 2E 2E
  74++948F 00
  75++9490                  ENDMODULE
  76++9490                  include "player.asm"
# file opened: player/player.asm
   1++9490              ;Universal PT2'n'PT3 Turbo Sound player for ZX Spectrum
   2++9490              ;(c)2004-2007 S.V.Bulba <vorobey@mail.khstu.ru>
   3++9490              ;Specially for AlCo
   4++9490              ;http://bulba.untergrund.net/ (http://bulba.at.kz/)
   5++9490              	MODULE VTPL
   6++9490              ;Release number
   7++9490              Release EQU "0"
   8++9490              ;Conditional assembly
   9++9490              ;1) Current position counters at (Vars1+0) and (Vars2+0)
  10++9490              CurPosCounter=0
  11++9490              ;2) Allow channels allocation bits at (START+10)
  12++9490              ACBBAC=0
  13++9490              ;3) Allow loop checking and disabling
  14++9490              LoopChecker=1
  15++9490              ;4) Insert official identificator
  16++9490              Id=0
  17++9490              ;5) Set IY for correct return to ZX Basic
  18++9490              Basic=1
  19++9490
  20++9490              ;Features
  21++9490              ;--------
  22++9490              ;-Can be compiled at any address (i.e. no need rounding ORG
  23++9490              ; address).
  24++9490              ;-Variables (VARS) can be located at any address (not only after
  25++9490              ; code block).
  26++9490              ;-INIT subprogram checks PT3-module version and rightly
  27++9490              ; generates both note and volume tables outside of code block
  28++9490              ; (in VARS).
  29++9490              ;-Two portamento (spc. command 3xxx) algorithms (depending of
  30++9490              ; PT3 module version).
  31++9490              ;-New 1.XX and 2.XX special command behaviour (only for PT v3.7
  32++9490              ; and higher).
  33++9490              ;-Any Tempo value are accepted (including Tempo=1 and Tempo=2).
  34++9490              ;-TS modes: 2xPT3, 2xPT2 and PT v3.7 TS standard.
  35++9490              ;-Fully compatible with Ay_Emul PT3 and PT2 players codes.
  36++9490              ;-See also notes at the end of this source code.
  37++9490
  38++9490              ;Limitations
  39++9490              ;-----------
  40++9490              ;-Can run in RAM only (self-modified code is used).
  41++9490              ;-PT2 position list must be end by #FF marker only.
  42++9490
  43++9490              ;Warning!!! PLAY subprogram can crash if no module are loaded
  44++9490              ;into RAM or INIT subprogram was not called before.
  45++9490
  46++9490              ;Call MUTE or INIT one more time to mute sound after stopping
  47++9490              ;playing
  48++9490
  49++9490              ;Test codes (commented)
  50++9490              ;	LD A,32 ;SinglePT3(TS if TSPT3.7),ABC,Looped
  51++9490              ;	LD (START+10),A
  52++9490              ;	LD HL,#8000 ;Mod1
  53++9490              ;	LD DE,#A000 ;Mod2 (optional)
  54++9490              ;	CALL START+3
  55++9490              ;	EI
  56++9490              ;_LP	HALT
  57++9490              ;	CALL START+5
  58++9490              ;	XOR A
  59++9490              ;	IN A,(#FE)
  60++9490              ;	CPL
  61++9490              ;	AND 15
  62++9490              ;	JR Z,_LP
  63++9490              ;	JR START+8
  64++9490
  65++9490              TonA	EQU 0
  66++9490              TonB	EQU 2
  67++9490              TonC	EQU 4
  68++9490              Noise	EQU 6
  69++9490              Mixer	EQU 7
  70++9490              AmplA	EQU 8
  71++9490              AmplB	EQU 9
  72++9490              AmplC	EQU 10
  73++9490              Env	EQU 11
  74++9490              EnvTp	EQU 13
  75++9490
  76++9490              ;Entry and other points
  77++9490              ;START initialize playing of modules at MDLADDR (single module)
  78++9490              ;START+3 initialization with module address in HL and DE (TS)
  79++9490              ;START+5 play one quark
  80++9490              ;START+8 mute
  81++9490              ;START+10 setup and status flags
  82++9490
  83++9490              START:
  84++9490 21 86 A0     	LD HL,outputBuffer ;DE - address of 2nd module for TS
  85++9493 18 3C        	JR INIT
  86++9495 C3 F4 9C     	JP PLAY
  87++9498 18 25        	JR MUTE
  88++949A 00           SETUP	DB 0 ;set bit0, if you want to play without looping
  89++949B              	     ;(optional);
  90++949B              	     ;set bit1 for PT2 and reset for PT3 before
  91++949B              	     ;calling INIT;
  92++949B              	     ;bits2-3: %00-ABC, %01-ACB, %10-BAC (optional);
  93++949B              	     ;bits4-5: %00-no TS, %01-2 modules TS, %10-
  94++949B              	     ;autodetect PT3 TS-format by AlCo (PT 3.7+);
  95++949B              	     ;Remark: old PT3 TS-format by AlCo (PT 3.6) is not
  96++949B              	     ;documented and must be converted to new standard.
  97++949B              	     ;bit6 is set each time, when loop point of 2nd TS
  98++949B              	     ;module is passed (optional).
  99++949B              	     ;bit7 is set each time, when loop point of 1st TS
 100++949B              	     ;or of single module is passed (optional).
 101++949B
 102++949B              ;Identifier
 103++949B              	IF Id
 104++949B ~            	DB "=UniPT2/PT3/TS-Player r.",Release,"="
 105++949B              	ENDIF
 106++949B
 107++949B              	IF LoopChecker
 108++949B 21 9A 94     CHECKLP	LD HL,SETUP
 109++949E FD CB 9E 46  	BIT 0,(IY-100+VRS.ModNum)
 110++94A2 28 04        	JR Z,CHL1
 111++94A4 CB F6        	SET 6,(HL)
 112++94A6 18 02        	JR CHL2
 113++94A8 CB FE        CHL1	SET 7,(HL)
 114++94AA CB 46        CHL2	BIT 0,(HL)
 115++94AC C8           	RET Z
 116++94AD E1           	POP HL
 117++94AE FD 34 09     	INC (IY-100+VRS.DelyCnt)
 118++94B1 FD 34 BA     	INC (IY-100+VRS.ChanA+CHP.NtSkCn)
 119++94B4 AF           	XOR A
 120++94B5 FD 77 1D     	LD (IY-100+VRS.AYREGS+AmplA),A
 121++94B8 FD 77 1E     	LD (IY-100+VRS.AYREGS+AmplB),A
 122++94BB FD 77 1F     	LD (IY-100+VRS.AYREGS+AmplC),A
 123++94BE C9           	RET
 124++94BF              	ENDIF
 125++94BF
 126++94BF AF           MUTE: XOR A
 127++94C0 67           	LD H,A
 128++94C1 6F           	LD L,A
 129++94C2 32 49 9E     	LD (VARS1+VRS.AYREGS+AmplA),A
 130++94C5 22 4A 9E     	LD (VARS1+VRS.AYREGS+AmplB),HL
 131++94C8 32 D0 9E     	LD (VARS2+VRS.AYREGS+AmplA),A
 132++94CB 22 D1 9E     	LD (VARS2+VRS.AYREGS+AmplB),HL
 133++94CE C3 0C 9D     	JP ROUT
 134++94D1
 135++94D1              INIT:
 136++94D1              ;HL - AddressOfModule
 137++94D1              ;DE - AddresOf2ndModule
 138++94D1 D5           	PUSH DE
 139++94D2 E5           	PUSH HL
 140++94D3 21 C7 9D     	LD HL,VARS
 141++94D6 36 00        	LD (HL),0
 142++94D8 11 C8 9D     	LD DE,VARS+1
 143++94DB 01 0E 01     	LD BC,VAR0END-VARS-1
 144++94DE ED B0        	LDIR
 145++94E0 23           	INC HL
 146++94E1 22 2A 9E     	LD (VARS1+VRS.AdInPtA),HL ;ptr to zero
 147++94E4 22 B1 9E     	LD (VARS2+VRS.AdInPtA),HL
 148++94E7
 149++94E7 E1           	POP HL
 150++94E8 FD 21 2C 9E  	LD IY,VARS1+100
 151++94EC 3A 9A 94     	LD A,(START+10)
 152++94EF E6 02        	AND 2
 153++94F1 C2 7A 95     	JP NZ,I_PT2
 154++94F4
 155++94F4 CD C7 96     	CALL INITPT3
 156++94F7 21 18 1F     	LD HL,(e_-SamCnv-2)*256+#18
 157++94FA 22 9A 9A     	LD (SamCnv),HL
 158++94FD 3E BA        	LD A,#BA
 159++94FF 32 65 9A     	LD (OrnCP),A
 160++9502 32 91 9A     	LD (SamCP),A
 161++9505 3E 7B        	LD A,#7B
 162++9507 32 68 9A     	LD (OrnLD),A
 163++950A 32 94 9A     	LD (SamLD),A
 164++950D 3E 87        	LD A,#87
 165++950F 32 8B 9A     	LD (SamClc2),A
 166++9512 E1           	POP HL
 167++9513              	;Use version and ton table of 1st module
 168++9513 DD 7E A9     	LD A,(IX+13-100) ;EXTRACT VERSION NUMBER
 169++9516 D6 30        	SUB #30
 170++9518 38 04        	JR C,L20
 171++951A FE 0A        	CP 10
 172++951C 38 02        	JR C,L21
 173++951E 3E 06        L20	LD A,6
 174++9520 32 38 99     L21	LD (Version),A
 175++9523 F5           	PUSH AF ;VolTable version
 176++9524 FE 04        	CP 4
 177++9526 DD 7E FF     	LD A,(IX+99-100) ;TONE TABLE NUMBER
 178++9529 17           	RLA
 179++952A E6 07        	AND 7
 180++952C F5           	PUSH AF ;NoteTable number
 181++952D
 182++952D FD 21 B3 9E  	LD IY,VARS2+100
 183++9531 3A 9A 94     	LD A,(START+10)
 184++9534 E6 30        	AND 48
 185++9536 28 37        	JR Z,NOTS
 186++9538 FE 10        	CP 16
 187++953A 28 27        	JR Z,TwoPT3s
 188++953C 3A 38 99     	LD A,(Version)
 189++953F FE 07        	CP 7
 190++9541 38 2C        	JR C,NOTS
 191++9543 DD 7E FE     	LD A,(IX+98-100) ;ALCO TS MARKER
 192++9546 FE 20        	CP #20
 193++9548 28 25        	JR Z,NOTS
 194++954A 21 C8 9D     	LD HL,VARS1
 195++954D 11 4F 9E     	LD DE,VARS2
 196++9550 01 87 00     	LD BC,VRS
 197++9553 ED B0        	LDIR
 198++9555 FD CB 9E CE  	SET 1,(IY-100+VRS.ModNum)
 199++9559 4F           	LD C,A
 200++955A 87           	ADD A,A
 201++955B 81           	ADD A,C
 202++955C D6 02        	SUB 2
 203++955E 32 FF 9B     	LD (TSSub),A
 204++9561 18 03        	JR AlCoTS_
 205++9563 CD C7 96     TwoPT3s	CALL INITPT3
 206++9566 3E 01        AlCoTS_	LD A,1
 207++9568 32 C7 9D     	LD (is_ts),A
 208++956B FD CB 9E C6  	SET 0,(IY-100+VRS.ModNum)
 209++956F
 210++956F 01 84 98     NOTS	LD BC,PT3PD
 211++9572 21 00 00     	LD HL,0
 212++9575 11 8F 9D     	LD DE,PT3EMPTYORN
 213++9578 18 48        	JR INITCOMMON
 214++957A
 215++957A CD FF 96     I_PT2	CALL INITPT2
 216++957D 21 CB 51     	LD HL,#51CB
 217++9580 22 9A 9A     	LD (SamCnv),HL
 218++9583 3E BB        	LD A,#BB
 219++9585 32 65 9A     	LD (OrnCP),A
 220++9588 32 91 9A     	LD (SamCP),A
 221++958B 3E 7A        	LD A,#7A
 222++958D 32 68 9A     	LD (OrnLD),A
 223++9590 32 94 9A     	LD (SamLD),A
 224++9593 3E 80        	LD A,#80
 225++9595 32 8B 9A     	LD (SamClc2),A
 226++9598 E1           	POP HL
 227++9599 3E 05        	LD A,5
 228++959B 32 38 99     	LD (Version),A
 229++959E F5           	PUSH AF
 230++959F 3E 02        	LD A,2
 231++95A1 F5           	PUSH AF
 232++95A2
 233++95A2 3A 9A 94     	LD A,(START+10)
 234++95A5 E6 30        	AND 48
 235++95A7 28 10        	JR Z,NOTS2
 236++95A9
 237++95A9 FD 21 B3 9E  	LD IY,VARS2+100
 238++95AD 3E 01        	LD A,1
 239++95AF 32 C7 9D     	LD (is_ts),A
 240++95B2 FD CB 9E C6  	SET 0,(IY-100+VRS.ModNum)
 241++95B6 CD FF 96     	CALL INITPT2
 242++95B9
 243++95B9 01 BE 97     NOTS2	LD BC,PT2PD
 244++95BC 21 87 86     	LD HL,#8687
 245++95BF 11 E5 9E     	LD DE,PT2EMPTYORN
 246++95C2
 247++95C2              INITCOMMON
 248++95C2
 249++95C2              	IF Basic
 250++95C2 FD 21 3A 5C  	LD IY,#5C3A
 251++95C6              	ENDIF
 252++95C6
 253++95C6 ED 43 6F 97  	LD (PTDEC),BC
 254++95CA 22 01 9C     	LD (PsCalc),HL
 255++95CD D5           	PUSH DE
 256++95CE
 257++95CE              ;note table data depacker
 258++95CE              ;(c) Ivan Roshin
 259++95CE 11 92 9D     	LD DE,T_PACK
 260++95D1 01 37 9F     	LD BC,T1_+(2*49)-1
 261++95D4 1A           TP_0	LD A,(DE)
 262++95D5 13           	INC DE
 263++95D6 FE 1E        	CP 15*2
 264++95D8 30 06        	JR NC,TP_1
 265++95DA 67           	LD H,A
 266++95DB 1A           	LD A,(DE)
 267++95DC 6F           	LD L,A
 268++95DD 13           	INC DE
 269++95DE 18 07        	JR TP_2
 270++95E0 D5           TP_1	PUSH DE
 271++95E1 16 00        	LD D,0
 272++95E3 5F           	LD E,A
 273++95E4 19           	ADD HL,DE
 274++95E5 19           	ADD HL,DE
 275++95E6 D1           	POP DE
 276++95E7 7C           TP_2	LD A,H
 277++95E8 02           	LD (BC),A
 278++95E9 0B           	DEC BC
 279++95EA 7D           	LD A,L
 280++95EB 02           	LD (BC),A
 281++95EC 0B           	DEC BC
player.asm(282): warning: value 0x1F0 is truncated to 8bit value: 0xF0
 282++95ED D6 F0        	SUB #F8*2
 283++95EF 20 E3        	JR NZ,TP_0
 284++95F1
 285++95F1 3C           	INC A
 286++95F2 32 35 9E     	LD (VARS1+VRS.DelyCnt),A
 287++95F5 32 BC 9E     	LD (VARS2+VRS.DelyCnt),A
 288++95F8 21 01 F0     	LD HL,#F001 ;H - CHP.Volume, L - CHP.NtSkCn
 289++95FB 22 E6 9D     	LD (VARS1+VRS.ChanA+CHP.NtSkCn),HL
 290++95FE 22 03 9E     	LD (VARS1+VRS.ChanB+CHP.NtSkCn),HL
 291++9601 22 20 9E     	LD (VARS1+VRS.ChanC+CHP.NtSkCn),HL
 292++9604 22 6D 9E     	LD (VARS2+VRS.ChanA+CHP.NtSkCn),HL
 293++9607 22 8A 9E     	LD (VARS2+VRS.ChanB+CHP.NtSkCn),HL
 294++960A 22 A7 9E     	LD (VARS2+VRS.ChanC+CHP.NtSkCn),HL
 295++960D E1           	POP HL
 296++960E 22 D8 9D     	LD (VARS1+VRS.ChanA+CHP.OrnPtr),HL
 297++9611 22 F5 9D     	LD (VARS1+VRS.ChanB+CHP.OrnPtr),HL
 298++9614 22 12 9E     	LD (VARS1+VRS.ChanC+CHP.OrnPtr),HL
 299++9617 22 5F 9E     	LD (VARS2+VRS.ChanA+CHP.OrnPtr),HL
 300++961A 22 7C 9E     	LD (VARS2+VRS.ChanB+CHP.OrnPtr),HL
 301++961D 22 99 9E     	LD (VARS2+VRS.ChanC+CHP.OrnPtr),HL
 302++9620
 303++9620 F1           	POP AF
 304++9621
 305++9621              ;NoteTableCreator (c) Ivan Roshin
 306++9621              ;A - NoteTableNumber*2+VersionForNoteTable
 307++9621              ;(xx1b - 3.xx..3.4r, xx0b - 3.4x..3.6x..VTII1.0)
 308++9621
 309++9621 21 3F 9D     	LD HL,NT_DATA
 310++9624 16 00        	LD D,0
 311++9626 87           	ADD A,A
 312++9627 5F           	LD E,A
 313++9628 19           	ADD HL,DE
 314++9629 5E           	LD E,(HL)
 315++962A 23           	INC HL
 316++962B CB 3B        	SRL E
 317++962D 9F           	SBC A,A
 318++962E E6 A7        	AND #A7 ;#00 (NOP) or #A7 (AND A)
 319++9630 32 58 96     	LD (L3),A
 320++9633 EB           	EX DE,HL
 321++9634 01 D6 9E     	LD BC,T1_
 322++9637 09           	ADD HL,BC
 323++9638
 324++9638 1A           	LD A,(DE)
player.asm(325): warning: value 0x9D4F is truncated to 8bit value: 0x4F
 325++9639 C6 4F        	ADD A,T_
 326++963B 4F           	LD C,A
 327++963C CE 9D        	ADC A,T_/256
 328++963E 91           	SUB C
 329++963F 47           	LD B,A
 330++9640 C5           	PUSH BC
 331++9641 11 C6 9F     	LD DE,NT_
 332++9644 D5           	PUSH DE
 333++9645
 334++9645 06 0C        	LD B,12
 335++9647 C5           L1	PUSH BC
 336++9648 4E           	LD C,(HL)
 337++9649 23           	INC HL
 338++964A E5           	PUSH HL
 339++964B 46           	LD B,(HL)
 340++964C
 341++964C D5           	PUSH DE
 342++964D EB           	EX DE,HL
 343++964E 11 17 00     	LD DE,23
 344++9651 DD 26 08     	LD IXH,8
 345++9654
 346++9654 CB 38        L2	SRL B
 347++9656 CB 19        	RR C
 348++9658 19           L3	DB #19	;AND A or NOP
 349++9659 79           	LD A,C
 350++965A 8A           	ADC A,D	;=ADC 0
 351++965B 77           	LD (HL),A
 352++965C 23           	INC HL
 353++965D 78           	LD A,B
 354++965E 8A           	ADC A,D
 355++965F 77           	LD (HL),A
 356++9660 19           	ADD HL,DE
 357++9661 DD 25        	DEC IXH
 358++9663 20 EF        	JR NZ,L2
 359++9665
 360++9665 D1           	POP DE
 361++9666 13           	INC DE
 362++9667 13           	INC DE
 363++9668 E1           	POP HL
 364++9669 23           	INC HL
 365++966A C1           	POP BC
 366++966B 10 DA        	DJNZ L1
 367++966D
 368++966D E1           	POP HL
 369++966E D1           	POP DE
 370++966F
 371++966F 7B           	LD A,E
player.asm(372): warning: value 0x9D5B is truncated to 8bit value: 0x5B
 372++9670 FE 5B        	CP TCOLD_1
 373++9672 20 05        	JR NZ,CORR_1
 374++9674 3E FD        	LD A,#FD
 375++9676 32 F4 9F     	LD (NT_+#2E),A
 376++9679
 377++9679 1A           CORR_1	LD A,(DE)
 378++967A A7           	AND A
 379++967B 28 11        	JR Z,TC_EXIT
 380++967D 1F           	RRA
 381++967E F5           	PUSH AF
 382++967F 87           	ADD A,A
 383++9680 4F           	LD C,A
 384++9681 09           	ADD HL,BC
 385++9682 F1           	POP AF
 386++9683 30 02        	JR NC,CORR_2
 387++9685 35           	DEC (HL)
 388++9686 35           	DEC (HL)
 389++9687 34           CORR_2	INC (HL)
 390++9688 A7           	AND A
 391++9689 ED 42        	SBC HL,BC
 392++968B 13           	INC DE
 393++968C 18 EB        	JR CORR_1
 394++968E
 395++968E              TC_EXIT
 396++968E
 397++968E F1           	POP AF
 398++968F
 399++968F              ;VolTableCreator (c) Ivan Roshin
 400++968F              ;A - VersionForVolumeTable (0..4 - 3.xx..3.4x;
 401++968F              			   ;5.. - 2.x,3.5x..3.6x..VTII1.0)
 402++968F
 403++968F FE 05        	CP 5
 404++9691 21 11 00     	LD HL,#11
 405++9694 54           	LD D,H
 406++9695 5C           	LD E,H
 407++9696 3E 17        	LD A,#17
 408++9698 30 03        	JR NC,M1
 409++969A 2D           	DEC L
 410++969B 5D           	LD E,L
 411++969C AF           	XOR A
 412++969D 32 AE 96     M1      LD (M2),A
 413++96A0
 414++96A0 DD 21 D6 9E  	LD IX,VT_+16
 415++96A4
 416++96A4 0E 0F        	LD C,#F
 417++96A6 E5           INITV2  PUSH HL
 418++96A7
 419++96A7 19           	ADD HL,DE
 420++96A8 EB           	EX DE,HL
 421++96A9 ED 62        	SBC HL,HL
 422++96AB
 423++96AB 06 10        	LD B,#10
 424++96AD 7D           INITV1  LD A,L
 425++96AE 7D           M2      DB #7D
 426++96AF 7C           	LD A,H
 427++96B0 CE 00        	ADC A,0
 428++96B2 DD 77 00     	LD (IX),A
 429++96B5 DD 23        	INC IX
 430++96B7 19           	ADD HL,DE
 431++96B8 10 F3        	DJNZ INITV1
 432++96BA
 433++96BA E1           	POP HL
 434++96BB 7B           	LD A,E
 435++96BC FE 77        	CP #77
 436++96BE 20 01        	JR NZ,M3
 437++96C0 1C           	INC E
 438++96C1 0D           M3      DEC C
 439++96C2 20 E2        	JR NZ,INITV2
 440++96C4
 441++96C4 C3 0C 9D     	JP ROUT
 442++96C7
 443++96C7 CD 3A 97     INITPT3	CALL SETMDAD
 444++96CA E5           	PUSH HL
 445++96CB 11 64 00     	LD DE,100
 446++96CE 19           	ADD HL,DE
 447++96CF 7E           	LD A,(HL)
 448++96D0 FD 77 08     	LD (IY-100+VRS.Delay),A
 449++96D3 E5           	PUSH HL
 450++96D4 DD E1        	POP IX
 451++96D6 19           	ADD HL,DE
 452++96D7 CD 48 97     	CALL SETCPPT
 453++96DA DD 5E 02     	LD E,(IX+102-100)
 454++96DD 23           	INC HL
 455++96DE
 456++96DE              	IF CurPosCounter
 457++96DE ~            	LD (IY-100+VRS.PosSub),L
 458++96DE              	ENDIF
 459++96DE
 460++96DE 19           	ADD HL,DE
 461++96DF CD 4F 97     	CALL SETLPPT
 462++96E2 D1           	POP DE
 463++96E3 DD 6E 03     	LD L,(IX+103-100)
 464++96E6 DD 66 04     	LD H,(IX+104-100)
 465++96E9 19           	ADD HL,DE
 466++96EA CD 33 97     	CALL SETPTPT
 467++96ED 21 A9 00     	LD HL,169
 468++96F0 19           	ADD HL,DE
 469++96F1 CD 41 97     	CALL SETORPT
 470++96F4 21 69 00     	LD HL,105
 471++96F7 19           	ADD HL,DE
 472++96F8
 473++96F8 FD 75 FA     SETSMPT LD (IY-100+VRS.SamPtrs),L
 474++96FB FD 74 FB     	LD (IY-100+VRS.SamPtrs+1),H
 475++96FE C9           	RET
 476++96FF
 477++96FF 7E           INITPT2	LD A,(HL)
 478++9700 FD 77 08     	LD (IY-100+VRS.Delay),A
 479++9703 E5           	PUSH HL
 480++9704 E5           	PUSH HL
 481++9705 E5           	PUSH HL
 482++9706 23           	INC HL
 483++9707 23           	INC HL
 484++9708 7E           	LD A,(HL)
 485++9709 23           	INC HL
 486++970A CD F8 96     	CALL SETSMPT
 487++970D 5E           	LD E,(HL)
 488++970E 23           	INC HL
 489++970F 56           	LD D,(HL)
 490++9710 E1           	POP HL
 491++9711 A7           	AND A
 492++9712 ED 52        	SBC HL,DE
 493++9714 CD 3A 97     	CALL SETMDAD
 494++9717 E1           	POP HL
 495++9718 11 43 00     	LD DE,67
 496++971B 19           	ADD HL,DE
 497++971C CD 41 97     	CALL SETORPT
 498++971F 1E 20        	LD E,32
 499++9721 19           	ADD HL,DE
 500++9722 4E           	LD C,(HL)
 501++9723 23           	INC HL
 502++9724 46           	LD B,(HL)
 503++9725 1E 1E        	LD E,30
 504++9727 19           	ADD HL,DE
 505++9728 CD 48 97     	CALL SETCPPT
 506++972B 5F           	LD E,A
 507++972C 23           	INC HL
 508++972D
 509++972D              	IF CurPosCounter
 510++972D ~            	LD (IY-100+VRS.PosSub),L
 511++972D              	ENDIF
 512++972D
 513++972D 19           	ADD HL,DE
 514++972E CD 4F 97     	CALL SETLPPT
 515++9731 E1           	POP HL
 516++9732 09           	ADD HL,BC
 517++9733
 518++9733 FD 75 FC     SETPTPT	LD (IY-100+VRS.PatsPtr),L
 519++9736 FD 74 FD     	LD (IY-100+VRS.PatsPtr+1),H
 520++9739 C9           	RET
 521++973A
 522++973A FD 75 F6     SETMDAD	LD (IY-100+VRS.MODADDR),L
 523++973D FD 74 F7     	LD (IY-100+VRS.MODADDR+1),H
 524++9740 C9           	RET
 525++9741
 526++9741 FD 75 F8     SETORPT	LD (IY-100+VRS.OrnPtrs),L
 527++9744 FD 74 F9     	LD (IY-100+VRS.OrnPtrs+1),H
 528++9747 C9           	RET
 529++9748
 530++9748 FD 75 04     SETCPPT	LD (IY-100+VRS.CrPsPtr),L
 531++974B FD 74 05     	LD (IY-100+VRS.CrPsPtr+1),H
 532++974E C9           	RET
 533++974F
 534++974F FD 75 06     SETLPPT	LD (IY-100+VRS.LPosPtr),L
 535++9752 FD 74 07     	LD (IY-100+VRS.LPosPtr+1),H
 536++9755 C9           	RET
 537++9756
 538++9756 FD 75 13     SETENBS	LD (IY-100+VRS.EnvBase),L
 539++9759 FD 74 14     	LD (IY-100+VRS.EnvBase+1),H
 540++975C C9           	RET
 541++975D
 542++975D FD 75 0C     SETESLD	LD (IY-100+VRS.CurESld),L
 543++9760 FD 74 0D     	LD (IY-100+VRS.CurESld+1),H
 544++9763 C9           	RET
 545++9764
 546++9764 FD E5        GETIX	PUSH IY
 547++9766 DD E1        	POP IX
 548++9768 DD 19        	ADD IX,DE
 549++976A C9           	RET
 550++976B
 551++976B CD 64 97     PTDECOD CALL GETIX
 552++976E              PTDEC	EQU $+1
 553++976E C3 C3 C3     	JP #C3C3
 554++9771
 555++9771              ;PT2 pattern decoder
 556++9771 CD 07 9A     PD2_SAM	CALL SETSAM
 557++9774 18 4A        	JR PD2_LOOP
 558++9776
 559++9776 DD 77 08     PD2_EOff LD (IX-12+CHP.Env_En),A
 560++9779 18 45        	JR PD2_LOOP
 561++977B
 562++977B DD 36 08 10  PD2_ENV	LD (IX-12+CHP.Env_En),16
 563++977F FD 77 22     	LD (IY-100+VRS.AYREGS+EnvTp),A
 564++9782 0A           	LD A,(BC)
 565++9783 03           	INC BC
 566++9784 6F           	LD L,A
 567++9785 0A           	LD A,(BC)
 568++9786 03           	INC BC
 569++9787 67           	LD H,A
 570++9788 CD 56 97     	CALL SETENBS
 571++978B 18 33        	JR PD2_LOOP
 572++978D
 573++978D CD E8 99     PD2_ORN	CALL SETORN
 574++9790 18 2E        	JR PD2_LOOP
 575++9792
 576++9792 3C           PD2_SKIP INC A
 577++9793 DD 77 05     	LD (IX-12+CHP.NNtSkp),A
 578++9796 18 28        	JR PD2_LOOP
 579++9798
 580++9798 0F           PD2_VOL	RRCA
 581++9799 0F           	RRCA
 582++979A 0F           	RRCA
 583++979B 0F           	RRCA
 584++979C DD 77 10     	LD (IX-12+CHP.Volume),A
 585++979F 18 1F        	JR PD2_LOOP
 586++97A1
 587++97A1 CD B8 99     PD2_DEL	CALL C_DELAY
 588++97A4 18 1A        	JR PD2_LOOP
 589++97A6
 590++97A6 DD CB 09 D6  PD2_GLIS SET 2,(IX-12+CHP.Flags)
 591++97AA 3C           	INC A
 592++97AB DD 77 0A     	LD (IX-12+CHP.TnSlDl),A
 593++97AE DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 594++97B1 0A           	LD A,(BC)
 595++97B2 03           	INC BC
 596++97B3 DD 77 0B             LD (IX-12+CHP.TSlStp),A
 597++97B6 87           	ADD A,A
 598++97B7 9F           	SBC A,A
 599++97B8 DD 77 0C             LD (IX-12+CHP.TSlStp+1),A
 600++97BB 37           	SCF
 601++97BC 18 01        	JR PD2_LP2
 602++97BE
 603++97BE A7           PT2PD	AND A
 604++97BF
 605++97BF 08           PD2_LP2	EX AF,AF'
 606++97C0
 607++97C0 0A           PD2_LOOP LD A,(BC)
 608++97C1 03           	INC BC
 609++97C2 C6 20        	ADD A,#20
 610++97C4 28 3F        	JR Z,PD2_REL
 611++97C6 38 A9        	JR C,PD2_SAM
 612++97C8 C6 60        	ADD A,96
 613++97CA 38 3E        	JR C,PD2_NOTE
 614++97CC 3C           	INC A
 615++97CD 28 A7        	JR Z,PD2_EOff
 616++97CF C6 0F        	ADD A,15
 617++97D1 CA E7 98     	JP Z,PD_FIN
 618++97D4 38 A5        	JR C,PD2_ENV
 619++97D6 C6 10        	ADD A,#10
 620++97D8 38 B3        	JR C,PD2_ORN
 621++97DA C6 40        	ADD A,#40
 622++97DC 38 B4        	JR C,PD2_SKIP
 623++97DE C6 10        	ADD A,#10
 624++97E0 38 B6        	JR C,PD2_VOL
 625++97E2 3C           	INC A
 626++97E3 28 BC        	JR Z,PD2_DEL
 627++97E5 3C           	INC A
 628++97E6 28 BE        	JR Z,PD2_GLIS
 629++97E8 3C           	INC A
 630++97E9 28 0A        	JR Z,PD2_PORT
 631++97EB 3C           	INC A
 632++97EC 28 12        	JR Z,PD2_STOP
 633++97EE 0A           	LD A,(BC)
 634++97EF 03           	INC BC
 635++97F0 DD 77 F7     	LD (IX-12+CHP.CrNsSl),A
 636++97F3 18 CB        	JR PD2_LOOP
 637++97F5
 638++97F5 DD CB 09 96  PD2_PORT RES 2,(IX-12+CHP.Flags)
 639++97F9 0A           	LD A,(BC)
 640++97FA 03           	INC BC
 641++97FB 03           	INC BC ;ignoring precalc delta to right sound
 642++97FC 03           	INC BC
 643++97FD 37           	SCF
 644++97FE 18 BF        	JR PD2_LP2
 645++9800
 646++9800 DD 77 F9     PD2_STOP LD (IX-12+CHP.TSlCnt),A
 647++9803 18 BB        	JR PD2_LOOP
 648++9805
 649++9805 DD 77 09     PD2_REL	LD (IX-12+CHP.Flags),A
 650++9808 18 2C        	JR PD2_EXIT
 651++980A
 652++980A 6F           PD2_NOTE LD L,A
 653++980B DD 7E 06     	LD A,(IX-12+CHP.Note)
 654++980E 32 21 99     	LD (PrNote+1),A
 655++9811 DD 75 06     	LD (IX-12+CHP.Note),L
 656++9814 AF           	XOR A
 657++9815 DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 658++9818 DD CB 09 C6  	SET 0,(IX-12+CHP.Flags)
 659++981C 08           	EX AF,AF'
 660++981D 30 16        	JR NC,NOGLIS2
 661++981F DD CB 09 56  	BIT 2,(IX-12+CHP.Flags)
 662++9823 20 0C        	JR NZ,NOPORT2
 663++9825 32 47 99     	LD (LoStep),A
 664++9828 87           	ADD A,A
 665++9829 9F           	SBC A,A
 666++982A 08           	EX AF,AF'
 667++982B 67           	LD H,A
 668++982C 6F           	LD L,A
 669++982D 3C           	INC A
 670++982E CD 02 99     	CALL SETPORT
 671++9831 DD 36 F9 01  NOPORT2	LD (IX-12+CHP.TSlCnt),1
 672++9835 AF           NOGLIS2	XOR A
 673++9836
 674++9836
 675++9836 DD 77 F5     PD2_EXIT LD (IX-12+CHP.PsInSm),A
 676++9839 DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 677++983C DD 77 FA     	LD (IX-12+CHP.CrTnSl),A
 678++983F DD 77 FB     	LD (IX-12+CHP.CrTnSl+1),A
 679++9842 C3 E7 98     	JP PD_FIN
 680++9845
 681++9845              ;PT3 pattern decoder
 682++9845 DD 36 08 00  PD_OrSm	LD (IX-12+CHP.Env_En),0
 683++9849 CD E8 99     	CALL SETORN
 684++984C 0A           PD_SAM_	LD A,(BC)
 685++984D 03           	INC BC
 686++984E 0F           	RRCA
 687++984F
 688++984F CD 07 9A     PD_SAM	CALL SETSAM
 689++9852 18 3F        	JR PD_LOOP
 690++9854
 691++9854 0F           PD_VOL	RRCA
 692++9855 0F           	RRCA
 693++9856 0F           	RRCA
 694++9857 0F           	RRCA
 695++9858 DD 77 10     	LD (IX-12+CHP.Volume),A
 696++985B 18 39        	JR PD_LP2
 697++985D
 698++985D DD 77 08     PD_EOff	LD (IX-12+CHP.Env_En),A
 699++9860 DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 700++9863 18 31        	JR PD_LP2
 701++9865
 702++9865 3D           PD_SorE	DEC A
 703++9866 20 07        	JR NZ,PD_ENV
 704++9868 0A           	LD A,(BC)
 705++9869 03           	INC BC
 706++986A DD 77 05     	LD (IX-12+CHP.NNtSkp),A
 707++986D 18 27        	JR PD_LP2
 708++986F
 709++986F CD CD 99     PD_ENV	CALL SETENV
 710++9872 18 22        	JR PD_LP2
 711++9874
 712++9874 CD E8 99     PD_ORN	CALL SETORN
 713++9877 18 1A        	JR PD_LOOP
 714++9879
 715++9879 DD 77 08     PD_ESAM	LD (IX-12+CHP.Env_En),A
 716++987C DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 717++987F C4 CD 99     	CALL NZ,SETENV
 718++9882 18 C8        	JR PD_SAM_
 719++9884
 720++9884 DD 7E 06     PT3PD	LD A,(IX-12+CHP.Note)
 721++9887 32 21 99     	LD (PrNote+1),A
 722++988A DD 6E FA     	LD L,(IX-12+CHP.CrTnSl)
 723++988D DD 66 FB     	LD H,(IX-12+CHP.CrTnSl+1)
 724++9890 22 3E 99     	LD (PrSlide+1),HL
 725++9893
 726++9893 11 10 20     PD_LOOP	LD DE,#2010
 727++9896 0A           PD_LP2	LD A,(BC)
 728++9897 03           	INC BC
 729++9898 83           	ADD A,E
 730++9899 38 AA        	JR C,PD_OrSm
 731++989B 82           	ADD A,D
 732++989C 28 49        	JR Z,PD_FIN
 733++989E 38 AF        	JR C,PD_SAM
 734++98A0 83           	ADD A,E
 735++98A1 28 25        	JR Z,PD_REL
 736++98A3 38 AF        	JR C,PD_VOL
 737++98A5 83           	ADD A,E
 738++98A6 28 B5        	JR Z,PD_EOff
 739++98A8 38 BB        	JR C,PD_SorE
 740++98AA C6 60        	ADD A,96
 741++98AC 38 20        	JR C,PD_NOTE
 742++98AE 83           	ADD A,E
 743++98AF 38 C3        	JR C,PD_ORN
 744++98B1 82           	ADD A,D
 745++98B2 38 0F        	JR C,PD_NOIS
 746++98B4 83           	ADD A,E
 747++98B5 38 C2        	JR C,PD_ESAM
 748++98B7 87           	ADD A,A
 749++98B8 5F           	LD E,A
player.asm(750): warning: value 0x17943 is truncated to 16bit value: 0x7943
 750++98B9 21 43 79     	LD HL,SPCCOMS+#FF20-#2000
 751++98BC 19           	ADD HL,DE
 752++98BD 5E           	LD E,(HL)
 753++98BE 23           	INC HL
 754++98BF 56           	LD D,(HL)
 755++98C0 D5           	PUSH DE
 756++98C1 18 D0        	JR PD_LOOP
 757++98C3
 758++98C3 FD 77 10     PD_NOIS	LD (IY-100+VRS.Ns_Base),A
 759++98C6 18 CE        	JR PD_LP2
 760++98C8
 761++98C8 DD CB 09 86  PD_REL	RES 0,(IX-12+CHP.Flags)
 762++98CC 18 08        	JR PD_RES
 763++98CE
 764++98CE DD 77 06     PD_NOTE	LD (IX-12+CHP.Note),A
 765++98D1 DD CB 09 C6  	SET 0,(IX-12+CHP.Flags)
 766++98D5 AF           	XOR A
 767++98D6
 768++98D6 ED 73 E5 98  PD_RES	LD (PDSP_+1),SP
 769++98DA DD F9        	LD SP,IX
 770++98DC 67           	LD H,A
 771++98DD 6F           	LD L,A
 772++98DE E5           	PUSH HL
 773++98DF E5           	PUSH HL
 774++98E0 E5           	PUSH HL
 775++98E1 E5           	PUSH HL
 776++98E2 E5           	PUSH HL
 777++98E3 E5           	PUSH HL
 778++98E4 31 31 31     PDSP_	LD SP,#3131
 779++98E7
 780++98E7 DD 7E 05     PD_FIN	LD A,(IX-12+CHP.NNtSkp)
 781++98EA DD 77 0F     	LD (IX-12+CHP.NtSkCn),A
 782++98ED C9           	RET
 783++98EE
 784++98EE 0A           C_PORTM LD A,(BC)
 785++98EF 03           	INC BC
 786++98F0              ;SKIP PRECALCULATED TONE DELTA (BECAUSE
 787++98F0              ;CANNOT BE RIGHT AFTER PT3 COMPILATION)
 788++98F0 03           	INC BC
 789++98F1 03           	INC BC
 790++98F2 08           	EX AF,AF'
 791++98F3 0A           	LD A,(BC) ;SIGNED TONE STEP
 792++98F4 03           	INC BC
 793++98F5 32 47 99     	LD (LoStep),A
 794++98F8 0A           	LD A,(BC)
 795++98F9 03           	INC BC
 796++98FA A7           	AND A
 797++98FB 08           	EX AF,AF'
 798++98FC DD 6E FA     	LD L,(IX-12+CHP.CrTnSl)
 799++98FF DD 66 FB     	LD H,(IX-12+CHP.CrTnSl+1)
 800++9902
 801++9902              ;Set portamento variables
 802++9902              ;A - Delay; A' - Hi(Step); ZF' - (A'=0); HL - CrTnSl
 803++9902
 804++9902 DD CB 09 96  SETPORT	RES 2,(IX-12+CHP.Flags)
 805++9906 DD 77 0A     	LD (IX-12+CHP.TnSlDl),A
 806++9909 DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 807++990C E5           	PUSH HL
 808++990D 11 C6 9F     	LD DE,NT_
 809++9910 DD 7E 06     	LD A,(IX-12+CHP.Note)
 810++9913 DD 77 07     	LD (IX-12+CHP.SlToNt),A
 811++9916 87           	ADD A,A
 812++9917 6F           	LD L,A
 813++9918 26 00        	LD H,0
 814++991A 19           	ADD HL,DE
 815++991B 7E           	LD A,(HL)
 816++991C 23           	INC HL
 817++991D 66           	LD H,(HL)
 818++991E 6F           	LD L,A
 819++991F E5           	PUSH HL
 820++9920 3E 3E        PrNote	LD A,#3E
 821++9922 DD 77 06     	LD (IX-12+CHP.Note),A
 822++9925 87           	ADD A,A
 823++9926 6F           	LD L,A
 824++9927 26 00        	LD H,0
 825++9929 19           	ADD HL,DE
 826++992A 5E           	LD E,(HL)
 827++992B 23           	INC HL
 828++992C 56           	LD D,(HL)
 829++992D E1           	POP HL
 830++992E ED 52        	SBC HL,DE
 831++9930 DD 75 0D     	LD (IX-12+CHP.TnDelt),L
 832++9933 DD 74 0E     	LD (IX-12+CHP.TnDelt+1),H
 833++9936 D1           	POP DE
 834++9937              Version EQU $+1
 835++9937 3E 3E        	LD A,#3E
 836++9939 FE 06        	CP 6
 837++993B 38 09        	JR C,OLDPRTM ;Old 3xxx for PT v3.5-
 838++993D 11 11 11     PrSlide	LD DE,#1111
 839++9940 DD 73 FA     	LD (IX-12+CHP.CrTnSl),E
 840++9943 DD 72 FB     	LD (IX-12+CHP.CrTnSl+1),D
 841++9946              LoStep	EQU $+1
 842++9946 3E 3E        OLDPRTM	LD A,#3E
 843++9948 08           	EX AF,AF'
 844++9949 28 01        	JR Z,NOSIG
 845++994B EB           	EX DE,HL
 846++994C ED 52        NOSIG	SBC HL,DE
 847++994E F2 56 99     	JP P,SET_STP
 848++9951 2F           	CPL
 849++9952 08           	EX AF,AF'
 850++9953 ED 44        	NEG
 851++9955 08           	EX AF,AF'
 852++9956 DD 77 0C     SET_STP	LD (IX-12+CHP.TSlStp+1),A
 853++9959 08           	EX AF,AF'
 854++995A DD 77 0B     	LD (IX-12+CHP.TSlStp),A
 855++995D DD 36 FE 00  	LD (IX-12+CHP.COnOff),0
 856++9961 C9           	RET
 857++9962
 858++9962 DD CB 09 D6  C_GLISS	SET 2,(IX-12+CHP.Flags)
 859++9966 0A           	LD A,(BC)
 860++9967 03           	INC BC
 861++9968 DD 77 0A     	LD (IX-12+CHP.TnSlDl),A
 862++996B A7           	AND A
 863++996C 20 07        	JR NZ,GL36
 864++996E 3A 38 99     	LD A,(Version) ;AlCo PT3.7+
 865++9971 FE 07        	CP 7
 866++9973 9F           	SBC A,A
 867++9974 3C           	INC A
 868++9975 DD 77 F9     GL36	LD (IX-12+CHP.TSlCnt),A
 869++9978 0A           	LD A,(BC)
 870++9979 03           	INC BC
 871++997A 08           	EX AF,AF'
 872++997B 0A           	LD A,(BC)
 873++997C 03           	INC BC
 874++997D 18 D7        	JR SET_STP
 875++997F
 876++997F 0A           C_SMPOS	LD A,(BC)
 877++9980 03           	INC BC
 878++9981 DD 77 F5     	LD (IX-12+CHP.PsInSm),A
 879++9984 C9           	RET
 880++9985
 881++9985 0A           C_ORPOS	LD A,(BC)
 882++9986 03           	INC BC
 883++9987 DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 884++998A C9           	RET
 885++998B
 886++998B 0A           C_VIBRT	LD A,(BC)
 887++998C 03           	INC BC
 888++998D DD 77 FF     	LD (IX-12+CHP.OnOffD),A
 889++9990 DD 77 FE     	LD (IX-12+CHP.COnOff),A
 890++9993 0A           	LD A,(BC)
 891++9994 03           	INC BC
 892++9995 DD 77 00     	LD (IX-12+CHP.OffOnD),A
 893++9998 AF           	XOR A
 894++9999 DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 895++999C DD 77 FA     	LD (IX-12+CHP.CrTnSl),A
 896++999F DD 77 FB     	LD (IX-12+CHP.CrTnSl+1),A
 897++99A2 C9           	RET
 898++99A3
 899++99A3 0A           C_ENGLS	LD A,(BC)
 900++99A4 03           	INC BC
 901++99A5 FD 77 0E     	LD (IY-100+VRS.Env_Del),A
 902++99A8 FD 77 0F     	LD (IY-100+VRS.CurEDel),A
 903++99AB 0A           	LD A,(BC)
 904++99AC 03           	INC BC
 905++99AD 6F           	LD L,A
 906++99AE 0A           	LD A,(BC)
 907++99AF 03           	INC BC
 908++99B0 67           	LD H,A
 909++99B1 FD 75 0A     	LD (IY-100+VRS.ESldAdd),L
 910++99B4 FD 74 0B     	LD (IY-100+VRS.ESldAdd+1),H
 911++99B7 C9           	RET
 912++99B8
 913++99B8 0A           C_DELAY	LD A,(BC)
 914++99B9 03           	INC BC
 915++99BA FD 77 08     	LD (IY-100+VRS.Delay),A
 916++99BD 21 51 9E     	LD HL,VARS2+VRS.ModNum ;if AlCo_TS
 917++99C0 CB 4E        	BIT 1,(HL)
 918++99C2 C8           	RET Z
 919++99C3 32 34 9E     	LD (VARS1+VRS.Delay),A
 920++99C6 32 35 9E     	LD (VARS1+VRS.DelyCnt),A
 921++99C9 32 BB 9E     	LD (VARS2+VRS.Delay),A
 922++99CC C9           	RET
 923++99CD
 924++99CD DD 73 08     SETENV	LD (IX-12+CHP.Env_En),E
 925++99D0 FD 77 22     	LD (IY-100+VRS.AYREGS+EnvTp),A
 926++99D3 0A           	LD A,(BC)
 927++99D4 03           	INC BC
 928++99D5 67           	LD H,A
 929++99D6 0A           	LD A,(BC)
 930++99D7 03           	INC BC
 931++99D8 6F           	LD L,A
 932++99D9 CD 56 97     	CALL SETENBS
 933++99DC AF           	XOR A
 934++99DD DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 935++99E0 FD 77 0F     	LD (IY-100+VRS.CurEDel),A
 936++99E3 67           	LD H,A
 937++99E4 6F           	LD L,A
 938++99E5 C3 5D 97     	JP SETESLD
 939++99E8
 940++99E8 87           SETORN	ADD A,A
 941++99E9 5F           	LD E,A
 942++99EA 16 00        	LD D,0
 943++99EC DD 72 F4     	LD (IX-12+CHP.PsInOr),D
 944++99EF FD 6E F8     	LD L,(IY-100+VRS.OrnPtrs)
 945++99F2 FD 66 F9     	LD H,(IY-100+VRS.OrnPtrs+1)
 946++99F5 19           	ADD HL,DE
 947++99F6 5E           	LD E,(HL)
 948++99F7 23           	INC HL
 949++99F8 56           	LD D,(HL)
 950++99F9 FD 6E F6     	LD L,(IY-100+VRS.MODADDR)
 951++99FC FD 66 F7     	LD H,(IY-100+VRS.MODADDR+1)
 952++99FF 19           	ADD HL,DE
 953++9A00 DD 75 01     	LD (IX-12+CHP.OrnPtr),L
 954++9A03 DD 74 02     	LD (IX-12+CHP.OrnPtr+1),H
 955++9A06 C9           C_NOP	RET
 956++9A07
 957++9A07 87           SETSAM	ADD A,A
 958++9A08 5F           	LD E,A
 959++9A09 16 00        	LD D,0
 960++9A0B FD 6E FA     	LD L,(IY-100+VRS.SamPtrs);
 961++9A0E FD 66 FB     	LD H,(IY-100+VRS.SamPtrs+1);
 962++9A11 19           	ADD HL,DE
 963++9A12 5E           	LD E,(HL)
 964++9A13 23           	INC HL
 965++9A14 56           	LD D,(HL)
 966++9A15 FD 6E F6     	LD L,(IY-100+VRS.MODADDR)
 967++9A18 FD 66 F7     	LD H,(IY-100+VRS.MODADDR+1)
 968++9A1B 19           	ADD HL,DE
 969++9A1C DD 75 03     	LD (IX-12+CHP.SamPtr),L
 970++9A1F DD 74 04     	LD (IX-12+CHP.SamPtr+1),H
 971++9A22 C9           	RET
 972++9A23
 973++9A23              ;ALL 16 ADDRESSES TO PROTECT FROM BROKEN PT3 MODULES
 974++9A23 06 9A        SPCCOMS DW C_NOP
 975++9A25 62 99        	DW C_GLISS
 976++9A27 EE 98        	DW C_PORTM
 977++9A29 7F 99        	DW C_SMPOS
 978++9A2B 85 99        	DW C_ORPOS
 979++9A2D 8B 99        	DW C_VIBRT
 980++9A2F 06 9A        	DW C_NOP
 981++9A31 06 9A        	DW C_NOP
 982++9A33 A3 99        	DW C_ENGLS
 983++9A35 B8 99        	DW C_DELAY
 984++9A37 06 9A        	DW C_NOP
 985++9A39 06 9A        	DW C_NOP
 986++9A3B 06 9A        	DW C_NOP
 987++9A3D 06 9A        	DW C_NOP
 988++9A3F 06 9A        	DW C_NOP
 989++9A41 06 9A        	DW C_NOP
 990++9A43
 991++9A43 CD 64 97     CHREGS	CALL GETIX
 992++9A46 AF           	XOR A
 993++9A47 32 83 9C     	LD (Ampl),A
 994++9A4A DD CB 15 46  	BIT 0,(IX+CHP.Flags)
 995++9A4E E5           	PUSH HL
 996++9A4F CA 96 9B     	JP Z,CH_EXIT
 997++9A52 ED 73 E0 9A  	LD (CSP_+1),SP
 998++9A56 DD 6E 0D     	LD L,(IX+CHP.OrnPtr)
 999++9A59 DD 66 0E     	LD H,(IX+CHP.OrnPtr+1)
1000++9A5C F9           	LD SP,HL
1001++9A5D D1           	POP DE
1002++9A5E 67           	LD H,A
1003++9A5F DD 7E 00     	LD A,(IX+CHP.PsInOr)
1004++9A62 6F           	LD L,A
1005++9A63 39           	ADD HL,SP
1006++9A64 3C           	INC A
1007++9A65              		;PT2	PT3
1008++9A65 3C           OrnCP	INC A	;CP E	CP D
1009++9A66 38 01        	JR C,CH_ORPS
1010++9A68 01           OrnLD	DB 1	;LD A,D	LD A,E
1011++9A69 DD 77 00     CH_ORPS	LD (IX+CHP.PsInOr),A
1012++9A6C DD 7E 12     	LD A,(IX+CHP.Note)
1013++9A6F 86           	ADD A,(HL)
1014++9A70 F2 74 9A     	JP P,CH_NTP
1015++9A73 AF           	XOR A
1016++9A74 FE 60        CH_NTP	CP 96
1017++9A76 38 02        	JR C,CH_NOK
1018++9A78 3E 5F        	LD A,95
1019++9A7A 87           CH_NOK	ADD A,A
1020++9A7B 08           	EX AF,AF'
1021++9A7C DD 6E 0F     	LD L,(IX+CHP.SamPtr)
1022++9A7F DD 66 10     	LD H,(IX+CHP.SamPtr+1)
1023++9A82 F9           	LD SP,HL
1024++9A83 D1           	POP DE
1025++9A84 26 00        	LD H,0
1026++9A86 DD 7E 01     	LD A,(IX+CHP.PsInSm)
1027++9A89 47           	LD B,A
1028++9A8A 87           	ADD A,A
1029++9A8B 87           SamClc2	ADD A,A ;or ADD A,B for PT2
1030++9A8C 6F           	LD L,A
1031++9A8D 39           	ADD HL,SP
1032++9A8E F9           	LD SP,HL
1033++9A8F 78           	LD A,B
1034++9A90 3C           	INC A
1035++9A91              		;PT2	PT3
1036++9A91 3C           SamCP	INC A	;CP E	CP D
1037++9A92 38 01        	JR C,CH_SMPS
1038++9A94 01           SamLD	DB 1	;LD A,D	LD A,E
1039++9A95 DD 77 01     CH_SMPS	LD (IX+CHP.PsInSm),A
1040++9A98 C1           	POP BC
1041++9A99 E1           	POP HL
1042++9A9A
1043++9A9A              ;Convert PT2 sample to PT3
1044++9A9A              		;PT2		PT3
1045++9A9A E1           SamCnv	POP HL  ;BIT 2,C	JR e_
1046++9A9B E1           	POP HL
1047++9A9C 60           	LD H,B
1048++9A9D 20 06        	JR NZ,$+8
1049++9A9F EB           	EX DE,HL
1050++9AA0 A7           	AND A
1051++9AA1 ED 62        	SBC HL,HL
1052++9AA3 ED 52        	SBC HL,DE
1053++9AA5 51           	LD D,C
1054++9AA6 CB 19        	RR C
1055++9AA8 9F           	SBC A,A
1056++9AA9 2F           	CPL
1057++9AAA E6 3E        	AND #3E
1058++9AAC CB 19        	RR C
1059++9AAE CB 18        	RR B
1060++9AB0 A1           	AND C
1061++9AB1 4F           	LD C,A
1062++9AB2 78           	LD A,B
1063++9AB3 1F           	RRA
1064++9AB4 1F           	RRA
1065++9AB5 CB 1A        	RR D
1066++9AB7 1F           	RRA
1067++9AB8 E6 9F        	AND #9F
1068++9ABA 47           	LD B,A
1069++9ABB
1070++9ABB DD 5E 08     e_	LD E,(IX+CHP.TnAcc)
1071++9ABE DD 56 09     	LD D,(IX+CHP.TnAcc+1)
1072++9AC1 19           	ADD HL,DE
1073++9AC2 CB 70        	BIT 6,B
1074++9AC4 28 06        	JR Z,CH_NOAC
1075++9AC6 DD 75 08     	LD (IX+CHP.TnAcc),L
1076++9AC9 DD 74 09     	LD (IX+CHP.TnAcc+1),H
1077++9ACC EB           CH_NOAC EX DE,HL
1078++9ACD 08           	EX AF,AF'
player.asm(1079): warning: value 0x9FC6 is truncated to 8bit value: 0xC6
1079++9ACE C6 C6        	ADD A,NT_
1080++9AD0 6F           	LD L,A
1081++9AD1 CE 9F        	ADC A,NT_/256
1082++9AD3 95           	SUB L
1083++9AD4 67           	LD H,A
1084++9AD5 F9           	LD SP,HL
1085++9AD6 E1           	POP HL
1086++9AD7 19           	ADD HL,DE
1087++9AD8 DD 5E 06     	LD E,(IX+CHP.CrTnSl)
1088++9ADB DD 56 07     	LD D,(IX+CHP.CrTnSl+1)
1089++9ADE 19           	ADD HL,DE
1090++9ADF 31 31 31     CSP_	LD SP,#3131
1091++9AE2 E3           	EX (SP),HL
1092++9AE3 AF           	XOR A
1093++9AE4 DD B6 05     	OR (IX+CHP.TSlCnt)
1094++9AE7 28 3E        	JR Z,CH_AMP
1095++9AE9 DD 35 05     	DEC (IX+CHP.TSlCnt)
1096++9AEC 20 39        	JR NZ,CH_AMP
1097++9AEE DD 7E 16     	LD A,(IX+CHP.TnSlDl)
1098++9AF1 DD 77 05     	LD (IX+CHP.TSlCnt),A
1099++9AF4 DD 6E 17     	LD L,(IX+CHP.TSlStp)
1100++9AF7 DD 66 18     	LD H,(IX+CHP.TSlStp+1)
1101++9AFA 7C           	LD A,H
1102++9AFB 19           	ADD HL,DE
1103++9AFC DD 75 06     	LD (IX+CHP.CrTnSl),L
1104++9AFF DD 74 07     	LD (IX+CHP.CrTnSl+1),H
1105++9B02 DD CB 15 56  	BIT 2,(IX+CHP.Flags)
1106++9B06 20 1F        	JR NZ,CH_AMP
1107++9B08 DD 5E 19     	LD E,(IX+CHP.TnDelt)
1108++9B0B DD 56 1A     	LD D,(IX+CHP.TnDelt+1)
1109++9B0E A7           	AND A
1110++9B0F 28 01        	JR Z,CH_STPP
1111++9B11 EB           	EX DE,HL
1112++9B12 ED 52        CH_STPP SBC HL,DE
1113++9B14 FA 27 9B     	JP M,CH_AMP
1114++9B17 DD 7E 13     	LD A,(IX+CHP.SlToNt)
1115++9B1A DD 77 12     	LD (IX+CHP.Note),A
1116++9B1D AF           	XOR A
1117++9B1E DD 77 05     	LD (IX+CHP.TSlCnt),A
1118++9B21 DD 77 06     	LD (IX+CHP.CrTnSl),A
1119++9B24 DD 77 07     	LD (IX+CHP.CrTnSl+1),A
1120++9B27 DD 7E 02     CH_AMP	LD A,(IX+CHP.CrAmSl)
1121++9B2A CB 79        	BIT 7,C
1122++9B2C 28 13        	JR Z,CH_NOAM
1123++9B2E CB 71        	BIT 6,C
1124++9B30 28 07        	JR Z,CH_AMIN
1125++9B32 FE 0F        	CP 15
1126++9B34 28 0B        	JR Z,CH_NOAM
1127++9B36 3C           	INC A
1128++9B37 18 05        	JR CH_SVAM
1129++9B39 FE F1        CH_AMIN	CP -15
1130++9B3B 28 04        	JR Z,CH_NOAM
1131++9B3D 3D           	DEC A
1132++9B3E DD 77 02     CH_SVAM	LD (IX+CHP.CrAmSl),A
1133++9B41 6F           CH_NOAM	LD L,A
1134++9B42 78           	LD A,B
1135++9B43 E6 0F        	AND 15
1136++9B45 85           	ADD A,L
1137++9B46 F2 4A 9B     	JP P,CH_APOS
1138++9B49 AF           	XOR A
1139++9B4A FE 10        CH_APOS	CP 16
1140++9B4C 38 02        	JR C,CH_VOL
1141++9B4E 3E 0F        	LD A,15
1142++9B50 DD B6 1C     CH_VOL	OR (IX+CHP.Volume)
player.asm(1143): warning: value 0x9EC6 is truncated to 8bit value: 0xC6
1143++9B53 C6 C6        	ADD A,VT_
1144++9B55 6F           	LD L,A
1145++9B56 CE 9E        	ADC A,VT_/256
1146++9B58 95           	SUB L
1147++9B59 67           	LD H,A
1148++9B5A 7E           	LD A,(HL)
1149++9B5B CB 41        CH_ENV	BIT 0,C
1150++9B5D 20 03        	JR NZ,CH_NOEN
1151++9B5F DD B6 14     	OR (IX+CHP.Env_En)
1152++9B62 32 83 9C     CH_NOEN	LD (Ampl),A
1153++9B65 CB 78        	BIT 7,B
1154++9B67 79           	LD A,C
1155++9B68 28 1A        	JR Z,NO_ENSL
1156++9B6A 17           	RLA
1157++9B6B 17           	RLA
1158++9B6C CB 2F        	SRA A
1159++9B6E CB 2F        	SRA A
1160++9B70 CB 2F        	SRA A
1161++9B72 DD 86 04     	ADD A,(IX+CHP.CrEnSl) ;SEE COMMENT BELOW
1162++9B75 CB 68        	BIT 5,B
1163++9B77 28 03        	JR Z,NO_ENAC
1164++9B79 DD 77 04     	LD (IX+CHP.CrEnSl),A
1165++9B7C FD 86 12     NO_ENAC	ADD A,(IY-100+VRS.AddToEn) ;BUG IN PT3 - NEED WORD HERE
1166++9B7F FD 77 12     	LD (IY-100+VRS.AddToEn),A
1167++9B82 18 0E        	JR CH_MIX
1168++9B84 1F           NO_ENSL RRA
1169++9B85 DD 86 03     	ADD A,(IX+CHP.CrNsSl)
1170++9B88 FD 77 11     	LD (IY-100+VRS.AddToNs),A
1171++9B8B CB 68        	BIT 5,B
1172++9B8D 28 03        	JR Z,CH_MIX
1173++9B8F DD 77 03     	LD (IX+CHP.CrNsSl),A
1174++9B92 78           CH_MIX	LD A,B
1175++9B93 1F           	RRA
1176++9B94 E6 48        	AND #48
1177++9B96 FD B6 1C     CH_EXIT	OR (IY-100+VRS.AYREGS+Mixer)
1178++9B99 0F           	RRCA
1179++9B9A FD 77 1C     	LD (IY-100+VRS.AYREGS+Mixer),A
1180++9B9D E1           	POP HL
1181++9B9E AF           	XOR A
1182++9B9F DD B6 0A     	OR (IX+CHP.COnOff)
1183++9BA2 C8           	RET Z
1184++9BA3 DD 35 0A     	DEC (IX+CHP.COnOff)
1185++9BA6 C0           	RET NZ
1186++9BA7 DD AE 15     	XOR (IX+CHP.Flags)
1187++9BAA DD 77 15     	LD (IX+CHP.Flags),A
1188++9BAD 1F           	RRA
1189++9BAE DD 7E 0B     	LD A,(IX+CHP.OnOffD)
1190++9BB1 38 03        	JR C,CH_ONDL
1191++9BB3 DD 7E 0C     	LD A,(IX+CHP.OffOnD)
1192++9BB6 DD 77 0A     CH_ONDL	LD (IX+CHP.COnOff),A
1193++9BB9 C9           	RET
1194++9BBA
1195++9BBA AF           PLAY_	XOR A
1196++9BBB FD 77 12     	LD (IY-100+VRS.AddToEn),A
1197++9BBE FD 77 1C     	LD (IY-100+VRS.AYREGS+Mixer),A
1198++9BC1 3D           	DEC A
1199++9BC2 FD 77 22     	LD (IY-100+VRS.AYREGS+EnvTp),A
1200++9BC5 FD 35 09     	DEC (IY-100+VRS.DelyCnt)
1201++9BC8 C2 70 9C     	JP NZ,PL2
1202++9BCB FD 35 BA     	DEC (IY-100+VRS.ChanA+CHP.NtSkCn)
1203++9BCE 20 6C        	JR NZ,PL1B
1204++9BD0 FD 4E FE     	LD C,(IY-100+VRS.AdInPtA)
1205++9BD3 FD 46 FF     	LD B,(IY-100+VRS.AdInPtA+1)
1206++9BD6 0A           	LD A,(BC)
1207++9BD7 A7           	AND A
1208++9BD8 20 56        	JR NZ,PL1A
1209++9BDA 57           	LD D,A
1210++9BDB FD 77 10     	LD (IY-100+VRS.Ns_Base),A
1211++9BDE FD 6E 04     	LD L,(IY-100+VRS.CrPsPtr)
1212++9BE1 FD 66 05     	LD H,(IY-100+VRS.CrPsPtr+1)
1213++9BE4 23           	INC HL
1214++9BE5 7E           	LD A,(HL)
1215++9BE6 3C           	INC A
1216++9BE7 20 0B        	JR NZ,PLNLP
1217++9BE9
1218++9BE9              	IF LoopChecker
1219++9BE9 CD 9B 94     	CALL CHECKLP
1220++9BEC              	ENDIF
1221++9BEC
1222++9BEC FD 6E 06     	LD L,(IY-100+VRS.LPosPtr)
1223++9BEF FD 66 07     	LD H,(IY-100+VRS.LPosPtr+1)
1224++9BF2 7E           	LD A,(HL)
1225++9BF3 3C           	INC A
1226++9BF4 CD 48 97     PLNLP	CALL SETCPPT
1227++9BF7 3D           	DEC A
1228++9BF8 FD CB 9E 4E  	BIT 1,(IY-100+VRS.ModNum)
1229++9BFC 28 03        	JR Z,NoAlCo
1230++9BFE              TSSub	EQU $+1
1231++9BFE D6 D6        	SUB #D6
1232++9C00 2F           	CPL
1233++9C01              NoAlCo
1234++9C01              		;PT2		PT3
1235++9C01 3D           PsCalc	DEC A	;ADD A,A	NOP
1236++9C02 3D           	DEC A	;ADD A,(HL)	NOP
1237++9C03 87           	ADD A,A
1238++9C04 5F           	LD E,A
1239++9C05 CB 12        	RL D
1240++9C07
1241++9C07              	IF CurPosCounter
1242++9C07 ~            	LD A,L
1243++9C07 ~            	SUB (IY-100+VRS.PosSub)
1244++9C07 ~            	LD (IY-100+VRS.CurPos),A
1245++9C07              	ENDIF
1246++9C07
1247++9C07 FD 6E FC     	LD L,(IY-100+VRS.PatsPtr)
1248++9C0A FD 66 FD     	LD H,(IY-100+VRS.PatsPtr+1)
1249++9C0D 19           	ADD HL,DE
1250++9C0E FD 5E F6     	LD E,(IY-100+VRS.MODADDR)
1251++9C11 FD 56 F7     	LD D,(IY-100+VRS.MODADDR+1)
1252++9C14 ED 73 2E 9C  	LD (PSP_+1),SP
1253++9C18 F9           	LD SP,HL
1254++9C19 E1           	POP HL
1255++9C1A 19           	ADD HL,DE
1256++9C1B 44           	LD B,H
1257++9C1C 4D           	LD C,L
1258++9C1D E1           	POP HL
1259++9C1E 19           	ADD HL,DE
1260++9C1F FD 75 00     	LD (IY-100+VRS.AdInPtB),L
1261++9C22 FD 74 01     	LD (IY-100+VRS.AdInPtB+1),H
1262++9C25 E1           	POP HL
1263++9C26 19           	ADD HL,DE
1264++9C27 FD 75 02     	LD (IY-100+VRS.AdInPtC),L
1265++9C2A FD 74 03     	LD (IY-100+VRS.AdInPtC+1),H
1266++9C2D 31 31 31     PSP_	LD SP,#3131
1267++9C30 11 AB FF     PL1A	LD DE,VRS.ChanA+12-100
1268++9C33 CD 6B 97     	CALL PTDECOD
1269++9C36 FD 71 FE     	LD (IY-100+VRS.AdInPtA),C
1270++9C39 FD 70 FF     	LD (IY-100+VRS.AdInPtA+1),B
1271++9C3C
1272++9C3C FD 35 D7     PL1B	DEC (IY-100+VRS.ChanB+CHP.NtSkCn)
1273++9C3F 20 12        	JR NZ,PL1C
1274++9C41 11 C8 FF     	LD DE,VRS.ChanB+12-100
1275++9C44 FD 4E 00     	LD C,(IY-100+VRS.AdInPtB)
1276++9C47 FD 46 01     	LD B,(IY-100+VRS.AdInPtB+1)
1277++9C4A CD 6B 97     	CALL PTDECOD
1278++9C4D FD 71 00     	LD (IY-100+VRS.AdInPtB),C
1279++9C50 FD 70 01     	LD (IY-100+VRS.AdInPtB+1),B
1280++9C53
1281++9C53 FD 35 F4     PL1C	DEC (IY-100+VRS.ChanC+CHP.NtSkCn)
1282++9C56 20 12        	JR NZ,PL1D
1283++9C58 11 E5 FF     	LD DE,VRS.ChanC+12-100
1284++9C5B FD 4E 02     	LD C,(IY-100+VRS.AdInPtC)
1285++9C5E FD 46 03     	LD B,(IY-100+VRS.AdInPtC+1)
1286++9C61 CD 6B 97     	CALL PTDECOD
1287++9C64 FD 71 02     	LD (IY-100+VRS.AdInPtC),C
1288++9C67 FD 70 03     	LD (IY-100+VRS.AdInPtC+1),B
1289++9C6A
1290++9C6A FD 7E 08     PL1D	LD A,(IY-100+VRS.Delay)
1291++9C6D FD 77 09     	LD (IY-100+VRS.DelyCnt),A
1292++9C70
1293++9C70 11 9F FF     PL2	LD DE,VRS.ChanA-100
1294++9C73 FD 6E 15     	LD L,(IY-100+VRS.AYREGS+TonA)
1295++9C76 FD 66 16     	LD H,(IY-100+VRS.AYREGS+TonA+1)
1296++9C79 CD 43 9A     	CALL CHREGS
1297++9C7C FD 75 15     	LD (IY-100+VRS.AYREGS+TonA),L
1298++9C7F FD 74 16     	LD (IY-100+VRS.AYREGS+TonA+1),H
1299++9C82              Ampl	EQU $+1
1300++9C82 3E 3E        	LD A,#3E
1301++9C84 FD 77 1D     	LD (IY-100+VRS.AYREGS+AmplA),A
1302++9C87 11 BC FF     	LD DE,VRS.ChanB-100
1303++9C8A FD 6E 17     	LD L,(IY-100+VRS.AYREGS+TonB)
1304++9C8D FD 66 18     	LD H,(IY-100+VRS.AYREGS+TonB+1)
1305++9C90 CD 43 9A     	CALL CHREGS
1306++9C93 FD 75 17     	LD (IY-100+VRS.AYREGS+TonB),L
1307++9C96 FD 74 18     	LD (IY-100+VRS.AYREGS+TonB+1),H
1308++9C99 3A 83 9C     	LD A,(Ampl)
1309++9C9C FD 77 1E     	LD (IY-100+VRS.AYREGS+AmplB),A
1310++9C9F 11 D9 FF     	LD DE,VRS.ChanC-100
1311++9CA2 FD 6E 19     	LD L,(IY-100+VRS.AYREGS+TonC)
1312++9CA5 FD 66 1A     	LD H,(IY-100+VRS.AYREGS+TonC+1)
1313++9CA8 CD 43 9A     	CALL CHREGS
1314++9CAB FD 75 19     	LD (IY-100+VRS.AYREGS+TonC),L
1315++9CAE FD 74 1A     	LD (IY-100+VRS.AYREGS+TonC+1),H
1316++9CB1 3A 83 9C     	LD A,(Ampl)
1317++9CB4 FD 77 1F     	LD (IY-100+VRS.AYREGS+AmplC),A
1318++9CB7
1319++9CB7 FD 7E 10     	LD A,(IY-100+VRS.Ns_Base)
1320++9CBA FD 86 11     	ADD (IY-100+VRS.AddToNs)
1321++9CBD FD 77 1B     	LD (IY-100+VRS.AYREGS+Noise),A
1322++9CC0
1323++9CC0 FD 7E 12     	LD A,(IY-100+VRS.AddToEn)
1324++9CC3 5F           	LD E,A
1325++9CC4 87           	ADD A,A
1326++9CC5 9F           	SBC A,A
1327++9CC6 57           	LD D,A
1328++9CC7 FD 6E 13     	LD L,(IY-100+VRS.EnvBase)
1329++9CCA FD 66 14     	LD H,(IY-100+VRS.EnvBase+1)
1330++9CCD 19           	ADD HL,DE
1331++9CCE FD 5E 0C     	LD E,(IY-100+VRS.CurESld)
1332++9CD1 FD 56 0D     	LD D,(IY-100+VRS.CurESld+1)
1333++9CD4 19           	ADD HL,DE
1334++9CD5 FD 75 20     	LD (IY-100+VRS.AYREGS+Env),L
1335++9CD8 FD 74 21     	LD (IY-100+VRS.AYREGS+Env+1),H
1336++9CDB
1337++9CDB AF           	XOR A
1338++9CDC FD B6 0F     	OR (IY-100+VRS.CurEDel)
1339++9CDF C8           	RET Z
1340++9CE0 FD 35 0F     	DEC (IY-100+VRS.CurEDel)
1341++9CE3 C0           	RET NZ
1342++9CE4 FD 7E 0E     	LD A,(IY-100+VRS.Env_Del)
1343++9CE7 FD 77 0F     	LD (IY-100+VRS.CurEDel),A
1344++9CEA FD 6E 0A     	LD L,(IY-100+VRS.ESldAdd)
1345++9CED FD 66 0B     	LD H,(IY-100+VRS.ESldAdd+1)
1346++9CF0 19           	ADD HL,DE
1347++9CF1 C3 5D 97     	JP SETESLD
1348++9CF4
1349++9CF4 FD 21 2C 9E  PLAY    LD IY,VARS1+100
1350++9CF8 CD BA 9B     	CALL PLAY_
1351++9CFB 3A C7 9D     	LD A,(is_ts)
1352++9CFE A7           	AND A
1353++9CFF 28 07        	JR Z,PL_nts
1354++9D01 FD 21 B3 9E  	LD IY,VARS2+100
1355++9D05 CD BA 9B     	CALL PLAY_
1356++9D08              PL_nts
1357++9D08              	IF Basic
1358++9D08 FD 21 3A 5C  	LD IY,#5C3A
1359++9D0C              	ENDIF
1360++9D0C
1361++9D0C 01 FD FF     ROUT	LD BC,#FFFD
1362++9D0F 3A C7 9D     	LD A,(is_ts)
1363++9D12 A7           	AND A
1364++9D13 28 02        	JR Z,r_nts ;keep old standard
1365++9D15 ED 41        	OUT (C),B
1366++9D17 08           r_nts	EX AF,AF'
1367++9D18
1368++9D18              	IF ACBBAC
1369++9D18 ~            	LD IX,VARS1+VRS.AYREGS
1370++9D18              	ELSE
1371++9D18 21 41 9E     	LD HL,VARS1+VRS.AYREGS
1372++9D1B              	ENDIF
1373++9D1B
1374++9D1B CD 27 9D     	CALL ROUT_
1375++9D1E 08           	EX AF,AF'
1376++9D1F C8           	RET Z
1377++9D20 42           	LD B,D
1378++9D21 2F           	CPL
1379++9D22 ED 79        	OUT (C),A
1380++9D24
1381++9D24              	IF ACBBAC
1382++9D24 ~            	LD IX,VARS2+VRS.AYREGS
1383++9D24              	ELSE
1384++9D24 21 C8 9E     	LD HL,VARS2+VRS.AYREGS
1385++9D27              	ENDIF
1386++9D27
1387++9D27              ROUT_
1388++9D27              	IF ACBBAC
1389++9D27 ~            	LD A,(SETUP)
1390++9D27 ~            	AND 12
1391++9D27 ~            	JR Z,ABC
1392++9D27 ~            	ADD A,CHTABLE
1393++9D27 ~            	LD E,A
1394++9D27 ~            	ADC A,CHTABLE/256
1395++9D27 ~            	SUB E
1396++9D27 ~            	LD D,A
1397++9D27 ~            	LD B,0
1398++9D27 ~            	PUSH IX
1399++9D27 ~            	POP HL
1400++9D27 ~            	LD A,(DE)
1401++9D27 ~            	INC DE
1402++9D27 ~            	LD C,A
1403++9D27 ~            	ADD HL,BC
1404++9D27 ~            	LD A,(IX+TonB)
1405++9D27 ~            	LD C,(HL)
1406++9D27 ~            	LD (IX+TonB),C
1407++9D27 ~            	LD (HL),A
1408++9D27 ~            	INC HL
1409++9D27 ~            	LD A,(IX+TonB+1)
1410++9D27 ~            	LD C,(HL)
1411++9D27 ~            	LD (IX+TonB+1),C
1412++9D27 ~            	LD (HL),A
1413++9D27 ~            	LD A,(DE)
1414++9D27 ~            	INC DE
1415++9D27 ~            	LD C,A
1416++9D27 ~            	ADD HL,BC
1417++9D27 ~            	LD A,(IX+AmplB)
1418++9D27 ~            	LD C,(HL)
1419++9D27 ~            	LD (IX+AmplB),C
1420++9D27 ~            	LD (HL),A
1421++9D27 ~            	LD A,(DE)
1422++9D27 ~            	INC DE
1423++9D27 ~            	LD (RxCA1),A
1424++9D27 ~            	XOR 8
1425++9D27 ~            	LD (RxCA2),A
1426++9D27 ~            	LD A,(DE)
1427++9D27 ~            	AND (IX+Mixer)
1428++9D27 ~            	LD E,A
1429++9D27 ~            	LD A,(IX+Mixer)
1430++9D27 ~            RxCA1	DB #E6
1431++9D27 ~            	AND %010010
1432++9D27 ~            	OR E
1433++9D27 ~            	LD E,A
1434++9D27 ~            	LD A,(IX+Mixer)
1435++9D27 ~            	AND %010010
1436++9D27 ~            RxCA2	OR E
1437++9D27 ~            	OR E
1438++9D27 ~            	LD (IX+Mixer),A
1439++9D27 ~            ABC
1440++9D27              	ENDIF
1441++9D27
1442++9D27 AF           	XOR A
1443++9D28 11 BF FF     	LD DE,#FFBF
1444++9D2B
1445++9D2B              	IF ACBBAC
1446++9D2B ~            	LD BC,#FFFD
1447++9D2B ~            	PUSH IX
1448++9D2B ~            	POP HL
1449++9D2B              	ENDIF
1450++9D2B
1451++9D2B ED 79        LOUT	OUT (C),A
1452++9D2D 43           	LD B,E
1453++9D2E ED A3        	OUTI
1454++9D30 42           	LD B,D
1455++9D31 3C           	INC A
1456++9D32 FE 0D        	CP 13
1457++9D34 20 F5        	JR NZ,LOUT
1458++9D36 ED 79        	OUT (C),A
1459++9D38 7E           	LD A,(HL)
1460++9D39 A7           	AND A
1461++9D3A F8           	RET M
1462++9D3B 43           	LD B,E
1463++9D3C ED 79        	OUT (C),A
1464++9D3E C9           	RET
1465++9D3F
1466++9D3F              	IF ACBBAC
1467++9D3F ~            CHTABLE	EQU $-4
1468++9D3F ~            	DB 4,5,15,%001001,0,7,7,%100100
1469++9D3F              	ENDIF
1470++9D3F
1471++9D3F 64           NT_DATA	DB (T_NEW_0-T1_)*2
1472++9D40 2A           	DB TCNEW_0-T_
1473++9D41 65           	DB (T_OLD_0-T1_)*2+1
1474++9D42 00           	DB TCOLD_0-T_
1475++9D43 01           	DB (T_NEW_1-T1_)*2+1
1476++9D44 0C           	DB TCNEW_1-T_
1477++9D45 01           	DB (T_OLD_1-T1_)*2+1
1478++9D46 0C           	DB TCOLD_1-T_
1479++9D47 94           	DB (T_NEW_2-T1_)*2
1480++9D48 35           	DB TCNEW_2-T_
1481++9D49 30           	DB (T_OLD_2-T1_)*2
1482++9D4A 0E           	DB TCOLD_2-T_
1483++9D4B 60           	DB (T_NEW_3-T1_)*2
1484++9D4C 20           	DB TCNEW_3-T_
1485++9D4D 60           	DB (T_OLD_3-T1_)*2
1486++9D4E 21           	DB TCOLD_3-T_
1487++9D4F
1488++9D4F              T_
1489++9D4F
1490++9D4F 01 05 09 0B  TCOLD_0	DB #00+1,#04+1,#08+1,#0A+1,#0C+1,#0E+1,#12+1,#14+1
1490++9D53 0D 0F 13 15
1491++9D57 19 25 3D 00  	DB #18+1,#24+1,#3C+1,0
1492++9D5B 5D 00        TCOLD_1	DB #5C+1,0
1493++9D5D 31 37 4D 53  TCOLD_2	DB #30+1,#36+1,#4C+1,#52+1,#5E+1,#70+1,#82,#8C,#9C
1493++9D61 5F 71 82 8C
1493++9D65 9C
1494++9D66 9E A0 A6 A8  	DB #9E,#A0,#A6,#A8,#AA,#AC,#AE,#AE,0
1494++9D6A AA AC AE AE
1494++9D6E 00
1495++9D6F 57           TCNEW_3	DB #56+1
1496++9D70 1F 23 25 29  TCOLD_3	DB #1E+1,#22+1,#24+1,#28+1,#2C+1,#2E+1,#32+1,#BE+1,0
1496++9D74 2D 2F 33 BF
1496++9D78 00
1497++9D79 1D 21 23 27  TCNEW_0	DB #1C+1,#20+1,#22+1,#26+1,#2A+1,#2C+1,#30+1,#54+1
1497++9D7D 2B 2D 31 55
1498++9D81 BD BF 00     	DB #BC+1,#BE+1,0
1499++9D84              TCNEW_1 EQU TCOLD_1
1500++9D84 1B 21 25 29  TCNEW_2	DB #1A+1,#20+1,#24+1,#28+1,#2A+1,#3A+1,#4C+1,#5E+1
1500++9D88 2B 3B 4D 5F
1501++9D8C BB BD BF 00  	DB #BA+1,#BC+1,#BE+1,0
1502++9D90
1503++9D90              PT3EMPTYORN EQU $-1
1504++9D90 01 00        	DB 1,0
1505++9D92
1506++9D92              ;first 12 values of tone tables (packed)
1507++9D92
player.asm(1508): warning: value 0xDD8 is truncated to 8bit value: 0xD8
1508++9D92 0D D8        T_PACK	DB #06EC*2/256,#06EC*2
1509++9D94 69           	DB #0755-#06EC
1510++9D95 70           	DB #07C5-#0755
1511++9D96 76           	DB #083B-#07C5
1512++9D97 7D           	DB #08B8-#083B
1513++9D98 85           	DB #093D-#08B8
1514++9D99 8D           	DB #09CA-#093D
1515++9D9A 95           	DB #0A5F-#09CA
1516++9D9B 9D           	DB #0AFC-#0A5F
1517++9D9C A8           	DB #0BA4-#0AFC
1518++9D9D B1           	DB #0C55-#0BA4
1519++9D9E BB           	DB #0D10-#0C55
player.asm(1520): warning: value 0xCDA is truncated to 8bit value: 0xDA
1520++9D9F 0C DA        	DB #066D*2/256,#066D*2
1521++9DA1 62           	DB #06CF-#066D
1522++9DA2 68           	DB #0737-#06CF
1523++9DA3 6D           	DB #07A4-#0737
1524++9DA4 75           	DB #0819-#07A4
1525++9DA5 7B           	DB #0894-#0819
1526++9DA6 83           	DB #0917-#0894
1527++9DA7 8A           	DB #09A1-#0917
1528++9DA8 92           	DB #0A33-#09A1
1529++9DA9 9C           	DB #0ACF-#0A33
1530++9DAA A4           	DB #0B73-#0ACF
1531++9DAB AF           	DB #0C22-#0B73
1532++9DAC B8           	DB #0CDA-#0C22
player.asm(1533): warning: value 0xE08 is truncated to 8bit value: 0x08
1533++9DAD 0E 08        	DB #0704*2/256,#0704*2
1534++9DAF 6A           	DB #076E-#0704
1535++9DB0 72           	DB #07E0-#076E
1536++9DB1 78           	DB #0858-#07E0
1537++9DB2 7E           	DB #08D6-#0858
1538++9DB3 86           	DB #095C-#08D6
1539++9DB4 90           	DB #09EC-#095C
1540++9DB5 96           	DB #0A82-#09EC
1541++9DB6 A0           	DB #0B22-#0A82
1542++9DB7 AA           	DB #0BCC-#0B22
1543++9DB8 B4           	DB #0C80-#0BCC
1544++9DB9 BE           	DB #0D3E-#0C80
player.asm(1545): warning: value 0xFC0 is truncated to 8bit value: 0xC0
1545++9DBA 0F C0        	DB #07E0*2/256,#07E0*2
1546++9DBC 78           	DB #0858-#07E0
1547++9DBD 88           	DB #08E0-#0858
1548++9DBE 80           	DB #0960-#08E0
1549++9DBF 90           	DB #09F0-#0960
1550++9DC0 98           	DB #0A88-#09F0
1551++9DC1 A0           	DB #0B28-#0A88
1552++9DC2 B0           	DB #0BD8-#0B28
1553++9DC3 A8           	DB #0C80-#0BD8
1554++9DC4 E0           	DB #0D60-#0C80
1555++9DC5 B0           	DB #0E10-#0D60
1556++9DC6 E8           	DB #0EF8-#0E10
1557++9DC7
1558++9DC7              ;vars from here can be stripped
1559++9DC7              ;you can move VARS to any other address
1560++9DC7
1561++9DC7              VARS
1562++9DC7
1563++9DC7 00           is_ts	DB 0
1564++9DC8
1565++9DC8              ;ChannelsVars
1566++9DC8              	STRUCT	CHP
1567++9DC8 ~            ;reset group
1568++9DC8 ~            PsInOr	DB 0
1569++9DC8 ~            PsInSm	DB 0
1570++9DC8 ~            CrAmSl	DB 0
1571++9DC8 ~            CrNsSl	DB 0
1572++9DC8 ~            CrEnSl	DB 0
1573++9DC8 ~            TSlCnt	DB 0
1574++9DC8 ~            CrTnSl	DW 0
1575++9DC8 ~            TnAcc	DW 0
1576++9DC8 ~            COnOff	DB 0
1577++9DC8 ~            ;reset group
1578++9DC8 ~
1579++9DC8 ~            OnOffD	DB 0
1580++9DC8 ~
1581++9DC8 ~            ;IX for PTDECOD here (+12)
1582++9DC8 ~            OffOnD	DB 0
1583++9DC8 ~            OrnPtr	DW 0
1584++9DC8 ~            SamPtr	DW 0
1585++9DC8 ~            NNtSkp	DB 0
1586++9DC8 ~            Note	DB 0
1587++9DC8 ~            SlToNt	DB 0
1588++9DC8 ~            Env_En	DB 0
1589++9DC8 ~            Flags	DB 0
1590++9DC8 ~             ;Enabled - 0, SimpleGliss - 2
1591++9DC8 ~            TnSlDl	DB 0
1592++9DC8 ~            TSlStp	DW 0
1593++9DC8 ~            TnDelt	DW 0
1594++9DC8 ~            NtSkCn	DB 0
1595++9DC8 ~            Volume	DB 0
1596++9DC8              	ENDS
1597++9DC8
1598++9DC8              	STRUCT	VRS
1599++9DC8 ~
1600++9DC8 ~            ;IF not works in STRUCT in SjASM :(
1601++9DC8 ~            ;	IF CurPosCounter
1602++9DC8 ~            CurPos	DB 0
1603++9DC8 ~            PosSub	DB 0
1604++9DC8 ~            ;	ENDIF
1605++9DC8 ~
1606++9DC8 ~            ModNum	DB 0 ;bit0: ChipNum
1607++9DC8 ~            	     ;bit1: 1-reversed patterns order (AlCo TS)
1608++9DC8 ~
1609++9DC8 ~            ChanA	DS CHP
1610++9DC8 ~            ChanB	DS CHP
1611++9DC8 ~            ChanC	DS CHP
1612++9DC8 ~
1613++9DC8 ~            ;GlobalVars
1614++9DC8 ~            MODADDR	DW 0
1615++9DC8 ~            OrnPtrs	DW 0
1616++9DC8 ~            SamPtrs	DW 0
1617++9DC8 ~            PatsPtr	DW 0
1618++9DC8 ~            AdInPtA	DW 0
1619++9DC8 ~            AdInPtB	DW 0
1620++9DC8 ~            AdInPtC	DW 0
1621++9DC8 ~            CrPsPtr	DW 0
1622++9DC8 ~            LPosPtr	DW 0
1623++9DC8 ~            Delay	DB 0
1624++9DC8 ~            DelyCnt	DB 0
1625++9DC8 ~            ESldAdd	DW 0
1626++9DC8 ~            CurESld	DW 0
1627++9DC8 ~            Env_Del	DB 0
1628++9DC8 ~            CurEDel	DB 0
1629++9DC8 ~            Ns_Base	DB 0
1630++9DC8 ~            AddToNs	DB 0
1631++9DC8 ~            AddToEn	DB 0
1632++9DC8 ~            EnvBase	DW 0
1633++9DC8 ~            AYREGS	DS 14
1634++9DC8              	ENDS
1635++9DC8
1636++9DC8 00 00 00...  VARS1	DS VRS
1637++9E4F 00 00 00...  VARS2	DS VRS
1638++9ED6
1639++9ED6              VT_	EQU $-16
1640++9ED6 00 00 00...  	DS 256-16 ;CreatedVolumeTableAddress
1641++9FC6
1642++9FC6              T1_	EQU VT_+16 ;Tone tables data depacked here
1643++9FC6
1644++9FC6              T_OLD_1	EQU T1_
1645++9FC6              T_OLD_2	EQU T_OLD_1+24
1646++9FC6              T_OLD_3	EQU T_OLD_2+24
1647++9FC6              T_OLD_0	EQU T_OLD_3+2
1648++9FC6              T_NEW_0	EQU T_OLD_0
1649++9FC6              T_NEW_1	EQU T_OLD_1
1650++9FC6              T_NEW_2	EQU T_NEW_0+24
1651++9FC6              T_NEW_3	EQU T_OLD_3
1652++9FC6
1653++9FC6              PT2EMPTYORN EQU VT_+31 ;1,0,0 sequence
1654++9FC6
1655++9FC6 00 00 00...  NT_	DS 192 ;CreatedNoteTableAddress
1656++A086
1657++A086              VAR0END	EQU VT_+16 ;INIT zeroes from VARS to VAR0END-1
1658++A086
1659++A086              VARSEND EQU $
1660++A086
1661++A086              MDLADDR EQU outputBuffer
1662++A086
1663++A086              ;Release 0 steps:
1664++A086              ;04/21/2007
1665++A086              ;Works start (PTxPlay adaptation); first beta.
1666++A086              ;04/22/2007
1667++A086              ;Job finished; beta-testing.
1668++A086              ;04/23/2007
1669++A086              ;PT v3.7 TS mode corrected (after AlCo remarks).
1670++A086              ;04/29/2007
1671++A086              ;Added 1.XX and 2.XX special commands interpretation for PT3
1672++A086              ;modules of v3.7+.
1673++A086
1674++A086              ;Size (minimal build for ZX Spectrum):
1675++A086              ;Code block #908 bytes
1676++A086              ;Variables #2BF bytes (can be stripped)
1677++A086              ;Total size #908+#2BF=#BC7 (3015) bytes
1678++A086              	ENDMODULE
# file closed: player/player.asm
  77++A086                  ENDIF
# file closed: player/vortex-processor.asm
  44+ A086
  45+ A086              start:
  46+ A086              outputBuffer:
  47+ A086 F3                   di
  48+ A087 AF                   xor a
  48+ A088 32 6A 5C       ld (#5c6a), a  ; Thank you, Mario Prato, for feedback
  49+ A08B 32 00 5C             ld (#5c00),a
  50+ A08E 31 00 60             ld sp, asmOrg
  51+ A091 CD D9 92             call Memory.init
  52+ A094 AF                   xor a
  52+ A095 D3 FE          out (#fe),a
  53+ A097 FB                   ei
  54+ A098
  55+ A098 3E 07                ld a, 7
  55+ A09A CD E3 92       call Memory.setPage
  56+ A09D                      ;; Logo
  57+ A09D 21 D8 A0 06          ld hl, logo, b, Dos.FMODE_READ
  57+ A0A1 01
  57+ A0A2 CD F2 6C       call Dos.fopen
  58+ A0A5 F5                   push af
  59+ A0A6 21 00 C0 01          ld hl, #c000, bc, 6912
  59+ A0AA 00 1B
  59+ A0AC CD 49 6F       call Dos.fread
  60+ A0AF F1                   pop af
  61+ A0B0 CD 3D 6E             call Dos.fclose
  62+ A0B3
  63+ A0B3 06 32                ld b, 50
  64+ A0B5 76           1       halt
  65+ A0B6 10 FD                djnz 1b
  66+ A0B8                  ENDIF
  67+ A0B8
  68+ A0B8 CD 03 60         call TextMode.init
  69+ A0BB 21 C7 A0     	ld hl, initing
  69+ A0BE CD BC 60       call TextMode.printZ
  70+ A0C1
  71+ A0C1                  IFNDEF NOINIT
  72+ A0C1 CD 91 8F       	    call Wifi.init
  73+ A0C4                  ENDIF
  74+ A0C4
  75+ A0C4 C3 62 74         jp History.home
  76+ A0C7
  77+ A0C7 49 6E 69 74  initing db "Initing Wifi...", "\r", 0
  77+ A0CB 69 6E 67 20
  77+ A0CF 57 69 66 69
  77+ A0D3 2E 2E 2E 0D
  77+ A0D7 00
  78+ A0D8 62 72 6F 77  logo    db "browser/logo.scr", 0
  78+ A0DC 73 65 72 2F
  78+ A0E0 6C 6F 67 6F
  78+ A0E4 2E 73 63 72
  78+ A0E8 00
  79+ A0E9 62 72 6F 77  creds   db "browser/auth.pwd", 0
  79+ A0ED 73 65 72 2F
  79+ A0F1 61 75 74 68
  79+ A0F5 2E 70 77 64
  79+ A0F9 00
  80+ A0FA              outputBuffer2:
  81+ A0FA 41 54 45 30      db  "ATE0", 0
  81+ A0FE 00
  82+ A0FF                  display "ENDS: ", $
  83+ A0FF                  display "Buff size", #ffff - $
  84+ A0FF
  85+ A0FF              	IFDEF TRDOS
  86+ A0FF              		SAVETRD "TRD/MRF.TRD",|"AY-64.C",asmOrg, $ - asmOrg
  87+ A0FF              	        ELSE
  88+ A0FF ~            			    savebin BINNAME, asmOrg, $ - asmOrg
  89+ A0FF                 	ENDIF
  90+ A0FF
# file closed: main-all.asm
  17  A0FF                  ENDIF
# file closed: main.asm
